{
  BulkRequest bulkRequest=new BulkRequest();
  ExecutableScript executableScript=null;
  Map<String,Object> scriptCtx=null;
  for (  SearchHit doc : docs) {
    if (doc.hasSource()) {
      throw new IllegalArgumentException("[" + doc.index() + "]["+ doc.type()+ "]["+ doc.id()+ "] didn't store _source");
    }
    IndexRequest index=buildIndexRequest(doc);
    copyMetadata(index,doc);
    if (script != null) {
      if (executableScript == null) {
        executableScript=scriptService.executable(script,mainRequest.getScript().getParams());
        scriptCtx=new HashMap<>();
      }
      if (false == applyScript(index,doc,executableScript,scriptCtx)) {
        continue;
      }
    }
    bulkRequest.add(index);
  }
  return bulkRequest;
}
