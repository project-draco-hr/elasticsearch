{
  try {
    client().prepareSearch("idx").setTypes("type").addAggregation(histogram("histo").field(INTERVAL_FIELD).interval(interval).extendedBounds(new ExtendedBounds(0L,(long)(interval * (numBuckets - 1)))).subAggregation(metric).subAggregation(diff("diff_counts","_count").lag(-1).gapPolicy(gapPolicy))).execute().actionGet();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.getMessage(),is("all shards failed"));
  }
}
