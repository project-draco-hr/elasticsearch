{
  if (query instanceof FunctionScoreQuery) {
    query=((FunctionScoreQuery)query).getSubQuery();
    extract(query,terms);
  }
 else   if (query instanceof FiltersFunctionScoreQuery) {
    query=((FiltersFunctionScoreQuery)query).getSubQuery();
    extract(query,terms);
  }
 else   if (query instanceof ConstantScoreQuery) {
    ConstantScoreQuery q=(ConstantScoreQuery)query;
    if (q.getQuery() != null) {
      query=q.getQuery();
      extract(query,terms);
    }
  }
 else   if (query instanceof FilteredQuery) {
    query=((FilteredQuery)query).getQuery();
    extract(query,terms);
  }
 else   if (query instanceof XFilteredQuery) {
    query=((XFilteredQuery)query).getQuery();
    extract(query,terms);
  }
 else   if (query instanceof XCommonTermsQuery) {
    XCommonTermsQuery ctq=((XCommonTermsQuery)query);
    List<Term> ctqTerms=ctq.terms();
    BooleanQuery bq=new BooleanQuery();
    for (    Term term : ctqTerms) {
      bq.add(new TermQuery(term),Occur.SHOULD);
    }
    extract(bq,terms);
  }
 else   if (query instanceof MultiPhrasePrefixQuery) {
    MultiPhrasePrefixQuery q=((MultiPhrasePrefixQuery)query);
    AtomicReader atomicReader=getLeafContextForField(q.getField()).reader();
    extract(q.rewrite(atomicReader),terms);
  }
}
