{
  XContentParser parser=parseContext.parser();
  Query query=null;
  boolean queryFound=false;
  Set<String> indices=Sets.newHashSet();
  String currentFieldName=null;
  XContentParser.Token token;
  Query noMatchQuery=Queries.newMatchAllQuery();
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if ("query".equals(currentFieldName)) {
        query=parseContext.parseInnerQuery();
        queryFound=true;
      }
 else       if ("no_match_query".equals(currentFieldName)) {
        noMatchQuery=parseContext.parseInnerQuery();
      }
 else {
        throw new QueryParsingException(parseContext.index(),"[indices] query does not support [" + currentFieldName + "]");
      }
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("indices".equals(currentFieldName)) {
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          String value=parser.textOrNull();
          if (value == null) {
            throw new QueryParsingException(parseContext.index(),"No value specified for term filter");
          }
          indices.add(value);
        }
      }
 else {
        throw new QueryParsingException(parseContext.index(),"[indices] query does not support [" + currentFieldName + "]");
      }
    }
 else     if (token.isValue()) {
      if ("index".equals(currentFieldName)) {
        indices.add(parser.text());
      }
 else       if ("no_match_query".equals(currentFieldName)) {
        String type=parser.text();
        if ("all".equals(type)) {
          noMatchQuery=Queries.newMatchAllQuery();
        }
 else         if ("none".equals(type)) {
          noMatchQuery=MatchNoDocsQuery.INSTANCE;
        }
      }
 else {
        throw new QueryParsingException(parseContext.index(),"[indices] query does not support [" + currentFieldName + "]");
      }
    }
  }
  if (!queryFound) {
    throw new QueryParsingException(parseContext.index(),"[indices] requires 'query' element");
  }
  if (query == null) {
    return null;
  }
  if (indices.isEmpty()) {
    throw new QueryParsingException(parseContext.index(),"[indices] requires 'indices' element");
  }
  String[] concreteIndices=indices.toArray(new String[indices.size()]);
  if (clusterService != null) {
    MetaData metaData=clusterService.state().metaData();
    concreteIndices=metaData.concreteIndices(indices.toArray(new String[indices.size()]),IgnoreIndices.MISSING,true);
  }
  for (  String index : concreteIndices) {
    if (Regex.simpleMatch(index,parseContext.index().name())) {
      return query;
    }
  }
  return noMatchQuery;
}
