{
  engine.create(new Engine.Create(doc().add(field("_uid","1")).add(field("value","test")).build(),Lucene.STANDARD_ANALYZER,"test","1",B_1));
  final ExecutorService executorService=Executors.newCachedThreadPool();
  engine.snapshot(new Engine.SnapshotHandler<Void>(){
    @Override public Void snapshot(    final SnapshotIndexCommit snapshotIndexCommit1,    final Translog.Snapshot translogSnapshot1){
      assertThat(snapshotIndexCommit1,snapshotIndexCommitExists());
      assertThat(translogSnapshot1.hasNext(),equalTo(true));
      Translog.Create create1=(Translog.Create)translogSnapshot1.next();
      assertThat(create1.source(),equalTo(B_1));
      assertThat(translogSnapshot1.hasNext(),equalTo(false));
      Future<Object> future=executorService.submit(new Callable<Object>(){
        @Override public Object call() throws Exception {
          engine.flush(new Engine.Flush());
          engine.create(new Engine.Create(doc().add(field("_uid","2")).add(field("value","test")).build(),Lucene.STANDARD_ANALYZER,"test","2",B_2));
          engine.flush(new Engine.Flush());
          engine.create(new Engine.Create(doc().add(field("_uid","3")).add(field("value","test")).build(),Lucene.STANDARD_ANALYZER,"test","3",B_3));
          return null;
        }
      }
);
      try {
        future.get();
      }
 catch (      Exception e) {
        e.printStackTrace();
        assertThat(e.getMessage(),false,equalTo(true));
      }
      assertThat(snapshotIndexCommit1,snapshotIndexCommitExists());
      engine.snapshot(new Engine.SnapshotHandler<Void>(){
        @Override public Void snapshot(        SnapshotIndexCommit snapshotIndexCommit2,        Translog.Snapshot translogSnapshot2) throws EngineException {
          assertThat(snapshotIndexCommit1,snapshotIndexCommitExists());
          assertThat(snapshotIndexCommit2,snapshotIndexCommitExists());
          assertThat(snapshotIndexCommit2.getSegmentsFileName(),not(equalTo(snapshotIndexCommit1.getSegmentsFileName())));
          assertThat(translogSnapshot2.hasNext(),equalTo(true));
          Translog.Create create3=(Translog.Create)translogSnapshot2.next();
          assertThat(create3.source(),equalTo(B_3));
          assertThat(translogSnapshot2.hasNext(),equalTo(false));
          return null;
        }
      }
);
      return null;
    }
  }
);
  engine.close();
}
