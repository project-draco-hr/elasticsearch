{
  List<Segment> segments=engine.segments();
  assertThat(segments.isEmpty(),equalTo(true));
  ParsedDocument doc=new ParsedDocument("1","1","test",null,-1,doc().add(uidField("1")).add(field("value","test")).add(field(SourceFieldMapper.NAME,B_1,Field.Store.YES)).build(),Lucene.STANDARD_ANALYZER,B_1,false);
  engine.create(new Engine.Create(null,newUid("1"),doc));
  ParsedDocument doc2=new ParsedDocument("2","2","test",null,-1,doc().add(uidField("2")).add(field("value","test")).build(),Lucene.STANDARD_ANALYZER,B_2,false);
  engine.create(new Engine.Create(null,newUid("2"),doc2));
  engine.refresh(new Engine.Refresh(true));
  segments=engine.segments();
  assertThat(segments.size(),equalTo(1));
  assertThat(segments.get(0).committed(),equalTo(false));
  assertThat(segments.get(0).search(),equalTo(true));
  assertThat(segments.get(0).numDocs(),equalTo(2));
  assertThat(segments.get(0).deletedDocs(),equalTo(0));
  engine.flush(new Engine.Flush());
  segments=engine.segments();
  assertThat(segments.size(),equalTo(1));
  assertThat(segments.get(0).committed(),equalTo(true));
  assertThat(segments.get(0).search(),equalTo(true));
  assertThat(segments.get(0).numDocs(),equalTo(2));
  assertThat(segments.get(0).deletedDocs(),equalTo(0));
  ParsedDocument doc3=new ParsedDocument("3","3","test",null,-1,doc().add(uidField("3")).add(field("value","test")).build(),Lucene.STANDARD_ANALYZER,B_3,false);
  engine.create(new Engine.Create(null,newUid("3"),doc3));
  engine.refresh(new Engine.Refresh(true));
  segments=engine.segments();
  assertThat(segments.size(),equalTo(2));
  assertThat(segments.get(0).generation() < segments.get(1).generation(),equalTo(true));
  assertThat(segments.get(0).committed(),equalTo(true));
  assertThat(segments.get(0).search(),equalTo(true));
  assertThat(segments.get(0).numDocs(),equalTo(2));
  assertThat(segments.get(0).deletedDocs(),equalTo(0));
  assertThat(segments.get(1).committed(),equalTo(false));
  assertThat(segments.get(1).search(),equalTo(true));
  assertThat(segments.get(1).numDocs(),equalTo(1));
  assertThat(segments.get(1).deletedDocs(),equalTo(0));
  engine.delete(new Engine.Delete("test","1",newUid("1")));
  engine.refresh(new Engine.Refresh(true));
  segments=engine.segments();
  assertThat(segments.size(),equalTo(2));
  assertThat(segments.get(0).generation() < segments.get(1).generation(),equalTo(true));
  assertThat(segments.get(0).committed(),equalTo(true));
  assertThat(segments.get(0).search(),equalTo(true));
  assertThat(segments.get(0).numDocs(),equalTo(1));
  assertThat(segments.get(0).deletedDocs(),equalTo(1));
  assertThat(segments.get(1).committed(),equalTo(false));
  assertThat(segments.get(1).search(),equalTo(true));
  assertThat(segments.get(1).numDocs(),equalTo(1));
  assertThat(segments.get(1).deletedDocs(),equalTo(0));
}
