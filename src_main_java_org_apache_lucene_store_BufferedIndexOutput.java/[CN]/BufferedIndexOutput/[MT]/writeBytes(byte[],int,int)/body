{
  int bytesLeft=bufferSize - bufferPosition;
  if (bytesLeft >= length) {
    System.arraycopy(b,offset,buffer,bufferPosition,length);
    bufferPosition+=length;
    if (bufferSize - bufferPosition == 0)     flush();
  }
 else {
    if (length > bufferSize) {
      if (bufferPosition > 0)       flush();
      crc.update(b,offset,length);
      flushBuffer(b,offset,length);
      bufferStart+=length;
    }
 else {
      int pos=0;
      int pieceLength;
      while (pos < length) {
        pieceLength=(length - pos < bytesLeft) ? length - pos : bytesLeft;
        System.arraycopy(b,pos + offset,buffer,bufferPosition,pieceLength);
        pos+=pieceLength;
        bufferPosition+=pieceLength;
        bytesLeft=bufferSize - bufferPosition;
        if (bytesLeft == 0) {
          flush();
          bytesLeft=bufferSize;
        }
      }
    }
  }
}
