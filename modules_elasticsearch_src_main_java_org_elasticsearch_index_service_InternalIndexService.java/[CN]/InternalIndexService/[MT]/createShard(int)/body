{
  if (closed) {
    throw new ElasticSearchIllegalStateException("Can't create shard [" + index.name() + "]["+ sShardId+ "], closed");
  }
  ShardId shardId=new ShardId(index,sShardId);
  if (shardsInjectors.containsKey(shardId.id())) {
    throw new IndexShardAlreadyExistsException(shardId + " already exists");
  }
  indicesLifecycle.beforeIndexShardCreated(shardId);
  logger.debug("creating shard_id [{}]",shardId.id());
  ModulesBuilder modules=new ModulesBuilder();
  modules.add(new ShardsPluginsModule(indexSettings,pluginsService));
  modules.add(new IndexShardModule(shardId));
  modules.add(new StoreModule(indexSettings,injector.getInstance(IndexStore.class)));
  modules.add(new DeletionPolicyModule(indexSettings));
  modules.add(new MergePolicyModule(indexSettings));
  modules.add(new MergeSchedulerModule(indexSettings));
  modules.add(new TranslogModule(indexSettings));
  modules.add(new EngineModule(indexSettings));
  modules.add(new IndexShardGatewayModule(injector.getInstance(IndexGateway.class)));
  Injector shardInjector=modules.createChildInjector(injector);
  shardsInjectors=newMapBuilder(shardsInjectors).put(shardId.id(),shardInjector).immutableMap();
  IndexShard indexShard=shardInjector.getInstance(IndexShard.class);
  indicesLifecycle.afterIndexShardCreated(indexShard);
  shards=newMapBuilder(shards).put(shardId.id(),indexShard).immutableMap();
  return indexShard;
}
