{
  prepareCreate("test",3,settingsBuilder().put("index.number_of_shards",3).put("index.number_of_replicas",1)).execute().actionGet();
  ensureGreen();
  ClusterState state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.routingNodes().unassigned().size(),equalTo(0));
  Map<String,RoutingNode> nodesToShards=state.routingNodes().getNodesToShards();
  for (  Entry<String,RoutingNode> entry : nodesToShards.entrySet()) {
    if (!entry.getValue().shards().isEmpty()) {
      assertThat(entry.getValue().shards().size(),equalTo(2));
    }
  }
  client().admin().indices().prepareUpdateSettings("test").setSettings(settingsBuilder().put("index.number_of_replicas",0)).execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.routingNodes().unassigned().size(),equalTo(0));
  nodesToShards=state.routingNodes().getNodesToShards();
  for (  Entry<String,RoutingNode> entry : nodesToShards.entrySet()) {
    if (!entry.getValue().shards().isEmpty()) {
      assertThat(entry.getValue().shards().size(),equalTo(1));
    }
  }
  prepareCreate("test2",3,settingsBuilder().put("index.number_of_shards",3).put("index.number_of_replicas",1)).execute().actionGet();
  ensureGreen();
  client().admin().indices().prepareUpdateSettings("test").setSettings(settingsBuilder().put("index.number_of_replicas",1)).execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.routingNodes().unassigned().size(),equalTo(0));
  nodesToShards=state.routingNodes().getNodesToShards();
  for (  Entry<String,RoutingNode> entry : nodesToShards.entrySet()) {
    if (!entry.getValue().shards().isEmpty()) {
      assertThat(entry.getValue().shards().size(),equalTo(4));
    }
  }
}
