{
  prepareCreate("test",3,settingsBuilder().put("index.number_of_shards",3).put("index.number_of_replicas",1)).execute().actionGet();
  ensureGreen();
  ClusterState state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.routingNodes().unassigned().size(),equalTo(0));
  for (  RoutingNode node : state.routingNodes()) {
    if (!node.isEmpty()) {
      assertThat(node.size(),equalTo(2));
    }
  }
  client().admin().indices().prepareUpdateSettings("test").setSettings(settingsBuilder().put("index.number_of_replicas",0)).execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.routingNodes().unassigned().size(),equalTo(0));
  for (  RoutingNode node : state.routingNodes()) {
    if (!node.isEmpty()) {
      assertThat(node.size(),equalTo(1));
    }
  }
  prepareCreate("test2",3,settingsBuilder().put("index.number_of_shards",3).put("index.number_of_replicas",1)).execute().actionGet();
  ensureGreen();
  client().admin().indices().prepareUpdateSettings("test").setSettings(settingsBuilder().put("index.number_of_replicas",1)).execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.routingNodes().unassigned().size(),equalTo(0));
  for (  RoutingNode node : state.routingNodes()) {
    if (!node.isEmpty()) {
      assertThat(node.size(),equalTo(4));
    }
  }
}
