{
  Directory directory=null;
  if (isChecksum(name)) {
    directory=delegates[0];
  }
 else {
    if (delegates.length == 1) {
      directory=delegates[0];
    }
 else {
      long size=Long.MAX_VALUE;
      for (      Directory delegate : delegates) {
        if (delegate instanceof FSDirectory) {
          long currentSize=((FSDirectory)delegate).getDirectory().getFreeSpace();
          if (currentSize < size) {
            size=currentSize;
            directory=delegate;
          }
 else           if (currentSize == size && ThreadLocalRandom.current().nextBoolean()) {
            directory=delegate;
          }
        }
 else {
          directory=delegate;
        }
      }
    }
  }
  IndexOutput out=directory.createOutput(name);
synchronized (mutex) {
    StoreFileMetaData metaData=new StoreFileMetaData(name,-1,-1,null,directory);
    filesMetadata=MapBuilder.newMapBuilder(filesMetadata).put(name,metaData).immutableMap();
    files=filesMetadata.keySet().toArray(new String[filesMetadata.size()]);
    return new StoreIndexOutput(metaData,out,name,computeChecksum);
  }
}
