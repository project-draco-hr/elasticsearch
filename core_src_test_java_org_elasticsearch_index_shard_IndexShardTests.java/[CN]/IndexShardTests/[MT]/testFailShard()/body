{
  createIndex("test");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  NodeEnvironment env=getInstanceFromNode(NodeEnvironment.class);
  IndexService test=indicesService.indexService("test");
  IndexShard shard=test.shard(0);
  shard.failShard("test shard fail",new IOException("corrupted"));
  ShardStateMetaData shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertEquals(shardStateMetaData,getShardStateMetadata(shard));
  ShardPath shardPath=ShardPath.loadShardPath(logger,env,shard.shardId(),test.getIndexSettings());
  assertNotNull(shardPath);
  assertThat("store index should be corrupted",Store.canOpenIndex(logger,shardPath.resolveIndex()),equalTo(false));
}
