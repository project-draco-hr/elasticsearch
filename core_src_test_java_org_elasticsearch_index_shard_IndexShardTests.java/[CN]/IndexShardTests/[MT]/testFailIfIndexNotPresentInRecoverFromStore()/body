{
  createIndex("test");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  DiscoveryNode localNode=new DiscoveryNode("foo",LocalTransportAddress.buildUnique(),emptyMap(),emptySet(),Version.CURRENT);
  IndexService test=indicesService.indexService(resolveIndex("test"));
  final IndexShard shard=test.getShardOrNull(0);
  client().prepareIndex("test","test","0").setSource("{}").setRefreshPolicy(randomBoolean() ? IMMEDIATE : NONE).get();
  if (randomBoolean()) {
    client().admin().indices().prepareFlush().get();
  }
  final ShardRouting origRouting=shard.routingEntry();
  ShardRouting routing=origRouting;
  Store store=shard.store();
  store.incRef();
  test.removeShard(0,"b/c simon says so");
  cleanLuceneIndex(store.directory());
  store.decRef();
  routing=ShardRoutingHelper.reinit(routing);
  IndexShard newShard=test.createShard(routing);
  newShard.updateRoutingEntry(routing);
  newShard.markAsRecovering("store",new RecoveryState(newShard.shardId(),routing.primary(),RecoveryState.Type.STORE,localNode,localNode));
  try {
    newShard.recoverFromStore();
    fail("index not there!");
  }
 catch (  IndexShardRecoveryException ex) {
    assertTrue(ex.getMessage().contains("failed to fetch index version after copying it over"));
  }
  routing=ShardRoutingHelper.moveToUnassigned(routing,new UnassignedInfo(UnassignedInfo.Reason.INDEX_CREATED,"because I say so"));
  routing=ShardRoutingHelper.initialize(routing,origRouting.currentNodeId());
  assertTrue("it's already recovering, we should ignore new ones",newShard.ignoreRecoveryAttempt());
  try {
    newShard.markAsRecovering("store",new RecoveryState(newShard.shardId(),routing.primary(),RecoveryState.Type.STORE,localNode,localNode));
    fail("we are already recovering, can't mark again");
  }
 catch (  IllegalIndexShardStateException e) {
  }
  test.removeShard(0,"I broken it");
  newShard=test.createShard(routing);
  newShard.updateRoutingEntry(routing);
  newShard.markAsRecovering("store",new RecoveryState(newShard.shardId(),routing.primary(),RecoveryState.Type.STORE,localNode,localNode));
  assertTrue("recover even if there is nothing to recover",newShard.recoverFromStore());
  newShard.updateRoutingEntry(getInitializingShardRouting(routing).moveToStarted());
  SearchResponse response=client().prepareSearch().get();
  assertHitCount(response,0);
  IndexRequest request=client().prepareIndex("test","test","0").setSource("{}").request();
  request.process(null,false,"test");
  TransportIndexAction.executeIndexRequestOnPrimary(request,newShard,null);
  newShard.refresh("test");
  assertHitCount(client().prepareSearch().get(),1);
}
