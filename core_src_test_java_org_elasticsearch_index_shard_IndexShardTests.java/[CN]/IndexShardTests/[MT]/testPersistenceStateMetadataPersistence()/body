{
  createIndex("test");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  NodeEnvironment env=getInstanceFromNode(NodeEnvironment.class);
  IndexService test=indicesService.indexService("test");
  IndexShard shard=test.getShardOrNull(0);
  ShardStateMetaData shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertEquals(getShardStateMetadata(shard),shardStateMetaData);
  ShardRouting routing=new ShardRouting(shard.shardRouting,shard.shardRouting.version() + 1);
  shard.updateRoutingEntry(routing,true);
  shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertEquals(shardStateMetaData,getShardStateMetadata(shard));
  assertEquals(shardStateMetaData,new ShardStateMetaData(routing.version(),routing.primary(),shard.indexSettings().getUUID()));
  routing=new ShardRouting(shard.shardRouting,shard.shardRouting.version() + 1);
  shard.updateRoutingEntry(routing,true);
  shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertEquals(shardStateMetaData,getShardStateMetadata(shard));
  assertEquals(shardStateMetaData,new ShardStateMetaData(routing.version(),routing.primary(),shard.indexSettings().getUUID()));
  routing=new ShardRouting(shard.shardRouting,shard.shardRouting.version() + 1);
  shard.updateRoutingEntry(routing,true);
  shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertEquals(shardStateMetaData,getShardStateMetadata(shard));
  assertEquals(shardStateMetaData,new ShardStateMetaData(routing.version(),routing.primary(),shard.indexSettings().getUUID()));
  ShardRouting inactiveRouting=TestShardRouting.newShardRouting(shard.shardRouting.index(),shard.shardRouting.shardId().id(),shard.shardRouting.currentNodeId(),null,null,true,ShardRoutingState.INITIALIZING,shard.shardRouting.version() + 1);
  shard.persistMetadata(inactiveRouting,shard.shardRouting);
  shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertEquals("inactive shard state shouldn't be persisted",shardStateMetaData,getShardStateMetadata(shard));
  assertEquals("inactive shard state shouldn't be persisted",shardStateMetaData,new ShardStateMetaData(routing.version(),routing.primary(),shard.indexSettings().getUUID()));
  shard.updateRoutingEntry(new ShardRouting(shard.shardRouting,shard.shardRouting.version() + 1),false);
  shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertFalse("shard state persisted despite of persist=false",shardStateMetaData.equals(getShardStateMetadata(shard)));
  assertEquals("shard state persisted despite of persist=false",shardStateMetaData,new ShardStateMetaData(routing.version(),routing.primary(),shard.indexSettings().getUUID()));
  routing=new ShardRouting(shard.shardRouting,shard.shardRouting.version() + 1);
  shard.updateRoutingEntry(routing,true);
  shardStateMetaData=load(logger,env.availableShardPaths(shard.shardId));
  assertEquals(shardStateMetaData,getShardStateMetadata(shard));
  assertEquals(shardStateMetaData,new ShardStateMetaData(routing.version(),routing.primary(),shard.indexSettings().getUUID()));
}
