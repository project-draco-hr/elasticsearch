{
  createIndex("testpreindex");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  IndexService test=indicesService.indexService("testpreindex");
  IndexShard shard=test.getShardOrNull(0);
  ShardIndexingService shardIndexingService=shard.indexingService();
  final AtomicBoolean preIndexCalled=new AtomicBoolean(false);
  shardIndexingService.addListener(new IndexingOperationListener(){
    @Override public Engine.Index preIndex(    Engine.Index operation){
      preIndexCalled.set(true);
      return super.preIndex(operation);
    }
  }
);
  ParsedDocument doc=testParsedDocument("1","1","test",null,-1,-1,new ParseContext.Document(),new BytesArray(new byte[]{1}),null);
  Engine.Index index=new Engine.Index(new Term("_uid","1"),doc);
  shard.index(index);
  assertTrue(preIndexCalled.get());
}
