{
  createIndex("testpreindex");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  IndexService test=indicesService.indexService("testpreindex");
  IndexShard shard=test.shard(0);
  ShardIndexingService shardIndexingService=shard.indexingService();
  final HashMap<String,Boolean> listenerInfo=new HashMap<>();
  listenerInfo.put("preIndexCalled",false);
  shardIndexingService.addListener(new IndexingOperationListener(){
    @Override public Engine.Index preIndex(    Engine.Index index){
      listenerInfo.put("preIndexCalled",true);
      return super.preIndex(index);
    }
  }
);
  ParsedDocument doc=testParsedDocument("1","1","test",null,-1,-1,new ParseContext.Document(),new BytesArray(new byte[]{1}),null);
  Engine.Index index=new Engine.Index(new Term("_uid","1"),doc);
  shard.index(index);
  assertTrue(listenerInfo.get("preIndexCalled"));
}
