{
  createIndex("test");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  IndexService test=indicesService.indexService(resolveIndex("test"));
  final IndexShard shard=test.getShardOrNull(0);
  int numDocs=randomInt(20);
  for (int i=0; i < numDocs; i++) {
    client().prepareIndex("test","type","id_" + i).setSource("{}").get();
  }
  final boolean flushFirst=randomBoolean();
  IndexCommit commit=shard.acquireIndexCommit(flushFirst);
  int moreDocs=randomInt(20);
  for (int i=0; i < moreDocs; i++) {
    client().prepareIndex("test","type","id_" + numDocs + i).setSource("{}").get();
  }
  shard.flush(new FlushRequest("index"));
  try (IndexReader reader=DirectoryReader.open(commit)){
    assertThat(reader.numDocs(),equalTo(flushFirst ? numDocs : 0));
  }
   shard.releaseIndexCommit(commit);
  shard.flush(new FlushRequest("index").force(true));
  assertThat(DirectoryReader.listCommits(shard.store().directory()),hasSize(1));
}
