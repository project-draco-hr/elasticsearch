{
  createIndex("index");
  client().admin().indices().preparePutMapping("index").setType("testtype").setSource(jsonBuilder().startObject().startObject("testtype").startObject("properties").startObject("foo").field("type","text").endObject().endObject().endObject().endObject()).get();
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  IndexService test=indicesService.indexService(resolveIndex("index"));
  IndexShard shard=test.getShardOrNull(0);
  ShardRouting routing=getInitializingShardRouting(shard.routingEntry());
  test.removeShard(0,"b/c britta says so");
  IndexShard newShard=test.createShard(routing);
  newShard.shardRouting=routing;
  DiscoveryNode localNode=new DiscoveryNode("foo",LocalTransportAddress.buildUnique(),emptyMap(),emptySet(),Version.CURRENT);
  newShard.markAsRecovering("for testing",new RecoveryState(routing,localNode,null));
  assertFalse(newShard.isActive());
  newShard.prepareForIndexRecovery();
  assertFalse(newShard.isActive());
  newShard.performTranslogRecovery(true);
  assertTrue(newShard.isActive());
}
