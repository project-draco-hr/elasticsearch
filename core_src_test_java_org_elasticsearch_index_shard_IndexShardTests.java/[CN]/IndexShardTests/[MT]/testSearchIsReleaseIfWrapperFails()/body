{
  createIndex("test");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  IndexService indexService=indicesService.indexService(resolveIndex("test"));
  IndexShard shard=indexService.getShardOrNull(0);
  client().prepareIndex("test","test","0").setSource("{\"foo\" : \"bar\"}").setRefresh(true).get();
  IndexSearcherWrapper wrapper=new IndexSearcherWrapper(){
    @Override public DirectoryReader wrap(    DirectoryReader reader) throws IOException {
      throw new RuntimeException("boom");
    }
    public IndexSearcher wrap(    IndexSearcher searcher) throws EngineException {
      return searcher;
    }
  }
;
  IndexShard newShard=reinitWithWrapper(indexService,shard,wrapper);
  try {
    newShard.acquireSearcher("test");
    fail("exception expected");
  }
 catch (  RuntimeException ex) {
  }
 finally {
    newShard.close("just do it",randomBoolean());
  }
}
