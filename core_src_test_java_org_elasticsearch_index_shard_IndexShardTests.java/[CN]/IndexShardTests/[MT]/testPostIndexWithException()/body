{
  createIndex("testpostindexwithexception");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  IndexService test=indicesService.indexService("testpostindexwithexception");
  IndexShard shard=test.shard(0);
  ShardIndexingService shardIndexingService=shard.indexingService();
  shard.close("Unexpected close",true);
  shard.state=IndexShardState.STARTED;
  final AtomicBoolean postIndexWithExceptionCalled=new AtomicBoolean(false);
  shardIndexingService.addListener(new IndexingOperationListener(){
    @Override public void postIndex(    Engine.Index index,    Throwable ex){
      assertNotNull(ex);
      postIndexWithExceptionCalled.set(true);
      super.postIndex(index,ex);
    }
  }
);
  ParsedDocument doc=testParsedDocument("1","1","test",null,-1,-1,new ParseContext.Document(),new BytesArray(new byte[]{1}),null);
  Engine.Index index=new Engine.Index(new Term("_uid","1"),doc);
  try {
    shard.index(index);
    fail();
  }
 catch (  IllegalIndexShardStateException e) {
  }
  assertTrue(postIndexWithExceptionCalled.get());
}
