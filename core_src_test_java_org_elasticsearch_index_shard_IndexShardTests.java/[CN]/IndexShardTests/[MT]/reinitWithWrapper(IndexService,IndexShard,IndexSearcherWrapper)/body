{
  ShardRouting routing=new ShardRouting(shard.routingEntry());
  shard.close("simon says",true);
  IndexServicesProvider indexServices=indexService.getIndexServices();
  IndexServicesProvider newProvider=new IndexServicesProvider(indexServices.getIndexEventListener(),indexServices.getThreadPool(),indexServices.getMapperService(),indexServices.getQueryParserService(),indexServices.getIndexCache(),indexServices.getIndicesQueryCache(),indexServices.getCodecService(),indexServices.getTermVectorsService(),indexServices.getIndexFieldDataService(),indexServices.getWarmer(),indexServices.getSimilarityService(),indexServices.getFactory(),indexServices.getBigArrays(),wrapper,indexServices.getIndexingMemoryController());
  IndexShard newShard=new IndexShard(shard.shardId(),shard.indexSettings,shard.shardPath(),shard.store(),newProvider);
  ShardRoutingHelper.reinit(routing);
  newShard.updateRoutingEntry(routing,false);
  DiscoveryNode localNode=new DiscoveryNode("foo",DummyTransportAddress.INSTANCE,Version.CURRENT);
  assertTrue(newShard.recoverFromStore(routing,localNode));
  routing=new ShardRouting(routing);
  ShardRoutingHelper.moveToStarted(routing);
  newShard.updateRoutingEntry(routing,true);
  return newShard;
}
