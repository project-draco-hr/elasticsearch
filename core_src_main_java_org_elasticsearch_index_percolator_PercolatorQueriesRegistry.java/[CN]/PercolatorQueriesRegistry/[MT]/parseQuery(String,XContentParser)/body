{
  String[] previousTypes=null;
  if (type != null) {
    previousTypes=QueryShardContext.setTypesWithPrevious(type);
  }
  QueryShardContext context=queryParserService.getShardContext();
  try {
    context.reset(parser);
    context.setAllowUnmappedFields(false);
    context.setMapUnmappedFieldAsString(mapUnmappedFieldsAsString);
    return queryParserService.parseInnerQuery(context);
  }
 catch (  IOException e) {
    throw new ParsingException(parser.getTokenLocation(),"Failed to parse",e);
  }
 finally {
    if (type != null) {
      QueryShardContext.setTypes(previousTypes);
    }
    context.reset(null);
  }
}
