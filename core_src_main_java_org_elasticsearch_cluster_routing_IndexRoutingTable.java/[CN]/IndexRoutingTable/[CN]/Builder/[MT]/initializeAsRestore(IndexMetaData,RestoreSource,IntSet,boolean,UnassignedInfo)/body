{
  if (!shards.isEmpty()) {
    throw new IllegalStateException("trying to initialize an index with fresh shards, but already has shards created");
  }
  for (int shardId=0; shardId < indexMetaData.numberOfShards(); shardId++) {
    IndexShardRoutingTable.Builder indexShardRoutingBuilder=new IndexShardRoutingTable.Builder(new ShardId(indexMetaData.index(),shardId));
    for (int i=0; i <= indexMetaData.numberOfReplicas(); i++) {
      if (asNew && ignoreShards.contains(shardId)) {
        indexShardRoutingBuilder.addShard(ShardRouting.newUnassigned(index,shardId,null,i == 0,unassignedInfo));
      }
 else {
        indexShardRoutingBuilder.addShard(ShardRouting.newUnassigned(index,shardId,i == 0 ? restoreSource : null,i == 0,unassignedInfo));
      }
    }
    shards.put(shardId,indexShardRoutingBuilder.build());
  }
  return this;
}
