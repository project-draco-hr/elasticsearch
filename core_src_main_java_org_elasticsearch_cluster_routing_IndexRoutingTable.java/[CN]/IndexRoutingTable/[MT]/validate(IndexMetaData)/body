{
  ArrayList<String> failures=new ArrayList<>();
  if (indexMetaData.numberOfShards() != shards().size()) {
    Set<Integer> expected=Sets.newHashSet();
    for (int i=0; i < indexMetaData.numberOfShards(); i++) {
      expected.add(i);
    }
    for (    IndexShardRoutingTable indexShardRoutingTable : this) {
      expected.remove(indexShardRoutingTable.shardId().id());
    }
    failures.add("Wrong number of shards in routing table, missing: " + expected);
  }
  for (  IndexShardRoutingTable indexShardRoutingTable : this) {
    int routingNumberOfReplicas=indexShardRoutingTable.size() - 1;
    if (routingNumberOfReplicas != indexMetaData.numberOfReplicas()) {
      failures.add("Shard [" + indexShardRoutingTable.shardId().id() + "] routing table has wrong number of replicas, expected ["+ indexMetaData.numberOfReplicas()+ "], got ["+ routingNumberOfReplicas+ "]");
    }
    for (    ShardRouting shardRouting : indexShardRoutingTable) {
      if (!shardRouting.index().equals(index())) {
        failures.add("shard routing has an index [" + shardRouting.index() + "] that is different than the routing table");
      }
    }
  }
  return failures;
}
