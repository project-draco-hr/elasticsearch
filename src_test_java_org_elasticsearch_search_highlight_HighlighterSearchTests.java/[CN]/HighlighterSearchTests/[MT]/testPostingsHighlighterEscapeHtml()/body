{
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",2)).addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("title").field("type","string").field("store","yes").field("index_options","offsets").endObject().endObject().endObject().endObject()).get();
  ensureYellow();
  for (int i=0; i < 5; i++) {
    client().prepareIndex("test","type1",Integer.toString(i)).setSource("title","This is a html escaping highlighting test for *&? elasticsearch").setRefresh(true).execute().actionGet();
  }
  SearchResponse searchResponse=client().prepareSearch().setQuery(matchQuery("title","test")).setHighlighterEncoder("html").addHighlightedField("title").get();
  assertHitCount(searchResponse,5l);
  assertThat(searchResponse.getHits().hits().length,equalTo(5));
  for (  SearchHit hit : searchResponse.getHits()) {
    assertThat(hit.highlightFields().get("title").fragments()[0].string(),equalTo("This is a html escaping highlighting <em>test</em> for *&amp;?"));
  }
}
