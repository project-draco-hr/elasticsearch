{
  final String newMetaData="metadata-" + (currentIndex + 1);
  try {
    BytesStreamOutput bStream=new BytesStreamOutput();
    StreamOutput stream=bStream;
    if (compress) {
      stream=CompressorFactory.defaultCompressor().streamOutput(stream);
    }
    XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON,stream);
    builder.startObject();
    MetaData.Builder.toXContent(metaData,builder,ToXContent.EMPTY_PARAMS);
    builder.endObject();
    builder.close();
    metaDataBlobContainer.writeBlob(newMetaData,bStream.bytes().streamInput(),bStream.bytes().length());
  }
 catch (  IOException e) {
    throw new GatewayException("Failed to write metadata [" + newMetaData + "]",e);
  }
  currentIndex++;
  try {
    metaDataBlobContainer.deleteBlobsByFilter(new BlobContainer.BlobNameFilter(){
      @Override public boolean accept(      String blobName){
        return blobName.startsWith("metadata-") && !newMetaData.equals(blobName);
      }
    }
);
  }
 catch (  IOException e) {
    logger.debug("Failed to delete old metadata, will do it next time",e);
  }
}
