{
  final String newMetaData="metadata-" + (currentIndex + 1);
  CachedStreamOutput.Entry cachedEntry=CachedStreamOutput.popEntry();
  try {
    StreamOutput streamOutput;
    if (compress) {
      streamOutput=cachedEntry.cachedBytes(CompressorFactory.defaultCompressor());
    }
 else {
      streamOutput=cachedEntry.cachedBytes();
    }
    XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON,streamOutput);
    builder.startObject();
    MetaData.Builder.toXContent(metaData,builder,ToXContent.EMPTY_PARAMS);
    builder.endObject();
    builder.close();
    metaDataBlobContainer.writeBlob(newMetaData,new ByteArrayInputStream(cachedEntry.bytes().underlyingBytes(),0,cachedEntry.bytes().size()),cachedEntry.bytes().size());
  }
 catch (  IOException e) {
    throw new GatewayException("Failed to write metadata [" + newMetaData + "]",e);
  }
 finally {
    CachedStreamOutput.pushEntry(cachedEntry);
  }
  currentIndex++;
  try {
    metaDataBlobContainer.deleteBlobsByFilter(new BlobContainer.BlobNameFilter(){
      @Override public boolean accept(      String blobName){
        return blobName.startsWith("metadata-") && !newMetaData.equals(blobName);
      }
    }
);
  }
 catch (  IOException e) {
    logger.debug("Failed to delete old metadata, will do it next time",e);
  }
}
