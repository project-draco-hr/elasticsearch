{
  Set<Instance> instances=new HashSet<Instance>();
  DocumentBuilderFactory dbFactory=DocumentBuilderFactory.newInstance();
  DocumentBuilder dBuilder=dbFactory.newDocumentBuilder();
  Document doc=dBuilder.parse(inputStream);
  doc.getDocumentElement().normalize();
  XPath xPath=XPathFactory.newInstance().newXPath();
  String expression="/HostedService/Deployments/Deployment/RoleInstanceList/RoleInstance[PowerState='Started']";
  NodeList nodeList=(NodeList)xPath.compile(expression).evaluate(doc,XPathConstants.NODESET);
  for (int i=0; i < nodeList.getLength(); i++) {
    Instance instance=new Instance();
    Node node=nodeList.item(i);
    instance.setPrivateIp(extractValueFromPath(node,"IpAddress"));
    instance.setName(extractValueFromPath(node,"InstanceName"));
    instance.setStatus(Instance.Status.STARTED);
    expression="InstanceEndpoints/InstanceEndpoint[Name='" + port_name + "']";
    NodeList endpoints=(NodeList)xPath.compile(expression).evaluate(node,XPathConstants.NODESET);
    for (int j=0; j < endpoints.getLength(); j++) {
      Node endpoint=endpoints.item(j);
      instance.setPublicIp(extractValueFromPath(endpoint,"Vip"));
      instance.setPublicPort(extractValueFromPath(endpoint,"PublicPort"));
    }
    instances.add(instance);
  }
  return instances;
}
