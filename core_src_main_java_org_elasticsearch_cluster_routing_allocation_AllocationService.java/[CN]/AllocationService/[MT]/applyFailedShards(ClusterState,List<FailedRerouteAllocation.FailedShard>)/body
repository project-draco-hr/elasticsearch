{
  RoutingNodes routingNodes=getMutableRoutingNodes(clusterState);
  routingNodes.unassigned().shuffle();
  FailedRerouteAllocation allocation=new FailedRerouteAllocation(allocationDeciders,routingNodes,clusterState.nodes(),failedShards,clusterInfoService.getClusterInfo());
  boolean changed=false;
  for (  FailedRerouteAllocation.FailedShard failedShard : failedShards) {
    changed|=applyFailedShard(allocation,failedShard.shard,true,new UnassignedInfo(UnassignedInfo.Reason.ALLOCATION_FAILED,failedShard.message,failedShard.failure));
  }
  if (!changed) {
    return new RoutingAllocation.Result(false,clusterState.routingTable());
  }
  shardsAllocators.applyFailedShards(allocation);
  reroute(allocation);
  return new RoutingAllocation.Result(true,new RoutingTable.Builder().updateNodes(routingNodes).build().validateRaiseException(clusterState.metaData()));
}
