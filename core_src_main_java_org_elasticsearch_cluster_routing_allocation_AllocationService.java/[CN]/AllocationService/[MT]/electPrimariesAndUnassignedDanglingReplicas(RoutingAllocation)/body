{
  boolean changed=false;
  final RoutingNodes routingNodes=allocation.routingNodes();
  if (routingNodes.unassigned().getNumPrimaries() == 0) {
    return changed;
  }
  for (  ShardRouting shardEntry : routingNodes.unassigned()) {
    if (shardEntry.primary()) {
      changed|=failReplicasForUnassignedPrimary(allocation,shardEntry);
      ShardRouting candidate=allocation.routingNodes().activeReplica(shardEntry);
      if (candidate != null) {
        IndexMetaData index=allocation.metaData().index(candidate.index());
        routingNodes.swapPrimaryFlag(shardEntry,candidate);
        if (candidate.relocatingNodeId() != null) {
          changed=true;
          RoutingNode node=routingNodes.node(candidate.relocatingNodeId());
          if (node != null) {
            for (            ShardRouting shardRouting : node) {
              if (shardRouting.shardId().equals(candidate.shardId()) && !shardRouting.primary()) {
                routingNodes.swapPrimaryFlag(shardRouting);
                break;
              }
            }
          }
        }
        if (IndexMetaData.isIndexUsingShadowReplicas(index.getSettings())) {
          routingNodes.reinitShadowPrimary(candidate);
          changed=true;
        }
      }
    }
  }
  return changed;
}
