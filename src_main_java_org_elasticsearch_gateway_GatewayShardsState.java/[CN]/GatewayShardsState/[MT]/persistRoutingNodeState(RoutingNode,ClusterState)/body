{
  final Map<ShardId,ShardStateInfo> newState=Maps.newHashMap();
  for (  MutableShardRouting shardRouting : routingNode) {
    if (shardRouting.active()) {
      ShardId shardId=shardRouting.shardId();
      ShardStateInfo shardStateInfo=new ShardStateInfo(shardRouting.version(),shardRouting.primary());
      final ShardStateInfo previous=currentState.get(shardId);
      Settings indexSettings=clusterState.getMetaData().indices().get(shardId.getIndex()).settings();
      if (maybeWriteShardState(shardId,shardStateInfo,previous,indexSettings)) {
        newState.put(shardId,shardStateInfo);
      }
 else       if (previous != null) {
        currentState.put(shardId,previous);
      }
    }
  }
  return newState;
}
