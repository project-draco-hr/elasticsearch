{
  if (!text.hasBytes() && seekPositionSupported()) {
    long pos1=position();
    seek(pos1 + 4);
    UTF8StreamWriter utf8StreamWriter=CachedStreamOutput.utf8StreamWriter();
    utf8StreamWriter.setOutput(this);
    utf8StreamWriter.write(text.string());
    utf8StreamWriter.close();
    long pos2=position();
    seek(pos1);
    writeInt((int)(pos2 - pos1 - 4));
    seek(pos2);
  }
 else {
    BytesReference bytes=text.bytes();
    writeInt(bytes.length());
    bytes.writeTo(this);
  }
}
