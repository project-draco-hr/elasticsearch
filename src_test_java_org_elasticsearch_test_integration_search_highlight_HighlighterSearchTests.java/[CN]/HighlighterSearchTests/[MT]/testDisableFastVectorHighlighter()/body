{
  try {
    client.admin().indices().prepareDelete("test").execute().actionGet();
  }
 catch (  Exception e) {
  }
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("number_of_shards",2)).addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("title").field("type","string").field("store","yes").field("term_vector","with_positions_offsets").endObject().endObject().endObject().endObject()).execute().actionGet();
  for (int i=0; i < 5; i++) {
    client.prepareIndex("test","type1",Integer.toString(i)).setSource("title","This is a test for the workaround for the fast vector highlighting SOLR-3724").setRefresh(true).execute().actionGet();
  }
  SearchResponse search=client.prepareSearch().setQuery(matchPhraseQuery("title","test for the workaround")).addHighlightedField("title",50,1,10).execute().actionGet();
  assertThat(Arrays.toString(search.shardFailures()),search.failedShards(),equalTo(0));
  assertThat(search.hits().totalHits(),equalTo(5l));
  assertThat(search.hits().hits().length,equalTo(5));
  for (  SearchHit hit : search.hits()) {
    assertThat(hit.highlightFields().isEmpty(),equalTo(true));
  }
  search=client.prepareSearch().setQuery(matchPhraseQuery("title","test for the workaround")).addHighlightedField("title",50,1,10).setHighlighterType("highlighter").execute().actionGet();
  assertThat(Arrays.toString(search.shardFailures()),search.failedShards(),equalTo(0));
  assertThat(search.hits().totalHits(),equalTo(5l));
  assertThat(search.hits().hits().length,equalTo(5));
  for (  SearchHit hit : search.hits()) {
    assertThat(hit.highlightFields().get("title").fragments()[0].string(),equalTo("This is a <em>test</em> for the <em>workaround</em> for the fast vector highlighting SOLR-3724"));
  }
  search=client.prepareSearch().setQuery(matchPhraseQuery("title","test for the workaround")).addHighlightedField(new HighlightBuilder.Field("title").highlighterType("highlighter")).setHighlighterType("highlighter").execute().actionGet();
  assertThat(Arrays.toString(search.shardFailures()),search.failedShards(),equalTo(0));
  assertThat(search.hits().totalHits(),equalTo(5l));
  assertThat(search.hits().hits().length,equalTo(5));
  for (  SearchHit hit : search.hits()) {
    assertThat(hit.highlightFields().get("title").fragments()[0].string(),equalTo("This is a <em>test</em> for the <em>workaround</em> for the fast vector highlighting SOLR-3724"));
  }
}
