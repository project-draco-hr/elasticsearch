{
  if (request.isBinary()) {
    if (request.isQuiet() && response.status().getStatus() < 500) {
      return;
    }
    try {
      ChannelBuffer writeBuffer=ChannelBuffers.dynamicBuffer(24 + request.getUriBytes().length + response.contentLength()+ 12);
      writeBuffer.writeByte(0x81);
      if (request.method() == RestRequest.Method.GET) {
        writeBuffer.writeByte(0x00);
      }
 else       if (request.method() == RestRequest.Method.POST) {
        if (request.isQuiet()) {
          writeBuffer.writeByte(0x11);
        }
 else {
          writeBuffer.writeByte(0x01);
        }
      }
 else       if (request.method() == RestRequest.Method.DELETE) {
        writeBuffer.writeByte(0x04);
      }
      short keyLength=request.method() == RestRequest.Method.GET ? (short)request.getUriBytes().length : 0;
      writeBuffer.writeShort(keyLength);
      int extrasLength=request.method() == RestRequest.Method.GET ? 4 : 0;
      writeBuffer.writeByte(extrasLength);
      writeBuffer.writeByte(0);
      if (response.status().getStatus() >= 500) {
        writeBuffer.writeShort(0x0A);
      }
 else {
        writeBuffer.writeShort(0x0000);
      }
      int dataLength=request.method() == RestRequest.Method.GET ? response.contentLength() : 0;
      writeBuffer.writeInt(dataLength + keyLength + extrasLength);
      writeBuffer.writeInt(request.getOpaque());
      writeBuffer.writeLong(0);
      if (extrasLength > 0) {
        writeBuffer.writeShort(0);
        writeBuffer.writeShort(0);
      }
      if (keyLength > 0) {
        writeBuffer.writeBytes(request.getUriBytes());
      }
      if (dataLength > 0) {
        writeBuffer.writeBytes(response.content(),0,response.contentLength());
      }
      channel.write(writeBuffer);
    }
 catch (    Exception e) {
      throw new MemcachedTransportException("Failed to write response",e);
    }
  }
 else {
    if (response.status().getStatus() >= 500) {
      channel.write(ERROR.duplicate());
    }
 else {
      if (request.method() == RestRequest.Method.POST) {
        channel.write(STORED.duplicate());
      }
 else       if (request.method() == RestRequest.Method.DELETE) {
        channel.write(DELETED.duplicate());
      }
 else {
        try {
          ChannelBuffer writeBuffer=ChannelBuffers.dynamicBuffer(response.contentLength() + 512);
          writeBuffer.writeBytes(VALUE.duplicate());
          writeBuffer.writeBytes(Unicode.fromStringAsBytes(request.uri()));
          writeBuffer.writeByte(' ');
          writeBuffer.writeByte('0');
          writeBuffer.writeByte(' ');
          writeBuffer.writeBytes(Bytes.itoa(response.contentLength()));
          writeBuffer.writeByte('\r');
          writeBuffer.writeByte('\n');
          writeBuffer.writeBytes(response.content(),0,response.contentLength());
          writeBuffer.writeByte('\r');
          writeBuffer.writeByte('\n');
          writeBuffer.writeBytes(END.duplicate());
          channel.write(writeBuffer);
        }
 catch (        Exception e) {
          throw new MemcachedTransportException("Failed to write 'get' response",e);
        }
      }
    }
  }
}
