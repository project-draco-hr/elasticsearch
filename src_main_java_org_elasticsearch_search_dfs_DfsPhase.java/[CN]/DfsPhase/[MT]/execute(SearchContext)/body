{
  try {
    if (!context.queryRewritten()) {
      context.updateRewriteQuery(context.searcher().rewrite(context.query()));
    }
    THashSet<Term> termsSet=cachedTermsSet.get().get();
    termsSet.clear();
    context.query().extractTerms(termsSet);
    Term[] terms=termsSet.toArray(new Term[termsSet.size()]);
    TermStatistics[] termStatistics=new TermStatistics[terms.length];
    IndexReaderContext indexReaderContext=context.searcher().getTopReaderContext();
    for (int i=0; i < terms.length; i++) {
      TermContext termContext=TermContext.build(indexReaderContext,terms[i],false);
      termStatistics[i]=context.searcher().termStatistics(terms[i],termContext);
    }
    TMap<String,CollectionStatistics> fieldStatistics=new ExtTHashMap<String,CollectionStatistics>();
    for (    Term term : terms) {
      if (!fieldStatistics.containsKey(term.field())) {
        fieldStatistics.put(term.field(),context.searcher().collectionStatistics(term.field()));
      }
    }
    context.dfsResult().termsStatistics(terms,termStatistics).fieldStatistics(fieldStatistics).maxDoc(context.searcher().getIndexReader().maxDoc());
  }
 catch (  Exception e) {
    throw new DfsPhaseExecutionException(context,"Exception during dfs phase",e);
  }
}
