{
  assertAcked(client().admin().cluster().preparePutStoredScript().setScriptLang(MustacheScriptEngineService.NAME).setId("testTemplate").setSource(new BytesArray("{" + "\"template\":{" + "                \"query\":{"+ "                   \"match\":{"+ "                    \"theField\" : \"{{fieldParam}}\"}"+ "       }"+ "}"+ "}")));
  assertAcked(client().admin().cluster().preparePutStoredScript().setScriptLang(MustacheScriptEngineService.NAME).setId("testTemplate").setSource(new BytesArray("{" + "\"template\":{" + "                \"query\":{"+ "                   \"match\":{"+ "                    \"theField\" : \"{{fieldParam}}\"}"+ "       }"+ "}"+ "}")));
  GetStoredScriptResponse getResponse=client().admin().cluster().prepareGetStoredScript(MustacheScriptEngineService.NAME,"testTemplate").get();
  assertNotNull(getResponse.getStoredScript());
  List<IndexRequestBuilder> builders=new ArrayList<>();
  builders.add(client().prepareIndex("test","type","1").setSource("{\"theField\":\"foo\"}"));
  builders.add(client().prepareIndex("test","type","2").setSource("{\"theField\":\"foo 2\"}"));
  builders.add(client().prepareIndex("test","type","3").setSource("{\"theField\":\"foo 3\"}"));
  builders.add(client().prepareIndex("test","type","4").setSource("{\"theField\":\"foo 4\"}"));
  builders.add(client().prepareIndex("test","type","5").setSource("{\"theField\":\"bar\"}"));
  indexRandom(true,builders);
  Map<String,Object> templateParams=new HashMap<>();
  templateParams.put("fieldParam","foo");
  SearchResponse searchResponse=client().prepareSearch("test").setTypes("type").setTemplate(new Template("testTemplate",ScriptType.STORED,MustacheScriptEngineService.NAME,null,templateParams)).get();
  assertHitCount(searchResponse,4);
  assertAcked(client().admin().cluster().prepareDeleteStoredScript(MustacheScriptEngineService.NAME,"testTemplate"));
  getResponse=client().admin().cluster().prepareGetStoredScript(MustacheScriptEngineService.NAME,"testTemplate").get();
  assertNull(getResponse.getStoredScript());
  try {
    client().prepareSearch("test").setTypes("type").setTemplate(new Template("/template_index/mustache/1000",ScriptType.STORED,MustacheScriptEngineService.NAME,null,templateParams)).get();
    fail("Expected SearchPhaseExecutionException");
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.toString(),containsString("Illegal index script format"));
  }
}
