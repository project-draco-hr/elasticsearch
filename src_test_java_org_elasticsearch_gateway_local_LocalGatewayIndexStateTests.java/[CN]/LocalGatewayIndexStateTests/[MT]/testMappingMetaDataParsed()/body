{
  logger.info("--> starting 1 nodes");
  internalCluster().startNode(settingsBuilder().put("gateway.type","local"));
  logger.info("--> creating test index, with meta routing");
  client().admin().indices().prepareCreate("test").addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("_routing").field("required",true).endObject().endObject().endObject()).execute().actionGet();
  logger.info("--> waiting for yellow status");
  ClusterHealthResponse health=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForActiveShards(5).setWaitForYellowStatus().execute().actionGet();
  if (health.isTimedOut()) {
    ClusterStateResponse response=client().admin().cluster().prepareState().execute().actionGet();
    System.out.println("" + response);
  }
  assertThat(health.isTimedOut(),equalTo(false));
  logger.info("--> verify meta _routing required exists");
  MappingMetaData mappingMd=client().admin().cluster().prepareState().execute().actionGet().getState().metaData().index("test").mapping("type1");
  assertThat(mappingMd.routing().required(),equalTo(true));
  logger.info("--> restarting nodes...");
  internalCluster().fullRestart();
  logger.info("--> waiting for yellow status");
  health=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForActiveShards(5).setWaitForYellowStatus().execute().actionGet();
  if (health.isTimedOut()) {
    ClusterStateResponse response=client().admin().cluster().prepareState().execute().actionGet();
    System.out.println("" + response);
  }
  assertThat(health.isTimedOut(),equalTo(false));
  logger.info("--> verify meta _routing required exists");
  mappingMd=client().admin().cluster().prepareState().execute().actionGet().getState().metaData().index("test").mapping("type1");
  assertThat(mappingMd.routing().required(),equalTo(true));
}
