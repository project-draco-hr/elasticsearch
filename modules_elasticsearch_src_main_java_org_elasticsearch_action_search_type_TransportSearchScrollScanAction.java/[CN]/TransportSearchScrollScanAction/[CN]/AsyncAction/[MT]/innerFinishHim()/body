{
  int numberOfHits=0;
  for (  QueryFetchSearchResult shardResult : queryFetchResults.values()) {
    numberOfHits+=shardResult.queryResult().topDocs().scoreDocs.length;
  }
  ShardDoc[] docs=new ShardDoc[numberOfHits];
  int counter=0;
  for (  QueryFetchSearchResult shardResult : queryFetchResults.values()) {
    ScoreDoc[] scoreDocs=shardResult.queryResult().topDocs().scoreDocs;
    for (    ScoreDoc scoreDoc : scoreDocs) {
      docs[counter++]=new ShardScoreDoc(shardResult.shardTarget(),scoreDoc.doc,0.0f);
    }
  }
  final InternalSearchResponse internalResponse=searchPhaseController.merge(docs,queryFetchResults,queryFetchResults);
  ((InternalSearchHits)internalResponse.hits()).totalHits=Long.parseLong(this.scrollId.attributes().get("total_hits"));
  for (  QueryFetchSearchResult shardResult : queryFetchResults.values()) {
    if (shardResult.queryResult().topDocs().scoreDocs.length < shardResult.queryResult().size()) {
      queryFetchResults.remove(shardResult.shardTarget());
    }
  }
  String scrollId=null;
  if (request.scroll() != null) {
    scrollId=TransportSearchHelper.buildScrollId(this.scrollId.type(),queryFetchResults.values(),this.scrollId.attributes());
  }
  searchCache.releaseQueryFetchResults(queryFetchResults);
  listener.onResponse(new SearchResponse(internalResponse,scrollId,this.scrollId.context().length,successfulOps.get(),System.currentTimeMillis() - startTime,buildShardFailures(shardFailures,searchCache)));
}
