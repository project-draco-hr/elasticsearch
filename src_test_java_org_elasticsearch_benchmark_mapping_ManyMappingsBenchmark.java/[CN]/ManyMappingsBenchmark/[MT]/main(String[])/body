{
  System.setProperty("es.logger.prefix","");
  Natives.tryMlockall();
  Settings settings=settingsBuilder().put("index.refresh_interval","-1").put("gateway.type","local").put(SETTING_NUMBER_OF_SHARDS,5).put(SETTING_NUMBER_OF_REPLICAS,0).put(TransportModule.TRANSPORT_TYPE_KEY,"local").build();
  String clusterName=ManyMappingsBenchmark.class.getSimpleName();
  Node node=nodeBuilder().clusterName(clusterName).settings(settingsBuilder().put(settings)).node();
  Client client=node.client();
  client.admin().indices().prepareDelete(INDEX_NAME).setIndicesOptions(IndicesOptions.lenientExpandOpen()).get();
  client.admin().indices().prepareCreate(INDEX_NAME).addMapping(TYPE_NAME,MAPPING).get();
  BulkRequestBuilder builder=client.prepareBulk();
  int fieldCount=0;
  long time=System.currentTimeMillis();
  final int PRINT=1000;
  for (int i=0; i < DOC_COUNT; i++) {
    XContentBuilder sourceBuilder=jsonBuilder().startObject();
    sourceBuilder.field(++fieldCount + "_ss","xyz");
    sourceBuilder.field(++fieldCount + "_dt",System.currentTimeMillis());
    sourceBuilder.field(++fieldCount + "_i",i % 100);
    sourceBuilder.endObject();
    if (fieldCount >= FIELD_COUNT) {
      fieldCount=0;
      System.out.println("dynamic fields rolled up");
    }
    builder.add(client.prepareIndex(INDEX_NAME,TYPE_NAME,String.valueOf(i)).setSource(sourceBuilder));
    if (builder.numberOfActions() >= 1000) {
      builder.get();
      builder=client.prepareBulk();
    }
    if (i % PRINT == 0) {
      long took=System.currentTimeMillis() - time;
      time=System.currentTimeMillis();
      System.out.println("Indexed " + i + " docs, in "+ TimeValue.timeValueMillis(took));
    }
  }
  if (builder.numberOfActions() > 0) {
    builder.get();
  }
}
