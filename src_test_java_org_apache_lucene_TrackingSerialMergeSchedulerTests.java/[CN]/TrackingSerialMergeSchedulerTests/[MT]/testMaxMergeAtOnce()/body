{
  Directory dir=newDirectory();
  IndexWriterConfig iwc=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random()));
  EnableMergeScheduler mergeScheduler=new EnableMergeScheduler(new TrackingSerialMergeScheduler(Loggers.getLogger(getTestClass()),2));
  iwc.setMergeScheduler(mergeScheduler);
  TieredMergePolicy mergePolicy=new TieredMergePolicy();
  mergePolicy.setMaxMergeAtOnceExplicit(3);
  mergePolicy.setMaxMergeAtOnce(3);
  iwc.setMergePolicy(mergePolicy);
  IndexWriter iw=new IndexWriter(dir,iwc);
  for (int i=0; i < 20; i++) {
    Document doc=new Document();
    doc.add(new StringField("id",Integer.toString(i),Field.Store.NO));
    iw.addDocument(doc);
    iw.commit();
  }
  for (int i=0; i < 4; i++) {
    assertTrue(iw.hasPendingMerges());
    Merges.maybeMerge(iw);
    assertTrue(iw.hasPendingMerges());
  }
  Merges.maybeMerge(iw);
  assertFalse(iw.hasPendingMerges());
  iw.close(false);
  dir.close();
}
