{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").addMapping("child",jsonBuilder().startObject().startObject("type").startObject("_parent").field("type","parent").endObject().endObject().endObject()).addMapping("child1",jsonBuilder().startObject().startObject("type").startObject("_parent").field("type","parent").endObject().endObject().endObject()).setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",2).put("index.number_of_replicas",0)).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  client.prepareIndex("test","parent","1").setSource("p_field","p_value1").execute().actionGet();
  client.prepareIndex("test","child","1").setSource("c_field1",1,"c_field2",0).setParent("1").execute().actionGet();
  client.prepareIndex("test","child","2").setSource("c_field1",1,"c_field2",0).setParent("1").execute().actionGet();
  client.prepareIndex("test","child","3").setSource("c_field1",2,"c_field2",0).setParent("1").execute().actionGet();
  client.prepareIndex("test","child","4").setSource("c_field1",2,"c_field2",0).setParent("1").execute().actionGet();
  client.prepareIndex("test","child","5").setSource("c_field1",1,"c_field2",1).setParent("1").execute().actionGet();
  client.prepareIndex("test","child","6").setSource("c_field1",1,"c_field2",2).setParent("1").execute().actionGet();
  client.prepareIndex("test","parent","2").setSource("p_field","p_value2").execute().actionGet();
  client.prepareIndex("test","child","7").setSource("c_field1",3,"c_field2",0).setParent("2").execute().actionGet();
  client.prepareIndex("test","child","8").setSource("c_field1",1,"c_field2",1).setParent("2").execute().actionGet();
  client.prepareIndex("test","child","9").setSource("c_field1",1,"c_field2",1).setParent("p").execute().actionGet();
  client.prepareIndex("test","child","10").setSource("c_field1",1,"c_field2",1).setParent("2").execute().actionGet();
  client.prepareIndex("test","child","11").setSource("c_field1",1,"c_field2",1).setParent("2").execute().actionGet();
  client.prepareIndex("test","child","12").setSource("c_field1",1,"c_field2",2).setParent("2").execute().actionGet();
  client.prepareIndex("test","parent","3").setSource("p_field1","p_value3","p_field2",5).execute().actionGet();
  client.prepareIndex("test","child","13").setSource("c_field1",4,"c_field2",0,"c_field3",0).setParent("3").execute().actionGet();
  client.prepareIndex("test","child","14").setSource("c_field1",1,"c_field2",1,"c_field3",1).setParent("3").execute().actionGet();
  client.prepareIndex("test","child","15").setSource("c_field1",1,"c_field2",2,"c_field3",2).setParent("3").execute().actionGet();
  client.prepareIndex("test","child","16").setSource("c_field1",1,"c_field2",2,"c_field3",3).setParent("3").execute().actionGet();
  client.prepareIndex("test","child","17").setSource("c_field1",1,"c_field2",2,"c_field3",4).setParent("3").execute().actionGet();
  client.prepareIndex("test","child","18").setSource("c_field1",1,"c_field2",2,"c_field3",5).setParent("3").execute().actionGet();
  client.prepareIndex("test","child1","1").setSource("c_field1",1,"c_field2",2,"c_field3",6).setParent("3").execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse response=client.prepareSearch("test").setQuery(QueryBuilders.hasChildQuery("child",QueryBuilders.customScoreQuery(matchQuery("c_field2",0)).script("doc['c_field1'].value")).scoreType("sum")).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("1"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(4f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(3f));
  response=client.prepareSearch("test").setQuery(QueryBuilders.hasChildQuery("child",QueryBuilders.customScoreQuery(matchQuery("c_field2",0)).script("doc['c_field1'].value")).scoreType("max")).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(4f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("1"));
  assertThat(response.getHits().hits()[2].score(),equalTo(2f));
  response=client.prepareSearch("test").setQuery(QueryBuilders.hasChildQuery("child",QueryBuilders.customScoreQuery(matchQuery("c_field2",0)).script("doc['c_field1'].value")).scoreType("avg")).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(4f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("1"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1.5f));
  response=client.prepareSearch("test").setQuery(QueryBuilders.hasParentQuery("parent",QueryBuilders.customScoreQuery(matchQuery("p_field1","p_value3")).script("doc['p_field2'].value")).scoreType("score")).addSort(SortBuilders.fieldSort("c_field3")).addSort(SortBuilders.scoreSort()).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(7l));
  assertThat(response.getHits().hits()[0].id(),equalTo("13"));
  assertThat(response.getHits().hits()[0].score(),equalTo(5f));
  assertThat(response.getHits().hits()[1].id(),equalTo("14"));
  assertThat(response.getHits().hits()[1].score(),equalTo(5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("15"));
  assertThat(response.getHits().hits()[2].score(),equalTo(5f));
  assertThat(response.getHits().hits()[3].id(),equalTo("16"));
  assertThat(response.getHits().hits()[3].score(),equalTo(5f));
  assertThat(response.getHits().hits()[4].id(),equalTo("17"));
  assertThat(response.getHits().hits()[4].score(),equalTo(5f));
  assertThat(response.getHits().hits()[5].id(),equalTo("18"));
  assertThat(response.getHits().hits()[5].score(),equalTo(5f));
  assertThat(response.getHits().hits()[6].id(),equalTo("1"));
  assertThat(response.getHits().hits()[6].score(),equalTo(5f));
}
