{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1).put("index.number_of_replicas",0)).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  client.admin().indices().preparePutMapping("test").setType("child").setSource(jsonBuilder().startObject().startObject("type").startObject("_parent").field("type","parent").endObject().endObject().endObject()).execute().actionGet();
  int numberOfParents=4;
  int numberOfChildrenPerParent=123;
  for (int i=1; i <= numberOfParents; i++) {
    String parentId=String.format(Locale.ROOT,"p%d",i);
    client.prepareIndex("test","parent",parentId).setSource("p_field",String.format(Locale.ROOT,"p_value%d",i)).execute().actionGet();
    for (int j=1; j <= numberOfChildrenPerParent; j++) {
      client.prepareIndex("test","child",String.format(Locale.ROOT,"%s_c%d",parentId,j)).setSource("c_field1",parentId,"c_field2",i % 2 == 0 ? "even" : "not_even").setParent(parentId).execute().actionGet();
    }
  }
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch("test").setQuery(topChildrenQuery("child",termQuery("c_field1","p3"))).execute().actionGet();
  assertThat("Failures " + Arrays.toString(searchResponse.getShardFailures()),searchResponse.getShardFailures().length,equalTo(0));
  assertThat(searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("p3"));
  searchResponse=client.prepareSearch("test").setQuery(topChildrenQuery("child",termQuery("c_field2","even"))).execute().actionGet();
  assertThat("Failures " + Arrays.toString(searchResponse.getShardFailures()),searchResponse.getShardFailures().length,equalTo(0));
  assertThat(searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("p2"));
}
