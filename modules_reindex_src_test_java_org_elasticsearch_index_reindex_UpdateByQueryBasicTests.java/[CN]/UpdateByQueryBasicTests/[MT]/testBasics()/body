{
  indexRandom(true,client().prepareIndex("test","test","1").setSource("foo","a"),client().prepareIndex("test","test","2").setSource("foo","a"),client().prepareIndex("test","test","3").setSource("foo","b"),client().prepareIndex("test","test","4").setSource("foo","c"));
  assertHitCount(client().prepareSearch("test").setTypes("test").setSize(0).get(),4);
  assertEquals(1,client().prepareGet("test","test","1").get().getVersion());
  assertEquals(1,client().prepareGet("test","test","4").get().getVersion());
  assertThat(updateByQuery().source("test").refresh(true).get(),matcher().updated(4));
  assertEquals(2,client().prepareGet("test","test","1").get().getVersion());
  assertEquals(2,client().prepareGet("test","test","4").get().getVersion());
  assertThat(updateByQuery().source("test").filter(termQuery("foo","no_match")).refresh(true).get(),matcher().updated(0));
  assertEquals(2,client().prepareGet("test","test","1").get().getVersion());
  assertEquals(2,client().prepareGet("test","test","4").get().getVersion());
  assertThat(updateByQuery().source("test").filter(termQuery("foo","a")).refresh(true).get(),matcher().updated(2));
  assertEquals(3,client().prepareGet("test","test","1").get().getVersion());
  assertEquals(3,client().prepareGet("test","test","2").get().getVersion());
  assertEquals(2,client().prepareGet("test","test","3").get().getVersion());
  assertEquals(2,client().prepareGet("test","test","4").get().getVersion());
  UpdateByQueryRequestBuilder request=updateByQuery().source("test").size(3).refresh(true);
  request.source().addSort("foo.keyword",SortOrder.ASC);
  assertThat(request.get(),matcher().updated(3));
  assertEquals(4,client().prepareGet("test","test","1").get().getVersion());
  assertEquals(4,client().prepareGet("test","test","2").get().getVersion());
  assertEquals(3,client().prepareGet("test","test","3").get().getVersion());
  assertEquals(2,client().prepareGet("test","test","4").get().getVersion());
}
