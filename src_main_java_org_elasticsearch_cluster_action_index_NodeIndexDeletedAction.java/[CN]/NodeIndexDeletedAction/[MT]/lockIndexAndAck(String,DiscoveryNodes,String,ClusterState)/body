{
  try {
    final List<ShardLock> locks=nodeEnv.lockAllForIndex(new Index(index),TimeUnit.MINUTES.toMillis(30));
    try {
      if (nodes.localNodeMaster()) {
        innerNodeIndexStoreDeleted(index,nodeId);
      }
 else {
        transportService.sendRequest(clusterState.nodes().masterNode(),INDEX_STORE_DELETED_ACTION_NAME,new NodeIndexStoreDeletedMessage(index,nodeId),EmptyTransportResponseHandler.INSTANCE_SAME);
      }
    }
  finally {
      IOUtils.close(locks);
    }
  }
 catch (  LockObtainFailedException exc) {
    logger.warn("[{}] failed to lock all shards for index - timed out after 30 seconds",index);
  }
}
