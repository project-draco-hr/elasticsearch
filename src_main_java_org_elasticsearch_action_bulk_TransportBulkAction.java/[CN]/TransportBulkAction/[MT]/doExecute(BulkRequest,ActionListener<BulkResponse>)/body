{
  final long startTime=System.currentTimeMillis();
  final AtomicArray<BulkItemResponse> responses=new AtomicArray<>(bulkRequest.requests.size());
  if (autoCreateIndex.needToCheck()) {
    final Set<String> indices=Sets.newHashSet();
    for (    ActionRequest request : bulkRequest.requests) {
      if (request instanceof DocumentRequest) {
        DocumentRequest req=(DocumentRequest)request;
        if (!indices.contains(req.index())) {
          indices.add(req.index());
        }
      }
 else {
        throw new ElasticsearchException("Parsed unknown request in bulk actions: " + request.getClass().getSimpleName());
      }
    }
    final AtomicInteger counter=new AtomicInteger(indices.size());
    ClusterState state=clusterService.state();
    for (    final String index : indices) {
      if (autoCreateIndex.shouldAutoCreate(index,state)) {
        createIndexAction.execute(new CreateIndexRequest(bulkRequest).index(index).cause("auto(bulk api)").masterNodeTimeout(bulkRequest.timeout()),new ActionListener<CreateIndexResponse>(){
          @Override public void onResponse(          CreateIndexResponse result){
            if (counter.decrementAndGet() == 0) {
              try {
                executeBulk(bulkRequest,startTime,listener,responses);
              }
 catch (              Throwable t) {
                listener.onFailure(t);
              }
            }
          }
          @Override public void onFailure(          Throwable e){
            if (!(ExceptionsHelper.unwrapCause(e) instanceof IndexAlreadyExistsException)) {
              for (int i=0; i < bulkRequest.requests.size(); i++) {
                ActionRequest request=bulkRequest.requests.get(i);
                if (request != null && setResponseFailureIfIndexMatches(responses,i,request,index,e)) {
                  bulkRequest.requests.set(i,null);
                }
              }
            }
            if (counter.decrementAndGet() == 0) {
              try {
                executeBulk(bulkRequest,startTime,listener,responses);
              }
 catch (              Throwable t) {
                listener.onFailure(t);
              }
            }
          }
        }
);
      }
 else {
        if (counter.decrementAndGet() == 0) {
          executeBulk(bulkRequest,startTime,listener,responses);
        }
      }
    }
  }
 else {
    executeBulk(bulkRequest,startTime,listener,responses);
  }
}
