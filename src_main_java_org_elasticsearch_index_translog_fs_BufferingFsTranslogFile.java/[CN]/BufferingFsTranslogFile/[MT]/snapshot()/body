{
  if (channelReference.tryIncRef()) {
    boolean success=false;
    try {
      rwl.writeLock().lock();
      try {
        flushBuffer();
        FsChannelSnapshot snapshot=new FsChannelSnapshot(this.id,channelReference,lastWrittenPosition,operationCounter);
        snapshot.seekTo(this.headerSize);
        success=true;
        return snapshot;
      }
 catch (      Exception e) {
        throw new TranslogException(shardId,"exception while creating snapshot",e);
      }
 finally {
        rwl.writeLock().unlock();
      }
    }
  finally {
      if (!success) {
        channelReference.decRef();
      }
    }
  }
  return null;
}
