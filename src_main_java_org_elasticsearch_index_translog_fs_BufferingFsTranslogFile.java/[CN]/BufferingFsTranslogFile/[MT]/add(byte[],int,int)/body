{
  rwl.writeLock().lock();
  try {
    operationCounter++;
    long position=lastPosition;
    if (size >= buffer.length) {
      flushBuffer();
      raf.channel().write(ByteBuffer.wrap(data,from,size));
      lastWrittenPosition+=size;
      lastPosition+=size;
      return new Translog.Location(id,position,size);
    }
    if (size > buffer.length - bufferCount) {
      flushBuffer();
    }
    System.arraycopy(data,from,buffer,bufferCount,size);
    bufferCount+=size;
    lastPosition+=size;
    return new Translog.Location(id,position,size);
  }
  finally {
    rwl.writeLock().unlock();
  }
}
