{
  QueryValidationException exception=checkLatLon(shardContext.indexVersionCreated().before(Version.V_2_0_0));
  if (exception != null) {
    throw new QueryShardException(shardContext,"couldn't validate latitude/ longitude values",exception);
  }
  if (GeoValidationMethod.isCoerce(validationMethod)) {
    GeoUtils.normalizePoint(center,true,true);
  }
  double normDistance=geoDistance.normalize(this.distance,DistanceUnit.DEFAULT);
  MappedFieldType fieldType=shardContext.fieldMapper(fieldName);
  if (fieldType == null) {
    throw new QueryShardException(shardContext,"failed to find geo_point field [" + fieldName + "]");
  }
  if (!(fieldType instanceof GeoPointFieldMapper.GeoPointFieldType)) {
    throw new QueryShardException(shardContext,"field [" + fieldName + "] is not a geo_point field");
  }
  GeoPointFieldMapper.GeoPointFieldType geoFieldType=((GeoPointFieldMapper.GeoPointFieldType)fieldType);
  IndexGeoPointFieldData indexFieldData=shardContext.getForField(fieldType);
  Query query=new GeoDistanceRangeQuery(center,null,normDistance,true,false,geoDistance,geoFieldType,indexFieldData,optimizeBbox);
  return query;
}
