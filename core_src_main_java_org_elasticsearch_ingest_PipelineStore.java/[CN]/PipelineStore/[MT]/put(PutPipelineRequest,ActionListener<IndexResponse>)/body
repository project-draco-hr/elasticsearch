{
  ensureReady();
  try {
    Map<String,Object> pipelineConfig=XContentHelper.convertToMap(request.source(),false).v2();
    constructPipeline(request.id(),pipelineConfig);
  }
 catch (  Exception e) {
    throw new IllegalArgumentException("Invalid pipeline configuration",e);
  }
  ClusterState state=clusterService.state();
  if (isIngestIndexPresent(state)) {
    innerPut(request,listener);
  }
 else {
    CreateIndexRequest createIndexRequest=new CreateIndexRequest(INDEX);
    createIndexRequest.settings(INGEST_INDEX_SETTING);
    createIndexRequest.mapping(TYPE,PIPELINE_MAPPING);
    client.admin().indices().create(createIndexRequest,new ActionListener<CreateIndexResponse>(){
      @Override public void onResponse(      CreateIndexResponse createIndexResponse){
        innerPut(request,listener);
      }
      @Override public void onFailure(      Throwable e){
        listener.onFailure(e);
      }
    }
);
  }
}
