{
  rwl.writeLock().lock();
  try {
    FsTranslogFile newFile;
    long size=Long.MAX_VALUE;
    Path location=null;
    for (    Path file : locations) {
      long currentFree=Files.getFileStore(file).getUsableSpace();
      if (currentFree < size) {
        size=currentFree;
        location=file;
      }
    }
    try {
      newFile=type.create(shardId,id,new InternalChannelReference(location.resolve(getPath(id)),StandardOpenOption.READ,StandardOpenOption.WRITE,StandardOpenOption.CREATE_NEW),bufferSize);
    }
 catch (    IOException e) {
      throw new TranslogException(shardId,"failed to create new translog file",e);
    }
    FsTranslogFile old=current;
    current=newFile;
    IOUtils.close(old);
  }
  finally {
    rwl.writeLock().unlock();
  }
}
