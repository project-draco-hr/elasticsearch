{
  rwl.readLock().lock();
  try {
    BytesStreamOutput out=new BytesStreamOutput();
    out.writeInt(0);
    TranslogStreams.writeTranslogOperation(out,operation);
    out.flush();
    int size=out.size();
    out.seek(0);
    out.writeInt(size - 4);
    out.seek(size);
    BytesReference ref=out.bytes();
    if (!ref.hasArray()) {
      ref=ref.toBytesArray();
    }
    byte[] refBytes=ref.array();
    int refBytesOffset=ref.arrayOffset();
    Location location=current.add(refBytes,refBytesOffset,size);
    if (syncOnEachOperation) {
      current.sync();
    }
    FsTranslogFile trans=this.trans;
    if (trans != null) {
      try {
        location=trans.add(refBytes,refBytesOffset,size);
      }
 catch (      ClosedChannelException e) {
      }
    }
    return location;
  }
 catch (  Exception e) {
    throw new TranslogException(shardId,"Failed to write operation [" + operation + "]",e);
  }
 finally {
    rwl.readLock().unlock();
  }
}
