{
  String field=null;
  int size=10;
  String fieldName=null;
  XContentParser.Token token;
  ImmutableSet<String> excluded=ImmutableSet.of();
  String regex=null;
  String regexFlags=null;
  TermsFacet.ComparatorType comparatorType=TermsFacet.ComparatorType.COUNT;
  String scriptLang=null;
  String script=null;
  Map<String,Object> params=null;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      fieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if ("params".equals(fieldName)) {
        params=parser.map();
      }
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("exclude".equals(fieldName)) {
        ImmutableSet.Builder<String> builder=ImmutableSet.builder();
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          builder.add(parser.text());
        }
        excluded=builder.build();
      }
    }
 else     if (token.isValue()) {
      if ("field".equals(fieldName)) {
        field=parser.text();
      }
 else       if ("size".equals(fieldName)) {
        size=parser.intValue();
      }
 else       if ("regex".equals(fieldName)) {
        regex=parser.text();
      }
 else       if ("regex_flags".equals(fieldName) || "regexFlags".equals(fieldName)) {
        regexFlags=parser.text();
      }
 else       if ("order".equals(fieldName) || "comparator".equals(field)) {
        comparatorType=TermsFacet.ComparatorType.fromString(parser.text());
      }
 else       if ("script".equals(fieldName)) {
        script=parser.text();
      }
 else       if ("lang".equals(fieldName)) {
        scriptLang=parser.text();
      }
    }
  }
  if ("_index".equals(field)) {
    return new IndexNameFacetCollector(facetName,context.shardTarget().index(),comparatorType,size);
  }
  Pattern pattern=null;
  if (regex != null) {
    pattern=Regex.compile(regex,regexFlags);
  }
  return new TermsFacetCollector(facetName,field,size,comparatorType,context,excluded,pattern,scriptLang,script,params);
}
