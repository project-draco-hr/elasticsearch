{
  String field=null;
  int size=10;
  String fieldName=null;
  XContentParser.Token token;
  ImmutableSet<String> excluded=ImmutableSet.of();
  String regex=null;
  String regexFlags=null;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      fieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("exclude".equals(fieldName)) {
        ImmutableSet.Builder<String> builder=ImmutableSet.builder();
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          builder.add(parser.text());
        }
        excluded=builder.build();
      }
    }
 else     if (token.isValue()) {
      if ("field".equals(fieldName)) {
        field=parser.text();
      }
 else       if ("size".equals(fieldName)) {
        size=parser.intValue();
      }
 else       if ("regex".equals(fieldName)) {
        regex=parser.text();
      }
 else       if ("regex_flags".equals(fieldName) || "regexFlags".equals(fieldName)) {
        regexFlags=parser.text();
      }
    }
  }
  Pattern pattern=null;
  if (regex != null) {
    pattern=Regex.compile(regex,regexFlags);
  }
  return new TermsFacetCollector(facetName,field,size,context.numberOfShards(),context.fieldDataCache(),context.mapperService(),excluded,pattern);
}
