{
  ReaderValue readerValue=cache.cache.get(reader.getCoreCacheKey());
  if (readerValue == null) {
    LongsLAB longsLAB=null;
    if (cache.labEnabled) {
      longsLAB=new LongsLAB(cache.labChunkSizeBytes,cache.labMaxAllocBytes);
    }
    readerValue=new ReaderValue(cache.buildFilterMap(),longsLAB);
    ReaderValue prev=cache.cache.putIfAbsent(reader.getCoreCacheKey(),readerValue);
    if (prev != null) {
      readerValue=prev;
    }
  }
  DocSet docSet=readerValue.filters().get(filter);
  if (docSet != null) {
    return docSet;
  }
  DocIdSet docIdSet=filter.getDocIdSet(reader);
  docSet=cacheable(reader,readerValue,docIdSet);
  DocSet prev=readerValue.filters().putIfAbsent(filter,docSet);
  if (prev != null) {
    docSet=prev;
  }
  return docSet;
}
