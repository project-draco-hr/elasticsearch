{
  FilterCacheValue<ConcurrentMap<Filter,DocSet>> cacheValue=cache.cache.get(reader.getCoreCacheKey());
  if (cacheValue == null) {
    LongsLAB longsLAB=null;
    if (cache.labEnabled) {
      longsLAB=new LongsLAB(cache.labChunkSizeBytes,cache.labMaxAllocBytes);
    }
    cacheValue=new FilterCacheValue<ConcurrentMap<Filter,DocSet>>(cache.buildFilterMap(),longsLAB);
    FilterCacheValue<ConcurrentMap<Filter,DocSet>> prev=cache.cache.putIfAbsent(reader.getCoreCacheKey(),cacheValue);
    if (prev != null) {
      cacheValue=prev;
    }
 else {
      reader.addReaderFinishedListener(cache);
    }
  }
  DocSet docSet=cacheValue.value().get(filter);
  if (docSet != null) {
    return docSet;
  }
  DocIdSet docIdSet=filter.getDocIdSet(reader);
  docSet=FilterCacheValue.cacheable(reader,cacheValue.longsLAB(),docIdSet);
  DocSet prev=cacheValue.value().putIfAbsent(filter,docSet);
  if (prev != null) {
    docSet=prev;
  }
  return docSet == DocSet.EMPTY_DOC_SET ? null : docSet;
}
