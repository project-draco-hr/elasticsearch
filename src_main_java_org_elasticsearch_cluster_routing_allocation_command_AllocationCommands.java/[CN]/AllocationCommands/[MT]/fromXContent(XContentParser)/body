{
  AllocationCommands commands=new AllocationCommands();
  XContentParser.Token token=parser.nextToken();
  if (token == null) {
    throw new ElasticSearchParseException("No commands");
  }
  if (token != XContentParser.Token.START_OBJECT) {
    throw new ElasticSearchParseException("No start object, got " + token);
  }
  token=parser.nextToken();
  if (token != XContentParser.Token.FIELD_NAME) {
    throw new ElasticSearchParseException("expected the field name `commands` to exists, got " + token);
  }
  if (!parser.currentName().equals("commands")) {
    throw new ElasticSearchParseException("expected field name to be named `commands`, got " + parser.currentName());
  }
  token=parser.nextToken();
  if (token != XContentParser.Token.START_ARRAY) {
    throw new ElasticSearchParseException("commands should follow with an array element");
  }
  while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
    if (token == XContentParser.Token.START_OBJECT) {
      token=parser.nextToken();
      String commandName=parser.currentName();
      token=parser.nextToken();
      commands.add(AllocationCommands.lookupFactorySafe(commandName).fromXContent(parser));
      if (parser.nextToken() != XContentParser.Token.END_OBJECT) {
        throw new ElasticSearchParseException("allocation command is malformed, done parsing a command, but didn't get END_OBJECT, got " + token);
      }
    }
 else {
      throw new ElasticSearchParseException("allocation command is malformed, got token " + token);
    }
  }
  return commands;
}
