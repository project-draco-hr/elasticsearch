{
  boolean http10=nettyRequest.getProtocolVersion().equals(HttpVersion.HTTP_1_0);
  boolean close=HttpHeaders.Values.CLOSE.equalsIgnoreCase(nettyRequest.headers().get(HttpHeaders.Names.CONNECTION)) || (http10 && !HttpHeaders.Values.KEEP_ALIVE.equalsIgnoreCase(nettyRequest.headers().get(HttpHeaders.Names.CONNECTION)));
  HttpResponseStatus status=getStatus(response.status());
  org.jboss.netty.handler.codec.http.HttpResponse resp;
  if (http10) {
    resp=new DefaultHttpResponse(HttpVersion.HTTP_1_0,status);
    if (!close) {
      resp.headers().add(HttpHeaders.Names.CONNECTION,"Keep-Alive");
    }
  }
 else {
    resp=new DefaultHttpResponse(HttpVersion.HTTP_1_1,status);
  }
  if (RestUtils.isBrowser(nettyRequest.headers().get(HttpHeaders.Names.USER_AGENT))) {
    if (transport.settings().getAsBoolean("http.cors.enabled",true)) {
      resp.headers().add("Access-Control-Allow-Origin",transport.settings().get("http.cors.allow-origin","*"));
      if (nettyRequest.getMethod() == HttpMethod.OPTIONS) {
        resp.headers().add("Access-Control-Max-Age",transport.settings().getAsInt("http.cors.max-age",1728000));
        resp.headers().add("Access-Control-Allow-Methods",transport.settings().get("http.cors.allow-methods","OPTIONS, HEAD, GET, POST, PUT, DELETE"));
        resp.headers().add("Access-Control-Allow-Headers",transport.settings().get("http.cors.allow-headers","X-Requested-With, Content-Type, Content-Length"));
      }
    }
  }
  String opaque=nettyRequest.headers().get("X-Opaque-Id");
  if (opaque != null) {
    resp.headers().add("X-Opaque-Id",opaque);
  }
  Map<String,List<String>> customHeaders=response.getHeaders();
  if (customHeaders != null) {
    for (    Map.Entry<String,List<String>> headerEntry : customHeaders.entrySet()) {
      for (      String headerValue : headerEntry.getValue()) {
        resp.headers().add(headerEntry.getKey(),headerValue);
      }
    }
  }
  BytesReference content=response.content();
  ChannelBuffer buffer;
  boolean addedReleaseListener=false;
  try {
    if (response.contentThreadSafe()) {
      buffer=content.toChannelBuffer();
    }
 else {
      buffer=content.copyBytesArray().toChannelBuffer();
    }
    String callback=request.param("callback");
    if (callback != null) {
      final BytesRef callbackBytes=new BytesRef(callback.length() * 4 + 1);
      UnicodeUtil.UTF16toUTF8(callback,0,callback.length(),callbackBytes);
      callbackBytes.bytes[callbackBytes.length]='(';
      callbackBytes.length++;
      buffer=ChannelBuffers.wrappedBuffer(ChannelBuffers.wrappedBuffer(callbackBytes.bytes,callbackBytes.offset,callbackBytes.length),buffer,ChannelBuffers.wrappedBuffer(END_JSONP));
    }
    resp.setContent(buffer);
    resp.headers().add(HttpHeaders.Names.CONTENT_TYPE,response.contentType());
    resp.headers().add(HttpHeaders.Names.CONTENT_LENGTH,String.valueOf(buffer.readableBytes()));
    if (transport.resetCookies) {
      String cookieString=nettyRequest.headers().get(HttpHeaders.Names.COOKIE);
      if (cookieString != null) {
        CookieDecoder cookieDecoder=new CookieDecoder();
        Set<Cookie> cookies=cookieDecoder.decode(cookieString);
        if (!cookies.isEmpty()) {
          CookieEncoder cookieEncoder=new CookieEncoder(true);
          for (          Cookie cookie : cookies) {
            cookieEncoder.addCookie(cookie);
          }
          resp.headers().add(HttpHeaders.Names.SET_COOKIE,cookieEncoder.encode());
        }
      }
    }
    ChannelFuture future=channel.write(resp);
    if (response.contentThreadSafe() && content instanceof Releasable) {
      future.addListener(new ReleaseChannelFutureListener((Releasable)content));
      addedReleaseListener=true;
    }
    if (close) {
      future.addListener(ChannelFutureListener.CLOSE);
    }
  }
  finally {
    if (!addedReleaseListener && content instanceof Releasable) {
      ((Releasable)content).close();
    }
  }
}
