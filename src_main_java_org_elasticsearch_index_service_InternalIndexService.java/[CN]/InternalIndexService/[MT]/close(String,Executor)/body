{
synchronized (this) {
    closed=true;
  }
  Set<Integer> shardIds=shardIds();
  final CountDownLatch latch=new CountDownLatch(shardIds.size());
  for (  final int shardId : shardIds) {
    executor=executor == null ? threadPool.generic() : executor;
    executor.execute(new Runnable(){
      @Override public void run(){
        try {
          removeShard(shardId,reason);
        }
 catch (        Throwable e) {
          logger.warn("failed to close shard",e);
        }
 finally {
          latch.countDown();
        }
      }
    }
);
  }
  try {
    latch.await();
  }
 catch (  InterruptedException e) {
    logger.debug("Interrupted closing index [{}]",e,index().name());
    Thread.currentThread().interrupt();
  }
}
