{
  String threadPoolName=randomThreadPoolName();
  for (  String name : new String[]{ThreadPool.Names.BULK,ThreadPool.Names.INDEX}) {
    ThreadPool threadPool=null;
    try {
      int maxSize=EsExecutors.boundedNumberOfProcessors(Settings.EMPTY);
      threadPool=new ThreadPool(Settings.builder().put("node.name","testIndexingThreadPoolsMaxSize").put("threadpool." + name + ".size",maxSize + 1).build());
      assertEquals(maxSize,((ThreadPoolExecutor)threadPool.executor(name)).getMaximumPoolSize());
      ClusterSettings clusterSettings=new ClusterSettings(Settings.EMPTY,ClusterSettings.BUILT_IN_CLUSTER_SETTINGS);
      threadPool.setClusterSettings(clusterSettings);
      clusterSettings.applySettings(Settings.builder().put("threadpool." + name + ".size",1).build());
      assertEquals(1,((ThreadPoolExecutor)threadPool.executor(name)).getMaximumPoolSize());
      clusterSettings.applySettings(Settings.builder().put("threadpool." + name + ".size",maxSize + 1).build());
      assertEquals(maxSize,((ThreadPoolExecutor)threadPool.executor(name)).getMaximumPoolSize());
    }
  finally {
      terminateThreadPoolIfNeeded(threadPool);
    }
  }
}
