{
  String threadPoolName=randomThreadPool(ThreadPool.ThreadPoolType.SCALING);
  ThreadPool threadPool=null;
  try {
    Settings nodeSettings=Settings.builder().put("threadpool." + threadPoolName + ".size",10).put("node.name","testScalingExecutorType").build();
    threadPool=new ThreadPool(nodeSettings);
    ClusterSettings clusterSettings=new ClusterSettings(nodeSettings,ClusterSettings.BUILT_IN_CLUSTER_SETTINGS);
    threadPool.setClusterSettings(clusterSettings);
    final int expectedMinimum="generic".equals(threadPoolName) ? 4 : 1;
    assertThat(info(threadPool,threadPoolName).getMin(),equalTo(expectedMinimum));
    assertThat(info(threadPool,threadPoolName).getMax(),equalTo(10));
    final long expectedKeepAlive="generic".equals(threadPoolName) ? 30 : 300;
    assertThat(info(threadPool,threadPoolName).getKeepAlive().seconds(),equalTo(expectedKeepAlive));
    assertEquals(info(threadPool,threadPoolName).getThreadPoolType(),ThreadPool.ThreadPoolType.SCALING);
    assertThat(threadPool.executor(threadPoolName),instanceOf(EsThreadPoolExecutor.class));
    Executor oldExecutor=threadPool.executor(threadPoolName);
    clusterSettings.applySettings(Settings.builder().put("threadpool." + threadPoolName + ".keep_alive","10m").put("threadpool." + threadPoolName + ".min","2").put("threadpool." + threadPoolName + ".size","15").build());
    assertEquals(info(threadPool,threadPoolName).getThreadPoolType(),ThreadPool.ThreadPoolType.SCALING);
    assertThat(threadPool.executor(threadPoolName),instanceOf(EsThreadPoolExecutor.class));
    assertThat(((EsThreadPoolExecutor)threadPool.executor(threadPoolName)).getCorePoolSize(),equalTo(2));
    assertThat(((EsThreadPoolExecutor)threadPool.executor(threadPoolName)).getMaximumPoolSize(),equalTo(15));
    assertThat(info(threadPool,threadPoolName).getMin(),equalTo(2));
    assertThat(info(threadPool,threadPoolName).getMax(),equalTo(15));
    assertThat(info(threadPool,threadPoolName).getKeepAlive().minutes(),equalTo(10L));
    assertThat(((EsThreadPoolExecutor)threadPool.executor(threadPoolName)).getKeepAliveTime(TimeUnit.MINUTES),equalTo(10L));
    assertThat(threadPool.executor(threadPoolName),sameInstance(oldExecutor));
  }
  finally {
    terminateThreadPoolIfNeeded(threadPool);
  }
}
