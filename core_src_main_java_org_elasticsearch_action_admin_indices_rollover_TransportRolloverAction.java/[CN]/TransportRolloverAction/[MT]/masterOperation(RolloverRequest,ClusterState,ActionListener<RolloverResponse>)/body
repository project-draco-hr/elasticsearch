{
  final MetaData metaData=state.metaData();
  validate(metaData,rolloverRequest);
  final AliasOrIndex aliasOrIndex=metaData.getAliasAndIndexLookup().get(rolloverRequest.getSourceAlias());
  final IndexMetaData indexMetaData=aliasOrIndex.getIndices().get(0);
  final String sourceIndexName=indexMetaData.getIndex().getName();
  client.admin().indices().prepareStats(sourceIndexName).clear().setDocs(true).setStore(true).execute(new ActionListener<IndicesStatsResponse>(){
    @Override public void onResponse(    IndicesStatsResponse indicesStatsResponse){
      final IndexMetaData sourceIndex=metaData.index(sourceIndexName);
      DocsStats docsStats=indicesStatsResponse.getTotal().getDocs();
      long docCount=docsStats == null ? 0 : docsStats.getCount();
      StoreStats storeStats=indicesStatsResponse.getTotal().getStore();
      long sizeInBytes=storeStats == null ? 0 : storeStats.getSizeInBytes();
      long creationDate=sourceIndex.getCreationDate();
      if (satisfiesConditions(rolloverRequest.getConditions(),docCount,sizeInBytes,creationDate)) {
        final String rolloverIndexName=generateRolloverIndexName(sourceIndexName);
        boolean createRolloverIndex=metaData.index(rolloverIndexName) == null;
        if (createRolloverIndex) {
          CreateIndexClusterStateUpdateRequest updateRequest=prepareCreateIndexRequest(rolloverIndexName,rolloverRequest);
          createIndexService.createIndex(updateRequest,new ActionListener<ClusterStateUpdateResponse>(){
            @Override public void onResponse(            ClusterStateUpdateResponse response){
              indexAliasesService.indicesAliases(prepareIndicesAliasesRequest(sourceIndexName,rolloverIndexName,rolloverRequest),new IndicesAliasesListener(sourceIndexName,rolloverIndexName,listener));
            }
            @Override public void onFailure(            Throwable t){
              if (t instanceof IndexAlreadyExistsException) {
                logger.trace("[{}] failed to create rollover index",t,updateRequest.index());
              }
 else {
                logger.debug("[{}] failed to create rollover index",t,updateRequest.index());
              }
              listener.onFailure(t);
            }
          }
);
        }
 else {
          indexAliasesService.indicesAliases(prepareIndicesAliasesRequest(sourceIndexName,rolloverIndexName,rolloverRequest),new IndicesAliasesListener(sourceIndexName,rolloverIndexName,listener));
        }
      }
 else {
        listener.onResponse(new RolloverResponse(sourceIndexName,sourceIndexName));
      }
    }
    @Override public void onFailure(    Throwable e){
      listener.onFailure(e);
    }
  }
);
}
