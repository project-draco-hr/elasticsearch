{
  IngestDocument ingestDocument=RandomDocumentPicks.randomIngestDocument(random());
  Map<String,String> fields=new HashMap<>();
  Map<String,String> expectedResultMap=new HashMap<>();
  int numFields=randomIntBetween(1,5);
  for (int i=0; i < numFields; i++) {
    int numItems=randomIntBetween(1,10);
    String separator=randomFrom(SEPARATORS);
    List<String> fieldValue=new ArrayList<>(numItems);
    String expectedResult="";
    for (int j=0; j < numItems; j++) {
      String value=randomAsciiOfLengthBetween(1,10);
      fieldValue.add(value);
      expectedResult+=value;
      if (j < numItems - 1) {
        expectedResult+=separator;
      }
    }
    String fieldName=RandomDocumentPicks.addRandomField(random(),ingestDocument,fieldValue);
    expectedResultMap.put(fieldName,expectedResult);
    fields.put(fieldName,separator);
  }
  Processor processor=new JoinProcessor(fields);
  processor.execute(ingestDocument);
  for (  Map.Entry<String,String> entry : expectedResultMap.entrySet()) {
    assertThat(ingestDocument.getFieldValue(entry.getKey(),String.class),equalTo(entry.getValue()));
  }
}
