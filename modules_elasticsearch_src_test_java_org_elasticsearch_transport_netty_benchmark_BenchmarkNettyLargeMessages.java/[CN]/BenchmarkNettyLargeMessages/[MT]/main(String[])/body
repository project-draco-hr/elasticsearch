{
  final ByteSizeValue payloadSize=new ByteSizeValue(10,ByteSizeUnit.MB);
  final int NUMBER_OF_ITERATIONS=100000;
  final int NUMBER_OF_CLIENTS=5;
  final byte[] payload=new byte[(int)payloadSize.bytes()];
  Settings settings=ImmutableSettings.settingsBuilder().build();
  final ThreadPool threadPool=new CachedThreadPool(settings);
  final TransportService transportServiceServer=new TransportService(new NettyTransport(settings,threadPool),threadPool).start();
  final TransportService transportServiceClient=new TransportService(new NettyTransport(settings,threadPool),threadPool).start();
  final DiscoveryNode bigNode=new DiscoveryNode("big",new InetSocketTransportAddress("localhost",9300));
  final DiscoveryNode smallNode=bigNode;
  transportServiceClient.connectToNode(bigNode);
  transportServiceClient.connectToNode(smallNode);
  transportServiceServer.registerHandler("benchmark",new BaseTransportRequestHandler<BenchmarkMessage>(){
    @Override public BenchmarkMessage newInstance(){
      return new BenchmarkMessage();
    }
    @Override public void messageReceived(    BenchmarkMessage request,    TransportChannel channel) throws Exception {
      channel.sendResponse(request);
    }
    @Override public boolean spawn(){
      return true;
    }
  }
);
  final CountDownLatch latch=new CountDownLatch(NUMBER_OF_CLIENTS);
  for (int i=0; i < NUMBER_OF_CLIENTS; i++) {
    new Thread(new Runnable(){
      @Override public void run(){
        for (int i=0; i < NUMBER_OF_ITERATIONS; i++) {
          BenchmarkMessage message=new BenchmarkMessage(1,payload);
          transportServiceClient.submitRequest(bigNode,"benchmark",message,options().withLowType(),new BaseTransportResponseHandler<BenchmarkMessage>(){
            @Override public BenchmarkMessage newInstance(){
              return new BenchmarkMessage();
            }
            @Override public void handleResponse(            BenchmarkMessage response){
            }
            @Override public void handleException(            TransportException exp){
              exp.printStackTrace();
            }
          }
).txGet();
        }
        latch.countDown();
      }
    }
).start();
  }
  new Thread(new Runnable(){
    @Override public void run(){
      for (int i=0; i < NUMBER_OF_ITERATIONS; i++) {
        BenchmarkMessage message=new BenchmarkMessage(2,Bytes.EMPTY_ARRAY);
        long start=System.currentTimeMillis();
        transportServiceClient.submitRequest(smallNode,"benchmark",message,options().withHighType(),new BaseTransportResponseHandler<BenchmarkMessage>(){
          @Override public BenchmarkMessage newInstance(){
            return new BenchmarkMessage();
          }
          @Override public void handleResponse(          BenchmarkMessage response){
          }
          @Override public void handleException(          TransportException exp){
            exp.printStackTrace();
          }
        }
).txGet();
        long took=System.currentTimeMillis() - start;
        System.out.println("Took " + took + "ms");
      }
    }
  }
).start();
  latch.await();
}
