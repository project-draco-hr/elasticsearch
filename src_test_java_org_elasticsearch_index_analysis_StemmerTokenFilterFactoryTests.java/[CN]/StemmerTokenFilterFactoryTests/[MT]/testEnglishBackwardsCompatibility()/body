{
  int iters=scaledRandomIntBetween(20,100);
  for (int i=0; i < iters; i++) {
    Version v=ElasticsearchTestCase.randomVersion(random());
    Settings settings=ImmutableSettings.settingsBuilder().put("index.analysis.filter.my_english.type","stemmer").put("index.analysis.filter.my_english.language","english").put("index.analysis.analyzer.my_english.tokenizer","whitespace").put("index.analysis.analyzer.my_english.filter","my_english").put(SETTING_VERSION_CREATED,v).build();
    AnalysisService analysisService=AnalysisTestsHelper.createAnalysisServiceFromSettings(settings);
    TokenFilterFactory tokenFilter=analysisService.tokenFilter("my_english");
    assertThat(tokenFilter,instanceOf(StemmerTokenFilterFactory.class));
    TokenStream create=tokenFilter.create(new WhitespaceTokenizer(TEST_VERSION_CURRENT,new StringReader("foo bar")));
    NamedAnalyzer analyzer=analysisService.analyzer("my_english");
    if (v.onOrAfter(Version.V_1_3_0)) {
      assertThat(create,instanceOf(PorterStemFilter.class));
      assertAnalyzesTo(analyzer,"consolingly",new String[]{"consolingli"});
    }
 else {
      assertThat(create,instanceOf(SnowballFilter.class));
      assertAnalyzesTo(analyzer,"consolingly",new String[]{"consol"});
    }
  }
}
