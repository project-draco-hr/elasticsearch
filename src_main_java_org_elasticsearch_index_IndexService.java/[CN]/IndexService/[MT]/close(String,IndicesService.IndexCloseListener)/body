{
  if (closed.compareAndSet(false,true)) {
    final Set<Integer> shardIds=shardIds();
    final IndicesService.IndexCloseListener innerListener=listener == null ? null : new PerShardIndexCloseListener(shardIds,listener);
    for (    final int shardId : shardIds) {
      try {
        removeShard(shardId,reason,innerListener);
      }
 catch (      Throwable t) {
        logger.warn("failed to close shard",t);
      }
    }
  }
}
