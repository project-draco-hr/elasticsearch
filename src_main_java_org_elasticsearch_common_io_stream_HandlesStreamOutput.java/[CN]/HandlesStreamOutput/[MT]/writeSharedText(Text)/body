{
  int length;
  if (text.hasBytes()) {
    length=text.bytes().length();
  }
 else {
    length=text.string().length();
  }
  if (length < identityThreshold) {
    int handle=handlesText.get(text);
    if (handle == -1) {
      handle=handlesText.size();
      handlesText.put(text,handle);
      out.writeByte((byte)0);
      out.writeVInt(handle);
      out.writeText(text);
    }
 else {
      out.writeByte((byte)1);
      out.writeVInt(handle);
    }
  }
 else {
    out.writeByte((byte)2);
    out.writeText(text);
  }
}
