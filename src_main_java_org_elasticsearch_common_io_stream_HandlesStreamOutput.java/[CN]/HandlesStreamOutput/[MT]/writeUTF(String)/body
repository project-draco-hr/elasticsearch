{
  if (s.length() < identityThreshold) {
    int handle=handles.get(s);
    if (handle == -1) {
      handle=handles.size();
      handles.put(s,handle);
      out.writeByte((byte)0);
      out.writeVInt(handle);
      out.writeUTF(s);
    }
 else {
      out.writeByte((byte)1);
      out.writeVInt(handle);
    }
  }
 else {
    int handle=identityHandles.lookup(s);
    if (handle == -1) {
      handle=identityHandles.assign(s);
      out.writeByte((byte)2);
      out.writeVInt(handle);
      out.writeUTF(s);
    }
 else {
      out.writeByte((byte)3);
      out.writeVInt(handle);
    }
  }
}
