{
  if (keyed) {
    builder.startObject(name);
  }
 else {
    builder.startArray(name);
  }
  for (  HistogramBase.Bucket bucket : buckets) {
    if (formatter != null) {
      Text keyTxt=new StringText(formatter.format(bucket.getKey()));
      if (keyed) {
        builder.startObject(keyTxt.string());
      }
 else {
        builder.startObject();
      }
      builder.field(CommonFields.KEY_AS_STRING,keyTxt);
    }
 else {
      if (keyed) {
        builder.startObject(String.valueOf(bucket.getKey()));
      }
 else {
        builder.startObject();
      }
    }
    builder.field(CommonFields.KEY,((Bucket)bucket).key);
    builder.field(CommonFields.DOC_COUNT,((Bucket)bucket).docCount);
    ((Bucket)bucket).aggregations.toXContentInternal(builder,params);
    builder.endObject();
  }
  if (keyed) {
    builder.endObject();
  }
 else {
    builder.endArray();
  }
  return builder;
}
