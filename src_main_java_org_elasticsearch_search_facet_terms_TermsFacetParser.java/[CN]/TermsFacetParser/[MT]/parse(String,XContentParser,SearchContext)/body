{
  String field=null;
  int size=10;
  int shardSize=-1;
  String[] fieldsNames=null;
  ImmutableSet<BytesRef> excluded=ImmutableSet.of();
  String regex=null;
  String regexFlags=null;
  TermsFacet.ComparatorType comparatorType=TermsFacet.ComparatorType.COUNT;
  String scriptLang=null;
  String script=null;
  Map<String,Object> params=null;
  boolean allTerms=false;
  String executionHint=null;
  String currentFieldName=null;
  XContentParser.Token token;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if ("params".equals(currentFieldName)) {
        params=parser.map();
      }
 else {
        throw new ElasticSearchParseException("unknown parameter [" + currentFieldName + "] while parsing terms facet ["+ facetName+ "]");
      }
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("exclude".equals(currentFieldName)) {
        ImmutableSet.Builder<BytesRef> builder=ImmutableSet.builder();
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          builder.add(parser.bytes());
        }
        excluded=builder.build();
      }
 else       if ("fields".equals(currentFieldName)) {
        List<String> fields=Lists.newArrayListWithCapacity(4);
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          fields.add(parser.text());
        }
        fieldsNames=fields.toArray(new String[fields.size()]);
      }
 else {
        throw new ElasticSearchParseException("unknown parameter [" + currentFieldName + "] while parsing terms facet ["+ facetName+ "]");
      }
    }
 else     if (token.isValue()) {
      if ("field".equals(currentFieldName)) {
        field=parser.text();
      }
 else       if ("script_field".equals(currentFieldName) || "scriptField".equals(currentFieldName)) {
        script=parser.text();
      }
 else       if ("size".equals(currentFieldName)) {
        size=parser.intValue();
      }
 else       if ("shard_size".equals(currentFieldName)) {
        shardSize=parser.intValue();
      }
 else       if ("all_terms".equals(currentFieldName) || "allTerms".equals(currentFieldName)) {
        allTerms=parser.booleanValue();
      }
 else       if ("regex".equals(currentFieldName)) {
        regex=parser.text();
      }
 else       if ("regex_flags".equals(currentFieldName) || "regexFlags".equals(currentFieldName)) {
        regexFlags=parser.text();
      }
 else       if ("order".equals(currentFieldName) || "comparator".equals(currentFieldName)) {
        comparatorType=TermsFacet.ComparatorType.fromString(parser.text());
      }
 else       if ("script".equals(currentFieldName)) {
        script=parser.text();
      }
 else       if ("lang".equals(currentFieldName)) {
        scriptLang=parser.text();
      }
 else       if ("execution_hint".equals(currentFieldName) || "executionHint".equals(currentFieldName)) {
        executionHint=parser.textOrNull();
      }
 else {
        throw new ElasticSearchParseException("unknown parameter [" + currentFieldName + "] while parsing terms facet ["+ facetName+ "]");
      }
    }
  }
  if ("_index".equals(field)) {
    return new IndexNameFacetExecutor(context.shardTarget().index(),comparatorType,size);
  }
  if (fieldsNames != null && fieldsNames.length == 1) {
    field=fieldsNames[0];
    fieldsNames=null;
  }
  Pattern pattern=null;
  if (regex != null) {
    pattern=Regex.compile(regex,regexFlags);
  }
  SearchScript searchScript=null;
  if (script != null) {
    searchScript=context.scriptService().search(context.lookup(),scriptLang,script,params);
  }
  if (shardSize < size) {
    shardSize=size;
  }
  if (fieldsNames != null) {
    ArrayList<FieldMapper> mappers=new ArrayList<FieldMapper>(fieldsNames.length);
    for (int i=0; i < fieldsNames.length; i++) {
      FieldMapper mapper=context.smartNameFieldMapper(fieldsNames[i]);
      if (mapper != null) {
        mappers.add(mapper);
      }
    }
    if (mappers.isEmpty()) {
      return new UnmappedFieldExecutor(size,comparatorType);
    }
    return new FieldsTermsStringFacetExecutor(mappers.toArray(new FieldMapper[mappers.size()]),size,shardSize,comparatorType,allTerms,context,excluded,pattern,searchScript);
  }
  if (field == null && script != null) {
    return new ScriptTermsStringFieldFacetExecutor(size,shardSize,comparatorType,context,excluded,pattern,scriptLang,script,params,context.cacheRecycler());
  }
  if (field == null) {
    throw new ElasticSearchParseException("terms facet [" + facetName + "] must have a field, fields or script parameter");
  }
  FieldMapper fieldMapper=context.smartNameFieldMapper(field);
  if (fieldMapper == null) {
    return new UnmappedFieldExecutor(size,comparatorType);
  }
  IndexFieldData indexFieldData=context.fieldData().getForField(fieldMapper);
  if (indexFieldData instanceof IndexNumericFieldData) {
    IndexNumericFieldData indexNumericFieldData=(IndexNumericFieldData)indexFieldData;
    if (indexNumericFieldData.getNumericType().isFloatingPoint()) {
      return new TermsDoubleFacetExecutor(indexNumericFieldData,size,shardSize,comparatorType,allTerms,context,excluded,searchScript,context.cacheRecycler());
    }
 else {
      return new TermsLongFacetExecutor(indexNumericFieldData,size,shardSize,comparatorType,allTerms,context,excluded,searchScript,context.cacheRecycler());
    }
  }
 else {
    if (script != null || "map".equals(executionHint)) {
      return new TermsStringFacetExecutor(indexFieldData,size,shardSize,comparatorType,allTerms,context,excluded,pattern,searchScript);
    }
 else     if (indexFieldData instanceof IndexFieldData.WithOrdinals) {
      return new TermsStringOrdinalsFacetExecutor((IndexFieldData.WithOrdinals)indexFieldData,size,shardSize,comparatorType,allTerms,context,excluded,pattern,ordinalsCacheAbove);
    }
 else {
      return new TermsStringFacetExecutor(indexFieldData,size,shardSize,comparatorType,allTerms,context,excluded,pattern,searchScript);
    }
  }
}
