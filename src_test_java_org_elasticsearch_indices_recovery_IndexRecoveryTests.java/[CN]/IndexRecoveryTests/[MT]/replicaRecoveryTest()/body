{
  logger.info("--> start node A");
  String nodeA=internalCluster().startNode(settingsBuilder().put("gateway.type","local"));
  logger.info("--> create index on node: {}",nodeA);
  createAndPopulateIndex(INDEX_NAME,1,SHARD_COUNT,REPLICA_COUNT);
  logger.info("--> start node B");
  String nodeB=internalCluster().startNode(settingsBuilder().put("gateway.type","local"));
  ensureGreen();
  logger.info("--> bump replica count");
  client().admin().indices().prepareUpdateSettings(INDEX_NAME).setSettings(settingsBuilder().put("number_of_replicas",1)).execute().actionGet();
  ensureGreen();
  logger.info("--> request recoveries");
  RecoveryResponse response=client().admin().indices().prepareRecoveries(INDEX_NAME).execute().actionGet();
  List<ShardRecoveryResponse> shardResponses=response.shardResponses().get(INDEX_NAME);
  assertThat(shardResponses.size(),equalTo(2));
  List<ShardRecoveryResponse> nodeAResponses=findRecoveriesForTargetNode(nodeA,shardResponses);
  assertThat(nodeAResponses.size(),equalTo(1));
  List<ShardRecoveryResponse> nodeBResponses=findRecoveriesForTargetNode(nodeB,shardResponses);
  assertThat(nodeBResponses.size(),equalTo(1));
  ShardRecoveryResponse nodeAShardResponse=nodeAResponses.get(0);
  assertThat(nodeAShardResponse.recoveryState().getShardId().id(),equalTo(0));
  assertThat(nodeAShardResponse.recoveryState().getSourceNode().getName(),equalTo(nodeA));
  assertThat(nodeAShardResponse.recoveryState().getTargetNode().getName(),equalTo(nodeA));
  assertThat(nodeAShardResponse.recoveryState().getType(),equalTo(RecoveryState.Type.GATEWAY));
  assertThat(nodeAShardResponse.recoveryState().getStage(),equalTo(RecoveryState.Stage.DONE));
  validateIndexRecoveryState(nodeAShardResponse.recoveryState().getIndex());
  ShardRecoveryResponse nodeBShardResponse=nodeBResponses.get(0);
  assertThat(nodeBShardResponse.recoveryState().getShardId().id(),equalTo(0));
  assertThat(nodeBShardResponse.recoveryState().getSourceNode().getName(),equalTo(nodeA));
  assertThat(nodeBShardResponse.recoveryState().getTargetNode().getName(),equalTo(nodeB));
  assertThat(nodeBShardResponse.recoveryState().getType(),equalTo(RecoveryState.Type.REPLICA));
  assertThat(nodeBShardResponse.recoveryState().getStage(),equalTo(RecoveryState.Stage.DONE));
  validateIndexRecoveryState(nodeBShardResponse.recoveryState().getIndex());
}
