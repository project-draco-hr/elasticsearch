{
  client.admin().indices().prepareCreate("test").execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  String mapping=XContentFactory.contentTextBuilder(XContentType.JSON).startObject().startObject("type").startObject("properties").startObject("field1").field("type","string").field("store","yes").endObject().startObject("field2").field("type","string").field("store","no").endObject().startObject("field3").field("type","string").field("store","yes").endObject().endObject().endObject().endObject().string();
  client.admin().indices().preparePutMapping().setType("type1").setSource(mapping).execute().actionGet();
  client.prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("field1","value1").field("field2","value2").field("field3","value3").endObject()).execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addField("field1").execute().actionGet();
  assertThat(searchResponse.hits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.hits().hits().length,equalTo(1));
  assertThat(searchResponse.hits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.hits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addField("field2").execute().actionGet();
  assertThat(searchResponse.hits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.hits().hits().length,equalTo(1));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addField("field3").execute().actionGet();
  assertThat(searchResponse.hits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.hits().hits().length,equalTo(1));
  assertThat(searchResponse.hits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.hits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addField("*").execute().actionGet();
  assertThat(searchResponse.hits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.hits().hits().length,equalTo(1));
  assertThat(searchResponse.hits().getAt(0).fields().size(),equalTo(2));
  assertThat(searchResponse.hits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.hits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
}
