{
  super(settings);
  if (!DiscoveryNode.nodeRequiresLocalStorage(settings)) {
    nodeFile=null;
    lock=null;
    localNodeId=-1;
    return;
  }
  Lock lock=null;
  File dir=null;
  int localNodeId=-1;
  IOException lastException=null;
  for (int i=0; i < 50; i++) {
    dir=new File(new File(environment.dataWithClusterFile(),"nodes"),Integer.toString(i));
    if (!dir.exists()) {
      dir.mkdirs();
    }
    logger.trace("obtaining node lock on {} ...",dir.getAbsolutePath());
    try {
      NativeFSLockFactory lockFactory=new NativeFSLockFactory(dir);
      Lock tmpLock=lockFactory.makeLock("node.lock");
      boolean obtained=tmpLock.obtain();
      if (obtained) {
        lock=tmpLock;
        localNodeId=i;
        break;
      }
 else {
        logger.trace("failed to obtain node lock on {}",dir.getAbsolutePath());
      }
    }
 catch (    IOException e) {
      logger.trace("failed to obtain node lock on {}",e,dir.getAbsolutePath());
      lastException=e;
    }
  }
  if (lock == null) {
    throw new IOException("Failed to obtain node lock",lastException);
  }
  this.localNodeId=localNodeId;
  this.lock=lock;
  this.nodeFile=dir;
  if (logger.isDebugEnabled()) {
    logger.debug("using node location [{}], local_node_id [{}]",dir,localNodeId);
  }
}
