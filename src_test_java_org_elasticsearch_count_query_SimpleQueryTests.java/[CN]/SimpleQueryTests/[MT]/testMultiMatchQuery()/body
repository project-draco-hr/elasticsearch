{
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client().prepareIndex("test","type1","1").setSource("field1","value1","field2","value4","field3","value3").execute().actionGet();
  client().prepareIndex("test","type1","2").setSource("field1","value2","field2","value5","field3","value2").execute().actionGet();
  client().prepareIndex("test","type1","3").setSource("field1","value3","field2","value6","field3","value1").execute().actionGet();
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  MultiMatchQueryBuilder builder=QueryBuilders.multiMatchQuery("value1 value2 value4","field1","field2");
  CountResponse countResponse=client().prepareCount().setQuery(builder).execute().actionGet();
  assertHitCount(countResponse,2l);
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  builder=QueryBuilders.multiMatchQuery("value1","field1","field2").operator(MatchQueryBuilder.Operator.AND);
  countResponse=client().prepareCount().setQuery(builder).execute().actionGet();
  assertHitCount(countResponse,1l);
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  builder=QueryBuilders.multiMatchQuery("value1","field1","field3^1.5").operator(MatchQueryBuilder.Operator.AND);
  countResponse=client().prepareCount().setQuery(builder).execute().actionGet();
  assertHitCount(countResponse,2l);
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  builder=QueryBuilders.multiMatchQuery("value1").field("field1").field("field3",1.5f).operator(MatchQueryBuilder.Operator.AND);
  countResponse=client().prepareCount().setQuery(builder).execute().actionGet();
  assertHitCount(countResponse,2l);
  client().prepareIndex("test","type1","3").setSource("field1","value7","field2","value8","field4",5).execute().actionGet();
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  builder=QueryBuilders.multiMatchQuery("value1","field1","field2","field4");
  builder.lenient(true);
  countResponse=client().prepareCount().setQuery(builder).execute().actionGet();
  assertHitCount(countResponse,1l);
}
