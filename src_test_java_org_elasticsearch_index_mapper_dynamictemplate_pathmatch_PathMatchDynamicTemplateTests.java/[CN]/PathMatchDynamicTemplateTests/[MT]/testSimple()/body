{
  String mapping=copyToStringFromClasspath("/org/elasticsearch/index/mapper/dynamictemplate/pathmatch/test-mapping.json");
  IndexService index=createIndex("test");
  client().admin().indices().preparePutMapping("test").setType("person").setSource(mapping).get();
  DocumentMapper docMapper=index.mapperService().documentMapper("person");
  byte[] json=copyToBytesFromClasspath("/org/elasticsearch/index/mapper/dynamictemplate/pathmatch/test-data.json");
  ParsedDocument parsedDoc=docMapper.parse(new BytesArray(json));
  client().admin().indices().preparePutMapping("test").setType("person").setSource(parsedDoc.dynamicMappingsUpdate().toString()).get();
  Document doc=parsedDoc.rootDoc();
  IndexableField f=doc.getField("name");
  assertThat(f.name(),equalTo("name"));
  assertThat(f.stringValue(),equalTo("top_level"));
  assertThat(f.fieldType().stored(),equalTo(false));
  FieldMappers fieldMappers=docMapper.mappers().fullName("name");
  assertThat(fieldMappers.mappers().size(),equalTo(1));
  assertThat(fieldMappers.mapper().fieldType().stored(),equalTo(false));
  f=doc.getField("obj1.name");
  assertThat(f.name(),equalTo("obj1.name"));
  assertThat(f.fieldType().stored(),equalTo(true));
  fieldMappers=docMapper.mappers().fullName("obj1.name");
  assertThat(fieldMappers.mappers().size(),equalTo(1));
  assertThat(fieldMappers.mapper().fieldType().stored(),equalTo(true));
  f=doc.getField("obj1.obj2.name");
  assertThat(f.name(),equalTo("obj1.obj2.name"));
  assertThat(f.fieldType().stored(),equalTo(false));
  fieldMappers=docMapper.mappers().fullName("obj1.obj2.name");
  assertThat(fieldMappers.mappers().size(),equalTo(1));
  assertThat(fieldMappers.mapper().fieldType().stored(),equalTo(false));
  fieldMappers=docMapper.mappers().fullName("obj3.obj4.prop1");
  assertThat(fieldMappers.mappers().size(),equalTo(1));
}
