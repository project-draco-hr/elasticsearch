{
  HttpDownloadHelper downloadHelper=new HttpDownloadHelper();
  if (!environment.pluginsFile().canWrite()) {
    System.out.println();
    throw new IOException("plugin directory " + environment.pluginsFile() + " is read only");
  }
  PluginHandle pluginHandle=PluginHandle.parse(name);
  File pluginFile=pluginHandle.distroFile(environment);
  File extractLocation=pluginHandle.extractedDir(environment);
  if (extractLocation.exists()) {
    throw new IOException("plugin directory " + extractLocation.getAbsolutePath() + " already exists. To update the plugin, uninstall it first using -remove "+ name+ " command");
  }
  boolean downloaded=false;
  if (url != null) {
    URL pluginUrl=new URL(url);
    System.out.println("Trying " + pluginUrl.toExternalForm() + "...");
    try {
      downloadHelper.download(pluginUrl,pluginFile,new HttpDownloadHelper.VerboseProgress(System.out));
      downloaded=true;
    }
 catch (    IOException e) {
      if (verbose) {
        System.out.println("Failed: " + ExceptionsHelper.detailedMessage(e));
      }
    }
  }
  if (!downloaded) {
    for (    URL url : pluginHandle.urls()) {
      System.out.println("Trying " + url.toExternalForm() + "...");
      try {
        downloadHelper.download(url,pluginFile,new HttpDownloadHelper.VerboseProgress(System.out));
        downloaded=true;
        break;
      }
 catch (      Exception e) {
        if (verbose) {
          System.out.println("Failed: " + ExceptionsHelper.detailedMessage(e));
        }
      }
    }
  }
  if (!downloaded) {
    throw new IOException("failed to download out of all possible locations..., use -verbose to get detailed information");
  }
  ZipFile zipFile=null;
  try {
    zipFile=new ZipFile(pluginFile);
    boolean removeTopLevelDir=topLevelDirInExcess(zipFile);
    Enumeration<? extends ZipEntry> zipEntries=zipFile.entries();
    while (zipEntries.hasMoreElements()) {
      ZipEntry zipEntry=zipEntries.nextElement();
      if (zipEntry.isDirectory()) {
        continue;
      }
      String zipEntryName=zipEntry.getName().replace('\\','/');
      if (removeTopLevelDir) {
        zipEntryName=zipEntryName.substring(zipEntryName.indexOf('/'));
      }
      File target=new File(extractLocation,zipEntryName);
      FileSystemUtils.mkdirs(target.getParentFile());
      Streams.copy(zipFile.getInputStream(zipEntry),new FileOutputStream(target));
    }
    System.out.println("Installed " + name + " into "+ extractLocation.getAbsolutePath());
  }
 catch (  Exception e) {
    System.err.println("failed to extract plugin [" + pluginFile + "]: "+ ExceptionsHelper.detailedMessage(e));
    return;
  }
 finally {
    if (zipFile != null) {
      try {
        zipFile.close();
      }
 catch (      IOException e) {
      }
    }
    pluginFile.delete();
  }
  if (FileSystemUtils.hasExtensions(extractLocation,".java")) {
    System.out.println("Plugin installation assumed to be site plugin, but contains source code, aborting installation...");
    FileSystemUtils.deleteRecursively(extractLocation);
    return;
  }
  File binFile=new File(extractLocation,"bin");
  if (binFile.exists() && binFile.isDirectory()) {
    File toLocation=pluginHandle.binDir(environment);
    System.out.println("Found bin, moving to " + toLocation.getAbsolutePath());
    FileSystemUtils.deleteRecursively(toLocation);
    binFile.renameTo(toLocation);
    System.out.println("Installed " + name + " into "+ toLocation.getAbsolutePath());
  }
  if (!new File(extractLocation,"_site").exists()) {
    if (!FileSystemUtils.hasExtensions(extractLocation,".class",".jar")) {
      System.out.println("Identified as a _site plugin, moving to _site structure ...");
      File site=new File(extractLocation,"_site");
      File tmpLocation=new File(environment.pluginsFile(),name + ".tmp");
      extractLocation.renameTo(tmpLocation);
      FileSystemUtils.mkdirs(extractLocation);
      tmpLocation.renameTo(site);
      System.out.println("Installed " + name + " into "+ site.getAbsolutePath());
    }
  }
}
