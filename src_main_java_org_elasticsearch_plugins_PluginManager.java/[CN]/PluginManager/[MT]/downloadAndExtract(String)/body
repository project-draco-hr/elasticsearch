{
  if (name == null) {
    throw new ElasticsearchIllegalArgumentException("plugin name must be supplied with --install [name].");
  }
  HttpDownloadHelper downloadHelper=new HttpDownloadHelper();
  boolean downloaded=false;
  HttpDownloadHelper.DownloadProgress progress;
  if (outputMode == OutputMode.SILENT) {
    progress=new HttpDownloadHelper.NullProgress();
  }
 else {
    progress=new HttpDownloadHelper.VerboseProgress(System.out);
  }
  if (!environment.pluginsFile().canWrite()) {
    System.err.println();
    throw new IOException("plugin directory " + environment.pluginsFile() + " is read only");
  }
  PluginHandle pluginHandle=PluginHandle.parse(name);
  checkForForbiddenName(pluginHandle.name);
  File pluginFile=pluginHandle.distroFile(environment);
  File extractLocation=pluginHandle.extractedDir(environment);
  if (extractLocation.exists()) {
    throw new IOException("plugin directory " + extractLocation.getAbsolutePath() + " already exists. To update the plugin, uninstall it first using --remove "+ name+ " command");
  }
  if (url != null) {
    URL pluginUrl=new URL(url);
    log("Trying " + pluginUrl.toExternalForm() + "...");
    try {
      downloadHelper.download(pluginUrl,pluginFile,progress,this.timeout);
      downloaded=true;
    }
 catch (    ElasticsearchTimeoutException e) {
      throw e;
    }
catch (    Exception e) {
      log("Failed: " + ExceptionsHelper.detailedMessage(e));
    }
  }
  if (!downloaded) {
    for (    URL url : pluginHandle.urls()) {
      log("Trying " + url.toExternalForm() + "...");
      try {
        downloadHelper.download(url,pluginFile,progress,this.timeout);
        downloaded=true;
        break;
      }
 catch (      ElasticsearchTimeoutException e) {
        throw e;
      }
catch (      Exception e) {
        debug("Failed: " + ExceptionsHelper.detailedMessage(e));
      }
    }
  }
  if (!downloaded) {
    throw new IOException("failed to download out of all possible locations..., use --verbose to get detailed information");
  }
  ZipFile zipFile=null;
  try {
    zipFile=new ZipFile(pluginFile);
    boolean removeTopLevelDir=topLevelDirInExcess(zipFile);
    Enumeration<? extends ZipEntry> zipEntries=zipFile.entries();
    while (zipEntries.hasMoreElements()) {
      ZipEntry zipEntry=zipEntries.nextElement();
      if (zipEntry.isDirectory()) {
        continue;
      }
      String zipEntryName=zipEntry.getName().replace('\\','/');
      if (removeTopLevelDir) {
        zipEntryName=zipEntryName.substring(zipEntryName.indexOf('/'));
      }
      File target=new File(extractLocation,zipEntryName);
      FileSystemUtils.mkdirs(target.getParentFile());
      Streams.copy(zipFile.getInputStream(zipEntry),new FileOutputStream(target));
    }
    log("Installed " + name + " into "+ extractLocation.getAbsolutePath());
  }
 catch (  Exception e) {
    log("failed to extract plugin [" + pluginFile + "]: "+ ExceptionsHelper.detailedMessage(e));
    return;
  }
 finally {
    if (zipFile != null) {
      try {
        zipFile.close();
      }
 catch (      IOException e) {
      }
    }
    try {
      Files.delete(pluginFile.toPath());
    }
 catch (    Exception ex) {
      log("Failed to delete plugin file" + pluginFile + " "+ ex);
    }
  }
  if (FileSystemUtils.hasExtensions(extractLocation,".java")) {
    debug("Plugin installation assumed to be site plugin, but contains source code, aborting installation...");
    try {
      IOUtils.rm(extractLocation.toPath());
    }
 catch (    Exception ex) {
      debug("Failed to remove site plugin from path " + extractLocation + " - "+ ex.getMessage());
    }
    throw new IllegalArgumentException("Plugin installation assumed to be site plugin, but contains source code, aborting installation.");
  }
  boolean potentialSitePlugin=true;
  File binFile=new File(extractLocation,"bin");
  if (binFile.exists() && binFile.isDirectory()) {
    File toLocation=pluginHandle.binDir(environment);
    debug("Found bin, moving to " + toLocation.getAbsolutePath());
    if (toLocation.exists()) {
      IOUtils.rm(toLocation.toPath());
    }
    if (!binFile.renameTo(toLocation)) {
      throw new IOException("Could not move [" + binFile.getAbsolutePath() + "] to ["+ toLocation.getAbsolutePath()+ "]");
    }
    Files.walkFileTree(toLocation.toPath(),new SimpleFileVisitor<Path>(){
      @Override public FileVisitResult visitFile(      Path file,      BasicFileAttributes attrs) throws IOException {
        if (attrs.isRegularFile()) {
          file.toFile().setExecutable(true);
        }
        return FileVisitResult.CONTINUE;
      }
    }
);
    debug("Installed " + name + " into "+ toLocation.getAbsolutePath());
    potentialSitePlugin=false;
  }
  File configFile=new File(extractLocation,"config");
  if (configFile.exists() && configFile.isDirectory()) {
    File configDestLocation=pluginHandle.configDir(environment);
    debug("Found config, moving to " + configDestLocation.getAbsolutePath());
    moveFilesWithoutOverwriting(configFile,configDestLocation,".new");
    debug("Installed " + name + " into "+ configDestLocation.getAbsolutePath());
    potentialSitePlugin=false;
  }
  if (!new File(extractLocation,"_site").exists()) {
    if (potentialSitePlugin && !FileSystemUtils.hasExtensions(extractLocation,".class",".jar")) {
      log("Identified as a _site plugin, moving to _site structure ...");
      File site=new File(extractLocation,"_site");
      File tmpLocation=new File(environment.pluginsFile(),extractLocation.getName() + ".tmp");
      if (!extractLocation.renameTo(tmpLocation)) {
        throw new IOException("failed to rename in order to copy to _site (rename to " + tmpLocation.getAbsolutePath() + "");
      }
      FileSystemUtils.mkdirs(extractLocation);
      if (!tmpLocation.renameTo(site)) {
        throw new IOException("failed to rename in order to copy to _site (rename to " + site.getAbsolutePath() + "");
      }
      debug("Installed " + name + " into "+ site.getAbsolutePath());
    }
  }
}
