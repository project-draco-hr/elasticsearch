{
synchronized (clusterGroups) {
    ClusterGroup clusterGroup=clusterGroups.get(clusterName);
    if (clusterGroup == null) {
      clusterGroup=new ClusterGroup();
      clusterGroups.put(clusterName,clusterGroup);
    }
    logger.debug("Connected to cluster [{}]",clusterName);
    this.localNode=new DiscoveryNode(settings.get("name"),DiscoveryService.generateNodeId(settings),transportService.boundAddress().publishAddress(),discoveryNodeService.buildAttributes(),version);
    clusterGroup.members().add(this);
    LocalDiscovery firstMaster=null;
    for (    LocalDiscovery localDiscovery : clusterGroup.members()) {
      if (localDiscovery.localNode().masterNode()) {
        firstMaster=localDiscovery;
        break;
      }
    }
    if (firstMaster != null && firstMaster.equals(this)) {
      master=true;
      final LocalDiscovery master=firstMaster;
      clusterService.submitStateUpdateTask("local-disco-initial_connect(master)",new ProcessedClusterStateNonMasterUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.builder();
          for (          LocalDiscovery discovery : clusterGroups.get(clusterName).members()) {
            nodesBuilder.put(discovery.localNode);
          }
          nodesBuilder.localNodeId(master.localNode().id()).masterNodeId(master.localNode().id());
          ClusterBlocks.Builder blocks=ClusterBlocks.builder().blocks(currentState.blocks()).removeGlobalBlock(discoverySettings.getNoMasterBlock());
          return ClusterState.builder(currentState).nodes(nodesBuilder).blocks(blocks).build();
        }
        @Override public void onFailure(        String source,        Throwable t){
          logger.error("unexpected failure during [{}]",t,source);
        }
        @Override public void clusterStateProcessed(        String source,        ClusterState oldState,        ClusterState newState){
          sendInitialStateEventIfNeeded();
        }
      }
);
    }
 else     if (firstMaster != null) {
      final ClusterState masterState=firstMaster.clusterService.state();
      clusterService.submitStateUpdateTask("local-disco(detected_master)",new ClusterStateNonMasterUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.builder(currentState.nodes()).put(localNode).localNodeId(localNode.id());
          return ClusterState.builder(currentState).metaData(masterState.metaData()).nodes(nodesBuilder).build();
        }
        @Override public void onFailure(        String source,        Throwable t){
          logger.error("unexpected failure during [{}]",t,source);
        }
      }
);
      final LocalDiscovery master=firstMaster;
      firstMaster.clusterService.submitStateUpdateTask("local-disco-receive(from node[" + localNode + "])",new ProcessedClusterStateNonMasterUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.builder();
          for (          LocalDiscovery discovery : clusterGroups.get(clusterName).members()) {
            nodesBuilder.put(discovery.localNode);
          }
          nodesBuilder.localNodeId(master.localNode().id()).masterNodeId(master.localNode().id());
          ClusterState updatedState=ClusterState.builder(currentState).nodes(nodesBuilder).build();
          RoutingAllocation.Result routingResult=master.allocationService.reroute(ClusterState.builder(updatedState).build());
          return ClusterState.builder(updatedState).routingResult(routingResult).build();
        }
        @Override public void onFailure(        String source,        Throwable t){
          logger.error("unexpected failure during [{}]",t,source);
        }
        @Override public void clusterStateProcessed(        String source,        ClusterState oldState,        ClusterState newState){
          sendInitialStateEventIfNeeded();
        }
      }
);
    }
  }
}
