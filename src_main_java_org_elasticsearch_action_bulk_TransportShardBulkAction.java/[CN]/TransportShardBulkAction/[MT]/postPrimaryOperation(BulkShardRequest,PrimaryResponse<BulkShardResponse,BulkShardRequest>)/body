{
  IndexService indexService=indicesService.indexServiceSafe(request.index());
  Engine.IndexingOperation[] ops=(Engine.IndexingOperation[])response.payload();
  if (ops == null) {
    return;
  }
  for (int i=0; i < ops.length; i++) {
    BulkItemRequest itemRequest=request.items()[i];
    BulkItemResponse itemResponse=response.response().getResponses()[i];
    if (itemResponse.isFailed()) {
      continue;
    }
    Engine.IndexingOperation op=ops[i];
    if (op == null) {
      continue;
    }
    if (itemRequest.request() instanceof IndexRequest) {
      IndexRequest indexRequest=(IndexRequest)itemRequest.request();
      if (!Strings.hasLength(indexRequest.percolate())) {
        continue;
      }
      try {
        PercolatorExecutor.Response percolate=indexService.percolateService().percolate(new PercolatorExecutor.DocAndSourceQueryRequest(op.parsedDoc(),indexRequest.percolate()));
        ((IndexResponse)itemResponse.getResponse()).setMatches(percolate.matches());
      }
 catch (      Exception e) {
        logger.warn("failed to percolate [{}]",e,itemRequest.request());
      }
    }
  }
}
