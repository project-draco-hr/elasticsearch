{
  MappingMetaData mappingMd=clusterState.metaData().index(request.index()).mappingOrDefault(indexRequest.type());
  if (mappingMd != null && mappingMd.routing().required()) {
    if (indexRequest.routing() == null) {
      throw new RoutingMissingException(request.index(),indexRequest.type(),indexRequest.id());
    }
  }
  if (!processed) {
    indexRequest.process(clusterState.metaData(),mappingMd,allowIdGeneration,request.index());
  }
  final IndexResponse response=executeIndexRequestOnPrimary(request,indexRequest,indexShard);
  return new WriteResult(response);
}
