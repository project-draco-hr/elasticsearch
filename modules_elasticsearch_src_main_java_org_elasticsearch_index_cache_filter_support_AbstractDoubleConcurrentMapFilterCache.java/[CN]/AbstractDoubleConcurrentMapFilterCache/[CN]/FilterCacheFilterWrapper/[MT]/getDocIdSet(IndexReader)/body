{
  ConcurrentMap<Filter,DocSet> cachedFilters=cache.cache.get(reader.getFieldCacheKey());
  if (cachedFilters == null) {
    cachedFilters=cache.buildCacheMap();
    cache.cache.putIfAbsent(reader.getFieldCacheKey(),cachedFilters);
  }
  DocSet docSet=cachedFilters.get(filter);
  if (docSet != null) {
    return docSet;
  }
  ConcurrentMap<Filter,DocSet> weakCachedFilters=cache.weakCache.get(reader.getFieldCacheKey());
  if (weakCachedFilters != null) {
    docSet=weakCachedFilters.get(filter);
    if (docSet != null) {
      cachedFilters.put(filter,docSet);
      weakCachedFilters.remove(filter);
      return docSet;
    }
  }
  DocIdSet docIdSet=filter.getDocIdSet(reader);
  docSet=cacheable(reader,docIdSet);
  cachedFilters.putIfAbsent(filter,docSet);
  return docIdSet;
}
