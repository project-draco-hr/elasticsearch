{
  DocSet docSet;
  ConcurrentMap<Filter,DocSet> cachedFilters=cache.cache.get(reader.getCoreCacheKey());
  if (cachedFilters != null) {
    docSet=cachedFilters.get(filter);
    if (docSet != null) {
      return docSet;
    }
  }
  ConcurrentMap<Filter,DocSet> weakCacheFilters=cache.weakCache.get(reader.getCoreCacheKey());
  if (weakCacheFilters == null) {
    weakCacheFilters=cache.buildWeakCacheMap();
    reader.addReaderFinishedListener(cache);
    ConcurrentMap<Filter,DocSet> prev=cache.weakCache.putIfAbsent(reader.getCoreCacheKey(),weakCacheFilters);
    if (prev != null) {
      weakCacheFilters=prev;
    }
  }
  docSet=weakCacheFilters.get(filter);
  if (docSet != null) {
    return docSet;
  }
  DocIdSet docIdSet=filter.getDocIdSet(reader);
  docSet=cacheable(reader,docIdSet);
  DocSet prev=weakCacheFilters.putIfAbsent(filter,docSet);
  if (prev != null) {
    docSet=prev;
  }
  return docSet;
}
