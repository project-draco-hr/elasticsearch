{
  FieldsVisitor fieldsVisitor;
  List<String> extractFieldNames=null;
  boolean sourceRequested=false;
  if (!context.hasFieldNames()) {
    if (context.hasPartialFields()) {
      fieldsVisitor=new UidAndSourceFieldsVisitor();
    }
 else     if (context.hasScriptFields()) {
      fieldsVisitor=new JustUidFieldsVisitor();
    }
 else {
      sourceRequested=true;
      fieldsVisitor=new UidAndSourceFieldsVisitor();
    }
  }
 else   if (context.fieldNames().isEmpty()) {
    fieldsVisitor=new JustUidFieldsVisitor();
  }
 else {
    boolean loadAllStored=false;
    Set<String> fieldNames=null;
    for (    String fieldName : context.fieldNames()) {
      if (fieldName.equals("*")) {
        loadAllStored=true;
        continue;
      }
      if (fieldName.equals(SourceFieldMapper.NAME)) {
        sourceRequested=true;
        continue;
      }
      FieldMappers x=context.smartNameFieldMappers(fieldName);
      if (x != null && x.mapper().stored()) {
        if (fieldNames == null) {
          fieldNames=new HashSet<String>();
        }
        fieldNames.add(x.mapper().names().indexName());
      }
 else {
        if (extractFieldNames == null) {
          extractFieldNames=newArrayList();
        }
        extractFieldNames.add(fieldName);
      }
    }
    if (loadAllStored) {
      if (sourceRequested || extractFieldNames != null) {
        fieldsVisitor=new CustomFieldsVisitor(true,true);
      }
 else {
        fieldsVisitor=new CustomFieldsVisitor(true,false);
      }
    }
 else     if (fieldNames != null) {
      boolean loadSource=extractFieldNames != null || sourceRequested;
      fieldsVisitor=new CustomFieldsVisitor(fieldNames,loadSource);
    }
 else     if (extractFieldNames != null || sourceRequested) {
      fieldsVisitor=new UidAndSourceFieldsVisitor();
    }
 else {
      fieldsVisitor=new JustUidFieldsVisitor();
    }
  }
  InternalSearchHit[] hits=new InternalSearchHit[context.docIdsToLoadSize()];
  for (int index=0; index < context.docIdsToLoadSize(); index++) {
    int docId=context.docIdsToLoad()[context.docIdsToLoadFrom() + index];
    loadStoredFields(context,fieldsVisitor,docId);
    fieldsVisitor.postProcess(context.mapperService());
    Map<String,SearchHitField> searchFields=null;
    if (fieldsVisitor.fields() != null) {
      searchFields=new HashMap<String,SearchHitField>(fieldsVisitor.fields().size());
      for (      Map.Entry<String,List<Object>> entry : fieldsVisitor.fields().entrySet()) {
        searchFields.put(entry.getKey(),new InternalSearchHitField(entry.getKey(),entry.getValue()));
      }
    }
    InternalSearchHit searchHit=new InternalSearchHit(docId,fieldsVisitor.uid().id(),fieldsVisitor.uid().type(),sourceRequested ? fieldsVisitor.source() : null,searchFields);
    hits[index]=searchHit;
    int readerIndex=ReaderUtil.subIndex(docId,context.searcher().getIndexReader().leaves());
    AtomicReaderContext subReaderContext=context.searcher().getIndexReader().leaves().get(readerIndex);
    int subDoc=docId - subReaderContext.docBase;
    context.lookup().setNextReader(subReaderContext);
    context.lookup().setNextDocId(subDoc);
    if (searchHit.source() != null) {
      context.lookup().source().setNextSource(new BytesArray(searchHit.source()));
    }
    if (extractFieldNames != null) {
      for (      String extractFieldName : extractFieldNames) {
        Object value=context.lookup().source().extractValue(extractFieldName);
        if (value != null) {
          if (searchHit.fieldsOrNull() == null) {
            searchHit.fields(new HashMap<String,SearchHitField>(2));
          }
          SearchHitField hitField=searchHit.fields().get(extractFieldName);
          if (hitField == null) {
            hitField=new InternalSearchHitField(extractFieldName,new ArrayList<Object>(2));
            searchHit.fields().put(extractFieldName,hitField);
          }
          hitField.values().add(value);
        }
      }
    }
    for (    FetchSubPhase fetchSubPhase : fetchSubPhases) {
      FetchSubPhase.HitContext hitContext=new FetchSubPhase.HitContext();
      if (fetchSubPhase.hitExecutionNeeded(context)) {
        hitContext.reset(searchHit,subReaderContext,subDoc,context.searcher().getIndexReader(),docId,fieldsVisitor);
        fetchSubPhase.hitExecute(context,hitContext);
      }
    }
  }
  for (  FetchSubPhase fetchSubPhase : fetchSubPhases) {
    if (fetchSubPhase.hitsExecutionNeeded(context)) {
      fetchSubPhase.hitsExecute(context,hits);
    }
  }
  context.fetchResult().hits(new InternalSearchHits(hits,context.queryResult().topDocs().totalHits,context.queryResult().topDocs().getMaxScore()));
}
