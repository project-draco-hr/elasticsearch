{
  if (nodeEnv.nodeDataPaths().length > 1) {
    final MultiDataPathUpgrader upgrader=new MultiDataPathUpgrader(nodeEnv);
    final Set<String> allIndices=nodeEnv.findAllIndices();
    for (    String index : allIndices) {
      for (      ShardId shardId : findAllShardIds(nodeEnv.indexPaths(new Index(index)))) {
        try (ShardLock lock=nodeEnv.shardLock(shardId,0)){
          if (upgrader.needsUpgrading(shardId)) {
            final ShardPath shardPath=upgrader.pickShardPath(shardId);
            upgrader.upgrade(shardId,shardPath);
            if (Files.exists(shardPath.resolveIndex())) {
              upgrader.checkIndex(shardPath);
            }
          }
 else {
            logger.debug("{} no upgrade needed - already upgraded");
          }
        }
       }
    }
  }
}
