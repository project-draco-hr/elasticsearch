{
  XContentParser.Token token;
  String currentFieldName=null;
  String bucketsPath=null;
  String format=null;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.VALUE_STRING) {
      if (BUCKETS_PATH.match(currentFieldName)) {
        bucketsPath=parser.text();
      }
 else       if (FORMAT.match(currentFieldName)) {
        format=parser.text();
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ reducerName+ "]: ["+ currentFieldName+ "].");
      }
    }
 else {
      throw new SearchParseException(context,"Unexpected token " + token + " in ["+ reducerName+ "].");
    }
  }
  if (bucketsPath == null) {
    throw new SearchParseException(context,"Missing required field [" + BUCKETS_PATH.getPreferredName() + "] for derivative aggregation ["+ reducerName+ "]");
  }
  ValueFormatter formatter=null;
  if (format != null) {
    formatter=ValueFormat.Patternable.Number.format(format).formatter();
  }
  return new DerivativeReducer.Factory(reducerName,bucketsPath,formatter);
}
