{
  Map<String,ImmutableList.Builder<ShardId>> waitingIndicesMap=newHashMap();
  for (  ImmutableMap.Entry<ShardId,ShardSnapshotStatus> entry : shards.entrySet()) {
    if (entry.getValue().state() == State.WAITING) {
      ImmutableList.Builder<ShardId> waitingShards=waitingIndicesMap.get(entry.getKey().getIndex());
      if (waitingShards == null) {
        waitingShards=ImmutableList.builder();
        waitingIndicesMap.put(entry.getKey().getIndex(),waitingShards);
      }
      waitingShards.add(entry.getKey());
    }
  }
  if (!waitingIndicesMap.isEmpty()) {
    ImmutableMap.Builder<String,ImmutableList<ShardId>> waitingIndicesBuilder=ImmutableMap.builder();
    for (    Map.Entry<String,ImmutableList.Builder<ShardId>> entry : waitingIndicesMap.entrySet()) {
      waitingIndicesBuilder.put(entry.getKey(),entry.getValue().build());
    }
    return waitingIndicesBuilder.build();
  }
 else {
    return ImmutableMap.of();
  }
}
