{
  DfsSearchResult dfsResult=searchService.executeDfsPhase(searchRequest(searchSource().query(termQuery("name","test1"))));
  AggregatedDfs dfs=searchPhaseController.aggregateDfs(newArrayList(dfsResult));
  QuerySearchResult queryResult=searchService.executeQueryPhase(new QuerySearchRequest(dfsResult.id(),dfs));
  assertThat(queryResult.topDocs().totalHits,equalTo(1));
  ShardDoc[] sortedShardList=searchPhaseController.sortDocs(newArrayList(queryResult));
  Map<SearchShardTarget,ExtTIntArrayList> docIdsToLoad=searchPhaseController.docIdsToLoad(sortedShardList);
  assertThat(docIdsToLoad.size(),equalTo(1));
  assertThat(docIdsToLoad.values().iterator().next().size(),equalTo(1));
  FetchSearchResult fetchResult=searchService.executeFetchPhase(new FetchSearchRequest(queryResult.id(),docIdsToLoad.values().iterator().next()));
  assertThat(fetchResult.hits().hits()[0].sourceAsString(),equalTo(source("1","test1",1)));
  assertThat(fetchResult.hits().hits()[0].id(),equalTo("1"));
  assertThat(fetchResult.hits().hits()[0].type(),equalTo("type1"));
}
