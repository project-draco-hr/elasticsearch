{
  assertAcked(prepareCreate("test").addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("bstag").field("type","byte").endObject().startObject("shstag").field("type","short").endObject().startObject("istag").field("type","integer").endObject().startObject("lstag").field("type","long").endObject().startObject("fstag").field("type","float").endObject().startObject("dstag").field("type","double").endObject().endObject().endObject().endObject()));
  ensureGreen();
  client().prepareIndex("test","type1").setSource(jsonBuilder().startObject().field("stag","111").field("bstag",111).field("shstag",111).field("istag",111).field("lstag",111).field("fstag",111.1f).field("dstag",111.1).startArray("tag").value("xxx").value("yyy").endArray().startArray("ltag").value(1000l).value(2000l).endArray().startArray("dtag").value(1000.1).value(2000.1).endArray().endObject()).execute().actionGet();
  flushAndRefresh();
  client().prepareIndex("test","type1").setSource(jsonBuilder().startObject().field("stag","111").field("bstag",111).field("shstag",111).field("istag",111).field("lstag",111).field("fstag",111.1f).field("dstag",111.1).startArray("tag").value("zzz").value("yyy").endArray().startArray("ltag").value(3000l).value(2000l).endArray().startArray("dtag").value(3000.1).value(2000.1).endArray().endObject()).execute().actionGet();
  refresh();
  for (int i=0; i < numberOfRuns(); i++) {
    SearchResponse searchResponse=client().prepareSearch().setQuery(termQuery("stag","111")).addFacet(termsFacet("facet1").field("stag").size(10).executionHint(executionHint)).addFacet(termsFacet("facet2").field("tag").size(10).executionHint(executionHint)).execute().actionGet();
    TermsFacet facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getTotalCount(),equalTo(2l));
    assertThat(facet.getOtherCount(),equalTo(0l));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    facet=searchResponse.getFacets().facet("facet2");
    assertThat(facet.getName(),equalTo("facet2"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("yyy"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    searchResponse=client().prepareSearch().setQuery(termQuery("stag","111")).addFacet(termsFacet("facet1").field("lstag").size(10).executionHint(executionHint)).addFacet(termsFacet("facet2").field("ltag").size(10).executionHint(executionHint)).addFacet(termsFacet("facet3").field("ltag").size(10).exclude(3000).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet,instanceOf(InternalLongTermsFacet.class));
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    facet=searchResponse.getFacets().facet("facet2");
    assertThat(facet,instanceOf(InternalLongTermsFacet.class));
    assertThat(facet.getName(),equalTo("facet2"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("2000"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("1000"),equalTo("3000")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(2).getTerm().string(),anyOf(equalTo("1000"),equalTo("3000")));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(1));
    facet=searchResponse.getFacets().facet("facet3");
    assertThat(facet,instanceOf(InternalLongTermsFacet.class));
    assertThat(facet.getName(),equalTo("facet3"));
    assertThat(facet.getEntries().size(),equalTo(2));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("2000"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(1).getTerm().string(),equalTo("1000"));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(termQuery("stag","111")).addFacet(termsFacet("facet1").field("dstag").size(10).executionHint(executionHint)).addFacet(termsFacet("facet2").field("dtag").size(10).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet,instanceOf(InternalDoubleTermsFacet.class));
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111.1"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    facet=searchResponse.getFacets().facet("facet2");
    assertThat(facet,instanceOf(InternalDoubleTermsFacet.class));
    assertThat(facet.getName(),equalTo("facet2"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("2000.1"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("1000.1"),equalTo("3000.1")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(2).getTerm().string(),anyOf(equalTo("1000.1"),equalTo("3000.1")));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(termQuery("stag","111")).addFacet(termsFacet("facet1").field("bstag").size(10).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    searchResponse=client().prepareSearch().setQuery(termQuery("stag","111")).addFacet(termsFacet("facet1").field("istag").size(10).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    searchResponse=client().prepareSearch().setQuery(termQuery("stag","111")).addFacet(termsFacet("facet1").field("shstag").size(10).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("stag").size(10).facetFilter(termFilter("tag","xxx")).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("stag").size(10).facetFilter(termFilter("tag","xxx")).global(true).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("type1.stag").size(10).facetFilter(termFilter("tag","xxx")).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("tag").size(10).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("yyy"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("xxx"),equalTo("zzz")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(2).getTerm().string(),anyOf(equalTo("xxx"),equalTo("zzz")));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("tag").size(2).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(2));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("yyy"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("xxx"),equalTo("zzz")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("tag").size(10).exclude("yyy").executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(2));
    assertThat(facet.getEntries().get(0).getTerm().string(),anyOf(equalTo("xxx"),equalTo("zzz")));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("xxx"),equalTo("zzz")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("tag").size(10).order(TermsFacet.ComparatorType.TERM).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("xxx"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(1).getTerm().string(),equalTo("yyy"));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(2).getTerm().string(),equalTo("zzz"));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("tag").size(10).order(TermsFacet.ComparatorType.REVERSE_TERM).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(2).getTerm().string(),equalTo("xxx"));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(1).getTerm().string(),equalTo("yyy"));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("zzz"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("tag").size(10).script("term + param1").param("param1","a").order(TermsFacet.ComparatorType.TERM).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("xxxa"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(1).getTerm().string(),equalTo("yyya"));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(2).getTerm().string(),equalTo("zzza"));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").field("tag").size(10).script("term == 'xxx' ? false : true").order(TermsFacet.ComparatorType.TERM).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(2));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("yyy"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(1).getTerm().string(),equalTo("zzz"));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").fields("stag","tag").size(10).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(4));
    assertThat(facet.getEntries().get(0).getTerm().string(),anyOf(equalTo("111"),equalTo("yyy")));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("111"),equalTo("yyy")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(2));
    assertThat(facet.getEntries().get(2).getTerm().string(),anyOf(equalTo("zzz"),equalTo("xxx")));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(1));
    assertThat(facet.getEntries().get(3).getTerm().string(),anyOf(equalTo("zzz"),equalTo("xxx")));
    assertThat(facet.getEntries().get(3).getCount(),equalTo(1));
    searchResponse=client().prepareSearch().setQuery(termQuery("xxx","yyy")).addFacet(termsFacet("facet1").field("tag").size(10).allTerms(true).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),anyOf(equalTo("xxx"),equalTo("yyy"),equalTo("zzz")));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("xxx"),equalTo("yyy"),equalTo("zzz")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(2).getTerm().string(),anyOf(equalTo("xxx"),equalTo("yyy"),equalTo("zzz")));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(0));
    searchResponse=client().prepareSearch().setQuery(termQuery("xxx","yyy")).addFacet(termsFacet("facet1").fields("tag","stag").size(10).allTerms(true).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(4));
    assertThat(facet.getEntries().get(0).getTerm().string(),anyOf(equalTo("xxx"),equalTo("yyy"),equalTo("zzz"),equalTo("111")));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(1).getTerm().string(),anyOf(equalTo("xxx"),equalTo("yyy"),equalTo("zzz"),equalTo("111")));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(2).getTerm().string(),anyOf(equalTo("xxx"),equalTo("yyy"),equalTo("zzz"),equalTo("111")));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(3).getTerm().string(),anyOf(equalTo("xxx"),equalTo("yyy"),equalTo("zzz"),equalTo("111")));
    assertThat(facet.getEntries().get(3).getCount(),equalTo(0));
    searchResponse=client().prepareSearch().setQuery(termQuery("xxx","yyy")).addFacet(termsFacet("facet1").field("ltag").size(10).allTerms(true).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTermAsNumber().intValue(),anyOf(equalTo(1000),equalTo(2000),equalTo(3000)));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(1).getTermAsNumber().intValue(),anyOf(equalTo(1000),equalTo(2000),equalTo(3000)));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(2).getTermAsNumber().intValue(),anyOf(equalTo(1000),equalTo(2000),equalTo(3000)));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(0));
    searchResponse=client().prepareSearch().setQuery(termQuery("xxx","yyy")).addFacet(termsFacet("facet1").field("dtag").size(10).allTerms(true).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTermAsNumber().doubleValue(),anyOf(equalTo(1000.1),equalTo(2000.1),equalTo(3000.1)));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(1).getTermAsNumber().doubleValue(),anyOf(equalTo(1000.1),equalTo(2000.1),equalTo(3000.1)));
    assertThat(facet.getEntries().get(1).getCount(),equalTo(0));
    assertThat(facet.getEntries().get(2).getTermAsNumber().doubleValue(),anyOf(equalTo(1000.1),equalTo(2000.1),equalTo(3000.1)));
    assertThat(facet.getEntries().get(2).getCount(),equalTo(0));
    searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addFacet(termsFacet("facet1").scriptField("_source.stag").size(10).executionHint(executionHint)).addFacet(termsFacet("facet2").scriptField("_source.tag").size(10).executionHint(executionHint)).execute().actionGet();
    facet=searchResponse.getFacets().facet("facet1");
    assertThat(facet.getName(),equalTo("facet1"));
    assertThat(facet.getTotalCount(),equalTo(2l));
    assertThat(facet.getOtherCount(),equalTo(0l));
    assertThat(facet.getEntries().size(),equalTo(1));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("111"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
    facet=searchResponse.getFacets().facet("facet2");
    assertThat(facet.getTotalCount(),equalTo(4l));
    assertThat(facet.getOtherCount(),equalTo(0l));
    assertThat(facet.getName(),equalTo("facet2"));
    assertThat(facet.getEntries().size(),equalTo(3));
    assertThat(facet.getEntries().get(0).getTerm().string(),equalTo("yyy"));
    assertThat(facet.getEntries().get(0).getCount(),equalTo(2));
  }
}
