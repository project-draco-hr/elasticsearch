{
  routing(metaData.resolveIndexRouting(routing,aliasOrIndex));
  if (timestamp != null) {
    timestamp=MappingMetaData.Timestamp.parseStringTimestamp(timestamp,mappingMd != null ? mappingMd.timestamp().dateTimeFormatter() : TimestampFieldMapper.Defaults.DATE_TIME_FORMATTER);
  }
  if (mappingMd != null) {
    boolean shouldParseRouting=(routing == null && mappingMd.routing().hasPath());
    boolean shouldParseTimestamp=(timestamp == null && mappingMd.timestamp().hasPath());
    if (shouldParseRouting || shouldParseTimestamp) {
      XContentParser parser=null;
      try {
        parser=XContentFactory.xContent(source,sourceOffset,sourceLength).createParser(source,sourceOffset,sourceLength);
        Tuple<String,String> parseResult=mappingMd.parseRoutingAndTimestamp(parser,shouldParseRouting,shouldParseTimestamp);
        if (shouldParseRouting) {
          routing=parseResult.v1();
        }
        if (shouldParseTimestamp) {
          timestamp=parseResult.v2();
          timestamp=MappingMetaData.Timestamp.parseStringTimestamp(timestamp,mappingMd.timestamp().dateTimeFormatter());
        }
      }
 catch (      Exception e) {
        throw new ElasticSearchParseException("failed to parse doc to extract routing/timestamp",e);
      }
 finally {
        if (parser != null) {
          parser.close();
        }
      }
    }
    if (mappingMd.routing().required() && routing == null) {
      throw new RoutingMissingException(index,type,id);
    }
  }
  if (timestamp == null) {
    timestamp=String.valueOf(System.currentTimeMillis());
  }
}
