{
  boolean shouldParseRouting=(routing == null && mappingMd.routing().hasPath());
  boolean shouldParseTimestamp=(timestamp == null && mappingMd.timestamp().hasPath());
  if (shouldParseRouting || shouldParseTimestamp) {
    XContentParser parser=null;
    try {
      parser=XContentFactory.xContent(source,sourceOffset,sourceLength).createParser(source,sourceOffset,sourceLength);
      Tuple<String,String> parseResult=mappingMd.parseRoutingAndTimestamp(parser,shouldParseRouting,shouldParseTimestamp);
      if (shouldParseRouting) {
        routing=parseResult.v1();
      }
      if (shouldParseTimestamp) {
        timestamp=parseResult.v2();
      }
    }
 catch (    Exception e) {
      throw new ElasticSearchParseException("failed to parse doc to extract routing/timestamp",e);
    }
 finally {
      if (parser != null) {
        parser.close();
      }
    }
  }
  if (mappingMd.routing().required() && routing == null) {
    throw new RoutingMissingException(index,type,id);
  }
  if (shouldParseTimestamp && timestamp != null) {
    parseStringTimestamp(timestamp,mappingMd.tsDateTimeFormatter());
  }
}
