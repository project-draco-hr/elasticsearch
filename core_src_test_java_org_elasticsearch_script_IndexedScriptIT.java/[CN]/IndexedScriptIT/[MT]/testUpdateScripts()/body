{
  createIndex("test_index");
  ensureGreen("test_index");
  client().prepareIndex("test_index","test_type","1").setSource("{\"foo\":\"bar\"}").get();
  flush("test_index");
  int iterations=randomIntBetween(2,11);
  for (int i=1; i < iterations; i++) {
    PutIndexedScriptResponse response=client().preparePutIndexedScript(GroovyScriptEngineService.NAME,"script1","{\"script\":\"" + i + "\"}").get();
    assertEquals(i,response.getVersion());
    String query="{" + " \"query\" : { \"match_all\": {}}, " + " \"script_fields\" : { \"test_field\" : { \"script_id\" : \"script1\", \"lang\":\"groovy\" } } }";
    SearchResponse searchResponse=client().prepareSearch().setSource(query).setIndices("test_index").setTypes("test_type").get();
    assertHitCount(searchResponse,1);
    SearchHit sh=searchResponse.getHits().getAt(0);
    assertThat((Integer)sh.field("test_field").getValue(),equalTo(i));
  }
}
