{
  Query innerQuery;
  if (queryFound) {
    innerQuery=getInnerQuery();
  }
 else   if (filterFound) {
    Filter innerFilter=getInnerFilter();
    if (innerFilter != null) {
      innerQuery=new ConstantScoreQuery(getInnerFilter());
    }
 else {
      innerQuery=null;
    }
  }
 else {
    throw new QueryParsingException(parseContext.index(),"[nested] requires either 'query' or 'filter' field");
  }
  if (innerHits != null) {
    ObjectMapper parentObjectMapper=childDocumentMapper.findParentObjectMapper(nestedObjectMapper);
    InnerHitsContext.NestedInnerHits nestedInnerHits=new InnerHitsContext.NestedInnerHits(innerHits.v2(),getInnerQuery(),null,parentObjectMapper,nestedObjectMapper);
    String name=innerHits.v1() != null ? innerHits.v1() : path;
    parseContext.addInnerHits(name,nestedInnerHits);
  }
  if (innerQuery != null) {
    return new ToParentBlockJoinQuery(new FilteredQuery(innerQuery,childFilter),parentFilter,scoreMode);
  }
 else {
    return null;
  }
}
