{
  Settings settings=InternalSettingsPreparer.prepareSettings(this.settings);
  settings=settingsBuilder().put(NettyTransport.PING_SCHEDULE,"5s").put(settings).put("network.server",false).put("node.client",true).put(CLIENT_TYPE_SETTING,CLIENT_TYPE).build();
  PluginsService pluginsService=new PluginsService(settings,null,null,pluginClasses);
  this.settings=pluginsService.updatedSettings();
  Version version=Version.CURRENT;
  final ThreadPool threadPool=new ThreadPool(settings);
  final NetworkService networkService=new NetworkService(settings);
  final SettingsFilter settingsFilter=new SettingsFilter(settings);
  boolean success=false;
  try {
    ModulesBuilder modules=new ModulesBuilder();
    modules.add(new Version.Module(version));
    for (    Module pluginModule : pluginsService.nodeModules()) {
      modules.add(pluginModule);
    }
    modules.add(new PluginsModule(pluginsService));
    modules.add(new SettingsModule(this.settings,settingsFilter));
    modules.add(new NetworkModule(networkService,this.settings,true));
    modules.add(new ClusterNameModule(this.settings));
    modules.add(new ThreadPoolModule(threadPool));
    modules.add(new SearchModule(){
      @Override protected void configure(){
      }
    }
);
    modules.add(new ActionModule(true));
    modules.add(new CircuitBreakerModule(this.settings));
    pluginsService.processModules(modules);
    Injector injector=modules.createInjector();
    injector.getInstance(TransportService.class).start();
    TransportClient transportClient=new TransportClient(injector);
    success=true;
    return transportClient;
  }
  finally {
    if (!success) {
      ThreadPool.terminate(threadPool,10,TimeUnit.SECONDS);
    }
  }
}
