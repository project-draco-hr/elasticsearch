{
  String mapping=copyToStringFromClasspath("/org/elasticsearch/index/mapper/dynamictemplate/simple/test-mapping.json");
  IndexService index=createIndex("test");
  client().admin().indices().preparePutMapping("test").setType("person").setSource(mapping).get();
  DocumentMapper docMapper=index.mapperService().documentMapper("person");
  byte[] json=copyToBytesFromClasspath("/org/elasticsearch/index/mapper/dynamictemplate/simple/test-data.json");
  ParsedDocument parsedDoc=docMapper.parse("person","1",new BytesArray(json));
  client().admin().indices().preparePutMapping("test").setType("person").setSource(parsedDoc.dynamicMappingsUpdate().toString()).get();
  Document doc=parsedDoc.rootDoc();
  IndexableField f=doc.getField("name");
  assertThat(f.name(),equalTo("name"));
  assertThat(f.stringValue(),equalTo("some name"));
  assertNotSame(IndexOptions.NONE,f.fieldType().indexOptions());
  assertThat(f.fieldType().tokenized(),equalTo(false));
  FieldMapper fieldMapper=docMapper.mappers().getMapper("name");
  assertNotNull(fieldMapper);
  f=doc.getField("multi1");
  assertThat(f.name(),equalTo("multi1"));
  assertThat(f.stringValue(),equalTo("multi 1"));
  assertNotSame(IndexOptions.NONE,f.fieldType().indexOptions());
  assertThat(f.fieldType().tokenized(),equalTo(true));
  fieldMapper=docMapper.mappers().getMapper("multi1");
  assertNotNull(fieldMapper);
  f=doc.getField("multi1.org");
  assertThat(f.name(),equalTo("multi1.org"));
  assertThat(f.stringValue(),equalTo("multi 1"));
  assertNotSame(IndexOptions.NONE,f.fieldType().indexOptions());
  assertThat(f.fieldType().tokenized(),equalTo(false));
  fieldMapper=docMapper.mappers().getMapper("multi1.org");
  assertNotNull(fieldMapper);
  f=doc.getField("multi2");
  assertThat(f.name(),equalTo("multi2"));
  assertThat(f.stringValue(),equalTo("multi 2"));
  assertNotSame(IndexOptions.NONE,f.fieldType().indexOptions());
  assertThat(f.fieldType().tokenized(),equalTo(true));
  fieldMapper=docMapper.mappers().getMapper("multi2");
  assertNotNull(fieldMapper);
  f=doc.getField("multi2.org");
  assertThat(f.name(),equalTo("multi2.org"));
  assertThat(f.stringValue(),equalTo("multi 2"));
  assertNotSame(IndexOptions.NONE,f.fieldType().indexOptions());
  assertThat(f.fieldType().tokenized(),equalTo(false));
  fieldMapper=docMapper.mappers().getMapper("multi2.org");
  assertNotNull(fieldMapper);
}
