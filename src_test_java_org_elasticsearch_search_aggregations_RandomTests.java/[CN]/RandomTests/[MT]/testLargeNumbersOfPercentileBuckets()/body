{
  createIndex("idx");
  final int numDocs=scaledRandomIntBetween(25000,50000);
  logger.info("Indexing [" + numDocs + "] docs");
  List<IndexRequestBuilder> indexingRequests=Lists.newArrayList();
  for (int i=0; i < numDocs; ++i) {
    indexingRequests.add(client().prepareIndex("idx","type",Integer.toString(i)).setSource("double_value",randomDouble()));
    if (indexingRequests.size() == 5000) {
      indexRandom(false,indexingRequests);
      indexingRequests.clear();
    }
  }
  indexRandom(true,indexingRequests);
  SearchResponse response=client().prepareSearch("idx").addAggregation(terms("terms").field("double_value").subAggregation(percentiles("pcts").field("double_value"))).execute().actionGet();
  assertAllSuccessful(response);
  assertEquals(numDocs,response.getHits().getTotalHits());
}
