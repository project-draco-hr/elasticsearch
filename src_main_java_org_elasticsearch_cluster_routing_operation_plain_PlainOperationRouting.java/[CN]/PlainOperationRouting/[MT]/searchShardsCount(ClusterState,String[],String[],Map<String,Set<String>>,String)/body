{
  if (concreteIndices == null || concreteIndices.length == 0) {
    concreteIndices=clusterState.metaData().concreteAllOpenIndices();
  }
  if (routing != null) {
    HashSet<ShardId> set=new HashSet<ShardId>();
    for (    String index : concreteIndices) {
      IndexRoutingTable indexRouting=indexRoutingTable(clusterState,index);
      Set<String> effectiveRouting=routing.get(index);
      if (effectiveRouting != null) {
        for (        String r : effectiveRouting) {
          int shardId=shardId(clusterState,index,null,null,r);
          IndexShardRoutingTable indexShard=indexRouting.shard(shardId);
          if (indexShard == null) {
            throw new IndexShardMissingException(new ShardId(index,shardId));
          }
          set.add(indexShard.shardId());
        }
      }
 else {
        for (        IndexShardRoutingTable indexShard : indexRouting) {
          set.add(indexShard.shardId());
        }
      }
    }
    return set.size();
  }
 else {
    int count=0;
    for (    String index : concreteIndices) {
      IndexRoutingTable indexRouting=indexRoutingTable(clusterState,index);
      count+=indexRouting.shards().size();
    }
    return count;
  }
}
