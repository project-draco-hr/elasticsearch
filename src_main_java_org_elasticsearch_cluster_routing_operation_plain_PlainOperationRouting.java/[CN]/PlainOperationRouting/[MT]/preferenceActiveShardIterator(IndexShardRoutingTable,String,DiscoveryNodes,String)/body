{
  if (preference == null) {
    String[] awarenessAttributes=awarenessAllocationDecider.awarenessAttributes();
    if (awarenessAttributes.length == 0) {
      return indexShard.activeShardsRandomIt();
    }
 else {
      return indexShard.preferAttributesActiveShardsIt(awarenessAttributes,nodes);
    }
  }
  if (preference.charAt(0) == '_') {
    if ("_local".equals(preference)) {
      return indexShard.preferNodeActiveShardsIt(localNodeId);
    }
    if ("_primary".equals(preference)) {
      return indexShard.primaryShardIt();
    }
    if ("_primary_first".equals(preference) || "_primaryFirst".equals(preference)) {
      return indexShard.primaryFirstActiveShardsIt();
    }
    if ("_only_local".equals(preference) || "_onlyLocal".equals(preference)) {
      return indexShard.onlyNodeActiveShardsIt(localNodeId);
    }
    if (preference.startsWith("_only_node:")) {
      return indexShard.onlyNodeActiveShardsIt(preference.substring("_only_node:".length()));
    }
  }
  String[] awarenessAttributes=awarenessAllocationDecider.awarenessAttributes();
  if (awarenessAttributes.length == 0) {
    return indexShard.activeShardsIt(DjbHashFunction.DJB_HASH(preference));
  }
 else {
    return indexShard.preferAttributesActiveShardsIt(awarenessAttributes,nodes,DjbHashFunction.DJB_HASH(preference));
  }
}
