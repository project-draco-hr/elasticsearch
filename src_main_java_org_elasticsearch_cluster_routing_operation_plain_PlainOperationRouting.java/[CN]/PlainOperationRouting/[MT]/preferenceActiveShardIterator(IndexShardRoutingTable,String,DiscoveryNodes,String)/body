{
  if (preference == null) {
    String[] awarenessAttributes=awarenessAllocationDecider.awarenessAttributes();
    if (awarenessAttributes.length == 0) {
      return indexShard.activeShardsRandomIt();
    }
 else {
      return indexShard.preferAttributesActiveShardsIt(awarenessAttributes,nodes);
    }
  }
  if (preference.charAt(0) == '_') {
    if (preference.startsWith("_shards:")) {
      int index=preference.indexOf(';');
      String shards;
      if (index == -1) {
        shards=preference.substring("_shards:".length());
      }
 else {
        shards=preference.substring("_shards:".length(),index);
      }
      String[] ids=Strings.splitStringByCommaToArray(shards);
      boolean found=false;
      for (      String id : ids) {
        if (Integer.parseInt(id) == indexShard.shardId().id()) {
          found=true;
          break;
        }
      }
      if (!found) {
        return null;
      }
      if (index == -1 || index == preference.length() - 1) {
        String[] awarenessAttributes=awarenessAllocationDecider.awarenessAttributes();
        if (awarenessAttributes.length == 0) {
          return indexShard.activeShardsRandomIt();
        }
 else {
          return indexShard.preferAttributesActiveShardsIt(awarenessAttributes,nodes);
        }
      }
 else {
        preference=preference.substring(index + 1);
      }
    }
    if (preference.startsWith("_prefer_node:")) {
      return indexShard.preferNodeActiveShardsIt(preference.substring("_prefer_node:".length()));
    }
    if ("_local".equals(preference)) {
      return indexShard.preferNodeActiveShardsIt(localNodeId);
    }
    if ("_primary".equals(preference)) {
      return indexShard.primaryActiveShardIt();
    }
    if ("_primary_first".equals(preference) || "_primaryFirst".equals(preference)) {
      return indexShard.primaryFirstActiveShardsIt();
    }
    if ("_only_local".equals(preference) || "_onlyLocal".equals(preference)) {
      return indexShard.onlyNodeActiveShardsIt(localNodeId);
    }
    if (preference.startsWith("_only_node:")) {
      return indexShard.onlyNodeActiveShardsIt(preference.substring("_only_node:".length()));
    }
  }
  String[] awarenessAttributes=awarenessAllocationDecider.awarenessAttributes();
  if (awarenessAttributes.length == 0) {
    return indexShard.activeShardsIt(DjbHashFunction.DJB_HASH(preference));
  }
 else {
    return indexShard.preferAttributesActiveShardsIt(awarenessAttributes,nodes,DjbHashFunction.DJB_HASH(preference));
  }
}
