{
  if (concreteIndices == null || concreteIndices.length == 0) {
    concreteIndices=clusterState.metaData().concreteAllOpenIndices();
  }
  routing=routing == null ? EMPTY_ROUTING : routing;
  final Set<ShardIterator> set=new HashSet<ShardIterator>();
  for (  String index : concreteIndices) {
    final IndexRoutingTable indexRouting=indexRoutingTable(clusterState,index);
    final Set<String> effectiveRouting=routing.get(index);
    if (effectiveRouting != null) {
      for (      String r : effectiveRouting) {
        int shardId=shardId(clusterState,index,null,null,r);
        IndexShardRoutingTable indexShard=indexRouting.shard(shardId);
        if (indexShard == null) {
          throw new IndexShardMissingException(new ShardId(index,shardId));
        }
        ShardIterator iterator=preferenceActiveShardIterator(indexShard,clusterState.nodes().localNodeId(),clusterState.nodes(),preference);
        if (iterator != null) {
          set.add(iterator);
        }
      }
    }
 else {
      for (      IndexShardRoutingTable indexShard : indexRouting) {
        ShardIterator iterator=preferenceActiveShardIterator(indexShard,clusterState.nodes().localNodeId(),clusterState.nodes(),preference);
        if (iterator != null) {
          set.add(iterator);
        }
      }
    }
  }
  return new GroupShardsIterator(set);
}
