{
  if (concreteIndices == null || concreteIndices.length == 0) {
    concreteIndices=clusterState.metaData().concreteAllOpenIndices();
  }
  if (routing != null) {
    HashSet<ShardIterator> set=new HashSet<ShardIterator>();
    for (    String index : concreteIndices) {
      IndexRoutingTable indexRouting=indexRoutingTable(clusterState,index);
      Set<String> effectiveRouting=routing.get(index);
      if (effectiveRouting != null) {
        for (        String r : effectiveRouting) {
          int shardId=shardId(clusterState,index,null,null,r);
          IndexShardRoutingTable indexShard=indexRouting.shard(shardId);
          if (indexShard == null) {
            throw new IndexShardMissingException(new ShardId(index,shardId));
          }
          set.add(preferenceActiveShardIterator(indexShard,clusterState.nodes().localNodeId(),clusterState.nodes(),preference));
        }
      }
    }
    return new GroupShardsIterator(set);
  }
 else {
    ArrayList<ShardIterator> set=new ArrayList<ShardIterator>();
    for (    String index : concreteIndices) {
      IndexRoutingTable indexRouting=indexRoutingTable(clusterState,index);
      for (      IndexShardRoutingTable indexShard : indexRouting) {
        set.add(preferenceActiveShardIterator(indexShard,clusterState.nodes().localNodeId(),clusterState.nodes(),preference));
      }
    }
    return new GroupShardsIterator(set);
  }
}
