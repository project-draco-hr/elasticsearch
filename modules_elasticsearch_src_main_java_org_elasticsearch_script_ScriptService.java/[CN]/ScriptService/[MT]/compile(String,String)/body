{
  CompiledScript compiled=cache.get(script);
  if (compiled != null) {
    return compiled;
  }
  if (type == null) {
    type=defaultType;
  }
synchronized (cache) {
    compiled=cache.get(script);
    if (compiled != null) {
      return compiled;
    }
    ScriptEngineService service=scriptEngines.get(type);
    if (service == null) {
      throw new ElasticSearchIllegalArgumentException("script_type not supported [" + type + "]");
    }
    compiled=new CompiledScript(type,service.compile(script));
    cache.put(script,compiled);
  }
  return compiled;
}
