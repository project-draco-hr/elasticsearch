{
  CompiledScript compiled=cache.get(script);
  if (compiled != null) {
    return compiled;
  }
  if (lang == null) {
    lang=defaultLang;
  }
synchronized (cache) {
    compiled=cache.get(script);
    if (compiled != null) {
      return compiled;
    }
    ScriptEngineService service=scriptEngines.get(lang);
    if (service == null) {
      throw new ElasticSearchIllegalArgumentException("script_lang not supported [" + lang + "]");
    }
    compiled=new CompiledScript(lang,service.compile(script));
    cache.put(script,compiled);
  }
  return compiled;
}
