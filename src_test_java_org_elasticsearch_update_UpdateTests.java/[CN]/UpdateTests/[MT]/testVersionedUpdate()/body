{
  createIndex("test");
  ensureGreen();
  index("test","type","1","text","value");
  assertThrows(client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v2'").setVersion(2).execute(),VersionConflictEngineException.class);
  run(client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v2'").setVersion(1));
  assertThat(run(client().prepareGet("test","type","1")).getVersion(),equalTo(2l));
  run(client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v3'").setVersion(2));
  assertThat(run(client().prepareGet("test","type","1")).getVersion(),equalTo(3l));
  run(client().prepareDelete("test","type","1"));
  assertThrows(client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v2'").setVersion(3).execute(),DocumentMissingException.class);
  run(client().prepareIndex("test","type","2").setSource("text","value").setVersion(10).setVersionType(VersionType.EXTERNAL));
  assertThrows(client().prepareUpdate("test","type","2").setScript("ctx._source.text = 'v2'").setVersion(2).setVersionType(VersionType.EXTERNAL).execute(),VersionConflictEngineException.class);
  run(client().prepareUpdate("test","type","2").setScript("ctx._source.text = 'v2'").setVersion(11).setVersionType(VersionType.EXTERNAL));
  assertThat(run(client().prepareGet("test","type","2")).getVersion(),equalTo(11l));
  run(client().prepareUpdate("test","type","3").setScript("ctx._source.text = 'v2'").setVersion(10).setUpsert("{ \"text\": \"v0\" }"));
  GetResponse get=get("test","type","3");
  assertThat(get.getVersion(),equalTo(1l));
  assertThat((String)get.getSource().get("text"),equalTo("v0"));
  run(client().prepareUpdate("test","type","4").setScript("ctx._source.text = 'v2'").setVersion(10).setVersionType(VersionType.EXTERNAL).setUpsert("{ \"text\": \"v0\" }"));
  get=get("test","type","4");
  assertThat(get.getVersion(),equalTo(10l));
  assertThat((String)get.getSource().get("text"),equalTo("v0"));
  assertThrows(client().prepareUpdate("test","type","1").setVersion(10).setRetryOnConflict(5),ActionRequestValidationException.class);
}
