{
  createIndex("test");
  ensureGreen();
  index("test","type","1","text","value");
  assertThrows(client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v2'",ScriptService.ScriptType.INLINE).setVersion(2).execute(),VersionConflictEngineException.class);
  client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v2'",ScriptService.ScriptType.INLINE).setVersion(1).get();
  assertThat(client().prepareGet("test","type","1").get().getVersion(),equalTo(2l));
  client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v3'",ScriptService.ScriptType.INLINE).setVersion(2).get();
  assertThat(client().prepareGet("test","type","1").get().getVersion(),equalTo(3l));
  client().prepareDelete("test","type","1").get();
  assertThrows(client().prepareUpdate("test","type","1").setScript("ctx._source.text = 'v2'",ScriptService.ScriptType.INLINE).setVersion(3).execute(),DocumentMissingException.class);
  client().prepareIndex("test","type","2").setSource("text","value").setVersion(10).setVersionType(VersionType.EXTERNAL).get();
  assertThrows(client().prepareUpdate("test","type","2").setScript("ctx._source.text = 'v2'",ScriptService.ScriptType.INLINE).setVersion(2).setVersionType(VersionType.EXTERNAL).execute(),ActionRequestValidationException.class);
  client().prepareUpdate("test","type","3").setScript("ctx._source.text = 'v2'",ScriptService.ScriptType.INLINE).setVersion(10).setUpsert("{ \"text\": \"v0\" }").get();
  GetResponse get=get("test","type","3");
  assertThat(get.getVersion(),equalTo(1l));
  assertThat((String)get.getSource().get("text"),equalTo("v0"));
  client().prepareUpdate("test","type","4").setScript("ctx._source.text = 'v2'",ScriptService.ScriptType.INLINE).setVersion(10).setVersionType(VersionType.FORCE).setUpsert("{ \"text\": \"v0\" }").get();
  get=get("test","type","4");
  assertThat(get.getVersion(),equalTo(10l));
  assertThat((String)get.getSource().get("text"),equalTo("v0"));
  assertThrows(client().prepareUpdate("test","type","1").setVersion(10).setRetryOnConflict(5),ActionRequestValidationException.class);
}
