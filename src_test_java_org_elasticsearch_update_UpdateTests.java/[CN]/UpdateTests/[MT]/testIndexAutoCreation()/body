{
  UpdateResponse updateResponse=client().prepareUpdate("test","type1","1").setUpsert(XContentFactory.jsonBuilder().startObject().field("bar","baz").endObject()).setScript("ctx._source.extra = \"foo\"",ScriptService.ScriptType.INLINE).setFields("_source").execute().actionGet();
  assertThat(updateResponse.getGetResult(),notNullValue());
  assertThat(updateResponse.getGetResult().sourceAsMap().get("bar").toString(),equalTo("baz"));
  assertThat(updateResponse.getGetResult().sourceAsMap().get("extra"),nullValue());
}
