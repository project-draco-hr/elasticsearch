{
  XContentType contentType=XContentType.fromRestContentType(request.param("format",request.header("Content-Type")));
  if (contentType == null) {
    if (autoDetectSource != null) {
      contentType=XContentFactory.xContentType(autoDetectSource);
    }
  }
  if (contentType == null) {
    contentType=XContentType.JSON;
  }
  String[] filters=useFiltering ? request.paramAsStringArrayOrEmptyIfAll("filter_path") : null;
  XContentBuilder builder=new XContentBuilder(XContentFactory.xContent(contentType),bytesOutput(),filters);
  if (request.paramAsBoolean("pretty",false)) {
    builder.prettyPrint().lfAtEnd();
  }
  builder.humanReadable(request.paramAsBoolean("human",builder.humanReadable()));
  String casing=request.param("case");
  if (casing != null && "camelCase".equals(casing)) {
    builder.fieldCaseConversion(XContentBuilder.FieldCaseConversion.CAMELCASE);
  }
 else {
    builder.fieldCaseConversion(XContentBuilder.FieldCaseConversion.NONE);
  }
  return builder;
}
