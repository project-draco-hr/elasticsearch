{
  int iters=scaledRandomIntBetween(20,100);
  for (int i=0; i < iters; i++) {
    final Index index=new Index("test");
    final String name="ngr";
    Version v=randomVersion(random());
    if (v.onOrAfter(Version.V_0_90_2)) {
      Builder builder=newAnalysisSettingsBuilder().put("min_gram",2).put("max_gram",3);
      boolean compatVersion=false;
      if ((compatVersion=random().nextBoolean())) {
        builder.put("version","4." + random().nextInt(3));
      }
      boolean reverse=random().nextBoolean();
      if (reverse) {
        builder.put("side","back");
      }
      Settings settings=builder.build();
      Settings indexSettings=newAnalysisSettingsBuilder().put(IndexMetaData.SETTING_VERSION_CREATED,v.id).build();
      Tokenizer tokenizer=new MockTokenizer();
      tokenizer.setReader(new StringReader("foo bar"));
      TokenStream edgeNGramTokenFilter=new EdgeNGramTokenFilterFactory(index,indexSettings,name,settings).create(tokenizer);
      if (reverse) {
        assertThat(edgeNGramTokenFilter,instanceOf(ReverseStringFilter.class));
      }
 else       if (compatVersion) {
        assertThat(edgeNGramTokenFilter,instanceOf(Lucene43EdgeNGramTokenFilter.class));
      }
 else {
        assertThat(edgeNGramTokenFilter,instanceOf(EdgeNGramTokenFilter.class));
      }
    }
 else {
      Builder builder=newAnalysisSettingsBuilder().put("min_gram",2).put("max_gram",3);
      boolean reverse=random().nextBoolean();
      if (reverse) {
        builder.put("side","back");
      }
      Settings settings=builder.build();
      Settings indexSettings=newAnalysisSettingsBuilder().put(IndexMetaData.SETTING_VERSION_CREATED,v.id).build();
      Tokenizer tokenizer=new MockTokenizer();
      tokenizer.setReader(new StringReader("foo bar"));
      TokenStream edgeNGramTokenFilter=new EdgeNGramTokenFilterFactory(index,indexSettings,name,settings).create(tokenizer);
      if (reverse) {
        assertThat(edgeNGramTokenFilter,instanceOf(ReverseStringFilter.class));
      }
 else {
        assertThat(edgeNGramTokenFilter,instanceOf(Lucene43EdgeNGramTokenFilter.class));
      }
    }
  }
}
