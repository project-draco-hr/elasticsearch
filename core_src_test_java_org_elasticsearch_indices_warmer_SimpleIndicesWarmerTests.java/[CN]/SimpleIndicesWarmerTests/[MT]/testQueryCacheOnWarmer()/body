{
  createIndex("test");
  ensureGreen();
  assertAcked(client().admin().indices().prepareUpdateSettings("test").setSettings(Settings.builder().put(IndicesQueryCache.INDEX_CACHE_QUERY_ENABLED,false)));
  logger.info("register warmer with no query cache, validate no cache is used");
  assertAcked(client().admin().indices().preparePutWarmer("warmer_1").setSearchRequest(client().prepareSearch("test").setTypes("a1").setQuery(QueryBuilders.matchAllQuery())).get());
  client().prepareIndex("test","type1","1").setSource("field","value1").setRefresh(true).execute().actionGet();
  assertThat(client().admin().indices().prepareStats("test").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),equalTo(0l));
  logger.info("register warmer with query cache, validate caching happened");
  assertAcked(client().admin().indices().preparePutWarmer("warmer_1").setSearchRequest(client().prepareSearch("test").setTypes("a1").setQuery(QueryBuilders.matchAllQuery()).setQueryCache(true)).get());
  client().prepareIndex("test","type1","1").setSource("field","value1").setRefresh(true).execute().actionGet();
  assertThat(client().admin().indices().prepareStats("test").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),greaterThan(0l));
  client().admin().indices().prepareClearCache().setQueryCache(true).get();
  assertThat(client().admin().indices().prepareStats("test").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),equalTo(0l));
  logger.info("enable default query caching on the index level, and test that no flag on warmer still caches");
  assertAcked(client().admin().indices().prepareUpdateSettings("test").setSettings(Settings.builder().put(IndicesQueryCache.INDEX_CACHE_QUERY_ENABLED,true)));
  assertAcked(client().admin().indices().preparePutWarmer("warmer_1").setSearchRequest(client().prepareSearch("test").setTypes("a1").setQuery(QueryBuilders.matchAllQuery())).get());
  client().prepareIndex("test","type1","1").setSource("field","value1").setRefresh(true).execute().actionGet();
  assertThat(client().admin().indices().prepareStats("test").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),greaterThan(0l));
}
