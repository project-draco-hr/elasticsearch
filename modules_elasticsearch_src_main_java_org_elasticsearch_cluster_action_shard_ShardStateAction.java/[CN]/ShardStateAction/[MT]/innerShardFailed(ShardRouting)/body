{
  logger.warn("Received shard failed for {}",shardRouting);
  clusterService.submitStateUpdateTask("shard-failed (" + shardRouting + ")",new ClusterStateUpdateTask(){
    @Override public ClusterState execute(    ClusterState currentState){
      RoutingTable routingTable=currentState.routingTable();
      IndexRoutingTable indexRoutingTable=routingTable.index(shardRouting.index());
      if (indexRoutingTable == null) {
        return currentState;
      }
      if (logger.isDebugEnabled()) {
        logger.debug("Applying failed shard {}",shardRouting);
      }
      RoutingTable prevRoutingTable=currentState.routingTable();
      RoutingTable newRoutingTable=shardsRoutingStrategy.applyFailedShards(currentState,newArrayList(shardRouting));
      if (prevRoutingTable == newRoutingTable) {
        return currentState;
      }
      return newClusterStateBuilder().state(currentState).routingTable(newRoutingTable).build();
    }
  }
);
}
