{
  assertAcked(prepareCreate("test1").addMapping("test","value","type=long"));
  assertAcked(prepareCreate("test2").addMapping("test","value","type=string"));
  ensureGreen("test1","test2");
  client().prepareIndex("test1","test").setSource("value",1l).get();
  client().prepareIndex("test1","test").setSource("value",2l).get();
  client().prepareIndex("test2","test").setSource("value","a").get();
  client().prepareIndex("test2","test").setSource("value","b").get();
  refresh();
  try {
    client().prepareFieldStats().setFields("value").get();
    fail();
  }
 catch (  IllegalStateException e) {
    assertThat(e.getMessage(),containsString("trying to merge the field stats of field [value]"));
  }
  FieldStatsResponse response=client().prepareFieldStats().setFields("value").setLevel("indices").get();
  assertAllSuccessful(response);
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(2));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValue(),equalTo(Long.toString(1)));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMaxValue(),equalTo(Long.toString(2)));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValue(),equalTo("a"));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMaxValue(),equalTo("b"));
}
