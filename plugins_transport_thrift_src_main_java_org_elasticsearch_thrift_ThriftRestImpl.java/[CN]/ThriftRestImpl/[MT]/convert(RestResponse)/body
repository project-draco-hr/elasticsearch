{
  org.elasticsearch.thrift.RestResponse tResponse=new org.elasticsearch.thrift.RestResponse(getStatus(response.status()));
  if (response.contentLength() > 0) {
    if (response.contentThreadSafe()) {
      tResponse.setBody(ByteBuffer.wrap(response.content(),0,response.contentLength()));
    }
 else {
      byte[] body=new byte[response.contentLength()];
      System.arraycopy(response.content(),0,body,0,response.contentLength());
      tResponse.setBody(ByteBuffer.wrap(body));
      if (response instanceof XContentRestResponse) {
        XContentBuilder builder=((XContentRestResponse)response).builder();
        if (builder.payload() instanceof CachedStreamOutput.Entry) {
          CachedStreamOutput.pushEntry((CachedStreamOutput.Entry)builder.payload());
        }
      }
    }
  }
  return tResponse;
}
