{
  SnapshotMetaData snapshotMetaData=event.state().getMetaData().custom(SnapshotMetaData.TYPE);
  if (snapshotMetaData == null) {
    return;
  }
  for (  SnapshotMetaData.Entry snapshot : snapshotMetaData.entries()) {
    if (snapshot.state() == State.STARTED || snapshot.state() == State.ABORTED) {
      ImmutableMap<ShardId,IndexShardSnapshotStatus> localShards=currentSnapshotShards(snapshot.snapshotId());
      if (localShards != null) {
        ImmutableMap<ShardId,ShardSnapshotStatus> masterShards=snapshot.shards();
        for (        Map.Entry<ShardId,IndexShardSnapshotStatus> localShard : localShards.entrySet()) {
          ShardId shardId=localShard.getKey();
          IndexShardSnapshotStatus localShardStatus=localShard.getValue();
          ShardSnapshotStatus masterShard=masterShards.get(shardId);
          if (masterShard != null && masterShard.state().completed() == false) {
            if (localShardStatus.stage() == IndexShardSnapshotStatus.Stage.DONE) {
              logger.debug("[{}] new master thinks the shard [{}] is not completed but the shard is done locally, updating status on the master",snapshot.snapshotId(),shardId);
              updateIndexShardSnapshotStatus(new UpdateIndexShardSnapshotStatusRequest(snapshot.snapshotId(),shardId,new ShardSnapshotStatus(event.state().nodes().localNodeId(),SnapshotMetaData.State.SUCCESS)));
            }
 else             if (localShard.getValue().stage() == IndexShardSnapshotStatus.Stage.FAILURE) {
              logger.debug("[{}] new master thinks the shard [{}] is not completed but the shard failed locally, updating status on master",snapshot.snapshotId(),shardId);
              updateIndexShardSnapshotStatus(new UpdateIndexShardSnapshotStatusRequest(snapshot.snapshotId(),shardId,new ShardSnapshotStatus(event.state().nodes().localNodeId(),State.FAILED,localShardStatus.failure())));
            }
          }
        }
      }
    }
  }
}
