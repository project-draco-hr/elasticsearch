{
  RestoreInProgress restore=event.state().custom(RestoreInProgress.TYPE);
  if (restore == null) {
    return;
  }
  if (!event.indicesDeleted().isEmpty()) {
    for (    RestoreInProgress.Entry entry : restore.entries()) {
      List<ShardId> shardsToFail=null;
      for (      Map.Entry<ShardId,ShardRestoreStatus> shard : entry.shards().entrySet()) {
        if (!shard.getValue().state().completed()) {
          if (!event.state().metaData().hasIndex(shard.getKey().getIndex())) {
            if (shardsToFail == null) {
              shardsToFail=new ArrayList<>();
            }
            shardsToFail.add(shard.getKey());
          }
        }
      }
      if (shardsToFail != null) {
        for (        ShardId shardId : shardsToFail) {
          logger.trace("[{}] failing running shard restore [{}]",entry.snapshotId(),shardId);
          updateRestoreStateOnMaster(new UpdateIndexShardRestoreStatusRequest(entry.snapshotId(),shardId,new ShardRestoreStatus(null,RestoreInProgress.State.FAILURE,"index was deleted")));
        }
      }
    }
  }
}
