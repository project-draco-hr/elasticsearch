{
  Index index=new Index(indexMetaData.getIndex());
  Settings settings=indexMetaData.getSettings();
  try {
    SimilarityService similarityService=new SimilarityService(index,settings);
    try (AnalysisService analysisService=new FakeAnalysisService(index,settings)){
      try (MapperService mapperService=new MapperService(index,settings,analysisService,similarityService,scriptService)){
        for (        ObjectCursor<MappingMetaData> cursor : indexMetaData.getMappings().values()) {
          MappingMetaData mappingMetaData=cursor.value;
          mapperService.merge(mappingMetaData.type(),mappingMetaData.source(),false,false);
        }
      }
     }
   }
 catch (  Exception ex) {
    throw new IllegalStateException("unable to upgrade the mappings for the index [" + indexMetaData.getIndex() + "], reason: ["+ ex.getMessage()+ "]",ex);
  }
}
