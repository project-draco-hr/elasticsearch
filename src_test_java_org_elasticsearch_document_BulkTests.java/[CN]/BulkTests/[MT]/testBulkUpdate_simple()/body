{
  createIndex("test");
  ensureGreen();
  BulkResponse bulkResponse=client().prepareBulk().add(client().prepareIndex().setIndex("test").setType("type1").setId("1").setSource("field",1)).add(client().prepareIndex().setIndex("test").setType("type1").setId("2").setSource("field",2).setCreate(true)).add(client().prepareIndex().setIndex("test").setType("type1").setId("3").setSource("field",3)).add(client().prepareIndex().setIndex("test").setType("type1").setId("4").setSource("field",4)).add(client().prepareIndex().setIndex("test").setType("type1").setId("5").setSource("field",5)).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(false));
  assertThat(bulkResponse.getItems().length,equalTo(5));
  bulkResponse=client().prepareBulk().add(client().prepareUpdate().setIndex("test").setType("type1").setId("1").setInlineScript("ctx._source.field += 1")).add(client().prepareUpdate().setIndex("test").setType("type1").setId("2").setInlineScript("ctx._source.field += 1").setRetryOnConflict(3)).add(client().prepareUpdate().setIndex("test").setType("type1").setId("3").setDoc(jsonBuilder().startObject().field("field1","test").endObject())).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(false));
  assertThat(bulkResponse.getItems().length,equalTo(3));
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getId(),equalTo("1"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getVersion(),equalTo(2l));
  assertThat(((UpdateResponse)bulkResponse.getItems()[1].getResponse()).getId(),equalTo("2"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[1].getResponse()).getVersion(),equalTo(2l));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getId(),equalTo("3"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getVersion(),equalTo(2l));
  GetResponse getResponse=client().prepareGet().setIndex("test").setType("type1").setId("1").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(2l));
  assertThat(((Long)getResponse.getField("field").getValue()),equalTo(2l));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("2").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(2l));
  assertThat(((Long)getResponse.getField("field").getValue()),equalTo(3l));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("3").setFields("field1").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(2l));
  assertThat(getResponse.getField("field1").getValue().toString(),equalTo("test"));
  bulkResponse=client().prepareBulk().add(client().prepareUpdate().setIndex("test").setType("type1").setId("6").setInlineScript("ctx._source.field += 1").setUpsert(jsonBuilder().startObject().field("field",0).endObject())).add(client().prepareUpdate().setIndex("test").setType("type1").setId("7").setInlineScript("ctx._source.field += 1")).add(client().prepareUpdate().setIndex("test").setType("type1").setId("2").setInlineScript("ctx._source.field += 1")).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(true));
  assertThat(bulkResponse.getItems().length,equalTo(3));
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getId(),equalTo("6"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getVersion(),equalTo(1l));
  assertThat(bulkResponse.getItems()[1].getResponse(),nullValue());
  assertThat(bulkResponse.getItems()[1].getFailure().getId(),equalTo("7"));
  assertThat(bulkResponse.getItems()[1].getFailure().getMessage(),containsString("DocumentMissingException"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getId(),equalTo("2"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getVersion(),equalTo(3l));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("6").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(1l));
  assertThat(((Long)getResponse.getField("field").getValue()),equalTo(0l));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("7").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("2").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(3l));
  assertThat(((Long)getResponse.getField("field").getValue()),equalTo(4l));
}
