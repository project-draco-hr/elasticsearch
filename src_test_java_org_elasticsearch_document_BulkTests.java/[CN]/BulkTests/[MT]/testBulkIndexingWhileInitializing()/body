{
  int replica=randomInt(2);
  cluster().ensureAtLeastNumNodes(1 + replica);
  assertAcked(prepareCreate("test").setSettings(ImmutableSettings.builder().put(indexSettings()).put("index.number_of_replicas",replica)));
  int numDocs=5000;
  int bulk=50;
  for (int i=0; i < numDocs; ) {
    BulkRequestBuilder builder=client().prepareBulk();
    for (int j=0; j < bulk; j++, i++) {
      builder.add(client().prepareIndex("test","type1",Integer.toString(i)).setSource("val",i));
    }
    logger.info("bulk indexing {}-{}",i - bulk,i - 1);
    BulkResponse response=builder.get();
    if (response.hasFailures()) {
      fail(response.buildFailureMessage());
    }
  }
  refresh();
  CountResponse countResponse=client().prepareCount().get();
  assertHitCount(countResponse,numDocs);
}
