{
  try {
    client.admin().indices().prepareDelete("test").execute().actionGet();
  }
 catch (  Exception e) {
  }
  client.admin().indices().prepareCreate("test").execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  logger.info("--> creating alias with routing [3]");
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test","alias").routing("3")).execute().actionGet();
  logger.info("--> indexing with id [0], and routing [3]");
  client.prepareIndex("alias","type1","0").setSource("field","value1").setRefresh(true).execute().actionGet();
  logger.info("--> verifying get with no routing, should not find anything");
  logger.info("--> verifying get and search with routing, should find");
  for (int i=0; i < 5; i++) {
    assertThat(client.prepareGet("test","type1","0").setRouting("3").execute().actionGet().isExists(),equalTo(true));
    assertThat(client.prepareSearch("alias").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(1l));
    assertThat(client.prepareCount("alias").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(1l));
  }
  logger.info("--> creating alias with routing [4]");
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test","alias").routing("4")).execute().actionGet();
  logger.info("--> verifying search with wrong routing should not find");
  for (int i=0; i < 5; i++) {
    assertThat(client.prepareSearch("alias").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(0l));
    assertThat(client.prepareCount("alias").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(0l));
  }
  logger.info("--> creating alias with search routing [3,4] and index routing 4");
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test","alias").searchRouting("3,4").indexRouting("4")).execute().actionGet();
  logger.info("--> indexing with id [1], and routing [4]");
  client.prepareIndex("alias","type1","1").setSource("field","value2").setRefresh(true).execute().actionGet();
  logger.info("--> verifying get with no routing, should not find anything");
  logger.info("--> verifying get and search with routing, should find");
  for (int i=0; i < 5; i++) {
    assertThat(client.prepareGet("test","type1","0").setRouting("3").execute().actionGet().isExists(),equalTo(true));
    assertThat(client.prepareGet("test","type1","1").setRouting("4").execute().actionGet().isExists(),equalTo(true));
    assertThat(client.prepareSearch("alias").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(2l));
    assertThat(client.prepareCount("alias").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(2l));
  }
}
