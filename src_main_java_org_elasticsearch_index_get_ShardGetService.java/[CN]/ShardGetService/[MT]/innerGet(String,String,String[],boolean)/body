{
  boolean loadSource=gFields == null || gFields.length > 0;
  Engine.GetResult get=null;
  if (type == null || type.equals("_all")) {
    for (    String typeX : mapperService.types()) {
      get=indexShard.get(new Engine.Get(realtime,UidFieldMapper.TERM_FACTORY.createTerm(Uid.createUid(typeX,id))).loadSource(loadSource));
      if (get.exists()) {
        type=typeX;
        break;
      }
 else {
        get.release();
      }
    }
    if (get == null) {
      return new GetResult(shardId.index().name(),type,id,-1,false,null,null);
    }
    if (!get.exists()) {
      return new GetResult(shardId.index().name(),type,id,-1,false,null,null);
    }
  }
 else {
    get=indexShard.get(new Engine.Get(realtime,UidFieldMapper.TERM_FACTORY.createTerm(Uid.createUid(type,id))).loadSource(loadSource));
    if (!get.exists()) {
      get.release();
      return new GetResult(shardId.index().name(),type,id,-1,false,null,null);
    }
  }
  DocumentMapper docMapper=mapperService.documentMapper(type);
  if (docMapper == null) {
    get.release();
    return new GetResult(shardId.index().name(),type,id,-1,false,null,null);
  }
  try {
    if (get.docIdAndVersion() != null) {
      Map<String,GetField> fields=null;
      byte[] source=null;
      UidField.DocIdAndVersion docIdAndVersion=get.docIdAndVersion();
      ResetFieldSelector fieldSelector=buildFieldSelectors(docMapper,gFields);
      if (fieldSelector != null) {
        fieldSelector.reset();
        Document doc;
        try {
          doc=docIdAndVersion.reader.document(docIdAndVersion.docId,fieldSelector);
        }
 catch (        IOException e) {
          throw new ElasticSearchException("Failed to get type [" + type + "] and id ["+ id+ "]",e);
        }
        source=extractSource(doc,docMapper);
        for (        Object oField : doc.getFields()) {
          Fieldable field=(Fieldable)oField;
          String name=field.name();
          Object value=null;
          FieldMappers fieldMappers=docMapper.mappers().indexName(field.name());
          if (fieldMappers != null) {
            FieldMapper mapper=fieldMappers.mapper();
            if (mapper != null) {
              name=mapper.names().fullName();
              value=mapper.valueForSearch(field);
            }
          }
          if (value == null) {
            if (field.isBinary()) {
              value=field.getBinaryValue();
            }
 else {
              value=field.stringValue();
            }
          }
          if (fields == null) {
            fields=newHashMapWithExpectedSize(2);
          }
          GetField getField=fields.get(name);
          if (getField == null) {
            getField=new GetField(name,new ArrayList<Object>(2));
            fields.put(name,getField);
          }
          getField.values().add(value);
        }
      }
      if (gFields != null && gFields.length > 0) {
        SearchLookup searchLookup=null;
        for (        String field : gFields) {
          Object value=null;
          if (field.contains("_source.") || field.contains("doc[")) {
            if (searchLookup == null) {
              searchLookup=new SearchLookup(mapperService,indexCache.fieldData());
            }
            SearchScript searchScript=scriptService.search(searchLookup,"mvel",field,null);
            searchScript.setNextReader(docIdAndVersion.reader);
            searchScript.setNextDocId(docIdAndVersion.docId);
            try {
              value=searchScript.run();
            }
 catch (            RuntimeException e) {
              if (logger.isTraceEnabled()) {
                logger.trace("failed to execute get request script field [{}]",e,field);
              }
            }
          }
 else {
            FieldMappers x=docMapper.mappers().smartName(field);
            if (x == null || !x.mapper().stored()) {
              if (searchLookup == null) {
                searchLookup=new SearchLookup(mapperService,indexCache.fieldData());
                searchLookup.setNextReader(docIdAndVersion.reader);
                searchLookup.setNextDocId(docIdAndVersion.docId);
              }
              value=searchLookup.source().extractValue(field);
            }
          }
          if (value != null) {
            if (fields == null) {
              fields=newHashMapWithExpectedSize(2);
            }
            GetField getField=fields.get(field);
            if (getField == null) {
              getField=new GetField(field,new ArrayList<Object>(2));
              fields.put(field,getField);
            }
            getField.values().add(value);
          }
        }
      }
      return new GetResult(shardId.index().name(),type,id,get.version(),get.exists(),source == null ? null : new BytesHolder(source),fields);
    }
 else {
      Translog.Source source=get.source();
      Map<String,GetField> fields=null;
      boolean sourceRequested=false;
      if (gFields == null) {
        sourceRequested=true;
      }
 else       if (gFields.length == 0) {
        sourceRequested=false;
      }
 else {
        Map<String,Object> sourceAsMap=null;
        SearchLookup searchLookup=null;
        for (        String field : gFields) {
          if (field.equals("_source")) {
            sourceRequested=true;
            continue;
          }
          Object value=null;
          if (field.equals(RoutingFieldMapper.NAME) && docMapper.routingFieldMapper().stored()) {
            value=source.routing;
          }
 else           if (field.equals(ParentFieldMapper.NAME) && docMapper.parentFieldMapper() != null && docMapper.parentFieldMapper().stored()) {
            value=source.parent;
          }
 else           if (field.equals(TimestampFieldMapper.NAME) && docMapper.timestampFieldMapper().stored()) {
            value=source.timestamp;
          }
 else           if (field.equals(TTLFieldMapper.NAME) && docMapper.TTLFieldMapper().stored()) {
            if (source.ttl > 0) {
              value=docMapper.TTLFieldMapper().valueForSearch(source.timestamp + source.ttl);
            }
          }
 else           if (field.equals(SizeFieldMapper.NAME) && docMapper.rootMapper(SizeFieldMapper.class).stored()) {
            value=source.source.length();
          }
 else {
            if (field.contains("_source.")) {
              if (searchLookup == null) {
                searchLookup=new SearchLookup(mapperService,indexCache.fieldData());
              }
              if (sourceAsMap == null) {
                sourceAsMap=SourceLookup.sourceAsMap(source.source.bytes(),source.source.offset(),source.source.length());
              }
              SearchScript searchScript=scriptService.search(searchLookup,"mvel",field,null);
              searchScript.setNextSource(sourceAsMap);
              try {
                value=searchScript.run();
              }
 catch (              RuntimeException e) {
                if (logger.isTraceEnabled()) {
                  logger.trace("failed to execute get request script field [{}]",e,field);
                }
              }
            }
 else {
              if (searchLookup == null) {
                searchLookup=new SearchLookup(mapperService,indexCache.fieldData());
                searchLookup.source().setNextSource(source.source.bytes(),source.source.offset(),source.source.length());
              }
              FieldMapper<?> x=docMapper.mappers().smartNameFieldMapper(field);
              value=searchLookup.source().extractValue(field);
              if (x != null && value instanceof String) {
                value=x.valueFromString((String)value);
              }
            }
          }
          if (value != null) {
            if (fields == null) {
              fields=newHashMapWithExpectedSize(2);
            }
            GetField getField=fields.get(field);
            if (getField == null) {
              getField=new GetField(field,new ArrayList<Object>(2));
              fields.put(field,getField);
            }
            getField.values().add(value);
          }
        }
      }
      if (sourceRequested && !docMapper.sourceMapper().enabled()) {
        sourceRequested=false;
      }
      return new GetResult(shardId.index().name(),type,id,get.version(),get.exists(),sourceRequested ? source.source : null,fields);
    }
  }
  finally {
    get.release();
  }
}
