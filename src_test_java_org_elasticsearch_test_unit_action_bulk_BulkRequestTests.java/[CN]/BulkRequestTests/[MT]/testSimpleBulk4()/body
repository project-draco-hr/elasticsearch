{
  String bulkAction=copyToStringFromClasspath("/org/elasticsearch/test/unit/action/bulk/simple-bulk4.json");
  BulkRequest bulkRequest=new BulkRequest();
  bulkRequest.add(bulkAction.getBytes(Streams.UTF8),0,bulkAction.length(),true,null,null);
  assertThat(bulkRequest.numberOfActions(),equalTo(4));
  assertThat(((UpdateRequest)bulkRequest.requests().get(0)).id(),equalTo("1"));
  assertThat(((UpdateRequest)bulkRequest.requests().get(0)).retryOnConflict(),equalTo(2));
  assertThat(((UpdateRequest)bulkRequest.requests().get(0)).doc().source().toUtf8(),equalTo("{\"field\":\"value\"}"));
  assertThat(((UpdateRequest)bulkRequest.requests().get(1)).id(),equalTo("0"));
  assertThat(((UpdateRequest)bulkRequest.requests().get(1)).type(),equalTo("type1"));
  assertThat(((UpdateRequest)bulkRequest.requests().get(1)).index(),equalTo("index1"));
  assertThat(((UpdateRequest)bulkRequest.requests().get(1)).script(),equalTo("counter += param1"));
  assertThat(((UpdateRequest)bulkRequest.requests().get(1)).scriptLang(),equalTo("js"));
  assertThat(((UpdateRequest)bulkRequest.requests().get(1)).scriptParams().size(),equalTo(1));
  assertThat(((Integer)((UpdateRequest)bulkRequest.requests().get(1)).scriptParams().get("param1")),equalTo(1));
  assertThat(((UpdateRequest)bulkRequest.requests().get(1)).upsertRequest().source().toUtf8(),equalTo("{\"counter\":1}"));
}
