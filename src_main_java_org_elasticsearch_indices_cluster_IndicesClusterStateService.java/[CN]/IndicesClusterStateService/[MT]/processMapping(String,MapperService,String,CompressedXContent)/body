{
  if (!seenMappings.containsKey(new Tuple<>(index,mappingType))) {
    seenMappings.put(new Tuple<>(index,mappingType),true);
  }
  boolean requiresRefresh=false;
  try {
    if (!mapperService.hasMapping(mappingType)) {
      if (logger.isDebugEnabled() && mappingSource.compressed().length < 512) {
        logger.debug("[{}] adding mapping [{}], source [{}]",index,mappingType,mappingSource.string());
      }
 else       if (logger.isTraceEnabled()) {
        logger.trace("[{}] adding mapping [{}], source [{}]",index,mappingType,mappingSource.string());
      }
 else {
        logger.debug("[{}] adding mapping [{}] (source suppressed due to length, use TRACE level if needed)",index,mappingType);
      }
      mapperService.merge(mappingType,mappingSource,false);
      if (!mapperService.documentMapper(mappingType).mappingSource().equals(mappingSource)) {
        logger.debug("[{}] parsed mapping [{}], and got different sources\noriginal:\n{}\nparsed:\n{}",index,mappingType,mappingSource,mapperService.documentMapper(mappingType).mappingSource());
        requiresRefresh=true;
      }
    }
 else {
      DocumentMapper existingMapper=mapperService.documentMapper(mappingType);
      if (!mappingSource.equals(existingMapper.mappingSource())) {
        if (logger.isDebugEnabled() && mappingSource.compressed().length < 512) {
          logger.debug("[{}] updating mapping [{}], source [{}]",index,mappingType,mappingSource.string());
        }
 else         if (logger.isTraceEnabled()) {
          logger.trace("[{}] updating mapping [{}], source [{}]",index,mappingType,mappingSource.string());
        }
 else {
          logger.debug("[{}] updating mapping [{}] (source suppressed due to length, use TRACE level if needed)",index,mappingType);
        }
        mapperService.merge(mappingType,mappingSource,false);
        if (!mapperService.documentMapper(mappingType).mappingSource().equals(mappingSource)) {
          requiresRefresh=true;
          logger.debug("[{}] parsed mapping [{}], and got different sources\noriginal:\n{}\nparsed:\n{}",index,mappingType,mappingSource,mapperService.documentMapper(mappingType).mappingSource());
        }
      }
    }
  }
 catch (  Throwable e) {
    logger.warn("[{}] failed to add mapping [{}], source [{}]",e,index,mappingType,mappingSource);
    throw e;
  }
  return requiresRefresh;
}
