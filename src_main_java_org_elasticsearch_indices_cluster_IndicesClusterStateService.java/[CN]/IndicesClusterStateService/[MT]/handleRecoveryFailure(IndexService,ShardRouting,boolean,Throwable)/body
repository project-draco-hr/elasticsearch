{
  logger.warn("[{}][{}] failed to start shard",failure,indexService.index().name(),shardRouting.shardId().id());
synchronized (mutex) {
    if (indexService.hasShard(shardRouting.shardId().id())) {
      try {
        indexService.removeShard(shardRouting.shardId().id(),"recovery failure [" + ExceptionsHelper.detailedMessage(failure) + "]");
      }
 catch (      IndexShardMissingException e) {
      }
catch (      Throwable e1) {
        logger.warn("[{}][{}] failed to delete shard after failed startup",e1,indexService.index().name(),shardRouting.shardId().id());
      }
    }
    if (sendShardFailure) {
      try {
        failedShards.put(shardRouting.shardId(),new FailedShard(shardRouting.version()));
        shardStateAction.shardFailed(shardRouting,"Failed to start shard, message [" + detailedMessage(failure) + "]");
      }
 catch (      Throwable e1) {
        logger.warn("[{}][{}] failed to mark shard as failed after a failed start",e1,indexService.index().name(),shardRouting.id());
      }
    }
  }
}
