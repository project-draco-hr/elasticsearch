{
  for (  IndexMetaData indexMetaData : event.state().metaData()) {
    if (!indicesService.hasIndex(indexMetaData.index())) {
      continue;
    }
    if (!event.indexMetaDataChanged(indexMetaData)) {
      continue;
    }
    List<String> typesToRefresh=null;
    String index=indexMetaData.index();
    IndexService indexService=indicesService.indexServiceSafe(index);
    MapperService mapperService=indexService.mapperService();
    if (indexMetaData.mappings().containsKey(MapperService.DEFAULT_MAPPING)) {
      processMapping(event,index,mapperService,MapperService.DEFAULT_MAPPING,indexMetaData.mapping(MapperService.DEFAULT_MAPPING).source());
    }
    for (    MappingMetaData mappingMd : indexMetaData.mappings().values()) {
      String mappingType=mappingMd.type();
      CompressedString mappingSource=mappingMd.source();
      if (mappingType.equals(MapperService.DEFAULT_MAPPING)) {
        continue;
      }
      boolean requireRefresh=processMapping(event,index,mapperService,mappingType,mappingSource);
      if (requireRefresh) {
        if (typesToRefresh == null) {
          typesToRefresh=Lists.newArrayList();
        }
        typesToRefresh.add(mappingType);
      }
    }
    if (typesToRefresh != null) {
      nodeMappingRefreshAction.nodeMappingRefresh(new NodeMappingRefreshAction.NodeMappingRefreshRequest(index,typesToRefresh.toArray(new String[typesToRefresh.size()]),event.state().nodes().localNodeId()));
    }
    for (    DocumentMapper documentMapper : mapperService) {
      if (seenMappings.containsKey(new Tuple<String,String>(index,documentMapper.type())) && !indexMetaData.mappings().containsKey(documentMapper.type())) {
        mapperService.remove(documentMapper.type());
        seenMappings.remove(new Tuple<String,String>(index,documentMapper.type()));
      }
    }
  }
}
