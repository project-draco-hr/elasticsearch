{
  client().admin().indices().prepareCreate(INDEX).get();
  int iters=atLeast(10);
  for (int i=0; i < iters; i++) {
    int len=between(3,50);
    String str=replaceReservedChars(randomRealisticUnicodeOfCodepointLengthBetween(len + 1,atLeast(len + 2)),(char)0x01);
    ElasticSearchAssertions.assertAcked(client().admin().indices().preparePutMapping(INDEX).setType(TYPE).setSource(jsonBuilder().startObject().startObject(TYPE).startObject("properties").startObject(FIELD).field("type","completion").field("max_input_len",len).field("analyzer","keyword").endObject().endObject().endObject().endObject()));
    ensureYellow();
    client().prepareIndex(INDEX,TYPE,"1").setSource(jsonBuilder().startObject().startObject(FIELD).startArray("input").value(str).endArray().field("output","foobar").endObject().endObject()).setRefresh(true).get();
    int prefixLen=CompletionFieldMapper.correctSubStringLen(str,between(1,len - 1));
    assertSuggestions(str.substring(0,prefixLen),"foobar");
    if (len + 1 < str.length()) {
      assertSuggestions(str.substring(0,CompletionFieldMapper.correctSubStringLen(str,len + (Character.isHighSurrogate(str.charAt(len - 1)) ? 2 : 1))));
    }
  }
}
