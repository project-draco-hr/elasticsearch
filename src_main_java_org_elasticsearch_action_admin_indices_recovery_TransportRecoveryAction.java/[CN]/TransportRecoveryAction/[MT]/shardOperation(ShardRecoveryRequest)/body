{
  InternalIndexService indexService=(InternalIndexService)indicesService.indexServiceSafe(request.index());
  InternalIndexShard indexShard=(InternalIndexShard)indexService.shardSafe(request.shardId());
  ShardRouting shardRouting=indexShard.routingEntry();
  ShardRecoveryResponse shardRecoveryResponse=new ShardRecoveryResponse(shardRouting.index(),shardRouting.id());
  RecoveryState state;
  RecoveryStatus recoveryStatus=indexShard.recoveryStatus();
  if (recoveryStatus == null) {
    recoveryStatus=recoveryTarget.recoveryStatus(indexShard);
  }
  if (recoveryStatus != null) {
    state=recoveryStatus.recoveryState();
  }
 else {
    IndexShardGatewayService gatewayService=indexService.shardInjector(request.shardId()).getInstance(IndexShardGatewayService.class);
    state=gatewayService.recoveryState();
  }
  shardRecoveryResponse.recoveryState(state);
  return shardRecoveryResponse;
}
