{
  InternalIndexService indexService=(InternalIndexService)indicesService.indexServiceSafe(request.shardId().getIndex());
  InternalIndexShard indexShard=(InternalIndexShard)indexService.shardSafe(request.shardId().id());
  ShardRecoveryResponse shardRecoveryResponse=new ShardRecoveryResponse(request.shardId());
  RecoveryState state=indexShard.recoveryState();
  if (state == null) {
    state=recoveryTarget.recoveryState(indexShard);
  }
  if (state == null) {
    IndexShardGatewayService gatewayService=indexService.shardInjector(request.shardId().id()).getInstance(IndexShardGatewayService.class);
    state=gatewayService.recoveryState();
  }
  shardRecoveryResponse.recoveryState(state);
  return shardRecoveryResponse;
}
