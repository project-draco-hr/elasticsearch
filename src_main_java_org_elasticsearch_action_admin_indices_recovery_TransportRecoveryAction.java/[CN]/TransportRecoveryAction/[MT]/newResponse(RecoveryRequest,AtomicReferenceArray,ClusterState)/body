{
  int successfulShards=0;
  int failedShards=0;
  List<ShardOperationFailedException> shardFailures=null;
  Map<String,List<ShardRecoveryResponse>> shardResponses=new HashMap<>();
  for (int i=0; i < shardsResponses.length(); i++) {
    Object shardResponse=shardsResponses.get(i);
    if (shardResponse == null) {
    }
 else     if (shardResponse instanceof BroadcastShardOperationFailedException) {
      failedShards++;
      if (shardFailures == null) {
        shardFailures=new ArrayList<>();
      }
      shardFailures.add(new DefaultShardOperationFailedException((BroadcastShardOperationFailedException)shardResponse));
    }
 else {
      ShardRecoveryResponse recoveryResponse=(ShardRecoveryResponse)shardResponse;
      successfulShards++;
      if (recoveryResponse.recoveryState() == null) {
        continue;
      }
      String indexName=recoveryResponse.getIndex();
      List<ShardRecoveryResponse> responses=shardResponses.get(indexName);
      if (responses == null) {
        responses=new ArrayList<>();
        shardResponses.put(indexName,responses);
      }
      if (request.activeOnly()) {
        if (recoveryResponse.recoveryState().getStage() != RecoveryState.Stage.DONE) {
          responses.add(recoveryResponse);
        }
      }
 else {
        responses.add(recoveryResponse);
      }
    }
  }
  return new RecoveryResponse(shardsResponses.length(),successfulShards,failedShards,request.detailed(),shardResponses,shardFailures);
}
