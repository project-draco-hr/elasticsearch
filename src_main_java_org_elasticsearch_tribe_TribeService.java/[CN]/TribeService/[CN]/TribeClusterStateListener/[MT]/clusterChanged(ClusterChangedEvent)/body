{
  logger.debug("[{}] received cluster event, [{}]",tribeName,event.source());
  clusterService.submitStateUpdateTask("cluster event from " + tribeName + ", "+ event.source(),new ClusterStateUpdateTask(){
    @Override public ClusterState execute(    ClusterState currentState) throws Exception {
      ClusterState tribeState=event.state();
      DiscoveryNodes.Builder nodes=DiscoveryNodes.builder(currentState.nodes());
      for (      DiscoveryNode discoNode : currentState.nodes()) {
        String markedTribeName=discoNode.attributes().get(TRIBE_NAME);
        if (markedTribeName != null && markedTribeName.equals(tribeName)) {
          if (tribeState.nodes().get(discoNode.id()) == null) {
            logger.info("[{}] removing node [{}]",tribeName,discoNode);
            nodes.remove(discoNode.id());
          }
        }
      }
      for (      DiscoveryNode tribe : tribeState.nodes()) {
        if (currentState.nodes().get(tribe.id()) == null) {
          ImmutableMap<String,String> tribeAttr=MapBuilder.newMapBuilder(tribe.attributes()).put(TRIBE_NAME,tribeName).immutableMap();
          DiscoveryNode discoNode=new DiscoveryNode(tribe.name(),tribe.id(),tribe.getHostName(),tribe.getHostAddress(),tribe.address(),tribeAttr,tribe.version());
          logger.info("[{}] adding node [{}]",tribeName,discoNode);
          nodes.put(discoNode);
        }
      }
      ClusterBlocks.Builder blocks=ClusterBlocks.builder().blocks(currentState.blocks());
      MetaData.Builder metaData=MetaData.builder(currentState.metaData());
      RoutingTable.Builder routingTable=RoutingTable.builder(currentState.routingTable());
      for (      IndexMetaData index : currentState.metaData()) {
        String markedTribeName=index.settings().get(TRIBE_NAME);
        if (markedTribeName != null && markedTribeName.equals(tribeName)) {
          IndexMetaData tribeIndex=tribeState.metaData().index(index.index());
          if (tribeIndex == null) {
            logger.info("[{}] removing index [{}]",tribeName,index.index());
            removeIndex(blocks,metaData,routingTable,index);
          }
 else {
            routingTable.add(tribeState.routingTable().index(index.index()));
            Settings tribeSettings=ImmutableSettings.builder().put(tribeIndex.settings()).put(TRIBE_NAME,tribeName).build();
            metaData.put(IndexMetaData.builder(tribeIndex).settings(tribeSettings));
          }
        }
      }
      for (      IndexMetaData tribeIndex : tribeState.metaData()) {
        IndexRoutingTable table=tribeState.routingTable().index(tribeIndex.index());
        if (table == null) {
          continue;
        }
        if (!currentState.metaData().hasIndex(tribeIndex.index()) && !droppedIndices.contains(tribeIndex.index())) {
          logger.info("[{}] adding index [{}]",tribeName,tribeIndex.index());
          addNewIndex(tribeState,blocks,metaData,routingTable,tribeIndex);
        }
 else {
          String existingFromTribe=currentState.metaData().index(tribeIndex.index()).getSettings().get(TRIBE_NAME);
          if (!tribeName.equals(existingFromTribe)) {
            if (ON_CONFLICT_ANY.equals(onConflict)) {
            }
 else             if (ON_CONFLICT_DROP.equals(onConflict)) {
              logger.info("[{}] dropping index [{}] due to conflict with [{}]",tribeName,tribeIndex.index(),existingFromTribe);
              removeIndex(blocks,metaData,routingTable,tribeIndex);
              droppedIndices.add(tribeIndex.index());
            }
 else             if (onConflict.startsWith(ON_CONFLICT_PREFER)) {
              String preferredTribeName=onConflict.substring(ON_CONFLICT_PREFER.length());
              if (tribeName.equals(preferredTribeName)) {
                logger.info("[{}] adding index [{}], preferred over [{}]",tribeName,tribeIndex.index(),existingFromTribe);
                removeIndex(blocks,metaData,routingTable,tribeIndex);
                addNewIndex(tribeState,blocks,metaData,routingTable,tribeIndex);
              }
            }
          }
        }
      }
      return ClusterState.builder(currentState).blocks(blocks).nodes(nodes).metaData(metaData).routingTable(routingTable).build();
    }
    private void removeIndex(    ClusterBlocks.Builder blocks,    MetaData.Builder metaData,    RoutingTable.Builder routingTable,    IndexMetaData index){
      metaData.remove(index.index());
      routingTable.remove(index.index());
      blocks.removeIndexBlocks(index.index());
    }
    private void addNewIndex(    ClusterState tribeState,    ClusterBlocks.Builder blocks,    MetaData.Builder metaData,    RoutingTable.Builder routingTable,    IndexMetaData tribeIndex){
      Settings tribeSettings=ImmutableSettings.builder().put(tribeIndex.settings()).put(TRIBE_NAME,tribeName).build();
      metaData.put(IndexMetaData.builder(tribeIndex).settings(tribeSettings));
      routingTable.add(tribeState.routingTable().index(tribeIndex.index()));
      if (Regex.simpleMatch(blockIndicesMetadata,tribeIndex.index())) {
        blocks.addIndexBlock(tribeIndex.index(),IndexMetaData.INDEX_METADATA_BLOCK);
      }
      if (Regex.simpleMatch(blockIndicesRead,tribeIndex.index())) {
        blocks.addIndexBlock(tribeIndex.index(),IndexMetaData.INDEX_READ_BLOCK);
      }
      if (Regex.simpleMatch(blockIndicesWrite,tribeIndex.index())) {
        blocks.addIndexBlock(tribeIndex.index(),IndexMetaData.INDEX_WRITE_BLOCK);
      }
    }
    @Override public void onFailure(    String source,    Throwable t){
      logger.warn("failed to process [{}]",t,source);
    }
  }
);
}
