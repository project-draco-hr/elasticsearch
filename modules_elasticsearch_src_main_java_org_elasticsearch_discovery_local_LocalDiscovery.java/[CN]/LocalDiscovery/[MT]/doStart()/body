{
synchronized (clusterGroups) {
    ClusterGroup clusterGroup=clusterGroups.get(clusterName);
    if (clusterGroup == null) {
      clusterGroup=new ClusterGroup();
      clusterGroups.put(clusterName,clusterGroup);
    }
    logger.debug("Connected to cluster [{}]",clusterName);
    this.localNode=new DiscoveryNode(settings.get("name"),Long.toString(nodeIdGenerator.incrementAndGet()),transportService.boundAddress().publishAddress(),discoveryNodeService.buildAttributes());
    clusterGroup.members().add(this);
    LocalDiscovery firstMaster=null;
    for (    LocalDiscovery localDiscovery : clusterGroup.members()) {
      if (localDiscovery.localNode().masterNode()) {
        firstMaster=localDiscovery;
        break;
      }
    }
    if (firstMaster != null && firstMaster.equals(this)) {
      master=true;
      final LocalDiscovery master=firstMaster;
      clusterService.submitStateUpdateTask("local-disco-initial_connect(master)",new ProcessedClusterStateUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.newNodesBuilder();
          for (          LocalDiscovery discovery : clusterGroups.get(clusterName).members()) {
            nodesBuilder.put(discovery.localNode);
          }
          nodesBuilder.localNodeId(master.localNode().id()).masterNodeId(master.localNode().id());
          ClusterBlocks.Builder blocks=ClusterBlocks.builder().blocks(currentState.blocks()).removeGlobalBlock(Discovery.NO_MASTER_BLOCK);
          return newClusterStateBuilder().state(currentState).nodes(nodesBuilder).blocks(blocks).build();
        }
        @Override public void clusterStateProcessed(        ClusterState clusterState){
          sendInitialStateEventIfNeeded();
        }
      }
);
    }
 else     if (firstMaster != null) {
      final ClusterState masterState=firstMaster.clusterService.state();
      clusterService.submitStateUpdateTask("local-disco(detected_master)",new ClusterStateUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.newNodesBuilder().putAll(currentState.nodes()).put(localNode).localNodeId(localNode.id());
          return ClusterState.builder().state(currentState).metaData(masterState.metaData()).nodes(nodesBuilder).build();
        }
      }
);
      final LocalDiscovery master=firstMaster;
      firstMaster.clusterService.submitStateUpdateTask("local-disco-receive(from node[" + localNode + "])",new ProcessedClusterStateUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.newNodesBuilder();
          for (          LocalDiscovery discovery : clusterGroups.get(clusterName).members()) {
            nodesBuilder.put(discovery.localNode);
          }
          nodesBuilder.localNodeId(master.localNode().id()).masterNodeId(master.localNode().id());
          return newClusterStateBuilder().state(currentState).nodes(nodesBuilder).build();
        }
        @Override public void clusterStateProcessed(        ClusterState clusterState){
          sendInitialStateEventIfNeeded();
        }
      }
);
    }
  }
}
