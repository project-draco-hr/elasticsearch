{
  if (!lifecycle.moveToStopped()) {
    return this;
  }
synchronized (clusterGroups) {
    ClusterGroup clusterGroup=clusterGroups.get(clusterName);
    if (clusterGroup == null) {
      logger.warn("Illegal state, should not have an empty cluster group when stopping, I should be there at teh very least...");
      return this;
    }
    clusterGroup.members().remove(this);
    if (clusterGroup.members().isEmpty()) {
      clusterGroups.remove(clusterName);
      return this;
    }
    final LocalDiscovery masterDiscovery=clusterGroup.members().peek();
    if (master) {
      masterDiscovery.master=true;
    }
    final Set<String> newMembers=newHashSet();
    for (    LocalDiscovery discovery : clusterGroup.members()) {
      newMembers.add(discovery.localNode.id());
    }
    masterDiscovery.clusterService.submitStateUpdateTask("local-disco-update",new ClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState){
        Nodes newNodes=currentState.nodes().removeDeadMembers(newMembers,masterDiscovery.localNode.id());
        Nodes.Delta delta=newNodes.delta(currentState.nodes());
        if (delta.added()) {
          logger.warn("No new nodes should be created when a new discovery view is accepted");
        }
        return newClusterStateBuilder().state(currentState).nodes(newNodes).build();
      }
    }
);
  }
  return this;
}
