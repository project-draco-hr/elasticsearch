{
  int randomInt=randomInt();
  ScriptService scriptService=mock(ScriptService.class);
  ClusterService clusterService=mock(ClusterService.class);
  CompiledScript compiledScript=mock(CompiledScript.class);
  Script script=mock(Script.class);
  when(scriptService.compile(any(),any(),any(),any())).thenReturn(compiledScript);
  ExecutableScript executableScript=mock(ExecutableScript.class);
  when(scriptService.executable(any(),any())).thenReturn(executableScript);
  when(executableScript.run()).thenReturn(randomInt);
  ScriptProcessor processor=new ScriptProcessor(randomAsciiOfLength(10),script,scriptService,clusterService,"bytes_total");
  Map<String,Object> document=new HashMap<>();
  document.put("bytes_in",1234);
  document.put("bytes_out",4321);
  IngestDocument ingestDocument=RandomDocumentPicks.randomIngestDocument(random(),document);
  processor.execute(ingestDocument);
  assertThat(ingestDocument.getSourceAndMetadata(),hasKey("bytes_in"));
  assertThat(ingestDocument.getSourceAndMetadata(),hasKey("bytes_out"));
  assertThat(ingestDocument.getSourceAndMetadata(),hasKey("bytes_total"));
  assertThat(ingestDocument.getSourceAndMetadata().get("bytes_total"),is(randomInt));
}
