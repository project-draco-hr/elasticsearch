{
  Settings.Builder settingsBuilder=Settings.builder().put("path.home",tempDir).put(settings);
  if (settings.get(IndexMetaData.SETTING_VERSION_CREATED) == null) {
    settingsBuilder.put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT);
  }
  Settings finalSettings=settingsBuilder.build();
  MapperRegistry mapperRegistry=indicesModule.getMapperRegistry();
  IndexSettings indexSettings=IndexSettingsModule.newIndexSettings(new Index("test"),finalSettings);
  AnalysisService analysisService=new AnalysisRegistry(null,new Environment(finalSettings)).build(indexSettings);
  SimilarityService similarityService=new SimilarityService(indexSettings,Collections.emptyMap());
  return new MapperService(indexSettings,analysisService,similarityService,mapperRegistry);
}
