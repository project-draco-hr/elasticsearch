{
  Iterable<DiscoveryNode> dataNodes=nodes.dataNodes().values();
  boolean changed=false;
  changed|=deassociateDeadNodes(routingNodes,dataNodes);
  applyNewNodes(routingNodes,dataNodes);
  changed|=electPrimaries(routingNodes);
  if (routingNodes.hasUnassigned()) {
    if (preferUnallocatedShardUnassignedStrategy != null) {
      changed|=preferUnallocatedShardUnassignedStrategy.allocateUnassigned(routingNodes,nodes);
    }
    changed|=allocateUnassigned(routingNodes);
    changed|=electPrimaries(routingNodes);
  }
  changed|=rebalance(routingNodes);
  return changed;
}
