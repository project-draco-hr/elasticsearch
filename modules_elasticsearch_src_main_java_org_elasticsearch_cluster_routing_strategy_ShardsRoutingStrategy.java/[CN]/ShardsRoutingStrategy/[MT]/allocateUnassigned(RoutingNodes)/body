{
  boolean changed=false;
  List<RoutingNode> nodes=routingNodes.sortedNodesLeastToHigh();
  Iterator<MutableShardRouting> unassignedIterator=routingNodes.unassigned().iterator();
  int lastNode=0;
  while (unassignedIterator.hasNext()) {
    MutableShardRouting shard=unassignedIterator.next();
    if (!shard.primary()) {
      MutableShardRouting primary=routingNodes.findPrimaryForReplica(shard);
      if (primary == null || !primary.active()) {
        continue;
      }
    }
    for (int i=0; i < nodes.size(); i++) {
      RoutingNode node=nodes.get(lastNode);
      lastNode++;
      if (lastNode == nodes.size())       lastNode=0;
      if (node.canAllocate(routingNodes) && node.canAllocate(shard)) {
        int numberOfShardsToAllocate=routingNodes.requiredAverageNumberOfShardsPerNode() - node.shards().size();
        if (numberOfShardsToAllocate == 0) {
          continue;
        }
        changed=true;
        node.add(shard);
        unassignedIterator.remove();
        break;
      }
    }
  }
  for (Iterator<MutableShardRouting> it=routingNodes.unassigned().iterator(); it.hasNext(); ) {
    MutableShardRouting shard=it.next();
    if (!shard.primary()) {
      MutableShardRouting primary=routingNodes.findPrimaryForReplica(shard);
      if (primary == null || !primary.active()) {
        continue;
      }
    }
    for (    RoutingNode routingNode : routingNodes.nodesToShards().values()) {
      if (routingNode.canAllocate(routingNodes) && routingNode.canAllocate(shard)) {
        changed=true;
        routingNode.add(shard);
        it.remove();
        break;
      }
    }
  }
  return changed;
}
