{
  final int id=pingIdGenerator.incrementAndGet();
  receivedResponses.put(id,new ConcurrentHashMap<DiscoveryNode,PingResponse>());
  sendPingRequest(id,true);
  threadPool.schedule(new Runnable(){
    @Override public void run(){
      try {
        sendPingRequest(id,false);
      }
 catch (      Exception e) {
        logger.warn("[{}] failed to send second ping request",e,id);
      }
    }
  }
,TimeValue.timeValueMillis(timeout.millis() / 2),ThreadPool.ExecutionType.THREADED);
  threadPool.schedule(new Runnable(){
    @Override public void run(){
      ConcurrentMap<DiscoveryNode,PingResponse> responses=receivedResponses.remove(id);
      listener.onPing(responses.values().toArray(new PingResponse[responses.size()]));
    }
  }
,timeout,ThreadPool.ExecutionType.THREADED);
}
