{
  try {
    this.datagramPacketReceive=new DatagramPacket(new byte[bufferSize],bufferSize);
    this.datagramPacketSend=new DatagramPacket(new byte[bufferSize],bufferSize,InetAddress.getByName(group),port);
  }
 catch (  Exception e) {
    throw new DiscoveryException("Failed to set datagram packets",e);
  }
  try {
    MulticastSocket multicastSocket;
    if (NetworkUtils.canBindToMcastAddress()) {
      try {
        multicastSocket=new MulticastSocket(new InetSocketAddress(groupAddress,port));
      }
 catch (      Exception e) {
        logger.debug("Failed to create multicast socket by binding to group address, binding to port",e);
        multicastSocket=new MulticastSocket(port);
      }
    }
 else {
      multicastSocket=new MulticastSocket(port);
    }
    multicastSocket.setReuseAddress(true);
    multicastSocket.setTimeToLive(ttl);
    if (address == null) {
      boolean joinedAtLeaseOnInterface=false;
      Exception lastException=null;
      for (      NetworkInterface inf : NetworkUtils.getAllAvailableInterfaces()) {
        try {
          multicastSocket.joinGroup(new InetSocketAddress(groupAddress,port),inf);
          logger.trace("Joined network interface {} for group {} and port {}",inf,groupAddress,port);
          joinedAtLeaseOnInterface=true;
        }
 catch (        Exception e) {
          lastException=e;
          logger.debug("Failed to join on network interface {}",e,inf);
        }
      }
      if (!joinedAtLeaseOnInterface) {
        throw new DiscoveryException("Failed to join any network interface",lastException);
      }
    }
 else {
      InetAddress multicastInterface=networkService.resolvePublishHostAddress(address);
      multicastSocket.setInterface(multicastInterface);
      multicastSocket.joinGroup(groupAddress);
      logger.trace("Joined address {} for group {} and port {}",multicastInterface,groupAddress,port);
    }
    multicastSocket.setReceiveBufferSize(bufferSize);
    multicastSocket.setSendBufferSize(bufferSize);
    multicastSocket.setSoTimeout(60000);
    this.multicastSocket=multicastSocket;
  }
 catch (  Exception e) {
    throw new DiscoveryException("Failed to setup multicast socket",e);
  }
  this.receiver=new Receiver();
  this.receiverThread=daemonThreadFactory(settings,"discovery#multicast#received").newThread(receiver);
  this.receiverThread.start();
}
