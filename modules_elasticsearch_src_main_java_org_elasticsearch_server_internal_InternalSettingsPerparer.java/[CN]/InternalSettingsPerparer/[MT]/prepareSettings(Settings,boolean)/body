{
  ImmutableSettings.Builder settingsBuilder=settingsBuilder().put(pSettings).putProperties("elasticsearch.",System.getProperties()).putProperties("es.",System.getProperties()).replacePropertyPlaceholders();
  Environment environment=new Environment(settingsBuilder.build());
  settingsBuilder=settingsBuilder().put(pSettings);
  settingsBuilder.put("path.home",cleanPath(environment.homeFile().getAbsolutePath()));
  settingsBuilder.put("path.work",cleanPath(environment.workFile().getAbsolutePath()));
  settingsBuilder.put("path.workWithCluster",cleanPath(environment.workWithClusterFile().getAbsolutePath()));
  settingsBuilder.put("path.logs",cleanPath(environment.logsFile().getAbsolutePath()));
  if (loadConfigSettings) {
    try {
      settingsBuilder.loadFromUrl(environment.resolveConfig("elasticsearch.yml"));
    }
 catch (    FailedToResolveConfigException e) {
    }
catch (    NoClassDefFoundError e) {
    }
    try {
      settingsBuilder.loadFromUrl(environment.resolveConfig("elasticsearch.json"));
    }
 catch (    FailedToResolveConfigException e) {
    }
    try {
      settingsBuilder.loadFromUrl(environment.resolveConfig("elasticsearch.properties"));
    }
 catch (    FailedToResolveConfigException e) {
    }
    if (System.getProperty("es.config") != null) {
      settingsBuilder.loadFromUrl(environment.resolveConfig(System.getProperty("es.config")));
    }
    if (System.getProperty("elasticsearch.config") != null) {
      settingsBuilder.loadFromUrl(environment.resolveConfig(System.getProperty("elasticsearch.config")));
    }
  }
  settingsBuilder.put(pSettings).putProperties("elasticsearch.",System.getProperties()).putProperties("es.",System.getProperties()).replacePropertyPlaceholders();
  if (settingsBuilder.get("name") == null) {
    String name=System.getProperty("name");
    if (name == null || name.isEmpty())     name=Names.randomNodeName(environment.resolveConfig("names.txt"));
    if (name != null) {
      settingsBuilder.put("name",name);
    }
  }
  if (settingsBuilder.get(ClusterName.SETTING) == null) {
    settingsBuilder.put(ClusterName.SETTING,ClusterName.DEFAULT.value());
  }
  return new Tuple<Settings,Environment>(settingsBuilder.build(),environment);
}
