{
  final IndexRequest request=shardRequest.request;
  MappingMetaData mappingMd=clusterState.metaData().index(request.index()).mapping(request.type());
  if (mappingMd != null && mappingMd.routing().required()) {
    if (request.routing() == null) {
      throw new RoutingMissingException(request.index(),request.type(),request.id());
    }
  }
  IndexShard indexShard=indexShard(shardRequest);
  SourceToParse sourceToParse=SourceToParse.source(request.source()).type(request.type()).id(request.id()).routing(request.routing()).parent(request.parent());
  ParsedDocument doc;
  long version;
  if (request.opType() == IndexRequest.OpType.INDEX) {
    Engine.Index index=indexShard.prepareIndex(sourceToParse).version(request.version()).origin(Engine.Operation.Origin.PRIMARY);
    index.refresh(request.refresh());
    doc=indexShard.index(index);
    version=index.version();
  }
 else {
    Engine.Create create=indexShard.prepareCreate(sourceToParse).version(request.version()).origin(Engine.Operation.Origin.PRIMARY);
    create.refresh(request.refresh());
    doc=indexShard.create(create);
    version=create.version();
  }
  if (doc.mappersAdded()) {
    updateMappingOnMaster(request);
  }
  request.version(version);
  return new IndexResponse(request.index(),request.type(),request.id(),version);
}
