{
  boolean needToParseExternalTimestamp=request.timestamp() != null;
  MetaData metaData=clusterService.state().metaData();
  request.routing(metaData.resolveIndexRouting(request.routing(),request.index()));
  request.index(metaData.concreteIndex(request.index()));
  if (metaData.hasIndex(request.index())) {
    MappingMetaData mappingMd=metaData.index(request.index()).mapping(request.type());
    if (mappingMd != null) {
      if (needToParseExternalTimestamp) {
        request.parseStringTimestamp(request.timestamp(),mappingMd.tsDateTimeFormatter());
        needToParseExternalTimestamp=false;
      }
      request.processRoutingAndTimestamp(mappingMd);
    }
  }
  if (needToParseExternalTimestamp) {
    request.parseStringTimestamp(request.timestamp(),TimestampFieldMapper.Defaults.DATE_TIME_FORMATTER);
  }
  if (request.timestamp() == null) {
    request.generateTimestamp();
  }
  super.doExecute(request,listener);
}
