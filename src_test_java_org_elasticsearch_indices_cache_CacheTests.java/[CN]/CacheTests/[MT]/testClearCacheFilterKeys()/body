{
  wipeIndices();
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client().prepareIndex("test","type","1").setSource("field","value").execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  NodesStatsResponse nodesStats=client().admin().cluster().prepareNodesStats().setIndices(true).execute().actionGet();
  assertThat(nodesStats.getNodes()[0].getIndices().getFilterCache().getMemorySizeInBytes(),equalTo(0l));
  IndicesStatsResponse indicesStats=client().admin().indices().prepareStats("test").clear().setFilterCache(true).execute().actionGet();
  assertThat(indicesStats.getTotal().getFilterCache().getMemorySizeInBytes(),equalTo(0l));
  SearchResponse searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),FilterBuilders.termFilter("field","value").cacheKey("test_key"))).execute().actionGet();
  assertThat(searchResponse.getHits().getHits().length,equalTo(1));
  nodesStats=client().admin().cluster().prepareNodesStats().setIndices(true).execute().actionGet();
  assertThat(nodesStats.getNodes()[0].getIndices().getFilterCache().getMemorySizeInBytes(),greaterThan(0l));
  indicesStats=client().admin().indices().prepareStats("test").clear().setFilterCache(true).execute().actionGet();
  assertThat(indicesStats.getTotal().getFilterCache().getMemorySizeInBytes(),greaterThan(0l));
  client().admin().indices().prepareClearCache().setFilterKeys("test_key").execute().actionGet();
  nodesStats=client().admin().cluster().prepareNodesStats().setIndices(true).execute().actionGet();
  assertThat(nodesStats.getNodes()[0].getIndices().getFilterCache().getMemorySizeInBytes(),equalTo(0l));
  indicesStats=client().admin().indices().prepareStats("test").clear().setFilterCache(true).execute().actionGet();
  assertThat(indicesStats.getTotal().getFilterCache().getMemorySizeInBytes(),equalTo(0l));
}
