{
  if (request.preferLocalShard()) {
    while (shardsIt.hasNextActive()) {
      final ShardRouting shard=shardsIt.nextActive();
      if (shard.currentNodeId().equals(nodes.localNodeId())) {
        if (request.operationThreaded()) {
          request.beforeLocalFork();
          threadPool.executor(executor()).execute(new Runnable(){
            @Override public void run(){
              try {
                Response response=shardOperation(request,shard.id());
                listener.onResponse(response);
              }
 catch (              Exception e) {
                onFailure(shard,e);
              }
            }
          }
);
          return;
        }
 else {
          try {
            final Response response=shardOperation(request,shard.id());
            listener.onResponse(response);
            return;
          }
 catch (          Exception e) {
            onFailure(shard,e);
          }
        }
      }
    }
  }
 else {
    perform(null);
  }
  if (!shardsIt.hasNextActive()) {
    shardsIt.reset();
    perform(null);
  }
}
