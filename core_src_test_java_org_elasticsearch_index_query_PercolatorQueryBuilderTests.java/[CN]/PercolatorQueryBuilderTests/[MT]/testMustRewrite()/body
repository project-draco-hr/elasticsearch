{
  PercolatorQueryBuilder pqb=doCreateTestQueryBuilder(true);
  try {
    pqb.toQuery(queryShardContext());
    fail("IllegalStateException expected");
  }
 catch (  IllegalStateException e) {
    assertThat(e.getMessage(),equalTo("query builder must be rewritten first"));
  }
  QueryBuilder<?> rewrite=pqb.rewrite(queryShardContext());
  PercolatorQueryBuilder geoShapeQueryBuilder=new PercolatorQueryBuilder(pqb.getDocumentType(),documentSource);
  assertEquals(geoShapeQueryBuilder,rewrite);
}
