{
  Directory dir=newDirectory();
  LRUQueryCache cache=new LRUQueryCache(10000,Long.MAX_VALUE);
  QueryCachingPolicy policy=QueryCachingPolicy.ALWAYS_CACHE;
  RandomIndexWriter writer=new RandomIndexWriter(getRandom(),dir);
  for (int i=0; i < 10; ++i) {
    writer.addDocument(new Document());
  }
  IndexReader reader=writer.getReader();
  IndexSearcher searcher=newSearcher(reader);
  searcher.setQueryCache(cache);
  searcher.setQueryCachingPolicy(policy);
  assertEquals(0,cache.getCacheSize());
  DummyIndexCacheableQuery query=new DummyIndexCacheableQuery();
  searcher.count(query);
  int expectedCacheSize=reader.leaves().size();
  assertEquals(expectedCacheSize,cache.getCacheSize());
  searcher.count(query);
  assertEquals(expectedCacheSize,cache.getCacheSize());
  writer.addDocument(new Document());
  DirectoryReader reader2=writer.getReader();
  searcher=newSearcher(reader2);
  searcher.setQueryCache(cache);
  searcher.setQueryCachingPolicy(policy);
  expectedCacheSize+=reader2.leaves().size();
  searcher.count(query);
  assertEquals(expectedCacheSize,cache.getCacheSize());
  searcher.count(query);
  assertEquals(expectedCacheSize,cache.getCacheSize());
  reader.close();
  reader2.close();
  writer.close();
  assertEquals(0,cache.getCacheSize());
  dir.close();
}
