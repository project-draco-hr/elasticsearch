{
  XContentParser.Token token;
  String topLevelFieldName=null;
  List<SearchContextHighlight.ParsedHighlightField> fields=newArrayList();
  String[] preTags=DEFAULT_PRE_TAGS;
  String[] postTags=DEFAULT_POST_TAGS;
  boolean scoreOrdered=false;
  boolean highlightFilter=true;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      topLevelFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("pre_tags".equals(topLevelFieldName) || "preTags".equals(topLevelFieldName)) {
        List<String> preTagsList=Lists.newArrayList();
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          preTagsList.add(parser.text());
        }
        preTags=preTagsList.toArray(new String[preTagsList.size()]);
      }
 else       if ("post_tags".equals(topLevelFieldName) || "postTags".equals(topLevelFieldName)) {
        List<String> postTagsList=Lists.newArrayList();
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          postTagsList.add(parser.text());
        }
        postTags=postTagsList.toArray(new String[postTagsList.size()]);
      }
    }
 else     if (token.isValue()) {
      if ("order".equals(topLevelFieldName)) {
        scoreOrdered="score".equals(parser.text());
      }
 else       if ("tags_schema".equals(topLevelFieldName) || "tagsSchema".equals(topLevelFieldName)) {
        String schema=parser.text();
        if ("styled".equals(schema)) {
          preTags=STYLED_PRE_TAG;
          postTags=STYLED_POST_TAGS;
        }
      }
 else       if ("highlight_filter".equals(topLevelFieldName) || "highlightFilter".equals(topLevelFieldName)) {
        highlightFilter=parser.booleanValue();
      }
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if ("fields".equals(topLevelFieldName)) {
        String highlightFieldName=null;
        while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
          if (token == XContentParser.Token.FIELD_NAME) {
            highlightFieldName=parser.currentName();
          }
 else           if (token == XContentParser.Token.START_OBJECT) {
            String fieldName=null;
            int fragmentSize=100;
            int numOfFragments=5;
            while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
              if (token == XContentParser.Token.FIELD_NAME) {
                fieldName=parser.currentName();
              }
 else               if (token.isValue()) {
                if ("fragment_size".equals(fieldName) || "fragmentSize".equals(fieldName)) {
                  fragmentSize=parser.intValue();
                }
 else                 if ("number_of_fragments".equals(fieldName) || "numberOfFragments".equals(fieldName)) {
                  numOfFragments=parser.intValue();
                }
              }
            }
            fields.add(new SearchContextHighlight.ParsedHighlightField(highlightFieldName,fragmentSize,numOfFragments));
          }
        }
      }
    }
  }
  if (preTags != null && postTags == null) {
    throw new SearchParseException(context,"Highlighter preTags are set, but postTags are not set");
  }
  context.highlight(new SearchContextHighlight(fields,preTags,postTags,scoreOrdered,highlightFilter));
}
