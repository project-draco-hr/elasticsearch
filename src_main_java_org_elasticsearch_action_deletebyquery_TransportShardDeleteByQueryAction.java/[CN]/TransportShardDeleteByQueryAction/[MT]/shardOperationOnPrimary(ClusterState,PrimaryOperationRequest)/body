{
  ShardDeleteByQueryRequest request=shardRequest.request;
  IndexService indexService=indicesService.indexServiceSafe(shardRequest.request.index());
  IndexShard indexShard=indexService.shardSafe(shardRequest.shardId);
  SearchContext.setCurrent(new DefaultSearchContext(0,new ShardSearchRequest().types(request.types()),null,indexShard.acquireSearcher("delete_by_query"),indexService,indexShard,scriptService,cacheRecycler,pageCacheRecycler));
  try {
    Engine.DeleteByQuery deleteByQuery=indexShard.prepareDeleteByQuery(request.source(),request.filteringAliases(),request.types()).origin(Engine.Operation.Origin.PRIMARY);
    SearchContext.current().parsedQuery(new ParsedQuery(deleteByQuery.query(),ImmutableMap.<String,Filter>of()));
    indexShard.deleteByQuery(deleteByQuery);
  }
  finally {
    SearchContext searchContext=SearchContext.current();
    searchContext.clearAndRelease();
    SearchContext.removeCurrent();
  }
  return new PrimaryResponse<ShardDeleteByQueryResponse,ShardDeleteByQueryRequest>(shardRequest.request,new ShardDeleteByQueryResponse(),null);
}
