{
  ShardDeleteByQueryRequest request=shardRequest.request;
  IndexService indexService=indicesService.indexServiceSafe(shardRequest.shardId.getIndex());
  IndexShard indexShard=indexService.shardSafe(shardRequest.shardId.id());
  SearchContext.setCurrent(new DefaultSearchContext(0,new ShardSearchRequest(shardRequest.request).types(request.types()).nowInMillis(request.nowInMillis()),null,indexShard.acquireSearcher(DELETE_BY_QUERY_API),indexService,indexShard,scriptService,pageCacheRecycler,bigArrays));
  try {
    Engine.DeleteByQuery deleteByQuery=indexShard.prepareDeleteByQuery(request.source(),request.filteringAliases(),Engine.Operation.Origin.PRIMARY,request.types());
    SearchContext.current().parsedQuery(new ParsedQuery(deleteByQuery.query(),ImmutableMap.<String,Filter>of()));
    indexShard.deleteByQuery(deleteByQuery);
  }
  finally {
    try (SearchContext searchContext=SearchContext.current()){
      SearchContext.removeCurrent();
    }
   }
  return new PrimaryResponse<>(shardRequest.request,new ShardDeleteByQueryResponse(),null);
}
