{
  Document doc=new Document();
  doc.add(new StringField("id",id,Field.Store.NO));
  if (typeField) {
    if (legacy) {
      doc.add(new StringField(TypeFieldMapper.NAME,PercolatorFieldMapper.LEGACY_TYPE_NAME,Field.Store.NO));
    }
 else {
      doc.add(new StringField(TypeFieldMapper.NAME,"query",Field.Store.NO));
    }
  }
  if (legacy) {
    BytesReference percolatorQuery=XContentFactory.jsonBuilder().startObject().field("query",queryBuilder).endObject().bytes();
    doc.add(new StoredField(SourceFieldMapper.NAME,percolatorQuery.array(),percolatorQuery.arrayOffset(),percolatorQuery.length()));
  }
 else {
    BytesRef queryBuilderAsBytes=new BytesRef(XContentFactory.contentBuilder(PercolatorQueryCache.QUERY_BUILDER_CONTENT_TYPE).value(queryBuilder).bytes().toBytes());
    doc.add(new BinaryDocValuesField(PercolatorFieldMapper.QUERY_BUILDER_FIELD_NAME,queryBuilderAsBytes));
  }
  indexWriter.addDocument(doc);
}
