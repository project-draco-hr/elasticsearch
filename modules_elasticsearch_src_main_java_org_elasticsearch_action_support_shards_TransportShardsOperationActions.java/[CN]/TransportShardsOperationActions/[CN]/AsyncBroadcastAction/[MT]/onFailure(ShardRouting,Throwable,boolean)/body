{
  int idx=indexCounter.getAndIncrement();
  if (accumulateExceptions()) {
    ShardOperationFailedException failedException;
    if (t instanceof ShardOperationFailedException) {
      failedException=(ShardOperationFailedException)t;
    }
 else {
      failedException=new ShardOperationFailedException(shardRouting.shardId(),t);
    }
    shardsResponses.set(idx,failedException);
  }
  if (opsCounter.incrementAndGet() == shardsResponses.length()) {
    finishHim(alreadyThreaded);
  }
}
