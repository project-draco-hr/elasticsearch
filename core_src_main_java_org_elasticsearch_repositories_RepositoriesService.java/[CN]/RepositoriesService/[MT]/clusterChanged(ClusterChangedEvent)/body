{
  try {
    RepositoriesMetaData oldMetaData=event.previousState().getMetaData().custom(RepositoriesMetaData.TYPE);
    RepositoriesMetaData newMetaData=event.state().getMetaData().custom(RepositoriesMetaData.TYPE);
    if ((oldMetaData == null && newMetaData == null) || (oldMetaData != null && oldMetaData.equals(newMetaData))) {
      return;
    }
    logger.trace("processing new index repositories for state version [{}]",event.state().version());
    Map<String,RepositoryHolder> survivors=newHashMap();
    for (    Map.Entry<String,RepositoryHolder> entry : repositories.entrySet()) {
      if (newMetaData == null || newMetaData.repository(entry.getKey()) == null) {
        logger.debug("unregistering repository [{}]",entry.getKey());
        closeRepository(entry.getKey(),entry.getValue());
      }
 else {
        survivors.put(entry.getKey(),entry.getValue());
      }
    }
    ImmutableMap.Builder<String,RepositoryHolder> builder=ImmutableMap.builder();
    if (newMetaData != null) {
      for (      RepositoryMetaData repositoryMetaData : newMetaData.repositories()) {
        RepositoryHolder holder=survivors.get(repositoryMetaData.name());
        if (holder != null) {
          if (!holder.type.equals(repositoryMetaData.type()) || !holder.settings.equals(repositoryMetaData.settings())) {
            logger.debug("updating repository [{}]",repositoryMetaData.name());
            closeRepository(repositoryMetaData.name(),holder);
            holder=null;
            try {
              holder=createRepositoryHolder(repositoryMetaData);
            }
 catch (            RepositoryException ex) {
              logger.warn("failed to change repository [{}]",ex,repositoryMetaData.name());
            }
          }
        }
 else {
          try {
            holder=createRepositoryHolder(repositoryMetaData);
          }
 catch (          RepositoryException ex) {
            logger.warn("failed to create repository [{}]",ex,repositoryMetaData.name());
          }
        }
        if (holder != null) {
          logger.debug("registering repository [{}]",repositoryMetaData.name());
          builder.put(repositoryMetaData.name(),holder);
        }
      }
    }
    repositories=builder.build();
  }
 catch (  Throwable ex) {
    logger.warn("failure updating cluster state ",ex);
  }
}
