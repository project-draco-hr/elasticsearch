{
  MetaData metaData=currentState.getMetaData();
  BenchmarkMetaData bmd=metaData.custom(BenchmarkMetaData.TYPE);
  MetaData.Builder mdBuilder=MetaData.builder(metaData);
  if (bmd != null && !bmd.entries().isEmpty()) {
    ImmutableList.Builder<BenchmarkMetaData.Entry> builder=new ImmutableList.Builder<BenchmarkMetaData.Entry>();
    for (    BenchmarkMetaData.Entry e : bmd.entries()) {
      if (benchmarkId == null || match(e)) {
        e=process(e);
        instances.add(e);
      }
      if (e != null && (e.state() != BenchmarkMetaData.State.SUCCESS && e.state() != BenchmarkMetaData.State.ABORTED && e.state() != BenchmarkMetaData.State.FAILED)) {
        builder.add(e);
      }
    }
    if (instances.isEmpty()) {
      throw new ElasticsearchException("No Benchmark found for id: [" + benchmarkId + "]");
    }
    bmd=new BenchmarkMetaData(builder.build());
  }
  if (bmd != null) {
    mdBuilder.putCustom(BenchmarkMetaData.TYPE,bmd);
  }
  return ClusterState.builder(currentState).metaData(mdBuilder).build();
}
