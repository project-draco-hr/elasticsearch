{
  String mapping=XContentFactory.jsonBuilder().startObject().startObject("type").startObject("properties").startObject("date_field").field("type","date").field("format","dateOptionalTime").endObject().endObject().endObject().endObject().string();
  Version randomVersion=VersionUtils.randomVersionBetween(getRandom(),Version.V_0_90_0,Version.V_1_6_1);
  createIndex("test",settingsBuilder().put(IndexMetaData.SETTING_VERSION_CREATED,randomVersion).build());
  client().admin().indices().preparePutMapping("test").setType("type").setSource(mapping).get();
  assertDateFormat("epoch_millis||dateOptionalTime");
  client().prepareIndex("test","type","1").setSource(XContentFactory.jsonBuilder().startObject().field("date_field","2015-06-06T00:00:44.000Z").endObject()).get();
  String newMapping=XContentFactory.jsonBuilder().startObject().startObject("type").startObject("properties").startObject("date_field").field("type","date").field("format","strictDateOptionalTime||epoch_millis").endObject().endObject().endObject().endObject().string();
  PutMappingResponse putMappingResponse=client().admin().indices().preparePutMapping("test").setType("type").setSource(newMapping).get();
  assertThat(putMappingResponse.isAcknowledged(),is(true));
  assertDateFormat("strictDateOptionalTime||epoch_millis");
}
