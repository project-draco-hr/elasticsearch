{
  if (fieldName == null) {
    throw new SearchSourceBuilderException("field must be set on geo_distance facet for facet [" + name + "]");
  }
  if (entries.isEmpty()) {
    throw new SearchSourceBuilderException("at least one range must be defined for geo_distance facet [" + name + "]");
  }
  builder.startObject(name);
  builder.startObject(GeoDistanceFacetCollectorParser.NAME);
  if (geohash != null) {
    builder.field(fieldName,geohash);
  }
 else {
    builder.startArray(fieldName).value(lat).value(lon).endArray();
  }
  if (valueFieldName != null) {
    builder.field("value_field",valueFieldName);
  }
  if (valueScript != null) {
    builder.field("value_script",valueScript);
    if (this.params != null) {
      builder.field("params");
      builder.map(this.params);
    }
  }
  builder.startArray("ranges");
  for (  Entry entry : entries) {
    builder.startObject();
    if (!Double.isInfinite(entry.from)) {
      builder.field("from",entry.from);
    }
    if (!Double.isInfinite(entry.to)) {
      builder.field("to",entry.to);
    }
    builder.endObject();
  }
  builder.endArray();
  if (unit != null) {
    builder.field("unit",unit);
  }
  if (geoDistance != null) {
    builder.field("distance_type",geoDistance.name().toLowerCase());
  }
  builder.endObject();
  if (filter != null) {
    builder.field("filter");
    filter.toXContent(builder,params);
  }
  if (global != null) {
    builder.field("global",global);
  }
  builder.endObject();
}
