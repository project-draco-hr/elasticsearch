{
synchronized (dirtyLock(index.uid())) {
    HashedBytesRef versionKey=versionKey(index.uid());
    final long currentVersion;
    VersionValue versionValue=versionMap.get(versionKey);
    if (versionValue == null) {
      currentVersion=loadCurrentVersionFromIndex(index.uid());
    }
 else {
      if (enableGcDeletes && versionValue.delete() && (threadPool.estimatedTimeInMillis() - versionValue.time()) > gcDeletesInMillis) {
        currentVersion=Versions.NOT_FOUND;
      }
 else {
        currentVersion=versionValue.version();
      }
    }
    long updatedVersion;
    if (index.origin() == Operation.Origin.PRIMARY) {
      if (index.versionType() == VersionType.INTERNAL) {
        long expectedVersion=index.version();
        if (expectedVersion != Versions.MATCH_ANY && currentVersion != Versions.NOT_SET) {
          if (currentVersion == Versions.NOT_FOUND) {
            throw new VersionConflictEngineException(shardId,index.type(),index.id(),Versions.NOT_FOUND,expectedVersion);
          }
 else           if (expectedVersion != currentVersion) {
            throw new VersionConflictEngineException(shardId,index.type(),index.id(),currentVersion,expectedVersion);
          }
        }
        updatedVersion=(currentVersion == Versions.NOT_SET || currentVersion == Versions.NOT_FOUND) ? 1 : currentVersion + 1;
      }
 else {
        if (currentVersion >= 0) {
          if (currentVersion >= index.version()) {
            throw new VersionConflictEngineException(shardId,index.type(),index.id(),currentVersion,index.version());
          }
        }
        updatedVersion=index.version();
      }
    }
 else {
      long expectedVersion=index.version();
      if (currentVersion != Versions.NOT_SET) {
        if (!(currentVersion == Versions.NOT_FOUND && index.version() == 1)) {
          if (expectedVersion <= currentVersion) {
            if (index.origin() == Operation.Origin.RECOVERY) {
              return;
            }
 else {
              throw new VersionConflictEngineException(shardId,index.type(),index.id(),currentVersion,expectedVersion);
            }
          }
        }
      }
      updatedVersion=index.version();
    }
    index.version(updatedVersion);
    if (currentVersion == Versions.NOT_FOUND) {
      index.created(true);
      if (index.docs().size() > 1) {
        writer.addDocuments(index.docs(),index.analyzer());
      }
 else {
        writer.addDocument(index.docs().get(0),index.analyzer());
      }
    }
 else {
      if (versionValue != null)       index.created(versionValue.delete());
      if (index.docs().size() > 1) {
        writer.updateDocuments(index.uid(),index.docs(),index.analyzer());
      }
 else {
        writer.updateDocument(index.uid(),index.docs().get(0),index.analyzer());
      }
    }
    Translog.Location translogLocation=translog.add(new Translog.Index(index));
    versionMap.put(versionKey,new VersionValue(updatedVersion,false,threadPool.estimatedTimeInMillis(),translogLocation));
    indexingService.postIndexUnderLock(index);
  }
}
