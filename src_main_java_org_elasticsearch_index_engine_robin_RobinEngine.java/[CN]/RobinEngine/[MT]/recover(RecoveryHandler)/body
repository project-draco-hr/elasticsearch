{
  rwl.writeLock().lock();
  try {
    onGoingRecoveries++;
  }
  finally {
    rwl.writeLock().unlock();
  }
  SnapshotIndexCommit phase1Snapshot;
  try {
    phase1Snapshot=deletionPolicy.snapshot();
  }
 catch (  Throwable e) {
    --onGoingRecoveries;
    throw new RecoveryEngineException(shardId,1,"Snapshot failed",e);
  }
  try {
    recoveryHandler.phase1(phase1Snapshot);
  }
 catch (  Throwable e) {
    --onGoingRecoveries;
    phase1Snapshot.release();
    if (closed) {
      e=new EngineClosedException(shardId,e);
    }
    throw new RecoveryEngineException(shardId,1,"Execution failed",e);
  }
  Translog.Snapshot phase2Snapshot;
  try {
    phase2Snapshot=translog.snapshot();
  }
 catch (  Throwable e) {
    --onGoingRecoveries;
    phase1Snapshot.release();
    if (closed) {
      e=new EngineClosedException(shardId,e);
    }
    throw new RecoveryEngineException(shardId,2,"Snapshot failed",e);
  }
  try {
    recoveryHandler.phase2(phase2Snapshot);
  }
 catch (  Throwable e) {
    --onGoingRecoveries;
    phase1Snapshot.release();
    phase2Snapshot.release();
    if (closed) {
      e=new EngineClosedException(shardId,e);
    }
    throw new RecoveryEngineException(shardId,2,"Execution failed",e);
  }
  rwl.writeLock().lock();
  Translog.Snapshot phase3Snapshot=null;
  try {
    phase3Snapshot=translog.snapshot(phase2Snapshot);
    recoveryHandler.phase3(phase3Snapshot);
  }
 catch (  Throwable e) {
    throw new RecoveryEngineException(shardId,3,"Execution failed",e);
  }
 finally {
    --onGoingRecoveries;
    rwl.writeLock().unlock();
    phase1Snapshot.release();
    phase2Snapshot.release();
    if (phase3Snapshot != null) {
      phase3Snapshot.release();
    }
  }
}
