{
  try {
    if (IndexWriter.isLocked(store.directory())) {
      logger.warn("shard is locked, releasing lock");
      IndexWriter.unlock(store.directory());
    }
    boolean create=!Lucene.indexExists(store.directory());
    IndexWriterConfig config=new IndexWriterConfig(Lucene.VERSION,analysisService.defaultIndexAnalyzer());
    config.setOpenMode(create ? IndexWriterConfig.OpenMode.CREATE : IndexWriterConfig.OpenMode.APPEND);
    config.setIndexDeletionPolicy(deletionPolicy);
    config.setMergeScheduler(mergeScheduler.newMergeScheduler());
    MergePolicy mergePolicy=mergePolicyProvider.newMergePolicy();
    mergePolicy=new IndexUpgraderMergePolicy(mergePolicy);
    config.setMergePolicy(mergePolicy);
    config.setSimilarity(similarityService.similarity());
    config.setRAMBufferSizeMB(indexingBufferSize.mbFrac());
    config.setTermIndexInterval(termIndexInterval);
    config.setReaderTermsIndexDivisor(termIndexDivisor);
    config.setMaxThreadStates(indexConcurrency);
    config.setCodec(codecService.codec(codecName));
    config.setWriteLockTimeout(5000);
    config.setUseCompoundFile(this.compoundOnFlush);
    return new IndexWriter(store.directory(),config);
  }
 catch (  LockObtainFailedException ex) {
    boolean isLocked=IndexWriter.isLocked(store.directory());
    logger.warn("Could not lock IndexWriter isLocked [{}]",ex,isLocked);
    throw ex;
  }
}
