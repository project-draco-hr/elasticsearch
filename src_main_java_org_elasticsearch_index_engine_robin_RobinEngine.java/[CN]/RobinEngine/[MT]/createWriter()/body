{
  IndexWriter indexWriter=null;
  try {
    if (IndexWriter.isLocked(store.directory())) {
      logger.warn("shard is locked, releasing lock");
      IndexWriter.unlock(store.directory());
    }
    boolean create=!IndexReader.indexExists(store.directory());
    IndexWriterConfig config=new IndexWriterConfig(Lucene.VERSION,analysisService.defaultIndexAnalyzer());
    config.setOpenMode(create ? IndexWriterConfig.OpenMode.CREATE : IndexWriterConfig.OpenMode.APPEND);
    config.setIndexDeletionPolicy(deletionPolicy);
    config.setMergeScheduler(mergeScheduler.newMergeScheduler());
    config.setMergePolicy(mergePolicyProvider.newMergePolicy());
    config.setSimilarity(similarityService.defaultIndexSimilarity());
    config.setRAMBufferSizeMB(indexingBufferSize.mbFrac());
    config.setTermIndexInterval(termIndexInterval);
    config.setReaderTermsIndexDivisor(termIndexDivisor);
    config.setMaxThreadStates(indexConcurrency);
    indexWriter=new XIndexWriter(store.directory(),config,logger,bloomCache);
  }
 catch (  IOException e) {
    safeClose(indexWriter);
    throw e;
  }
  return indexWriter;
}
