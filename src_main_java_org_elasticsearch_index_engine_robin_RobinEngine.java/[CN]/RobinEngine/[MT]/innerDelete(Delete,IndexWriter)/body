{
synchronized (dirtyLock(delete.uid())) {
    final long currentVersion;
    HashedBytesRef versionKey=versionKey(delete.uid());
    VersionValue versionValue=versionMap.get(versionKey);
    if (versionValue == null) {
      currentVersion=loadCurrentVersionFromIndex(delete.uid());
    }
 else {
      if (enableGcDeletes && versionValue.delete() && (threadPool.estimatedTimeInMillis() - versionValue.time()) > gcDeletesInMillis) {
        currentVersion=Versions.NOT_FOUND;
      }
 else {
        currentVersion=versionValue.version();
      }
    }
    long updatedVersion;
    if (delete.origin() == Operation.Origin.PRIMARY) {
      if (delete.versionType() == VersionType.INTERNAL) {
        if (delete.version() != Versions.MATCH_ANY && currentVersion != Versions.NOT_SET) {
          if (currentVersion == Versions.NOT_FOUND) {
            throw new VersionConflictEngineException(shardId,delete.type(),delete.id(),Versions.NOT_FOUND,delete.version());
          }
 else           if (delete.version() != currentVersion) {
            throw new VersionConflictEngineException(shardId,delete.type(),delete.id(),currentVersion,delete.version());
          }
        }
        updatedVersion=(currentVersion == Versions.NOT_SET || currentVersion == Versions.NOT_FOUND) ? 1 : currentVersion + 1;
      }
 else {
        if (currentVersion == Versions.NOT_FOUND) {
        }
 else         if (currentVersion >= delete.version()) {
          throw new VersionConflictEngineException(shardId,delete.type(),delete.id(),currentVersion,delete.version());
        }
        updatedVersion=delete.version();
      }
    }
 else {
      if (currentVersion != Versions.NOT_SET) {
        if (currentVersion != Versions.NOT_FOUND) {
          if (delete.version() <= currentVersion) {
            if (delete.origin() == Operation.Origin.RECOVERY) {
              return;
            }
 else {
              throw new VersionConflictEngineException(shardId,delete.type(),delete.id(),currentVersion - 1,delete.version());
            }
          }
        }
      }
      updatedVersion=delete.version();
    }
    if (currentVersion == Versions.NOT_FOUND) {
      delete.version(updatedVersion).notFound(true);
      Translog.Location translogLocation=translog.add(new Translog.Delete(delete));
      versionMap.put(versionKey,new VersionValue(updatedVersion,true,threadPool.estimatedTimeInMillis(),translogLocation));
    }
 else     if (versionValue != null && versionValue.delete()) {
      delete.version(updatedVersion).notFound(true);
      Translog.Location translogLocation=translog.add(new Translog.Delete(delete));
      versionMap.put(versionKey,new VersionValue(updatedVersion,true,threadPool.estimatedTimeInMillis(),translogLocation));
    }
 else {
      delete.version(updatedVersion);
      writer.deleteDocuments(delete.uid());
      Translog.Location translogLocation=translog.add(new Translog.Delete(delete));
      versionMap.put(versionKey,new VersionValue(updatedVersion,true,threadPool.estimatedTimeInMillis(),translogLocation));
    }
    indexingService.postDeleteUnderLock(delete);
  }
}
