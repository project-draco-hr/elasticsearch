{
  XContentParser parser=parseContext.parser();
  Query noMatchQuery=null;
  boolean queryFound=false;
  boolean indicesFound=false;
  boolean currentIndexMatchesIndices=false;
  String queryName=null;
  float boost=AbstractQueryBuilder.DEFAULT_BOOST;
  String currentFieldName=null;
  XContentParser.Token token;
  XContentStructure.InnerQuery innerQuery=null;
  XContentStructure.InnerQuery innerNoMatchQuery=null;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if (parseContext.parseFieldMatcher().match(currentFieldName,QUERY_FIELD)) {
        innerQuery=new XContentStructure.InnerQuery(parseContext,null);
        queryFound=true;
      }
 else       if (parseContext.parseFieldMatcher().match(currentFieldName,NO_MATCH_QUERY)) {
        innerNoMatchQuery=new XContentStructure.InnerQuery(parseContext,null);
      }
 else {
        throw new QueryParsingException(parseContext,"[indices] query does not support [" + currentFieldName + "]");
      }
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("indices".equals(currentFieldName)) {
        if (indicesFound) {
          throw new QueryParsingException(parseContext,"[indices] indices or index already specified");
        }
        indicesFound=true;
        Collection<String> indices=new ArrayList<>();
        while (parser.nextToken() != XContentParser.Token.END_ARRAY) {
          String value=parser.textOrNull();
          if (value == null) {
            throw new QueryParsingException(parseContext,"[indices] no value specified for 'indices' entry");
          }
          indices.add(value);
        }
        currentIndexMatchesIndices=matchesIndices(parseContext.index().name(),indices.toArray(new String[indices.size()]));
      }
 else {
        throw new QueryParsingException(parseContext,"[indices] query does not support [" + currentFieldName + "]");
      }
    }
 else     if (token.isValue()) {
      if ("index".equals(currentFieldName)) {
        if (indicesFound) {
          throw new QueryParsingException(parseContext,"[indices] indices or index already specified");
        }
        indicesFound=true;
        currentIndexMatchesIndices=matchesIndices(parseContext.index().name(),parser.text());
      }
 else       if (parseContext.parseFieldMatcher().match(currentFieldName,NO_MATCH_QUERY)) {
        String type=parser.text();
        if ("all".equals(type)) {
          noMatchQuery=Queries.newMatchAllQuery();
        }
 else         if ("none".equals(type)) {
          noMatchQuery=Queries.newMatchNoDocsQuery();
        }
      }
 else       if ("_name".equals(currentFieldName)) {
        queryName=parser.text();
      }
 else       if ("boost".equals(currentFieldName)) {
        boost=parser.floatValue();
      }
 else {
        throw new QueryParsingException(parseContext,"[indices] query does not support [" + currentFieldName + "]");
      }
    }
  }
  if (!queryFound) {
    throw new QueryParsingException(parseContext,"[indices] requires 'query' element");
  }
  if (!indicesFound) {
    throw new QueryParsingException(parseContext,"[indices] requires 'indices' or 'index' element");
  }
  Query chosenQuery;
  if (currentIndexMatchesIndices) {
    chosenQuery=innerQuery.asQuery();
  }
 else {
    if (noMatchQuery != null) {
      chosenQuery=noMatchQuery;
    }
 else {
      if (innerNoMatchQuery == null) {
        chosenQuery=Queries.newMatchAllQuery();
      }
 else {
        chosenQuery=innerNoMatchQuery.asQuery();
      }
    }
  }
  if (queryName != null) {
    parseContext.addNamedQuery(queryName,chosenQuery);
  }
  chosenQuery.setBoost(boost);
  return chosenQuery;
}
