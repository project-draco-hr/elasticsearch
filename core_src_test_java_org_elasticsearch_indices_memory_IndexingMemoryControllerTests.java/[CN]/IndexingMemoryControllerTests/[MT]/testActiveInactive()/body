{
  MockController controller=new MockController(Settings.builder().put(IndexingMemoryController.INDEX_BUFFER_SIZE_SETTING,"5mb").build());
  final ShardId shard1=new ShardId("test",1);
  controller.simulateIndexing(shard1);
  final ShardId shard2=new ShardId("test",2);
  controller.simulateIndexing(shard2);
  controller.assertBuffer(shard1,new ByteSizeValue(1,ByteSizeUnit.MB));
  controller.assertBuffer(shard2,new ByteSizeValue(1,ByteSizeUnit.MB));
  controller.simulateIndexing(shard1);
  controller.simulateIndexing(shard2);
  controller.assertBuffer(shard1,new ByteSizeValue(2,ByteSizeUnit.MB));
  controller.assertBuffer(shard2,new ByteSizeValue(2,ByteSizeUnit.MB));
  controller.simulateIndexing(shard1);
  controller.simulateIndexing(shard1);
  controller.assertBuffer(shard1,new ByteSizeValue(0,ByteSizeUnit.MB));
  controller.assertBuffer(shard2,new ByteSizeValue(2,ByteSizeUnit.MB));
  controller.simulateIndexing(shard2);
  controller.simulateIndexing(shard2);
  controller.assertBuffer(shard2,new ByteSizeValue(4,ByteSizeUnit.MB));
  controller.simulateIndexing(shard2);
  controller.simulateIndexing(shard2);
  controller.assertBuffer(shard2,new ByteSizeValue(0,ByteSizeUnit.MB));
}
