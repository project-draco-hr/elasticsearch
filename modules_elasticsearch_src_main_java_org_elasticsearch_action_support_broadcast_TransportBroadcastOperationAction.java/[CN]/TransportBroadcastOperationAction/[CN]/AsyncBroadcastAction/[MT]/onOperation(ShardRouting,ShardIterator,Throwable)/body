{
  if (!hasNextShard(shardIt)) {
    if (logger.isDebugEnabled()) {
      if (t != null) {
        if (shard != null) {
          logger.debug(shard.shortSummary() + ": Failed to execute [" + request+ "]",t);
        }
 else {
          logger.debug(shardIt.shardId() + ": Failed to execute [" + request+ "]",t);
        }
      }
    }
    int index=indexCounter.getAndIncrement();
    if (accumulateExceptions()) {
      if (t == null) {
        if (!ignoreNonActiveExceptions()) {
          t=new BroadcastShardOperationFailedException(shardIt.shardId(),"No active shard(s)");
        }
      }
 else       if (!(t instanceof BroadcastShardOperationFailedException)) {
        t=new BroadcastShardOperationFailedException(shardIt.shardId(),t);
      }
      shardsResponses.set(index,t);
    }
    if (expectedOps == counterOps.incrementAndGet()) {
      finishHim();
    }
    return;
  }
 else {
    if (logger.isTraceEnabled()) {
      if (t != null) {
        if (shard != null) {
          logger.trace(shard.shortSummary() + ": Failed to execute [" + request+ "]",t);
        }
 else {
          logger.trace(shardIt.shardId() + ": Failed to execute [" + request+ "]",t);
        }
      }
    }
  }
  performOperation(shardIt,true);
}
