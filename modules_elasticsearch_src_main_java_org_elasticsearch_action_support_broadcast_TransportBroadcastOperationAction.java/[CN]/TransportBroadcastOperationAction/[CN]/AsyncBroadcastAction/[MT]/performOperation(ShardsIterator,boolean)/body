{
  final ShardRouting shard=nextShardOrNull(shardIt);
  if (shard == null) {
    onOperation(shard,shardIt,null,false);
  }
 else {
    final ShardRequest shardRequest=newShardRequest(shard,request);
    if (shard.currentNodeId().equals(nodes.localNodeId())) {
      if (localAsync) {
        threadPool.execute(new Runnable(){
          @Override public void run(){
            try {
              onOperation(shard,shardOperation(shardRequest),true);
            }
 catch (            Exception e) {
              onOperation(shard,shardIt,e,true);
            }
          }
        }
);
      }
 else {
        try {
          onOperation(shard,shardOperation(shardRequest),false);
        }
 catch (        Exception e) {
          onOperation(shard,shardIt,e,false);
        }
      }
    }
 else {
      DiscoveryNode node=nodes.get(shard.currentNodeId());
      if (node == null) {
        onOperation(shard,shardIt,null,false);
      }
 else {
        transportService.sendRequest(node,transportShardAction(),shardRequest,new BaseTransportResponseHandler<ShardResponse>(){
          @Override public ShardResponse newInstance(){
            return newShardResponse();
          }
          @Override public void handleResponse(          ShardResponse response){
            onOperation(shard,response,false);
          }
          @Override public void handleException(          TransportException e){
            onOperation(shard,shardIt,e,false);
          }
          @Override public boolean spawn(){
            return false;
          }
        }
);
      }
    }
  }
}
