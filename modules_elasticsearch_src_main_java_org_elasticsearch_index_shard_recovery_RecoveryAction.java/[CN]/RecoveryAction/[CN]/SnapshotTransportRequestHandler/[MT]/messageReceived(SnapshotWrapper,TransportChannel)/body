{
  receiveSnapshotRecoveryThread=Thread.currentThread();
  try {
    if (closed) {
      throw new IndexShardClosedException(shardId);
    }
    if (!snapshot.phase3) {
      cleanOpenIndex();
    }
    indexShard.performRecovery(snapshot.snapshot,snapshot.phase3);
    if (snapshot.phase3) {
      indexShard.refresh(new Engine.Refresh(true));
    }
    channel.sendResponse(VoidStreamable.INSTANCE);
  }
  finally {
    receiveSnapshotRecoveryThread=null;
  }
}
