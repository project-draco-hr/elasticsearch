{
  IndexMetaData indexMd=allocation.routingNodes().metaData().index(shardRouting.index());
  int totalShardsPerNode=indexMd.settings().getAsInt(INDEX_TOTAL_SHARDS_PER_NODE,-1);
  if (totalShardsPerNode <= 0) {
    return true;
  }
  int nodeCount=0;
  List<MutableShardRouting> shards=node.shards();
  for (int i=0; i < shards.size(); i++) {
    MutableShardRouting nodeShard=shards.get(i);
    if (!nodeShard.index().equals(shardRouting.index())) {
      continue;
    }
    if (nodeShard.relocating()) {
      continue;
    }
    nodeCount++;
  }
  if (nodeCount > totalShardsPerNode) {
    return false;
  }
  return true;
}
