{
  sortedShardList=searchPhaseController.sortDocs(!useSlowScroll,queryResults);
  AtomicArray<IntArrayList> docIdsToLoad=new AtomicArray<>(queryResults.length());
  searchPhaseController.fillDocIdsToLoad(docIdsToLoad,sortedShardList);
  if (docIdsToLoad.asList().isEmpty()) {
    finishHim();
    return;
  }
  final ScoreDoc[] lastEmittedDocPerShard;
  if (useSlowScroll) {
    lastEmittedDocPerShard=new ScoreDoc[queryResults.length()];
  }
 else {
    lastEmittedDocPerShard=searchPhaseController.getLastEmittedDocPerShard(sortedShardList,queryResults.length());
  }
  final AtomicInteger counter=new AtomicInteger(docIdsToLoad.asList().size());
  for (  final AtomicArray.Entry<IntArrayList> entry : docIdsToLoad.asList()) {
    IntArrayList docIds=entry.value;
    final QuerySearchResult querySearchResult=queryResults.get(entry.index);
    ScoreDoc lastEmittedDoc=lastEmittedDocPerShard[entry.index];
    ShardFetchRequest shardFetchRequest=new ShardFetchRequest(request,querySearchResult.id(),docIds,lastEmittedDoc);
    DiscoveryNode node=nodes.get(querySearchResult.shardTarget().nodeId());
    searchService.sendExecuteFetchScroll(node,shardFetchRequest,new SearchServiceListener<FetchSearchResult>(){
      @Override public void onResult(      FetchSearchResult result){
        result.shardTarget(querySearchResult.shardTarget());
        fetchResults.set(entry.index,result);
        if (counter.decrementAndGet() == 0) {
          finishHim();
        }
      }
      @Override public void onFailure(      Throwable t){
        if (logger.isDebugEnabled()) {
          logger.debug("Failed to execute fetch phase",t);
        }
        successfulOps.decrementAndGet();
        if (counter.decrementAndGet() == 0) {
          finishHim();
        }
      }
    }
);
  }
}
