{
  ThreadPool threadPool=new ThreadPool("test");
  IndicesWarmer warmer=new IndicesWarmer(settings,threadPool);
  IndicesQueryCache indicesQueryCache=new IndicesQueryCache(settings);
  CircuitBreakerService circuitBreakerService=new NoneCircuitBreakerService();
  PageCacheRecycler recycler=new PageCacheRecycler(settings,threadPool);
  BigArrays bigArrays=new BigArrays(recycler,circuitBreakerService);
  IndicesFieldDataCache indicesFieldDataCache=new IndicesFieldDataCache(settings,new IndicesFieldDataCacheListener(circuitBreakerService),threadPool);
  Set<ScriptEngineService> scriptEngines=new HashSet<>();
  scriptEngines.add(new MustacheScriptEngineService(settings));
  scriptEngines.addAll(Arrays.asList(scriptEngineServices));
  ScriptService scriptService=new ScriptService(settings,environment,scriptEngines,new ResourceWatcherService(settings,threadPool),new ScriptContextRegistry(Collections.EMPTY_LIST));
  IndicesQueriesRegistry indicesQueriesRegistry=new IndicesQueriesRegistry(settings,Collections.EMPTY_SET,new NamedWriteableRegistry());
  return new NodeServicesProvider(threadPool,indicesQueryCache,null,warmer,bigArrays,null,client,scriptService,indicesQueriesRegistry,indicesFieldDataCache,circuitBreakerService);
}
