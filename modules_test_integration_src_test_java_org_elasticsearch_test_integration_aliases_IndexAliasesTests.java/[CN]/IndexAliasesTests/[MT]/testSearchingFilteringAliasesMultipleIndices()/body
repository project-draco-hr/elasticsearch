{
  client1.admin().indices().prepareDelete().execute().actionGet();
  logger.info("--> creating indices");
  client1.admin().indices().create(createIndexRequest("test1")).actionGet();
  client1.admin().indices().create(createIndexRequest("test2")).actionGet();
  client1.admin().indices().create(createIndexRequest("test3")).actionGet();
  logger.info("--> running cluster_health");
  ClusterHealthResponse clusterHealth=client1.admin().cluster().health(clusterHealthRequest().waitForGreenStatus()).actionGet();
  logger.info("--> done cluster_health, status " + clusterHealth.status());
  assertThat(clusterHealth.timedOut(),equalTo(false));
  assertThat(clusterHealth.status(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("--> adding aliases to indices");
  client1.admin().indices().prepareAliases().addAlias("test1","alias12").execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test2","alias12").execute().actionGet();
  logger.info("--> adding filtering aliases to indices");
  client1.admin().indices().prepareAliases().addAlias("test1","filter1",termFilter("name","test1")).execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test2","filter23",termFilter("name","foo")).execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test3","filter23",termFilter("name","foo")).execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test1","filter13",termFilter("name","baz")).execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test3","filter13",termFilter("name","baz")).execute().actionGet();
  logger.info("--> indexing against [test1]");
  client1.index(indexRequest("test1").type("type1").id("11").source(source("11","foo test1")).refresh(true)).actionGet();
  client1.index(indexRequest("test1").type("type1").id("12").source(source("12","bar test1")).refresh(true)).actionGet();
  client1.index(indexRequest("test1").type("type1").id("13").source(source("13","baz test1")).refresh(true)).actionGet();
  client1.index(indexRequest("test2").type("type1").id("21").source(source("21","foo test2")).refresh(true)).actionGet();
  client1.index(indexRequest("test2").type("type1").id("22").source(source("22","bar test2")).refresh(true)).actionGet();
  client1.index(indexRequest("test2").type("type1").id("23").source(source("23","baz test2")).refresh(true)).actionGet();
  client1.index(indexRequest("test3").type("type1").id("31").source(source("31","foo test3")).refresh(true)).actionGet();
  client1.index(indexRequest("test3").type("type1").id("32").source(source("32","bar test3")).refresh(true)).actionGet();
  client1.index(indexRequest("test3").type("type1").id("33").source(source("33","baz test3")).refresh(true)).actionGet();
  logger.info("--> checking filtering alias for multiple indices");
  SearchResponse searchResponse=client1.prepareSearch("filter23","filter13").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.hits(),"21","31","13","33");
  assertThat(client1.prepareCount("filter23","filter13").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().count(),equalTo(4L));
  searchResponse=client1.prepareSearch("filter23","filter1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.hits(),"21","31","11","12","13");
  assertThat(client1.prepareCount("filter23","filter1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().count(),equalTo(5L));
  searchResponse=client1.prepareSearch("filter13","filter1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.hits(),"11","12","13","33");
  assertThat(client1.prepareCount("filter13","filter1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().count(),equalTo(4L));
  searchResponse=client1.prepareSearch("filter13","filter1","filter23").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.hits(),"11","12","13","21","31","33");
  assertThat(client1.prepareCount("filter13","filter1","filter23").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().count(),equalTo(6L));
  searchResponse=client1.prepareSearch("filter23","filter13","test2").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.hits(),"21","22","23","31","13","33");
  assertThat(client1.prepareCount("filter23","filter13","test2").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().count(),equalTo(6L));
  searchResponse=client1.prepareSearch("filter23","filter13","test1","test2").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.hits(),"11","12","13","21","22","23","31","33");
  assertThat(client1.prepareCount("filter23","filter13","test1","test2").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().count(),equalTo(8L));
}
