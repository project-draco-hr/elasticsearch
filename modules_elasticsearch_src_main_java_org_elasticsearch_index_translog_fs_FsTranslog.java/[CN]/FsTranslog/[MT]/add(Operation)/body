{
  try {
    BytesStreamOutput out=CachedStreamOutput.cachedBytes();
    out.writeInt(0);
    TranslogStreams.writeTranslogOperation(out,operation);
    out.flush();
    int size=out.size();
    out.seek(0);
    out.writeInt(size - 4);
    long position=lastPosition.getAndAdd(size);
    raf.channel().write(ByteBuffer.wrap(out.unsafeByteArray(),0,size),position);
    if (syncOnEachOperation) {
      raf.channel().force(false);
    }
synchronized (mutex) {
      lastWrittenPosition.getAndAdd(size);
      operationCounter.incrementAndGet();
    }
  }
 catch (  Exception e) {
    throw new TranslogException(shardId,"Failed to write operation [" + operation + "]",e);
  }
}
