{
  rwl.writeLock().lock();
  try {
    FsTranslogFile newFile;
    long size=Long.MAX_VALUE;
    File location=null;
    for (    File file : locations) {
      long currentFree=file.getFreeSpace();
      if (currentFree < size) {
        size=currentFree;
        location=file;
      }
 else       if (currentFree == size && ThreadLocalRandom.current().nextBoolean()) {
        location=file;
      }
    }
    try {
      newFile=new FsTranslogFile(shardId,id,new RafReference(new File(location,"translog-" + id)));
    }
 catch (    IOException e) {
      throw new TranslogException(shardId,"failed to create new translog file",e);
    }
    FsTranslogFile old=current;
    current=newFile;
    if (old != null) {
      boolean delete=true;
      if (old.id() == id) {
        delete=false;
      }
      old.close(delete);
    }
  }
  finally {
    rwl.writeLock().unlock();
  }
}
