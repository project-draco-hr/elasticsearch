{
synchronized (mutex) {
    if (currentId() != snapshot.translogId()) {
      return snapshot();
    }
    try {
      raf.increaseRefCount();
      if (useStream) {
        FsStreamSnapshot newSnapshot=new FsStreamSnapshot(shardId,id,raf,lastPosition);
        newSnapshot.seekForward(snapshot.position());
        return newSnapshot;
      }
 else {
        FsChannelSnapshot newSnapshot=new FsChannelSnapshot(shardId,id,raf,lastPosition);
        newSnapshot.seekForward(snapshot.position());
        return newSnapshot;
      }
    }
 catch (    IOException e) {
      throw new TranslogException(shardId,"Failed to snapshot",e);
    }
  }
}
