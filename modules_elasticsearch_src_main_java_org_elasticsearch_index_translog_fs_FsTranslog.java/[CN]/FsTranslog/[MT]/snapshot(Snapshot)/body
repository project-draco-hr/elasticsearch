{
synchronized (mutex) {
    if (currentId() != snapshot.translogId()) {
      return snapshot();
    }
    try {
      raf.increaseRefCount();
      raf.channel().force(true);
      if (useStream) {
        FsStreamSnapshot newSnapshot=new FsStreamSnapshot(shardId,id,raf,lastWrittenPosition.get(),operationCounter.get(),operationCounter.get() - snapshot.totalOperations());
        newSnapshot.seekForward(snapshot.position());
        return newSnapshot;
      }
 else {
        FsChannelSnapshot newSnapshot=new FsChannelSnapshot(shardId,id,raf,lastWrittenPosition.get(),operationCounter.get(),operationCounter.get() - snapshot.totalOperations());
        newSnapshot.seekForward(snapshot.position());
        return newSnapshot;
      }
    }
 catch (    Exception e) {
      throw new TranslogException(shardId,"Failed to snapshot",e);
    }
  }
}
