{
  HandlesStreamOutput stream=CachedStreamOutput.cachedHandles();
  stream.writeBytes(LENGTH_PLACEHOLDER);
  stream.writeLong(requestId);
  byte status=0;
  status=setResponse(status);
  stream.writeByte(status);
  message.writeTo(stream);
  stream.flush();
  byte[] data=((BytesStreamOutput)stream.wrappedOut()).copiedByteArray();
  ChannelBuffer buffer=ChannelBuffers.wrappedBuffer(data);
  buffer.setInt(0,buffer.writerIndex() - 4);
  channel.write(buffer);
}
