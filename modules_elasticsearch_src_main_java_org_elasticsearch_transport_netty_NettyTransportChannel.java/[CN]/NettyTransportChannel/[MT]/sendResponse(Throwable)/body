{
  BytesStreamOutput stream;
  try {
    stream=CachedStreamOutput.cachedBytes();
    writeResponseExceptionHeader(stream);
    RemoteTransportException tx=new RemoteTransportException(transport.nodeName(),transport.wrapAddress(channel.getLocalAddress()),action,error);
    ThrowableObjectOutputStream too=new ThrowableObjectOutputStream(stream);
    too.writeObject(tx);
    too.close();
  }
 catch (  NotSerializableException e) {
    stream=CachedStreamOutput.cachedBytes();
    writeResponseExceptionHeader(stream);
    RemoteTransportException tx=new RemoteTransportException(transport.nodeName(),transport.wrapAddress(channel.getLocalAddress()),action,new NotSerializableTransportException(error));
    ThrowableObjectOutputStream too=new ThrowableObjectOutputStream(stream);
    too.writeObject(tx);
    too.close();
  }
  ChannelBuffer buffer=ChannelBuffers.wrappedBuffer(stream.copiedByteArray());
  buffer.setInt(0,buffer.writerIndex() - 4);
  channel.write(buffer);
}
