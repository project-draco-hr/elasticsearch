{
  assertAcked(prepareCreate("index").setSettings(Settings.builder().put(indexSettings()).put("number_of_replicas",0).build()).get());
  indexRandom(true,client().prepareIndex("index","type","1").setSource("foo","bar"),client().prepareIndex("index","type","2").setSource("foo","baz"));
  ensureGreen();
  IndicesStatsResponse response=client().admin().indices().prepareStats("index").setQueryCache(true).get();
  assertCumulativeQueryCacheStats(response);
  assertEquals(0,response.getTotal().queryCache.getCacheSize());
  SearchResponse r;
  assertSearchResponse(r=client().prepareSearch("index").setQuery(QueryBuilders.constantScoreQuery(QueryBuilders.matchQuery("foo","baz"))).get());
  response=client().admin().indices().prepareStats("index").setQueryCache(true).get();
  assertCumulativeQueryCacheStats(response);
  assertThat(response.getTotal().queryCache.getHitCount(),equalTo(0L));
  assertThat(response.getTotal().queryCache.getEvictions(),equalTo(0L));
  assertThat(response.getTotal().queryCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getCacheSize(),greaterThan(0L));
  assertSearchResponse(client().prepareSearch("index").setQuery(QueryBuilders.constantScoreQuery(QueryBuilders.matchQuery("foo","baz"))).get());
  response=client().admin().indices().prepareStats("index").setQueryCache(true).get();
  assertCumulativeQueryCacheStats(response);
  assertThat(response.getTotal().queryCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getEvictions(),equalTo(0L));
  assertThat(response.getTotal().queryCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getCacheSize(),greaterThan(0L));
  assertTrue(client().prepareDelete("index","type","1").get().isFound());
  assertTrue(client().prepareDelete("index","type","2").get().isFound());
  refresh();
  response=client().admin().indices().prepareStats("index").setQueryCache(true).get();
  assertCumulativeQueryCacheStats(response);
  assertThat(response.getTotal().queryCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getEvictions(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getCacheSize(),equalTo(0L));
  assertThat(response.getTotal().queryCache.getCacheCount(),greaterThan(0L));
  indexRandom(true,client().prepareIndex("index","type","1").setSource("foo","bar"),client().prepareIndex("index","type","2").setSource("foo","baz"));
  assertSearchResponse(client().prepareSearch("index").setQuery(QueryBuilders.constantScoreQuery(QueryBuilders.matchQuery("foo","baz"))).get());
  response=client().admin().indices().prepareStats("index").setQueryCache(true).get();
  assertCumulativeQueryCacheStats(response);
  assertThat(response.getTotal().queryCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getEvictions(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getCacheSize(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getMemorySizeInBytes(),greaterThan(0L));
  assertAllSuccessful(client().admin().indices().prepareClearCache("index").setQueryCache(true).get());
  response=client().admin().indices().prepareStats("index").setQueryCache(true).get();
  assertCumulativeQueryCacheStats(response);
  assertThat(response.getTotal().queryCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getEvictions(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().queryCache.getCacheSize(),equalTo(0L));
  assertThat(response.getTotal().queryCache.getMemorySizeInBytes(),equalTo(0L));
}
