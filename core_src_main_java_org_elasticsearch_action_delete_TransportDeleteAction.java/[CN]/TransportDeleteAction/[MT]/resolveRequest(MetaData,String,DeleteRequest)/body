{
  request.routing(metaData.resolveIndexRouting(request.parent(),request.routing(),request.index()));
  if (metaData.hasIndex(concreteIndex)) {
    MappingMetaData mappingMd=metaData.index(concreteIndex).mappingOrDefault(request.type());
    if (mappingMd != null && mappingMd.routing().required()) {
      if (request.routing() == null) {
        if (request.versionType() != VersionType.INTERNAL) {
          throw new IllegalArgumentException("routing value is required for deleting documents of type [" + request.type() + "] while using version_type ["+ request.versionType()+ "]");
        }
        throw new RoutingMissingException(concreteIndex,request.type(),request.id());
      }
    }
  }
  ShardId shardId=clusterService.operationRouting().shardId(clusterService.state(),concreteIndex,request.id(),request.routing());
  request.setShardId(shardId);
}
