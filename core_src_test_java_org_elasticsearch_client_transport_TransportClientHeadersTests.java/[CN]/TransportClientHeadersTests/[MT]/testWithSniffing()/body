{
  try (TransportClient client=TransportClient.builder().settings(Settings.builder().put("client.transport.sniff",true).put("cluster.name","cluster1").put(NetworkModule.TRANSPORT_TYPE_KEY,"local").put("node.name","transport_client_" + this.getTestName() + "_1").put("client.transport.nodes_sampler_interval","1s").put(HEADER_SETTINGS).put(Environment.PATH_HOME_SETTING.getKey(),createTempDir().toString()).build()).addPlugin(InternalTransportService.TestPlugin.class).build()){
    client.addTransportAddress(address);
    InternalTransportService service=(InternalTransportService)client.injector.getInstance(TransportService.class);
    if (!service.clusterStateLatch.await(5,TimeUnit.SECONDS)) {
      fail("takes way too long to get the cluster state");
    }
    assertThat(client.connectedNodes().size(),is(1));
    assertThat(client.connectedNodes().get(0).getAddress(),is((TransportAddress)address));
  }
 }
