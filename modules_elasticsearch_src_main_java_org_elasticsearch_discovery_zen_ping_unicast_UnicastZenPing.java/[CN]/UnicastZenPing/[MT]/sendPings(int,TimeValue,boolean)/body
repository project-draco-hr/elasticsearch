{
  final UnicastPingRequest pingRequest=new UnicastPingRequest();
  pingRequest.id=id;
  pingRequest.timeout=timeout;
  DiscoveryNodes discoNodes=nodesProvider.nodes();
  pingRequest.pingResponse=new PingResponse(discoNodes.localNode(),discoNodes.masterNode(),clusterName);
  List<DiscoveryNode> nodesToPing=newArrayList(nodes);
  for (  UnicastHostsProvider provider : hostsProviders) {
    nodesToPing.addAll(provider.buildDynamicNodes());
  }
  final CountDownLatch latch=new CountDownLatch(nodesToPing.size());
  for (  final DiscoveryNode node : nodesToPing) {
    boolean disconnectX;
    DiscoveryNode nodeToSendX=discoNodes.findByAddress(node.address());
    if (nodeToSendX != null) {
      disconnectX=false;
    }
 else {
      nodeToSendX=node;
      disconnectX=true;
    }
    final DiscoveryNode nodeToSend=nodeToSendX;
    final boolean disconnect=disconnectX;
    if (!transportService.nodeConnected(nodeToSend)) {
      threadPool.cached().execute(new Runnable(){
        @Override public void run(){
          try {
            transportService.connectToNode(nodeToSend);
            sendPingRequestToNode(id,timeout,pingRequest,latch,node,disconnect,nodeToSend);
          }
 catch (          ConnectTransportException e) {
            logger.trace("[{}] failed to connect to {}",e,id,nodeToSend);
            latch.countDown();
          }
        }
      }
);
    }
 else {
      sendPingRequestToNode(id,timeout,pingRequest,latch,node,disconnectX,nodeToSend);
    }
  }
  if (wait) {
    try {
      latch.await(timeout.millis() * 5,TimeUnit.MILLISECONDS);
    }
 catch (    InterruptedException e) {
    }
  }
}
