{
  final UnicastPingRequest pingRequest=new UnicastPingRequest();
  pingRequest.id=id;
  pingRequest.timeout=timeout;
  DiscoveryNodes discoNodes=nodesProvider.nodes();
  pingRequest.pingResponse=new PingResponse(discoNodes.localNode(),discoNodes.masterNode(),clusterName);
  List<DiscoveryNode> nodesToPing=newArrayList(nodes);
  for (  UnicastHostsProvider provider : hostsProviders) {
    nodesToPing.addAll(provider.buildDynamicNodes());
  }
  Set<DiscoveryNode> nodesToDisconnect=Sets.newHashSet();
  final CountDownLatch latch=new CountDownLatch(nodesToPing.size());
  for (  final DiscoveryNode node : nodesToPing) {
    boolean nodeFoundByAddressX;
    DiscoveryNode nodeToSendX=discoNodes.findByAddress(node.address());
    if (nodeToSendX != null) {
      nodeFoundByAddressX=false;
    }
 else {
      nodeToSendX=node;
      nodeFoundByAddressX=true;
    }
    final DiscoveryNode nodeToSend=nodeToSendX;
    final boolean nodeFoundByAddress=nodeFoundByAddressX;
    if (!transportService.nodeConnected(nodeToSend)) {
      nodesToDisconnect.add(nodeToSend);
      threadPool.executor(ThreadPool.Names.MANAGEMENT).execute(new Runnable(){
        @Override public void run(){
          try {
            if (!nodeFoundByAddress) {
              transportService.connectToNodeLight(nodeToSend);
            }
 else {
              transportService.connectToNode(nodeToSend);
            }
            sendPingRequestToNode(id,timeout,pingRequest,latch,node,nodeToSend);
          }
 catch (          ConnectTransportException e) {
            logger.trace("[{}] failed to connect to {}",e,id,nodeToSend);
            latch.countDown();
          }
        }
      }
);
    }
 else {
      sendPingRequestToNode(id,timeout,pingRequest,latch,node,nodeToSend);
    }
  }
  if (wait) {
    try {
      latch.await(timeout.millis() * 5,TimeUnit.MILLISECONDS);
    }
 catch (    InterruptedException e) {
    }
  }
  return nodesToDisconnect;
}
