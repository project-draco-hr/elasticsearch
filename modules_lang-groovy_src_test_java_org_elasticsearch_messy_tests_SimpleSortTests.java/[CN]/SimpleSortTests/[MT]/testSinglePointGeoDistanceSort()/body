{
  assertAcked(prepareCreate("index").addMapping("type","location","type=geo_point"));
  indexRandom(true,client().prepareIndex("index","type","d1").setSource(jsonBuilder().startObject().startObject("location").field("lat",1).field("lon",1).endObject().endObject()),client().prepareIndex("index","type","d2").setSource(jsonBuilder().startObject().startObject("location").field("lat",1).field("lon",2).endObject().endObject()));
  ensureYellow();
  String hashPoint="s037ms06g7h0";
  GeoDistanceSortBuilder geoDistanceSortBuilder=new GeoDistanceSortBuilder("location");
  geoDistanceSortBuilder.geohashes(hashPoint);
  SearchResponse searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addSort(geoDistanceSortBuilder.sortMode("min").order(SortOrder.ASC).geoDistance(GeoDistance.PLANE).unit(DistanceUnit.KILOMETERS)).execute().actionGet();
  checkCorrectSortOrderForGeoSort(searchResponse);
  geoDistanceSortBuilder=new GeoDistanceSortBuilder("location");
  geoDistanceSortBuilder.points(new GeoPoint(2,2));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addSort(geoDistanceSortBuilder.sortMode("min").order(SortOrder.ASC).geoDistance(GeoDistance.PLANE).unit(DistanceUnit.KILOMETERS)).execute().actionGet();
  checkCorrectSortOrderForGeoSort(searchResponse);
  geoDistanceSortBuilder=new GeoDistanceSortBuilder("location");
  geoDistanceSortBuilder.point(2,2);
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addSort(geoDistanceSortBuilder.sortMode("min").order(SortOrder.ASC).geoDistance(GeoDistance.PLANE).unit(DistanceUnit.KILOMETERS)).execute().actionGet();
  checkCorrectSortOrderForGeoSort(searchResponse);
  searchResponse=client().prepareSearch().setSource(new SearchSourceBuilder().sort(SortBuilders.geoDistanceSort("location").point(2.0,2.0).unit(DistanceUnit.KILOMETERS).geoDistance(GeoDistance.PLANE))).execute().actionGet();
  checkCorrectSortOrderForGeoSort(searchResponse);
  searchResponse=client().prepareSearch().setSource(new SearchSourceBuilder().sort(SortBuilders.geoDistanceSort("location").geohashes("s037ms06g7h0").unit(DistanceUnit.KILOMETERS).geoDistance(GeoDistance.PLANE))).execute().actionGet();
  checkCorrectSortOrderForGeoSort(searchResponse);
  searchResponse=client().prepareSearch().setSource(new SearchSourceBuilder().sort(SortBuilders.geoDistanceSort("location").point(2.0,2.0).unit(DistanceUnit.KILOMETERS).geoDistance(GeoDistance.PLANE))).execute().actionGet();
  checkCorrectSortOrderForGeoSort(searchResponse);
}
