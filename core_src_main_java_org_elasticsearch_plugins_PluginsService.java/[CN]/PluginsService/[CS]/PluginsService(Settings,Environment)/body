{
  super(settings);
  List<Tuple<PluginInfo,Plugin>> tupleBuilder=new ArrayList<>();
  String[] defaultPluginsClasses=settings.getAsArray("plugin.types");
  for (  String pluginClass : defaultPluginsClasses) {
    Plugin plugin=loadPlugin(pluginClass,settings,getClass().getClassLoader());
    PluginInfo pluginInfo=new PluginInfo(plugin.name(),plugin.description(),false,"NA",true,pluginClass,false);
    if (logger.isTraceEnabled()) {
      logger.trace("plugin loaded from settings [{}]",pluginInfo);
    }
    tupleBuilder.add(new Tuple<>(pluginInfo,plugin));
  }
  try {
    List<Bundle> bundles=getPluginBundles(environment);
    tupleBuilder.addAll(loadBundles(bundles));
  }
 catch (  IOException ex) {
    throw new IllegalStateException("Unable to initialize plugins",ex);
  }
  plugins=Collections.unmodifiableList(tupleBuilder);
  info=new PluginsInfo();
  for (  Tuple<PluginInfo,Plugin> tuple : plugins) {
    info.add(tuple.v1());
  }
  Map<String,Plugin> jvmPlugins=new HashMap<>();
  List<String> sitePlugins=new ArrayList<>();
  for (  Tuple<PluginInfo,Plugin> tuple : plugins) {
    PluginInfo info=tuple.v1();
    if (info.isJvm()) {
      jvmPlugins.put(tuple.v2().name(),tuple.v2());
    }
    if (info.isSite()) {
      sitePlugins.add(info.getName());
    }
  }
  String[] mandatoryPlugins=settings.getAsArray("plugin.mandatory",null);
  if (mandatoryPlugins != null) {
    Set<String> missingPlugins=new HashSet<>();
    for (    String mandatoryPlugin : mandatoryPlugins) {
      if (!jvmPlugins.containsKey(mandatoryPlugin) && !sitePlugins.contains(mandatoryPlugin) && !missingPlugins.contains(mandatoryPlugin)) {
        missingPlugins.add(mandatoryPlugin);
      }
    }
    if (!missingPlugins.isEmpty()) {
      throw new ElasticsearchException("Missing mandatory plugins [" + Strings.collectionToDelimitedString(missingPlugins,", ") + "]");
    }
  }
  logger.info("loaded {}, sites {}",jvmPlugins.keySet(),sitePlugins);
  MapBuilder<Plugin,List<OnModuleReference>> onModuleReferences=MapBuilder.newMapBuilder();
  for (  Plugin plugin : jvmPlugins.values()) {
    List<OnModuleReference> list=new ArrayList<>();
    for (    Method method : plugin.getClass().getMethods()) {
      if (!method.getName().equals("onModule")) {
        continue;
      }
      if (method.getParameterTypes().length == 0 || method.getParameterTypes().length > 1) {
        logger.warn("Plugin: {} implementing onModule with no parameters or more than one parameter",plugin.name());
        continue;
      }
      Class moduleClass=method.getParameterTypes()[0];
      if (!Module.class.isAssignableFrom(moduleClass)) {
        logger.warn("Plugin: {} implementing onModule by the type is not of Module type {}",plugin.name(),moduleClass);
        continue;
      }
      list.add(new OnModuleReference(moduleClass,method));
    }
    if (!list.isEmpty()) {
      onModuleReferences.put(plugin,list);
    }
  }
  this.onModuleReferences=onModuleReferences.immutableMap();
}
