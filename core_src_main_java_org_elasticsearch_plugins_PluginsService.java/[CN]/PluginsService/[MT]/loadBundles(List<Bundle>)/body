{
  List<Tuple<PluginInfo,Plugin>> plugins=new ArrayList<>();
  for (  Bundle bundle : bundles) {
    try {
      final List<URL> jars=new ArrayList<>();
      ClassLoader parentLoader=getClass().getClassLoader();
      if (parentLoader instanceof URLClassLoader) {
        for (        URL url : ((URLClassLoader)parentLoader).getURLs()) {
          jars.add(url);
        }
      }
      jars.addAll(bundle.urls);
      JarHell.checkJarHell(jars.toArray(new URL[0]));
    }
 catch (    Exception e) {
      throw new IllegalStateException("failed to load bundle " + bundle.urls + " due to jar hell",e);
    }
    ClassLoader loader=URLClassLoader.newInstance(bundle.urls.toArray(new URL[0]),getClass().getClassLoader());
    for (    PluginInfo pluginInfo : bundle.plugins) {
      final Plugin plugin;
      if (pluginInfo.isJvm()) {
        reloadLuceneSPI(loader);
        plugin=loadPlugin(pluginInfo.getClassname(),settings,loader);
      }
 else {
        plugin=new SitePlugin(pluginInfo.getName(),pluginInfo.getDescription());
      }
      plugins.add(new Tuple<>(pluginInfo,plugin));
    }
  }
  return Collections.unmodifiableList(plugins);
}
