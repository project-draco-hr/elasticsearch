{
  if (currentRequest.numberOfActions() >= bulkSize) {
    int currentOnGoingBulks=onGoingBulks.incrementAndGet();
    if (currentOnGoingBulks > dropThreshold) {
      onGoingBulks.decrementAndGet();
      logger.warn("dropping bulk, [{}] crossed threshold [{}]",onGoingBulks,dropThreshold);
    }
 else {
      try {
        currentRequest.execute(new ActionListener<BulkResponse>(){
          @Override public void onResponse(          BulkResponse bulkResponse){
            onGoingBulks.decrementAndGet();
          }
          @Override public void onFailure(          Throwable e){
            logger.warn("failed to execute bulk");
          }
        }
);
      }
 catch (      Exception e) {
        logger.warn("failed to process bulk",e);
      }
    }
    currentRequest=client.prepareBulk();
  }
}
