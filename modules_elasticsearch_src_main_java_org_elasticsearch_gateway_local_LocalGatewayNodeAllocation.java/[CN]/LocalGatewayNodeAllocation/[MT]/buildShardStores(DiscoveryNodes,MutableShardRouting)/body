{
  ConcurrentMap<DiscoveryNode,TransportNodesListShardStoreMetaData.StoreFilesMetaData> shardStores=cachedStores.get(shard.shardId());
  if (shardStores == null) {
    shardStores=ConcurrentCollections.newConcurrentMap();
    TransportNodesListShardStoreMetaData.NodesStoreFilesMetaData nodesStoreFilesMetaData=listShardStoreMetaData.list(shard.shardId(),false,nodes.dataNodes().keySet(),listTimeout).actionGet();
    if (logger.isDebugEnabled()) {
      if (nodesStoreFilesMetaData.failures().length > 0) {
        StringBuilder sb=new StringBuilder(shard + ": failures when trying to list stores on nodes:");
        for (int i=0; i < nodesStoreFilesMetaData.failures().length; i++) {
          Throwable cause=ExceptionsHelper.unwrapCause(nodesStoreFilesMetaData.failures()[i]);
          if (cause instanceof ConnectTransportException) {
            continue;
          }
          sb.append("\n    -> ").append(nodesStoreFilesMetaData.failures()[i].getDetailedMessage());
        }
        logger.debug(sb.toString());
      }
    }
    for (    TransportNodesListShardStoreMetaData.NodeStoreFilesMetaData nodeStoreFilesMetaData : nodesStoreFilesMetaData) {
      if (nodeStoreFilesMetaData.storeFilesMetaData() != null) {
        shardStores.put(nodeStoreFilesMetaData.node(),nodeStoreFilesMetaData.storeFilesMetaData());
      }
    }
    cachedStores.put(shard.shardId(),shardStores);
  }
 else {
    for (    DiscoveryNode node : shardStores.keySet()) {
      if (!nodes.nodeExists(node.id())) {
        shardStores.remove(node);
      }
    }
    Set<String> fetchedNodes=Sets.newHashSet();
    for (    DiscoveryNode node : nodes.dataNodes().values()) {
      if (!shardStores.containsKey(node)) {
        fetchedNodes.add(node.id());
      }
    }
    if (!fetchedNodes.isEmpty()) {
      TransportNodesListShardStoreMetaData.NodesStoreFilesMetaData nodesStoreFilesMetaData=listShardStoreMetaData.list(shard.shardId(),false,fetchedNodes,listTimeout).actionGet();
      if (logger.isTraceEnabled()) {
        if (nodesStoreFilesMetaData.failures().length > 0) {
          StringBuilder sb=new StringBuilder(shard + ": failures when trying to list stores on nodes:");
          for (int i=0; i < nodesStoreFilesMetaData.failures().length; i++) {
            Throwable cause=ExceptionsHelper.unwrapCause(nodesStoreFilesMetaData.failures()[i]);
            if (cause instanceof ConnectTransportException) {
              continue;
            }
            sb.append("\n    -> ").append(nodesStoreFilesMetaData.failures()[i].getDetailedMessage());
          }
          logger.trace(sb.toString());
        }
      }
      for (      TransportNodesListShardStoreMetaData.NodeStoreFilesMetaData nodeStoreFilesMetaData : nodesStoreFilesMetaData) {
        if (nodeStoreFilesMetaData.storeFilesMetaData() != null) {
          shardStores.put(nodeStoreFilesMetaData.node(),nodeStoreFilesMetaData.storeFilesMetaData());
        }
      }
    }
  }
  return shardStores;
}
