{
  for (  ShardRouting failedShard : failedShards) {
    IndexRoutingTable indexRoutingTable=routingNodes.routingTable().index(failedShard.index());
    if (!routingNodes.blocks().hasIndexBlock(indexRoutingTable.index(),LocalGateway.INDEX_NOT_RECOVERED_BLOCK)) {
      continue;
    }
    Set<String> nodesIds=Sets.newHashSet();
    nodesIds.addAll(nodes.dataNodes().keySet());
    nodesIds.addAll(nodes.masterNodes().keySet());
    TransportNodesListGatewayState.NodesLocalGatewayState nodesState=listGatewayState.list(nodesIds,null).actionGet();
    Tuple<DiscoveryNode,Long> t=null;
    for (    TransportNodesListGatewayState.NodeLocalGatewayState nodeState : nodesState) {
      if (nodeState.node().id().equals(failedShard.currentNodeId())) {
        continue;
      }
      for (      Map.Entry<ShardId,Long> entry : nodeState.state().shards().entrySet()) {
        if (entry.getKey().equals(failedShard.shardId())) {
          if (t == null || entry.getValue() > t.v2().longValue()) {
            t=new Tuple<DiscoveryNode,Long>(nodeState.node(),entry.getValue());
          }
        }
      }
    }
    if (t != null) {
      RoutingNode currentRoutingNode=routingNodes.nodesToShards().get(failedShard.currentNodeId());
      if (currentRoutingNode == null) {
        continue;
      }
      Iterator<MutableShardRouting> shards=currentRoutingNode.iterator();
      while (shards.hasNext()) {
        MutableShardRouting shard=shards.next();
        if (shard.shardId().equals(failedShard.shardId())) {
          shard.deassignNode();
          shards.remove();
          break;
        }
      }
      RoutingNode targetNode=routingNodes.nodesToShards().get(t.v1().id());
      targetNode.add(new MutableShardRouting(failedShard.index(),failedShard.id(),targetNode.nodeId(),failedShard.relocatingNodeId(),failedShard.primary(),INITIALIZING));
    }
  }
}
