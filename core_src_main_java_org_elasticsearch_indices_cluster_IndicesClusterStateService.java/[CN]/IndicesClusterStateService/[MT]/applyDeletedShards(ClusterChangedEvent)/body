{
  RoutingNodes.RoutingNodeIterator routingNode=event.state().getRoutingNodes().routingNodeIter(event.state().nodes().localNodeId());
  if (routingNode == null) {
    return;
  }
  IntHashSet newShardIds=new IntHashSet();
  for (  IndexService indexService : indicesService) {
    String indexName=indexService.index().getName();
    IndexMetaData indexMetaData=event.state().metaData().index(indexName);
    if (indexMetaData == null) {
      continue;
    }
    newShardIds.clear();
    for (    ShardRouting shard : routingNode) {
      if (shard.index().getName().equals(indexName)) {
        newShardIds.add(shard.id());
      }
    }
    for (    Integer existingShardId : indexService.shardIds()) {
      if (!newShardIds.contains(existingShardId)) {
        if (indexMetaData.getState() == IndexMetaData.State.CLOSE) {
          if (logger.isDebugEnabled()) {
            logger.debug("[{}][{}] removing shard (index is closed)",indexName,existingShardId);
          }
          indexService.removeShard(existingShardId,"removing shard (index is closed)");
        }
 else {
          if (logger.isDebugEnabled()) {
            logger.debug("[{}][{}] removing shard (not allocated)",indexName,existingShardId);
          }
          indexService.removeShard(existingShardId,"removing shard (not allocated)");
        }
      }
    }
  }
}
