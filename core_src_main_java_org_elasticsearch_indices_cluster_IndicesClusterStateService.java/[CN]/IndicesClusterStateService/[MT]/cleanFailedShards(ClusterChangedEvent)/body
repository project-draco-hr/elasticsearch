{
  RoutingNode routingNode=event.state().getRoutingNodes().node(event.state().nodes().getLocalNodeId());
  if (routingNode == null) {
    failedShards.clear();
    return;
  }
  for (Iterator<Map.Entry<ShardId,ShardRouting>> iterator=failedShards.entrySet().iterator(); iterator.hasNext(); ) {
    Map.Entry<ShardId,ShardRouting> entry=iterator.next();
    ShardRouting failedShardRouting=entry.getValue();
    ShardRouting matchedShardRouting=routingNode.getByShardId(failedShardRouting.shardId());
    if (matchedShardRouting == null || matchedShardRouting.isSameAllocation(failedShardRouting) == false) {
      iterator.remove();
    }
  }
}
