{
  for (  IndexMetaData indexMetaData : event.state().metaData()) {
    if (!indicesService.hasIndex(indexMetaData.getIndex())) {
      continue;
    }
    boolean requireRefresh=false;
    String index=indexMetaData.getIndex();
    IndexService indexService=indicesService.indexService(index);
    if (indexService == null) {
      return;
    }
    try {
      MapperService mapperService=indexService.mapperService();
      for (      ObjectCursor<MappingMetaData> cursor : indexMetaData.getMappings().values()) {
        MappingMetaData mappingMd=cursor.value;
        String mappingType=mappingMd.type();
        CompressedXContent mappingSource=mappingMd.source();
        requireRefresh|=processMapping(index,mapperService,mappingType,mappingSource);
      }
      if (requireRefresh && sendRefreshMapping) {
        nodeMappingRefreshAction.nodeMappingRefresh(event.state(),new NodeMappingRefreshAction.NodeMappingRefreshRequest(index,indexMetaData.getIndexUUID(),event.state().nodes().localNodeId()));
      }
    }
 catch (    Throwable t) {
      for (      IndexShard indexShard : indexService) {
        ShardRouting shardRouting=indexShard.routingEntry();
        failAndRemoveShard(shardRouting,indexService.indexUUID(),indexService,true,"failed to update mappings",t);
      }
    }
  }
}
