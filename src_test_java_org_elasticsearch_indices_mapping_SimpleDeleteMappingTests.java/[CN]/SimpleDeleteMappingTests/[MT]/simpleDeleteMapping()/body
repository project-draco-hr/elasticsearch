{
  for (int i=0; i < 10; i++) {
    client().prepareIndex("test","type1",Integer.toString(i)).setSource(jsonBuilder().startObject().field("value","test" + i).endObject()).execute().actionGet();
  }
  ensureGreen();
  client().admin().indices().prepareRefresh().execute().actionGet();
  for (int i=0; i < 10; i++) {
    CountResponse countResponse=client().prepareCount().setQuery(matchAllQuery()).execute().actionGet();
    assertThat(countResponse.getCount(),equalTo(10l));
  }
  ClusterState clusterState=client().admin().cluster().prepareState().execute().actionGet().getState();
  for (int i=0; i < 10 && !clusterState.metaData().index("test").mappings().containsKey("type1"); i++, Thread.sleep(100))   ;
  assertThat(clusterState.metaData().index("test").mappings(),hasKey("type1"));
  GetMappingsResponse mappingsResponse=client().admin().indices().prepareGetMappings("test").setTypes("type1").execute().actionGet();
  assertThat(mappingsResponse.getMappings().get("test").get("type1"),notNullValue());
  client().admin().indices().prepareDeleteMapping().setType("type1").execute().actionGet();
  Thread.sleep(500);
  for (int i=0; i < 10; i++) {
    CountResponse countResponse=client().prepareCount().setQuery(matchAllQuery()).execute().actionGet();
    assertThat(countResponse.getCount(),equalTo(0l));
  }
  clusterState=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(clusterState.metaData().index("test").mappings().containsKey("type1"),equalTo(false));
  mappingsResponse=client().admin().indices().prepareGetMappings("test").setTypes("type1").execute().actionGet();
  assertThat(mappingsResponse.getMappings().get("test"),nullValue());
}
