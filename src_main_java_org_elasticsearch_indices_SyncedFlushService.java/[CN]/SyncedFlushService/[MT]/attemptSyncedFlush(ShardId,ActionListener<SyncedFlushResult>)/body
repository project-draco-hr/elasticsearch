{
  try {
    final ClusterState state=clusterService.state();
    final IndexShardRoutingTable shardRoutingTable=getActiveShardRoutings(shardId,state);
    final List<ShardRouting> activeShards=shardRoutingTable.activeShards();
    Map<String,byte[]> commitIds=sendPreSyncRequests(activeShards,state,shardId);
    if (commitIds.isEmpty()) {
      actionListener.onResponse(new SyncedFlushResult(shardId,"all shards failed to commit on pre-sync"));
    }
    int inflight=getInflightOpsCount(shardId,state,shardRoutingTable);
    if (inflight != 1) {
      actionListener.onResponse(new SyncedFlushResult(shardId,"operation counter on primary is non zero [" + inflight + "]"));
    }
    String syncId=Strings.base64UUID();
    sendSyncRequests(syncId,activeShards,state,commitIds,shardId,actionListener);
  }
 catch (  Throwable t) {
    actionListener.onFailure(t);
  }
}
