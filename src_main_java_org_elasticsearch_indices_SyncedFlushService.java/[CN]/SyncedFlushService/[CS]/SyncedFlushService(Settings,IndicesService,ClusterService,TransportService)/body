{
  super(settings);
  this.indicesService=indicesService;
  this.clusterService=clusterService;
  this.transportService=transportService;
  transportService.registerRequestHandler(PRE_SYNCED_FLUSH_ACTION_NAME,PreSyncedFlushRequest.class,ThreadPool.Names.FLUSH,new PreSyncedFlushTransportHandler());
  transportService.registerRequestHandler(SYNCED_FLUSH_ACTION_NAME,SyncedFlushRequest.class,ThreadPool.Names.FLUSH,new SyncedFlushTransportHandler());
  transportService.registerRequestHandler(IN_FLIGHT_OPS_ACTION_NAME,InFlightOpsRequest.class,ThreadPool.Names.SAME,new InFlightOpCountTransportHandler());
  preSyncTimeout=settings.getAsTime(SETTING_PRE_SYNC_TIMEOUT,TimeValue.timeValueMinutes(5));
  syncTimeout=settings.getAsTime(SETTING_SYNC_TIMEOUT,TimeValue.timeValueMinutes(5));
  inflightOpsTimeout=settings.getAsTime(SETTING_IN_FLIGHT_OPS_TIMEOUT,TimeValue.timeValueMinutes(5));
  indicesService.indicesLifecycle().addListener(new IndicesLifecycle.Listener(){
    @Override public void onShardInactive(    final IndexShard indexShard){
      if (indexShard.routingEntry().primary()) {
        attemptSyncedFlush(indexShard.shardId(),new ActionListener<SyncedFlushResult>(){
          @Override public void onResponse(          SyncedFlushResult syncedFlushResult){
            logger.debug("{} sync flush on inactive shard returned successfully for sync_id: {}",syncedFlushResult.getShardId(),syncedFlushResult.syncId());
          }
          @Override public void onFailure(          Throwable e){
            logger.debug("{} sync flush on inactive shard failed",e,indexShard.shardId());
          }
        }
);
      }
    }
  }
);
}
