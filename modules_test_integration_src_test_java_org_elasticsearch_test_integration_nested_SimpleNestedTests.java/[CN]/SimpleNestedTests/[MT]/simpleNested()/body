{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("nested1").field("type","nested").endObject().endObject().endObject().endObject()).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch("test").setQuery(termQuery("_all","n_value1_1")).execute().actionGet();
  assertThat(searchResponse.hits().totalHits(),equalTo(0l));
  searchResponse=client.prepareSearch("test").setQuery(termQuery("nested1.n_field1","n_value1_1")).execute().actionGet();
  assertThat(searchResponse.hits().totalHits(),equalTo(0l));
  client.prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("field1","value1").startArray("nested1").startObject().field("n_field1","n_value1_1").field("n_field2","n_value2_1").endObject().startObject().field("n_field1","n_value1_2").field("n_field2","n_value2_2").endObject().endArray().endObject()).execute().actionGet();
  client.admin().indices().prepareFlush().setRefresh(true).execute().actionGet();
  GetResponse getResponse=client.prepareGet("test","type1","1").execute().actionGet();
  assertThat(getResponse.exists(),equalTo(true));
  IndicesStatusResponse statusResponse=client.admin().indices().prepareStatus().execute().actionGet();
  assertThat(statusResponse.index("test").docs().numDocs(),equalTo(3));
  searchResponse=client.prepareSearch("test").setQuery(termQuery("_all","n_value1_1")).execute().actionGet();
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  searchResponse=client.prepareSearch("test").setQuery(termQuery("nested1.n_field1","n_value1_1")).execute().actionGet();
  assertThat(searchResponse.hits().totalHits(),equalTo(0l));
  searchResponse=client.prepareSearch("test").setQuery(matchAllQuery()).execute().actionGet();
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  searchResponse=client.prepareSearch("test").setQuery(termQuery("nested1.n_field1","n_value1_1")).execute().actionGet();
  assertThat(searchResponse.hits().totalHits(),equalTo(0l));
  searchResponse=client.prepareSearch("test").setQuery(nestedQuery("nested1",termQuery("nested1.n_field1","n_value1_1"))).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.shardFailures()),searchResponse.failedShards(),equalTo(0));
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  client.prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().field("field1","value1").startArray("nested1").startObject().field("n_field1","n_value1_1").field("n_field2","n_value2_2").endObject().startObject().field("n_field1","n_value1_2").field("n_field2","n_value2_1").endObject().endArray().endObject()).execute().actionGet();
  client.admin().indices().prepareFlush().setRefresh(true).execute().actionGet();
  statusResponse=client.admin().indices().prepareStatus().execute().actionGet();
  assertThat(statusResponse.index("test").docs().numDocs(),equalTo(6));
  searchResponse=client.prepareSearch("test").setQuery(nestedQuery("nested1",boolQuery().must(termQuery("nested1.n_field1","n_value1_1")).must(termQuery("nested1.n_field2","n_value2_1")))).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.shardFailures()),searchResponse.failedShards(),equalTo(0));
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  searchResponse=client.prepareSearch("test").setQuery(filteredQuery(matchAllQuery(),nestedFilter("nested1",boolQuery().must(termQuery("nested1.n_field1","n_value1_1")).must(termQuery("nested1.n_field2","n_value2_1"))))).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.shardFailures()),searchResponse.failedShards(),equalTo(0));
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  searchResponse=client.prepareSearch("test").setQuery(nestedQuery("type1.nested1",boolQuery().must(termQuery("nested1.n_field1","n_value1_1")).must(termQuery("nested1.n_field2","n_value2_1")))).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.shardFailures()),searchResponse.failedShards(),equalTo(0));
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  DeleteResponse deleteResponse=client.prepareDelete("test","type1","2").execute().actionGet();
  assertThat(deleteResponse.notFound(),equalTo(false));
  client.admin().indices().prepareFlush().setRefresh(true).execute().actionGet();
  statusResponse=client.admin().indices().prepareStatus().execute().actionGet();
  assertThat(statusResponse.index("test").docs().numDocs(),equalTo(3));
  searchResponse=client.prepareSearch("test").setQuery(nestedQuery("nested1",termQuery("nested1.n_field1","n_value1_1"))).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.shardFailures()),searchResponse.failedShards(),equalTo(0));
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
}
