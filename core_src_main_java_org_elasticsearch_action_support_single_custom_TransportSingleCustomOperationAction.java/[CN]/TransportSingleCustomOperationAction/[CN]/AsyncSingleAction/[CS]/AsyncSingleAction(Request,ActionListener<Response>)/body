{
  this.listener=listener;
  ClusterState clusterState=clusterService.state();
  nodes=clusterState.nodes();
  ClusterBlockException blockException=checkGlobalBlock(clusterState);
  if (blockException != null) {
    throw blockException;
  }
  String concreteSingleIndex;
  if (resolveIndex(request)) {
    concreteSingleIndex=indexNameExpressionResolver.concreteSingleIndex(clusterState,request);
  }
 else {
    concreteSingleIndex=request.index();
  }
  this.internalRequest=new InternalRequest(request,concreteSingleIndex);
  blockException=checkRequestBlock(clusterState,internalRequest);
  if (blockException != null) {
    throw blockException;
  }
  this.shardsIt=shards(clusterState,internalRequest);
}
