{
  TermsParametersParser aggParser=new TermsParametersParser();
  ValuesSourceParser vsParser=ValuesSourceParser.any(aggregationName,StringTerms.TYPE,context).scriptable(true).formattable(true).build();
  IncludeExclude.Parser incExcParser=new IncludeExclude.Parser(aggregationName,StringTerms.TYPE,context);
  aggParser.parse(aggregationName,parser,context,vsParser,incExcParser);
  List<OrderElement> orderElements=aggParser.getOrderElements();
  List<Terms.Order> orders=new ArrayList<>(orderElements.size());
  for (  OrderElement orderElement : orderElements) {
    orders.add(resolveOrder(orderElement.key(),orderElement.asc()));
  }
  Terms.Order order;
  if (orders.size() == 1 && (orders.get(0) == InternalOrder.TERM_ASC || orders.get(0) == InternalOrder.TERM_DESC)) {
    order=orders.get(0);
  }
 else {
    order=Order.compound(orders);
  }
  TermsAggregator.BucketCountThresholds bucketCountThresholds=aggParser.getBucketCountThresholds();
  if (!(order == InternalOrder.TERM_ASC || order == InternalOrder.TERM_DESC) && bucketCountThresholds.getShardSize() == aggParser.getDefaultBucketCountThresholds().getShardSize()) {
    bucketCountThresholds.setShardSize(BucketUtils.suggestShardSideQueueSize(bucketCountThresholds.getRequiredSize(),context.numberOfShards()));
  }
  bucketCountThresholds.ensureValidity();
  return new TermsAggregatorFactory(aggregationName,vsParser.config(),order,bucketCountThresholds,aggParser.getIncludeExclude(),aggParser.getExecutionHint(),aggParser.getCollectionMode(),aggParser.showTermDocCountError());
}
