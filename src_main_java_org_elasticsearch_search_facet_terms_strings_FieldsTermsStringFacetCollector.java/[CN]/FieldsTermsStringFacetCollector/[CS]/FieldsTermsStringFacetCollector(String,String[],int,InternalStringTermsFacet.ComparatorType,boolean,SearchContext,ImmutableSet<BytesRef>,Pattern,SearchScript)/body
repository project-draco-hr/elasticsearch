{
  super(facetName);
  this.size=size;
  this.comparatorType=comparatorType;
  this.numberOfShards=context.numberOfShards();
  this.script=script;
  indexFieldDatas=new IndexFieldData[fieldsNames.length];
  values=new HashedBytesValues[fieldsNames.length];
  aggregators=new StaticAggregatorValueProc[fieldsNames.length];
  TObjectIntHashMap<HashedBytesRef> map=CacheRecycler.popObjectIntMap();
  for (int i=0; i < fieldsNames.length; i++) {
    FieldMapper mapper=context.smartNameFieldMapper(fieldsNames[i]);
    if (mapper == null) {
      throw new FacetPhaseExecutionException(facetName,"failed to find mapping for [" + fieldsNames[i] + "]");
    }
    indexFieldDatas[i]=context.fieldData().getForField(mapper);
    if (excluded.isEmpty() && pattern == null && this.script == null) {
      aggregators[i]=new StaticAggregatorValueProc(map);
    }
 else {
      aggregators[i]=new AggregatorValueProc(map,excluded,pattern,this.script);
    }
  }
}
