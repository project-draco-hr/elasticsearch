{
  if (t instanceof RetryOnReplicaException) {
    logger.trace("Retrying operation on replica, action [{}], request [{}]",t,transportReplicaAction,request);
    final ThreadContext threadContext=threadPool.getThreadContext();
    final ThreadContext.StoredContext context=threadPool.getThreadContext().newStoredContext();
    observer.waitForNextChange(new ClusterStateObserver.Listener(){
      @Override public void onNewClusterState(      ClusterState state){
        context.close();
        String extraMessage="action [" + transportReplicaAction + "], request["+ request+ "]";
        TransportChannelResponseHandler<TransportResponse.Empty> handler=TransportChannelResponseHandler.emptyResponseHandler(logger,channel,extraMessage);
        transportService.sendRequest(clusterService.localNode(),transportReplicaAction,request,handler);
      }
      @Override public void onClusterServiceClose(){
        responseWithFailure(new NodeClosedException(clusterService.localNode()));
      }
      @Override public void onTimeout(      TimeValue timeout){
        throw new AssertionError("Cannot happen: there is not timeout");
      }
    }
);
  }
 else {
    try {
      failReplicaIfNeeded(t);
    }
 catch (    Throwable unexpected) {
      logger.error("{} unexpected error while failing replica",unexpected,request.shardId().id());
    }
 finally {
      responseWithFailure(t);
    }
  }
}
