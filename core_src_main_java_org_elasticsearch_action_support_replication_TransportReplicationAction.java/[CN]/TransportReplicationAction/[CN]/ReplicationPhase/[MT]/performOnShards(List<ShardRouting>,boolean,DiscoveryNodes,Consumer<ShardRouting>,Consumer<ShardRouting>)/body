{
  int numberOfIgnoredShardInstances=0;
  for (  ShardRouting shard : shards) {
    if (shard.primary() == false && executeOnReplica == false) {
      numberOfIgnoredShardInstances++;
      continue;
    }
    if (shard.unassigned()) {
      numberOfIgnoredShardInstances++;
      continue;
    }
    if (nodes.localNodeId().equals(shard.currentNodeId()) == false) {
      onLocalShard.accept(shard);
    }
    if (shard.relocating() && nodes.localNodeId().equals(shard.relocatingNodeId()) == false) {
      onRelocatingShard.accept(shard);
    }
  }
  return numberOfIgnoredShardInstances;
}
