{
  String nodeId=shard.currentNodeId();
  if (!nodes.nodeExists(nodeId)) {
    logger.trace("failed to send action [{}] on replica [{}] for request [{}] due to unknown node [{}]",transportReplicaAction,shard.shardId(),replicaRequest,nodeId);
    onReplicaFailure(nodeId,null);
    return;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("send action [{}] on replica [{}] for request [{}] to [{}]",transportReplicaAction,shard.shardId(),replicaRequest,nodeId);
  }
  final DiscoveryNode node=nodes.get(nodeId);
  transportService.sendRequest(node,transportReplicaAction,replicaRequest,transportOptions,new EmptyTransportResponseHandler(ThreadPool.Names.SAME){
    @Override public void handleResponse(    TransportResponse.Empty vResponse){
      onReplicaSuccess();
    }
    @Override public void handleException(    TransportException exp){
      logger.trace("[{}] transport failure during replica request [{}], action [{}]",exp,node,replicaRequest,transportReplicaAction);
      if (ignoreReplicaException(exp)) {
        onReplicaFailure(nodeId,exp);
      }
 else {
        String message=String.format(Locale.ROOT,"failed to perform %s on replica on node %s",transportReplicaAction,node);
        logger.warn("[{}] {}",exp,shardId,message);
        shardStateAction.shardFailed(shard,indexShardReference.routingEntry(),message,exp,new ShardStateAction.Listener(){
          @Override public void onSuccess(){
            onReplicaFailure(nodeId,exp);
          }
          @Override public void onFailure(          Throwable t){
            onReplicaFailure(nodeId,exp);
          }
        }
);
      }
    }
  }
);
}
