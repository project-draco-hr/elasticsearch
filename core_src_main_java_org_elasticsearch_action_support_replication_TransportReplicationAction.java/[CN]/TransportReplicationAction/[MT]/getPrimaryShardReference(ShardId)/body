{
  IndexService indexService=indicesService.indexServiceSafe(shardId.getIndex());
  IndexShard indexShard=indexService.getShard(shardId.id());
  if (indexShard.routingEntry().primary() == false) {
    throw new ReplicationOperation.RetryOnPrimaryException(indexShard.shardId(),"actual shard is not a primary " + indexShard.routingEntry());
  }
  return new PrimaryShardReference(indexShard,indexShard.acquirePrimaryOperationLock());
}
