{
  IndexService indexService=indicesService.indexServiceSafe(shardId.getIndex());
  IndexShard indexShard=indexService.getShard(shardId.id());
  if (indexShard.routingEntry().primary() == false) {
    throw new ReplicationOperation.RetryOnPrimaryException(indexShard.shardId(),"actual shard is not a primary " + indexShard.routingEntry());
  }
  ActionListener<Releasable> onAcquired=new ActionListener<Releasable>(){
    @Override public void onResponse(    Releasable releasable){
      onReferenceAcquired.onResponse(new PrimaryShardReference(indexShard,releasable));
    }
    @Override public void onFailure(    Throwable e){
      onReferenceAcquired.onFailure(e);
    }
  }
;
  indexShard.acquirePrimaryOperationLock(onAcquired,executor);
}
