{
  FormatDateTimeFormatter dateFormatter=this.dateFormatter;
  if (optionalFormat != null) {
    dateFormatter=Joda.forPattern(optionalFormat);
  }
  long millis;
  if (value instanceof java.lang.Long) {
    millis=((java.lang.Long)value).longValue();
  }
 else   if (value instanceof DateTime) {
    millis=((DateTime)value).getMillis();
  }
 else   if (value instanceof BytesRef) {
    millis=dateFormatter.parser().parseMillis(((BytesRef)value).utf8ToString());
  }
 else {
    throw new IllegalArgumentException("value must be either a DateTime or a long: " + value);
  }
  return dateFormatter.printer().print(millis);
}
