{
  client().prepareIndex(PipelineStore.INDEX,PipelineStore.TYPE,"_id").setSource(jsonBuilder().startObject().field("name","my_pipeline").field("description","my_pipeline").startArray("processors").startObject().startObject("simple").field("path","field2").field("expected_value","abc").field("add_field","field3").field("add_field_value","xyz").endObject().endObject().endArray().endObject()).setRefresh(true).get();
  Thread.sleep(5000);
  createIndex("test");
  client().prepareIndex("test","type","1").setSource("field2","abc").putHeader("ingest","_id").get();
  assertBusy(new Runnable(){
    @Override public void run(){
      Map<String,Object> doc=client().prepareGet("test","type","1").get().getSourceAsMap();
      assertThat(doc.get("field3"),equalTo("xyz"));
    }
  }
);
  client().prepareBulk().add(client().prepareIndex("test","type","2").setSource("field2","abc")).putHeader("ingest","_id").get();
  assertBusy(new Runnable(){
    @Override public void run(){
      Map<String,Object> doc=client().prepareGet("test","type","2").get().getSourceAsMap();
      assertThat(doc.get("field3"),equalTo("xyz"));
    }
  }
);
}
