{
  ClusterState clusterState=clusterService.state();
  final String concreteIndex=clusterState.metaData().concreteSingleIndex(request.index(),request.indicesOptions());
  Iterable<MutableShardRouting> routingNode=clusterState.getRoutingNodes().routingNodeIter(clusterService.localNode().getId());
  if (routingNode == null) {
    redirect(request,concreteIndex,listener,clusterState);
    return;
  }
  boolean hasIndexLocally=false;
  for (  MutableShardRouting shardRouting : routingNode) {
    if (concreteIndex.equals(shardRouting.index())) {
      hasIndexLocally=true;
      break;
    }
  }
  if (!hasIndexLocally) {
    redirect(request,concreteIndex,listener,clusterState);
    return;
  }
  Set<String> getFields=newHashSet();
  if (request.fields() != null) {
    Collections.addAll(getFields,request.fields());
  }
  getFields.add(SourceFieldMapper.NAME);
  GetRequest getRequest=new GetRequest(request,request.index()).fields(getFields.toArray(new String[getFields.size()])).type(request.type()).id(request.id()).routing(request.routing()).listenerThreaded(true).operationThreaded(true);
  getAction.execute(getRequest,new ActionListener<GetResponse>(){
    @Override public void onResponse(    GetResponse getResponse){
      if (!getResponse.isExists()) {
        listener.onFailure(new DocumentMissingException(null,request.type(),request.id()));
        return;
      }
      final BoolQueryBuilder boolBuilder=boolQuery();
      try {
        final DocumentMapper docMapper=indicesService.indexServiceSafe(concreteIndex).mapperService().documentMapper(request.type());
        if (docMapper == null) {
          throw new ElasticsearchException("No DocumentMapper found for type [" + request.type() + "]");
        }
        final Set<String> fields=newHashSet();
        if (request.fields() != null) {
          for (          String field : request.fields()) {
            FieldMapper fieldMapper=docMapper.mappers().smartNameFieldMapper(field);
            if (fieldMapper != null) {
              fields.add(fieldMapper.names().indexName());
            }
 else {
              fields.add(field);
            }
          }
        }
        if (!fields.isEmpty()) {
          for (Iterator<String> it=fields.iterator(); it.hasNext(); ) {
            String field=it.next();
            GetField getField=getResponse.getField(field);
            if (getField != null) {
              for (              Object value : getField.getValues()) {
                addMoreLikeThis(request,boolBuilder,getField.getName(),value.toString(),true);
              }
              it.remove();
            }
          }
          if (!fields.isEmpty()) {
            parseSource(getResponse,boolBuilder,docMapper,fields,request);
          }
        }
 else {
          parseSource(getResponse,boolBuilder,docMapper,fields,request);
        }
        if (!boolBuilder.hasClauses()) {
          listener.onFailure(new ElasticsearchException("No fields found to fetch the 'likeText' from"));
          return;
        }
        if (!request.include()) {
          Term uidTerm=docMapper.uidMapper().term(request.type(),request.id());
          boolBuilder.mustNot(termQuery(uidTerm.field(),uidTerm.text()));
          boolBuilder.adjustPureNegative(false);
        }
      }
 catch (      Throwable e) {
        listener.onFailure(e);
        return;
      }
      String[] searchIndices=request.searchIndices();
      if (searchIndices == null) {
        searchIndices=new String[]{request.index()};
      }
      String[] searchTypes=request.searchTypes();
      if (searchTypes == null) {
        searchTypes=new String[]{request.type()};
      }
      SearchRequest searchRequest=new SearchRequest(request).indices(searchIndices).types(searchTypes).searchType(request.searchType()).scroll(request.searchScroll()).listenerThreaded(request.listenerThreaded());
      SearchSourceBuilder extraSource=searchSource().query(boolBuilder);
      if (request.searchFrom() != 0) {
        extraSource.from(request.searchFrom());
      }
      if (request.searchSize() != 0) {
        extraSource.size(request.searchSize());
      }
      searchRequest.extraSource(extraSource);
      if (request.searchSource() != null) {
        searchRequest.source(request.searchSource());
      }
      searchAction.execute(searchRequest,new ActionListener<SearchResponse>(){
        @Override public void onResponse(        SearchResponse response){
          listener.onResponse(response);
        }
        @Override public void onFailure(        Throwable e){
          listener.onFailure(e);
        }
      }
);
    }
    @Override public void onFailure(    Throwable e){
      listener.onFailure(e);
    }
  }
);
}
