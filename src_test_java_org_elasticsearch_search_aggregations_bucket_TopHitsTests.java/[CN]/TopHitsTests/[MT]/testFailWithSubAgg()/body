{
  String source="{\n" + "  \"aggs\": {\n" + "    \"top-tags\": {\n"+ "      \"terms\": {\n"+ "        \"field\": \"tags\"\n"+ "      },\n"+ "      \"aggs\": {\n"+ "        \"top_tags_hits\": {\n"+ "          \"top_hits\": {},\n"+ "          \"aggs\": {\n"+ "            \"max\": {\n"+ "              \"max\": {\n"+ "                \"field\": \"age\"\n"+ "              }\n"+ "            }\n"+ "          }\n"+ "        }\n"+ "      }\n"+ "    }\n"+ "  }\n"+ "}";
  try {
    client().prepareSearch("idx").setTypes("type").setSource(source).get();
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.getMessage(),containsString("Aggregator [top_tags_hits] of type [top_hits] cannot accept sub-aggregations"));
  }
}
