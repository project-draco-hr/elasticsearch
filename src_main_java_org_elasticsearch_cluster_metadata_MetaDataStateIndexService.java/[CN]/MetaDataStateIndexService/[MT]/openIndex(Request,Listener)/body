{
  clusterService.submitStateUpdateTask("open-index [" + request.index + "]",Priority.URGENT,new ProcessedClusterStateUpdateTask(){
    @Override public ClusterState execute(    ClusterState currentState){
      IndexMetaData indexMetaData=currentState.metaData().index(request.index);
      if (indexMetaData == null) {
        listener.onFailure(new IndexMissingException(new Index(request.index)));
        return currentState;
      }
      if (indexMetaData.state() == IndexMetaData.State.OPEN) {
        listener.onResponse(new Response(true));
        return currentState;
      }
      logger.info("[{}] opening index",request.index);
      MetaData.Builder mdBuilder=MetaData.builder().metaData(currentState.metaData()).put(IndexMetaData.newIndexMetaDataBuilder(currentState.metaData().index(request.index)).state(IndexMetaData.State.OPEN));
      ClusterBlocks.Builder blocks=ClusterBlocks.builder().blocks(currentState.blocks()).removeIndexBlock(request.index,INDEX_CLOSED_BLOCK);
      ClusterState updatedState=ClusterState.builder().state(currentState).metaData(mdBuilder).blocks(blocks).build();
      RoutingTable.Builder rtBuilder=RoutingTable.builder().routingTable(updatedState.routingTable()).addAsRecovery(updatedState.metaData().index(request.index));
      RoutingAllocation.Result routingResult=allocationService.reroute(newClusterStateBuilder().state(updatedState).routingTable(rtBuilder).build());
      return ClusterState.builder().state(updatedState).routingResult(routingResult).build();
    }
    @Override public void clusterStateProcessed(    ClusterState clusterState){
      listener.onResponse(new Response(true));
    }
  }
);
}
