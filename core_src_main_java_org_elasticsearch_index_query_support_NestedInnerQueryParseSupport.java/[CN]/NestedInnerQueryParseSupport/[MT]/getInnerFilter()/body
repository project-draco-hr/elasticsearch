{
  if (filterParsed) {
    return innerFilter;
  }
 else {
    if (path == null) {
      throw new QueryShardException(shardContext,"[nested] requires 'path' field");
    }
    if (!filterFound) {
      throw new QueryShardException(shardContext,"[nested] requires either 'query' or 'filter' field");
    }
    setPathLevel();
    XContentParser old=parseContext.parser();
    try {
      XContentParser innerParser=XContentHelper.createParser(source);
      parseContext.parser(innerParser);
      innerFilter=QueryBuilder.rewriteQuery(parseContext.parseInnerQueryBuilder(),this.shardContext).toFilter(this.shardContext);
      filterParsed=true;
      return innerFilter;
    }
  finally {
      resetPathLevel();
      parseContext.parser(old);
    }
  }
}
