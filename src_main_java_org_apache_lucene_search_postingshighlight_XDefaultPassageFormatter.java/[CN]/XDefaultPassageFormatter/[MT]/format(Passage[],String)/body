{
  StringBuilder sb=new StringBuilder();
  int pos=0;
  for (  Passage passage : passages) {
    if (passage.startOffset > pos && pos > 0) {
      sb.append(ellipsis);
    }
    pos=passage.startOffset;
    for (int i=0; i < passage.numMatches; i++) {
      int start=passage.matchStarts[i];
      int end=passage.matchEnds[i];
      if (start > pos) {
        append(sb,content,pos,start);
      }
      if (end > pos) {
        sb.append(preTag);
        append(sb,content,Math.max(pos,start),end);
        sb.append(postTag);
        pos=end;
      }
    }
    append(sb,content,pos,Math.max(pos,passage.endOffset));
    pos=passage.endOffset;
  }
  return sb.toString();
}
