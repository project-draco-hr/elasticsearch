{
  client().admin().indices().prepareCreate("index").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",2).put("index.number_of_replicas",1).build()).execute().actionGet();
  ensureGreen();
  final int numIndexThreads=3;
  final int numberPercolateOperation=100;
  final AtomicBoolean assertionFailure=new AtomicBoolean(false);
  final AtomicInteger indexOperations=new AtomicInteger();
  final AtomicInteger deleteOperations=new AtomicInteger();
  final AtomicBoolean run=new AtomicBoolean(true);
  Thread[] indexThreads=new Thread[numIndexThreads];
  final Semaphore semaphore=new Semaphore(numIndexThreads,true);
  for (int i=0; i < indexThreads.length; i++) {
    Runnable r=new Runnable(){
      @Override public void run(){
        try {
          XContentBuilder doc=XContentFactory.jsonBuilder().startObject().field("query",termQuery("field1","value")).endObject();
          while (run.get()) {
            semaphore.acquire();
            try {
              if ((indexOperations.get() - deleteOperations.get()) > 0 && getRandom().nextInt(100) < 19) {
                String id=Integer.toString(deleteOperations.incrementAndGet());
                DeleteResponse response=client().prepareDelete("index","_percolator",id).execute().actionGet();
                assertThat(response.getId(),equalTo(id));
                assertThat(response.isNotFound(),equalTo(false));
              }
 else {
                String id=Integer.toString(indexOperations.incrementAndGet());
                IndexResponse response=client().prepareIndex("index","_percolator",id).setSource(doc).execute().actionGet();
                assertThat(response.getId(),equalTo(id));
              }
            }
  finally {
              semaphore.release();
            }
          }
        }
 catch (        InterruptedException iex) {
          logger.error("indexing thread was interrupted...",iex);
          run.set(false);
        }
catch (        Throwable t) {
          run.set(false);
          assertionFailure.set(true);
          logger.error("Error in indexing thread...",t);
        }
      }
    }
;
    indexThreads[i]=new Thread(r);
    indexThreads[i].start();
  }
  XContentBuilder percolateDoc=XContentFactory.jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject();
  for (int counter=0; counter < numberPercolateOperation; counter++) {
    Thread.sleep(5);
    semaphore.acquire(numIndexThreads);
    try {
      if (!run.get()) {
        break;
      }
      int atLeastExpected=indexOperations.get() - deleteOperations.get();
      PercolateResponse response=client().preparePercolate("index","type").setSource(percolateDoc).execute().actionGet();
      assertThat(response.getShardFailures(),emptyArray());
      assertThat(response.getSuccessfulShards(),equalTo(response.getTotalShards()));
      assertThat(response.getMatches().length,equalTo(atLeastExpected));
    }
  finally {
      semaphore.release(numIndexThreads);
    }
  }
  run.set(false);
  for (  Thread thread : indexThreads) {
    thread.join();
  }
  assertThat(assertionFailure.get(),equalTo(false));
}
