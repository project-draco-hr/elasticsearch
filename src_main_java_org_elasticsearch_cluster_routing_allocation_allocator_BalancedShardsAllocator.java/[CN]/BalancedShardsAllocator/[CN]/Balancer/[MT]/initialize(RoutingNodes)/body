{
  Collection<MutableShardRouting> shards=new ArrayList<MutableShardRouting>();
  if (logger.isTraceEnabled()) {
    logger.trace("Start distributing Shards");
  }
  for (  IndexRoutingTable index : allocation.routingTable().indicesRouting().values()) {
    indices.add(index.index());
    for (    IndexShardRoutingTable shard : index.getShards().values()) {
      shards.addAll(routing.shardsRoutingFor(index.index(),shard.shardId().id()));
    }
  }
  buildModelFromAssigned(Iterables.filter(shards,assignedFilter));
  return allocateUnassigned(allocation.routingNodes().unassigned(),allocation.routingNodes().ignoredUnassigned());
}
