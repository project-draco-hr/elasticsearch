{
  createIndex("test");
  ensureGreen();
  IndexResponse indexResponse=client().prepareIndex("test","type","1").setSource("field1","value1_1").execute().actionGet();
  assertThat(indexResponse.getVersion(),equalTo(1l));
  indexResponse=client().prepareIndex("test","type","1").setSource("field1","value1_2").setVersion(1).execute().actionGet();
  assertThat(indexResponse.getVersion(),equalTo(2l));
  assertThrows(client().prepareIndex("test","type","1").setSource("field1","value1_1").setVersion(1).execute(),VersionConflictEngineException.class);
  assertThrows(client().prepareIndex("test","type","1").setSource("field1","value1_1").setVersion(1).execute(),VersionConflictEngineException.class);
  assertThrows(client().prepareIndex("test","type","1").setCreate(true).setSource("field1","value1_1").setVersion(1).execute(),VersionConflictEngineException.class);
  assertThrows(client().prepareIndex("test","type","1").setCreate(true).setSource("field1","value1_1").setVersion(1).execute(),VersionConflictEngineException.class);
  assertThrows(client().prepareIndex("test","type","1").setCreate(true).setSource("field1","value1_1").setVersion(2).execute(),DocumentAlreadyExistsException.class);
  assertThrows(client().prepareIndex("test","type","1").setCreate(true).setSource("field1","value1_1").setVersion(2).execute(),DocumentAlreadyExistsException.class);
  assertThrows(client().prepareDelete("test","type","1").setVersion(1).execute(),VersionConflictEngineException.class);
  assertThrows(client().prepareDelete("test","type","1").setVersion(1).execute(),VersionConflictEngineException.class);
  client().admin().indices().prepareRefresh().execute().actionGet();
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareGet("test","type","1").execute().actionGet().getVersion(),equalTo(2l));
  }
  for (int i=0; i < 10; i++) {
    SearchResponse searchResponse=client().prepareSearch().setQuery(matchAllQuery()).setVersion(true).execute().actionGet();
    assertThat(searchResponse.getHits().getAt(0).version(),equalTo(2l));
  }
  for (int i=0; i < 10; i++) {
    SearchResponse searchResponse=client().prepareSearch().setQuery(matchAllQuery()).execute().actionGet();
    assertThat(searchResponse.getHits().getAt(0).version(),equalTo(Versions.NOT_FOUND));
  }
  DeleteResponse deleteResponse=client().prepareDelete("test","type","1").setVersion(2).execute().actionGet();
  assertThat(deleteResponse.isFound(),equalTo(true));
  assertThat(deleteResponse.getVersion(),equalTo(3l));
  assertThrows(client().prepareDelete("test","type","1").setVersion(2).execute(),VersionConflictEngineException.class);
  deleteResponse=client().prepareDelete("test","type","1").setVersion(3).execute().actionGet();
  assertThat(deleteResponse.isFound(),equalTo(false));
  assertThat(deleteResponse.getVersion(),equalTo(4l));
}
