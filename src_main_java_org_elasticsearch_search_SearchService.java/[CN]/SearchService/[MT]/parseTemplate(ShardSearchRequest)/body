{
  if (hasLength(request.templateName())) {
    ExecutableScript executable=this.scriptService.executable("mustache",request.templateName(),request.templateParams());
    BytesReference processedQuery=(BytesReference)executable.run();
    request.source(processedQuery);
  }
 else {
    if (request.templateSource() == null || request.templateSource().length() == 0) {
      return;
    }
    XContentParser parser=null;
    try {
      parser=XContentFactory.xContent(request.templateSource()).createParser(request.templateSource());
      TemplateQueryParser.TemplateContext templateContext=TemplateQueryParser.parse(parser,"template","params");
      if (!hasLength(templateContext.template())) {
        throw new ElasticsearchParseException("Template must have [template] field configured");
      }
      ExecutableScript executable=this.scriptService.executable("mustache",templateContext.template(),templateContext.params());
      BytesReference processedQuery=(BytesReference)executable.run();
      request.source(processedQuery);
    }
 catch (    IOException e) {
      logger.error("Error trying to parse template: ",e);
    }
 finally {
      IOUtils.closeWhileHandlingException(parser);
    }
  }
}
