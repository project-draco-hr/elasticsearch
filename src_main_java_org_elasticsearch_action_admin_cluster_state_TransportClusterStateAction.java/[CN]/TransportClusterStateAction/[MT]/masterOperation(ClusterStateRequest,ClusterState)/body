{
  ClusterState currentState=clusterService.state();
  ClusterState.Builder builder=newClusterStateBuilder();
  if (!request.isFilterNodes()) {
    builder.nodes(currentState.nodes());
  }
  if (!request.isFilterRoutingTable()) {
    builder.routingTable(currentState.routingTable());
    builder.allocationExplanation(currentState.allocationExplanation());
  }
  if (!request.isFilterBlocks()) {
    builder.blocks(currentState.blocks());
  }
  if (!request.isFilterMetaData()) {
    MetaData.Builder mdBuilder=newMetaDataBuilder();
    if (request.getFilteredIndices().length == 0 && request.getFilteredIndexTemplates().length == 0) {
      mdBuilder.metaData(currentState.metaData());
    }
    if (request.getFilteredIndices().length > 0) {
      String[] indices=currentState.metaData().concreteIndicesIgnoreMissing(request.getFilteredIndices());
      for (      String filteredIndex : indices) {
        IndexMetaData indexMetaData=currentState.metaData().index(filteredIndex);
        if (indexMetaData != null) {
          mdBuilder.put(indexMetaData,false);
        }
      }
    }
    if (request.getFilteredIndexTemplates().length > 0) {
      for (      String templateName : request.getFilteredIndexTemplates()) {
        IndexTemplateMetaData indexTemplateMetaData=currentState.metaData().templates().get(templateName);
        if (indexTemplateMetaData != null) {
          mdBuilder.put(indexTemplateMetaData);
        }
      }
    }
    builder.metaData(mdBuilder);
  }
  return new ClusterStateResponse(clusterName,builder.build());
}
