{
  XContentType contentType=XContentFactory.xContentType(doc);
  if (contentType == builder.contentType()) {
    builder.rawField("doc",doc);
  }
 else {
    XContentParser parser=XContentFactory.xContent(contentType).createParser(doc);
    try {
      parser.nextToken();
      builder.field("doc");
      builder.copyCurrentStructure(parser);
    }
  finally {
      parser.close();
    }
  }
  return builder;
}
