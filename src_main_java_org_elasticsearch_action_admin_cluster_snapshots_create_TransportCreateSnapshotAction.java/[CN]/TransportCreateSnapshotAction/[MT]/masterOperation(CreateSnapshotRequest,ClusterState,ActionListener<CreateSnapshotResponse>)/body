{
  SnapshotsService.SnapshotRequest snapshotRequest=new SnapshotsService.SnapshotRequest("create_snapshot[" + request.snapshot() + "]",request.snapshot(),request.repository()).indices(request.indices()).indicesOptions(request.indicesOptions()).settings(request.settings()).includeGlobalState(request.includeGlobalState()).masterNodeTimeout(request.masterNodeTimeout());
  snapshotsService.createSnapshot(snapshotRequest,new SnapshotsService.CreateSnapshotListener(){
    @Override public void onResponse(){
      if (request.waitForCompletion()) {
        snapshotsService.addListener(new SnapshotsService.SnapshotCompletionListener(){
          SnapshotId snapshotId=new SnapshotId(request.repository(),request.snapshot());
          @Override public void onSnapshotCompletion(          SnapshotId snapshotId,          SnapshotInfo snapshot){
            if (this.snapshotId.equals(snapshotId)) {
              listener.onResponse(new CreateSnapshotResponse(snapshot));
              snapshotsService.removeListener(this);
            }
          }
          @Override public void onSnapshotFailure(          SnapshotId snapshotId,          Throwable t){
            if (this.snapshotId.equals(snapshotId)) {
              listener.onFailure(t);
              snapshotsService.removeListener(this);
            }
          }
        }
);
      }
 else {
        listener.onResponse(new CreateSnapshotResponse());
      }
    }
    @Override public void onFailure(    Throwable t){
      listener.onFailure(t);
    }
  }
);
}
