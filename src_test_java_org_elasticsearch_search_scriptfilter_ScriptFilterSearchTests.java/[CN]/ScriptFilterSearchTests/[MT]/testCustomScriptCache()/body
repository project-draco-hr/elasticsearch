{
  assertAcked(prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put(indexSettings()).put(IndexMetaData.SETTING_NUMBER_OF_REPLICAS,0)));
  client().prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("test","1").field("num",1.0f).endObject()).execute().actionGet();
  flush();
  client().prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().field("test","2").field("num",2.0f).endObject()).execute().actionGet();
  flush();
  client().prepareIndex("test","type1","3").setSource(jsonBuilder().startObject().field("test","3").field("num",3.0f).endObject()).execute().actionGet();
  flushAndRefresh();
  String script="org.elasticsearch.search.scriptfilter.ScriptFilterSearchTests.incrementScriptCounter() > 0";
  scriptCounter.set(0);
  logger.info("running script filter the first time");
  SearchResponse response=client().prepareSearch().setQuery(filteredQuery(termQuery("test","1"),scriptFilter(script).cache(true))).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(scriptCounter.get(),equalTo(internalCluster().hasFilterCache() ? 3 : 1));
  scriptCounter.set(0);
  logger.info("running script filter the second time");
  response=client().prepareSearch().setQuery(filteredQuery(termQuery("test","2"),scriptFilter(script).cache(true))).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(scriptCounter.get(),equalTo(cluster().hasFilterCache() ? 0 : 1));
  scriptCounter.set(0);
  logger.info("running script filter with new parameters");
  response=client().prepareSearch().setQuery(filteredQuery(termQuery("test","1"),scriptFilter(script).addParam("param1","1").cache(true))).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(scriptCounter.get(),equalTo(cluster().hasFilterCache() ? 3 : 1));
  scriptCounter.set(0);
  logger.info("running script filter with same parameters");
  response=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),scriptFilter(script).addParam("param1","1").cache(true))).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(scriptCounter.get(),equalTo(cluster().hasFilterCache() ? 0 : 3));
}
