{
  ClusterState clusterState=createInitialClusterState();
  RoutingTable routingTable=clusterState.routingTable();
  final int retries=MaxRetryAllocationDecider.SETTING_ALLOCATION_MAX_RETRY.get(Settings.EMPTY);
  for (int i=0; i < retries - 1; i++) {
    List<FailedRerouteAllocation.FailedShard> failedShards=Collections.singletonList(new FailedRerouteAllocation.FailedShard(routingTable.index("idx").shard(0).shards().get(0),"boom" + i,new UnsupportedOperationException()));
    RoutingAllocation.Result result=strategy.applyFailedShards(clusterState,failedShards);
    assertTrue(result.changed());
    routingTable=result.routingTable();
    clusterState=ClusterState.builder(clusterState).routingTable(routingTable).build();
    assertEquals(routingTable.index("idx").shards().size(),1);
    assertEquals(routingTable.index("idx").shard(0).shards().get(0).state(),INITIALIZING);
    assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getNumFailedAllocations(),i + 1);
    assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getMessage(),"boom" + i);
  }
  List<FailedRerouteAllocation.FailedShard> failedShards=Collections.singletonList(new FailedRerouteAllocation.FailedShard(routingTable.index("idx").shard(0).shards().get(0),"boom",new UnsupportedOperationException()));
  RoutingAllocation.Result result=strategy.applyFailedShards(clusterState,failedShards);
  assertTrue(result.changed());
  routingTable=result.routingTable();
  clusterState=ClusterState.builder(clusterState).routingTable(routingTable).build();
  assertEquals(routingTable.index("idx").shards().size(),1);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getNumFailedAllocations(),retries);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).state(),UNASSIGNED);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getMessage(),"boom");
  result=strategy.reroute(clusterState,new AllocationCommands(),false,true);
  assertTrue(result.changed());
  routingTable=result.routingTable();
  clusterState=ClusterState.builder(clusterState).routingTable(routingTable).build();
  assertEquals(routingTable.index("idx").shards().size(),1);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getNumFailedAllocations(),retries);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).state(),INITIALIZING);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getMessage(),"boom");
  failedShards=Collections.singletonList(new FailedRerouteAllocation.FailedShard(routingTable.index("idx").shard(0).shards().get(0),"boom",new UnsupportedOperationException()));
  result=strategy.applyFailedShards(clusterState,failedShards);
  assertTrue(result.changed());
  routingTable=result.routingTable();
  clusterState=ClusterState.builder(clusterState).routingTable(routingTable).build();
  assertEquals(routingTable.index("idx").shards().size(),1);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getNumFailedAllocations(),retries + 1);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).state(),UNASSIGNED);
  assertEquals(routingTable.index("idx").shard(0).shards().get(0).unassignedInfo().getMessage(),"boom");
}
