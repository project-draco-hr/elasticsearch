{
  if (!lifecycle.started()) {
    throw new ElasticSearchIllegalStateException("Can't add nodes to a stopped transport");
  }
  if (node == null) {
    throw new ConnectTransportException(node,"Can't connect to a null node");
  }
  try {
    NodeChannels nodeChannels=connectedNodes.get(node);
    if (nodeChannels != null) {
      return;
    }
synchronized (this) {
      nodeChannels=connectedNodes.get(node);
      if (nodeChannels != null) {
        return;
      }
      nodeChannels=new NodeChannels(new Channel[connectionsPerNodeLow],new Channel[connectionsPerNodeMed],new Channel[connectionsPerNodeHigh]);
      try {
        connectToChannels(nodeChannels,node);
      }
 catch (      Exception e) {
        nodeChannels.close();
        throw e;
      }
      connectedNodes.put(node,nodeChannels);
      if (logger.isDebugEnabled()) {
        logger.debug("Connected to node [{}]",node);
      }
    }
    transportServiceAdapter.raiseNodeConnected(node);
  }
 catch (  ConnectTransportException e) {
    throw e;
  }
catch (  Exception e) {
    throw new ConnectTransportException(node,"General node connection failure",e);
  }
}
