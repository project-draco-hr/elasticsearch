{
  createIndex("index1","index2","index3");
  ensureGreen();
  client().prepareIndex("index1","type1").setId("1").setSource("text","value1").get();
  client().prepareIndex("index2","type2").setId("2").setSource("text","value2").get();
  client().prepareIndex("index3","type3").setId("3").setSource("text","value3").get();
  refresh();
  SearchResponse response=client().prepareSearch("index1","index2","index3").setFilter(indicesFilter(termFilter("text","value1"),"index1").noMatchFilter(termFilter("text","value2"))).get();
  assertHitCount(response,2l);
  assertThat(response.getHits().getAt(0).getId(),anyOf(equalTo("1"),equalTo("2")));
  assertThat(response.getHits().getAt(1).getId(),anyOf(equalTo("1"),equalTo("2")));
  response=client().prepareSearch("index1","index2","index3").setFilter(indicesFilter(termFilter("text","value1"),"index1")).get();
  assertHitCount(response,3l);
  assertThat(response.getHits().getAt(0).getId(),anyOf(equalTo("1"),equalTo("2"),equalTo("3")));
  assertThat(response.getHits().getAt(1).getId(),anyOf(equalTo("1"),equalTo("2"),equalTo("3")));
  assertThat(response.getHits().getAt(2).getId(),anyOf(equalTo("1"),equalTo("2"),equalTo("3")));
  response=client().prepareSearch("index1","index2","index3").setFilter(indicesFilter(termFilter("text","value1"),"index1").noMatchFilter("all")).get();
  assertHitCount(response,3l);
  assertThat(response.getHits().getAt(0).getId(),anyOf(equalTo("1"),equalTo("2"),equalTo("3")));
  assertThat(response.getHits().getAt(1).getId(),anyOf(equalTo("1"),equalTo("2"),equalTo("3")));
  assertThat(response.getHits().getAt(2).getId(),anyOf(equalTo("1"),equalTo("2"),equalTo("3")));
  response=client().prepareSearch("index1","index2","index3").setFilter(indicesFilter(termFilter("text","value1"),"index1").noMatchFilter("none")).get();
  assertHitCount(response,1l);
  assertThat(response.getHits().getAt(0).getId(),equalTo("1"));
}
