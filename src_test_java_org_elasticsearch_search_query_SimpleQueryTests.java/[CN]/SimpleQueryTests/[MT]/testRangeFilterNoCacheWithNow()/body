{
  assertAcked(prepareCreate("test").setSettings(ImmutableSettings.builder().put(indexSettings()).put(SETTING_NUMBER_OF_REPLICAS,0)).addMapping("type1","date","type=date,format=YYYY-mm-dd"));
  ensureGreen();
  client().prepareIndex("test","type1","1").setSource("date","2014-01-01","field","value").setRefresh(true).get();
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.rangeFilter("date").from("2013-01-01").to("now"))).get();
  assertHitCount(searchResponse,1l);
  IndicesStatsResponse statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),equalTo(0l));
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.matchAllFilter()).must(FilterBuilders.rangeFilter("date").from("2013-01-01").to("now")))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),equalTo(0l));
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.matchAllFilter()).must(FilterBuilders.rangeFilter("date").from("2013-01-01").to("now/d").cache(true)))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  long filtercacheSize=statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes();
  assertThat(filtercacheSize,greaterThan(0l));
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.termFilter("field","value").cache(true)).must(FilterBuilders.rangeFilter("date").from("2013-01-01").to("now")))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),greaterThan(filtercacheSize));
  filtercacheSize=statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes();
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.matchAllFilter()).must(FilterBuilders.rangeFilter("date").from("2013-01-01").to("now").cache(true)))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),greaterThan(filtercacheSize));
}
