{
  createIndex("index1","index2","index3");
  ensureGreen();
  client().prepareIndex("index1","type1").setId("1").setSource("text","value1").get();
  client().prepareIndex("index2","type2").setId("2").setSource("text","value2").get();
  client().prepareIndex("index3","type3").setId("3").setSource("text","value3").get();
  refresh();
  SearchResponse response=client().prepareSearch("index1","index2","index3").setQuery(indicesQuery(matchQuery("text","value1"),"index1").noMatchQuery(matchQuery("text","value2"))).get();
  assertHitCount(response,2l);
  assertThat(response.getHits().getAt(0).getId(),either(equalTo("1")).or(equalTo("2")));
  assertThat(response.getHits().getAt(1).getId(),either(equalTo("1")).or(equalTo("2")));
  response=client().prepareSearch("index1","index2","index3").setQuery(indicesQuery(matchQuery("text","value1"),"index1")).get();
  assertHitCount(response,3l);
  assertThat(response.getHits().getAt(0).getId(),either(equalTo("1")).or(equalTo("2")).or(equalTo("3")));
  assertThat(response.getHits().getAt(1).getId(),either(equalTo("1")).or(equalTo("2")).or(equalTo("3")));
  assertThat(response.getHits().getAt(2).getId(),either(equalTo("1")).or(equalTo("2")).or(equalTo("3")));
  response=client().prepareSearch("index1","index2","index3").setQuery(indicesQuery(matchQuery("text","value1"),"index1").noMatchQuery("all")).get();
  assertHitCount(response,3l);
  assertThat(response.getHits().getAt(0).getId(),either(equalTo("1")).or(equalTo("2")).or(equalTo("3")));
  assertThat(response.getHits().getAt(1).getId(),either(equalTo("1")).or(equalTo("2")).or(equalTo("3")));
  assertThat(response.getHits().getAt(2).getId(),either(equalTo("1")).or(equalTo("2")).or(equalTo("3")));
  response=client().prepareSearch("index1","index2","index3").setQuery(indicesQuery(matchQuery("text","value1"),"index1").noMatchQuery("none")).get();
  assertHitCount(response,1l);
  assertThat(response.getHits().getAt(0).getId(),equalTo("1"));
}
