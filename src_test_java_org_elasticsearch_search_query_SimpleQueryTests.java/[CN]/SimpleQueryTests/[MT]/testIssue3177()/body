{
  assertAcked(prepareCreate("test").setSettings(settingsBuilder().put(SETTING_NUMBER_OF_SHARDS,1)));
  client().prepareIndex("test","type1","1").setSource("field1","value1").get();
  client().prepareIndex("test","type1","2").setSource("field1","value2").get();
  client().prepareIndex("test","type1","3").setSource("field1","value3").get();
  ensureGreen();
  waitForRelocation();
  optimize();
  refresh();
  assertHitCount(client().prepareSearch().setQuery(matchAllQuery()).setFilter(andFilter(queryFilter(matchAllQuery()),notFilter(andFilter(queryFilter(termQuery("field1","value1")),queryFilter(termQuery("field1","value2")))))).get(),3l);
  assertHitCount(client().prepareSearch().setQuery(filteredQuery(boolQuery().should(termQuery("field1","value1")).should(termQuery("field1","value2")).should(termQuery("field1","value3")),notFilter(andFilter(queryFilter(termQuery("field1","value1")),queryFilter(termQuery("field1","value2")))))).get(),3l);
  assertHitCount(client().prepareSearch().setQuery(matchAllQuery()).setFilter(notFilter(termFilter("field1","value3"))).get(),2l);
}
