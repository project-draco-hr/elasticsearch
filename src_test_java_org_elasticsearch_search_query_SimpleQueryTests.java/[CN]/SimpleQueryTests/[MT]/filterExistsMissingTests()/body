{
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client().prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().startObject("obj1").field("obj1_val","1").endObject().field("x1","x_1").field("field1","value1_1").field("field2","value2_1").endObject()).execute().actionGet();
  client().prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().startObject("obj1").field("obj1_val","1").endObject().field("x2","x_2").field("field1","value1_2").endObject()).execute().actionGet();
  client().prepareIndex("test","type1","3").setSource(jsonBuilder().startObject().startObject("obj2").field("obj2_val","1").endObject().field("y1","y_1").field("field2","value2_3").endObject()).execute().actionGet();
  client().prepareIndex("test","type1","4").setSource(jsonBuilder().startObject().startObject("obj2").field("obj2_val","1").endObject().field("y2","y_2").field("field3","value3_4").endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),existsFilter("field1"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("1"),equalTo("2")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("1"),equalTo("2")));
  searchResponse=client().prepareSearch().setQuery(constantScoreQuery(existsFilter("field1"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("1"),equalTo("2")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("1"),equalTo("2")));
  searchResponse=client().prepareSearch().setQuery(queryString("_exists_:field1")).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("1"),equalTo("2")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("1"),equalTo("2")));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),existsFilter("field2"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("1"),equalTo("3")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("1"),equalTo("3")));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),existsFilter("field3"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("4"));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),existsFilter("x*"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("1"),equalTo("2")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("1"),equalTo("2")));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),existsFilter("obj1"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("1"),equalTo("2")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("1"),equalTo("2")));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),missingFilter("field1"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("3"),equalTo("4")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("3"),equalTo("4")));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),missingFilter("field1"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("3"),equalTo("4")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("3"),equalTo("4")));
  searchResponse=client().prepareSearch().setQuery(constantScoreQuery(missingFilter("field1"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("3"),equalTo("4")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("3"),equalTo("4")));
  searchResponse=client().prepareSearch().setQuery(queryString("_missing_:field1")).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("3"),equalTo("4")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("3"),equalTo("4")));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),missingFilter("x*"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("3"),equalTo("4")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("3"),equalTo("4")));
  searchResponse=client().prepareSearch().setQuery(filteredQuery(matchAllQuery(),missingFilter("obj1"))).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  assertThat(searchResponse.getHits().getAt(0).id(),anyOf(equalTo("3"),equalTo("4")));
  assertThat(searchResponse.getHits().getAt(1).id(),anyOf(equalTo("3"),equalTo("4")));
}
