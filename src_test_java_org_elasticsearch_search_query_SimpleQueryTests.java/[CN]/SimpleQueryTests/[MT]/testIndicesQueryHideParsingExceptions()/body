{
  client().admin().indices().prepareCreate("simple").addMapping("lone",jsonBuilder().startObject().startObject("lone").endObject().endObject()).get();
  client().admin().indices().prepareCreate("related").addMapping("parent",jsonBuilder().startObject().startObject("parent").endObject().endObject()).addMapping("child",jsonBuilder().startObject().startObject("child").startObject("_parent").field("type","parent").endObject().endObject().endObject()).get();
  ensureGreen();
  client().prepareIndex("simple","lone").setId("1").setSource("text","value").get();
  client().prepareIndex("related","parent").setId("2").setSource("text","parent").get();
  client().prepareIndex("related","child").setId("3").setParent("2").setSource("text","value").get();
  refresh();
  SearchResponse response=client().prepareSearch("related").setQuery(hasChildQuery("child",matchQuery("text","value"))).get();
  assertHitCount(response,1l);
  assertThat(response.getHits().getAt(0).getId(),equalTo("2"));
  response=client().prepareSearch("simple").setQuery(matchQuery("text","value")).get();
  assertHitCount(response,1l);
  assertThat(response.getHits().getAt(0).getId(),equalTo("1"));
  try {
    client().prepareSearch("simple").setQuery(hasChildQuery("child",matchQuery("text","value"))).get();
    fail("Should have failed with a SearchPhaseExecutionException because all shards failed with a nested QueryParsingException");
  }
 catch (  SearchPhaseExecutionException e) {
  }
  response=client().prepareSearch("related","simple").setQuery(indicesQuery(matchQuery("text","parent"),"related").noMatchQuery(matchQuery("text","value"))).get();
  assertHitCount(response,2l);
  assertThat(response.getHits().getAt(0).getId(),either(equalTo("1")).or(equalTo("2")));
  assertThat(response.getHits().getAt(1).getId(),either(equalTo("1")).or(equalTo("2")));
  response=client().prepareSearch("related","simple").setQuery(indicesQuery(hasChildQuery("child",matchQuery("text","value")),"related").noMatchQuery(matchQuery("text","value"))).get();
  assertHitCount(response,2l);
  assertThat(response.getHits().getAt(0).getId(),either(equalTo("1")).or(equalTo("2")));
  assertThat(response.getHits().getAt(1).getId(),either(equalTo("1")).or(equalTo("2")));
}
