{
  CreateIndexRequestBuilder builder=prepareCreate("test").setSettings(settingsBuilder().put(SETTING_NUMBER_OF_SHARDS,1).put(SETTING_NUMBER_OF_REPLICAS,0).put("index.analysis.analyzer.index.type","custom").put("index.analysis.analyzer.index.tokenizer","standard").put("index.analysis.analyzer.index.filter","lowercase").put("index.analysis.analyzer.search.type","custom").put("index.analysis.analyzer.search.tokenizer","standard").putArray("index.analysis.analyzer.search.filter","lowercase","synonym").put("index.analysis.filter.synonym.type","synonym").putArray("index.analysis.filter.synonym.synonyms","fast, quick"));
  XContentBuilder mapping=XContentFactory.jsonBuilder().startObject().startObject("test").startObject("properties").startObject("text").field("type","string").field("index_analyzer","index").field("search_analyzer","search").endObject().endObject().endObject().endObject();
  assertAcked(builder.addMapping("test",mapping));
  ensureGreen();
  client().prepareIndex("test","test","1").setSource(jsonBuilder().startObject().field("text","quick brown fox").endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.queryString("quick").defaultField("text").defaultOperator(QueryStringQueryBuilder.Operator.AND)).get();
  assertHitCount(searchResponse,1);
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.queryString("quick brown").defaultField("text").defaultOperator(QueryStringQueryBuilder.Operator.AND)).get();
  assertHitCount(searchResponse,1);
  searchResponse=client().prepareSearch().setQuery(QueryBuilders.queryString("fast").defaultField("text").defaultOperator(QueryStringQueryBuilder.Operator.AND)).get();
  assertHitCount(searchResponse,1);
  client().prepareIndex("test","test","2").setSource(jsonBuilder().startObject().field("text","fast brown fox").endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.queryString("quick").defaultField("text").defaultOperator(QueryStringQueryBuilder.Operator.AND)).get();
  assertHitCount(searchResponse,2);
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.queryString("quick brown").defaultField("text").defaultOperator(QueryStringQueryBuilder.Operator.AND)).get();
  assertHitCount(searchResponse,2);
}
