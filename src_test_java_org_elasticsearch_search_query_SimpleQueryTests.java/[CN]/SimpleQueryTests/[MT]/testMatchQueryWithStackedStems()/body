{
  CreateIndexRequestBuilder builder=prepareCreate("test").setSettings(settingsBuilder().put(SETTING_NUMBER_OF_SHARDS,1).put(SETTING_NUMBER_OF_REPLICAS,0).put("index.analysis.analyzer.index.type","custom").put("index.analysis.analyzer.index.tokenizer","standard").put("index.analysis.analyzer.index.filter","lowercase").put("index.analysis.analyzer.search.type","custom").put("index.analysis.analyzer.search.tokenizer","standard").putArray("index.analysis.analyzer.search.filter","lowercase","keyword_repeat","porterStem","unique_stem").put("index.analysis.filter.unique_stem.type","unique").put("index.analysis.filter.unique_stem.only_on_same_position",true));
  XContentBuilder mapping=XContentFactory.jsonBuilder().startObject().startObject("test").startObject("properties").startObject("text").field("type","string").field("index_analyzer","index").field("search_analyzer","search").endObject().endObject().endObject().endObject();
  assertAcked(builder.addMapping("test",mapping));
  ensureGreen();
  client().prepareIndex("test","test","1").setSource(jsonBuilder().startObject().field("text","the fox runs across the street").endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.matchQuery("text","fox runs").operator(MatchQueryBuilder.Operator.AND)).get();
  assertHitCount(searchResponse,1);
  client().prepareIndex("test","test","2").setSource(jsonBuilder().startObject().field("text","run fox run").endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.matchQuery("text","fox runs").operator(MatchQueryBuilder.Operator.AND)).get();
  assertHitCount(searchResponse,2);
}
