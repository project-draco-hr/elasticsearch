{
  final CompletionMappingBuilder mapping=new CompletionMappingBuilder();
  createIndexAndMapping(mapping);
  int numDocs=randomIntBetween(10,100);
  int numPayloadFields=randomIntBetween(2,5);
  List<IndexRequestBuilder> indexRequestBuilders=new ArrayList<>();
  for (int i=1; i <= numDocs; i++) {
    XContentBuilder source=jsonBuilder().startObject().startObject(FIELD).field("input","suggestion" + i).field("weight",i).endObject();
    for (int j=0; j < numPayloadFields; j++) {
      source.field("test_field" + j,j + "value" + i);
    }
    source.endObject();
    indexRequestBuilders.add(client().prepareIndex(INDEX,TYPE,"" + i).setSource(source));
  }
  indexRandom(true,indexRequestBuilders);
  int suggestionSize=randomIntBetween(1,numDocs);
  int numRequestedPayloadFields=randomIntBetween(2,numPayloadFields);
  List<String> payloadFields=new ArrayList<>(numRequestedPayloadFields);
  for (int i=0; i < numRequestedPayloadFields; i++) {
    payloadFields.add("test_field" + i + ".keyword");
  }
  CompletionSuggestionBuilder prefix=SuggestBuilders.completionSuggestion(FIELD).prefix("sugg").size(suggestionSize).payload(payloadFields);
  SearchResponse searchResponse=client().prepareSearch(INDEX).suggest(new SuggestBuilder().addSuggestion("foo",prefix)).execute().actionGet();
  assertNoFailures(searchResponse);
  CompletionSuggestion completionSuggestion=searchResponse.getSuggest().getSuggestion("foo");
  CompletionSuggestion.Entry options=completionSuggestion.getEntries().get(0);
  assertThat(options.getOptions().size(),equalTo(suggestionSize));
  int id=numDocs;
  for (  CompletionSuggestion.Entry.Option option : options) {
    assertThat(option.getText().toString(),equalTo("suggestion" + id));
    assertThat(option.getPayload().size(),equalTo(numRequestedPayloadFields));
    for (int i=0; i < numRequestedPayloadFields; i++) {
      List<Object> fieldValue=option.getPayload().get("test_field" + i + ".keyword");
      assertNotNull(fieldValue);
      assertThat(fieldValue.size(),equalTo(1));
      assertThat((String)fieldValue.get(0),equalTo(i + "value" + id));
    }
    id--;
  }
}
