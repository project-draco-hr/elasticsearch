{
  createIndexAndMappingAndSettings(settingsBuilder().put(SETTING_NUMBER_OF_SHARDS,1).put(SETTING_NUMBER_OF_REPLICAS,0).build(),completionMappingBuilder);
  client().prepareIndex(INDEX,TYPE,"1").setSource(jsonBuilder().startObject().startObject(FIELD).startArray("input").value("The Beatles").endArray().endObject().endObject()).get();
  client().prepareIndex(INDEX,TYPE,"2").setSource(jsonBuilder().startObject().field("somefield","somevalue").endObject()).get();
  OptimizeResponse actionGet=client().admin().indices().prepareOptimize().setFlush(true).setMaxNumSegments(1).execute().actionGet();
  assertAllSuccessful(actionGet);
  refresh();
  client().prepareIndex(INDEX,TYPE,"1").setSource(jsonBuilder().startObject().field("somefield","somevalue").endObject()).get();
  actionGet=client().admin().indices().prepareOptimize().setFlush(true).setMaxNumSegments(1).execute().actionGet();
  assertAllSuccessful(actionGet);
  refresh();
  assertSuggestions("b");
  assertThat(2l,equalTo(client().prepareCount(INDEX).get().getCount()));
  for (  IndexShardSegments seg : client().admin().indices().prepareSegments().get().getIndices().get(INDEX)) {
    ShardSegments[] shards=seg.getShards();
    for (    ShardSegments shardSegments : shards) {
      assertThat(shardSegments.getSegments().size(),equalTo(1));
    }
  }
}
