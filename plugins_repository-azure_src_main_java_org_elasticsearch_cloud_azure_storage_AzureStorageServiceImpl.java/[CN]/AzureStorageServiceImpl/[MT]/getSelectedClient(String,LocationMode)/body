{
  logger.trace("selecting a client for account [{}], mode [{}]",account,mode.name());
  AzureStorageSettings azureStorageSettings=null;
  if (this.primaryStorageSettings == null || this.secondariesStorageSettings.isEmpty()) {
    throw new IllegalArgumentException("No azure storage can be found. Check your elasticsearch.yml.");
  }
  if (account != null) {
    azureStorageSettings=this.secondariesStorageSettings.get(account);
  }
  if (azureStorageSettings == null) {
    if (account == null || primaryStorageSettings.getName() == null || account.equals(primaryStorageSettings.getName())) {
      azureStorageSettings=primaryStorageSettings;
    }
  }
  if (azureStorageSettings == null) {
    throw new IllegalArgumentException("Can not find azure account [" + account + "]. Check your elasticsearch.yml.");
  }
  CloudBlobClient client=this.clients.get(azureStorageSettings.getAccount());
  if (client == null) {
    throw new IllegalArgumentException("Can not find an azure client for account [" + account + "]");
  }
  client.getDefaultRequestOptions().setLocationMode(mode);
  return client;
}
