{
  final IndexRoutingTable indexRoutingTable=state.routingTable().index(shardId.index().name());
  if (indexRoutingTable == null) {
    IndexMetaData index=state.getMetaData().index(shardId.index().getName());
    if (index != null && index.state() == IndexMetaData.State.CLOSE) {
      throw new IndexClosedException(shardId.index());
    }
    throw new IndexNotFoundException(shardId.index().getName());
  }
  final IndexShardRoutingTable shardRoutingTable=indexRoutingTable.shard(shardId.id());
  if (shardRoutingTable == null) {
    throw new ShardNotFoundException(shardId);
  }
  return shardRoutingTable;
}
