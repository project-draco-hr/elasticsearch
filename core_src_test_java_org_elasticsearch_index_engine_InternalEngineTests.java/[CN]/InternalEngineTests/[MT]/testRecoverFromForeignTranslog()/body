{
  boolean canHaveDuplicates=true;
  boolean autoGeneratedId=true;
  final int numDocs=randomIntBetween(1,10);
  for (int i=0; i < numDocs; i++) {
    ParsedDocument doc=testParsedDocument(Integer.toString(i),Integer.toString(i),"test",null,-1,-1,testDocument(),new BytesArray("{}"),null);
    Engine.Create firstIndexRequest=new Engine.Create(null,newUid(Integer.toString(i)),doc,Versions.MATCH_ANY,VersionType.INTERNAL,PRIMARY,System.nanoTime(),canHaveDuplicates,autoGeneratedId);
    engine.create(firstIndexRequest);
    assertThat(firstIndexRequest.version(),equalTo(1l));
  }
  engine.refresh("test");
  try (Engine.Searcher searcher=engine.acquireSearcher("test")){
    TopDocs topDocs=searcher.searcher().search(new MatchAllDocsQuery(),randomIntBetween(numDocs,numDocs + 10));
    assertThat(topDocs.totalHits,equalTo(numDocs));
  }
   final MockDirectoryWrapper directory=DirectoryUtils.getLeaf(store.directory(),MockDirectoryWrapper.class);
  if (directory != null) {
    directory.setPreventDoubleWrite(false);
  }
  Translog.TranslogGeneration generation=engine.getTranslog().getGeneration();
  engine.close();
  Translog translog=new Translog(new TranslogConfig(shardId,createTempDir(),Settings.EMPTY,Translog.Durabilty.REQUEST,BigArrays.NON_RECYCLING_INSTANCE,threadPool));
  translog.add(new Translog.Create("test","SomeBogusId","{}".getBytes(Charset.forName("UTF-8"))));
  assertEquals(generation.translogFileGeneration,translog.currentFileGeneration());
  translog.close();
  EngineConfig config=engine.config();
  TranslogConfig translogConfig=new TranslogConfig(shardId,translog.location(),config.getIndexSettings(),Translog.Durabilty.REQUEST,BigArrays.NON_RECYCLING_INSTANCE,threadPool);
  EngineConfig brokenConfig=new EngineConfig(shardId,threadPool,config.getIndexingService(),config.getIndexSettingsService(),null,store,createSnapshotDeletionPolicy(),newMergePolicy(),config.getMergeSchedulerConfig(),config.getAnalyzer(),config.getSimilarity(),new CodecService(shardId.index()),config.getFailedEngineListener(),config.getTranslogRecoveryPerformer(),IndexSearcher.getDefaultQueryCache(),IndexSearcher.getDefaultQueryCachingPolicy(),translogConfig);
  try {
    new InternalEngine(brokenConfig,false);
    fail("translog belongs to a different engine");
  }
 catch (  EngineCreationFailureException ex) {
  }
  engine=createEngine(store,primaryTranslogDir);
  try (Engine.Searcher searcher=engine.acquireSearcher("test")){
    TopDocs topDocs=searcher.searcher().search(new MatchAllDocsQuery(),randomIntBetween(numDocs,numDocs + 10));
    assertThat(topDocs.totalHits,equalTo(numDocs));
  }
 }
