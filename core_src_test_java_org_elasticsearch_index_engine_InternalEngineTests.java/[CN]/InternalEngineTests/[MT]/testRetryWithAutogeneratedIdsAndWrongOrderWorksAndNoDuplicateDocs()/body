{
  final ParsedDocument doc=testParsedDocument("1","1","test",null,100,-1,testDocumentWithTextField(),new BytesArray("{}".getBytes(Charset.defaultCharset())),null);
  boolean isRetry=true;
  long autoGeneratedIdTimestamp=0;
  Engine.Index firstIndexRequest=new Engine.Index(newUid("1"),doc,Versions.MATCH_ANY,VersionType.INTERNAL,PRIMARY,System.nanoTime(),autoGeneratedIdTimestamp,isRetry);
  engine.index(firstIndexRequest);
  assertThat(firstIndexRequest.version(),equalTo(1L));
  Engine.Index firstIndexRequestReplica=new Engine.Index(newUid("1"),doc,firstIndexRequest.version(),firstIndexRequest.versionType().versionTypeForReplicationAndRecovery(),REPLICA,System.nanoTime(),autoGeneratedIdTimestamp,isRetry);
  replicaEngine.index(firstIndexRequestReplica);
  assertThat(firstIndexRequestReplica.version(),equalTo(1L));
  isRetry=false;
  Engine.Index secondIndexRequest=new Engine.Index(newUid("1"),doc,Versions.MATCH_ANY,VersionType.INTERNAL,PRIMARY,System.nanoTime(),autoGeneratedIdTimestamp,isRetry);
  engine.index(secondIndexRequest);
  assertTrue(secondIndexRequest.isCreated());
  engine.refresh("test");
  try (Engine.Searcher searcher=engine.acquireSearcher("test")){
    TopDocs topDocs=searcher.searcher().search(new MatchAllDocsQuery(),10);
    assertEquals(1,topDocs.totalHits);
  }
   Engine.Index secondIndexRequestReplica=new Engine.Index(newUid("1"),doc,firstIndexRequest.version(),firstIndexRequest.versionType().versionTypeForReplicationAndRecovery(),REPLICA,System.nanoTime(),autoGeneratedIdTimestamp,isRetry);
  replicaEngine.index(secondIndexRequestReplica);
  replicaEngine.refresh("test");
  try (Engine.Searcher searcher=replicaEngine.acquireSearcher("test")){
    TopDocs topDocs=searcher.searcher().search(new MatchAllDocsQuery(),10);
    assertEquals(1,topDocs.totalHits);
  }
 }
