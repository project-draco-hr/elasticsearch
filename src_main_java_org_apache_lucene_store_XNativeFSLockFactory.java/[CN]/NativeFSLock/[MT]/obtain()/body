{
  if (lock != null) {
    return false;
  }
  if (!lockDir.exists()) {
    if (!lockDir.mkdirs())     throw new IOException("Cannot create directory: " + lockDir.getAbsolutePath());
  }
 else   if (!lockDir.isDirectory()) {
    throw new IOException("Found regular file where directory expected: " + lockDir.getAbsolutePath());
  }
  final String canonicalPath=path.getCanonicalPath();
  boolean obtained=false;
  if (LOCK_HELD.add(canonicalPath)) {
    try {
      channel=FileChannel.open(path.toPath(),StandardOpenOption.CREATE,StandardOpenOption.WRITE);
      try {
        lock=channel.tryLock();
        obtained=lock != null;
      }
 catch (      IOException|OverlappingFileLockException e) {
        failureReason=e;
      }
    }
  finally {
      if (obtained == false) {
        clearLockHeld(path);
        final FileChannel toClose=channel;
        channel=null;
        IOUtils.closeWhileHandlingException(toClose);
      }
    }
  }
  return obtained;
}
