{
  final int nbDocs=randomIntBetween(0,20);
  SearchHit[] docs=new SearchHit[nbDocs];
  for (int i=0; i < nbDocs; i++) {
    InternalSearchHit doc=new InternalSearchHit(randomInt(),String.valueOf(i),new Text("type"),null);
    doc.shard(new SearchShardTarget("node","test",randomInt()));
    docs[i]=doc;
  }
  DeleteByQueryRequest delete=new DeleteByQueryRequest();
  TestActionListener listener=new TestActionListener();
  TransportDeleteByQueryAction.AsyncDeleteByQueryAction async=newAsyncAction(delete,listener);
  async.onBulkFailure(null,docs,new Throwable("This is a bulk failure"));
  waitForCompletion("waiting for bulk failure to complete",listener);
  assertFailure(listener,"This is a bulk failure");
  DeleteByQueryResponse response=async.buildResponse();
  assertThat(response.getTotalFailed(),equalTo((long)nbDocs));
  assertThat(response.getTotalDeleted(),equalTo(0L));
}
