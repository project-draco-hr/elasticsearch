{
  createIndex("test");
  final int numDocs=randomIntBetween(1,200);
  for (int i=1; i <= numDocs; i++) {
    client().prepareIndex("test","type").setSource("num",i).get();
  }
  client().admin().indices().prepareRefresh("test").get();
  assertHitCount(client().prepareSearch("test").setSize(0).get(),numDocs);
  final long limit=randomIntBetween(0,numDocs);
  DeleteByQueryRequest delete=new DeleteByQueryRequest().indices(new String[]{"test"}).query(boolQuery().must(rangeQuery("num").lte(limit)));
  TestActionListener listener=new TestActionListener();
  newAsyncAction(delete,listener).executeScan();
  waitForCompletion("scan request should return the exact number of documents",listener);
  assertNoFailures(listener);
  DeleteByQueryResponse response=listener.getResponse();
  assertNotNull(response);
  assertThat(response.getTotalFound(),equalTo(limit));
  assertThat(response.getTotalDeleted(),equalTo(limit));
  assertSearchContextsClosed();
}
