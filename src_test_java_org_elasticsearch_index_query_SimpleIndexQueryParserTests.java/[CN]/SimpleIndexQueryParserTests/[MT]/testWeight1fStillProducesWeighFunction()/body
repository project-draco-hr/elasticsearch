{
  IndexQueryParserService queryParser=queryParser();
  String queryString=jsonBuilder().startObject().startObject("function_score").startArray("functions").startObject().startObject("field_value_factor").field("field","popularity").endObject().field("weight",1.0).endObject().endArray().endObject().endObject().string();
  IndexService indexService=createIndex("testidx",client().admin().indices().prepareCreate("testidx").addMapping("doc",jsonBuilder().startObject().startObject("properties").startObject("popularity").field("type","float").endObject().endObject().endObject()));
  SearchContext.setCurrent(createSearchContext(indexService));
  Query query=queryParser.parse(queryString).query();
  assertThat(query,instanceOf(FunctionScoreQuery.class));
  assertThat(((FunctionScoreQuery)query).getFunction(),instanceOf(WeightFactorFunction.class));
  SearchContext.removeCurrent();
}
