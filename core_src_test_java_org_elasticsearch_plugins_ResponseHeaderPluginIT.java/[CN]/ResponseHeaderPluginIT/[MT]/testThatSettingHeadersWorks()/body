{
  ensureGreen();
  try (RestClient client=restClient()){
    try {
      client.performRequest("GET","/_protected",Collections.emptyMap(),null);
      fail("request should have failed");
    }
 catch (    ElasticsearchResponseException e) {
      ElasticsearchResponse response=e.getElasticsearchResponse();
      assertThat(response,hasStatus(UNAUTHORIZED));
      assertThat(response.getFirstHeader("Secret"),equalTo("required"));
    }
    ElasticsearchResponse authResponse=client.performRequest("GET","/_protected",Collections.emptyMap(),null,new BasicHeader("Secret","password"));
    assertThat(authResponse,hasStatus(OK));
    assertThat(authResponse.getFirstHeader("Secret"),equalTo("granted"));
  }
 }
