{
  if (searchContext.timeoutInMillis() != -1) {
    collector=new TimeLimitingCollector(collector,TimeLimitingCollector.getGlobalCounter(),searchContext.timeoutInMillis());
  }
  if (currentState == Stage.MAIN_QUERY) {
    if (enableMainDocIdSetCollector) {
      collector=this.mainDocIdSetCollector=new DocIdSetCollector(searchContext.docSetCache(),collector);
    }
    if (searchContext.parsedPostFilter() != null) {
      collector=new FilteredCollector(collector,searchContext.parsedPostFilter().filter());
    }
    if (queryCollectors != null && !queryCollectors.isEmpty()) {
      collector=new MultiCollector(collector,queryCollectors.toArray(new Collector[queryCollectors.size()]));
    }
    if (searchContext.minimumScore() != null) {
      collector=new MinimumScoreCollector(collector,searchContext.minimumScore());
    }
  }
  try {
    if (searchContext.timeoutInMillis() != -1) {
      try {
        super.search(leaves,weight,collector);
      }
 catch (      TimeLimitingCollector.TimeExceededException e) {
        searchContext.queryResult().searchTimedOut(true);
      }
    }
 else {
      super.search(leaves,weight,collector);
    }
    if (currentState == Stage.MAIN_QUERY) {
      if (enableMainDocIdSetCollector) {
        enableMainDocIdSetCollector=false;
        mainDocIdSetCollector.postCollection();
      }
      if (queryCollectors != null && !queryCollectors.isEmpty()) {
        for (        Collector queryCollector : queryCollectors) {
          if (queryCollector instanceof XCollector) {
            ((XCollector)queryCollector).postCollection();
          }
        }
      }
    }
  }
  finally {
    searchContext.clearReleasables(Lifetime.COLLECTION);
  }
}
