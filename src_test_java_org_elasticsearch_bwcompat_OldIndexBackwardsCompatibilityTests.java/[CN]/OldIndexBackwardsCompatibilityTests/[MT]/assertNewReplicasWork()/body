{
  final int numReplicas=randomIntBetween(2,3);
  logger.debug("Creating [{}] nodes for replicas",numReplicas);
  internalCluster().startNodesAsync(numReplicas,ImmutableSettings.builder().put("data.node",true).put("master.node",false).put(Node.HTTP_ENABLED,true).build()).get();
  client().admin().cluster().prepareHealth("test").setWaitForNodes("" + (numReplicas + 1));
  assertAcked(client().admin().indices().prepareUpdateSettings("test").setSettings(ImmutableSettings.builder().put("number_of_replicas",numReplicas)).execute().actionGet());
  ensureGreen(TimeValue.timeValueMinutes(1),"test");
  assertAcked(client().admin().indices().prepareUpdateSettings("test").setSettings(ImmutableSettings.builder().put("number_of_replicas",0)).execute().actionGet());
  waitNoPendingTasksOnAll();
}
