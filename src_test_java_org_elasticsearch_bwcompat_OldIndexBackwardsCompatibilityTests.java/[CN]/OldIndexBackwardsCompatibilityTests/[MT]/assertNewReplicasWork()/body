{
  final int numReplicas=randomIntBetween(2,3);
  for (int i=0; i < numReplicas; ++i) {
    logger.debug("Creating another node for replica " + i);
    internalCluster().startNode(ImmutableSettings.builder().put("data.node",true).put("master.node",false).put(InternalNode.HTTP_ENABLED,true).build());
  }
  client().admin().cluster().prepareHealth("test").setWaitForNodes("" + (numReplicas + 1));
  assertAcked(client().admin().indices().prepareUpdateSettings("test").setSettings(ImmutableSettings.builder().put("number_of_replicas",numReplicas)).execute().actionGet());
  ensureGreen(TimeValue.timeValueMinutes(1),"test");
  assertAcked(client().admin().indices().prepareUpdateSettings("test").setSettings(ImmutableSettings.builder().put("number_of_replicas",0)).execute().actionGet());
  waitNoPendingTasksOnAll();
}
