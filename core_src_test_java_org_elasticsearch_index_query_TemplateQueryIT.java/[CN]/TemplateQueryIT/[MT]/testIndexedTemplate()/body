{
  createIndex(ScriptService.SCRIPT_INDEX);
  ensureGreen(ScriptService.SCRIPT_INDEX);
  List<IndexRequestBuilder> builders=new ArrayList<>();
  builders.add(client().prepareIndex(ScriptService.SCRIPT_INDEX,MustacheScriptEngineService.NAME,"1a").setSource("{" + "\"template\":{" + "                \"query\":{"+ "                   \"match\":{"+ "                    \"theField\" : \"{{fieldParam}}\"}"+ "       }"+ "}"+ "}"));
  builders.add(client().prepareIndex(ScriptService.SCRIPT_INDEX,MustacheScriptEngineService.NAME,"2").setSource("{" + "\"template\":{" + "                \"query\":{"+ "                   \"match\":{"+ "                    \"theField\" : \"{{fieldParam}}\"}"+ "       }"+ "}"+ "}"));
  builders.add(client().prepareIndex(ScriptService.SCRIPT_INDEX,MustacheScriptEngineService.NAME,"3").setSource("{" + "\"template\":{" + "             \"match\":{"+ "                    \"theField\" : \"{{fieldParam}}\"}"+ "       }"+ "}"));
  indexRandom(true,builders);
  builders.clear();
  builders.add(client().prepareIndex("test","type","1").setSource("{\"theField\":\"foo\"}"));
  builders.add(client().prepareIndex("test","type","2").setSource("{\"theField\":\"foo 2\"}"));
  builders.add(client().prepareIndex("test","type","3").setSource("{\"theField\":\"foo 3\"}"));
  builders.add(client().prepareIndex("test","type","4").setSource("{\"theField\":\"foo 4\"}"));
  builders.add(client().prepareIndex("test","type","5").setSource("{\"theField\":\"bar\"}"));
  indexRandom(true,builders);
  Map<String,Object> templateParams=new HashMap<>();
  templateParams.put("fieldParam","foo");
  SearchResponse searchResponse=client().prepareSearch("test").setTypes("type").setTemplate(new Template("/mustache/1a",ScriptService.ScriptType.INDEXED,MustacheScriptEngineService.NAME,null,templateParams)).get();
  assertHitCount(searchResponse,4);
  try {
    client().prepareSearch("test").setTypes("type").setTemplate(new Template("/template_index/mustache/1000",ScriptService.ScriptType.INDEXED,MustacheScriptEngineService.NAME,null,templateParams)).get();
    fail("shouldn't get here");
  }
 catch (  SearchPhaseExecutionException spee) {
  }
  try {
    searchResponse=client().prepareSearch("test").setTypes("type").setTemplate(new Template("/myindex/mustache/1",ScriptService.ScriptType.INDEXED,MustacheScriptEngineService.NAME,null,templateParams)).get();
    assertFailures(searchResponse);
  }
 catch (  SearchPhaseExecutionException spee) {
  }
  searchResponse=client().prepareSearch("test").setTypes("type").setTemplate(new Template("1a",ScriptService.ScriptType.INDEXED,MustacheScriptEngineService.NAME,null,templateParams)).get();
  assertHitCount(searchResponse,4);
  templateParams.put("fieldParam","bar");
  searchResponse=client().prepareSearch("test").setTypes("type").setTemplate(new Template("/mustache/2",ScriptService.ScriptType.INDEXED,MustacheScriptEngineService.NAME,null,templateParams)).get();
  assertHitCount(searchResponse,1);
  Map<String,Object> vars=new HashMap<>();
  vars.put("fieldParam","bar");
  TemplateQueryBuilder builder=new TemplateQueryBuilder(new Template("3",ScriptService.ScriptType.INDEXED,null,null,vars));
  SearchResponse sr=client().prepareSearch().setQuery(builder).execute().actionGet();
  assertHitCount(sr,1);
  String query="{\"template\": {\"id\": \"3\",\"params\" : {\"fieldParam\" : \"foo\"}}}";
  sr=client().prepareSearch().setQuery(query).get();
  assertHitCount(sr,4);
  query="{\"template\": {\"id\": \"/mustache/3\",\"params\" : {\"fieldParam\" : \"foo\"}}}";
  sr=client().prepareSearch().setQuery(query).get();
  assertHitCount(sr,4);
}
