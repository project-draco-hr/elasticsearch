{
  Random random=new Random();
  Settings settings=settingsBuilder().put("cluster.routing.schedule",200,TimeUnit.MILLISECONDS).put("index.engine.robin.refreshInterval","-1").put("gateway.type","local").put(SETTING_NUMBER_OF_SHARDS,2).put(SETTING_NUMBER_OF_REPLICAS,1).build();
  Node node1=nodeBuilder().settings(settingsBuilder().put(settings).put("name","server1")).node();
  Node node2=nodeBuilder().settings(settingsBuilder().put(settings).put("name","server2")).node();
  Node client=nodeBuilder().settings(settingsBuilder().put(settings).put("name","client")).client(true).node();
  Client client1=client.client();
  Thread.sleep(1000);
  client1.admin().indices().create(createIndexRequest("test")).actionGet();
  Thread.sleep(5000);
  StopWatch stopWatch=new StopWatch().start();
  long COUNT=SizeValue.parseSizeValue("5m").singles();
  int BATCH=100;
  System.out.println("Indexing [" + COUNT + "] ...");
  long ITERS=COUNT / BATCH;
  long i=1;
  int counter=0;
  for (; i <= ITERS; i++) {
    BulkRequestBuilder request=client1.prepareBulk();
    for (int j=0; j < BATCH; j++) {
      counter++;
      request.add(Requests.indexRequest("test").type("type1").id(Integer.toString(counter)).source(source(Integer.toString(counter),"test" + counter)));
    }
    BulkResponse response=request.execute().actionGet();
    if (response.hasFailures()) {
      System.err.println("failures...");
    }
    if (((i * BATCH) % 10000) == 0) {
      System.out.println("Indexed " + (i * 100) + " took "+ stopWatch.stop().lastTaskTime());
      stopWatch.start();
    }
  }
  System.out.println("Indexing took " + stopWatch.totalTime() + ", TPS "+ (((double)COUNT) / stopWatch.totalTime().secondsFrac()));
  client.client().admin().indices().prepareRefresh().execute().actionGet();
  System.out.println("Count: " + client.client().prepareCount().setQuery(matchAllQuery()).execute().actionGet().count());
  client.close();
  node1.close();
  node2.close();
}
