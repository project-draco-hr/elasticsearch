{
  if (finished.compareAndSet(false,true)) {
    Releasables.close(indexShardReference);
    final ShardId shardId=shardIt.shardId();
    final ActionWriteResponse.ShardInfo.Failure[] failuresArray;
    if (!shardReplicaFailures.isEmpty()) {
      int slot=0;
      failuresArray=new ActionWriteResponse.ShardInfo.Failure[shardReplicaFailures.size()];
      for (      Map.Entry<String,Throwable> entry : shardReplicaFailures.entrySet()) {
        RestStatus restStatus=ExceptionsHelper.status(entry.getValue());
        failuresArray[slot++]=new ActionWriteResponse.ShardInfo.Failure(shardId.getIndex(),shardId.getId(),entry.getKey(),entry.getValue(),restStatus,false);
      }
    }
 else {
      failuresArray=ActionWriteResponse.EMPTY;
    }
    finalResponse.setShardInfo(new ActionWriteResponse.ShardInfo(totalShards,success.get(),failuresArray));
    listener.onResponse(finalResponse);
  }
}
