{
  if (finished.compareAndSet(false,true)) {
    final ActionWriteResponse.ShardInfo.Failure[] failuresArray;
    if (!shardReplicaFailures.isEmpty()) {
      int slot=0;
      failuresArray=new ActionWriteResponse.ShardInfo.Failure[shardReplicaFailures.size()];
      for (      Map.Entry<String,Throwable> entry : shardReplicaFailures.entrySet()) {
        String reason=ExceptionsHelper.detailedMessage(entry.getValue());
        RestStatus restStatus=ExceptionsHelper.status(entry.getValue());
        failuresArray[slot++]=new ActionWriteResponse.ShardInfo.Failure(shardId.getIndex(),shardId.getId(),entry.getKey(),reason,restStatus,false);
      }
    }
 else {
      failuresArray=ActionWriteResponse.EMPTY;
    }
    finalResponse.setShardInfo(new ActionWriteResponse.ShardInfo(numberOfShardInstances,success.get(),failuresArray));
    listener.onResponse(onAllReplicasResponded(finalResponse,replicaResponses));
  }
}
