{
  SimpleIdCache idCache=createSimpleIdCache(Tuple.tuple("child","parent"));
  IndexWriter writer=createIndexWriter();
  writer.addDocument(doc("parent","1"));
  writer.addDocument(childDoc("child","1","parent","1"));
  writer.addDocument(childDoc("child","2","parent","1"));
  writer.addDocument(childDoc("child","3","parent","1"));
  writer.addDocument(childDoc("child","4","parent","1"));
  writer.commit();
  writer.addDocument(childDoc("child","5","parent","2"));
  writer.addDocument(doc("parent","2"));
  writer.addDocument(doc("parent","3"));
  writer.addDocument(doc("parent","4"));
  writer.addDocument(doc("parent","5"));
  writer.commit();
  writer.addDocument(doc("parent","6"));
  writer.addDocument(childDoc("child","6","parent","6"));
  writer.addDocument(childDoc("child","7","parent","6"));
  writer.addDocument(childDoc("child","8","parent","5"));
  writer.addDocument(childDoc("child","9","parent","4"));
  writer.addDocument(doc("parent","7"));
  writer.commit();
  writer.addDocument(doc("zzz","1"));
  writer.addDocument(doc("xxx","2"));
  writer.addDocument(doc("aaa","3"));
  writer.addDocument(doc("ccc","4"));
  writer.addDocument(doc("parent","8"));
  writer.commit();
  writer.close();
  DirectoryReader topLevelReader=DirectoryReader.open(writer.getDirectory());
  List<AtomicReaderContext> leaves=topLevelReader.getContext().leaves();
  idCache.refresh(leaves);
  IdReaderCache readerCache=idCache.reader(leaves.get(0).reader());
  assertThat(readerCache.type("child"),nullValue());
  IdReaderTypeCache typeCache=readerCache.type("parent");
  assertThat(typeCache.idByDoc(0).toUtf8(),equalTo("1"));
  assertThat(typeCache.idByDoc(1),nullValue());
  assertThat(typeCache.idByDoc(2),nullValue());
  assertThat(typeCache.idByDoc(3),nullValue());
  assertThat(typeCache.idByDoc(4),nullValue());
  assertThat(typeCache.parentIdByDoc(0),nullValue());
  assertThat(typeCache.parentIdByDoc(1).toUtf8(),equalTo("1"));
  assertThat(typeCache.parentIdByDoc(2).toUtf8(),equalTo("1"));
  assertThat(typeCache.parentIdByDoc(3).toUtf8(),equalTo("1"));
  assertThat(typeCache.parentIdByDoc(4).toUtf8(),equalTo("1"));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("1"))),equalTo(0));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("2"))),equalTo(-1));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("3"))),equalTo(-1));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("4"))),equalTo(-1));
  readerCache=idCache.reader(leaves.get(1).reader());
  assertThat(readerCache.type("child"),nullValue());
  typeCache=readerCache.type("parent");
  assertThat(typeCache.idByDoc(0),nullValue());
  assertThat(typeCache.idByDoc(1).toUtf8(),equalTo("2"));
  assertThat(typeCache.idByDoc(2).toUtf8(),equalTo("3"));
  assertThat(typeCache.idByDoc(3).toUtf8(),equalTo("4"));
  assertThat(typeCache.idByDoc(4).toUtf8(),equalTo("5"));
  assertThat(typeCache.parentIdByDoc(0).toUtf8(),equalTo("2"));
  assertThat(typeCache.parentIdByDoc(1),nullValue());
  assertThat(typeCache.parentIdByDoc(2),nullValue());
  assertThat(typeCache.parentIdByDoc(3),nullValue());
  assertThat(typeCache.parentIdByDoc(4),nullValue());
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("2"))),equalTo(1));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("3"))),equalTo(2));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("4"))),equalTo(3));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("5"))),equalTo(4));
  readerCache=idCache.reader(leaves.get(2).reader());
  assertThat(readerCache.type("child"),nullValue());
  typeCache=readerCache.type("parent");
  assertThat(typeCache.idByDoc(0).toUtf8(),equalTo("6"));
  assertThat(typeCache.idByDoc(1),nullValue());
  assertThat(typeCache.idByDoc(2),nullValue());
  assertThat(typeCache.idByDoc(3),nullValue());
  assertThat(typeCache.idByDoc(4),nullValue());
  assertThat(typeCache.idByDoc(5).toUtf8(),equalTo("7"));
  assertThat(typeCache.parentIdByDoc(0),nullValue());
  assertThat(typeCache.parentIdByDoc(1).toUtf8(),equalTo("6"));
  assertThat(typeCache.parentIdByDoc(2).toUtf8(),equalTo("6"));
  assertThat(typeCache.parentIdByDoc(3).toUtf8(),equalTo("5"));
  assertThat(typeCache.parentIdByDoc(4).toUtf8(),equalTo("4"));
  assertThat(typeCache.parentIdByDoc(5),nullValue());
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("6"))),equalTo(0));
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("7"))),equalTo(5));
  readerCache=idCache.reader(leaves.get(3).reader());
  assertThat(readerCache.type("child"),nullValue());
  typeCache=readerCache.type("parent");
  assertThat(typeCache.idByDoc(0),nullValue());
  assertThat(typeCache.idByDoc(1),nullValue());
  assertThat(typeCache.idByDoc(2),nullValue());
  assertThat(typeCache.idByDoc(3),nullValue());
  assertThat(typeCache.idByDoc(4).toUtf8(),equalTo("8"));
  assertThat(typeCache.parentIdByDoc(0),nullValue());
  assertThat(typeCache.parentIdByDoc(1),nullValue());
  assertThat(typeCache.parentIdByDoc(2),nullValue());
  assertThat(typeCache.parentIdByDoc(3),nullValue());
  assertThat(typeCache.parentIdByDoc(4),nullValue());
  assertThat(typeCache.docById(new HashedBytesArray(Strings.toUTF8Bytes("8"))),equalTo(4));
}
