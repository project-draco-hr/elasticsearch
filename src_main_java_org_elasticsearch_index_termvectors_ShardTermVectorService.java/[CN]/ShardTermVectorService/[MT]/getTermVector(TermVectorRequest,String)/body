{
  final Engine.Searcher searcher=indexShard.acquireSearcher("term_vector");
  IndexReader topLevelReader=searcher.reader();
  final TermVectorResponse termVectorResponse=new TermVectorResponse(concreteIndex,request.type(),request.id());
  final Term uidTerm=new Term(UidFieldMapper.NAME,Uid.createUidAsBytes(request.type(),request.id()));
  Engine.GetResult get=indexShard.get(new Engine.Get(request.realtime(),uidTerm));
  boolean docFromTranslog=get.source() != null;
  AggregatedDfs dfs=null;
  if (docFromTranslog) {
    request.doc(get.source().source,false);
    termVectorResponse.setDocVersion(get.version());
  }
  if (request.selectedFields() != null) {
    handleFieldWildcards(request);
  }
  try {
    Fields topLevelFields=MultiFields.getFields(topLevelReader);
    Versions.DocIdAndVersion docIdAndVersion=get.docIdAndVersion();
    if (request.doc() != null) {
      Fields termVectorsByField=generateTermVectorsFromDoc(request,!docFromTranslog);
      if (topLevelFields == null) {
        topLevelFields=termVectorsByField;
      }
      if (useDfs(request)) {
        dfs=getAggregatedDfs(termVectorsByField,request);
      }
      termVectorResponse.setFields(termVectorsByField,request.selectedFields(),request.getFlags(),topLevelFields,dfs);
      termVectorResponse.setExists(true);
      termVectorResponse.setArtificial(!docFromTranslog);
    }
 else     if (docIdAndVersion != null) {
      Fields termVectorsByField=docIdAndVersion.context.reader().getTermVectors(docIdAndVersion.docId);
      Set<String> selectedFields=request.selectedFields();
      if (selectedFields == null && request.perFieldAnalyzer() != null) {
        selectedFields=getFieldsToGenerate(request.perFieldAnalyzer(),termVectorsByField);
      }
      if (selectedFields != null) {
        termVectorsByField=addGeneratedTermVectors(get,termVectorsByField,request,selectedFields);
      }
      if (useDfs(request)) {
        dfs=getAggregatedDfs(termVectorsByField,request);
      }
      termVectorResponse.setFields(termVectorsByField,request.selectedFields(),request.getFlags(),topLevelFields,dfs);
      termVectorResponse.setDocVersion(docIdAndVersion.version);
      termVectorResponse.setExists(true);
    }
 else {
      termVectorResponse.setExists(false);
    }
  }
 catch (  Throwable ex) {
    throw new ElasticsearchException("failed to execute term vector request",ex);
  }
 finally {
    searcher.close();
    get.release();
  }
  return termVectorResponse;
}
