{
  Set<String> validFields=new HashSet<>();
  for (  String field : request.selectedFields()) {
    FieldMapper fieldMapper=indexShard.mapperService().smartNameFieldMapper(field);
    if (!isValidField(fieldMapper)) {
      continue;
    }
    if (fieldMapper.fieldType().storeTermVectors()) {
      continue;
    }
    validFields.add(field);
  }
  if (validFields.isEmpty()) {
    return termVectorsByField;
  }
  GetResult getResult=indexShard.getService().get(get,request.id(),request.type(),validFields.toArray(Strings.EMPTY_ARRAY),null,false);
  Fields generatedTermVectors=generateTermVectors(getResult.getFields().values(),request.offsets());
  if (termVectorsByField == null) {
    return generatedTermVectors;
  }
 else {
    return mergeFields(request.selectedFields().toArray(Strings.EMPTY_ARRAY),termVectorsByField,generatedTermVectors);
  }
}
