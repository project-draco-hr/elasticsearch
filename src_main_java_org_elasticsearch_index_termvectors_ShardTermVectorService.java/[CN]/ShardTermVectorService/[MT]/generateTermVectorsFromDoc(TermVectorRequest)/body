{
  ParsedDocument parsedDocument=parseDocument(indexShard.shardId().getIndex(),request.type(),request.doc());
  ParseContext.Document doc=parsedDocument.rootDoc();
  Collection<String> seenFields=new HashSet<>();
  Collection<GetField> getFields=new HashSet<>();
  for (  IndexableField field : doc.getFields()) {
    FieldMapper fieldMapper=indexShard.mapperService().smartNameFieldMapper(field.name());
    if (seenFields.contains(field.name())) {
      continue;
    }
 else {
      seenFields.add(field.name());
    }
    if (!isValidField(fieldMapper)) {
      continue;
    }
    if (request.selectedFields() != null && !request.selectedFields().contains(field.name())) {
      continue;
    }
    String[] values=doc.getValues(field.name());
    getFields.add(new GetField(field.name(),Arrays.asList((Object[])values)));
  }
  return generateTermVectors(getFields,request.offsets());
}
