{
  if (map.size() == 1 && map.containsKey(TYPE)) {
    map=(Map<String,Object>)map.values().iterator().next();
  }
  XContentBuilder builder=XContentFactory.smileBuilder().map(map);
  XContentParser parser=XContentFactory.xContent(XContentType.SMILE).createParser(builder.underlyingBytes(),0,builder.underlyingBytesLength());
  try {
    parser.nextToken();
    return fromXContent(parser);
  }
  finally {
    parser.close();
  }
}
