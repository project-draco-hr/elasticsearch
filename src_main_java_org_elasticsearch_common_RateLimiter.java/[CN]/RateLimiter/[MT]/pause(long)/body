{
  final long targetNS=lastNS=lastNS + ((long)(bytes * nsPerByte));
  long curNS=System.nanoTime();
  if (lastNS < curNS) {
    lastNS=curNS;
  }
  long totalPauseTime=0;
  while (true) {
    final long pauseNS=targetNS - curNS;
    if (pauseNS > 0) {
      try {
        Thread.sleep((int)(pauseNS / 1000000),(int)(pauseNS % 1000000));
        totalPauseTime+=pauseNS;
      }
 catch (      InterruptedException ie) {
        throw new ElasticSearchInterruptedException("interrupted while rate limiting",ie);
      }
      curNS=System.nanoTime();
      continue;
    }
    break;
  }
  return totalPauseTime;
}
