{
  QueryParseContext parseContext=context.parseContext();
  XContentParser parser=parseContext.parser();
  XContentParser.Token token=parser.nextToken();
  if (token != XContentParser.Token.FIELD_NAME) {
    throw new QueryParsingException(parseContext,"[wrapper] query malformed");
  }
  String fieldName=parser.currentName();
  if (!fieldName.equals("query")) {
    throw new QueryParsingException(parseContext,"[wrapper] query malformed");
  }
  parser.nextToken();
  byte[] querySource=parser.binaryValue();
  try (XContentParser qSourceParser=XContentFactory.xContent(querySource).createParser(querySource)){
    final QueryShardContext contextCopy=new QueryShardContext(context.index(),context.indexQueryParserService());
    contextCopy.reset(qSourceParser);
    Query result=contextCopy.parseContext().parseInnerQuery();
    parser.nextToken();
    context.combineNamedQueries(contextCopy);
    return result;
  }
 }
