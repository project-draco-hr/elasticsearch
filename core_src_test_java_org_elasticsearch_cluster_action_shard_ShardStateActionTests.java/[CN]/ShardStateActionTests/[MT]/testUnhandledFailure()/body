{
  final String index="test";
  clusterService.setState(stateWithStartedPrimary(index,true,randomInt(5)));
  String indexUUID=clusterService.state().metaData().index(index).getIndexUUID();
  AtomicBoolean failure=new AtomicBoolean();
  shardStateAction.shardFailed(getRandomShardRouting(index),indexUUID,"test",getSimulatedFailure(),new ShardStateAction.Listener(){
    @Override public void onShardFailedFailure(    Exception e){
      failure.set(true);
    }
  }
);
  final CapturingTransport.CapturedRequest[] capturedRequests=transport.getCapturedRequestsAndClear();
  assertThat(capturedRequests.length,equalTo(1));
  assertFalse(failure.get());
  transport.handleResponse(capturedRequests[0].requestId,new TransportException("simulated"));
  assertTrue(failure.get());
}
