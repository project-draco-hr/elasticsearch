{
  final String index="test";
  clusterService.setState(stateWithStartedPrimary(index,true,randomInt(5)));
  String indexUUID=clusterService.state().metaData().index(index).getIndexUUID();
  CountDownLatch latch=new CountDownLatch(1);
  AtomicBoolean noMaster=new AtomicBoolean();
  AtomicBoolean retried=new AtomicBoolean();
  AtomicBoolean success=new AtomicBoolean();
  setUpMasterRetryVerification(noMaster,retried,latch);
  shardStateAction.shardFailed(getRandomShardRouting(index),indexUUID,"test",getSimulatedFailure(),new ShardStateAction.Listener(){
    @Override public void onSuccess(){
      success.set(true);
      latch.countDown();
    }
    @Override public void onShardFailedFailure(    Exception e){
      success.set(false);
      latch.countDown();
    }
  }
);
  final CapturingTransport.CapturedRequest[] capturedRequests=transport.capturedRequests();
  transport.clear();
  assertThat(capturedRequests.length,equalTo(1));
  assertFalse(success.get());
  List<Exception> possibleExceptions=new ArrayList<>();
  possibleExceptions.add(new NotMasterException("simulated"));
  possibleExceptions.add(new NodeDisconnectedException(clusterService.state().nodes().masterNode(),ShardStateAction.SHARD_FAILED_ACTION_NAME));
  transport.handleResponse(capturedRequests[0].requestId,randomFrom(possibleExceptions));
  latch.await();
  assertTrue(success.get());
}
