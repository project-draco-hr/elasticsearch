{
  ChannelBuffer buffer=(ChannelBuffer)event.getMessage();
  int size=buffer.getInt(buffer.readerIndex() - 4);
  transportServiceAdapter.received(size + 4);
  int markedReaderIndex=buffer.readerIndex();
  int expectedIndexReader=markedReaderIndex + size;
  StreamInput streamIn=new ChannelBufferStreamInput(buffer);
  streamIn=HandlesStreamInput.Cached.cached(streamIn);
  long requestId=buffer.readLong();
  byte status=buffer.readByte();
  boolean isRequest=isRequest(status);
  TransportResponseHandler handler=null;
  if (isRequest) {
    handleRequest(event,streamIn,requestId);
  }
 else {
    handler=transportServiceAdapter.remove(requestId);
    if (handler != null) {
      if (isError(status)) {
        handlerResponseError(streamIn,handler);
      }
 else {
        handleResponse(streamIn,handler);
      }
    }
 else {
      buffer.readerIndex(markedReaderIndex + size);
    }
  }
  if (buffer.readerIndex() < expectedIndexReader) {
    logger.warn("Message not fully read for [{}] and handler {}, resetting",requestId,handler);
    buffer.readerIndex(expectedIndexReader);
  }
}
