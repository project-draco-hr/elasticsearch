{
  try {
    String name="metadata-" + (currentIndex + 1);
    BinaryXContentBuilder builder=XContentFactory.contentBinaryBuilder(XContentType.JSON);
    builder.prettyPrint();
    builder.startObject();
    MetaData.Builder.toXContent(metaData,builder,ToXContent.EMPTY_PARAMS);
    builder.endObject();
    Blob blob=blobStoreContext.getBlobStore().newBlob(name);
    blob.setPayload(new FastByteArrayInputStream(builder.unsafeBytes(),0,builder.unsafeBytesLength()));
    blob.setContentLength(builder.unsafeBytesLength());
    blobStoreContext.getBlobStore().putBlob(metadataContainer,blob);
    currentIndex++;
    PageSet<? extends StorageMetadata> pageSet=blobStoreContext.getBlobStore().list(metadataContainer);
    for (    StorageMetadata storageMetadata : pageSet) {
      if (storageMetadata.getName().startsWith("metadata-") && !name.equals(storageMetadata.getName())) {
        blobStoreContext.getAsyncBlobStore().removeBlob(metadataContainer,storageMetadata.getName());
      }
    }
  }
 catch (  IOException e) {
    throw new GatewayException("can't write new metadata file into the gateway",e);
  }
}
