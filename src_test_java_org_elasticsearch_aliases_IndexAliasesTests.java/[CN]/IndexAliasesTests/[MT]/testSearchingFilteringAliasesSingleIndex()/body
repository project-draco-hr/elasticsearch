{
  logger.info("--> creating index [test]");
  assertAcked(prepareCreate("test").addMapping("type1","id","type=string","name","type=string"));
  ensureGreen();
  logger.info("--> adding filtering aliases to index [test]");
  assertAcked(admin().indices().prepareAliases().addAlias("test","alias1"));
  assertAcked(admin().indices().prepareAliases().addAlias("test","alias2"));
  assertAcked(admin().indices().prepareAliases().addAlias("test","foos",termFilter("name","foo")));
  assertAcked(admin().indices().prepareAliases().addAlias("test","bars",termFilter("name","bar")));
  assertAcked(admin().indices().prepareAliases().addAlias("test","tests",termFilter("name","test")));
  logger.info("--> indexing against [test]");
  client().index(indexRequest("test").type("type1").id("1").source(source("1","foo test")).refresh(true)).actionGet();
  client().index(indexRequest("test").type("type1").id("2").source(source("2","bar test")).refresh(true)).actionGet();
  client().index(indexRequest("test").type("type1").id("3").source(source("3","baz test")).refresh(true)).actionGet();
  client().index(indexRequest("test").type("type1").id("4").source(source("4","something else")).refresh(true)).actionGet();
  logger.info("--> checking single filtering alias search");
  SearchResponse searchResponse=client().prepareSearch("foos").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1");
  logger.info("--> checking single filtering alias wildcard search");
  searchResponse=client().prepareSearch("fo*").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1");
  searchResponse=client().prepareSearch("tests").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1","2","3");
  logger.info("--> checking single filtering alias search with sort");
  searchResponse=client().prepareSearch("tests").setQuery(QueryBuilders.matchAllQuery()).addSort("_uid",SortOrder.ASC).get();
  assertHits(searchResponse.getHits(),"1","2","3");
  logger.info("--> checking single filtering alias search with global facets");
  searchResponse=client().prepareSearch("tests").setQuery(QueryBuilders.matchQuery("name","bar")).addAggregation(AggregationBuilders.global("global").subAggregation(AggregationBuilders.terms("test").field("name"))).get();
  assertSearchResponse(searchResponse);
  Global global=searchResponse.getAggregations().get("global");
  Terms terms=global.getAggregations().get("test");
  assertThat(terms.getBuckets().size(),equalTo(4));
  logger.info("--> checking single filtering alias search with global facets and sort");
  searchResponse=client().prepareSearch("tests").setQuery(QueryBuilders.matchQuery("name","bar")).addAggregation(AggregationBuilders.global("global").subAggregation(AggregationBuilders.terms("test").field("name"))).addSort("_uid",SortOrder.ASC).get();
  assertSearchResponse(searchResponse);
  global=searchResponse.getAggregations().get("global");
  terms=global.getAggregations().get("test");
  assertThat(terms.getBuckets().size(),equalTo(4));
  logger.info("--> checking single filtering alias search with non-global facets");
  searchResponse=client().prepareSearch("tests").setQuery(QueryBuilders.matchQuery("name","bar")).addAggregation(AggregationBuilders.terms("test").field("name")).addSort("_uid",SortOrder.ASC).get();
  assertSearchResponse(searchResponse);
  terms=searchResponse.getAggregations().get("test");
  assertThat(terms.getBuckets().size(),equalTo(2));
  searchResponse=client().prepareSearch("foos","bars").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1","2");
  logger.info("--> checking single non-filtering alias search");
  searchResponse=client().prepareSearch("alias1").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1","2","3","4");
  logger.info("--> checking non-filtering alias and filtering alias search");
  searchResponse=client().prepareSearch("alias1","foos").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1","2","3","4");
  logger.info("--> checking index and filtering alias search");
  searchResponse=client().prepareSearch("test","foos").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1","2","3","4");
  logger.info("--> checking index and alias wildcard search");
  searchResponse=client().prepareSearch("te*","fo*").setQuery(QueryBuilders.matchAllQuery()).get();
  assertHits(searchResponse.getHits(),"1","2","3","4");
}
