{
  client().admin().indices().prepareDelete().execute().actionGet();
  logger.info("--> creating index [test]");
  client().admin().indices().create(createIndexRequest("test")).actionGet();
  ensureGreen();
  logger.info("--> creating alias1 ");
  assertThat(client().admin().indices().prepareAliases().addAlias("test","alias1").execute().actionGet().isAcknowledged(),equalTo(true));
  TimeValue timeout=TimeValue.timeValueSeconds(2);
  logger.info("--> recreating alias1 ");
  StopWatch stopWatch=new StopWatch();
  stopWatch.start();
  assertThat(client().admin().indices().prepareAliases().addAlias("test","alias1").setTimeout(timeout).execute().actionGet().isAcknowledged(),equalTo(true));
  assertThat(stopWatch.stop().lastTaskTime().millis(),lessThan(timeout.millis()));
  logger.info("--> modifying alias1 to have a filter");
  stopWatch.start();
  assertThat(client().admin().indices().prepareAliases().addAlias("test","alias1",termFilter("name","foo")).setTimeout(timeout).execute().actionGet().isAcknowledged(),equalTo(true));
  assertThat(stopWatch.stop().lastTaskTime().millis(),lessThan(timeout.millis()));
  logger.info("--> recreating alias1 with the same filter");
  stopWatch.start();
  assertThat(client().admin().indices().prepareAliases().addAlias("test","alias1",termFilter("name","foo")).setTimeout(timeout).execute().actionGet().isAcknowledged(),equalTo(true));
  assertThat(stopWatch.stop().lastTaskTime().millis(),lessThan(timeout.millis()));
  logger.info("--> recreating alias1 with a different filter");
  stopWatch.start();
  assertThat(client().admin().indices().prepareAliases().addAlias("test","alias1",termFilter("name","bar")).setTimeout(timeout).execute().actionGet().isAcknowledged(),equalTo(true));
  assertThat(stopWatch.stop().lastTaskTime().millis(),lessThan(timeout.millis()));
  logger.info("--> verify that filter was updated");
  AliasMetaData aliasMetaData=cluster().clusterService().state().metaData().aliases().get("alias1").get("test");
  assertThat(aliasMetaData.getFilter().toString(),equalTo("{\"term\":{\"name\":\"bar\"}}"));
  logger.info("--> deleting alias1");
  stopWatch.start();
  assertThat(client().admin().indices().prepareAliases().removeAlias("test","alias1").setTimeout(timeout).execute().actionGet().isAcknowledged(),equalTo(true));
  assertThat(stopWatch.stop().lastTaskTime().millis(),lessThan(timeout.millis()));
  logger.info("--> deleting alias1 one more time");
  stopWatch.start();
  assertThat(client().admin().indices().prepareAliases().removeAlias("test","alias1").setTimeout(timeout).execute().actionGet().isAcknowledged(),equalTo(true));
  assertThat(stopWatch.stop().lastTaskTime().millis(),lessThan(timeout.millis()));
}
