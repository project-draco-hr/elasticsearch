{
  try {
    client.admin().indices().prepareDelete("test").execute().actionGet();
  }
 catch (  Exception e) {
  }
  Builder builder=ImmutableSettings.builder();
  builder.put("index.analysis.analyzer.synonym.tokenizer","whitespace");
  builder.putArray("index.analysis.analyzer.synonym.filter","synonym","lowercase");
  builder.put("index.analysis.filter.synonym.type","synonym");
  builder.putArray("index.analysis.filter.synonym.synonyms","ave => ave, avenue","street => str, street");
  XContentBuilder mapping=XContentFactory.jsonBuilder().startObject().startObject("type2").startObject("properties").startObject("field1").field("type","string").field("index_analyzer","whitespace").field("search_analyzer","synonym").endObject().endObject().endObject().endObject();
  client.admin().indices().prepareCreate("test").addMapping("type1",mapping).setSettings(builder.put("index.number_of_shards",1)).execute().actionGet();
  client.prepareIndex("test","type1","1").setSource("field1","massachusetts avenue boston massachusetts").execute().actionGet();
  client.prepareIndex("test","type1","2").setSource("field1","lexington avenue boston massachusetts").execute().actionGet();
  client.prepareIndex("test","type1","3").setSource("field1","boston avenue lexington massachusetts").execute().actionGet();
  client.admin().indices().prepareRefresh("test").execute().actionGet();
  client.prepareIndex("test","type1","4").setSource("field1","boston road lexington massachusetts").execute().actionGet();
  client.prepareIndex("test","type1","5").setSource("field1","lexington street lexington massachusetts").execute().actionGet();
  client.prepareIndex("test","type1","6").setSource("field1","massachusetts avenue lexington massachusetts").execute().actionGet();
  client.prepareIndex("test","type1","7").setSource("field1","bosten street san franciso california").execute().actionGet();
  client.admin().indices().prepareRefresh("test").execute().actionGet();
  client.prepareIndex("test","type1","8").setSource("field1","hollywood boulevard los angeles california").execute().actionGet();
  client.prepareIndex("test","type1","9").setSource("field1","1st street boston massachussetts").execute().actionGet();
  client.prepareIndex("test","type1","10").setSource("field1","1st street boston massachusetts").execute().actionGet();
  client.admin().indices().prepareRefresh("test").execute().actionGet();
  client.prepareIndex("test","type1","11").setSource("field1","2st street boston massachusetts").execute().actionGet();
  client.prepareIndex("test","type1","12").setSource("field1","3st street boston massachusetts").execute().actionGet();
  client.admin().indices().prepareRefresh("test").execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch().setQuery(QueryBuilders.matchQuery("field1","lexington avenue massachusetts").operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(5).setRescorer(RescoreBuilder.queryRescorer(QueryBuilders.matchPhraseQuery("field1","lexington avenue massachusetts").slop(3)).setQueryWeight(0.6f).setRescoreQueryWeight(2.0f)).setRescoreWindow(20).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(9l));
  assertThat(searchResponse.getHits().hits().length,equalTo(5));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("6"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  searchResponse=client.prepareSearch().setQuery(QueryBuilders.matchQuery("field1","lexington avenue massachusetts").operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(5).setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setRescorer(RescoreBuilder.queryRescorer(QueryBuilders.matchPhraseQuery("field1","lexington avenue massachusetts").slop(3)).setQueryWeight(0.6f).setRescoreQueryWeight(2.0f)).setRescoreWindow(20).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(9l));
  assertThat(searchResponse.getHits().hits().length,equalTo(5));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("6"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
}
