{
  Iterable<DiscoveryNode> dataNodes=allocation.nodes().dataNodes().values();
  boolean changed=false;
  changed|=deassociateDeadNodes(allocation.routingNodes(),dataNodes);
  applyNewNodes(allocation.routingNodes(),dataNodes);
  changed|=electPrimaries(allocation.routingNodes());
  if (allocation.routingNodes().hasUnassigned()) {
    changed|=nodeAllocations.allocateUnassigned(nodeAllocations,allocation);
    changed|=allocateUnassigned(allocation);
    changed|=electPrimaries(allocation.routingNodes());
  }
  changed|=rebalance(allocation);
  return changed;
}
