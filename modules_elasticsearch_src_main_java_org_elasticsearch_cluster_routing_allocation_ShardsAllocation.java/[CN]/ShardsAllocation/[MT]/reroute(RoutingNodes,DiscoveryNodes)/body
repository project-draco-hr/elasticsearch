{
  Iterable<DiscoveryNode> dataNodes=nodes.dataNodes().values();
  boolean changed=false;
  changed|=deassociateDeadNodes(routingNodes,dataNodes);
  applyNewNodes(routingNodes,dataNodes);
  changed|=electPrimaries(routingNodes);
  if (routingNodes.hasUnassigned()) {
    changed|=nodeAllocations.allocate(nodeAllocations,routingNodes,nodes);
    changed|=allocateUnassigned(routingNodes);
    changed|=electPrimaries(routingNodes);
  }
  changed|=rebalance(routingNodes,nodes);
  return changed;
}
