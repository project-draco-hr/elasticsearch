{
  boolean changed=false;
  List<RoutingNode> nodes=routingNodes.sortedNodesLeastToHigh();
  Iterator<MutableShardRouting> unassignedIterator=routingNodes.unassigned().iterator();
  int lastNode=0;
  while (unassignedIterator.hasNext()) {
    MutableShardRouting shard=unassignedIterator.next();
    for (int i=0; i < nodes.size(); i++) {
      RoutingNode node=nodes.get(lastNode);
      lastNode++;
      if (lastNode == nodes.size()) {
        lastNode=0;
      }
      if (nodeAllocations.canAllocate(shard,node,routingNodes).allocate()) {
        int numberOfShardsToAllocate=routingNodes.requiredAverageNumberOfShardsPerNode() - node.shards().size();
        if (numberOfShardsToAllocate <= 0) {
          continue;
        }
        changed=true;
        node.add(shard);
        unassignedIterator.remove();
        break;
      }
    }
  }
  for (Iterator<MutableShardRouting> it=routingNodes.unassigned().iterator(); it.hasNext(); ) {
    MutableShardRouting shard=it.next();
    for (    RoutingNode routingNode : routingNodes.sortedNodesLeastToHigh()) {
      if (nodeAllocations.canAllocate(shard,routingNode,routingNodes).allocate()) {
        changed=true;
        routingNode.add(shard);
        it.remove();
        break;
      }
    }
  }
  return changed;
}
