{
synchronized (mutex) {
    List<SnapshotIndexCommit> snapshotCommits=wrapCommits(commits);
    primary.onCommit(snapshotCommits);
    for (Iterator<SnapshotHolder> it=snapshots.values().iterator(); it.hasNext(); ) {
      SnapshotHolder holder=it.next();
      if (holder.counter <= 0) {
        it.remove();
      }
    }
    List<SnapshotIndexCommit> newCommits=new ArrayList<SnapshotIndexCommit>();
    for (    SnapshotIndexCommit commit : snapshotCommits) {
      if (!commit.isDeleted()) {
        newCommits.add(commit);
      }
    }
    this.commits=newCommits;
    this.lastCommit=newCommits.get(newCommits.size() - 1);
  }
}
