{
  logger.warn(new ParameterizedMessage("{} received shard failed for {}",request.shardId,request),request.failure);
  clusterService.submitStateUpdateTask("shard-failed",request,ClusterStateTaskConfig.build(Priority.HIGH),shardFailedClusterStateTaskExecutor,new ClusterStateTaskListener(){
    @Override public void onFailure(    String source,    Exception e){
      logger.error(new ParameterizedMessage("{} unexpected failure while failing shard [{}]",request.shardId,request),e);
      try {
        channel.sendResponse(e);
      }
 catch (      Exception channelException) {
        channelException.addSuppressed(e);
        logger.warn(new ParameterizedMessage("{} failed to send failure [{}] while failing shard [{}]",request.shardId,e,request),channelException);
      }
    }
    @Override public void onNoLongerMaster(    String source){
      logger.error("{} no longer master while failing shard [{}]",request.shardId,request);
      try {
        channel.sendResponse(new NotMasterException(source));
      }
 catch (      Exception channelException) {
        logger.warn(new ParameterizedMessage("{} failed to send no longer master while failing shard [{}]",request.shardId,request),channelException);
      }
    }
    @Override public void clusterStateProcessed(    String source,    ClusterState oldState,    ClusterState newState){
      try {
        channel.sendResponse(TransportResponse.Empty.INSTANCE);
      }
 catch (      Exception channelException) {
        logger.warn(new ParameterizedMessage("{} failed to send response while failing shard [{}]",request.shardId,request),channelException);
      }
    }
  }
);
}
