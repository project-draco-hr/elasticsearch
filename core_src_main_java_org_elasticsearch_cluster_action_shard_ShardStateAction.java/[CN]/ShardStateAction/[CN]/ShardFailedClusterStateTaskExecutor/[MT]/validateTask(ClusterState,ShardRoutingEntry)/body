{
  if (!task.shardRouting.isSameAllocation(task.sourceShardRouting)) {
    IndexShardRoutingTable indexShard=currentState.getRoutingTable().shardRoutingTableOrNull(task.shardRouting.shardId());
    if (indexShard == null) {
      return ValidationResult.SOURCE_INVALID;
    }
    ShardRouting primaryShard=indexShard.primaryShard();
    if (primaryShard == null || !primaryShard.isSameAllocation(task.sourceShardRouting)) {
      return ValidationResult.SOURCE_INVALID;
    }
  }
  RoutingNode routingNode=currentState.getRoutingNodes().node(task.getShardRouting().currentNodeId());
  if (routingNode != null) {
    ShardRouting maybe=routingNode.getByShardId(task.getShardRouting().shardId());
    if (maybe != null && maybe.isSameAllocation(task.getShardRouting())) {
      return ValidationResult.VALID;
    }
  }
  return ValidationResult.SHARD_MISSING;
}
