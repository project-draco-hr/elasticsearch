{
  BatchResult.Builder<ShardRoutingEntry> batchResultBuilder=BatchResult.builder();
  List<FailedRerouteAllocation.FailedShard> shardRoutingsToBeApplied=new ArrayList<>(tasks.size());
  for (  ShardRoutingEntry task : tasks) {
    task.processed=true;
    shardRoutingsToBeApplied.add(new FailedRerouteAllocation.FailedShard(task.shardRouting,task.message,task.failure));
  }
  ClusterState maybeUpdatedState=currentState;
  try {
    RoutingAllocation.Result result=allocationService.applyFailedShards(currentState,shardRoutingsToBeApplied);
    if (result.changed()) {
      maybeUpdatedState=ClusterState.builder(currentState).routingResult(result).build();
    }
    batchResultBuilder.successes(tasks);
  }
 catch (  Throwable t) {
    batchResultBuilder.failures(tasks,t);
  }
  return batchResultBuilder.build(maybeUpdatedState);
}
