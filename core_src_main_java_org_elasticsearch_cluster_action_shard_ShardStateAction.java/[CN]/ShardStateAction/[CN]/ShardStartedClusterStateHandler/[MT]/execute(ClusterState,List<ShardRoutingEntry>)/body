{
  BatchResult.Builder<ShardRoutingEntry> builder=BatchResult.builder();
  List<ShardRouting> shardRoutingsToBeApplied=new ArrayList<>(tasks.size());
  for (  ShardRoutingEntry task : tasks) {
    task.processed=true;
    shardRoutingsToBeApplied.add(task.shardRouting);
  }
  ClusterState maybeUpdatedState=currentState;
  try {
    RoutingAllocation.Result result=allocationService.applyStartedShards(currentState,shardRoutingsToBeApplied,true);
    if (result.changed()) {
      maybeUpdatedState=ClusterState.builder(currentState).routingResult(result).build();
    }
    builder.successes(tasks);
  }
 catch (  Throwable t) {
    builder.failures(tasks,t);
  }
  return builder.build(maybeUpdatedState);
}
