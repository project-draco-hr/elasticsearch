{
  BatchResult.Builder<ShardRoutingEntry> builder=BatchResult.builder();
  ClusterState accumulator=ClusterState.builder(currentState).build();
  for (  ShardRoutingEntry task : tasks) {
    task.processed=true;
    try {
      RoutingAllocation.Result result=allocationService.applyStartedShard(currentState,task.shardRouting,true);
      builder.success(task);
      if (result.changed()) {
        accumulator=ClusterState.builder(accumulator).routingResult(result).build();
      }
    }
 catch (    Throwable t) {
      builder.failure(task,t);
    }
  }
  return builder.build(accumulator);
}
