{
  DiscoveryNode masterNode=observer.observedState().nodes().masterNode();
  if (masterNode == null) {
    logger.warn("{} no master known to fail shard [{}]",shardRoutingEntry.getShardRouting().shardId(),shardRoutingEntry.getShardRouting());
    waitForNewMasterAndRetry(observer,shardRoutingEntry,listener);
  }
 else {
    transportService.sendRequest(masterNode,SHARD_FAILED_ACTION_NAME,shardRoutingEntry,new EmptyTransportResponseHandler(ThreadPool.Names.SAME){
      @Override public void handleResponse(      TransportResponse.Empty response){
        listener.onSuccess();
      }
      @Override public void handleException(      TransportException exp){
        if (isMasterChannelException(exp.getCause())) {
          waitForNewMasterAndRetry(observer,shardRoutingEntry,listener);
        }
 else {
          logger.warn("{} unexpected failure while sending request to [{}] to fail shard [{}]",exp,shardRoutingEntry.getShardRouting().shardId(),masterNode,shardRoutingEntry);
          listener.onShardFailedFailure(exp);
        }
      }
    }
);
  }
}
