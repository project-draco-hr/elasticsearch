{
  if (valuesSource instanceof BytesValuesSource) {
    return new StringTermsAggregator(name,factories,valuesSource,order,requiredSize,shardSize,aggregationContext,parent);
  }
  if (valuesSource instanceof NumericValuesSource) {
    if (((NumericValuesSource)valuesSource).isFloatingPoint()) {
      return new DoubleTermsAggregator(name,factories,(NumericValuesSource)valuesSource,order,requiredSize,shardSize,aggregationContext,parent);
    }
    return new LongTermsAggregator(name,factories,(NumericValuesSource)valuesSource,order,requiredSize,shardSize,aggregationContext,parent);
  }
  throw new AggregationExecutionException("terms aggregation cannot be applied to field [" + valuesSourceConfig.fieldContext().field() + "]. It can only be applied to numeric or string fields.");
}
