{
  setupNode();
  ClusterState state=client().admin().cluster().prepareState().get().getState();
  assertThat(state.metaData().indices().size(),equalTo(1));
  assertThat(state.metaData().indices().get(INDEX_NAME),notNullValue());
  assertThat(state.metaData().indices().get(INDEX_NAME).getCreationVersion(),equalTo(Version.V_2_0_0));
  assertThat(state.metaData().indices().get(INDEX_NAME).getUpgradedVersion(),equalTo(Version.CURRENT));
  assertThat(state.metaData().indices().get(INDEX_NAME).getMappings().size(),equalTo(2));
  assertThat(state.metaData().indices().get(INDEX_NAME).getMappings().get(".percolator"),notNullValue());
  MappingMetaData mappingMetaData=state.metaData().indices().get(INDEX_NAME).getMappings().get(".percolator");
  assertThat(XContentMapValues.extractValue("properties.query.type",mappingMetaData.sourceAsMap()),equalTo("object"));
  assertThat(state.metaData().indices().get(INDEX_NAME).getMappings().get("message"),notNullValue());
  SearchResponse searchResponse=client().prepareSearch(INDEX_NAME).setTypes(".percolator").addSort("_uid",SortOrder.ASC).get();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(4L));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("3"));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("4"));
  assertThat(XContentMapValues.extractValue("query.script.script.inline",searchResponse.getHits().getAt(3).sourceAsMap()),equalTo("return true"));
  assertThat(XContentMapValues.extractValue("query.script.script.lang",searchResponse.getHits().getAt(3).sourceAsMap()),nullValue());
  PercolateResponse percolateResponse=preparePercolate(client()).setIndices(INDEX_NAME).setDocumentType("message").setPercolateDoc(new PercolateSourceBuilder.DocBuilder().setDoc("{}")).get();
  assertThat(percolateResponse.getCount(),equalTo(1L));
  assertThat(percolateResponse.getMatches().length,equalTo(1));
  assertThat(percolateResponse.getMatches()[0].getId().string(),equalTo("4"));
  percolateResponse=preparePercolate(client()).setIndices(INDEX_NAME).setDocumentType("message").setPercolateDoc(new PercolateSourceBuilder.DocBuilder().setDoc("message","the quick brown fox jumps over the lazy dog")).get();
  assertThat(percolateResponse.getCount(),equalTo(3L));
  assertThat(percolateResponse.getMatches().length,equalTo(3));
  assertThat(percolateResponse.getMatches()[0].getId().string(),equalTo("1"));
  assertThat(percolateResponse.getMatches()[1].getId().string(),equalTo("2"));
  assertThat(percolateResponse.getMatches()[2].getId().string(),equalTo("4"));
  client().prepareIndex(INDEX_NAME,".percolator","5").setSource(jsonBuilder().startObject().field("query",matchQuery("message","fox jumps")).endObject()).get();
  refresh();
  percolateResponse=preparePercolate(client()).setIndices(INDEX_NAME).setDocumentType("message").setPercolateDoc(new PercolateSourceBuilder.DocBuilder().setDoc("message","the quick brown fox jumps over the lazy dog")).get();
  assertThat(percolateResponse.getCount(),equalTo(4L));
  assertThat(percolateResponse.getMatches().length,equalTo(4));
  assertThat(percolateResponse.getMatches()[0].getId().string(),equalTo("1"));
  assertThat(percolateResponse.getMatches()[1].getId().string(),equalTo("2"));
  assertThat(percolateResponse.getMatches()[2].getId().string(),equalTo("4"));
}
