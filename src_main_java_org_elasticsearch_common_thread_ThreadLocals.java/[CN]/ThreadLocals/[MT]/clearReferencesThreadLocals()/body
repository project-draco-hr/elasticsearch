{
  try {
    Thread[] threads=getThreads();
    Field threadLocalsField=Thread.class.getDeclaredField("threadLocals");
    threadLocalsField.setAccessible(true);
    Field inheritableThreadLocalsField=Thread.class.getDeclaredField("inheritableThreadLocals");
    inheritableThreadLocalsField.setAccessible(true);
    Class<?> tlmClass=Class.forName("java.lang.ThreadLocal$ThreadLocalMap");
    Field tableField=tlmClass.getDeclaredField("table");
    tableField.setAccessible(true);
    for (int i=0; i < threads.length; i++) {
      Object threadLocalMap;
      if (threads[i] != null) {
        threadLocalMap=threadLocalsField.get(threads[i]);
        clearThreadLocalMap(threadLocalMap,tableField);
        threadLocalMap=inheritableThreadLocalsField.get(threads[i]);
        clearThreadLocalMap(threadLocalMap,tableField);
      }
    }
  }
 catch (  Exception e) {
    logger.warn("Failed to clean thread locals",e);
  }
}
