{
  Compressor compressor=CompressorFactory.compressor(source);
  if (compressor != null) {
    InputStream compressedStreamInput=compressor.streamInput(source.streamInput());
    if (compressedStreamInput.markSupported() == false) {
      compressedStreamInput=new BufferedInputStream(compressedStreamInput);
    }
    XContentType contentType=XContentFactory.xContentType(compressedStreamInput);
    if (contentType == rawBuilder.contentType()) {
      Streams.copy(compressedStreamInput,rawBuilder.stream());
    }
 else {
      try (XContentParser parser=XContentFactory.xContent(contentType).createParser(compressedStreamInput)){
        parser.nextToken();
        rawBuilder.copyCurrentStructure(parser);
      }
     }
  }
 else {
    XContentType contentType=XContentFactory.xContentType(source);
    if (contentType == rawBuilder.contentType()) {
      source.writeTo(rawBuilder.stream());
    }
 else {
      try (XContentParser parser=XContentFactory.xContent(contentType).createParser(source)){
        parser.nextToken();
        rawBuilder.copyCurrentStructure(parser);
      }
     }
  }
}
