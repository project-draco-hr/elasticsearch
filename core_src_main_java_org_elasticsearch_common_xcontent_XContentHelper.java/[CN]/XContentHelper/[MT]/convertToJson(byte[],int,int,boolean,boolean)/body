{
  XContentType xContentType=XContentFactory.xContentType(data,offset,length);
  if (xContentType == XContentType.JSON && !reformatJson) {
    return new String(data,offset,length,StandardCharsets.UTF_8);
  }
  try (XContentParser parser=XContentFactory.xContent(xContentType).createParser(data,offset,length)){
    parser.nextToken();
    XContentBuilder builder=XContentFactory.jsonBuilder();
    if (prettyPrint) {
      builder.prettyPrint();
    }
    builder.copyCurrentStructure(parser);
    return builder.string();
  }
 }
