{
  XContentType xContentType=XContentFactory.xContentType(data,offset,length);
  if (xContentType == XContentType.JSON && !reformatJson) {
    return new String(data,offset,length,Charsets.UTF_8);
  }
  XContentParser parser=null;
  try {
    parser=XContentFactory.xContent(xContentType).createParser(data,offset,length);
    parser.nextToken();
    XContentBuilder builder=XContentFactory.jsonBuilder();
    if (prettyPrint) {
      builder.prettyPrint();
    }
    builder.copyCurrentStructure(parser);
    return builder.string();
  }
  finally {
    if (parser != null) {
      parser.close();
    }
  }
}
