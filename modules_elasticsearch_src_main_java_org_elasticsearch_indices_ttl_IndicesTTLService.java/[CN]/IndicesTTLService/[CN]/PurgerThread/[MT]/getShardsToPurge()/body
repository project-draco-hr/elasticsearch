{
  List<IndexShard> shardsToPurge=new ArrayList<IndexShard>();
  for (  IndexService indexService : indicesService) {
    FieldMappers ttlFieldMappers=indexService.mapperService().name(TTLFieldMapper.NAME);
    boolean hasTTLEnabled=false;
    for (    FieldMapper ttlFieldMapper : ttlFieldMappers) {
      if (((TTLFieldMapper)ttlFieldMapper).enabled()) {
        hasTTLEnabled=true;
        break;
      }
    }
    if (hasTTLEnabled) {
      for (      Integer shardId : indexService.shardIds()) {
        IndexShard shard=indexService.shard(shardId);
        if (shard.routingEntry().primary() && shard.state() == IndexShardState.STARTED && shard.routingEntry().started()) {
          shardsToPurge.add(shard);
        }
      }
    }
  }
  return shardsToPurge;
}
