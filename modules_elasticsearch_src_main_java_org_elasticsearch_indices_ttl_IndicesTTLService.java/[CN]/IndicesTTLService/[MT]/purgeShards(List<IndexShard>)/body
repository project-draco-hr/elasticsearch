{
  for (  IndexShard shardToPurge : shardsToPurge) {
    Query query=NumericRangeQuery.newLongRange(TTLFieldMapper.NAME,null,System.currentTimeMillis(),false,true);
    Engine.Searcher searcher=shardToPurge.searcher();
    try {
      logger.debug("[{}][{}] purging shard",shardToPurge.routingEntry().index(),shardToPurge.routingEntry().id());
      ExpiredDocsCollector expiredDocsCollector=new ExpiredDocsCollector();
      searcher.searcher().search(query,expiredDocsCollector);
      List<DocToPurge> docsToPurge=expiredDocsCollector.getDocsToPurge();
      bulkRequest=client.prepareBulk();
      for (      DocToPurge docToPurge : docsToPurge) {
        bulkRequest.add(new DeleteRequest().index(shardToPurge.routingEntry().index()).type(docToPurge.type).id(docToPurge.id).version(docToPurge.version));
        processBulkIfNeeded(false);
      }
      processBulkIfNeeded(true);
    }
 catch (    Exception e) {
      logger.warn("failed to purge",e);
    }
 finally {
      searcher.release();
    }
  }
}
