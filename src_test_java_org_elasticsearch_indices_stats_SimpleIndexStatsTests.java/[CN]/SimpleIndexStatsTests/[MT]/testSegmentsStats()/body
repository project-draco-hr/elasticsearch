{
  assertAcked(prepareCreate("test1",2,settingsBuilder().put(SETTING_NUMBER_OF_REPLICAS,between(0,1))));
  ensureGreen();
  NumShards test1=getNumShards("test1");
  for (int i=0; i < 20; i++) {
    index("test1","type1",Integer.toString(i),"field","value");
    index("test1","type2",Integer.toString(i),"field","value");
    client().admin().indices().prepareFlush().get();
  }
  client().admin().indices().prepareOptimize().setWaitForMerge(true).setMaxNumSegments(1).execute().actionGet();
  IndicesStatsResponse stats=client().admin().indices().prepareStats().setSegments(true).get();
  assertThat(stats.getTotal().getSegments(),notNullValue());
  assertThat(stats.getTotal().getSegments().getCount(),equalTo((long)test1.totalNumShards));
  assumeTrue(org.elasticsearch.Version.CURRENT.luceneVersion != Version.LUCENE_46);
  assertThat(stats.getTotal().getSegments().getMemoryInBytes(),greaterThan(0l));
}
