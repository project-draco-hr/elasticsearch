{
  prepareCreate("test1",2).setSettings("index.number_of_shards",5,"index.number_of_replicas",1).get();
  ClusterHealthResponse clusterHealthResponse=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().get();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  for (int i=0; i < 20; i++) {
    index("test1","type1",Integer.toString(i),"field","value");
    index("test1","type2",Integer.toString(i),"field","value");
    client().admin().indices().prepareFlush().get();
  }
  client().admin().indices().prepareOptimize().setWaitForMerge(true).setMaxNumSegments(1).execute().actionGet();
  IndicesStatsResponse stats=client().admin().indices().prepareStats().setSegments(true).get();
  assertThat(stats.getTotal().getSegments(),notNullValue());
  assertThat(stats.getTotal().getSegments().getCount(),equalTo(10l));
}
