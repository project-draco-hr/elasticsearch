{
  Compressor compressor=CompressorFactory.compressor(request.bytes());
  StreamInput in;
  if (compressor != null) {
    in=CachedStreamInput.cachedHandlesCompressed(compressor,request.bytes().streamInput());
  }
 else {
    in=CachedStreamInput.cachedHandles(request.bytes().streamInput());
  }
  in.setVersion(request.version());
  ClusterState clusterState=ClusterState.Builder.readFrom(in,nodesProvider.nodes().localNode(),clusterName);
  clusterState.status(ClusterState.ClusterStateStatus.RECEIVED);
  logger.debug("received cluster state version {}",clusterState.version());
  listener.onNewClusterState(clusterState,new NewClusterStateListener.NewStateProcessed(){
    @Override public void onNewClusterStateProcessed(){
      try {
        channel.sendResponse(TransportResponse.Empty.INSTANCE);
      }
 catch (      Throwable e) {
        logger.debug("failed to send response on cluster state processed",e);
      }
    }
    @Override public void onNewClusterStateFailed(    Throwable t){
      try {
        channel.sendResponse(t);
      }
 catch (      Throwable e) {
        logger.debug("failed to send response on cluster state processed",e);
      }
    }
  }
);
}
