{
  DiscoveryNode localNode=nodesProvider.nodes().localNode();
  Map<Version,BytesReference> serializedStates=Maps.newHashMap();
  for (  final DiscoveryNode node : clusterState.nodes()) {
    if (node.equals(localNode)) {
      continue;
    }
    BytesReference bytes=serializedStates.get(node.version());
    if (bytes == null) {
      try {
        BytesStreamOutput bStream=new BytesStreamOutput();
        StreamOutput stream=new HandlesStreamOutput(CompressorFactory.defaultCompressor().streamOutput(bStream));
        stream.setVersion(node.version());
        ClusterState.Builder.writeTo(clusterState,stream);
        stream.close();
        bytes=bStream.bytes();
        serializedStates.put(node.version(),bytes);
      }
 catch (      Exception e) {
        logger.warn("failed to serialize cluster_state before publishing it to nodes",e);
        return;
      }
    }
    transportService.sendRequest(node,PublishClusterStateRequestHandler.ACTION,new PublishClusterStateRequest(bytes),TransportRequestOptions.options().withHighType().withCompress(false),new EmptyTransportResponseHandler(ThreadPool.Names.SAME){
      @Override public void handleException(      TransportException exp){
        logger.debug("failed to send cluster state to [{}], should be detected as failed soon...",exp,node);
      }
    }
);
  }
}
