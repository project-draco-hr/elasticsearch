{
  DiscoveryNode localNode=nodesProvider.nodes().localNode();
  CachedStreamOutput.Entry cachedEntry=CachedStreamOutput.popEntry();
  byte[] clusterStateInBytes;
  try {
    HandlesStreamOutput stream=cachedEntry.cachedHandlesLzfBytes();
    ClusterState.Builder.writeTo(clusterState,stream);
    stream.flush();
    clusterStateInBytes=cachedEntry.bytes().copiedByteArray();
  }
 catch (  Exception e) {
    logger.warn("failed to serialize cluster_state before publishing it to nodes",e);
    return;
  }
 finally {
    CachedStreamOutput.pushEntry(cachedEntry);
  }
  for (  final DiscoveryNode node : clusterState.nodes()) {
    if (node.equals(localNode)) {
      continue;
    }
    transportService.sendRequest(node,PublishClusterStateRequestHandler.ACTION,new PublishClusterStateRequest(clusterStateInBytes),TransportRequestOptions.options().withHighType().withCompress(false),new VoidTransportResponseHandler(ThreadPool.Names.SAME){
      @Override public void handleException(      TransportException exp){
        logger.debug("failed to send cluster state to [{}], should be detected as failed soon...",exp,node);
      }
    }
);
  }
}
