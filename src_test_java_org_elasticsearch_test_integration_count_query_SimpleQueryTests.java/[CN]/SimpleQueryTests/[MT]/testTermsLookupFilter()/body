{
  createIndexMapped("lookup","type","terms","string","other","string");
  createIndexMapped("lookup2","type","term","string");
  createIndexMapped("test","type","term","string");
  ensureGreen();
  client().prepareIndex("lookup","type","1").setSource("terms",new String[]{"1","3"}).execute().actionGet();
  client().prepareIndex("lookup","type","2").setSource("terms",new String[]{"2"}).execute().actionGet();
  client().prepareIndex("lookup","type","3").setSource("terms",new String[]{"2","4"}).execute().actionGet();
  client().prepareIndex("lookup","type","4").setSource("other","value").execute().actionGet();
  client().prepareIndex("lookup2","type","1").setSource(XContentFactory.jsonBuilder().startObject().startArray("arr").startObject().field("term","1").endObject().startObject().field("term","3").endObject().endArray().endObject()).execute().actionGet();
  client().prepareIndex("lookup2","type","2").setSource(XContentFactory.jsonBuilder().startObject().startArray("arr").startObject().field("term","2").endObject().endArray().endObject()).execute().actionGet();
  client().prepareIndex("lookup2","type","3").setSource(XContentFactory.jsonBuilder().startObject().startArray("arr").startObject().field("term","2").endObject().startObject().field("term","4").endObject().endArray().endObject()).execute().actionGet();
  client().prepareIndex("test","type","1").setSource("term","1").execute().actionGet();
  client().prepareIndex("test","type","2").setSource("term","2").execute().actionGet();
  client().prepareIndex("test","type","3").setSource("term","3").execute().actionGet();
  client().prepareIndex("test","type","4").setSource("term","4").execute().actionGet();
  refresh();
  CountResponse countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup").lookupType("type").lookupId("1").lookupPath("terms"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,2l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("_id").lookupIndex("lookup").lookupType("type").lookupId("1").lookupPath("terms"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,2l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup").lookupType("type").lookupId("1").lookupPath("terms"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,2l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup").lookupType("type").lookupId("2").lookupPath("terms"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,1l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup").lookupType("type").lookupId("3").lookupPath("terms"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,2l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup").lookupType("type").lookupId("4").lookupPath("terms"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,0l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup2").lookupType("type").lookupId("1").lookupPath("arr.term"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,2l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup2").lookupType("type").lookupId("2").lookupPath("arr.term"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,1l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("term").lookupIndex("lookup2").lookupType("type").lookupId("3").lookupPath("arr.term"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,2l);
  countResponse=client().prepareCount("test").setQuery(filteredQuery(matchAllQuery(),termsLookupFilter("not_exists").lookupIndex("lookup2").lookupType("type").lookupId("3").lookupPath("arr.term"))).execute().actionGet();
  assertNoFailures(countResponse);
  assertHitCount(countResponse,0l);
}
