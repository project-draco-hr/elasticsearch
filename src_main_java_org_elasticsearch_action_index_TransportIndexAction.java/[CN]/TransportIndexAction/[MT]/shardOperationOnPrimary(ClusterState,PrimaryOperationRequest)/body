{
  final IndexRequest request=shardRequest.request;
  MappingMetaData mappingMd=clusterState.metaData().index(request.getIndex()).mappingOrDefault(request.getType());
  if (mappingMd != null && mappingMd.routing().required()) {
    if (request.getRouting() == null) {
      throw new RoutingMissingException(request.getIndex(),request.getType(),request.getId());
    }
  }
  IndexShard indexShard=indicesService.indexServiceSafe(shardRequest.request.getIndex()).shardSafe(shardRequest.shardId);
  SourceToParse sourceToParse=SourceToParse.source(request.getSource()).type(request.getType()).id(request.getId()).routing(request.getRouting()).parent(request.getParent()).timestamp(request.getTimestamp()).ttl(request.getTtl());
  long version;
  Engine.IndexingOperation op;
  if (request.getOpType() == IndexRequest.OpType.INDEX) {
    Engine.Index index=indexShard.prepareIndex(sourceToParse).version(request.getVersion()).versionType(request.getVersionType()).origin(Engine.Operation.Origin.PRIMARY);
    indexShard.index(index);
    version=index.version();
    op=index;
  }
 else {
    Engine.Create create=indexShard.prepareCreate(sourceToParse).version(request.getVersion()).versionType(request.getVersionType()).origin(Engine.Operation.Origin.PRIMARY);
    indexShard.create(create);
    version=create.version();
    op=create;
  }
  if (request.isRefresh()) {
    try {
      indexShard.refresh(new Engine.Refresh(false));
    }
 catch (    Exception e) {
    }
  }
  if (op.parsedDoc().mappingsModified()) {
    updateMappingOnMaster(request);
  }
  request.setVersion(version);
  IndexResponse response=new IndexResponse(request.getIndex(),request.getType(),request.getId(),version);
  return new PrimaryResponse<IndexResponse,IndexRequest>(shardRequest.request,response,op);
}
