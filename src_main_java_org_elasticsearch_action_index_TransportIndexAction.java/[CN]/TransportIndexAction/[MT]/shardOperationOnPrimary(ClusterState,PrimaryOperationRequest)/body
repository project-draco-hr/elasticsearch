{
  final IndexRequest request=shardRequest.request;
  IndexMetaData indexMetaData=clusterState.metaData().index(shardRequest.shardId.getIndex());
  MappingMetaData mappingMd=indexMetaData.mappingOrDefault(request.type());
  if (mappingMd != null && mappingMd.routing().required()) {
    if (request.routing() == null) {
      throw new RoutingMissingException(shardRequest.shardId.getIndex(),request.type(),request.id());
    }
  }
  IndexService indexService=indicesService.indexServiceSafe(shardRequest.shardId.getIndex());
  IndexShard indexShard=indexService.shardSafe(shardRequest.shardId.id());
  final IndexResponse response=executeIndexRequestOnPrimary(null,request,indexShard);
  if (request.refresh()) {
    try {
      indexShard.refresh("refresh_flag_index");
    }
 catch (    Throwable e) {
    }
  }
  return new Tuple<>(response,shardRequest.request);
}
