{
  final AtomicBoolean denied=new AtomicBoolean();
  final SecurityManager sm=System.getSecurityManager();
  try {
    System.setSecurityManager(new SecurityManager(){
      @Override public void checkPermission(      Permission perm){
        if (perm instanceof RuntimePermission && "setSecurityManager".equals(perm.getName())) {
          return;
        }
        if (perm instanceof MBeanServerPermission && "createMBeanServer".equals(perm.getName())) {
          denied.set(true);
          throw new AccessControlException("denied");
        }
        super.checkPermission(perm);
      }
      @Override public void checkPropertyAccess(      String key){
        if ("log4j2.disable.jmx".equals(key)) {
          return;
        }
        super.checkPropertyAccess(key);
      }
    }
);
    LoggerContext context=(LoggerContext)LogManager.getContext(false);
    Configurator.shutdown(context);
    assertFalse(denied.get());
  }
  finally {
    System.setSecurityManager(sm);
  }
}
