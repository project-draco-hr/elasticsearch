{
  int docId=scorer.docID();
  double factor=1.0f;
  if (scoreMode == ScoreMode.First) {
    for (int i=0; i < filterFunctions.length; i++) {
      if (docSets[i].get(docId)) {
        factor=filterFunctions[i].function.factor(docId);
        break;
      }
    }
  }
 else   if (scoreMode == ScoreMode.Max) {
    double maxFactor=Double.NEGATIVE_INFINITY;
    for (int i=0; i < filterFunctions.length; i++) {
      if (docSets[i].get(docId)) {
        maxFactor=Math.max(filterFunctions[i].function.factor(docId),maxFactor);
      }
    }
    if (maxFactor != Float.NEGATIVE_INFINITY) {
      factor=maxFactor;
    }
  }
 else   if (scoreMode == ScoreMode.Min) {
    double minFactor=Double.POSITIVE_INFINITY;
    for (int i=0; i < filterFunctions.length; i++) {
      if (docSets[i].get(docId)) {
        minFactor=Math.min(filterFunctions[i].function.factor(docId),minFactor);
      }
    }
    if (minFactor != Float.POSITIVE_INFINITY) {
      factor=minFactor;
    }
  }
 else   if (scoreMode == ScoreMode.Multiply) {
    for (int i=0; i < filterFunctions.length; i++) {
      if (docSets[i].get(docId)) {
        factor*=filterFunctions[i].function.factor(docId);
      }
    }
  }
 else {
    double totalFactor=0.0f;
    int count=0;
    for (int i=0; i < filterFunctions.length; i++) {
      if (docSets[i].get(docId)) {
        totalFactor+=filterFunctions[i].function.factor(docId);
        count++;
      }
    }
    if (count != 0) {
      factor=totalFactor;
      if (scoreMode == ScoreMode.Avg) {
        factor/=count;
      }
    }
  }
  if (factor > maxBoost) {
    factor=maxBoost;
  }
  float score=scorer.score();
  return (float)(subQueryBoost * score * factor);
}
