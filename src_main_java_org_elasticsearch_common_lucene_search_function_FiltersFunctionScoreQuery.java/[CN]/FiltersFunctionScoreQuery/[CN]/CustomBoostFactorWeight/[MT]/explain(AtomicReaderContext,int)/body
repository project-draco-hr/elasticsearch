{
  Explanation subQueryExpl=subQueryWeight.explain(context,doc);
  if (!subQueryExpl.isMatch()) {
    return subQueryExpl;
  }
  if (scoreMode == ScoreMode.First) {
    for (    FilterFunction filterFunction : filterFunctions) {
      DocSet docSet=DocSets.convert(context.reader(),filterFunction.filter.getDocIdSet(context,context.reader().getLiveDocs()));
      if (docSet.get(doc)) {
        filterFunction.function.setNextReader(context);
        Explanation functionExplanation=filterFunction.function.explainFactor(doc);
        float sc=getBoost() * subQueryExpl.getValue() * functionExplanation.getValue();
        Explanation filterExplanation=new ComplexExplanation(true,sc,"custom score, product of:");
        filterExplanation.addDetail(new Explanation(1.0f,"match filter: " + filterFunction.filter.toString()));
        filterExplanation.addDetail(functionExplanation);
        filterExplanation.addDetail(new Explanation(getBoost(),"queryBoost"));
        float topLevelScore=subQueryExpl.getValue() * sc;
        Explanation topLevel=new ComplexExplanation(true,topLevelScore,"custom score, score mode [" + scoreMode.toString().toLowerCase() + "]");
        topLevel.addDetail(subQueryExpl);
        topLevel.addDetail(filterExplanation);
        return topLevel;
      }
    }
  }
 else {
    int count=0;
    float total=0;
    float multiply=1;
    float max=Float.NEGATIVE_INFINITY;
    float min=Float.POSITIVE_INFINITY;
    ArrayList<Explanation> filtersExplanations=new ArrayList<Explanation>();
    for (    FilterFunction filterFunction : filterFunctions) {
      DocSet docSet=DocSets.convert(context.reader(),filterFunction.filter.getDocIdSet(context,context.reader().getLiveDocs()));
      if (docSet.get(doc)) {
        filterFunction.function.setNextReader(context);
        Explanation functionExplanation=filterFunction.function.explainFactor(doc);
        float factor=functionExplanation.getValue();
        count++;
        total+=factor;
        multiply*=factor;
        max=Math.max(factor,max);
        min=Math.min(factor,min);
        Explanation res=new ComplexExplanation(true,factor,"custom score, product of:");
        res.addDetail(new Explanation(1.0f,"match filter: " + filterFunction.filter.toString()));
        res.addDetail(functionExplanation);
        res.addDetail(new Explanation(getBoost(),"queryBoost"));
        filtersExplanations.add(res);
      }
    }
    if (count > 0) {
      float factor=0;
switch (scoreMode) {
case Avg:
        factor=total / count;
      break;
case Max:
    factor=max;
  break;
case Min:
factor=min;
break;
case Total:
factor=total;
break;
case Multiply:
factor=multiply;
break;
}
if (factor > maxBoost) {
factor=maxBoost;
}
float sc=factor * subQueryExpl.getValue() * getBoost();
Explanation res=new ComplexExplanation(true,sc,"custom score, score mode [" + scoreMode.toString().toLowerCase() + "]");
res.addDetail(subQueryExpl);
for (Explanation explanation : filtersExplanations) {
res.addDetail(explanation);
}
return res;
}
}
float sc=getBoost() * subQueryExpl.getValue();
Explanation res=new ComplexExplanation(true,sc,"custom score, no filter match, product of:");
res.addDetail(subQueryExpl);
res.addDetail(new Explanation(getBoost(),"queryBoost"));
return res;
}
