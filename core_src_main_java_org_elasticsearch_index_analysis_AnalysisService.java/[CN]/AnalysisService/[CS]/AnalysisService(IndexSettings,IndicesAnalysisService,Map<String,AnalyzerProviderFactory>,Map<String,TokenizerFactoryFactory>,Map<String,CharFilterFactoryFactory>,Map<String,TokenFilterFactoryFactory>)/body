{
  super(indexSettings);
  Settings defaultSettings=Settings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,indexSettings.getIndexVersionCreated()).build();
  Map<String,TokenizerFactory> tokenizers=new HashMap<>();
  if (tokenizerFactoryFactories != null) {
    Map<String,Settings> tokenizersSettings=this.indexSettings.getSettings().getGroups("index.analysis.tokenizer");
    for (    Map.Entry<String,TokenizerFactoryFactory> entry : tokenizerFactoryFactories.entrySet()) {
      String tokenizerName=entry.getKey();
      TokenizerFactoryFactory tokenizerFactoryFactory=entry.getValue();
      Settings tokenizerSettings=tokenizersSettings.get(tokenizerName);
      if (tokenizerSettings == null) {
        tokenizerSettings=defaultSettings;
      }
      TokenizerFactory tokenizerFactory=tokenizerFactoryFactory.create(tokenizerName,tokenizerSettings);
      tokenizers.put(tokenizerName,tokenizerFactory);
      tokenizers.put(Strings.toCamelCase(tokenizerName),tokenizerFactory);
    }
  }
  if (indicesAnalysisService != null) {
    for (    Map.Entry<String,PreBuiltTokenizerFactoryFactory> entry : indicesAnalysisService.tokenizerFactories().entrySet()) {
      String name=entry.getKey();
      if (!tokenizers.containsKey(name)) {
        tokenizers.put(name,entry.getValue().create(name,defaultSettings));
      }
      name=Strings.toCamelCase(entry.getKey());
      if (!name.equals(entry.getKey())) {
        if (!tokenizers.containsKey(name)) {
          tokenizers.put(name,entry.getValue().create(name,defaultSettings));
        }
      }
    }
  }
  this.tokenizers=unmodifiableMap(tokenizers);
  Map<String,CharFilterFactory> charFilters=new HashMap<>();
  if (charFilterFactoryFactories != null) {
    Map<String,Settings> charFiltersSettings=this.indexSettings.getSettings().getGroups("index.analysis.char_filter");
    for (    Map.Entry<String,CharFilterFactoryFactory> entry : charFilterFactoryFactories.entrySet()) {
      String charFilterName=entry.getKey();
      CharFilterFactoryFactory charFilterFactoryFactory=entry.getValue();
      Settings charFilterSettings=charFiltersSettings.get(charFilterName);
      if (charFilterSettings == null) {
        charFilterSettings=defaultSettings;
      }
      CharFilterFactory tokenFilterFactory=charFilterFactoryFactory.create(charFilterName,charFilterSettings);
      charFilters.put(charFilterName,tokenFilterFactory);
      charFilters.put(Strings.toCamelCase(charFilterName),tokenFilterFactory);
    }
  }
  if (indicesAnalysisService != null) {
    for (    Map.Entry<String,PreBuiltCharFilterFactoryFactory> entry : indicesAnalysisService.charFilterFactories().entrySet()) {
      String name=entry.getKey();
      if (!charFilters.containsKey(name)) {
        charFilters.put(name,entry.getValue().create(name,defaultSettings));
      }
      name=Strings.toCamelCase(entry.getKey());
      if (!name.equals(entry.getKey())) {
        if (!charFilters.containsKey(name)) {
          charFilters.put(name,entry.getValue().create(name,defaultSettings));
        }
      }
    }
  }
  this.charFilters=unmodifiableMap(charFilters);
  Map<String,TokenFilterFactory> tokenFilters=new HashMap<>();
  if (tokenFilterFactoryFactories != null) {
    Map<String,Settings> tokenFiltersSettings=this.indexSettings.getSettings().getGroups("index.analysis.filter");
    for (    Map.Entry<String,TokenFilterFactoryFactory> entry : tokenFilterFactoryFactories.entrySet()) {
      String tokenFilterName=entry.getKey();
      TokenFilterFactoryFactory tokenFilterFactoryFactory=entry.getValue();
      Settings tokenFilterSettings=tokenFiltersSettings.get(tokenFilterName);
      if (tokenFilterSettings == null) {
        tokenFilterSettings=defaultSettings;
      }
      TokenFilterFactory tokenFilterFactory=tokenFilterFactoryFactory.create(tokenFilterName,tokenFilterSettings);
      tokenFilters.put(tokenFilterName,tokenFilterFactory);
      tokenFilters.put(Strings.toCamelCase(tokenFilterName),tokenFilterFactory);
    }
  }
  if (indicesAnalysisService != null) {
    for (    Map.Entry<String,PreBuiltTokenFilterFactoryFactory> entry : indicesAnalysisService.tokenFilterFactories().entrySet()) {
      String name=entry.getKey();
      if (!tokenFilters.containsKey(name)) {
        tokenFilters.put(name,entry.getValue().create(name,defaultSettings));
      }
      name=Strings.toCamelCase(entry.getKey());
      if (!name.equals(entry.getKey())) {
        if (!tokenFilters.containsKey(name)) {
          tokenFilters.put(name,entry.getValue().create(name,defaultSettings));
        }
      }
    }
  }
  this.tokenFilters=unmodifiableMap(tokenFilters);
  Map<String,AnalyzerProvider> analyzerProviders=new HashMap<>();
  if (analyzerFactoryFactories != null) {
    Map<String,Settings> analyzersSettings=this.indexSettings.getSettings().getGroups("index.analysis.analyzer");
    for (    Map.Entry<String,AnalyzerProviderFactory> entry : analyzerFactoryFactories.entrySet()) {
      String analyzerName=entry.getKey();
      AnalyzerProviderFactory analyzerFactoryFactory=entry.getValue();
      Settings analyzerSettings=analyzersSettings.get(analyzerName);
      if (analyzerSettings == null) {
        analyzerSettings=defaultSettings;
      }
      AnalyzerProvider analyzerFactory=analyzerFactoryFactory.create(analyzerName,analyzerSettings);
      analyzerProviders.put(analyzerName,analyzerFactory);
    }
  }
  if (indicesAnalysisService != null) {
    for (    Map.Entry<String,PreBuiltAnalyzerProviderFactory> entry : indicesAnalysisService.analyzerProviderFactories().entrySet()) {
      String name=entry.getKey();
      Version indexVersion=indexSettings.getIndexVersionCreated();
      if (!analyzerProviders.containsKey(name)) {
        analyzerProviders.put(name,entry.getValue().create(name,Settings.settingsBuilder().put(IndexMetaData.SETTING_VERSION_CREATED,indexVersion).build()));
      }
      String camelCaseName=Strings.toCamelCase(name);
      if (!camelCaseName.equals(entry.getKey()) && !analyzerProviders.containsKey(camelCaseName)) {
        analyzerProviders.put(camelCaseName,entry.getValue().create(name,Settings.settingsBuilder().put(IndexMetaData.SETTING_VERSION_CREATED,indexVersion).build()));
      }
    }
  }
  if (!analyzerProviders.containsKey("default")) {
    analyzerProviders.put("default",new StandardAnalyzerProvider(indexSettings,null,"default",Settings.Builder.EMPTY_SETTINGS));
  }
  if (!analyzerProviders.containsKey("default_index")) {
    analyzerProviders.put("default_index",analyzerProviders.get("default"));
  }
  if (!analyzerProviders.containsKey("default_search")) {
    analyzerProviders.put("default_search",analyzerProviders.get("default"));
  }
  if (!analyzerProviders.containsKey("default_search_quoted")) {
    analyzerProviders.put("default_search_quoted",analyzerProviders.get("default_search"));
  }
  Map<String,NamedAnalyzer> analyzers=new HashMap<>();
  for (  AnalyzerProvider analyzerFactory : analyzerProviders.values()) {
    int overridePositionIncrementGap=StringFieldMapper.Defaults.positionIncrementGap(indexSettings.getIndexVersionCreated());
    if (analyzerFactory instanceof CustomAnalyzerProvider) {
      ((CustomAnalyzerProvider)analyzerFactory).build(this);
      overridePositionIncrementGap=Integer.MIN_VALUE;
    }
    Analyzer analyzerF=analyzerFactory.get();
    if (analyzerF == null) {
      throw new IllegalArgumentException("analyzer [" + analyzerFactory.name() + "] created null analyzer");
    }
    NamedAnalyzer analyzer;
    if (analyzerF instanceof NamedAnalyzer) {
      analyzer=(NamedAnalyzer)analyzerF;
      if (overridePositionIncrementGap >= 0 && analyzer.getPositionIncrementGap(analyzer.name()) != overridePositionIncrementGap) {
        analyzer=new NamedAnalyzer(analyzer,overridePositionIncrementGap);
      }
    }
 else {
      analyzer=new NamedAnalyzer(analyzerFactory.name(),analyzerFactory.scope(),analyzerF,overridePositionIncrementGap);
    }
    analyzers.put(analyzerFactory.name(),analyzer);
    analyzers.put(Strings.toCamelCase(analyzerFactory.name()),analyzer);
    String strAliases=this.indexSettings.getSettings().get("index.analysis.analyzer." + analyzerFactory.name() + ".alias");
    if (strAliases != null) {
      for (      String alias : Strings.commaDelimitedListToStringArray(strAliases)) {
        analyzers.put(alias,analyzer);
      }
    }
    String[] aliases=this.indexSettings.getSettings().getAsArray("index.analysis.analyzer." + analyzerFactory.name() + ".alias");
    for (    String alias : aliases) {
      analyzers.put(alias,analyzer);
    }
  }
  NamedAnalyzer defaultAnalyzer=analyzers.get("default");
  if (defaultAnalyzer == null) {
    throw new IllegalArgumentException("no default analyzer configured");
  }
  if (analyzers.containsKey("default_index")) {
    final Version createdVersion=indexSettings.getIndexVersionCreated();
    if (createdVersion.onOrAfter(Version.V_3_0_0)) {
      throw new IllegalArgumentException("setting [index.analysis.analyzer.default_index] is not supported anymore, use [index.analysis.analyzer.default] instead for index [" + index().getName() + "]");
    }
 else {
      deprecationLogger.deprecated("setting [index.analysis.analyzer.default_index] is deprecated, use [index.analysis.analyzer.default] instead for index [{}]",index().getName());
    }
  }
  defaultIndexAnalyzer=analyzers.containsKey("default_index") ? analyzers.get("default_index") : defaultAnalyzer;
  defaultSearchAnalyzer=analyzers.containsKey("default_search") ? analyzers.get("default_search") : defaultAnalyzer;
  defaultSearchQuoteAnalyzer=analyzers.containsKey("default_search_quote") ? analyzers.get("default_search_quote") : defaultSearchAnalyzer;
  for (  Map.Entry<String,NamedAnalyzer> analyzer : analyzers.entrySet()) {
    if (analyzer.getKey().startsWith("_")) {
      throw new IllegalArgumentException("analyzer name must not start with '_'. got \"" + analyzer.getKey() + "\"");
    }
  }
  this.analyzers=unmodifiableMap(analyzers);
}
