{
  while (shardIt.hasNextActive()) {
    final ShardRouting shard=shardIt.nextActive();
    if (!shard.currentNodeId().equals(nodes.localNodeId())) {
      DiscoveryNode node=nodes.get(shard.currentNodeId());
      transportService.sendRequest(node,transportShardAction,new ShardSingleOperationRequest(request,shard.id()),new BaseTransportResponseHandler<Response>(){
        @Override public Response newInstance(){
          return newResponse();
        }
        @Override public String executor(){
          return ThreadPool.Names.SAME;
        }
        @Override public void handleResponse(        final Response response){
          if (request.listenerThreaded()) {
            threadPool.cached().execute(new Runnable(){
              @Override public void run(){
                listener.onResponse(response);
              }
            }
);
          }
 else {
            listener.onResponse(response);
          }
        }
        @Override public void handleException(        TransportException exp){
          onFailure(shard,exp);
        }
      }
);
      return;
    }
  }
  if (!shardIt.hasNextActive()) {
    Exception failure=lastException;
    if (failure == null) {
      failure=new NoShardAvailableActionException(shardIt.shardId(),"No shard available for [" + request.type() + "#"+ request.id()+ "]");
    }
 else {
      if (logger.isDebugEnabled()) {
        logger.debug(shardIt.shardId() + ": Failed to get [" + request.type()+ "#"+ request.id()+ "]",failure);
      }
    }
    if (request.listenerThreaded()) {
      final Exception fFailure=failure;
      threadPool.cached().execute(new Runnable(){
        @Override public void run(){
          listener.onFailure(fFailure);
        }
      }
);
    }
 else {
      listener.onFailure(failure);
    }
  }
}
