{
  while (shardIt.hasNextActive()) {
    final ShardRouting shard=shardIt.nextActive();
    if (shard.currentNodeId().equals(nodes.localNodeId())) {
      if (request.operationThreaded()) {
        threadPool.executor(executor).execute(new Runnable(){
          @Override public void run(){
            try {
              Response response=shardOperation(request,shard.id());
              listener.onResponse(response);
            }
 catch (            Exception e) {
              onFailure(shard,e);
            }
          }
        }
);
        return;
      }
 else {
        try {
          final Response response=shardOperation(request,shard.id());
          listener.onResponse(response);
          return;
        }
 catch (        Exception e) {
          onFailure(shard,e);
        }
      }
    }
  }
  if (!shardIt.hasNextActive()) {
    shardIt.reset();
    perform(null);
  }
}
