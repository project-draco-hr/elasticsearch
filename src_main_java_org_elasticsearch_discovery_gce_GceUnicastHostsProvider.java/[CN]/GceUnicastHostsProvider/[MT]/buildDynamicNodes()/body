{
  if (refreshInterval.millis() != 0) {
    if (cachedDiscoNodes != null && (refreshInterval.millis() < 0 || (System.currentTimeMillis() - lastRefresh) < refreshInterval.millis())) {
      if (logger.isTraceEnabled())       logger.trace("using cache to retrieve node list");
      return cachedDiscoNodes;
    }
    lastRefresh=System.currentTimeMillis();
  }
  logger.debug("start building nodes list using GCE API");
  cachedDiscoNodes=Lists.newArrayList();
  String ipAddress=null;
  try {
    InetAddress inetAddress=networkService.resolvePublishHostAddress(null);
    if (inetAddress != null) {
      ipAddress=inetAddress.getHostAddress();
    }
  }
 catch (  IOException e) {
  }
  try {
    Collection<Instance> instances=gceComputeService.instances();
    if (instances == null) {
      logger.trace("no instance found for project [{}], zone [{}].",this.project,this.zone);
      return cachedDiscoNodes;
    }
    for (    Instance instance : instances) {
      String name=instance.getName();
      String type=instance.getMachineType();
      String image=instance.getImage();
      String status=instance.getStatus();
      logger.trace("gce instance {} with status {} found.",name,status);
      if (Status.TERMINATED.equals(status)) {
        logger.debug("node {} is TERMINATED. Ignoring",name);
        continue;
      }
      boolean filterByTag=false;
      if (tags.length > 0) {
        logger.trace("start filtering instance {} with tags {}.",name,tags);
        if (instance.getTags() == null || instance.getTags().isEmpty()) {
          logger.trace("no tags for this instance but we asked for tags. {} won't be part of the cluster.",name);
          filterByTag=true;
        }
 else {
          logger.trace("comparing instance tags {} with tags filter {}.",instance.getTags().getItems(),tags);
          for (          String tag : tags) {
            boolean found=false;
            for (            String instancetag : instance.getTags().getItems()) {
              if (instancetag.equals(tag)) {
                found=true;
                break;
              }
            }
            if (!found) {
              filterByTag=true;
              break;
            }
          }
        }
      }
      if (filterByTag) {
        logger.trace("filtering out instance {} based tags {}, not part of {}",name,tags,instance.getTags() == null ? "" : instance.getTags().getItems());
        continue;
      }
 else {
        logger.trace("instance {} with tags {} is added to discovery",name,tags);
      }
      String ip_public=null;
      String ip_private=null;
      List<NetworkInterface> interfaces=instance.getNetworkInterfaces();
      for (      NetworkInterface networkInterface : interfaces) {
        if (ip_public == null) {
          if (networkInterface.getAccessConfigs() != null) {
            for (            AccessConfig accessConfig : networkInterface.getAccessConfigs()) {
              if (Strings.hasText(accessConfig.getNatIP())) {
                ip_public=accessConfig.getNatIP();
                break;
              }
            }
          }
        }
        if (ip_private == null) {
          ip_private=networkInterface.getNetworkIP();
        }
        if (ip_private != null && ip_public != null)         break;
      }
      try {
        if (ip_private.equals(ipAddress)) {
          logger.trace("current node found. Ignoring {} - {}",name,ip_private);
        }
 else {
          String address=ip_private;
          if (instance.getMetadata() != null && instance.getMetadata().containsKey("es_port")) {
            Object es_port=instance.getMetadata().get("es_port");
            logger.trace("es_port is defined with {}",es_port);
            if (es_port instanceof String) {
              address=address.concat(":").concat((String)es_port);
            }
 else {
              logger.trace("es_port is instance of {}. Ignoring...",es_port.getClass().getName());
            }
          }
          TransportAddress[] addresses=transportService.addressesFromString(address);
          for (int i=0; i < addresses.length; i++) {
            logger.trace("adding {}, type {}, image {}, address {}, transport_address {}, status {}",name,type,image,ip_private,addresses[i],status);
            cachedDiscoNodes.add(new DiscoveryNode("#cloud-" + name + "-"+ i,addresses[i],Version.CURRENT));
          }
        }
      }
 catch (      Exception e) {
        logger.warn("failed to add {}, address {}",e,name,ip_private);
      }
    }
  }
 catch (  Throwable e) {
    logger.warn("Exception caught during discovery {} : {}",e.getClass().getName(),e.getMessage());
    logger.trace("Exception caught during discovery",e);
  }
  logger.debug("{} node(s) added",cachedDiscoNodes.size());
  logger.debug("using dynamic discovery nodes {}",cachedDiscoNodes);
  return cachedDiscoNodes;
}
