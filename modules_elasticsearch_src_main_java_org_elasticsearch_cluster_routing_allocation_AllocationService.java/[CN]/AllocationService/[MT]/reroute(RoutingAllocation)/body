{
  Iterable<DiscoveryNode> dataNodes=allocation.nodes().dataNodes().values();
  boolean changed=false;
  changed|=deassociateDeadNodes(allocation.routingNodes(),dataNodes);
  applyNewNodes(allocation.routingNodes(),dataNodes);
  changed|=electPrimaries(allocation.routingNodes());
  if (allocation.routingNodes().hasUnassigned()) {
    changed|=shardsAllocators.allocateUnassigned(nodeAllocations,allocation);
    changed|=electPrimaries(allocation.routingNodes());
  }
  changed|=shardsAllocators.rebalance(nodeAllocations,allocation);
  return changed;
}
