{
  MappingMetaData mappingMd=metaData.index(request.index()).mappingOrDefault(indexRequest.type());
  if (mappingMd != null && mappingMd.routing().required()) {
    if (indexRequest.routing() == null) {
      throw new RoutingMissingException(request.index(),indexRequest.type(),indexRequest.id());
    }
  }
  if (!processed) {
    indexRequest.process(metaData,mappingMd,allowIdGeneration,request.index());
  }
  return TransportIndexAction.executeIndexRequestOnPrimary(indexRequest,indexShard,mappingUpdatedAction);
}
