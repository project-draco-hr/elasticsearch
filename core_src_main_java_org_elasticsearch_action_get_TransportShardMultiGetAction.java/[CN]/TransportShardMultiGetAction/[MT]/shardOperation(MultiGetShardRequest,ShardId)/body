{
  IndexService indexService=indicesService.indexServiceSafe(shardId.getIndex());
  IndexShard indexShard=indexService.shardSafe(shardId.id());
  if (request.refresh() && !request.realtime()) {
    indexShard.refresh("refresh_flag_mget");
  }
  MultiGetShardResponse response=new MultiGetShardResponse();
  for (int i=0; i < request.locations.size(); i++) {
    MultiGetRequest.Item item=request.items.get(i);
    try {
      GetResult getResult=indexShard.getService().get(item.type(),item.id(),item.fields(),request.realtime(),item.version(),item.versionType(),item.fetchSourceContext(),request.ignoreErrorsOnGeneratedFields());
      response.add(request.locations.get(i),new GetResponse(getResult));
    }
 catch (    Throwable t) {
      if (TransportActions.isShardNotAvailableException(t)) {
        throw (ElasticsearchException)t;
      }
 else {
        logger.debug("{} failed to execute multi_get for [{}]/[{}]",t,shardId,item.type(),item.id());
        response.add(request.locations.get(i),new MultiGetResponse.Failure(request.index(),item.type(),item.id(),ExceptionsHelper.detailedMessage(t)));
      }
    }
  }
  return response;
}
