{
  XContentBuilder mapping=jsonBuilder().startObject().startObject("doc").startObject("properties").startObject("z").field("type","long").endObject().endObject().endObject().endObject();
  IndexService indexService=createIndex("test",ImmutableSettings.EMPTY,"doc",mapping);
  boolean create=randomBoolean();
  if (create == false) {
    client().prepareIndex().setIndex("test").setType("doc").setId("1").setSource(jsonBuilder().startObject().field("z",0).endObject()).get();
  }
  try {
    IndexRequestBuilder indexRequest=client().prepareIndex().setIndex("test").setType("doc").setId("1").setSource(jsonBuilder().startObject().field("a","string").field("z","string").endObject());
    indexRequest.setCreate(create);
    indexRequest.get();
    fail();
  }
 catch (  MapperParsingException e) {
  }
  GetMappingsResponse getMappingsResponse=client().admin().indices().prepareGetMappings("test").get();
  assertNotNull(getMappingsResponse.getMappings().get("test").get("doc"));
  client().prepareIndex().setIndex("test").setType("doc").setId("1").setSource(jsonBuilder().startObject().field("a","string").field("z",0).endObject()).get();
  client().admin().indices().prepareRefresh("test").get();
  assertThat(client().prepareSearch("test").get().getHits().getTotalHits(),equalTo(1l));
  DocumentMapper mapper=indexService.mapperService().documentMapper("doc");
  assertNotNull(mapper.mappers().name("a"));
  assertNotNull(mapper.mappers().name("z"));
  getMappingsResponse=client().admin().indices().prepareGetMappings("test").get();
  assertNotNull(getMappingsResponse.getMappings().get("test").get("doc"));
  Map<String,Object> mappings=getMappingsResponse.getMappings().get("test").get("doc").getSourceAsMap();
  assertNotNull(((LinkedHashMap)mappings.get("properties")).get("a"));
  assertNotNull(((LinkedHashMap)mappings.get("properties")).get("z"));
}
