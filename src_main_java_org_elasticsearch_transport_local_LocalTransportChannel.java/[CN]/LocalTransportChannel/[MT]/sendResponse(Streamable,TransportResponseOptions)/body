{
  CachedStreamOutput.Entry cachedEntry=CachedStreamOutput.popEntry();
  try {
    StreamOutput stream=cachedEntry.handles();
    stream.writeLong(requestId);
    byte status=0;
    status=TransportStatus.setResponse(status);
    stream.writeByte(status);
    message.writeTo(stream);
    stream.close();
    final byte[] data=cachedEntry.bytes().bytes().copyBytesArray().toBytes();
    targetTransport.threadPool().generic().execute(new Runnable(){
      @Override public void run(){
        targetTransport.messageReceived(data,action,sourceTransport,null);
      }
    }
);
  }
  finally {
    CachedStreamOutput.pushEntry(cachedEntry);
  }
}
