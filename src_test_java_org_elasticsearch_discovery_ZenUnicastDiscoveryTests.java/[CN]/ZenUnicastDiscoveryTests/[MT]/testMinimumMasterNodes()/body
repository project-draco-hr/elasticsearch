{
  int currentNumNodes=randomIntBetween(3,5);
  int currentNumOfUnicastHosts=randomIntBetween(1,currentNumNodes);
  final Settings settings=ImmutableSettings.settingsBuilder().put("discovery.zen.minimum_master_nodes",currentNumNodes / 2 + 1).build();
  discoveryConfig=new ClusterDiscoveryConfiguration.UnicastZen(currentNumNodes,currentNumOfUnicastHosts,settings,Scope.TEST);
  List<String> nodes=internalCluster().startNodesAsync(currentNumNodes).get();
  ensureGreen();
  DiscoveryNode masterDiscoNode=null;
  for (  String node : nodes) {
    ClusterState state=internalCluster().client(node).admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
    assertThat(state.nodes().size(),equalTo(currentNumNodes));
    if (masterDiscoNode == null) {
      masterDiscoNode=state.nodes().masterNode();
    }
 else {
      assertThat(masterDiscoNode.equals(state.nodes().masterNode()),equalTo(true));
    }
  }
}
