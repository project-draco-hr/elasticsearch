{
  try (BytesStreamOutput bytesStreamOutput=new BytesStreamOutput()){
    if (compress) {
      try (StreamOutput compressedStreamOutput=CompressorFactory.defaultCompressor().streamOutput(bytesStreamOutput)){
        write(obj,compressedStreamOutput);
      }
     }
 else {
      write(obj,bytesStreamOutput);
    }
    return bytesStreamOutput.bytes();
  }
 }
