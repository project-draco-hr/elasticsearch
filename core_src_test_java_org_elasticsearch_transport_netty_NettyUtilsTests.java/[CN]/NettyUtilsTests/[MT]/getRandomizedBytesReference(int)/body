{
  ReleasableBytesStreamOutput out=new ReleasableBytesStreamOutput(length,bigarrays);
  for (int i=0; i < length; i++) {
    out.writeByte((byte)random().nextInt(1 << 8));
  }
  assertEquals(out.size(),length);
  BytesReference ref=out.bytes();
  assertEquals(ref.length(),length);
  if (randomBoolean()) {
    return ref.toBytesArray();
  }
 else   if (randomBoolean()) {
    BytesArray bytesArray=ref.toBytesArray();
    return NettyUtils.toBytesReference(ChannelBuffers.wrappedBuffer(bytesArray.array(),bytesArray.arrayOffset(),bytesArray.length()));
  }
 else {
    return ref;
  }
}
