{
  Map<String,Object> additionalFields=new HashMap<>();
  try {
    Metadata metadata=new Metadata();
    byte[] input=ingestDocument.getFieldValueAsBytes(sourceField);
    String parsedContent=TikaImpl.parse(input,metadata,indexedChars);
    if (fields.contains(Field.CONTENT) && Strings.hasLength(parsedContent)) {
      additionalFields.put(Field.CONTENT.toLowerCase(),parsedContent.trim());
    }
    if (fields.contains(Field.LANGUAGE) && Strings.hasLength(parsedContent)) {
      LanguageIdentifier identifier=new LanguageIdentifier(parsedContent);
      String language=identifier.getLanguage();
      additionalFields.put(Field.LANGUAGE.toLowerCase(),language);
    }
    if (fields.contains(Field.DATE)) {
      String createdDate=metadata.get(TikaCoreProperties.CREATED);
      if (createdDate != null) {
        additionalFields.put(Field.DATE.toLowerCase(),createdDate);
      }
    }
    if (fields.contains(Field.TITLE)) {
      String title=metadata.get(TikaCoreProperties.TITLE);
      if (Strings.hasLength(title)) {
        additionalFields.put(Field.TITLE.toLowerCase(),title);
      }
    }
    if (fields.contains(Field.AUTHOR)) {
      String author=metadata.get("Author");
      if (Strings.hasLength(author)) {
        additionalFields.put(Field.AUTHOR.toLowerCase(),author);
      }
    }
    if (fields.contains(Field.KEYWORDS)) {
      String keywords=metadata.get("Keywords");
      if (Strings.hasLength(keywords)) {
        additionalFields.put(Field.KEYWORDS.toLowerCase(),keywords);
      }
    }
    if (fields.contains(Field.CONTENT_TYPE)) {
      String contentType=metadata.get(Metadata.CONTENT_TYPE);
      if (Strings.hasLength(contentType)) {
        additionalFields.put(Field.CONTENT_TYPE.toLowerCase(),contentType);
      }
    }
    if (fields.contains(Field.CONTENT_LENGTH)) {
      String contentLength=metadata.get(Metadata.CONTENT_LENGTH);
      String length=Strings.hasLength(contentLength) ? contentLength : String.valueOf(parsedContent.length());
      additionalFields.put(Field.CONTENT_LENGTH.toLowerCase(),length);
    }
  }
 catch (  Throwable e) {
    throw new ElasticsearchParseException("Error parsing document in field [{}]",e,sourceField);
  }
  ingestDocument.setFieldValue(targetField,additionalFields);
}
