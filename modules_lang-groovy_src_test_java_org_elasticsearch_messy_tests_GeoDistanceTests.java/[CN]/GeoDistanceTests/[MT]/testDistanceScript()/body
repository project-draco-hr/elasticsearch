{
  double source_lat=32.798;
  double source_long=-117.151;
  double target_lat=32.81;
  double target_long=-117.21;
  Version version=VersionUtils.randomVersionBetween(random(),Version.V_2_0_0,Version.CURRENT);
  Settings settings=Settings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,version).build();
  XContentBuilder xContentBuilder=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("location").field("type","geo_point");
  if (version.before(Version.V_2_2_0)) {
    xContentBuilder.field("lat_lon",true);
  }
  xContentBuilder.endObject().endObject().endObject().endObject();
  assertAcked(prepareCreate("test").setSettings(settings).addMapping("type1",xContentBuilder));
  ensureGreen();
  client().prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("name","TestPosition").startObject("location").field("lat",source_lat).field("lon",source_long).endObject().endObject()).execute().actionGet();
  refresh();
  SearchResponse searchResponse1=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].arcDistance(" + target_lat + ","+ target_long+ ")")).execute().actionGet();
  Double resultDistance1=searchResponse1.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultDistance1,closeTo(GeoDistance.ARC.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.DEFAULT),0.01d));
  SearchResponse searchResponse2=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].distance(" + target_lat + ","+ target_long+ ")")).execute().actionGet();
  Double resultDistance2=searchResponse2.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultDistance2,closeTo(GeoDistance.PLANE.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.DEFAULT),0.01d));
  SearchResponse searchResponse3=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].arcDistanceInKm(" + target_lat + ","+ target_long+ ")")).execute().actionGet();
  Double resultArcDistance3=searchResponse3.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultArcDistance3,closeTo(GeoDistance.ARC.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.KILOMETERS),0.01d));
  SearchResponse searchResponse4=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].distanceInKm(" + target_lat + ","+ target_long+ ")")).execute().actionGet();
  Double resultDistance4=searchResponse4.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultDistance4,closeTo(GeoDistance.PLANE.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.KILOMETERS),0.01d));
  SearchResponse searchResponse5=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].arcDistanceInKm(" + (target_lat) + ","+ (target_long + 360)+ ")")).execute().actionGet();
  Double resultArcDistance5=searchResponse5.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultArcDistance5,closeTo(GeoDistance.ARC.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.KILOMETERS),0.01d));
  SearchResponse searchResponse6=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].arcDistanceInKm(" + (target_lat + 360) + ","+ (target_long)+ ")")).execute().actionGet();
  Double resultArcDistance6=searchResponse6.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultArcDistance6,closeTo(GeoDistance.ARC.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.KILOMETERS),0.01d));
  SearchResponse searchResponse7=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].arcDistanceInMiles(" + target_lat + ","+ target_long+ ")")).execute().actionGet();
  Double resultDistance7=searchResponse7.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultDistance7,closeTo(GeoDistance.ARC.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.MILES),0.01d));
  SearchResponse searchResponse8=client().prepareSearch().addField("_source").addScriptField("distance",new Script("doc['location'].distanceInMiles(" + target_lat + ","+ target_long+ ")")).execute().actionGet();
  Double resultDistance8=searchResponse8.getHits().getHits()[0].getFields().get("distance").getValue();
  assertThat(resultDistance8,closeTo(GeoDistance.PLANE.calculate(source_lat,source_long,target_lat,target_long,DistanceUnit.MILES),0.01d));
}
