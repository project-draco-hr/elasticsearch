{
  createIndex("test");
  index("test","type","1","field","1");
  final BulkResponse[] responses=new BulkResponse[30];
  final CyclicBarrier cyclicBarrier=new CyclicBarrier(responses.length);
  Thread[] threads=new Thread[responses.length];
  for (int i=0; i < responses.length; i++) {
    final int threadID=i;
    threads[threadID]=new Thread(new Runnable(){
      @Override public void run(){
        try {
          cyclicBarrier.await();
        }
 catch (        Exception e) {
          return;
        }
        BulkRequestBuilder requestBuilder=client().prepareBulk();
        requestBuilder.add(client().prepareUpdate("test","type","1").setVersion(1).setDoc("field",threadID));
        responses[threadID]=requestBuilder.get();
      }
    }
);
    threads[threadID].start();
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].join();
  }
  int successes=0;
  for (  BulkResponse response : responses) {
    if (!response.hasFailures()) {
      successes++;
    }
  }
  assertThat(successes,equalTo(1));
}
