{
  createIndex("test");
  ensureGreen();
  BulkResponse bulkResponse=client().prepareBulk().add(client().prepareIndex().setIndex("test").setType("type1").setId("1").setSource("field",1)).add(client().prepareIndex().setIndex("test").setType("type1").setId("2").setSource("field",1)).add(client().prepareIndex().setIndex("test").setType("type1").setId("3").setSource("field",1)).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(false));
  assertThat(bulkResponse.getItems().length,equalTo(3));
  bulkResponse=client().prepareBulk().add(client().prepareUpdate().setIndex("test").setType("type1").setId("1").setScript(new Script("ctx._source.field += a",ScriptService.ScriptType.INLINE,null,null)).setFields("field")).add(client().prepareUpdate().setIndex("test").setType("type1").setId("2").setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null)).setFields("field")).add(client().prepareUpdate().setIndex("test").setType("type1").setId("3").setScript(new Script("ctx._source.field += a",ScriptService.ScriptType.INLINE,null,null)).setFields("field")).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(true));
  assertThat(bulkResponse.getItems().length,equalTo(3));
  assertThat(bulkResponse.getItems()[0].getFailure().getId(),equalTo("1"));
  assertThat(bulkResponse.getItems()[0].getFailure().getMessage(),containsString("failed to execute script"));
  assertThat(bulkResponse.getItems()[0].getResponse(),nullValue());
  assertThat(((UpdateResponse)bulkResponse.getItems()[1].getResponse()).getId(),equalTo("2"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[1].getResponse()).getVersion(),equalTo(2l));
  assertThat(((Integer)((UpdateResponse)bulkResponse.getItems()[1].getResponse()).getGetResult().field("field").getValue()),equalTo(2));
  assertThat(bulkResponse.getItems()[1].getFailure(),nullValue());
  assertThat(bulkResponse.getItems()[2].getFailure().getId(),equalTo("3"));
  assertThat(bulkResponse.getItems()[2].getFailure().getMessage(),containsString("failed to execute script"));
  assertThat(bulkResponse.getItems()[2].getResponse(),nullValue());
}
