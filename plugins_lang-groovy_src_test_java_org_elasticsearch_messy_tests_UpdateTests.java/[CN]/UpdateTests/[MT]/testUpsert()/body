{
  createTestIndex();
  ensureGreen();
  UpdateResponse updateResponse=client().prepareUpdate(indexOrAlias(),"type1","1").setUpsert(XContentFactory.jsonBuilder().startObject().field("field",1).endObject()).setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null)).execute().actionGet();
  assertTrue(updateResponse.isCreated());
  assertThat(updateResponse.getIndex(),equalTo("test"));
  for (int i=0; i < 5; i++) {
    GetResponse getResponse=client().prepareGet("test","type1","1").execute().actionGet();
    assertThat(getResponse.getSourceAsMap().get("field").toString(),equalTo("1"));
  }
  updateResponse=client().prepareUpdate(indexOrAlias(),"type1","1").setUpsert(XContentFactory.jsonBuilder().startObject().field("field",1).endObject()).setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null)).execute().actionGet();
  assertFalse(updateResponse.isCreated());
  assertThat(updateResponse.getIndex(),equalTo("test"));
  for (int i=0; i < 5; i++) {
    GetResponse getResponse=client().prepareGet("test","type1","1").execute().actionGet();
    assertThat(getResponse.getSourceAsMap().get("field").toString(),equalTo("2"));
  }
}
