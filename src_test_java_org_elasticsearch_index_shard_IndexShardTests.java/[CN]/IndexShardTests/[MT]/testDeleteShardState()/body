{
  createIndex("test");
  ensureGreen();
  IndicesService indicesService=getInstanceFromNode(IndicesService.class);
  NodeEnvironment env=getInstanceFromNode(NodeEnvironment.class);
  IndexService test=indicesService.indexService("test");
  IndexShard shard=test.shard(0);
  try {
    shard.deleteShardState();
    fail("shard is active metadata delete must fail");
  }
 catch (  ElasticsearchIllegalStateException ex) {
  }
  ShardRouting routing=shard.routingEntry();
  ShardStateMetaData shardStateMetaData=ShardStateMetaData.load(logger,shard.shardId,env.shardPaths(shard.shardId));
  assertEquals(shardStateMetaData,getShardStateMetadata(shard));
  routing=new MutableShardRouting(shard.shardId.index().getName(),shard.shardId.id(),routing.currentNodeId(),routing.primary(),ShardRoutingState.INITIALIZING,shard.shardRouting.version() + 1);
  shard.updateRoutingEntry(routing,true);
  shard.deleteShardState();
  assertNull("no shard state expected after delete on initializing",ShardStateMetaData.load(logger,shard.shardId,env.shardPaths(shard.shardId)));
}
