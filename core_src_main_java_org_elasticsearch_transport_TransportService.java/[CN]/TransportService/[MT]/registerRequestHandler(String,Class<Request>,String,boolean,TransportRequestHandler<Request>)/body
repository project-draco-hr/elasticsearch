{
synchronized (requestHandlerMutex) {
    RequestHandlerRegistry<Request> reg=new RequestHandlerRegistry<>(action,request,handler,executor,forceExecution);
    RequestHandlerRegistry replaced=requestHandlers.get(reg.getAction());
    requestHandlers=MapBuilder.newMapBuilder(requestHandlers).put(reg.getAction(),reg).immutableMap();
    if (replaced != null) {
      logger.warn("registered two transport handlers for action {}, handlers: {}, {}",reg.getAction(),reg.getHandler(),replaced.getHandler());
    }
  }
}
