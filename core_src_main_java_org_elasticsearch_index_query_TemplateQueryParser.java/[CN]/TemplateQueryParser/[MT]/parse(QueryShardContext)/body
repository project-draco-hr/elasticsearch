{
  QueryParseContext parseContext=context.parseContext();
  XContentParser parser=parseContext.parser();
  Template template=parse(parser,parseContext.parseFieldMatcher());
  ExecutableScript executable=this.scriptService.executable(template,ScriptContext.Standard.SEARCH,SearchContext.current());
  BytesReference querySource=(BytesReference)executable.run();
  try (XContentParser qSourceParser=XContentFactory.xContent(querySource).createParser(querySource)){
    final QueryShardContext contextCopy=new QueryShardContext(context.index(),context.indexQueryParserService());
    contextCopy.reset(qSourceParser);
    return contextCopy.parseContext().parseInnerQuery();
  }
 }
