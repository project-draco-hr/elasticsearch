{
  String field=null;
  int size=10;
  String[] fieldsNames=null;
  ImmutableSet<BytesRef> excluded=ImmutableSet.of();
  String regex=null;
  String regexFlags=null;
  TermsFacet.ComparatorType comparatorType=TermsFacet.ComparatorType.COUNT;
  String scriptLang=null;
  String script=null;
  Map<String,Object> params=null;
  boolean allTerms=false;
  String executionHint=null;
  String currentFieldName=null;
  XContentParser.Token token;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if ("params".equals(currentFieldName)) {
        params=parser.map();
      }
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("exclude".equals(currentFieldName)) {
        ImmutableSet.Builder<BytesRef> builder=ImmutableSet.builder();
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          builder.add(parser.bytes());
        }
        excluded=builder.build();
      }
 else       if ("fields".equals(currentFieldName)) {
        List<String> fields=Lists.newArrayListWithCapacity(4);
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          fields.add(parser.text());
        }
        fieldsNames=fields.toArray(new String[fields.size()]);
      }
    }
 else     if (token.isValue()) {
      if ("field".equals(currentFieldName)) {
        field=parser.text();
      }
 else       if ("script_field".equals(currentFieldName)) {
        script=parser.text();
      }
 else       if ("size".equals(currentFieldName)) {
        size=parser.intValue();
      }
 else       if ("all_terms".equals(currentFieldName) || "allTerms".equals(currentFieldName)) {
        allTerms=parser.booleanValue();
      }
 else       if ("regex".equals(currentFieldName)) {
        regex=parser.text();
      }
 else       if ("regex_flags".equals(currentFieldName) || "regexFlags".equals(currentFieldName)) {
        regexFlags=parser.text();
      }
 else       if ("order".equals(currentFieldName) || "comparator".equals(currentFieldName)) {
        comparatorType=TermsFacet.ComparatorType.fromString(parser.text());
      }
 else       if ("script".equals(currentFieldName)) {
        script=parser.text();
      }
 else       if ("lang".equals(currentFieldName)) {
        scriptLang=parser.text();
      }
 else       if ("execution_hint".equals(currentFieldName) || "executionHint".equals(currentFieldName)) {
        executionHint=parser.textOrNull();
      }
    }
  }
  if ("_index".equals(field)) {
    return new IndexNameFacetCollector(facetName,context.shardTarget().index(),comparatorType,size);
  }
  Pattern pattern=null;
  if (regex != null) {
    pattern=Regex.compile(regex,regexFlags);
  }
  SearchScript searchScript=null;
  if (script != null) {
    searchScript=context.scriptService().search(context.lookup(),scriptLang,script,params);
  }
  if (fieldsNames != null) {
    return new FieldsTermsStringFacetCollector(facetName,fieldsNames,size,comparatorType,allTerms,context,excluded,pattern,searchScript);
  }
  if (field == null && fieldsNames == null && script != null) {
    return new ScriptTermsStringFieldFacetCollector(facetName,size,comparatorType,context,excluded,pattern,scriptLang,script,params);
  }
  FieldMapper fieldMapper=context.smartNameFieldMapper(field);
  if (fieldMapper == null) {
    throw new FacetPhaseExecutionException(facetName,"failed to find mapping for [" + field + "]");
  }
  IndexFieldData indexFieldData=context.fieldData().getForField(fieldMapper);
  if (indexFieldData instanceof IndexNumericFieldData) {
    IndexNumericFieldData indexNumericFieldData=(IndexNumericFieldData)indexFieldData;
    if (indexNumericFieldData.getNumericType().isFloatingPoint()) {
      return new TermsDoubleFacetCollector(facetName,indexNumericFieldData,size,comparatorType,allTerms,context,excluded,searchScript);
    }
 else {
      return new TermsLongFacetCollector(facetName,indexNumericFieldData,size,comparatorType,allTerms,context,excluded,searchScript);
    }
  }
 else {
    if (script != null || "map".equals(executionHint)) {
      return new TermsStringFacetCollector(facetName,indexFieldData,size,comparatorType,allTerms,context,excluded,pattern,searchScript);
    }
 else     if (indexFieldData instanceof IndexOrdinalFieldData) {
      return new TermsStringOrdinalsFacetCollector(facetName,(IndexOrdinalFieldData)indexFieldData,size,comparatorType,allTerms,context,excluded,pattern);
    }
 else {
      return new TermsStringFacetCollector(facetName,indexFieldData,size,comparatorType,allTerms,context,excluded,pattern,searchScript);
    }
  }
}
