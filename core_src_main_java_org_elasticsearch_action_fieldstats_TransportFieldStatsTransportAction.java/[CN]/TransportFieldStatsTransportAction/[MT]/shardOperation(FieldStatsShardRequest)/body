{
  ShardId shardId=request.shardId();
  Map<String,FieldStats<?>> fieldStats=new HashMap<>();
  IndexService indexServices=indicesService.indexServiceSafe(shardId.getIndex());
  MapperService mapperService=indexServices.mapperService();
  IndexShard shard=indexServices.getShard(shardId.id());
  try (Engine.Searcher searcher=shard.acquireSearcher("fieldstats")){
    for (    String field : request.getFields()) {
      MappedFieldType fieldType=mapperService.fullName(field);
      if (fieldType == null) {
        throw new IllegalArgumentException("field [" + field + "] doesn't exist");
      }
      FieldStats<?> stats=fieldType.stats(searcher.reader());
      if (stats != null) {
        fieldStats.put(field,stats);
      }
    }
  }
 catch (  IOException e) {
    throw ExceptionsHelper.convertToElastic(e);
  }
  return new FieldStatsShardResponse(shardId,fieldStats);
}
