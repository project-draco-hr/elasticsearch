{
  ShardId shardId=request.shardId();
  Map<String,FieldStats<?>> fieldStats=new HashMap<>();
  IndexService indexServices=indicesService.indexServiceSafe(shardId.getIndex());
  MapperService mapperService=indexServices.mapperService();
  IndexShard shard=indexServices.getShard(shardId.id());
  try (Engine.Searcher searcher=shard.acquireSearcher("fieldstats")){
    for (    String field : request.getFields()) {
      Collection<String> matchFields;
      if (Regex.isSimpleMatchPattern(field)) {
        matchFields=mapperService.simpleMatchToIndexNames(field);
      }
 else {
        matchFields=Collections.singleton(field);
      }
      for (      String matchField : matchFields) {
        MappedFieldType fieldType=mapperService.fullName(matchField);
        if (fieldType == null) {
          continue;
        }
        FieldStats<?> stats=fieldType.stats(searcher.reader());
        if (stats != null) {
          fieldStats.put(matchField,stats);
        }
      }
    }
  }
 catch (  IOException e) {
    throw ExceptionsHelper.convertToElastic(e);
  }
  return new FieldStatsShardResponse(shardId,fieldStats);
}
