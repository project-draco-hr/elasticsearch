{
  IndexWriter indexWriter=null;
  try {
    if (IndexWriter.isLocked(store.directory())) {
      logger.trace("Shard is locked, releasing lock");
      store.directory().clearLock(IndexWriter.WRITE_LOCK_NAME);
    }
    boolean create=!IndexReader.indexExists(store.directory());
    indexWriter=new IndexWriter(store.directory(),analysisService.defaultIndexAnalyzer(),create,deletionPolicy,IndexWriter.MaxFieldLength.UNLIMITED);
    indexWriter.setMergeScheduler(mergeScheduler.newMergeScheduler());
    indexWriter.setMergePolicy(mergePolicyProvider.newMergePolicy(indexWriter));
    indexWriter.setSimilarity(similarityService.defaultIndexSimilarity());
    indexWriter.setRAMBufferSizeMB(indexingBufferSize.mbFrac());
    indexWriter.setTermIndexInterval(termIndexInterval);
  }
 catch (  IOException e) {
    safeClose(indexWriter);
    throw e;
  }
  return indexWriter;
}
