{
  if (indexWriter == null) {
    throw new EngineClosedException(shardId);
  }
  rwl.readLock().lock();
  try {
    IndexWriter currentWriter=indexWriter;
    if (currentWriter == null) {
      throw new EngineClosedException(shardId,failedEngine);
    }
    try {
synchronized (refreshMutex) {
        if (dirty || refresh.force()) {
          dirty=false;
          AcquirableResource<ReaderSearcherHolder> current=nrtResource;
          IndexReader newReader=current.resource().reader().reopen(true);
          if (newReader != current.resource().reader()) {
            ExtendedIndexSearcher indexSearcher=new ExtendedIndexSearcher(newReader);
            indexSearcher.setSimilarity(similarityService.defaultSearchSimilarity());
            nrtResource=newAcquirableResource(new ReaderSearcherHolder(indexSearcher));
            current.markForClose();
          }
        }
      }
    }
 catch (    AlreadyClosedException e) {
    }
catch (    OutOfMemoryError e) {
      failEngine(e);
      throw new RefreshFailedEngineException(shardId,e);
    }
catch (    IllegalStateException e) {
      if (e.getMessage().contains("OutOfMemoryError")) {
        failEngine(e);
      }
      throw new RefreshFailedEngineException(shardId,e);
    }
catch (    Exception e) {
      if (indexWriter == null) {
        throw new EngineClosedException(shardId,failedEngine);
      }
 else       if (currentWriter != indexWriter) {
      }
 else {
        throw new RefreshFailedEngineException(shardId,e);
      }
    }
  }
  finally {
    rwl.readLock().unlock();
  }
}
