{
  if (indexWriter == null) {
    throw new EngineClosedException(shardId);
  }
  if (disableFlushCounter > 0) {
    throw new FlushNotAllowedEngineException(shardId,"Recovery is in progress, flush is not allowed");
  }
  if (!flushing.compareAndSet(false,true)) {
    throw new FlushNotAllowedEngineException(shardId,"Already flushing...");
  }
  try {
    indexWriter.maybeMerge();
  }
 catch (  Exception e) {
    flushing.set(false);
    throw new FlushFailedEngineException(shardId,e);
  }
  rwl.writeLock().lock();
  try {
    if (indexWriter == null) {
      throw new EngineClosedException(shardId);
    }
    if (disableFlushCounter > 0) {
      throw new FlushNotAllowedEngineException(shardId,"Recovery is in progress, flush is not allowed");
    }
    if (flush.full()) {
      dirty=false;
      refreshMutex.set(true);
      try {
        indexWriter.close();
        indexWriter=createWriter();
        AcquirableResource<ReaderSearcherHolder> current=nrtResource;
        nrtResource=buildNrtResource(indexWriter);
        current.markForClose();
        translog.newTranslog(newTransactionLogId());
      }
 catch (      IOException e) {
        throw new FlushFailedEngineException(shardId,e);
      }
 finally {
        refreshMutex.set(false);
      }
    }
 else {
      try {
        indexWriter.commit();
        translog.newTranslog(newTransactionLogId());
      }
 catch (      IOException e) {
        throw new FlushFailedEngineException(shardId,e);
      }
    }
    versionMap.clear();
    dirty=true;
    refresh(new Refresh(true));
  }
  finally {
    rwl.writeLock().unlock();
    flushing.set(false);
  }
}
