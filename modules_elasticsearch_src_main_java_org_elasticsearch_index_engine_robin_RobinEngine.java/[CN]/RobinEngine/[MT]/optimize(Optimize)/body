{
  if (optimizeMutex.compareAndSet(false,true)) {
    rwl.readLock().lock();
    try {
      int maxNumberOfSegments=optimize.maxNumSegments();
      if (maxNumberOfSegments == -1) {
        if (indexWriter.getMergePolicy() instanceof LogMergePolicy) {
          maxNumberOfSegments=((LogMergePolicy)indexWriter.getMergePolicy()).getMergeFactor() / 2;
          if (maxNumberOfSegments < 0) {
            maxNumberOfSegments=1;
          }
        }
      }
      indexWriter.optimize(maxNumberOfSegments,optimize.waitForMerge());
    }
 catch (    Exception e) {
      throw new OptimizeFailedEngineException(shardId,e);
    }
 finally {
      rwl.readLock().unlock();
      optimizeMutex.set(false);
    }
  }
}
