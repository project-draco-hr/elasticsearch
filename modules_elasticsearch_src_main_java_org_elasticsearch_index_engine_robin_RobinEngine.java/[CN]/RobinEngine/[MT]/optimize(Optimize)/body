{
  if (optimizeMutex.compareAndSet(false,true)) {
    rwl.readLock().lock();
    try {
      if (indexWriter == null) {
        throw new EngineClosedException(shardId,failedEngine);
      }
      if (indexWriter.getConfig().getMergePolicy() instanceof EnableMergePolicy) {
        ((EnableMergePolicy)indexWriter.getConfig().getMergePolicy()).enableMerge();
      }
      if (optimize.onlyExpungeDeletes()) {
        indexWriter.expungeDeletes(false);
      }
 else       if (optimize.maxNumSegments() <= 0) {
        indexWriter.maybeMerge();
        possibleMergeNeeded=false;
      }
 else {
        indexWriter.optimize(optimize.maxNumSegments(),false);
      }
    }
 catch (    Exception e) {
      throw new OptimizeFailedEngineException(shardId,e);
    }
catch (    OutOfMemoryError e) {
      failEngine(e);
      throw new OptimizeFailedEngineException(shardId,e);
    }
 finally {
      rwl.readLock().unlock();
      if (indexWriter != null && indexWriter.getConfig().getMergePolicy() instanceof EnableMergePolicy) {
        ((EnableMergePolicy)indexWriter.getConfig().getMergePolicy()).disableMerge();
      }
      optimizeMutex.set(false);
    }
  }
  if (optimize.waitForMerge()) {
    indexWriter.waitForMerges();
  }
  if (optimize.flush()) {
    flush(new Flush());
  }
  if (optimize.refresh()) {
    refresh(new Refresh(false).force(true));
  }
}
