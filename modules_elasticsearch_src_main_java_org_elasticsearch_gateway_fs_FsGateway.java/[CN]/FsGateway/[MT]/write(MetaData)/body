{
  try {
    final File file=new File(gatewayHome,"metadata-" + (currentIndex + 1));
    for (int i=0; i < 5; i++) {
      if (file.createNewFile())       break;
    }
    if (!file.exists()) {
      throw new GatewayException("Failed to create new file [" + file + "]");
    }
    FileOutputStream fileStream=new FileOutputStream(file);
    FastDataOutputStream outStream=new FastDataOutputStream(fileStream);
    MetaData.Builder.writeTo(metaData,outStream);
    outStream.close();
    FileSystemUtils.syncFile(file);
    currentIndex++;
    File[] oldFiles=gatewayHome.listFiles(new FilenameFilter(){
      @Override public boolean accept(      File dir,      String name){
        return name.startsWith("metadata-") && !name.equals(file.getName());
      }
    }
);
    for (    File oldFile : oldFiles) {
      oldFile.delete();
    }
  }
 catch (  IOException e) {
    throw new GatewayException("can't write new metadata file into the gateway",e);
  }
}
