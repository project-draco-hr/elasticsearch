{
  final String index="test";
  final ShardId shardId=new ShardId(index,"_na_",0);
  ClusterState state=stateWithActivePrimary(index,true,randomInt(5));
  ShardRouting primaryShard=state.getRoutingTable().shardRoutingTable(shardId).primaryShard();
  if (primaryShard.relocating() && randomBoolean()) {
    state=ClusterState.builder(state).nodes(DiscoveryNodes.builder(state.nodes()).localNodeId(primaryShard.relocatingNodeId())).build();
  }
  setState(clusterService,state);
  final IndexShardRoutingTable shardRoutingTable=clusterService.state().routingTable().index(index).shard(shardId.id());
  int assignedReplicas=0;
  int totalShards=0;
  for (  ShardRouting shard : shardRoutingTable) {
    totalShards++;
    if (shard.primary() == false && shard.assignedToNode()) {
      assignedReplicas++;
    }
    if (shard.relocating()) {
      assignedReplicas++;
      totalShards++;
    }
  }
  runReplicateTest(state,shardRoutingTable,assignedReplicas,totalShards);
}
