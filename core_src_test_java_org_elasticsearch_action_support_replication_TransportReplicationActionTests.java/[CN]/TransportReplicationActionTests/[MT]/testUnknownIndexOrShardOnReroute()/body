{
  final String index="test";
  clusterService.setState(state(index,true,randomBoolean() ? ShardRoutingState.INITIALIZING : ShardRoutingState.UNASSIGNED));
  logger.debug("--> using initial state:\n{}",clusterService.state().prettyPrint());
  Request request=new Request(new ShardId("unknown_index","_na_",0)).timeout("1ms");
  PlainActionFuture<Response> listener=new PlainActionFuture<>();
  TransportReplicationAction.ReroutePhase reroutePhase=action.new ReroutePhase(request,listener);
  reroutePhase.run();
  assertListenerThrows("must throw index not found exception",listener,IndexNotFoundException.class);
  request=new Request(new ShardId(index,"_na_",10)).timeout("1ms");
  listener=new PlainActionFuture<>();
  reroutePhase=action.new ReroutePhase(request,listener);
  reroutePhase.run();
  assertListenerThrows("must throw shard not found exception",listener,ShardNotFoundException.class);
}
