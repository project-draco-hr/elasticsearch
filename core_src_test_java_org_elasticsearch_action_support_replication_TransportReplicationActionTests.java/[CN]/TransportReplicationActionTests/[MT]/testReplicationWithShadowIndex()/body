{
  final String index="test";
  final ShardId shardId=new ShardId(index,"_na_",0);
  ClusterState state=stateWithActivePrimary(index,true,randomInt(5));
  MetaData.Builder metaData=MetaData.builder(state.metaData());
  Settings.Builder settings=Settings.builder().put(metaData.get(index).getSettings());
  settings.put(IndexMetaData.SETTING_SHADOW_REPLICAS,true);
  metaData.put(IndexMetaData.builder(metaData.get(index)).settings(settings));
  state=ClusterState.builder(state).metaData(metaData).build();
  ShardRouting primaryShard=state.getRoutingTable().shardRoutingTable(shardId).primaryShard();
  if (primaryShard.relocating() && randomBoolean()) {
    state=ClusterState.builder(state).nodes(DiscoveryNodes.builder(state.nodes()).localNodeId(primaryShard.relocatingNodeId())).build();
  }
  clusterService.setState(state);
  final IndexShardRoutingTable shardRoutingTable=clusterService.state().routingTable().index(index).shard(shardId.id());
  int assignedReplicas=0;
  int totalShards=0;
  for (  ShardRouting shard : shardRoutingTable) {
    totalShards++;
    if (shard.primary() && shard.relocating()) {
      assignedReplicas++;
      totalShards++;
    }
  }
  runReplicateTest(state,shardRoutingTable,assignedReplicas,totalShards);
}
