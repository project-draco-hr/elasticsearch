{
  final String index="test";
  final ShardId shardId=new ShardId(index,"_na_",0);
  clusterService.setState(state(index,true,ShardRoutingState.STARTED,ShardRoutingState.STARTED));
  Request request=new Request(shardId).timeout("1ms");
  PlainActionFuture<Response> listener=new PlainActionFuture<>();
  TransportReplicationAction.PrimaryPhase primaryPhase=action.new PrimaryPhase(request,createTransportChannel(listener));
  primaryPhase.run();
  assertThat("request was not processed on primary",request.processedOnPrimary.get(),equalTo(true));
  final String replicaNodeId=clusterService.state().getRoutingTable().shardRoutingTable(index,shardId.id()).replicaShards().get(0).currentNodeId();
  final List<CapturingTransport.CapturedRequest> requests=transport.getCapturedRequestsByTargetNodeAndClear().get(replicaNodeId);
  assertThat(requests,notNullValue());
  assertThat(requests.size(),equalTo(1));
  assertThat("replica request was not sent",requests.get(0).action,equalTo("testAction[r]"));
}
