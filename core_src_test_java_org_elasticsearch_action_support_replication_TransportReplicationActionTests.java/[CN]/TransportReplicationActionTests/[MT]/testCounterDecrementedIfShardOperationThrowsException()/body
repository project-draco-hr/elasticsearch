{
  action=new ActionWithExceptions(Settings.EMPTY,"testActionWithExceptions",transportService,clusterService,threadPool);
  final String index="test";
  final ShardId shardId=new ShardId(index,"_na_",0);
  clusterService.setState(state(index,true,ShardRoutingState.STARTED,ShardRoutingState.STARTED));
  logger.debug("--> using initial state:\n{}",clusterService.state().prettyPrint());
  Request request=new Request(shardId).timeout("100ms");
  PlainActionFuture<Response> listener=new PlainActionFuture<>();
  ReplicationTask task=maybeTask();
  TransportReplicationAction.PrimaryPhase primaryPhase=action.new PrimaryPhase(task,request,createTransportChannel(listener));
  primaryPhase.run();
  assertThat(transport.capturedRequests().length,equalTo(0));
  assertIndexShardCounter(1);
  assertPhase(task,"failed");
}
