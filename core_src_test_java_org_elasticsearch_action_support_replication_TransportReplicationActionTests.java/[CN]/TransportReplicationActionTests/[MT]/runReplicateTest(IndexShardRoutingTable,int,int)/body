{
  final ShardIterator shardIt=shardRoutingTable.shardsIt();
  final ShardId shardId=shardIt.shardId();
  final Request request=new Request(shardId);
  final PlainActionFuture<Response> listener=new PlainActionFuture<>();
  logger.debug("expecting [{}] assigned replicas, [{}] total shards. using state: \n{}",assignedReplicas,totalShards,clusterService.state().prettyPrint());
  Releasable reference=getOrCreateIndexShardOperationsCounter();
  assertIndexShardCounter(2);
  TransportReplicationAction<Request,Request,Response>.ReplicationPhase replicationPhase=action.new ReplicationPhase(request,new Response(),request.shardId(),createTransportChannel(listener),reference,null);
  assertThat(replicationPhase.totalShards(),equalTo(totalShards));
  assertThat(replicationPhase.pending(),equalTo(assignedReplicas));
  replicationPhase.run();
  final CapturingTransport.CapturedRequest[] capturedRequests=transport.capturedRequests();
  transport.clear();
  assertThat(capturedRequests.length,equalTo(assignedReplicas));
  Set<String> nodesSentTo=new HashSet<>();
  boolean executeOnReplica=action.shouldExecuteReplication(clusterService.state().getMetaData().index(shardId.getIndex()).getSettings());
  for (  CapturingTransport.CapturedRequest capturedRequest : capturedRequests) {
    assertTrue(nodesSentTo.add(capturedRequest.node.getId()));
    Request replicationRequest=(Request)capturedRequest.request;
    assertEquals(request.shardId,replicationRequest.shardId);
  }
  List<ShardRouting> shards=clusterService.state().getRoutingTable().index(shardId.getIndex()).shard(shardId.id()).shards();
  for (  ShardRouting shard : shards) {
    if (!shard.primary() && !executeOnReplica) {
      continue;
    }
    if (shard.unassigned()) {
      continue;
    }
    if (!clusterService.state().getNodes().localNodeId().equals(shard.currentNodeId())) {
      assertThat(nodesSentTo,hasItem(shard.currentNodeId()));
    }
    if (shard.relocating()) {
      assertThat(nodesSentTo,hasItem(shard.relocatingNodeId()));
    }
  }
  if (assignedReplicas > 0) {
    assertThat("listener is done, but there are outstanding replicas",listener.isDone(),equalTo(false));
  }
  int pending=replicationPhase.pending();
  int criticalFailures=0;
  int successful=1;
  List<CapturingTransport.CapturedRequest> failures=new ArrayList<>();
  for (  CapturingTransport.CapturedRequest capturedRequest : capturedRequests) {
    if (randomBoolean()) {
      Throwable t;
      boolean criticalFailure=randomBoolean();
      if (criticalFailure) {
        t=new CorruptIndexException("simulated",(String)null);
        criticalFailures++;
      }
 else {
        t=new IndexShardNotStartedException(shardId,IndexShardState.RECOVERING);
      }
      logger.debug("--> simulating failure on {} with [{}]",capturedRequest.node,t.getClass().getSimpleName());
      transport.handleResponse(capturedRequest.requestId,t);
      if (criticalFailure) {
        CapturingTransport.CapturedRequest[] shardFailedRequests=transport.capturedRequests();
        transport.clear();
        assertEquals(1,shardFailedRequests.length);
        CapturingTransport.CapturedRequest shardFailedRequest=shardFailedRequests[0];
        ShardRouting routing=clusterService.state().getRoutingNodes().node(capturedRequest.node.id()).get(request.shardId.id());
        ShardStateAction.ShardRoutingEntry shardRoutingEntry=(ShardStateAction.ShardRoutingEntry)shardFailedRequest.request;
        assertTrue(shardRoutingEntry.getShardRouting().isSameAllocation(routing));
        failures.add(shardFailedRequest);
        transport.handleResponse(shardFailedRequest.requestId,TransportResponse.Empty.INSTANCE);
      }
    }
 else {
      successful++;
      transport.handleResponse(capturedRequest.requestId,TransportResponse.Empty.INSTANCE);
    }
    pending--;
    assertThat(replicationPhase.pending(),equalTo(pending));
    assertThat(replicationPhase.successful(),equalTo(successful));
  }
  assertThat(listener.isDone(),equalTo(true));
  Response response=listener.get();
  final ReplicationResponse.ShardInfo shardInfo=response.getShardInfo();
  assertThat(shardInfo.getFailed(),equalTo(criticalFailures));
  assertThat(shardInfo.getFailures(),arrayWithSize(criticalFailures));
  assertThat(shardInfo.getSuccessful(),equalTo(successful));
  assertThat(shardInfo.getTotal(),equalTo(totalShards));
  assertThat("failed to see enough shard failures",failures.size(),equalTo(criticalFailures));
  for (  CapturingTransport.CapturedRequest capturedRequest : transport.capturedRequests()) {
    assertThat(capturedRequest.action,equalTo(ShardStateAction.SHARD_FAILED_ACTION_NAME));
  }
  assertIndexShardCounter(1);
}
