{
  final String index="test";
  final ShardId shardId=new ShardId(index,"_na_",0);
  clusterService.setState(state(index,true,ShardRoutingState.STARTED,ShardRoutingState.STARTED));
  ShardRouting primaryShard=clusterService.state().routingTable().shardRoutingTable(shardId).primaryShard();
  indexShardRouting.set(primaryShard);
  logger.debug("--> using initial state:\n{}",clusterService.state().prettyPrint());
  Request request=new Request(shardId).timeout("100ms");
  PlainActionFuture<Response> listener=new PlainActionFuture<>();
  ReplicationTask task=maybeTask();
  TransportReplicationAction.PrimaryPhase primaryPhase=action.new PrimaryPhase(task,request,createTransportChannel(listener));
  primaryPhase.run();
  assertIndexShardCounter(2);
  assertThat(transport.capturedRequests().length,equalTo(1));
  transport.handleResponse(transport.capturedRequests()[0].requestId,TransportResponse.Empty.INSTANCE);
  transport.clear();
  assertIndexShardCounter(1);
  assertPhase(task,"finished");
  request=new Request(shardId).timeout("100ms");
  task=maybeTask();
  primaryPhase=action.new PrimaryPhase(task,request,createTransportChannel(listener));
  primaryPhase.run();
  assertIndexShardCounter(2);
  assertPhase(task,"replicating");
  CapturingTransport.CapturedRequest[] replicationRequests=transport.getCapturedRequestsAndClear();
  assertThat(replicationRequests.length,equalTo(1));
  transport.handleRemoteError(replicationRequests[0].requestId,new CorruptIndexException("simulated",(String)null));
  CapturingTransport.CapturedRequest[] shardFailedRequests=transport.getCapturedRequestsAndClear();
  assertEquals(1,shardFailedRequests.length);
  transport.handleResponse(shardFailedRequests[0].requestId,TransportResponse.Empty.INSTANCE);
  assertIndexShardCounter(1);
}
