{
  SearchResponse response=client().prepareSearch("idx","unmapped_idx").addAggregation(missing("top_missing").field("tag").subAggregation(missing("sub_missing"))).execute().actionGet();
  assertSearchResponse(response);
  Missing topMissing=response.getAggregations().get("top_missing");
  assertThat(topMissing,notNullValue());
  assertThat(topMissing.getName(),equalTo("top_missing"));
  assertThat(topMissing.getDocCount(),equalTo((long)numDocsMissing + numDocsUnmapped));
  assertThat(topMissing.getAggregations().asList().isEmpty(),is(false));
  Missing subMissing=topMissing.getAggregations().get("sub_missing");
  assertThat(subMissing,notNullValue());
  assertThat(subMissing.getName(),equalTo("sub_missing"));
  assertThat(subMissing.getDocCount(),equalTo((long)numDocsMissing + numDocsUnmapped));
}
