{
  Builder builder=ImmutableSettings.builder();
  builder.put("index.analysis.analyzer.synonym.tokenizer","whitespace");
  builder.putArray("index.analysis.analyzer.synonym.filter","synonym","lowercase");
  builder.put("index.analysis.filter.synonym.type","synonym");
  builder.putArray("index.analysis.filter.synonym.synonyms","ave => ave, avenue","street => str, street");
  XContentBuilder mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field1").field("type","string").field("index_analyzer","whitespace").field("search_analyzer","synonym").endObject().endObject().endObject().endObject();
  assertAcked(client().admin().indices().prepareCreate("test").addMapping("type1",mapping).setSettings(builder.put("index.number_of_shards",1)));
  client().prepareIndex("test","type1","3").setSource("field1","massachusetts").execute().actionGet();
  client().prepareIndex("test","type1","6").setSource("field1","massachusetts avenue lexington massachusetts").execute().actionGet();
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  client().prepareIndex("test","type1","1").setSource("field1","lexington massachusetts avenue").execute().actionGet();
  client().prepareIndex("test","type1","2").setSource("field1","lexington avenue boston massachusetts road").execute().actionGet();
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch().setQuery(QueryBuilders.matchQuery("field1","massachusetts").operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(5).execute().actionGet();
  assertThat(searchResponse.getHits().hits().length,equalTo(4));
  assertHitCount(searchResponse,4);
  assertFirstHit(searchResponse,hasId("3"));
  assertSecondHit(searchResponse,hasId("6"));
  assertThirdHit(searchResponse,hasId("1"));
  assertFourthHit(searchResponse,hasId("2"));
  searchResponse=client().prepareSearch().setQuery(QueryBuilders.matchQuery("field1","massachusetts").operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(5).setRescorer(RescoreBuilder.queryRescorer(QueryBuilders.matchPhraseQuery("field1","lexington avenue massachusetts").slop(3)).setQueryWeight(1.0f).setRescoreQueryWeight(-1f)).setRescoreWindow(3).execute().actionGet();
  assertFirstHit(searchResponse,hasId("3"));
  assertSecondHit(searchResponse,hasId("2"));
  assertThirdHit(searchResponse,hasId("6"));
  assertFourthHit(searchResponse,hasId("1"));
}
