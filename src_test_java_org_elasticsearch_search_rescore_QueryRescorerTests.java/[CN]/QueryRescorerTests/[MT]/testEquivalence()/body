{
  client().admin().indices().prepareCreate("test").addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field1").field("analyzer","whitespace").field("type","string").endObject().endObject().endObject().endObject()).setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",between(1,5)).put("index.number_of_replicas",between(0,1))).execute().actionGet();
  ensureGreen();
  int numDocs=atLeast(100);
  IndexRequestBuilder[] docs=new IndexRequestBuilder[numDocs];
  for (int i=0; i < numDocs; i++) {
    docs[i]=client().prepareIndex("test","type1",String.valueOf(i)).setSource("field1",English.intToEnglish(i));
  }
  indexRandom(true,docs);
  ensureGreen();
  final int iters=atLeast(50);
  for (int i=0; i < iters; i++) {
    String intToEnglish=English.intToEnglish(between(0,numDocs - 1));
    String query=intToEnglish.split(" ")[0];
    SearchResponse rescored=client().prepareSearch().setPreference("test").setQuery(QueryBuilders.matchQuery("field1",query).operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(10).setRescorer(RescoreBuilder.queryRescorer(QueryBuilders.constantScoreQuery(QueryBuilders.matchPhraseQuery("field1",intToEnglish).slop(3))).setQueryWeight(1.0f).setRescoreQueryWeight(0.0f)).setRescoreWindow(50).execute().actionGet();
    SearchResponse plain=client().prepareSearch().setPreference("test").setQuery(QueryBuilders.matchQuery("field1",query).operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(10).execute().actionGet();
    assertEquivalent(plain,rescored);
    rescored=client().prepareSearch().setPreference("test").setQuery(QueryBuilders.matchQuery("field1",query).operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(10).setRescorer(RescoreBuilder.queryRescorer(QueryBuilders.constantScoreQuery(QueryBuilders.matchPhraseQuery("field1","not in the index").slop(3))).setQueryWeight(1.0f).setRescoreQueryWeight(1.0f)).setRescoreWindow(50).execute().actionGet();
    assertEquivalent(plain,rescored);
    rescored=client().prepareSearch().setPreference("test").setQuery(QueryBuilders.matchQuery("field1",query).operator(MatchQueryBuilder.Operator.OR)).setFrom(0).setSize(10).setRescorer(RescoreBuilder.queryRescorer(QueryBuilders.matchPhraseQuery("field1",intToEnglish).slop(0)).setQueryWeight(1.0f).setRescoreQueryWeight(1.0f)).setRescoreWindow(100).execute().actionGet();
    assertEquivalentOrSubstringMatch(intToEnglish,plain,rescored);
  }
}
