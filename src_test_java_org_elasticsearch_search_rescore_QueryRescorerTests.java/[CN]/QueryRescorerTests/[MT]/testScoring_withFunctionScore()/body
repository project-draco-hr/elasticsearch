{
  client().admin().indices().prepareCreate("test").addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field1").field("index","not_analyzed").field("type","string").endObject().endObject().endObject().endObject()).setSettings(ImmutableSettings.settingsBuilder()).execute().actionGet();
  ensureGreen();
  int numDocs=1000;
  for (int i=0; i < numDocs; i++) {
    client().prepareIndex("test","type1",String.valueOf(i)).setSource("field1",English.intToEnglish(i)).execute().actionGet();
  }
  flush();
  optimize();
  refresh();
  ensureGreen();
  String[] scoreModes=new String[]{"max","min","avg","total","multiply",""};
  float primaryWeight=1.1f;
  float secondaryWeight=1.6f;
  for (  String scoreMode : scoreModes) {
    for (int i=0; i < numDocs - 4; i++) {
      String[] intToEnglish=new String[]{English.intToEnglish(i),English.intToEnglish(i + 1),English.intToEnglish(i + 2),English.intToEnglish(i + 3)};
      QueryRescorer rescoreQuery=RescoreBuilder.queryRescorer(QueryBuilders.boolQuery().disableCoord(true).should(QueryBuilders.functionScoreQuery(QueryBuilders.termQuery("field1",intToEnglish[0]),scriptFunction("5.0f")).boostMode(CombineFunction.REPLACE.getName())).should(QueryBuilders.functionScoreQuery(QueryBuilders.termQuery("field1",intToEnglish[1]),scriptFunction("7.0f")).boostMode(CombineFunction.REPLACE.getName())).should(QueryBuilders.functionScoreQuery(QueryBuilders.termQuery("field1",intToEnglish[3]),scriptFunction("0.0f")).boostMode(CombineFunction.REPLACE.getName()))).setQueryWeight(primaryWeight).setRescoreQueryWeight(secondaryWeight);
      if (!"".equals(scoreMode)) {
        rescoreQuery.setScoreMode(scoreMode);
      }
      SearchResponse rescored=client().prepareSearch().setPreference("test").setQuery(QueryBuilders.boolQuery().disableCoord(true).should(QueryBuilders.functionScoreQuery(QueryBuilders.termQuery("field1",intToEnglish[0]),scriptFunction("2.0f")).boostMode(CombineFunction.REPLACE.getName())).should(QueryBuilders.functionScoreQuery(QueryBuilders.termQuery("field1",intToEnglish[1]),scriptFunction("3.0f")).boostMode(CombineFunction.REPLACE.getName())).should(QueryBuilders.functionScoreQuery(QueryBuilders.termQuery("field1",intToEnglish[2]),scriptFunction("5.0f")).boostMode(CombineFunction.REPLACE.getName())).should(QueryBuilders.functionScoreQuery(QueryBuilders.termQuery("field1",intToEnglish[3]),scriptFunction("0.2f")).boostMode(CombineFunction.REPLACE.getName()))).setFrom(0).setSize(10).setRescorer(rescoreQuery).setRescoreWindow(50).execute().actionGet();
      assertHitCount(rescored,4);
      if ("total".equals(scoreMode) || "".equals(scoreMode)) {
        assertFirstHit(rescored,hasId(String.valueOf(i + 1)));
        assertSecondHit(rescored,hasId(String.valueOf(i)));
        assertThirdHit(rescored,hasId(String.valueOf(i + 2)));
        assertThat(rescored.getHits().getHits()[0].getScore(),equalTo(3.0f * primaryWeight + 7.0f * secondaryWeight));
        assertThat(rescored.getHits().getHits()[1].getScore(),equalTo(2.0f * primaryWeight + 5.0f * secondaryWeight));
        assertThat(rescored.getHits().getHits()[2].getScore(),equalTo(5.0f * primaryWeight));
        assertThat(rescored.getHits().getHits()[3].getScore(),equalTo(0.2f * primaryWeight + 0.0f * secondaryWeight));
      }
 else       if ("max".equals(scoreMode)) {
        assertFirstHit(rescored,hasId(String.valueOf(i + 1)));
        assertSecondHit(rescored,hasId(String.valueOf(i)));
        assertThirdHit(rescored,hasId(String.valueOf(i + 2)));
        assertThat(rescored.getHits().getHits()[0].getScore(),equalTo(7.0f * secondaryWeight));
        assertThat(rescored.getHits().getHits()[1].getScore(),equalTo(5.0f * secondaryWeight));
        assertThat(rescored.getHits().getHits()[2].getScore(),equalTo(5.0f * primaryWeight));
        assertThat(rescored.getHits().getHits()[3].getScore(),equalTo(0.2f * primaryWeight));
      }
 else       if ("min".equals(scoreMode)) {
        assertFirstHit(rescored,hasId(String.valueOf(i + 2)));
        assertSecondHit(rescored,hasId(String.valueOf(i + 1)));
        assertThirdHit(rescored,hasId(String.valueOf(i)));
        assertThat(rescored.getHits().getHits()[0].getScore(),equalTo(5.0f * primaryWeight));
        assertThat(rescored.getHits().getHits()[1].getScore(),equalTo(3.0f * primaryWeight));
        assertThat(rescored.getHits().getHits()[2].getScore(),equalTo(2.0f * primaryWeight));
        assertThat(rescored.getHits().getHits()[3].getScore(),equalTo(0.0f * secondaryWeight));
      }
 else       if ("avg".equals(scoreMode)) {
        assertFirstHit(rescored,hasId(String.valueOf(i + 1)));
        assertSecondHit(rescored,hasId(String.valueOf(i + 2)));
        assertThirdHit(rescored,hasId(String.valueOf(i)));
        assertThat(rescored.getHits().getHits()[0].getScore(),equalTo((3.0f * primaryWeight + 7.0f * secondaryWeight) / 2.0f));
        assertThat(rescored.getHits().getHits()[1].getScore(),equalTo(5.0f * primaryWeight));
        assertThat(rescored.getHits().getHits()[2].getScore(),equalTo((2.0f * primaryWeight + 5.0f * secondaryWeight) / 2.0f));
        assertThat(rescored.getHits().getHits()[3].getScore(),equalTo((0.2f * primaryWeight) / 2.0f));
      }
 else       if ("multiply".equals(scoreMode)) {
        assertFirstHit(rescored,hasId(String.valueOf(i + 1)));
        assertSecondHit(rescored,hasId(String.valueOf(i)));
        assertThirdHit(rescored,hasId(String.valueOf(i + 2)));
        assertThat(rescored.getHits().getHits()[0].getScore(),equalTo(3.0f * primaryWeight * 7.0f* secondaryWeight));
        assertThat(rescored.getHits().getHits()[1].getScore(),equalTo(2.0f * primaryWeight * 5.0f* secondaryWeight));
        assertThat(rescored.getHits().getHits()[2].getScore(),equalTo(5.0f * primaryWeight));
        assertThat(rescored.getHits().getHits()[3].getScore(),equalTo(0.2f * primaryWeight * 0.0f* secondaryWeight));
      }
    }
  }
}
