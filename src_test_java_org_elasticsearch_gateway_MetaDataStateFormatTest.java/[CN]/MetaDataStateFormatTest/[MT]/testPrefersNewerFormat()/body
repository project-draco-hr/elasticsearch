{
  final ToXContent.Params params=ToXContent.EMPTY_PARAMS;
  MetaDataStateFormat<MetaData> format=MetaStateService.globalStateFormat(randomFrom(XContentType.values()),params);
  final Path[] dirs=new Path[2];
  dirs[0]=newTempDirPath();
  dirs[1]=newTempDirPath();
  for (  Path dir : dirs) {
    Files.createDirectories(dir.resolve(MetaDataStateFormat.STATE_DIR_NAME));
  }
  final long v=randomInt(10);
  MetaData meta=randomMeta();
  String uuid=meta.uuid();
  final Path dir2=randomFrom(dirs);
  MetaData meta2=randomMeta();
  assertFalse(meta2.uuid().equals(uuid));
  try (XContentBuilder xcontentBuilder=XContentFactory.contentBuilder(format.format(),Files.newOutputStream(dir2.resolve(MetaDataStateFormat.STATE_DIR_NAME).resolve(MetaStateService.GLOBAL_STATE_FILE_PREFIX + v)))){
    xcontentBuilder.startObject();
    MetaData.Builder.toXContent(randomMeta(),xcontentBuilder,params);
    xcontentBuilder.endObject();
  }
   format.write(meta,v,dirs);
  MetaData state=format.loadLatestState(logger,dirs);
  final Path path=randomFrom(dirs);
  assertTrue(Files.exists(path.resolve(MetaDataStateFormat.STATE_DIR_NAME).resolve("global-" + (v + 1) + ".st")));
  assertEquals(state.uuid(),uuid);
}
