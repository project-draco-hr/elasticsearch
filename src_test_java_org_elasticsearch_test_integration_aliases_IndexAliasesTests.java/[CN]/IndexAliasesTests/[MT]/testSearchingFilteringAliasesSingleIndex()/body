{
  client1.admin().indices().prepareDelete().execute().actionGet();
  logger.info("--> creating index [test]");
  client1.admin().indices().create(createIndexRequest("test")).actionGet();
  logger.info("--> running cluster_health");
  ClusterHealthResponse clusterHealth=client1.admin().cluster().health(clusterHealthRequest().waitForGreenStatus()).actionGet();
  logger.info("--> done cluster_health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("--> adding filtering aliases to index [test]");
  client1.admin().indices().prepareAliases().addAlias("test","alias1").execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test","alias2").execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test","foos",termFilter("name","foo")).execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test","bars",termFilter("name","bar")).execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test","tests",termFilter("name","test")).execute().actionGet();
  logger.info("--> indexing against [test]");
  client1.index(indexRequest("test").type("type1").id("1").source(source("1","foo test")).refresh(true)).actionGet();
  client1.index(indexRequest("test").type("type1").id("2").source(source("2","bar test")).refresh(true)).actionGet();
  client1.index(indexRequest("test").type("type1").id("3").source(source("3","baz test")).refresh(true)).actionGet();
  client1.index(indexRequest("test").type("type1").id("4").source(source("4","something else")).refresh(true)).actionGet();
  logger.info("--> checking single filtering alias search");
  SearchResponse searchResponse=client1.prepareSearch("foos").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1");
  searchResponse=client1.prepareSearch("tests").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","2","3");
  searchResponse=client1.prepareSearch("foos","bars").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","2");
  logger.info("--> checking single non-filtering alias search");
  searchResponse=client1.prepareSearch("alias1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","2","3","4");
  logger.info("--> checking non-filtering alias and filtering alias search");
  searchResponse=client1.prepareSearch("alias1","foos").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","2","3","4");
  logger.info("--> checking index and filtering alias search");
  searchResponse=client1.prepareSearch("test","foos").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","2","3","4");
}
