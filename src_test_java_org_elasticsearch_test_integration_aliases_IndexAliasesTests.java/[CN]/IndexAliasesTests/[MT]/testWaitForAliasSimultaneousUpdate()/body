{
  final int aliasCount=10;
  client1.admin().indices().prepareDelete().execute().actionGet();
  logger.info("--> creating index [test]");
  client1.admin().indices().create(createIndexRequest("test")).actionGet();
  logger.info("--> running cluster_health");
  ClusterHealthResponse clusterHealth=client1.admin().cluster().health(clusterHealthRequest().setWaitForGreenStatus()).actionGet();
  logger.info("--> done cluster_health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  ExecutorService executor=Executors.newFixedThreadPool(aliasCount);
  for (int i=0; i < aliasCount; i++) {
    final String aliasName="alias" + i;
    executor.submit(new Runnable(){
      @Override public void run(){
        assertThat(client1.admin().indices().prepareAliases().addAlias("test",aliasName).execute().actionGet().isAcknowledged(),equalTo(true));
        client2.index(indexRequest(aliasName).setType("type1").setId("1").setSource(source("1","test")).setRefresh(true)).actionGet();
      }
    }
);
  }
  executor.shutdown();
  boolean done=executor.awaitTermination(10,TimeUnit.SECONDS);
  assertThat(done,equalTo(true));
  if (!done) {
    executor.shutdownNow();
  }
}
