{
  client1.admin().indices().prepareDelete().execute().actionGet();
  logger.info("--> creating index [test1]");
  client1.admin().indices().create(createIndexRequest("test1")).actionGet();
  logger.info("--> creating index [test2]");
  client1.admin().indices().create(createIndexRequest("test2")).actionGet();
  logger.info("--> running cluster_health");
  ClusterHealthResponse clusterHealth=client1.admin().cluster().health(clusterHealthRequest().setWaitForGreenStatus()).actionGet();
  logger.info("--> done cluster_health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("--> adding filtering aliases to index [test1]");
  client1.admin().indices().prepareAliases().addAlias("test1","aliasToTest1").execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test1","aliasToTests").execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test1","foos",termFilter("name","foo")).execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test1","bars",termFilter("name","bar")).execute().actionGet();
  logger.info("--> adding filtering aliases to index [test2]");
  client1.admin().indices().prepareAliases().addAlias("test2","aliasToTest2").execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test2","aliasToTests").execute().actionGet();
  client1.admin().indices().prepareAliases().addAlias("test2","foos",termFilter("name","foo")).execute().actionGet();
  logger.info("--> indexing against [test1]");
  client1.index(indexRequest("test1").setType("type1").setId("1").setSource(source("1","foo test")).setRefresh(true)).actionGet();
  client1.index(indexRequest("test1").setType("type1").setId("2").setSource(source("2","bar test")).setRefresh(true)).actionGet();
  client1.index(indexRequest("test1").setType("type1").setId("3").setSource(source("3","baz test")).setRefresh(true)).actionGet();
  client1.index(indexRequest("test1").setType("type1").setId("4").setSource(source("4","something else")).setRefresh(true)).actionGet();
  logger.info("--> indexing against [test2]");
  client1.index(indexRequest("test2").setType("type1").setId("5").setSource(source("5","foo test")).setRefresh(true)).actionGet();
  client1.index(indexRequest("test2").setType("type1").setId("6").setSource(source("6","bar test")).setRefresh(true)).actionGet();
  client1.index(indexRequest("test2").setType("type1").setId("7").setSource(source("7","baz test")).setRefresh(true)).actionGet();
  client1.index(indexRequest("test2").setType("type1").setId("8").setSource(source("8","something else")).setRefresh(true)).actionGet();
  logger.info("--> checking filtering alias for two indices");
  SearchResponse searchResponse=client1.prepareSearch("foos").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","5");
  assertThat(client1.prepareCount("foos").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(2L));
  logger.info("--> checking filtering alias for one index");
  searchResponse=client1.prepareSearch("bars").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"2");
  assertThat(client1.prepareCount("bars").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(1L));
  logger.info("--> checking filtering alias for two indices and one complete index");
  searchResponse=client1.prepareSearch("foos","test1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","2","3","4","5");
  assertThat(client1.prepareCount("foos","test1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(5L));
  logger.info("--> checking filtering alias for two indices and non-filtering alias for one index");
  searchResponse=client1.prepareSearch("foos","aliasToTest1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertHits(searchResponse.getHits(),"1","2","3","4","5");
  assertThat(client1.prepareCount("foos","aliasToTest1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(5L));
  logger.info("--> checking filtering alias for two indices and non-filtering alias for both indices");
  searchResponse=client1.prepareSearch("foos","aliasToTests").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(8L));
  assertThat(client1.prepareCount("foos","aliasToTests").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(8L));
  logger.info("--> checking filtering alias for two indices and non-filtering alias for both indices");
  searchResponse=client1.prepareSearch("foos","aliasToTests").setQuery(QueryBuilders.termQuery("name","something")).execute().actionGet();
  assertHits(searchResponse.getHits(),"4","8");
  assertThat(client1.prepareCount("foos","aliasToTests").setQuery(QueryBuilders.termQuery("name","something")).execute().actionGet().getCount(),equalTo(2L));
}
