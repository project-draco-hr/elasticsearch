{
  CacheSegment<K,V> segment=getCacheSegment(key);
  Tuple<Entry<K,V>,Entry<K,V>> tuple=segment.put(key,value,now,onlyIfAbsent);
  lock.lock();
  boolean replaced=false;
  if (tuple.v2() != null && tuple.v2().state == State.EXISTING) {
    if (unlink(tuple.v2())) {
      replaced=true;
    }
  }
  promote(tuple.v1(),now);
  lock.unlock();
  if (replaced) {
    removalListener.onRemoval(new RemovalNotification(tuple.v2().key,tuple.v2().value,RemovalNotification.RemovalReason.REPLACED));
  }
}
