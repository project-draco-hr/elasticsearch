{
  assumeTrue("File system does not support permissions, skipping",supportsPermissions);
  URL pluginUrl=createPlugin(true,true);
  Files.createDirectories(environment.pluginsFile());
  try {
    Files.setPosixFilePermissions(environment.pluginsFile(),PosixFilePermissions.fromString("---------"));
    PluginManager pluginManager=new PluginManager(environment,pluginUrl,PluginManager.OutputMode.VERBOSE,TimeValue.timeValueSeconds(10));
    try {
      pluginManager.downloadAndExtract(pluginName,terminal);
      fail("Expected IOException due to read-only plugins/ directory");
    }
 catch (    IOException e) {
      assertFileNotExists(environment.binFile().resolve(pluginName));
      assertFileNotExists(environment.configFile().resolve(pluginName));
      Files.setPosixFilePermissions(environment.pluginsFile(),PosixFilePermissions.fromString("rwxrwxrwx"));
      assertDirectoryExists(environment.pluginsFile());
      assertFileNotExists(environment.pluginsFile().resolve(pluginName));
    }
  }
  finally {
    Files.setPosixFilePermissions(environment.pluginsFile(),PosixFilePermissions.fromString("rwxrwxrwx"));
  }
}
