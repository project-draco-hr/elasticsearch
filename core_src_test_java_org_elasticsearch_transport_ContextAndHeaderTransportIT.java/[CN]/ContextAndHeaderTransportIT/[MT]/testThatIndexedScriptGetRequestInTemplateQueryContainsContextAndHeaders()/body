{
  PutIndexedScriptResponse scriptResponse=transportClient().preparePutIndexedScript(MustacheScriptEngineService.NAME,"my_script",jsonBuilder().startObject().field("script","{ \"query\": { \"match\": { \"name\": \"Star Wars\" }}}").endObject().string()).get();
  assertThat(scriptResponse.isCreated(),is(true));
  transportClient().prepareIndex(queryIndex,"type","1").setSource(jsonBuilder().startObject().field("name","Star Wars - The new republic").endObject()).get();
  transportClient().admin().indices().prepareRefresh(queryIndex).get();
  SearchResponse searchResponse=transportClient().prepareSearch(queryIndex).setQuery(QueryBuilders.templateQuery(new Template("my_script",ScriptType.INDEXED,MustacheScriptEngineService.NAME,null,null))).get();
  assertNoFailures(searchResponse);
  assertHitCount(searchResponse,1);
  assertGetRequestsContainHeaders(".scripts");
  assertRequestsContainHeader(PutIndexedScriptRequest.class);
}
