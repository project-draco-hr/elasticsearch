{
  if (nodeInfo == null) {
    throw new IllegalStateException("Node has not started yet");
  }
  if (client == null) {
    TransportAddress addr=nodeInfo.getTransport().getAddress().publishAddress();
    Settings clientSettings=settingsBuilder().put("client.transport.nodes_sampler_interval","1s").put("name","transport_client_" + nodeInfo.getNode().name()).put(ClusterName.SETTING,clusterName).put("client.transport.sniff",false).build();
    Tuple<Settings,Environment> finalSettings=InternalSettingsPreparer.prepareSettings(clientSettings,true);
    assertFalse("backward compatibility tests must run in network mode. You probably have a system property overriding the test settings.",DiscoveryNode.localNode(finalSettings.v1()));
    TransportClient client=new TransportClient(clientSettings);
    client.addTransportAddress(addr);
    this.client=client;
  }
  return client;
}
