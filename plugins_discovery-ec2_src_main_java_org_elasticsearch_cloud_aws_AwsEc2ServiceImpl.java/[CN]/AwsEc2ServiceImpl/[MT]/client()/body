{
  if (client != null) {
    return client;
  }
  ClientConfiguration clientConfiguration=new ClientConfiguration();
  clientConfiguration.setResponseMetadataCacheSize(0);
  String protocol=settings.get(CLOUD_EC2.PROTOCOL,settings.get(CLOUD_AWS.PROTOCOL,"https")).toLowerCase(Locale.ROOT);
  if ("http".equals(protocol)) {
    clientConfiguration.setProtocol(Protocol.HTTP);
  }
 else   if ("https".equals(protocol)) {
    clientConfiguration.setProtocol(Protocol.HTTPS);
  }
 else {
    throw new IllegalArgumentException("No protocol supported [" + protocol + "], can either be [http] or [https]");
  }
  String account=settings.get(CLOUD_EC2.KEY,settings.get(CLOUD_AWS.KEY));
  String key=settings.get(CLOUD_EC2.SECRET,settings.get(CLOUD_AWS.SECRET));
  String proxyHost=settings.get(CLOUD_EC2.PROXY_HOST,settings.get(CLOUD_AWS.PROXY_HOST));
  if (proxyHost != null) {
    String portString=settings.get(CLOUD_EC2.PROXY_PORT,settings.get(CLOUD_AWS.PROXY_PORT,"80"));
    Integer proxyPort;
    try {
      proxyPort=Integer.parseInt(portString,10);
    }
 catch (    NumberFormatException ex) {
      throw new IllegalArgumentException("The configured proxy port value [" + portString + "] is invalid",ex);
    }
    clientConfiguration.withProxyHost(proxyHost).setProxyPort(proxyPort);
  }
  String awsSigner=settings.get(CLOUD_EC2.SIGNER,settings.get(CLOUD_AWS.SIGNER));
  if (awsSigner != null) {
    logger.debug("using AWS API signer [{}]",awsSigner);
    try {
      AwsSigner.configureSigner(awsSigner,clientConfiguration);
    }
 catch (    IllegalArgumentException e) {
      logger.warn("wrong signer set for [{}] or [{}]: [{}]",CLOUD_EC2.SIGNER,CLOUD_AWS.SIGNER,awsSigner);
    }
  }
  AWSCredentialsProvider credentials;
  if (account == null && key == null) {
    credentials=new AWSCredentialsProviderChain(new EnvironmentVariableCredentialsProvider(),new SystemPropertiesCredentialsProvider(),new InstanceProfileCredentialsProvider());
  }
 else {
    credentials=new AWSCredentialsProviderChain(new StaticCredentialsProvider(new BasicAWSCredentials(account,key)));
  }
  this.client=new AmazonEC2Client(credentials,clientConfiguration);
  if (settings.get(CLOUD_EC2.ENDPOINT) != null) {
    String endpoint=settings.get(CLOUD_EC2.ENDPOINT);
    logger.debug("using explicit ec2 endpoint [{}]",endpoint);
    client.setEndpoint(endpoint);
  }
 else   if (settings.get(CLOUD_AWS.REGION) != null) {
    String region=settings.get(CLOUD_AWS.REGION).toLowerCase(Locale.ROOT);
    String endpoint;
    if (region.equals("us-east-1") || region.equals("us-east")) {
      endpoint="ec2.us-east-1.amazonaws.com";
    }
 else     if (region.equals("us-west") || region.equals("us-west-1")) {
      endpoint="ec2.us-west-1.amazonaws.com";
    }
 else     if (region.equals("us-west-2")) {
      endpoint="ec2.us-west-2.amazonaws.com";
    }
 else     if (region.equals("ap-southeast") || region.equals("ap-southeast-1")) {
      endpoint="ec2.ap-southeast-1.amazonaws.com";
    }
 else     if (region.equals("us-gov-west") || region.equals("us-gov-west-1")) {
      endpoint="ec2.us-gov-west-1.amazonaws.com";
    }
 else     if (region.equals("ap-southeast-2")) {
      endpoint="ec2.ap-southeast-2.amazonaws.com";
    }
 else     if (region.equals("ap-northeast") || region.equals("ap-northeast-1")) {
      endpoint="ec2.ap-northeast-1.amazonaws.com";
    }
 else     if (region.equals("eu-west") || region.equals("eu-west-1")) {
      endpoint="ec2.eu-west-1.amazonaws.com";
    }
 else     if (region.equals("eu-central") || region.equals("eu-central-1")) {
      endpoint="ec2.eu-central-1.amazonaws.com";
    }
 else     if (region.equals("sa-east") || region.equals("sa-east-1")) {
      endpoint="ec2.sa-east-1.amazonaws.com";
    }
 else     if (region.equals("cn-north") || region.equals("cn-north-1")) {
      endpoint="ec2.cn-north-1.amazonaws.com.cn";
    }
 else {
      throw new IllegalArgumentException("No automatic endpoint could be derived from region [" + region + "]");
    }
    logger.debug("using ec2 region [{}], with endpoint [{}]",region,endpoint);
    client.setEndpoint(endpoint);
  }
  return this.client;
}
