{
  cluster().startNode();
  createIndex("test");
  for (int i=0; i < 1000; i++) {
    client().prepareIndex("test","type1",Long.toString(i)).setSource(MapBuilder.<String,Object>newMapBuilder().put("test","value" + i).map()).execute().actionGet();
  }
  client().admin().indices().prepareFlush().execute().actionGet();
  for (int i=1000; i < 2000; i++) {
    client().prepareIndex("test","type1",Long.toString(i)).setSource(MapBuilder.<String,Object>newMapBuilder().put("test","value" + i).map()).execute().actionGet();
  }
  cluster().startNode();
  cluster().startNode();
  assertThat(client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setTimeout("1m").setWaitForGreenStatus().setWaitForRelocatingShards(0).setWaitForNodes("3").execute().actionGet().isTimedOut(),equalTo(false));
  cluster().startNode();
  cluster().startNode();
  assertThat(client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setTimeout("1m").setWaitForGreenStatus().setWaitForRelocatingShards(0).setWaitForNodes("5").execute().actionGet().isTimedOut(),equalTo(false));
  client().admin().indices().prepareRefresh().execute().actionGet();
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareCount().setQuery(matchAllQuery()).execute().actionGet().getCount(),equalTo(2000l));
  }
  cluster().stopRandomNode();
  assertThat(client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setTimeout("1m").setWaitForGreenStatus().setWaitForRelocatingShards(0).setWaitForNodes("4").execute().actionGet().isTimedOut(),equalTo(false));
  cluster().stopRandomNode();
  assertThat(client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setTimeout("1m").setWaitForGreenStatus().setWaitForRelocatingShards(0).setWaitForNodes("3").execute().actionGet().isTimedOut(),equalTo(false));
  client().admin().indices().prepareRefresh().execute().actionGet();
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareCount().setQuery(matchAllQuery()).execute().actionGet().getCount(),equalTo(2000l));
  }
  cluster().stopRandomNode();
  assertThat(client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setTimeout("1m").setWaitForGreenStatus().setWaitForRelocatingShards(0).setWaitForNodes("2").execute().actionGet().isTimedOut(),equalTo(false));
  cluster().stopRandomNode();
  assertThat(client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setTimeout("1m").setWaitForYellowStatus().setWaitForRelocatingShards(0).setWaitForNodes("1").execute().actionGet().isTimedOut(),equalTo(false));
  client().admin().indices().prepareRefresh().execute().actionGet();
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareCount().setQuery(matchAllQuery()).execute().actionGet().getCount(),equalTo(2000l));
  }
}
