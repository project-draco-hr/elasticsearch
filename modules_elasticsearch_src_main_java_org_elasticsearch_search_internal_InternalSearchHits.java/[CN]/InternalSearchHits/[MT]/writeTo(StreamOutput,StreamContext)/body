{
  out.writeVLong(totalHits);
  out.writeFloat(maxScore);
  out.writeVInt(hits.length);
  if (hits.length > 0) {
    if (context.streamShardTarget() == StreamContext.ShardTargetType.LOOKUP) {
      int counter=1;
      for (      InternalSearchHit hit : hits) {
        if (hit.shard() != null) {
          Integer handle=context.shardHandleLookup().get(hit.shard());
          if (handle == null) {
            context.shardHandleLookup().put(hit.shard(),counter++);
          }
        }
      }
      out.writeVInt(context.shardHandleLookup().size());
      if (!context.shardHandleLookup().isEmpty()) {
        for (        Map.Entry<SearchShardTarget,Integer> entry : context.shardHandleLookup().entrySet()) {
          out.writeVInt(entry.getValue());
          entry.getKey().writeTo(out);
        }
      }
    }
    for (    InternalSearchHit hit : hits) {
      hit.writeTo(out,context);
    }
  }
}
