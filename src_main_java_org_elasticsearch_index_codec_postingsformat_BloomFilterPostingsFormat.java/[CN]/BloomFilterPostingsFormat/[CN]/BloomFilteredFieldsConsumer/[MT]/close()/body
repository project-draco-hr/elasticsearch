{
  if (closed) {
    return;
  }
  closed=true;
  delegateFieldsConsumer.close();
  List<Entry<FieldInfo,BloomFilter>> nonSaturatedBlooms=new ArrayList<>();
  for (  Entry<FieldInfo,BloomFilter> entry : bloomFilters.entrySet()) {
    nonSaturatedBlooms.add(entry);
  }
  String bloomFileName=IndexFileNames.segmentFileName(state.segmentInfo.name,state.segmentSuffix,BLOOM_EXTENSION);
  IndexOutput bloomOutput=null;
  try {
    bloomOutput=state.directory.createOutput(bloomFileName,state.context);
    CodecUtil.writeHeader(bloomOutput,BLOOM_CODEC_NAME,BLOOM_CODEC_VERSION_CURRENT);
    bloomOutput.writeString(delegatePostingsFormat.getName());
    bloomOutput.writeInt(nonSaturatedBlooms.size());
    for (    Entry<FieldInfo,BloomFilter> entry : nonSaturatedBlooms) {
      FieldInfo fieldInfo=entry.getKey();
      BloomFilter bloomFilter=entry.getValue();
      bloomOutput.writeInt(fieldInfo.number);
      saveAppropriatelySizedBloomFilter(bloomOutput,bloomFilter,fieldInfo);
    }
    CodecUtil.writeFooter(bloomOutput);
  }
  finally {
    IOUtils.close(bloomOutput);
  }
  bloomFilters.clear();
}
