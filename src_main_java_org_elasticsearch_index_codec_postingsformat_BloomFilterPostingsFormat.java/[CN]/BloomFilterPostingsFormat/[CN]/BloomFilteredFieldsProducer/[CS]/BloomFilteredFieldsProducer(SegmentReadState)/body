{
  String bloomFileName=IndexFileNames.segmentFileName(state.segmentInfo.name,state.segmentSuffix,BLOOM_EXTENSION);
  ChecksumIndexInput bloomIn=null;
  boolean success=false;
  try {
    bloomIn=state.directory.openChecksumInput(bloomFileName,state.context);
    int version=CodecUtil.checkHeader(bloomIn,BLOOM_CODEC_NAME,BLOOM_CODEC_VERSION,BLOOM_CODEC_VERSION_CURRENT);
    PostingsFormat delegatePostingsFormat=PostingsFormat.forName(bloomIn.readString());
    this.delegateFieldsProducer=delegatePostingsFormat.fieldsProducer(state);
    int numBlooms=bloomIn.readInt();
    boolean load=true;
    Store.StoreDirectory storeDir=DirectoryUtils.getStoreDirectory(state.directory);
    if (storeDir != null && storeDir.codecService() != null) {
      load=storeDir.codecService().isLoadBloomFilter();
    }
    if (load && state.context.context != IOContext.Context.MERGE) {
      for (int i=0; i < numBlooms; i++) {
        int fieldNum=bloomIn.readInt();
        BloomFilter bloom=BloomFilter.deserialize(bloomIn);
        FieldInfo fieldInfo=state.fieldInfos.fieldInfo(fieldNum);
        bloomsByFieldName.put(fieldInfo.name,bloom);
      }
      if (version >= BLOOM_CODEC_VERSION_CHECKSUM) {
        CodecUtil.checkFooter(bloomIn);
      }
 else {
        CodecUtil.checkEOF(bloomIn);
      }
    }
    IOUtils.close(bloomIn);
    success=true;
  }
  finally {
    if (!success) {
      IOUtils.closeWhileHandlingException(bloomIn,delegateFieldsProducer);
    }
  }
}
