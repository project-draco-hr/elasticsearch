{
  GroupShardsIterator iterator=clusterState.routingTable().allActiveShardsGrouped(concreteIndices,true);
  Set<String> indicesWithMissingPrimaries=indicesWithMissingPrimaries(clusterState,concreteIndices);
  if (indicesWithMissingPrimaries.isEmpty()) {
    return iterator;
  }
  throw new PrimaryMissingActionException("Cannot upgrade indices because the following indices are missing primary shards " + indicesWithMissingPrimaries);
}
