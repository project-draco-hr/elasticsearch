{
  internalCluster().startNodesAsync(3).get();
  prepareCreate("test").setSettings(Settings.builder().put(IndexMetaData.SETTING_NUMBER_OF_SHARDS,1).put(IndexMetaData.SETTING_NUMBER_OF_REPLICAS,1).put(UnassignedInfo.INDEX_DELAYED_NODE_LEFT_TIMEOUT_SETTING,TimeValue.timeValueHours(1))).get();
  ensureGreen("test");
  indexRandomData();
  internalCluster().stopRandomNode(InternalTestCluster.nameFilter(findNodeWithShard()));
  assertThat(client().admin().cluster().prepareState().all().get().getState().routingNodes().hasUnassigned(),equalTo(true));
  assertThat(client().admin().cluster().prepareHealth().get().getDelayedUnassignedShards(),equalTo(1));
  assertAcked(client().admin().indices().prepareUpdateSettings("test").setSettings(Settings.builder().put(UnassignedInfo.INDEX_DELAYED_NODE_LEFT_TIMEOUT_SETTING,TimeValue.timeValueMillis(0))).get());
  ensureGreen("test");
  assertThat(client().admin().cluster().prepareHealth().get().getDelayedUnassignedShards(),equalTo(0));
}
