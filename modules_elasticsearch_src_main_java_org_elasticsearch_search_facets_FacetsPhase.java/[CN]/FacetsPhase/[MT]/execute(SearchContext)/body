{
  if (context.facets() == null) {
    return;
  }
  if (context.queryResult().facets() != null) {
    return;
  }
  SearchContextFacets contextFacets=context.facets();
  List<Facet> facets=Lists.newArrayListWithCapacity(2);
  if (contextFacets.queryFacets() != null) {
    for (    SearchContextFacets.QueryFacet queryFacet : contextFacets.queryFacets()) {
      Filter facetFilter=new QueryWrapperFilter(queryFacet.query());
      facetFilter=context.filterCache().cache(facetFilter);
      long count;
      if (contextFacets.queryType() == SearchContextFacets.QueryExecutionType.COLLECT) {
        count=executeQueryCollectorCount(context,queryFacet,facetFilter);
      }
 else       if (contextFacets.queryType() == SearchContextFacets.QueryExecutionType.IDSET) {
        count=executeQueryIdSetCount(context,queryFacet,facetFilter);
      }
 else {
        throw new ElasticSearchIllegalStateException("No matching for type [" + contextFacets.queryType() + "]");
      }
      facets.add(new CountFacet(queryFacet.name(),count));
    }
  }
  context.queryResult().facets(new Facets(facets));
}
