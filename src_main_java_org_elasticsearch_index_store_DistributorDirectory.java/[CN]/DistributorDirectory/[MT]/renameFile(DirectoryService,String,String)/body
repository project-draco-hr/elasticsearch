{
  Directory directory=getDirectory(from);
  if (nameDirMapping.putIfAbsent(to,directory) != null) {
    throw new IOException("Can't rename file from " + from + " to: "+ to+ ": target file already exists");
  }
  boolean success=false;
  try {
    directoryService.renameFile(directory,from,to);
    nameDirMapping.remove(from);
    success=true;
  }
  finally {
    if (!success) {
      nameDirMapping.remove(to);
    }
  }
}
