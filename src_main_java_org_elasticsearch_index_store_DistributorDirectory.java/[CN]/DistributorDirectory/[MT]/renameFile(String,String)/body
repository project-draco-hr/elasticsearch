{
  Directory directory=getDirectory(source);
  if (nameDirMapping.putIfAbsent(dest,directory) != null) {
    throw new IOException("Can't rename file from " + source + " to: "+ dest+ ": target file already exists");
  }
  boolean success=false;
  try {
    directory.renameFile(source,dest);
    nameDirMapping.remove(source);
    success=true;
  }
  finally {
    if (!success) {
      nameDirMapping.remove(dest);
    }
  }
}
