{
  Settings settings=settingsBuilder().put("discovery.type","local").put(InternalClusterService.SETTING_CLUSTER_SERVICE_SLOW_TASK_LOGGING_THRESHOLD,"10s").build();
  internalCluster().startNode(settings);
  ClusterService clusterService1=internalCluster().getInstance(ClusterService.class);
  MockLogAppender mockAppender=new MockLogAppender();
  mockAppender.addExpectation(new MockLogAppender.UnseenEventExpectation("test1 shouldn't see because setting is too low","cluster.service",Level.WARN,"*cluster state update task [test1] took * above the warn threshold of *"));
  mockAppender.addExpectation(new MockLogAppender.SeenEventExpectation("test2","cluster.service",Level.WARN,"*cluster state update task [test2] took * above the warn threshold of 10ms"));
  mockAppender.addExpectation(new MockLogAppender.SeenEventExpectation("test3","cluster.service",Level.WARN,"*cluster state update task [test3] took * above the warn threshold of 10ms"));
  mockAppender.addExpectation(new MockLogAppender.SeenEventExpectation("test4","cluster.service",Level.WARN,"*cluster state update task [test4] took * above the warn threshold of 10ms"));
  Logger rootLogger=Logger.getRootLogger();
  rootLogger.addAppender(mockAppender);
  try {
    final CountDownLatch latch=new CountDownLatch(5);
    final CountDownLatch processedFirstTask=new CountDownLatch(1);
    clusterService1.submitStateUpdateTask("test1",new ProcessedClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState) throws Exception {
        Thread.sleep(100);
        return currentState;
      }
      @Override public void clusterStateProcessed(      String source,      ClusterState oldState,      ClusterState newState){
        latch.countDown();
        processedFirstTask.countDown();
      }
      @Override public void onFailure(      String source,      Throwable t){
        fail();
      }
    }
);
    processedFirstTask.await(1,TimeUnit.SECONDS);
    assertAcked(client().admin().cluster().prepareUpdateSettings().setTransientSettings(settingsBuilder().put(InternalClusterService.SETTING_CLUSTER_SERVICE_SLOW_TASK_LOGGING_THRESHOLD,"10ms")));
    clusterService1.submitStateUpdateTask("test2",new ProcessedClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState) throws Exception {
        Thread.sleep(100);
        throw new IllegalArgumentException("Testing handling of exceptions in the cluster state task");
      }
      @Override public void clusterStateProcessed(      String source,      ClusterState oldState,      ClusterState newState){
        fail();
      }
      @Override public void onFailure(      String source,      Throwable t){
        latch.countDown();
      }
    }
);
    clusterService1.submitStateUpdateTask("test3",new ProcessedClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState) throws Exception {
        Thread.sleep(100);
        return ClusterState.builder(currentState).incrementVersion().build();
      }
      @Override public void clusterStateProcessed(      String source,      ClusterState oldState,      ClusterState newState){
        latch.countDown();
      }
      @Override public void onFailure(      String source,      Throwable t){
        fail();
      }
    }
);
    clusterService1.submitStateUpdateTask("test4",new ProcessedClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState) throws Exception {
        Thread.sleep(100);
        return currentState;
      }
      @Override public void clusterStateProcessed(      String source,      ClusterState oldState,      ClusterState newState){
        latch.countDown();
      }
      @Override public void onFailure(      String source,      Throwable t){
        fail();
      }
    }
);
    clusterService1.submitStateUpdateTask("test5",new ProcessedClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState){
        return currentState;
      }
      @Override public void clusterStateProcessed(      String source,      ClusterState oldState,      ClusterState newState){
        latch.countDown();
      }
      @Override public void onFailure(      String source,      Throwable t){
        fail();
      }
    }
);
    assertThat(latch.await(5,TimeUnit.SECONDS),equalTo(true));
  }
  finally {
    rootLogger.removeAppender(mockAppender);
  }
  mockAppender.assertAllExpectationsMatched();
}
