{
  try {
    if (!routingTableDirty) {
      return;
    }
    if (lifecycle.stopped()) {
      return;
    }
    clusterService.submitStateUpdateTask(CLUSTER_UPDATE_TASK_SOURCE,Priority.HIGH,new ClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState){
        RoutingAllocation.Result routingResult=allocationService.reroute(currentState);
        if (!routingResult.changed()) {
          return currentState;
        }
        return ClusterState.builder(currentState).routingResult(routingResult).build();
      }
      @Override public void onFailure(      String source,      Throwable t){
        ClusterState state=clusterService.state();
        logger.error("unexpected failure during [{}], current state:\n{}",t,source,state.prettyPrint());
      }
    }
);
    routingTableDirty=false;
  }
 catch (  Exception e) {
    ClusterState state=clusterService.state();
    logger.warn("Failed to reroute routing table, current state:\n{}",e,state.prettyPrint());
  }
}
