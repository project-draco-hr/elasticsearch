{
  createIndex("test");
  String mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field1").field("type","text").field("store",true).endObject().startObject("field2").field("type","text").field("store",false).endObject().startObject("field3").field("type","text").field("store",true).endObject().endObject().endObject().endObject().string();
  client().admin().indices().preparePutMapping().setType("type1").setSource(mapping).execute().actionGet();
  client().prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("field1","value1").field("field2","value2").field("field3","value3").endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("field1").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("field2").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(0));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field2"),nullValue());
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("field3").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("*3").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("*3").addStoredField("field1").addStoredField("field2").get();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(2));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("field*").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(2));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("f*3").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("*").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).source(),nullValue());
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(2));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addStoredField("*").addStoredField("_source").get();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1L));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).source(),notNullValue());
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(2));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
}
