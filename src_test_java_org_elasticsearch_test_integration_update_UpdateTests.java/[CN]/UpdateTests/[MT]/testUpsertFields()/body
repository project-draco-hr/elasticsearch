{
  createIndex();
  ClusterHealthResponse clusterHealth=client.admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  UpdateResponse updateResponse=client.prepareUpdate("test","type1","1").setUpsertRequest(XContentFactory.jsonBuilder().startObject().field("bar","baz").endObject()).setScript("ctx._source.extra = \"foo\"").setFields("_source").execute().actionGet();
  assertThat(updateResponse.getGetResult(),notNullValue());
  assertThat(updateResponse.getGetResult().sourceAsMap().get("bar").toString(),equalTo("baz"));
  assertThat(updateResponse.getGetResult().sourceAsMap().get("extra"),nullValue());
  updateResponse=client.prepareUpdate("test","type1","1").setUpsertRequest(XContentFactory.jsonBuilder().startObject().field("bar","baz").endObject()).setScript("ctx._source.extra = \"foo\"").setFields("_source").execute().actionGet();
  assertThat(updateResponse.getGetResult(),notNullValue());
  assertThat(updateResponse.getGetResult().sourceAsMap().get("bar").toString(),equalTo("baz"));
  assertThat(updateResponse.getGetResult().sourceAsMap().get("extra").toString(),equalTo("foo"));
}
