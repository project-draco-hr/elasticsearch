{
  createIndex();
  ClusterHealthResponse clusterHealth=client.admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  client.prepareUpdate("test","type1","1").setUpsertRequest(XContentFactory.jsonBuilder().startObject().field("field",1).endObject()).setScript("ctx._source.field += 1").execute().actionGet();
  for (int i=0; i < 5; i++) {
    GetResponse getResponse=client.prepareGet("test","type1","1").execute().actionGet();
    assertThat(getResponse.getSourceAsMap().get("field").toString(),equalTo("1"));
  }
  client.prepareUpdate("test","type1","1").setUpsertRequest(XContentFactory.jsonBuilder().startObject().field("field",1).endObject()).setScript("ctx._source.field += 1").execute().actionGet();
  for (int i=0; i < 5; i++) {
    GetResponse getResponse=client.prepareGet("test","type1","1").execute().actionGet();
    assertThat(getResponse.getSourceAsMap().get("field").toString(),equalTo("2"));
  }
}
