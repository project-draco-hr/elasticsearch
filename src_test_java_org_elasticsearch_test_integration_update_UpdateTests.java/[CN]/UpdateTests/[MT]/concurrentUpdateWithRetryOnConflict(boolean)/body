{
  createIndex();
  ensureGreen();
  int numberOfThreads=5;
  final CountDownLatch latch=new CountDownLatch(numberOfThreads);
  final int numberOfUpdatesPerThread=10000;
  for (int i=0; i < numberOfThreads; i++) {
    Runnable r=new Runnable(){
      @Override public void run(){
        try {
          for (int i=0; i < numberOfUpdatesPerThread; i++) {
            if (useBulkApi) {
              UpdateRequestBuilder updateRequestBuilder=client().prepareUpdate("test","type1",Integer.toString(i)).setScript("ctx._source.field += 1").setRetryOnConflict(Integer.MAX_VALUE).setUpsertRequest(jsonBuilder().startObject().field("field",1).endObject());
              client().prepareBulk().add(updateRequestBuilder).execute().actionGet();
            }
 else {
              client().prepareUpdate("test","type1",Integer.toString(i)).setScript("ctx._source.field += 1").setRetryOnConflict(Integer.MAX_VALUE).setUpsertRequest(jsonBuilder().startObject().field("field",1).endObject()).execute().actionGet();
            }
          }
        }
 catch (        Exception e) {
          e.printStackTrace();
        }
 finally {
          latch.countDown();
        }
      }
    }
;
    new Thread(r).start();
  }
  latch.await();
  for (int i=0; i < numberOfUpdatesPerThread; i++) {
    GetResponse response=client().prepareGet("test","type1",Integer.toString(i)).execute().actionGet();
    assertThat(response.getId(),equalTo(Integer.toString(i)));
    assertThat(response.getVersion(),equalTo((long)numberOfThreads));
    assertThat((Integer)response.getSource().get("field"),equalTo(numberOfThreads));
  }
}
