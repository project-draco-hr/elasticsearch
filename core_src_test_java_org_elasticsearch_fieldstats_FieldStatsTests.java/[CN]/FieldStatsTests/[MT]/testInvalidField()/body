{
  createIndex("test1",Settings.EMPTY,"field1","value","type=string");
  client().prepareIndex("test1","test").setSource("field1","a").get();
  client().prepareIndex("test1","test").setSource("field1","b").get();
  createIndex("test2",Settings.EMPTY,"field2","value","type=string");
  client().prepareIndex("test2","test").setSource("field2","a").get();
  client().prepareIndex("test2","test").setSource("field2","b").get();
  client().admin().indices().prepareRefresh().get();
  FieldStatsResponse result=client().prepareFieldStats().setFields("field1","field2").get();
  assertThat(result.getFailedShards(),equalTo(2));
  assertThat(result.getTotalShards(),equalTo(2));
  assertThat(result.getSuccessfulShards(),equalTo(0));
  assertThat(result.getShardFailures()[0].reason(),either(containsString("field [field1] doesn't exist")).or(containsString("field [field2] doesn't exist")));
  assertThat(result.getIndicesMergedFieldStats().size(),equalTo(0));
  result=client().prepareFieldStats().setFields("field1").get();
  assertThat(result.getFailedShards(),equalTo(1));
  assertThat(result.getTotalShards(),equalTo(2));
  assertThat(result.getSuccessfulShards(),equalTo(1));
  assertThat(result.getShardFailures()[0].reason(),either(containsString("field [field1] doesn't exist")).or(containsString("field [field2] doesn't exist")));
  assertThat(result.getIndicesMergedFieldStats().get("_all").get("field1").getMinValue(),equalTo("a"));
  assertThat(result.getIndicesMergedFieldStats().get("_all").get("field1").getMaxValue(),equalTo("b"));
}
