{
  DateTime dateTime1=new DateTime(2014,1,1,0,0,0,0,DateTimeZone.UTC);
  String dateTime1Str=DateFieldMapper.Defaults.DATE_TIME_FORMATTER.parser().print(dateTime1);
  DateTime dateTime2=new DateTime(2014,1,2,0,0,0,0,DateTimeZone.UTC);
  String dateTime2Str=DateFieldMapper.Defaults.DATE_TIME_FORMATTER.parser().print(dateTime2);
  createIndex("test1",Settings.EMPTY,"type","value","type=date");
  client().prepareIndex("test1","test").setSource("value",dateTime1Str).get();
  createIndex("test2",Settings.EMPTY,"type","value","type=date");
  client().prepareIndex("test2","test").setSource("value",dateTime2Str).get();
  client().admin().indices().prepareRefresh().get();
  FieldStatsResponse response=client().prepareFieldStats().setFields("value").setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(2));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValue(),equalTo(dateTime1.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValue(),equalTo(dateTime2.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValueAsString(),equalTo(dateTime1Str));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValueAsString(),equalTo(dateTime2Str));
  response=client().prepareFieldStats().setFields("value").setIndexContraints(new IndexConstraint("value",MIN,GTE,"2013-12-30T00:00:00.000Z"),new IndexConstraint("value",MAX,LTE,"2013-12-31T00:00:00.000Z")).setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(0));
  response=client().prepareFieldStats().setFields("value").setIndexContraints(new IndexConstraint("value",MIN,GTE,"2013-12-31T00:00:00.000Z"),new IndexConstraint("value",MAX,LTE,"2014-01-01T00:00:00.000Z")).setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(1));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValue(),equalTo(dateTime1.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValueAsString(),equalTo(dateTime1Str));
  response=client().prepareFieldStats().setFields("value").setIndexContraints(new IndexConstraint("value",MIN,GT,"2014-01-01T00:00:00.000Z"),new IndexConstraint("value",MAX,LTE,"2014-01-02T00:00:00.000Z")).setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(1));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValue(),equalTo(dateTime2.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValueAsString(),equalTo(dateTime2Str));
  response=client().prepareFieldStats().setFields("value").setIndexContraints(new IndexConstraint("value",MIN,GT,"2014-01-02T00:00:00.000Z"),new IndexConstraint("value",MAX,LTE,"2014-01-03T00:00:00.000Z")).setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(0));
  response=client().prepareFieldStats().setFields("value").setIndexContraints(new IndexConstraint("value",MIN,GTE,"2014-01-01T23:00:00.000Z"),new IndexConstraint("value",MAX,LTE,"2014-01-02T01:00:00.000Z")).setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(1));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValue(),equalTo(dateTime2.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValueAsString(),equalTo(dateTime2Str));
  response=client().prepareFieldStats().setFields("value").setIndexContraints(new IndexConstraint("value",MIN,GTE,"2014-01-01T00:00:00.000Z")).setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(2));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValue(),equalTo(dateTime1.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValue(),equalTo(dateTime2.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValueAsString(),equalTo(dateTime1Str));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValueAsString(),equalTo(dateTime2Str));
  response=client().prepareFieldStats().setFields("value").setIndexContraints(new IndexConstraint("value",MAX,LTE,"2014-01-02T00:00:00.000Z")).setLevel("indices").get();
  assertThat(response.getIndicesMergedFieldStats().size(),equalTo(2));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValue(),equalTo(dateTime1.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValue(),equalTo(dateTime2.getMillis()));
  assertThat(response.getIndicesMergedFieldStats().get("test1").get("value").getMinValueAsString(),equalTo(dateTime1Str));
  assertThat(response.getIndicesMergedFieldStats().get("test2").get("value").getMinValueAsString(),equalTo(dateTime2Str));
}
