{
  IndexService indexService=createIndex("test");
  IndicesModule indicesModule=new IndicesModule();
  indicesModule.registerMetadataMapper("_dummy",new DummyMetadataFieldMapper.TypeParser());
  final MapperRegistry mapperRegistry=indicesModule.getMapperRegistry();
  MapperService mapperService=new MapperService(indexService.getIndexSettings(),indexService.analysisService(),indexService.similarityService(),mapperRegistry);
  DocumentMapperParser parser=new DocumentMapperParser(indexService.getIndexSettings(),mapperService,indexService.analysisService(),indexService.similarityService(),mapperRegistry);
  String mapping=XContentFactory.jsonBuilder().startObject().startObject("type").endObject().endObject().string();
  DocumentMapper mapper=parser.parse("type",new CompressedXContent(mapping));
  ParsedDocument parsedDocument=mapper.parse("index","type","id",new BytesArray("{}"));
  IndexableField[] fields=parsedDocument.rootDoc().getFields(FieldNamesFieldMapper.NAME);
  boolean found=false;
  for (  IndexableField f : fields) {
    if ("_dummy".equals(f.stringValue())) {
      found=true;
      break;
    }
  }
  assertTrue("Could not find the dummy field among " + Arrays.toString(fields),found);
}
