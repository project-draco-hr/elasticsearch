{
  aggregationPhase.preProcess(searchContext);
  searchContext.queryResult().searchTimedOut(false);
  searchContext.searcher().inStage(ContextIndexSearcher.Stage.MAIN_QUERY);
  boolean rescore=false;
  try {
    searchContext.queryResult().from(searchContext.from());
    searchContext.queryResult().size(searchContext.size());
    Query query=searchContext.query();
    final TopDocs topDocs;
    int numDocs=searchContext.from() + searchContext.size();
    if (searchContext.size() == 0) {
      topDocs=new TopDocs(searchContext.searcher().count(query),Lucene.EMPTY_SCORE_DOCS,0);
    }
 else     if (searchContext.searchType() == SearchType.SCAN) {
      topDocs=searchContext.scanContext().execute(searchContext);
    }
 else {
      if (searchContext.request().scroll() != null) {
        numDocs=searchContext.size();
        ScoreDoc lastEmittedDoc=searchContext.lastEmittedDoc();
        if (searchContext.sort() != null) {
          topDocs=searchContext.searcher().searchAfter(lastEmittedDoc,query,null,numDocs,searchContext.sort(),searchContext.trackScores(),searchContext.trackScores());
        }
 else {
          rescore=!searchContext.rescore().isEmpty();
          for (          RescoreSearchContext rescoreContext : searchContext.rescore()) {
            numDocs=Math.max(rescoreContext.window(),numDocs);
          }
          topDocs=searchContext.searcher().searchAfter(lastEmittedDoc,query,numDocs);
        }
        int size=topDocs.scoreDocs.length;
        if (size > 0) {
          if (searchContext.searchType() == SearchType.QUERY_AND_FETCH || searchContext.searchType() == SearchType.DFS_QUERY_AND_FETCH) {
            searchContext.lastEmittedDoc(topDocs.scoreDocs[size - 1]);
          }
        }
      }
 else {
        if (searchContext.sort() != null) {
          topDocs=searchContext.searcher().search(query,null,numDocs,searchContext.sort(),searchContext.trackScores(),searchContext.trackScores());
        }
 else {
          rescore=!searchContext.rescore().isEmpty();
          for (          RescoreSearchContext rescoreContext : searchContext.rescore()) {
            numDocs=Math.max(rescoreContext.window(),numDocs);
          }
          topDocs=searchContext.searcher().search(query,numDocs);
        }
      }
    }
    searchContext.queryResult().topDocs(topDocs);
  }
 catch (  Throwable e) {
    throw new QueryPhaseExecutionException(searchContext,"Failed to execute main query",e);
  }
 finally {
    searchContext.searcher().finishStage(ContextIndexSearcher.Stage.MAIN_QUERY);
  }
  if (rescore) {
    rescorePhase.execute(searchContext);
  }
  suggestPhase.execute(searchContext);
  aggregationPhase.execute(searchContext);
}
