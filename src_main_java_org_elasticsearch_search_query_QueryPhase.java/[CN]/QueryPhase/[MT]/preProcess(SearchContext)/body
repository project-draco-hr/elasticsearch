{
  if (context.query() == null) {
    context.parsedQuery(ParsedQuery.MATCH_ALL_PARSED_QUERY);
  }
  if (context.queryBoost() != 1.0f) {
    context.parsedQuery(new ParsedQuery(new FunctionScoreQuery(context.query(),new BoostScoreFunction(context.queryBoost())),context.parsedQuery()));
  }
  Filter searchFilter=context.mapperService().searchFilter(context.types());
  if (searchFilter != null) {
    if (Queries.isMatchAllQuery(context.query())) {
      Query q=new DeletionAwareConstantScoreQuery(context.filterCache().cache(searchFilter));
      q.setBoost(context.query().getBoost());
      context.parsedQuery(new ParsedQuery(q,context.parsedQuery()));
    }
 else {
      context.parsedQuery(new ParsedQuery(new FilteredQuery(context.query(),context.filterCache().cache(searchFilter)),context.parsedQuery()));
    }
  }
  facetPhase.preProcess(context);
}
