{
  client().admin().indices().prepareDeleteTemplate("*").get();
  GetIndexTemplatesResponse response=client().admin().indices().prepareGetTemplates().get();
  assertThat(response.getIndexTemplates(),empty());
  client().admin().indices().preparePutTemplate("template_1").setTemplate("te*").setOrder(0).addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field1").field("type","string").field("store","yes").endObject().startObject("field2").field("type","string").field("store","yes").field("index","not_analyzed").endObject().endObject().endObject().endObject()).get();
  client().admin().indices().preparePutTemplate("template_2").setTemplate("test*").setOrder(1).addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field2").field("type","string").field("store","no").endObject().endObject().endObject().endObject()).get();
  assertThrows(client().admin().indices().preparePutTemplate("template_2").setTemplate("test*").setCreate(true).setOrder(1).addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field2").field("type","string").field("store","no").endObject().endObject().endObject().endObject()),IndexTemplateAlreadyExistsException.class);
  response=client().admin().indices().prepareGetTemplates().get();
  assertThat(response.getIndexTemplates(),hasSize(2));
  client().prepareIndex("test_index","type1","1").setSource("field1","value1","field2","value 2").setRefresh(true).execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch("test_index").setQuery(termQuery("field1","value1")).addField("field1").addField("field2").execute().actionGet();
  assertHitCount(searchResponse,1);
  assertThat(searchResponse.getHits().getAt(0).field("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.getHits().getAt(0).field("field2").value().toString(),equalTo("value 2"));
  client().prepareIndex("text_index","type1","1").setSource("field1","value1","field2","value 2").setRefresh(true).execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  searchResponse=client().prepareSearch("text_index").setQuery(termQuery("field1","value1")).addField("field1").addField("field2").execute().actionGet();
  if (searchResponse.getFailedShards() > 0) {
    logger.warn("failed search " + Arrays.toString(searchResponse.getShardFailures()));
  }
  assertHitCount(searchResponse,1);
  assertThat(searchResponse.getHits().getAt(0).field("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.getHits().getAt(0).field("field2").value().toString(),equalTo("value 2"));
}
