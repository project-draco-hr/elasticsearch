{
  CodecUtil.checkHeader(input,CODEC_NAME,CODEC_VERSION,CODEC_VERSION);
  final Map<String,AnalyzingSuggestHolder> lookupMap=new HashMap<>();
  input.seek(input.length() - 8);
  long metaPointer=input.readLong();
  input.seek(metaPointer);
  int numFields=input.readVInt();
  Map<Long,String> meta=new TreeMap<>();
  for (int i=0; i < numFields; i++) {
    String name=input.readString();
    long offset=input.readVLong();
    meta.put(offset,name);
  }
  long sizeInBytes=0;
  for (  Map.Entry<Long,String> entry : meta.entrySet()) {
    input.seek(entry.getKey());
    FST<Pair<Long,BytesRef>> fst=new FST<>(input,new PairOutputs<>(PositiveIntOutputs.getSingleton(),ByteSequenceOutputs.getSingleton()));
    int maxAnalyzedPathsForOneInput=input.readVInt();
    int maxSurfaceFormsPerAnalyzedForm=input.readVInt();
    int maxGraphExpansions=input.readInt();
    int options=input.readVInt();
    boolean preserveSep=(options & SERIALIZE_PRESERVE_SEPARATORS) != 0;
    boolean hasPayloads=(options & SERIALIZE_HAS_PAYLOADS) != 0;
    boolean preservePositionIncrements=(options & SERIALIZE_PRESERVE_POSITION_INCREMENTS) != 0;
    sizeInBytes+=fst.ramBytesUsed();
    lookupMap.put(entry.getValue(),new AnalyzingSuggestHolder(preserveSep,preservePositionIncrements,maxSurfaceFormsPerAnalyzedForm,maxGraphExpansions,hasPayloads,maxAnalyzedPathsForOneInput,fst));
  }
  final long ramBytesUsed=sizeInBytes;
  return new LookupFactory(){
    @Override public Lookup getLookup(    CompletionFieldMapper.CompletionFieldType fieldType,    CompletionSuggestionContext suggestionContext){
      AnalyzingSuggestHolder analyzingSuggestHolder=lookupMap.get(fieldType.names().indexName());
      if (analyzingSuggestHolder == null) {
        return null;
      }
      int flags=analyzingSuggestHolder.getPreserveSeparator() ? XAnalyzingSuggester.PRESERVE_SEP : 0;
      final Automaton queryPrefix=fieldType.requiresContext() ? ContextQuery.toAutomaton(analyzingSuggestHolder.getPreserveSeparator(),suggestionContext.getContextQueries()) : null;
      XAnalyzingSuggester suggester;
      if (suggestionContext.isFuzzy()) {
        suggester=new XFuzzySuggester(fieldType.indexAnalyzer(),queryPrefix,fieldType.searchAnalyzer(),flags,analyzingSuggestHolder.maxSurfaceFormsPerAnalyzedForm,analyzingSuggestHolder.maxGraphExpansions,suggestionContext.getFuzzyEditDistance(),suggestionContext.isFuzzyTranspositions(),suggestionContext.getFuzzyPrefixLength(),suggestionContext.getFuzzyMinLength(),false,analyzingSuggestHolder.fst,analyzingSuggestHolder.hasPayloads,analyzingSuggestHolder.maxAnalyzedPathsForOneInput,SEP_LABEL,PAYLOAD_SEP,END_BYTE,HOLE_CHARACTER);
      }
 else {
        suggester=new XAnalyzingSuggester(fieldType.indexAnalyzer(),queryPrefix,fieldType.searchAnalyzer(),flags,analyzingSuggestHolder.maxSurfaceFormsPerAnalyzedForm,analyzingSuggestHolder.maxGraphExpansions,analyzingSuggestHolder.preservePositionIncrements,analyzingSuggestHolder.fst,analyzingSuggestHolder.hasPayloads,analyzingSuggestHolder.maxAnalyzedPathsForOneInput,SEP_LABEL,PAYLOAD_SEP,END_BYTE,HOLE_CHARACTER);
      }
      return suggester;
    }
    @Override public CompletionStats stats(    String... fields){
      long sizeInBytes=0;
      ObjectLongHashMap<String> completionFields=null;
      if (fields != null && fields.length > 0) {
        completionFields=new ObjectLongHashMap<>(fields.length);
      }
      for (      Map.Entry<String,AnalyzingSuggestHolder> entry : lookupMap.entrySet()) {
        sizeInBytes+=entry.getValue().fst.ramBytesUsed();
        if (fields == null || fields.length == 0) {
          continue;
        }
        for (        String field : fields) {
          if (Regex.simpleMatch(field,entry.getKey())) {
            long fstSize=entry.getValue().fst.ramBytesUsed();
            completionFields.addTo(field,fstSize);
          }
        }
      }
      return new CompletionStats(sizeInBytes,completionFields);
    }
    @Override AnalyzingSuggestHolder getAnalyzingSuggestHolder(    MappedFieldType fieldType){
      return lookupMap.get(fieldType.names().indexName());
    }
    @Override public long ramBytesUsed(){
      return ramBytesUsed;
    }
    @Override public Collection<Accountable> getChildResources(){
      return Accountables.namedAccountables("field",lookupMap);
    }
  }
;
}
