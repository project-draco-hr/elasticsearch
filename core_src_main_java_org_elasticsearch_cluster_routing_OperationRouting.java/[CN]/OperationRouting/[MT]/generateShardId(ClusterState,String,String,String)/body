{
  IndexMetaData indexMetaData=clusterState.metaData().index(index);
  if (indexMetaData == null) {
    throw new IndexNotFoundException(index);
  }
  final int hash;
  if (routing == null) {
    hash=Murmur3HashFunction.hash(id);
  }
 else {
    hash=Murmur3HashFunction.hash(routing);
  }
  return MathUtils.mod(hash,indexMetaData.getNumberOfShards());
}
