{
  if (request.getShardId() != -1) {
    return clusterState.routingTable().index(request.getIndex()).shard(request.getShardId()).primaryShardIt();
  }
  ShardIterator shardIterator=clusterService.operationRouting().indexShards(clusterService.state(),request.getIndex(),request.getType(),request.getId(),request.getRouting());
  ShardRouting shard;
  while ((shard=shardIterator.nextOrNull()) != null) {
    if (shard.primary()) {
      return new PlainShardIterator(shardIterator.shardId(),ImmutableList.of(shard));
    }
  }
  return new PlainShardIterator(shardIterator.shardId(),ImmutableList.<ShardRouting>of());
}
