{
  Map<String,GetField> fields=null;
  if (request.fields() != null && request.fields().length > 0) {
    SourceLookup sourceLookup=new SourceLookup();
    sourceLookup.setNextSource(source);
    for (    String field : request.fields()) {
      Object value=null;
      if (field.equals("_source")) {
        value=source;
      }
 else {
        value=sourceLookup.extractValue(field);
      }
      if (value != null) {
        if (fields == null) {
          fields=newHashMapWithExpectedSize(2);
        }
        GetField getField=fields.get(field);
        if (getField == null) {
          getField=new GetField(field,new ArrayList<Object>(2));
          fields.put(field,getField);
        }
        getField.values().add(value);
      }
    }
  }
  return fields;
}
