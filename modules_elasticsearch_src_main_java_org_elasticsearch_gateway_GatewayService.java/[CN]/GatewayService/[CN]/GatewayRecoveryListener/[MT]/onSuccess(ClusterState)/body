{
  final AtomicInteger indicesCounter=new AtomicInteger(recoveredState.metaData().indices().size());
  clusterService.submitStateUpdateTask("local-gateway-elected-state",new ProcessedClusterStateUpdateTask(){
    @Override public ClusterState execute(    ClusterState currentState){
      MetaData.Builder metaDataBuilder=newMetaDataBuilder().metaData(currentState.metaData());
      metaDataBuilder.markAsRecoveredFromGateway();
      for (      Map.Entry<String,IndexTemplateMetaData> entry : recoveredState.metaData().templates().entrySet()) {
        metaDataBuilder.put(entry.getValue());
      }
      return newClusterStateBuilder().state(currentState).version(recoveredState.version()).metaData(metaDataBuilder).build();
    }
    @Override public void clusterStateProcessed(    ClusterState clusterState){
      if (recoveredState.metaData().indices().isEmpty()) {
        markMetaDataAsReadFromGateway("success");
        latch.countDown();
        return;
      }
      for (      final IndexMetaData indexMetaData : recoveredState.metaData()) {
        try {
          createIndexService.createIndex(new MetaDataCreateIndexService.Request(MetaDataCreateIndexService.Request.Origin.GATEWAY,"gateway",indexMetaData.index()).settings(indexMetaData.settings()).mappingsMetaData(indexMetaData.mappings()).state(indexMetaData.state()).timeout(timeValueSeconds(30)),new MetaDataCreateIndexService.Listener(){
            @Override public void onResponse(            MetaDataCreateIndexService.Response response){
              if (indicesCounter.decrementAndGet() == 0) {
                markMetaDataAsReadFromGateway("success");
                latch.countDown();
              }
            }
            @Override public void onFailure(            Throwable t){
              logger.error("failed to create index [{}]",t,indexMetaData.index());
              if (indicesCounter.decrementAndGet() == 0) {
                markMetaDataAsReadFromGateway("success");
                latch.countDown();
              }
            }
          }
);
        }
 catch (        IOException e) {
          logger.error("failed to create index [{}]",e,indexMetaData.index());
          if (indicesCounter.decrementAndGet() == 0) {
            markMetaDataAsReadFromGateway("success");
            latch.countDown();
          }
        }
      }
    }
  }
);
}
