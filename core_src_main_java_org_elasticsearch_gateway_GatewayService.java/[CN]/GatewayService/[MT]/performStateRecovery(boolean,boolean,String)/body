{
  final Gateway.GatewayStateRecoveredListener recoveryListener=new GatewayRecoveryListener(new CountDownLatch(1));
  if (enforceRecoverAfterTime && recoverAfterTime != null) {
    if (scheduledRecovery.compareAndSet(false,true)) {
      logger.info("delaying initial state recovery for [{}]. {}",recoverAfterTime,reason);
      threadPool.schedule(recoverAfterTime,ThreadPool.Names.GENERIC,new Runnable(){
        @Override public void run(){
          if (recovered.compareAndSet(false,true)) {
            logger.info("recover_after_time [{}] elapsed. performing state recovery...",recoverAfterTime);
            gateway.performStateRecovery(recoveryListener);
          }
        }
      }
);
    }
  }
 else {
    if (recovered.compareAndSet(false,true)) {
      if (asyncRecovery) {
        threadPool.generic().execute(new Runnable(){
          @Override public void run(){
            gateway.performStateRecovery(recoveryListener);
          }
        }
);
      }
 else {
        logger.trace("performing state recovery...");
        gateway.performStateRecovery(recoveryListener);
      }
    }
  }
}
