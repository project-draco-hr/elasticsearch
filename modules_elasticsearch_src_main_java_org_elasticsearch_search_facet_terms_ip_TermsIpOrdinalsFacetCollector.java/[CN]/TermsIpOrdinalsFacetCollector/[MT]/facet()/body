{
  if (current != null) {
    missing+=current.counts[0];
    if (current.values.length > 1) {
      aggregators.add(current);
    }
  }
  AggregatorPriorityQueue queue=new AggregatorPriorityQueue(aggregators.size());
  for (  ReaderAggregator aggregator : aggregators) {
    if (aggregator.nextPosition()) {
      queue.add(aggregator);
    }
  }
  if (size < EntryPriorityQueue.LIMIT) {
    EntryPriorityQueue ordered=new EntryPriorityQueue(size,comparatorType.comparator());
    while (queue.size() > 0) {
      ReaderAggregator agg=queue.top();
      long value=agg.current;
      int count=0;
      do {
        count+=agg.counts[agg.position];
        if (agg.nextPosition()) {
          agg=queue.updateTop();
        }
 else {
          queue.pop();
          agg=queue.top();
        }
      }
 while (agg != null && value == agg.current);
      if (count > minCount) {
        if (excluded == null || !excluded.contains(value)) {
          InternalIpTermsFacet.LongEntry entry=new InternalIpTermsFacet.LongEntry(value,count);
          ordered.insertWithOverflow(entry);
        }
      }
    }
    InternalIpTermsFacet.LongEntry[] list=new InternalIpTermsFacet.LongEntry[ordered.size()];
    for (int i=ordered.size() - 1; i >= 0; i--) {
      list[i]=(InternalIpTermsFacet.LongEntry)ordered.pop();
    }
    for (    ReaderAggregator aggregator : aggregators) {
      CacheRecycler.pushIntArray(aggregator.counts);
    }
    return new InternalIpTermsFacet(facetName,comparatorType,size,Arrays.asList(list),missing);
  }
  BoundedTreeSet<InternalIpTermsFacet.LongEntry> ordered=new BoundedTreeSet<InternalIpTermsFacet.LongEntry>(comparatorType.comparator(),size);
  while (queue.size() > 0) {
    ReaderAggregator agg=queue.top();
    long value=agg.current;
    int count=0;
    do {
      count+=agg.counts[agg.position];
      if (agg.nextPosition()) {
        agg=queue.updateTop();
      }
 else {
        queue.pop();
        agg=queue.top();
      }
    }
 while (agg != null && value == agg.current);
    if (count > minCount) {
      if (excluded == null || !excluded.contains(value)) {
        InternalIpTermsFacet.LongEntry entry=new InternalIpTermsFacet.LongEntry(value,count);
        ordered.add(entry);
      }
    }
  }
  for (  ReaderAggregator aggregator : aggregators) {
    CacheRecycler.pushIntArray(aggregator.counts);
  }
  return new InternalIpTermsFacet(facetName,comparatorType,size,ordered,missing);
}
