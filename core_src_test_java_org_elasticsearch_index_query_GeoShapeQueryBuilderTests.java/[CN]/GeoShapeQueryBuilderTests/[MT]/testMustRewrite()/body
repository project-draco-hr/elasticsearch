{
  GeoShapeQueryBuilder sqb;
  do {
    sqb=doCreateTestQueryBuilder();
  }
 while (sqb.shape() != null);
  try {
    sqb.toQuery(createShardContext());
    fail();
  }
 catch (  UnsupportedOperationException e) {
    assertEquals("query must be rewritten first",e.getMessage());
  }
  QueryBuilder rewrite=sqb.rewrite(createShardContext());
  GeoShapeQueryBuilder geoShapeQueryBuilder=new GeoShapeQueryBuilder(GEO_SHAPE_FIELD_NAME,indexedShapeToReturn);
  geoShapeQueryBuilder.strategy(sqb.strategy());
  geoShapeQueryBuilder.relation(sqb.relation());
  assertEquals(geoShapeQueryBuilder,rewrite);
}
