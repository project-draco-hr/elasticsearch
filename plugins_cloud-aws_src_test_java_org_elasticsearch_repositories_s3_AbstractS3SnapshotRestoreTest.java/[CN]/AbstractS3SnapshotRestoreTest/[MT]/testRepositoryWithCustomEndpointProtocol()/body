{
  Client client=client();
  Settings bucketSettings=internalCluster().getInstance(Settings.class).getByPrefix("repositories.s3.external-bucket.");
  logger.info("--> creating s3 repostoriy with endpoint [{}], bucket[{}] and path [{}]",bucketSettings.get("endpoint"),bucketSettings.get("bucket"),basePath);
  PutRepositoryResponse putRepositoryResponse=client.admin().cluster().preparePutRepository("test-repo").setType("s3").setSettings(Settings.settingsBuilder().put("bucket",bucketSettings.get("bucket")).put("endpoint",bucketSettings.get("endpoint")).put("access_key",bucketSettings.get("access_key")).put("secret_key",bucketSettings.get("secret_key")).put("base_path",basePath)).get();
  assertThat(putRepositoryResponse.isAcknowledged(),equalTo(true));
  assertRepositoryIsOperational(client,"test-repo");
}
