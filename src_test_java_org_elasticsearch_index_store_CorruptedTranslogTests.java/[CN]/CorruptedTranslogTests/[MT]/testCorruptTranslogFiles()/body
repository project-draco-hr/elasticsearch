{
  internalCluster().startNodesAsync(1,ImmutableSettings.EMPTY).get();
  assertAcked(prepareCreate("test").setSettings(ImmutableSettings.builder().put("index.number_of_shards",1).put("index.number_of_replicas",0).put("index.refresh_interval","-1").put(MockEngineSupport.FLUSH_ON_CLOSE_RATIO,0.0d).put(IndexShard.INDEX_FLUSH_ON_CLOSE,false).put(Translog.INDEX_TRANSLOG_SYNC_INTERVAL,"1s")));
  ensureYellow();
  int numDocs=scaledRandomIntBetween(100,1000);
  IndexRequestBuilder[] builders=new IndexRequestBuilder[numDocs];
  for (int i=0; i < builders.length; i++) {
    builders[i]=client().prepareIndex("test","type").setSource("foo","bar");
  }
  disableTranslogFlush("test");
  indexRandom(false,false,false,Arrays.asList(builders));
  corruptRandomTranslogFiles();
  internalCluster().fullRestart();
  Thread.sleep(1000);
  enableTranslogFlush("test");
  try {
    client().prepareSearch("test").setQuery(matchAllQuery()).get();
    fail("all shards should be failed due to a corrupted translog");
  }
 catch (  SearchPhaseExecutionException e) {
  }
}
