{
  Engine.Searcher searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
  searchResult.release();
  Document document=testDocumentWithTextField("1");
  document.add(new Field(SourceFieldMapper.NAME,B_1.toBytes(),SourceFieldMapper.Defaults.SOURCE_FIELD_TYPE));
  ParsedDocument doc=new ParsedDocument("1","1","test",null,-1,-1,document,Lucene.STANDARD_ANALYZER,B_1,false);
  engine.create(new Engine.Create(null,newUid("1"),doc));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),0));
  searchResult.release();
  Engine.GetResult getResult=engine.get(new Engine.Get(true,newUid("1")));
  assertThat(getResult.exists(),equalTo(true));
  assertThat(getResult.source().source.toBytesArray(),equalTo(B_1.toBytesArray()));
  assertThat(getResult.docIdAndVersion(),nullValue());
  getResult=engine.get(new Engine.Get(false,newUid("1")));
  assertThat(getResult.exists(),equalTo(false));
  engine.refresh(new Engine.Refresh(true));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),1));
  searchResult.release();
  getResult=engine.get(new Engine.Get(false,newUid("1")));
  assertThat(getResult.exists(),equalTo(true));
  assertThat(getResult.docIdAndVersion(),notNullValue());
  document=testDocument("1");
  document.add(new TextField("value","test1",Field.Store.YES));
  document.add(new Field(SourceFieldMapper.NAME,B_2.toBytes(),SourceFieldMapper.Defaults.SOURCE_FIELD_TYPE));
  doc=new ParsedDocument("1","1","test",null,-1,-1,document,Lucene.STANDARD_ANALYZER,B_2,false);
  engine.index(new Engine.Index(null,newUid("1"),doc));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),0));
  searchResult.release();
  getResult=engine.get(new Engine.Get(true,newUid("1")));
  assertThat(getResult.exists(),equalTo(true));
  assertThat(getResult.source().source.toBytesArray(),equalTo(B_2.toBytesArray()));
  assertThat(getResult.docIdAndVersion(),nullValue());
  engine.refresh(new Engine.Refresh(true));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),1));
  searchResult.release();
  engine.delete(new Engine.Delete("test","1",newUid("1")));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),1));
  searchResult.release();
  getResult=engine.get(new Engine.Get(true,newUid("1")));
  assertThat(getResult.exists(),equalTo(false));
  engine.refresh(new Engine.Refresh(true));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),0));
  searchResult.release();
  document=testDocumentWithTextField("1");
  document.add(new Field(SourceFieldMapper.NAME,B_1.toBytes(),SourceFieldMapper.Defaults.SOURCE_FIELD_TYPE));
  doc=new ParsedDocument("1","1","test",null,-1,-1,document,Lucene.STANDARD_ANALYZER,B_1,false);
  engine.create(new Engine.Create(null,newUid("1"),doc));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),0));
  searchResult.release();
  engine.refresh(new Engine.Refresh(true));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),0));
  searchResult.release();
  engine.flush(new Engine.Flush());
  getResult=engine.get(new Engine.Get(true,newUid("1")));
  assertThat(getResult.exists(),equalTo(true));
  assertThat(getResult.source(),nullValue());
  assertThat(getResult.docIdAndVersion(),notNullValue());
  document=testDocument("1");
  document.add(new TextField("value","test1",Field.Store.YES));
  doc=new ParsedDocument("1","1","test",null,-1,-1,document,Lucene.STANDARD_ANALYZER,B_1,false);
  engine.index(new Engine.Index(null,newUid("1"),doc));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),0));
  searchResult.release();
  engine.refresh(new Engine.Refresh(true));
  searchResult=engine.searcher();
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(1));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test")),0));
  MatcherAssert.assertThat(searchResult,EngineSearcherTotalHitsMatcher.engineSearcherTotalHits(new TermQuery(new Term("value","test1")),1));
  searchResult.release();
  engine.close();
}
