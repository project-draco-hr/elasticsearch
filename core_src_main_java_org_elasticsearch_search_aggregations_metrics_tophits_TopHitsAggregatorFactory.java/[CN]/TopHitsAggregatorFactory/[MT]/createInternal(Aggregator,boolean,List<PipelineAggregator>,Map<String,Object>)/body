{
  SubSearchContext subSearchContext=new SubSearchContext(context.searchContext());
  subSearchContext.parsedQuery(context.searchContext().parsedQuery());
  subSearchContext.explain(explain);
  subSearchContext.version(version);
  subSearchContext.trackScores(trackScores);
  subSearchContext.from(from);
  subSearchContext.size(size);
  if (sorts != null) {
    Optional<Sort> optionalSort=SortBuilder.buildSort(sorts,subSearchContext.getQueryShardContext());
    if (optionalSort.isPresent()) {
      subSearchContext.sort(optionalSort.get());
    }
  }
  if (fieldNames != null) {
    subSearchContext.fieldNames().addAll(fieldNames);
  }
  if (fieldDataFields != null) {
    FieldDataFieldsContext fieldDataFieldsContext=subSearchContext.getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);
    for (    String field : fieldDataFields) {
      fieldDataFieldsContext.add(new FieldDataField(field));
    }
    fieldDataFieldsContext.setHitExecutionNeeded(true);
  }
  if (scriptFields != null) {
    for (    ScriptField field : scriptFields) {
      SearchScript searchScript=subSearchContext.scriptService().search(subSearchContext.lookup(),field.script(),ScriptContext.Standard.SEARCH,Collections.emptyMap(),subSearchContext.getQueryShardContext().getClusterState());
      subSearchContext.scriptFields().add(new org.elasticsearch.search.fetch.script.ScriptFieldsContext.ScriptField(field.fieldName(),searchScript,field.ignoreFailure()));
    }
  }
  if (fetchSourceContext != null) {
    subSearchContext.fetchSourceContext(fetchSourceContext);
  }
  if (highlightBuilder != null) {
    subSearchContext.highlight(highlightBuilder.build(context.searchContext().getQueryShardContext()));
  }
  return new TopHitsAggregator(context.searchContext().fetchPhase(),subSearchContext,name,context,parent,pipelineAggregators,metaData);
}
