{
  SubSearchContext subSearchContext=new SubSearchContext(aggregationContext.searchContext());
  subSearchContext.explain(explain);
  subSearchContext.version(version);
  subSearchContext.trackScores(trackScores);
  subSearchContext.from(from);
  subSearchContext.size(size);
  if (sorts != null) {
    XContentParser completeSortParser=null;
    try {
      XContentBuilder completeSortBuilder=XContentFactory.jsonBuilder();
      completeSortBuilder.startObject();
      completeSortBuilder.startArray("sort");
      for (      BytesReference sort : sorts) {
        XContentParser parser=XContentFactory.xContent(sort).createParser(sort);
        parser.nextToken();
        completeSortBuilder.copyCurrentStructure(parser);
      }
      completeSortBuilder.endArray();
      completeSortBuilder.endObject();
      BytesReference completeSortBytes=completeSortBuilder.bytes();
      completeSortParser=XContentFactory.xContent(completeSortBytes).createParser(completeSortBytes);
      completeSortParser.nextToken();
      completeSortParser.nextToken();
      completeSortParser.nextToken();
      sortParseElement.parse(completeSortParser,subSearchContext);
    }
 catch (    Exception e) {
      XContentLocation location=completeSortParser != null ? completeSortParser.getTokenLocation() : null;
      throw new ParsingException(location,"failed to parse sort source in aggregation [" + name + "]",e);
    }
  }
  if (fieldNames != null) {
    subSearchContext.fieldNames().addAll(fieldNames);
  }
  if (fieldDataFields != null) {
    FieldDataFieldsContext fieldDataFieldsContext=subSearchContext.getFetchSubPhaseContext(FieldDataFieldsFetchSubPhase.CONTEXT_FACTORY);
    for (    String field : fieldDataFields) {
      fieldDataFieldsContext.add(new FieldDataField(field));
    }
    fieldDataFieldsContext.setHitExecutionNeeded(true);
  }
  if (scriptFields != null) {
    for (    ScriptField field : scriptFields) {
      SearchScript searchScript=subSearchContext.scriptService().search(subSearchContext.lookup(),field.script(),ScriptContext.Standard.SEARCH,Collections.emptyMap());
      subSearchContext.scriptFields().add(new org.elasticsearch.search.fetch.script.ScriptFieldsContext.ScriptField(field.fieldName(),searchScript,field.ignoreFailure()));
    }
  }
  if (fetchSourceContext != null) {
    subSearchContext.fetchSourceContext(fetchSourceContext);
  }
  if (highlightBuilder != null) {
    subSearchContext.highlight(highlightBuilder.build(aggregationContext.searchContext().indexShard().getQueryShardContext()));
  }
  return new TopHitsAggregator(aggregationContext.searchContext().fetchPhase(),subSearchContext,name,aggregationContext,parent,pipelineAggregators,metaData);
}
