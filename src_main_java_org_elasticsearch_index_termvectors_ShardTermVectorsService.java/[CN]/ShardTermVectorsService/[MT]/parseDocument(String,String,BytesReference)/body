{
  MapperService mapperService=indexShard.mapperService();
  IndexService indexService=indexShard.indexService();
  Tuple<DocumentMapper,Mapping> docMapper=mapperService.documentMapperWithAutoCreate(type);
  ParsedDocument parsedDocument=docMapper.v1().parse(source(doc).type(type).flyweight(true));
  if (docMapper.v2() != null) {
    parsedDocument.addDynamicMappingsUpdate(docMapper.v2());
  }
  if (parsedDocument.dynamicMappingsUpdate() != null) {
    mappingUpdatedAction.updateMappingOnMasterSynchronously(index,indexService.indexUUID(),type,parsedDocument.dynamicMappingsUpdate());
  }
  return parsedDocument;
}
