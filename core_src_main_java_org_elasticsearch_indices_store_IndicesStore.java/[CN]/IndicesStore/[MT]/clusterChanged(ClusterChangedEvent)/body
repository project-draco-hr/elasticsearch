{
  if (!event.routingTableChanged()) {
    return;
  }
  if (event.state().blocks().disableStatePersistence()) {
    return;
  }
  for (  IndexRoutingTable indexRoutingTable : event.state().routingTable()) {
    for (    IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {
      if (shardCanBeDeleted(event.state(),indexShardRoutingTable)) {
        ShardId shardId=indexShardRoutingTable.shardId();
        IndexService indexService=indicesService.indexService(indexRoutingTable.getIndex());
        IndexSettings indexSettings=indexService != null ? indexService.getIndexSettings() : new IndexSettings(event.state().getMetaData().index(indexRoutingTable.getIndex()),settings);
        if (indicesService.canDeleteShardContent(shardId,indexSettings)) {
          deleteShardIfExistElseWhere(event.state(),indexShardRoutingTable);
        }
      }
    }
  }
}
