{
  GeoBoundingBoxFilterBuilder bbox=new GeoBoundingBoxFilterBuilder("location");
  bbox.topLeft(smallestGeoHash).bottomRight(smallestGeoHash).filterName("bbox");
  for (int precision=1; precision <= highestPrecisionGeohash; precision++) {
    SearchResponse response=client().prepareSearch("idx").addAggregation(AggregationBuilders.filter("filtered").filter(bbox).subAggregation(geohashGrid("geohashgrid").field("location").precision(precision))).execute().actionGet();
    assertThat(response.getFailedShards(),equalTo(0));
    Filter filter=response.getAggregations().get("filtered");
    GeoHashGrid geoGrid=filter.getAggregations().get("geohashgrid");
    for (    GeoHashGrid.Bucket cell : geoGrid.getBuckets()) {
      String geohash=cell.getKey();
      long bucketCount=cell.getDocCount();
      int expectedBucketCount=expectedDocCountsForGeoHash.get(geohash);
      assertNotSame(bucketCount,0);
      assertTrue("Buckets must be filtered",geohash.startsWith(smallestGeoHash));
      assertEquals("Geohash " + geohash + " has wrong doc count ",expectedBucketCount,bucketCount);
    }
  }
}
