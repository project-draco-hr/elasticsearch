{
  assertAcked(prepareCreate("idx").addMapping("type","location","type=geo_point","city","type=string,index=not_analyzed"));
  createIndex("idx_unmapped");
  List<IndexRequestBuilder> cities=new ArrayList<>();
  Random random=getRandom();
  expectedDocCountsForGeoHash=new ObjectIntOpenHashMap<>(numRandomPoints * 2);
  for (int i=0; i < numRandomPoints; i++) {
    double lat=(180d * random.nextDouble()) - 90d;
    double lng=(360d * random.nextDouble()) - 180d;
    String randomGeoHash=GeoHashUtils.encode(lat,lng,highestPrecisionGeohash);
    cities.add(indexCity(randomGeoHash,lat + ", " + lng));
    expectedDocCountsForGeoHash.put(randomGeoHash,expectedDocCountsForGeoHash.getOrDefault(randomGeoHash,0) + 1);
    for (int precision=highestPrecisionGeohash - 1; precision > 0; precision--) {
      String hash=GeoHashUtils.encode(lat,lng,precision);
      if ((smallestGeoHash == null) || (hash.length() < smallestGeoHash.length())) {
        smallestGeoHash=hash;
      }
      expectedDocCountsForGeoHash.put(hash,expectedDocCountsForGeoHash.getOrDefault(hash,0) + 1);
    }
  }
  indexRandom(true,cities);
  ensureSearchable();
}
