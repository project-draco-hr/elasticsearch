{
  if (temporarilyMarked.contains(factory)) {
    throw new ElasticsearchIllegalStateException("Cyclical dependancy found with reducer [" + factory.getName() + "]");
  }
 else   if (unmarkedFactories.contains(factory)) {
    temporarilyMarked.add(factory);
    String[] bucketsPaths=factory.getBucketsPaths();
    for (    String bucketsPath : bucketsPaths) {
      ReducerFactory matchingFactory=reducerFactoriesMap.get(bucketsPath);
      if (bucketsPath.equals("_count") || bucketsPath.equals("_key") || aggFactoryNames.contains(bucketsPath)) {
        continue;
      }
 else       if (matchingFactory != null) {
        resolveReducerOrder(aggFactoryNames,reducerFactoriesMap,orderedReducers,unmarkedFactories,temporarilyMarked,matchingFactory);
      }
 else {
        throw new ElasticsearchIllegalStateException("No reducer found for path [" + bucketsPath + "]");
      }
    }
    unmarkedFactories.remove(factory);
    temporarilyMarked.remove(factory);
    orderedReducers.add(factory);
  }
}
