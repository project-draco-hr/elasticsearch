def new_es_instance(num_nodes, http_port, timeout=30):
    logging.info(('Waiting for %s nodes to join the cluster' % num_nodes))
    for _ in range(0, timeout):
        try:
            es = Elasticsearch([{'host': '127.0.0.1', 'port': (http_port + x), } for x in range(0, num_nodes)])
            es.cluster.health(wait_for_nodes=num_nodes)
            es.count()
            return es
        except (ConnectionError, TransportError):
            pass
        time.sleep(1)
    assert False, ('Timed out waiting for %s nodes for %s seconds' % (num_nodes, timeout))
