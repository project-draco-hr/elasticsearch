{
  IndexShardState state=this.state;
  if (state == IndexShardState.POST_RECOVERY || state == IndexShardState.STARTED || state == IndexShardState.RELOCATED || state == IndexShardState.CLOSED) {
    return engine.snapshot(snapshotHandler);
  }
 else {
    throw new IllegalIndexShardStateException(shardId,state,"snapshot is not allowed");
  }
}
