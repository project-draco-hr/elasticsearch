{
  ShardRouting currentRouting=this.shardRouting;
  if (!newRouting.shardId().equals(shardId())) {
    throw new ElasticSearchIllegalArgumentException("Trying to set a routing entry with shardId [" + newRouting.shardId() + "] on a shard with shardId ["+ shardId()+ "]");
  }
  if (currentRouting != null) {
    if (!newRouting.primary() && currentRouting.primary()) {
      logger.warn("suspect illegal state: trying to move shard from primary mode to replica mode");
    }
    if (currentRouting.equals(newRouting)) {
      return this;
    }
  }
  if (newRouting.state() == ShardRoutingState.STARTED && (currentRouting == null || currentRouting.state() != ShardRoutingState.STARTED)) {
    try {
      engine.refresh(new Engine.Refresh().force(true).source("cluster_state_started"));
    }
 catch (    Throwable t) {
      logger.debug("failed to refresh due to move to cluster wide started",t);
    }
  }
  this.shardRouting=newRouting;
  indicesLifecycle.shardRoutingChanged(this,currentRouting,newRouting);
  return this;
}
