{
  ShardRouting currentRouting=this.shardRouting;
  if (!newRouting.shardId().equals(shardId())) {
    throw new ElasticSearchIllegalArgumentException("Trying to set a routing entry with shardId [" + newRouting.shardId() + "] on a shard with shardId ["+ shardId()+ "]");
  }
  if (currentRouting != null) {
    if (!newRouting.primary() && currentRouting.primary()) {
      logger.warn("suspect illegal state: trying to move shard from primary mode to replica mode");
    }
    if (currentRouting.equals(newRouting)) {
      return this;
    }
  }
  if (newRouting.state() == ShardRoutingState.STARTED && (currentRouting == null || currentRouting.state() != ShardRoutingState.STARTED)) {
    try {
      engine.refresh(new Engine.Refresh("cluster_state_started").force(true));
    }
 catch (    Throwable t) {
      logger.debug("failed to refresh due to move to cluster wide started",t);
    }
synchronized (mutex) {
      if (state != IndexShardState.POST_RECOVERY) {
        logger.debug("suspected wrong state when acting on cluster state started state, current state {}",state);
      }
      logger.debug("state: [{}]->[{}], reason [global state moved to started]",state,IndexShardState.STARTED);
      state=IndexShardState.STARTED;
    }
    indicesLifecycle.afterIndexShardStarted(this);
  }
  this.shardRouting=newRouting;
  indicesLifecycle.shardRoutingChanged(this,currentRouting,newRouting);
  return this;
}
