{
  try {
    checkIndexTook=0;
    long time=System.currentTimeMillis();
    if (!IndexReader.indexExists(store.directory())) {
      return;
    }
    CheckIndex checkIndex=new CheckIndex(store.directory());
    FastByteArrayOutputStream os=new FastByteArrayOutputStream();
    PrintStream out=new PrintStream(os);
    checkIndex.setInfoStream(out);
    out.flush();
    CheckIndex.Status status=checkIndex.checkIndex();
    if (!status.clean) {
      if (state == IndexShardState.CLOSED) {
        return;
      }
      logger.warn("check index [failure]\n{}",new String(os.underlyingBytes(),0,os.size()));
      if (throwException) {
        throw new IndexShardException(shardId,"index check failure");
      }
    }
 else {
      if (logger.isDebugEnabled()) {
        logger.debug("check index [success]\n{}",new String(os.underlyingBytes(),0,os.size()));
      }
      if (fixIndexOnStartup) {
        if (logger.isDebugEnabled()) {
          logger.debug("fixing index, writing new segments file ...");
        }
        checkIndex.fixIndex(status);
        if (logger.isDebugEnabled()) {
          logger.debug("index fixed, wrote new segments file \"{}\"",status.segmentsFileName);
        }
      }
    }
    checkIndexTook=System.currentTimeMillis() - time;
  }
 catch (  Exception e) {
    logger.warn("failed to check index",e);
  }
}
