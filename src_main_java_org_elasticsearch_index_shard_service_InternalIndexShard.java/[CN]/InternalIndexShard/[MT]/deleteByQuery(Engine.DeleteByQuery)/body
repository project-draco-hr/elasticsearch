{
  writeAllowed();
  if (mapperService.hasNested()) {
    IncludeAllChildrenQuery nestedQuery=new IncludeAllChildrenQuery(deleteByQuery.query(),indexCache.filter().cache(NonNestedDocsFilter.INSTANCE));
    deleteByQuery=new Engine.DeleteByQuery(nestedQuery,deleteByQuery.source(),deleteByQuery.filteringAliases(),deleteByQuery.aliasFilter(),deleteByQuery.types());
  }
  if (logger.isTraceEnabled()) {
    logger.trace("delete_by_query [{}]",deleteByQuery.query());
  }
  deleteByQuery=indexingService.preDeleteByQuery(deleteByQuery);
  engine.delete(deleteByQuery);
  deleteByQuery.endTime(System.nanoTime());
  indexingService.postDeleteByQuery(deleteByQuery);
}
