{
  readAllowed();
  Query query;
  if (querySource == null || querySource.length() == 0) {
    query=Queries.MATCH_ALL_QUERY;
  }
 else {
    try {
      QueryParseContext.setTypes(types);
      query=queryParserService.parse(querySource).query();
    }
  finally {
      QueryParseContext.removeTypes();
    }
  }
  query=filterQueryIfNeeded(query,types);
  Filter aliasFilter=indexAliasesService.aliasFilter(filteringAliases);
  Engine.Searcher searcher=engine.searcher();
  try {
    long count=Lucene.count(searcher.searcher(),query,aliasFilter,minScore);
    if (logger.isTraceEnabled()) {
      logger.trace("count of [{}] is [{}]",query,count);
    }
    return count;
  }
 catch (  IOException e) {
    throw new ElasticSearchException("Failed to count query [" + query + "]",e);
  }
 finally {
    searcher.release();
  }
}
