{
  Map<DiscoveryNode,TransportNodesListShardStoreMetaData.StoreFilesMetaData> shardStores=cachedStores.get(shard.shardId());
  ObjectOpenHashSet<String> nodesIds;
  if (shardStores == null) {
    shardStores=Maps.newHashMap();
    cachedStores.put(shard.shardId(),shardStores);
    nodesIds=ObjectOpenHashSet.from(nodes.dataNodes().keys());
  }
 else {
    nodesIds=ObjectOpenHashSet.newInstance();
    for (Iterator<DiscoveryNode> it=shardStores.keySet().iterator(); it.hasNext(); ) {
      DiscoveryNode node=it.next();
      if (!nodes.nodeExists(node.id())) {
        it.remove();
      }
    }
    for (    ObjectCursor<DiscoveryNode> cursor : nodes.dataNodes().values()) {
      DiscoveryNode node=cursor.value;
      if (!shardStores.containsKey(node)) {
        nodesIds.add(node.id());
      }
    }
  }
  if (!nodesIds.isEmpty()) {
    String[] nodesIdsArray=nodesIds.toArray(String.class);
    TransportNodesListShardStoreMetaData.NodesStoreFilesMetaData nodesStoreFilesMetaData=listShardStoreMetaData.list(shard.shardId(),false,nodesIdsArray,listTimeout).actionGet();
    logListActionFailures(shard,"stores",nodesStoreFilesMetaData.failures());
    for (    TransportNodesListShardStoreMetaData.NodeStoreFilesMetaData nodeStoreFilesMetaData : nodesStoreFilesMetaData) {
      if (nodeStoreFilesMetaData.storeFilesMetaData() != null) {
        shardStores.put(nodeStoreFilesMetaData.getNode(),nodeStoreFilesMetaData.storeFilesMetaData());
      }
    }
  }
  return shardStores;
}
