{
  setupTribeNode(ImmutableSettings.EMPTY);
  logger.info("create 2 indices, test1 on t1, and test2 on t2");
  assertAcked(internalCluster().client().admin().indices().prepareCreate("test1"));
  assertAcked(cluster2.client().admin().indices().prepareCreate("test2"));
  logger.info("wait till test1 and test2 exists in the tribe node state");
  awaitIndicesInClusterState("test1","test2");
  logger.info("wait till tribe has the same nodes as the 2 clusters");
  awaitSameNodeCounts();
  assertThat(tribeClient.admin().cluster().prepareHealth().setWaitForGreenStatus().get().getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("create 2 docs through the tribe node");
  tribeClient.prepareIndex("test1","type1","1").setSource("field1","value1").get();
  tribeClient.prepareIndex("test2","type1","1").setSource("field1","value1").get();
  tribeClient.admin().indices().prepareRefresh().get();
  logger.info("verify they are there");
  assertHitCount(tribeClient.prepareCount().get(),2l);
  assertHitCount(tribeClient.prepareSearch().get(),2l);
  assertBusy(new Runnable(){
    @Override public void run(){
      ClusterState tribeState=tribeNode.client().admin().cluster().prepareState().get().getState();
      assertThat(tribeState.getMetaData().index("test1").mapping("type1"),notNullValue());
      assertThat(tribeState.getMetaData().index("test2").mapping("type1"),notNullValue());
    }
  }
);
  logger.info("write to another type");
  tribeClient.prepareIndex("test1","type2","1").setSource("field1","value1").get();
  tribeClient.prepareIndex("test2","type2","1").setSource("field1","value1").get();
  assertNoFailures(tribeClient.admin().indices().prepareRefresh().get());
  logger.info("verify they are there");
  assertHitCount(tribeClient.prepareCount().get(),4l);
  assertHitCount(tribeClient.prepareSearch().get(),4l);
  assertBusy(new Runnable(){
    @Override public void run(){
      ClusterState tribeState=tribeNode.client().admin().cluster().prepareState().get().getState();
      assertThat(tribeState.getMetaData().index("test1").mapping("type1"),notNullValue());
      assertThat(tribeState.getMetaData().index("test1").mapping("type2"),notNullValue());
      assertThat(tribeState.getMetaData().index("test2").mapping("type1"),notNullValue());
      assertThat(tribeState.getMetaData().index("test2").mapping("type2"),notNullValue());
    }
  }
);
  logger.info("make sure master level write operations fail... (we don't really have a master)");
  try {
    tribeClient.admin().indices().prepareCreate("tribe_index").setMasterNodeTimeout("10ms").get();
    fail();
  }
 catch (  MasterNotDiscoveredException e) {
  }
  logger.info("delete an index, and make sure its reflected");
  cluster2.client().admin().indices().prepareDelete("test2").get();
  awaitIndicesNotInClusterState("test2");
  try {
    logger.info("stop a node, make sure its reflected");
    cluster2.stopRandomDataNode();
    awaitSameNodeCounts();
  }
  finally {
    cluster2.startNode();
    awaitSameNodeCounts();
  }
}
