{
  if (logger.isTraceEnabled()) {
    logger.trace("Compiling lang: [{}] type: [{}] script: {}",lang,scriptType,script);
  }
  CacheKey cacheKey;
  CompiledScript compiled;
  if (lang == null) {
    lang=defaultLang;
  }
  if (scriptType == ScriptType.INDEXED) {
    if (client == null) {
      throw new ElasticsearchIllegalArgumentException("Got an indexed script with no Client registered.");
    }
    final IndexedScript indexedScript=new IndexedScript(lang,script);
    verifyDynamicScripting(indexedScript.lang);
    script=getScriptFromIndex(client,indexedScript.lang,indexedScript.id);
  }
 else   if (scriptType == ScriptType.FILE) {
    compiled=staticCache.get(script);
    if (compiled != null) {
      return compiled;
    }
 else {
      throw new ElasticsearchIllegalArgumentException("Unable to find on disk script " + script);
    }
  }
  verifyDynamicScripting(lang);
  cacheKey=new CacheKey(lang,script);
  compiled=cache.getIfPresent(cacheKey);
  if (compiled != null) {
    return compiled;
  }
  if (!dynamicScriptEnabled(lang)) {
    throw new ScriptException("dynamic scripting for [" + lang + "] disabled");
  }
  compiled=getCompiledScript(lang,script);
  cache.put(cacheKey,compiled);
  return compiled;
}
