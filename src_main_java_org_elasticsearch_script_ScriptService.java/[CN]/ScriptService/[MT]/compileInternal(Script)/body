{
  if (script == null) {
    throw new ElasticsearchIllegalArgumentException("The parameter script (Script) must not be null.");
  }
  String lang=script.getLang();
  if (lang == null) {
    lang=defaultLang;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Compiling lang: [{}] type: [{}] script: {}",lang,script.getType(),script.getScript());
  }
  ScriptEngineService scriptEngineService=getScriptEngineServiceForLang(lang);
  CacheKey cacheKey=newCacheKey(scriptEngineService,script.getScript());
  if (script.getType() == ScriptType.FILE) {
    CompiledScript compiled=staticCache.get(cacheKey);
    if (compiled == null) {
      throw new ElasticsearchIllegalArgumentException("Unable to find on disk script " + script.getScript());
    }
    return compiled;
  }
  String code=script.getScript();
  if (script.getType() == ScriptType.INDEXED) {
    final IndexedScript indexedScript=new IndexedScript(lang,script.getScript());
    code=getScriptFromIndex(indexedScript.lang,indexedScript.id);
    cacheKey=newCacheKey(scriptEngineService,code);
  }
  CompiledScript compiled=cache.getIfPresent(cacheKey);
  if (compiled == null) {
    compiled=new CompiledScript(lang,scriptEngineService.compile(code));
    cache.put(cacheKey,compiled);
  }
  return compiled;
}
