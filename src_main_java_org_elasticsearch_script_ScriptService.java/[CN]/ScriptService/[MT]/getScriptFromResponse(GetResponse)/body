{
  Map<String,Object> source=responseFields.getSourceAsMap();
  if (source.containsKey("template")) {
    try {
      XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON);
      Object template=source.get("template");
      if (template instanceof Map) {
        builder.map((Map<String,Object>)template);
        return builder.string();
      }
 else {
        return template.toString();
      }
    }
 catch (    IOException|ClassCastException e) {
      throw new ElasticsearchIllegalStateException("Unable to parse " + responseFields.getSourceAsString() + " as json",e);
    }
  }
 else   if (source.containsKey("script")) {
    return source.get("script").toString();
  }
 else {
    try {
      XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON);
      builder.map(responseFields.getSource());
      return builder.string();
    }
 catch (    IOException|ClassCastException e) {
      throw new ElasticsearchIllegalStateException("Unable to parse " + responseFields.getSourceAsString() + " as json",e);
    }
  }
}
