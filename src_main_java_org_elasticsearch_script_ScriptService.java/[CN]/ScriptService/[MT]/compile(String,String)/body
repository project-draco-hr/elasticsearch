{
  CompiledScript compiled=staticCache.get(script);
  if (compiled != null) {
    return compiled;
  }
  if (lang == null) {
    lang=defaultLang;
  }
  if (dynamicScriptDisabled(lang)) {
    throw new ScriptException("dynamic scripting disabled");
  }
  CacheKey cacheKey=new CacheKey(lang,script);
  compiled=cache.getIfPresent(cacheKey);
  if (compiled != null) {
    return compiled;
  }
  ScriptEngineService service=scriptEngines.get(lang);
  if (service == null) {
    throw new ElasticSearchIllegalArgumentException("script_lang not supported [" + lang + "]");
  }
  compiled=new CompiledScript(lang,service.compile(script));
  cache.put(cacheKey,compiled);
  return compiled;
}
