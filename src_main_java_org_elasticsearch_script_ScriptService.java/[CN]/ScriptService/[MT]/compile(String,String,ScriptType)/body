{
  if (lang == null) {
    lang=defaultLang;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Compiling lang: [{}] type: [{}] script: {}",lang,scriptType,script);
  }
  if (scriptType == ScriptType.FILE) {
    CompiledScript compiled=staticCache.get(script);
    if (compiled == null) {
      throw new ElasticsearchIllegalArgumentException("Unable to find on disk script " + script);
    }
    return compiled;
  }
  ScriptEngineService scriptEngineService=getScriptEngineService(lang);
  verifyDynamicScripting(lang,scriptEngineService);
  if (scriptType == ScriptType.INDEXED) {
    if (client == null) {
      throw new ElasticsearchIllegalArgumentException("Got an indexed script with no Client registered.");
    }
    final IndexedScript indexedScript=new IndexedScript(lang,script);
    script=getScriptFromIndex(client,indexedScript.lang,indexedScript.id);
  }
  CacheKey cacheKey=new CacheKey(lang,script);
  CompiledScript compiled=cache.getIfPresent(cacheKey);
  if (compiled == null) {
    compiled=new CompiledScript(lang,scriptEngineService.compile(script));
    cache.put(cacheKey,compiled);
  }
  return compiled;
}
