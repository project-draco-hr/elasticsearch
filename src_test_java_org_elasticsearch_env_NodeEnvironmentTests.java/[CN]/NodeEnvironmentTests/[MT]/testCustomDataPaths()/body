{
  String[] dataPaths=tmpPaths();
  NodeEnvironment env=newNodeEnvironment(dataPaths,ImmutableSettings.EMPTY);
  Settings s1=ImmutableSettings.EMPTY;
  Settings s2=ImmutableSettings.builder().put(IndexMetaData.SETTING_DATA_PATH,"/tmp/foo").build();
  ShardId sid=new ShardId("myindex",0);
  Index i=new Index("myindex");
  assertFalse("no settings should mean no custom data path",NodeEnvironment.hasCustomDataPath(s1));
  assertTrue("settings with path_data should have a custom data path",NodeEnvironment.hasCustomDataPath(s2));
  assertThat(env.shardDataPaths(sid,s1),equalTo(env.shardPaths(sid,s1)));
  assertThat(env.shardDataPaths(sid,s2),equalTo(new Path[]{Paths.get("/tmp/foo/0/myindex/0")}));
  assertThat("shard paths with a custom data_path should contain regular paths and custom path",env.shardPaths(sid,s2),equalTo(addPaths(stringsToPaths(dataPaths,"elasticsearch/nodes/0/indices/myindex/0"),new String[]{"/tmp/foo/0/myindex/0"})));
  assertThat("index paths with no custom settings uses the regular template",env.indexPaths(i,s1),equalTo(stringsToPaths(dataPaths,"elasticsearch/nodes/0/indices/myindex")));
  assertThat("index paths with custom data_path setting is the same as the data_path",env.indexPaths(i,s2),equalTo(addPaths(stringsToPaths(dataPaths,"elasticsearch/nodes/0/indices/myindex"),new String[]{"/tmp/foo/0"})));
  env.close();
  NodeEnvironment env2=newNodeEnvironment(dataPaths,ImmutableSettings.builder().put(NodeEnvironment.ADD_NODE_ID_TO_CUSTOM_PATH,false).build());
  assertThat(env2.shardDataPaths(sid,s1),equalTo(env2.shardPaths(sid,s1)));
  assertThat(env2.shardDataPaths(sid,s2),equalTo(new Path[]{Paths.get("/tmp/foo/myindex/0")}));
  assertThat("shard paths with a custom data_path should contain regular paths and custom path",env2.shardPaths(sid,s2),equalTo(addPaths(stringsToPaths(dataPaths,"elasticsearch/nodes/0/indices/myindex/0"),new String[]{"/tmp/foo/myindex/0"})));
  assertThat("index paths with no custom settings uses the regular template",env2.indexPaths(i,s1),equalTo(stringsToPaths(dataPaths,"elasticsearch/nodes/0/indices/myindex")));
  assertThat("index paths with custom data_path setting is the same as the data_path",env2.indexPaths(i,s2),equalTo(addPaths(stringsToPaths(dataPaths,"elasticsearch/nodes/0/indices/myindex"),new String[]{"/tmp/foo/"})));
}
