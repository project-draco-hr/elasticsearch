{
  String[] dataPaths=tmpPaths();
  Settings settings=ImmutableSettings.builder().put(nodeEnvSettings(dataPaths)).put("node.max_local_storage_nodes",1).build();
  NodeEnvironment env=new NodeEnvironment(settings,new Environment(settings));
  try {
    new NodeEnvironment(settings,new Environment(settings));
    fail("env is already locked");
  }
 catch (  ElasticsearchIllegalStateException ex) {
  }
  env.close();
  env=new NodeEnvironment(settings,new Environment(settings));
  assertEquals(env.nodeDataPaths().length,dataPaths.length);
  for (int i=0; i < dataPaths.length; i++) {
    assertTrue(env.nodeDataPaths()[i].startsWith(Paths.get(dataPaths[i])));
  }
  env.close();
  assertTrue("LockedShards: " + env.lockedShards(),env.lockedShards().isEmpty());
}
