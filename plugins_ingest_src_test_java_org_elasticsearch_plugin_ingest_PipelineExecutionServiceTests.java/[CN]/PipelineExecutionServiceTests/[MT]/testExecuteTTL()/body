{
  SetProcessor.Factory metaProcessorFactory=new SetProcessor.Factory(TestTemplateService.instance());
  Map<String,Object> config=new HashMap<>();
  config.put("field","_ttl");
  config.put("value","5d");
  Processor processor=metaProcessorFactory.create(config);
  when(store.get("_id")).thenReturn(new Pipeline("_id","_description",Collections.singletonList(processor)));
  IndexRequest indexRequest=new IndexRequest("_index","_type","_id").source(Collections.emptyMap());
  ActionListener<Void> listener=(ActionListener<Void>)mock(ActionListener.class);
  executionService.execute(indexRequest,"_id",listener);
  assertThat(indexRequest.ttl(),equalTo(TimeValue.parseTimeValue("5d",null,"ttl")));
  verify(listener,times(1)).onResponse(any());
  verify(listener,never()).onFailure(any());
  metaProcessorFactory=new SetProcessor.Factory(TestTemplateService.instance());
  config=new HashMap<>();
  config.put("field","_ttl");
  config.put("value","abc");
  processor=metaProcessorFactory.create(config);
  when(store.get("_id")).thenReturn(new Pipeline("_id","_description",Collections.singletonList(processor)));
  indexRequest=new IndexRequest("_index","_type","_id").source(Collections.emptyMap());
  listener=mock(ActionListener.class);
  executionService.execute(indexRequest,"_id",listener);
  verify(listener,never()).onResponse(any());
  verify(listener,times(1)).onFailure(any(ElasticsearchParseException.class));
  when(store.get("_id")).thenReturn(new Pipeline("_id","_description",Collections.emptyList()));
  indexRequest=new IndexRequest("_index","_type","_id").source(Collections.emptyMap()).ttl(1000L);
  listener=mock(ActionListener.class);
  executionService.execute(indexRequest,"_id",listener);
  assertThat(indexRequest.ttl(),equalTo(new TimeValue(1000L)));
  verify(listener,times(1)).onResponse(any());
  verify(listener,never()).onFailure(any(Throwable.class));
}
