{
  Processor processor=mock(Processor.class);
  when(store.get("_id")).thenReturn(new Pipeline("_id","_description",Arrays.asList(processor)));
  IngestDocument ingestDocument=new IngestDocument("_index","_type","_id",Collections.emptyMap());
  doThrow(new RuntimeException()).when(processor).execute(ingestDocument);
  PipelineExecutionService.Listener listener=mock(PipelineExecutionService.Listener.class);
  executionService.execute(ingestDocument,"_id",listener);
  assertBusy(new Runnable(){
    @Override public void run(){
      verify(processor).execute(ingestDocument);
      verify(listener,times(0)).executed(ingestDocument);
      verify(listener).failed(any(RuntimeException.class));
    }
  }
);
}
