{
  ClusterState clusterState=mock(ClusterState.class);
  DiscoveryNodes.Builder builder=new DiscoveryNodes.Builder();
  for (int i=0; i < totalNodes; i++) {
    String nodeId="node" + i;
    Map<String,String> attributes=new HashMap<>();
    if (i >= ingestNodes) {
      attributes.put("ingest","false");
    }
 else     if (randomBoolean()) {
      attributes.put("ingest","true");
    }
    builder.put(new DiscoveryNode(nodeId,nodeId,DummyTransportAddress.INSTANCE,attributes,VersionUtils.randomVersion(random())));
  }
  builder.localNodeId("node" + (totalNodes - 1));
  when(clusterState.nodes()).thenReturn(builder.build());
  ClusterService clusterService=mock(ClusterService.class);
  when(clusterService.state()).thenReturn(clusterState);
  transportService=mock(TransportService.class);
  return new IngestProxyActionFilter(clusterService,transportService);
}
