{
  EnumSet<ShardStatusChangeType> changes=EnumSet.noneOf(ShardStatusChangeType.class);
  Iterator<ShardId> statusShardIdIterator=shardsIndicesStatus.keySet().iterator();
  while (statusShardIdIterator.hasNext()) {
    ShardId statusShardId=statusShardIdIterator.next();
    IndexService indexService=indicesService.indexService(statusShardId.getIndex());
    boolean remove=false;
    try {
      if (indexService == null) {
        remove=true;
        continue;
      }
      IndexShard indexShard=indexService.shard(statusShardId.id());
      if (indexShard == null) {
        remove=true;
        continue;
      }
      remove=!CAN_UPDATE_INDEX_BUFFER_STATES.contains(indexShard.state());
    }
  finally {
      if (remove) {
        changes.add(ShardStatusChangeType.DELETED);
        statusShardIdIterator.remove();
      }
    }
  }
  return changes;
}
