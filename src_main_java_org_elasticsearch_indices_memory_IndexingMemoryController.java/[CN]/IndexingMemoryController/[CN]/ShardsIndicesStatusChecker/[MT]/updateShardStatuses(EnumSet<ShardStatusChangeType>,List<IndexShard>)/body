{
  int activeShards=0;
  for (  IndexService indexService : indicesService) {
    for (    IndexShard indexShard : indexService) {
      if (!CAN_UPDATE_INDEX_BUFFER_STATES.contains(indexShard.state())) {
        continue;
      }
      final long time=threadPool.estimatedTimeInMillis();
      Translog translog=((IndexShard)indexShard).translog();
      ShardIndexingStatus status=shardsIndicesStatus.get(indexShard.shardId());
      if (status == null) {
        status=new ShardIndexingStatus();
        shardsIndicesStatus.put(indexShard.shardId(),status);
        changes.add(ShardStatusChangeType.ADDED);
      }
      if (status.translogId == translog.currentId() && translog.estimatedNumberOfOperations() == 0) {
        if (status.time == -1) {
          status.time=time;
        }
        if (status.activeIndexing) {
          if ((time - status.time) > inactiveTime.millis() && indexShard.mergeStats().getCurrent() == 0) {
            activeToInactiveIndexingShards.add(indexShard);
            status.activeIndexing=false;
            changes.add(ShardStatusChangeType.BECAME_INACTIVE);
            logger.debug("marking shard [{}][{}] as inactive (inactive_time[{}]) indexing wise, setting size to [{}]",indexShard.shardId().index().name(),indexShard.shardId().id(),inactiveTime,Engine.INACTIVE_SHARD_INDEXING_BUFFER);
          }
        }
      }
 else {
        if (!status.activeIndexing) {
          status.activeIndexing=true;
          changes.add(ShardStatusChangeType.BECAME_ACTIVE);
          logger.debug("marking shard [{}][{}] as active indexing wise",indexShard.shardId().index().name(),indexShard.shardId().id());
        }
        status.time=-1;
      }
      status.translogId=translog.currentId();
      status.translogNumberOfOperations=translog.estimatedNumberOfOperations();
      if (status.activeIndexing) {
        activeShards++;
      }
    }
  }
  return activeShards;
}
