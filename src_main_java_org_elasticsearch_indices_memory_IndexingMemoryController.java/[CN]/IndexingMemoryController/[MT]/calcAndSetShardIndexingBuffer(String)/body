{
  int shardsCount=countShards();
  if (shardsCount == 0) {
    return;
  }
  ByteSizeValue shardIndexingBufferSize=calcShardIndexingBuffer(shardsCount);
  if (shardIndexingBufferSize == null) {
    return;
  }
  if (shardIndexingBufferSize.bytes() < minShardIndexBufferSize.bytes()) {
    shardIndexingBufferSize=minShardIndexBufferSize;
  }
  if (shardIndexingBufferSize.bytes() > maxShardIndexBufferSize.bytes()) {
    shardIndexingBufferSize=maxShardIndexBufferSize;
  }
  logger.debug("recalculating shard indexing buffer (reason={}), total is [{}] with [{}] active shards, each shard set to [{}]",reason,indexingBuffer,shardsCount,shardIndexingBufferSize);
  for (  IndexService indexService : indicesService) {
    for (    IndexShard indexShard : indexService) {
      ShardIndexingStatus status=shardsIndicesStatus.get(indexShard.shardId());
      if (status == null || !status.inactiveIndexing) {
        try {
          ((InternalIndexShard)indexShard).engine().updateIndexingBufferSize(shardIndexingBufferSize);
        }
 catch (        EngineClosedException e) {
          continue;
        }
catch (        FlushNotAllowedEngineException e) {
          continue;
        }
catch (        Exception e) {
          logger.warn("failed to set shard [{}][{}] index buffer to [{}]",indexShard.shardId().index().name(),indexShard.shardId().id(),shardIndexingBufferSize);
        }
      }
    }
  }
}
