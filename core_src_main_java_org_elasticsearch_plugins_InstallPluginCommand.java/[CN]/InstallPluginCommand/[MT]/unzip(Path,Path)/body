{
  Set<PosixFilePermission> perms=new HashSet<>();
  perms.add(PosixFilePermission.OWNER_EXECUTE);
  perms.add(PosixFilePermission.OWNER_READ);
  perms.add(PosixFilePermission.OWNER_WRITE);
  perms.add(PosixFilePermission.GROUP_READ);
  perms.add(PosixFilePermission.GROUP_EXECUTE);
  perms.add(PosixFilePermission.OTHERS_READ);
  perms.add(PosixFilePermission.OTHERS_EXECUTE);
  Path target=Files.createTempDirectory(pluginsDir,".installing-",PosixFilePermissions.asFileAttribute(perms));
  Files.createDirectories(target);
  boolean hasEsDir=false;
  try (ZipInputStream zipInput=new ZipInputStream(Files.newInputStream(zip))){
    ZipEntry entry;
    byte[] buffer=new byte[8192];
    while ((entry=zipInput.getNextEntry()) != null) {
      if (entry.getName().startsWith("elasticsearch/") == false) {
        continue;
      }
      hasEsDir=true;
      Path targetFile=target.resolve(entry.getName().substring("elasticsearch/".length()));
      if (targetFile.normalize().startsWith(target) == false) {
        throw new IOException("Zip contains entry name '" + entry.getName() + "' resolving outside of plugin directory");
      }
      Files.createDirectories(targetFile.getParent());
      if (entry.isDirectory() == false) {
        try (OutputStream out=Files.newOutputStream(targetFile)){
          int len;
          while ((len=zipInput.read(buffer)) >= 0) {
            out.write(buffer,0,len);
          }
        }
       }
      zipInput.closeEntry();
    }
  }
   Files.delete(zip);
  if (hasEsDir == false) {
    IOUtils.rm(target);
    throw new UserError(ExitCodes.DATA_ERROR,"`elasticsearch` directory is missing in the plugin zip");
  }
  return target;
}
