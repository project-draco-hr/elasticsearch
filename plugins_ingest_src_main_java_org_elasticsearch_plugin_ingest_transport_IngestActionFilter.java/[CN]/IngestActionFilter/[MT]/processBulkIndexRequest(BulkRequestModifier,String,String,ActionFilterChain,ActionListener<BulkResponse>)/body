{
  if (!bulkRequestModifier.hasNext()) {
    BulkRequest bulkRequest=bulkRequestModifier.getBulkRequest();
    ActionListener<BulkResponse> actionListener=bulkRequestModifier.wrapActionListenerIfNeeded(listener);
    if (bulkRequest.requests().isEmpty()) {
      actionListener.onResponse(new BulkResponse(new BulkItemResponse[0],0));
    }
 else {
      chain.proceed(action,bulkRequest,actionListener);
    }
    return;
  }
  ActionRequest actionRequest=bulkRequestModifier.next();
  if (!(actionRequest instanceof IndexRequest)) {
    processBulkIndexRequest(bulkRequestModifier,pipelineId,action,chain,listener);
    return;
  }
  IndexRequest indexRequest=(IndexRequest)actionRequest;
  executionService.execute(indexRequest,pipelineId,new ActionListener<Void>(){
    @Override public void onResponse(    Void aVoid){
      processBulkIndexRequest(bulkRequestModifier,pipelineId,action,chain,listener);
    }
    @Override public void onFailure(    Throwable e){
      logger.debug("failed to execute pipeline [{}]",e,pipelineId);
      bulkRequestModifier.markCurrentItemAsFailed(e);
      processBulkIndexRequest(bulkRequestModifier,pipelineId,action,chain,listener);
    }
  }
);
}
