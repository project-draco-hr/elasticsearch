{
  if (indexRequest.hasHeader(IngestPlugin.PIPELINE_ALREADY_PROCESSED)) {
    chain.proceed(action,indexRequest,listener);
    return;
  }
  Map<String,Object> sourceAsMap=indexRequest.sourceAsMap();
  IngestDocument ingestDocument=new IngestDocument(indexRequest.index(),indexRequest.type(),indexRequest.id(),sourceAsMap);
  executionService.execute(ingestDocument,pipelineId,new PipelineExecutionService.Listener(){
    @Override public void executed(    IngestDocument ingestDocument){
      if (ingestDocument.isModified()) {
        indexRequest.source(ingestDocument.getSource());
      }
      indexRequest.putHeader(IngestPlugin.PIPELINE_ALREADY_PROCESSED,true);
      chain.proceed(action,indexRequest,listener);
    }
    @Override public void failed(    Exception e){
      logger.error("failed to execute pipeline [{}]",e,pipelineId);
      listener.onFailure(e);
    }
  }
);
}
