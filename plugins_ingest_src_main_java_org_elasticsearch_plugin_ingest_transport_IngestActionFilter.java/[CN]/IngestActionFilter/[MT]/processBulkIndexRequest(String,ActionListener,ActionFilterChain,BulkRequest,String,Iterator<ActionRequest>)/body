{
  if (!requests.hasNext()) {
    chain.proceed(action,bulkRequest,listener);
    return;
  }
  ActionRequest actionRequest=requests.next();
  if (!(actionRequest instanceof IndexRequest)) {
    processBulkIndexRequest(action,listener,chain,bulkRequest,pipelineId,requests);
    return;
  }
  IndexRequest indexRequest=(IndexRequest)actionRequest;
  Map<String,Object> sourceAsMap=indexRequest.sourceAsMap();
  IngestDocument ingestDocument=new IngestDocument(indexRequest.index(),indexRequest.type(),indexRequest.id(),sourceAsMap);
  executionService.execute(ingestDocument,pipelineId,new PipelineExecutionService.Listener(){
    @Override public void executed(    IngestDocument ingestDocument){
      if (ingestDocument.isModified()) {
        indexRequest.source(ingestDocument.getSource());
      }
      processBulkIndexRequest(action,listener,chain,bulkRequest,pipelineId,requests);
    }
    @Override public void failed(    Exception e){
      logger.error("failed to execute pipeline [{}]",e,pipelineId);
      listener.onFailure(e);
    }
  }
);
}
