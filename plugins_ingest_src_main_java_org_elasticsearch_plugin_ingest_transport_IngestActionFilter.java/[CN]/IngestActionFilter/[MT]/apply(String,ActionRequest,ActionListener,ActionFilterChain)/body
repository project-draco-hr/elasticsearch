{
  String pipelineId=request.getFromContext(IngestPlugin.INGEST_PARAM_CONTEXT_KEY);
  if (pipelineId == null) {
    pipelineId=request.getHeader(IngestPlugin.INGEST_PARAM);
    if (pipelineId == null) {
      chain.proceed(action,request,listener);
      return;
    }
  }
  if (request instanceof IndexRequest) {
    processIndexRequest(action,listener,chain,(IndexRequest)request,pipelineId);
  }
 else   if (request instanceof BulkRequest) {
    BulkRequest bulkRequest=(BulkRequest)request;
    processBulkIndexRequest(action,listener,chain,bulkRequest,pipelineId,bulkRequest.requests().iterator());
  }
 else {
    chain.proceed(action,request,listener);
  }
}
