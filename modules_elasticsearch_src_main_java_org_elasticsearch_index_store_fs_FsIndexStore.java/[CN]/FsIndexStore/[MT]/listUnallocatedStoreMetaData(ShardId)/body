{
  if (location == null) {
    return new StoreFilesMetaData(false,shardId,ImmutableMap.<String,StoreFileMetaData>of());
  }
  File shardIndexLocation=shardIndexLocation(shardId);
  if (!shardIndexLocation.exists()) {
    return new StoreFilesMetaData(false,shardId,ImmutableMap.<String,StoreFileMetaData>of());
  }
  ConcurrentMap<String,String> shardIdCachedMd5s=cachedUnallocatedMd5s.get(shardId);
  if (shardIdCachedMd5s == null) {
    shardIdCachedMd5s=ConcurrentCollections.newConcurrentMap();
    cachedUnallocatedMd5s.put(shardId,shardIdCachedMd5s);
  }
  Map<String,StoreFileMetaData> files=Maps.newHashMap();
  for (  File file : shardIndexLocation.listFiles()) {
    if (file.getName().endsWith(".md5")) {
      continue;
    }
    String md5=shardIdCachedMd5s.get(file.getName());
    if (md5 == null) {
      File md5File=new File(shardIndexLocation,file.getName() + ".md5");
      if (md5File.exists()) {
        try {
          byte[] md5Bytes=Streams.copyToByteArray(md5File);
          md5=Digest.md5HexFromByteArray(md5Bytes);
        }
 catch (        Exception e) {
        }
      }
      if (md5 == null) {
        FileInputStream is=new FileInputStream(file);
        try {
          md5=Digest.md5Hex(is);
        }
  finally {
          is.close();
        }
      }
      if (md5 != null) {
        shardIdCachedMd5s.put(file.getName(),md5);
      }
    }
    files.put(file.getName(),new StoreFileMetaData(file.getName(),file.length(),file.lastModified(),md5));
  }
  return new StoreFilesMetaData(false,shardId,files);
}
