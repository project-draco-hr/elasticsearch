{
  createIndex("test");
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForYellowStatus().execute().actionGet();
  String mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("_timestamp").field("enabled",false).endObject().startObject("_size").field("enabled",false).endObject().startObject("properties").startObject("field1").field("type","string").field("store","yes").endObject().startObject("field2").field("type","string").field("store","no").endObject().startObject("field3").field("type","string").field("store","yes").endObject().endObject().endObject().endObject().string();
  client().admin().indices().preparePutMapping().setType("type1").setSource(mapping).execute().actionGet();
  client().prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("field1","value1").field("field2","value2").field("field3","value3").endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addField("field1").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addField("field2").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field2").value().toString(),equalTo("value2"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addField("field3").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addField("*").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).source(),nullValue());
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(2));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addField("*").addField("_source").execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().hits().length,equalTo(1));
  assertThat(searchResponse.getHits().getAt(0).source(),notNullValue());
  assertThat(searchResponse.getHits().getAt(0).fields().size(),equalTo(2));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.getHits().getAt(0).fields().get("field3").value().toString(),equalTo("value3"));
}
