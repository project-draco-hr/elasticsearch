{
  Settings indexSettings=ImmutableSettings.builder().put(defaultSettings).put(EngineConfig.INDEX_BUFFER_SIZE_SETTING,"1kb").build();
  IndexSettingsService indexSettingsService=new IndexSettingsService(shardId.index(),indexSettings);
  try (Store store=createStore();Translog translog=createTranslog();Engine engine=new InternalEngine(config(indexSettingsService,store,translog,createMergeScheduler(indexSettingsService)))){
    for (int i=0; i < 100; i++) {
      String id=Integer.toString(i);
      ParsedDocument doc=testParsedDocument(id,id,"test",null,-1,-1,testDocument(),B_1,false);
      engine.index(new Engine.Index(null,newUid(id),doc,2,VersionType.EXTERNAL,Engine.Operation.Origin.PRIMARY,System.nanoTime()));
    }
    engine.forceMerge(true,1,false,false);
    Searcher s=engine.acquireSearcher("test");
    long version1=((DirectoryReader)s.reader()).getVersion();
    s.close();
    for (int i=0; i < 100; i++) {
      String id=Integer.toString(i);
      engine.delete(new Engine.Delete("test",id,newUid(id),10,VersionType.EXTERNAL,Engine.Operation.Origin.PRIMARY,System.nanoTime(),false));
    }
    s=engine.acquireSearcher("test");
    long version2=((DirectoryReader)s.reader()).getVersion();
    s.close();
    assertThat(version2,greaterThan(version1));
  }
 }
