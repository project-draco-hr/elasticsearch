{
  super.setUp();
  assertBusy(new Runnable(){
    @Override public void run(){
      try {
        IOUtils.rm(Paths.get(TRANSLOG_PRIMARY_LOCATION));
        IOUtils.rm(Paths.get(TRANSLOG_REPLICA_LOCATION));
      }
 catch (      IOException e) {
        fail("failed to delete translogs before tests." + ExceptionsHelper.detailedMessage(e) + "\n"+ ExceptionsHelper.stackTrace(e));
      }
    }
  }
,30,TimeUnit.SECONDS);
  CodecService codecService=new CodecService(shardId.index());
  indexConcurrency=randomIntBetween(1,20);
  String name=Codec.getDefault().getName();
  if (Arrays.asList(codecService.availableCodecs()).contains(name)) {
    codecName=name;
  }
 else {
    codecName="default";
  }
  defaultSettings=ImmutableSettings.builder().put(EngineConfig.INDEX_COMPOUND_ON_FLUSH,randomBoolean()).put(EngineConfig.INDEX_GC_DELETES_SETTING,"1h").put(EngineConfig.INDEX_FAIL_ON_CORRUPTION_SETTING,randomBoolean()).put(EngineConfig.INDEX_CODEC_SETTING,codecName).put(EngineConfig.INDEX_CONCURRENCY_SETTING,indexConcurrency).build();
  threadPool=new ThreadPool(getClass().getName());
  store=createStore();
  storeReplica=createStore();
  Lucene.cleanLuceneIndex(store.directory());
  Lucene.cleanLuceneIndex(storeReplica.directory());
  translog=createTranslog();
  engine=createEngine(store,translog);
  LiveIndexWriterConfig currentIndexWriterConfig=engine.getCurrentIndexWriterConfig();
  assertEquals(engine.config().getCodec().getName(),codecService.codec(codecName).getName());
  assertEquals(currentIndexWriterConfig.getCodec().getName(),codecService.codec(codecName).getName());
  if (randomBoolean()) {
    engine.config().setEnableGcDeletes(false);
  }
  replicaTranslog=createTranslogReplica();
  replicaEngine=createEngine(storeReplica,replicaTranslog);
  currentIndexWriterConfig=replicaEngine.getCurrentIndexWriterConfig();
  assertEquals(replicaEngine.config().getCodec().getName(),codecService.codec(codecName).getName());
  assertEquals(currentIndexWriterConfig.getCodec().getName(),codecService.codec(codecName).getName());
  if (randomBoolean()) {
    engine.config().setEnableGcDeletes(false);
  }
}
