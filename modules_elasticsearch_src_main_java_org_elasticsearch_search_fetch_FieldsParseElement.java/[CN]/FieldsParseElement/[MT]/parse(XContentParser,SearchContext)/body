{
  XContentParser.Token token=parser.currentToken();
  if (token == XContentParser.Token.START_ARRAY) {
    boolean added=false;
    while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
      String name=parser.text();
      if (name.contains("_source.") || name.contains("doc[")) {
        SearchScript searchScript=new SearchScript(context.lookup(),null,name,null,context.scriptService());
        context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript,true));
      }
 else {
        if ("*".equals(name)) {
          added=true;
          context.fieldNames().add("*");
        }
 else {
          FieldMapper fieldMapper=context.mapperService().smartNameFieldMapper(name);
          if (fieldMapper != null) {
            if (fieldMapper.stored()) {
              added=true;
              context.fieldNames().add(name);
            }
 else {
              SearchScript searchScript=new SearchScript(context.lookup(),"mvel","_source." + fieldMapper.names().fullName(),null,context.scriptService());
              context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript,true));
            }
          }
        }
      }
    }
    if (!added) {
      context.emptyFieldNames();
    }
  }
 else   if (token == XContentParser.Token.VALUE_STRING) {
    String name=parser.text();
    if (name.contains("_source.") || name.contains("doc[")) {
      SearchScript searchScript=new SearchScript(context.lookup(),null,name,null,context.scriptService());
      context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript,true));
    }
 else {
      if ("*".equals(name)) {
        context.fieldNames().add("*");
      }
 else {
        FieldMapper fieldMapper=context.mapperService().smartNameFieldMapper(name);
        if (fieldMapper != null) {
          if (fieldMapper.stored()) {
            context.fieldNames().add(name);
          }
 else {
            SearchScript searchScript=new SearchScript(context.lookup(),"mvel","_source." + fieldMapper.names().fullName(),null,context.scriptService());
            context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript,true));
          }
        }
 else {
          context.emptyFieldNames();
        }
      }
    }
  }
}
