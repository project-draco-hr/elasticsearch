{
  XContentParser.Token token=parser.currentToken();
  if (token == XContentParser.Token.START_ARRAY) {
    boolean added=false;
    while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
      added=true;
      String name=parser.text();
      if (name.contains("_source.") || name.contains("doc[")) {
        SearchScript searchScript=new SearchScript(context.lookup(),null,name,null,context.scriptService());
        context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript));
      }
 else {
        FieldMapper fieldMapper=context.mapperService().smartNameFieldMapper(name);
        if (!"*".equals(name) && (fieldMapper == null || !fieldMapper.stored())) {
          SearchScript searchScript=new SearchScript(context.lookup(),null,"_source." + name,null,context.scriptService());
          context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript));
        }
 else {
          context.fieldNames().add(name);
        }
      }
    }
    if (!added) {
      context.emptyFieldNames();
    }
  }
 else   if (token == XContentParser.Token.VALUE_STRING) {
    String name=parser.text();
    if (name.contains("_source.") || name.contains("doc[")) {
      SearchScript searchScript=new SearchScript(context.lookup(),null,name,null,context.scriptService());
      context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript));
    }
 else {
      FieldMapper fieldMapper=context.mapperService().smartNameFieldMapper(name);
      if (!"*".equals(name) && (fieldMapper == null || !fieldMapper.stored())) {
        SearchScript searchScript=new SearchScript(context.lookup(),null,"_source." + name,null,context.scriptService());
        context.scriptFields().add(new ScriptFieldsContext.ScriptField(name,searchScript));
      }
 else {
        context.fieldNames().add(name);
      }
    }
  }
}
