{
  if (disableSites) {
    channel.sendResponse(new BytesRestResponse(FORBIDDEN));
    return;
  }
  if (request.method() == RestRequest.Method.OPTIONS) {
    channel.sendResponse(new BytesRestResponse(OK));
    return;
  }
  if (request.method() != RestRequest.Method.GET) {
    channel.sendResponse(new BytesRestResponse(FORBIDDEN));
    return;
  }
  String path=request.rawPath().substring("/_plugin/".length());
  int i1=path.indexOf('/');
  String pluginName;
  String sitePath;
  if (i1 == -1) {
    pluginName=path;
    sitePath=null;
    String redirectUrl=request.rawPath() + "/";
    BytesRestResponse restResponse=new BytesRestResponse(RestStatus.MOVED_PERMANENTLY,"text/html","<head><meta http-equiv=\"refresh\" content=\"0; URL=" + redirectUrl + "></head>");
    restResponse.addHeader("Location",redirectUrl);
    channel.sendResponse(restResponse);
    return;
  }
 else {
    pluginName=path.substring(0,i1);
    sitePath=path.substring(i1 + 1);
  }
  if (sitePath.length() == 0) {
    sitePath="/index.html";
  }
  final Path siteFile=environment.pluginsFile().resolve(pluginName).resolve("_site");
  final String separator=siteFile.getFileSystem().getSeparator();
  sitePath=sitePath.replace("/",separator);
  Path file=FileSystemUtils.append(siteFile,PathUtils.get(sitePath),0);
  if (!Files.exists(file) || Files.isHidden(file)) {
    channel.sendResponse(new BytesRestResponse(NOT_FOUND));
    return;
  }
  BasicFileAttributes attributes=Files.readAttributes(file,BasicFileAttributes.class);
  if (!attributes.isRegularFile()) {
    if (!attributes.isDirectory()) {
      channel.sendResponse(new BytesRestResponse(FORBIDDEN));
      return;
    }
    file=file.resolve("index.html");
    if (!Files.exists(file) || Files.isHidden(file) || !Files.isRegularFile(file)) {
      channel.sendResponse(new BytesRestResponse(FORBIDDEN));
      return;
    }
  }
  if (!file.toAbsolutePath().startsWith(siteFile.toAbsolutePath())) {
    channel.sendResponse(new BytesRestResponse(FORBIDDEN));
    return;
  }
  try {
    byte[] data=Files.readAllBytes(file);
    channel.sendResponse(new BytesRestResponse(OK,guessMimeType(sitePath),data));
  }
 catch (  IOException e) {
    channel.sendResponse(new BytesRestResponse(INTERNAL_SERVER_ERROR));
  }
}
