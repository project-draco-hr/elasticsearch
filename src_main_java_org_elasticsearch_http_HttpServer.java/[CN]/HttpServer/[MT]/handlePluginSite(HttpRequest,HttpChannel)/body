{
  if (disableSites) {
    channel.sendResponse(new StringRestResponse(FORBIDDEN));
    return;
  }
  if (request.method() == RestRequest.Method.OPTIONS) {
    StringRestResponse response=new StringRestResponse(OK);
    channel.sendResponse(response);
    return;
  }
  if (request.method() != RestRequest.Method.GET) {
    channel.sendResponse(new StringRestResponse(FORBIDDEN));
    return;
  }
  String path=request.rawPath().substring("/_plugin/".length());
  int i1=path.indexOf('/');
  String pluginName;
  String sitePath;
  if (i1 == -1) {
    pluginName=path;
    sitePath=null;
    channel.sendResponse(new HttpRedirectRestResponse(request.rawPath() + "/"));
    return;
  }
 else {
    pluginName=path.substring(0,i1);
    sitePath=path.substring(i1 + 1);
  }
  if (sitePath.length() == 0) {
    sitePath="/index.html";
  }
  sitePath=sitePath.replace('/',File.separatorChar);
  File siteFile=new File(new File(environment.pluginsFile(),pluginName),"_site");
  File file=new File(siteFile,sitePath);
  if (!file.exists() || file.isHidden()) {
    channel.sendResponse(new StringRestResponse(NOT_FOUND));
    return;
  }
  if (!file.isFile()) {
    if (!file.isDirectory()) {
      channel.sendResponse(new StringRestResponse(FORBIDDEN));
      return;
    }
    file=new File(file,"index.html");
    if (!file.exists() || file.isHidden() || !file.isFile()) {
      channel.sendResponse(new StringRestResponse(FORBIDDEN));
      return;
    }
  }
  if (!file.getAbsolutePath().startsWith(siteFile.getAbsolutePath())) {
    channel.sendResponse(new StringRestResponse(FORBIDDEN));
    return;
  }
  try {
    byte[] data=Streams.copyToByteArray(file);
    channel.sendResponse(new BytesRestResponse(data,guessMimeType(sitePath)));
  }
 catch (  IOException e) {
    channel.sendResponse(new StringRestResponse(INTERNAL_SERVER_ERROR));
  }
}
