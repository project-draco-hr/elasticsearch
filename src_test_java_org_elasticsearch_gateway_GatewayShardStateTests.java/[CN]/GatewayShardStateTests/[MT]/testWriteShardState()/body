{
  try (NodeEnvironment env=newNodeEnvironment()){
    GatewayShardsState state=new GatewayShardsState(ImmutableSettings.EMPTY,env,null);
    ShardId id=new ShardId("foo",1);
    long version=between(1,Integer.MAX_VALUE / 2);
    boolean primary=randomBoolean();
    ShardStateInfo state1=new ShardStateInfo(version,primary);
    state.maybeWriteShardState(id,state1,null,IDX_SETTINGS);
    ShardStateInfo shardStateInfo=state.loadShardInfo(id,IDX_SETTINGS);
    assertEquals(shardStateInfo,state1);
    ShardStateInfo state2=new ShardStateInfo(version,primary);
    state.maybeWriteShardState(id,state2,state1,IDX_SETTINGS);
    shardStateInfo=state.loadShardInfo(id,IDX_SETTINGS);
    assertEquals(shardStateInfo,state1);
    ShardStateInfo state3=new ShardStateInfo(version + 1,primary);
    state.maybeWriteShardState(id,state3,state1,IDX_SETTINGS);
    shardStateInfo=state.loadShardInfo(id,IDX_SETTINGS);
    assertEquals(shardStateInfo,state3);
    assertTrue(state.getCurrentState().isEmpty());
  }
 }
