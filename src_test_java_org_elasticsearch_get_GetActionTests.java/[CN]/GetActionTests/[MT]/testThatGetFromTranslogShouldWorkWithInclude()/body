{
  String index="test";
  String type="type1";
  String mapping=jsonBuilder().startObject().startObject(type).startObject("_source").array("includes","included").endObject().endObject().endObject().string();
  assertAcked(prepareCreate(index).addMapping(type,mapping).setSettings(ImmutableSettings.settingsBuilder().put("index.refresh_interval",-1)));
  client().prepareIndex(index,type,"1").setSource(jsonBuilder().startObject().field("field","1","2").field("included","should be seen").endObject()).get();
  GetResponse responseBeforeFlush=client().prepareGet(index,type,"1").get();
  flush();
  GetResponse responseAfterFlush=client().prepareGet(index,type,"1").get();
  assertThat(responseBeforeFlush.isExists(),is(true));
  assertThat(responseAfterFlush.isExists(),is(true));
  assertThat(responseBeforeFlush.getSourceAsMap(),not(hasKey("field")));
  assertThat(responseBeforeFlush.getSourceAsMap(),hasKey("included"));
  assertThat(responseBeforeFlush.getSourceAsString(),is(responseAfterFlush.getSourceAsString()));
}
