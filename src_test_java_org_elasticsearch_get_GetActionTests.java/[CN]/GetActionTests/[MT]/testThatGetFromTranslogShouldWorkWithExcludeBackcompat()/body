{
  String index="test";
  String type="type1";
  String mapping=jsonBuilder().startObject().startObject(type).startObject("_source").array("excludes","excluded").endObject().endObject().endObject().string();
  assertAcked(prepareCreate(index).addMapping(type,mapping).setSettings("index.refresh_interval",-1,IndexMetaData.SETTING_VERSION_CREATED,Version.V_1_4_2.id));
  client().prepareIndex(index,type,"1").setSource(jsonBuilder().startObject().field("field","1","2").field("excluded","should not be seen").endObject()).get();
  GetResponse responseBeforeFlush=client().prepareGet(index,type,"1").get();
  client().admin().indices().prepareFlush(index).get();
  GetResponse responseAfterFlush=client().prepareGet(index,type,"1").get();
  assertThat(responseBeforeFlush.isExists(),is(true));
  assertThat(responseAfterFlush.isExists(),is(true));
  assertThat(responseBeforeFlush.getSourceAsMap(),hasKey("field"));
  assertThat(responseBeforeFlush.getSourceAsMap(),not(hasKey("excluded")));
  assertThat(responseBeforeFlush.getSourceAsString(),is(responseAfterFlush.getSourceAsString()));
}
