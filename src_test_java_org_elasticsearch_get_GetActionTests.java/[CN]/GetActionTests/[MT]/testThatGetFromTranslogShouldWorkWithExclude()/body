{
  String index="test";
  String type="type1";
  String mapping=jsonBuilder().startObject().startObject(type).startObject("_source").array("excludes","excluded").endObject().endObject().endObject().string();
  client().admin().indices().prepareCreate(index).addMapping(type,mapping).setSettings(ImmutableSettings.settingsBuilder().put("index.refresh_interval",-1)).execute().actionGet();
  client().prepareIndex(index,type,"1").setSource(jsonBuilder().startObject().field("field","1","2").field("excluded","should not be seen").endObject()).execute().actionGet();
  GetResponse responseBeforeFlush=client().prepareGet(index,type,"1").execute().actionGet();
  client().admin().indices().prepareFlush(index).execute().actionGet();
  GetResponse responseAfterFlush=client().prepareGet(index,type,"1").execute().actionGet();
  assertThat(responseBeforeFlush.isExists(),is(true));
  assertThat(responseAfterFlush.isExists(),is(true));
  assertThat(responseBeforeFlush.getSourceAsMap(),hasKey("field"));
  assertThat(responseBeforeFlush.getSourceAsMap(),not(hasKey("excluded")));
  assertThat(responseBeforeFlush.getSourceAsString(),is(responseAfterFlush.getSourceAsString()));
}
