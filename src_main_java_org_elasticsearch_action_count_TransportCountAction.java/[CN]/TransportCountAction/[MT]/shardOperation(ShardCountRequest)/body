{
  IndexService indexService=indicesService.indexServiceSafe(request.shardId().getIndex());
  IndexShard indexShard=indexService.shardSafe(request.shardId().id());
  SearchShardTarget shardTarget=new SearchShardTarget(clusterService.localNode().id(),request.shardId().getIndex(),request.shardId().id());
  SearchContext context=new DefaultSearchContext(0,new ShardSearchRequest().types(request.types()).filteringAliases(request.filteringAliases()).nowInMillis(request.nowInMillis()),shardTarget,indexShard.acquireSearcher("count"),indexService,indexShard,scriptService,cacheRecycler,pageCacheRecycler,bigArrays);
  SearchContext.setCurrent(context);
  try {
    if (request.minScore() != -1) {
      context.minimumScore(request.minScore());
    }
    BytesReference source=request.querySource();
    if (source != null && source.length() > 0) {
      try {
        QueryParseContext.setTypes(request.types());
        context.parsedQuery(indexService.queryParserService().parseQuery(source));
      }
  finally {
        QueryParseContext.removeTypes();
      }
    }
    final boolean hasTerminateAfterCount=request.terminateAfter() != DEFAULT_TERMINATE_AFTER;
    boolean terminatedEarly=false;
    context.preProcess();
    try {
      long count;
      if (hasTerminateAfterCount) {
        final Lucene.EarlyTerminatingCollector countCollector=Lucene.createCountBasedEarlyTerminatingCollector(request.terminateAfter());
        terminatedEarly=Lucene.countWithEarlyTermination(context.searcher(),context.query(),countCollector);
        count=countCollector.count();
      }
 else {
        count=Lucene.count(context.searcher(),context.query());
      }
      return new ShardCountResponse(request.shardId(),count,terminatedEarly);
    }
 catch (    Exception e) {
      throw new QueryPhaseExecutionException(context,"failed to execute count",e);
    }
  }
  finally {
    context.close();
    SearchContext.removeCurrent();
  }
}
