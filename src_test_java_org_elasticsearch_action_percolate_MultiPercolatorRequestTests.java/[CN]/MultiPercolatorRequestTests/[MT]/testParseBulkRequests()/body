{
  byte[] data=Streams.copyToBytesFromClasspath("/org/elasticsearch/action/percolate/mpercolate1.json");
  MultiPercolateRequest request=new MultiPercolateRequest().add(data,0,data.length);
  assertThat(request.requests().size(),equalTo(6));
  PercolateRequest percolateRequest=request.requests().get(0);
  assertThat(percolateRequest.indices()[0],equalTo("my-index1"));
  assertThat(percolateRequest.documentType(),equalTo("my-type1"));
  assertThat(percolateRequest.routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.preference(),equalTo("_local"));
  assertThat(percolateRequest.indicesOptions(),equalTo(IndicesOptions.strictExpandOpenAndForbidClosed()));
  assertThat(percolateRequest.onlyCount(),equalTo(false));
  assertThat(percolateRequest.getRequest(),nullValue());
  assertThat(percolateRequest.source(),notNullValue());
  Map sourceMap=XContentFactory.xContent(percolateRequest.source()).createParser(percolateRequest.source()).map();
  assertThat(sourceMap.get("doc"),equalTo((Object)MapBuilder.newMapBuilder().put("field1","value1").map()));
  percolateRequest=request.requests().get(1);
  assertThat(percolateRequest.indices()[0],equalTo("my-index2"));
  assertThat(percolateRequest.indices()[1],equalTo("my-index3"));
  assertThat(percolateRequest.documentType(),equalTo("my-type1"));
  assertThat(percolateRequest.routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.preference(),equalTo("_local"));
  assertThat(percolateRequest.indicesOptions(),equalTo(IndicesOptions.fromOptions(true,true,true,false,IndicesOptions.strictExpandOpenAndForbidClosed())));
  assertThat(percolateRequest.onlyCount(),equalTo(false));
  assertThat(percolateRequest.getRequest(),nullValue());
  assertThat(percolateRequest.source(),notNullValue());
  sourceMap=XContentFactory.xContent(percolateRequest.source()).createParser(percolateRequest.source()).map();
  assertThat(sourceMap.get("doc"),equalTo((Object)MapBuilder.newMapBuilder().put("field1","value2").map()));
  percolateRequest=request.requests().get(2);
  assertThat(percolateRequest.indices()[0],equalTo("my-index4"));
  assertThat(percolateRequest.indices()[1],equalTo("my-index5"));
  assertThat(percolateRequest.documentType(),equalTo("my-type1"));
  assertThat(percolateRequest.routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.preference(),equalTo("_local"));
  assertThat(percolateRequest.indicesOptions(),equalTo(IndicesOptions.fromOptions(false,true,true,true,IndicesOptions.strictExpandOpenAndForbidClosed())));
  assertThat(percolateRequest.onlyCount(),equalTo(true));
  assertThat(percolateRequest.getRequest(),nullValue());
  assertThat(percolateRequest.source(),notNullValue());
  sourceMap=XContentFactory.xContent(percolateRequest.source()).createParser(percolateRequest.source()).map();
  assertThat(sourceMap.get("doc"),equalTo((Object)MapBuilder.newMapBuilder().put("field1","value3").map()));
  percolateRequest=request.requests().get(3);
  assertThat(percolateRequest.indices()[0],equalTo("my-index6"));
  assertThat(percolateRequest.documentType(),equalTo("my-type1"));
  assertThat(percolateRequest.routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.preference(),equalTo("_local"));
  assertThat(percolateRequest.indicesOptions(),equalTo(IndicesOptions.fromOptions(false,true,true,true,IndicesOptions.strictExpandOpenAndForbidClosed())));
  assertThat(percolateRequest.onlyCount(),equalTo(false));
  assertThat(percolateRequest.getRequest(),notNullValue());
  assertThat(percolateRequest.getRequest().id(),equalTo("1"));
  assertThat(percolateRequest.getRequest().type(),equalTo("my-type1"));
  assertThat(percolateRequest.getRequest().index(),equalTo("my-index6"));
  assertThat(percolateRequest.getRequest().routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.getRequest().preference(),equalTo("_local"));
  percolateRequest=request.requests().get(4);
  assertThat(percolateRequest.indices()[0],equalTo("my-index7"));
  assertThat(percolateRequest.documentType(),equalTo("my-type1"));
  assertThat(percolateRequest.routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.preference(),equalTo("_local"));
  assertThat(percolateRequest.indicesOptions(),equalTo(IndicesOptions.strictExpandOpenAndForbidClosed()));
  assertThat(percolateRequest.onlyCount(),equalTo(true));
  assertThat(percolateRequest.getRequest(),notNullValue());
  assertThat(percolateRequest.getRequest().id(),equalTo("2"));
  assertThat(percolateRequest.getRequest().type(),equalTo("my-type1"));
  assertThat(percolateRequest.getRequest().index(),equalTo("my-index7"));
  assertThat(percolateRequest.getRequest().routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.getRequest().preference(),equalTo("_local"));
  percolateRequest=request.requests().get(5);
  assertThat(percolateRequest.indices()[0],equalTo("my-index8"));
  assertThat(percolateRequest.documentType(),equalTo("my-type1"));
  assertThat(percolateRequest.routing(),equalTo("my-routing-1"));
  assertThat(percolateRequest.preference(),equalTo("primary"));
  assertThat(percolateRequest.indicesOptions(),equalTo(IndicesOptions.strictExpandOpenAndForbidClosed()));
  assertThat(percolateRequest.onlyCount(),equalTo(false));
  assertThat(percolateRequest.getRequest(),nullValue());
  assertThat(percolateRequest.source(),notNullValue());
  sourceMap=XContentFactory.xContent(percolateRequest.source()).createParser(percolateRequest.source()).map();
  assertThat(sourceMap.get("doc"),equalTo((Object)MapBuilder.newMapBuilder().put("field1","value4").map()));
}
