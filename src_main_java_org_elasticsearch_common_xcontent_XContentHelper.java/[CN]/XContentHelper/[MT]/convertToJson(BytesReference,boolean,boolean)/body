{
  if (bytes.hasArray()) {
    return convertToJson(bytes.array(),bytes.arrayOffset(),bytes.length(),reformatJson,prettyPrint);
  }
  XContentType xContentType=XContentFactory.xContentType(bytes);
  if (xContentType == XContentType.JSON && !reformatJson) {
    BytesArray bytesArray=bytes.toBytesArray();
    return new String(bytesArray.array(),bytesArray.arrayOffset(),bytesArray.length(),Charsets.UTF_8);
  }
  XContentParser parser=null;
  try {
    parser=XContentFactory.xContent(xContentType).createParser(bytes.streamInput());
    parser.nextToken();
    XContentBuilder builder=XContentFactory.jsonBuilder();
    if (prettyPrint) {
      builder.prettyPrint();
    }
    builder.copyCurrentStructure(parser);
    return builder.string();
  }
  finally {
    if (parser != null) {
      parser.close();
    }
  }
}
