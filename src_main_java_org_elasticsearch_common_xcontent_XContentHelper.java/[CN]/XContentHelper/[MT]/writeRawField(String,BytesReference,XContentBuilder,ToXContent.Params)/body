{
  Compressor compressor=CompressorFactory.compressor(source);
  if (compressor != null) {
    InputStream compressedStreamInput=compressor.streamInput(source.streamInput());
    XContentType contentType=XContentFactory.xContentType(compressedStreamInput);
    if (compressedStreamInput.markSupported() == false) {
      compressedStreamInput=new BufferedInputStream(compressedStreamInput);
    }
    if (contentType == builder.contentType()) {
      builder.rawField(field,compressedStreamInput);
    }
 else {
      try (XContentParser parser=XContentFactory.xContent(contentType).createParser(compressedStreamInput)){
        parser.nextToken();
        builder.field(field);
        builder.copyCurrentStructure(parser);
      }
     }
  }
 else {
    XContentType contentType=XContentFactory.xContentType(source);
    if (contentType == builder.contentType()) {
      builder.rawField(field,source);
    }
 else {
      try (XContentParser parser=XContentFactory.xContent(contentType).createParser(source)){
        parser.nextToken();
        builder.field(field);
        builder.copyCurrentStructure(parser);
      }
     }
  }
}
