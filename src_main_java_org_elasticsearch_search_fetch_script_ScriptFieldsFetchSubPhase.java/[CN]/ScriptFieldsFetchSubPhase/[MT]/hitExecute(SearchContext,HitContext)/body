{
  for (  ScriptFieldsContext.ScriptField scriptField : context.scriptFields().fields()) {
    try {
      scriptField.script().setNextReader(hitContext.readerContext());
    }
 catch (    IOException e) {
      throw new ElasticsearchIllegalStateException("IOException while calling setNextReader",e);
    }
    scriptField.script().setNextDocId(hitContext.docId());
    Object value;
    try {
      value=scriptField.script().run();
      value=scriptField.script().unwrap(value);
    }
 catch (    RuntimeException e) {
      if (scriptField.ignoreException()) {
        continue;
      }
      throw e;
    }
    if (hitContext.hit().fieldsOrNull() == null) {
      hitContext.hit().fields(new HashMap<String,SearchHitField>(2));
    }
    SearchHitField hitField=hitContext.hit().fields().get(scriptField.name());
    if (hitField == null) {
      final List<Object> values;
      if (value == null) {
        values=Collections.emptyList();
      }
 else       if (value instanceof Collection) {
        values=new ArrayList<Object>((Collection<?>)value);
      }
 else {
        values=Collections.singletonList(value);
      }
      hitField=new InternalSearchHitField(scriptField.name(),values);
      hitContext.hit().fields().put(scriptField.name(),hitField);
    }
  }
}
