{
  if (entries.v().isEmpty()) {
    entries.close();
    return new InternalTermsStatsStringFacet(facetName,comparatorType,size,ImmutableList.<InternalTermsStatsStringFacet.StringEntry>of(),missing);
  }
  if (size == 0) {
    List<InternalTermsStatsStringFacet.StringEntry> stringEntries=new ArrayList<>();
    final boolean[] states=entries.v().allocated;
    final Object[] values=entries.v().values;
    for (int i=0; i < states.length; i++) {
      if (states[i]) {
        stringEntries.add((InternalTermsStatsStringFacet.StringEntry)values[i]);
      }
    }
    return new InternalTermsStatsStringFacet(facetName,comparatorType,0,stringEntries,missing);
  }
  Object[] values=entries.v().values;
  Arrays.sort(values,(Comparator)comparatorType.comparator());
  List<InternalTermsStatsStringFacet.StringEntry> ordered=Lists.newArrayList();
  int limit=shardSize;
  for (int i=0; i < limit; i++) {
    InternalTermsStatsStringFacet.StringEntry value=(InternalTermsStatsStringFacet.StringEntry)values[i];
    if (value == null) {
      break;
    }
    ordered.add(value);
  }
  entries.close();
  return new InternalTermsStatsStringFacet(facetName,comparatorType,size,ordered,missing);
}
