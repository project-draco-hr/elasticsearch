{
  IndexQueryParserService queryParserService=indicesService.indexServiceSafe(request.index()).queryParserService();
  IndexService indexService=indicesService.indexServiceSafe(request.index());
  IndexShard indexShard=indexService.shardSafe(request.shardId());
  boolean valid;
  String explanation=null;
  String error=null;
  if (request.querySource().length() == 0) {
    valid=true;
  }
 else {
    SearchContext.setCurrent(new SearchContext(0,new InternalSearchRequest().types(request.types()),null,indexShard.searcher(),indexService,indexShard,scriptService));
    try {
      ParsedQuery parsedQuery=queryParserService.parse(request.querySource());
      valid=true;
      if (request.explain()) {
        explanation=parsedQuery.query().toString();
      }
    }
 catch (    QueryParsingException e) {
      valid=false;
      error=e.getDetailedMessage();
    }
catch (    AssertionError e) {
      valid=false;
      error=e.getMessage();
    }
 finally {
      SearchContext.current().release();
      SearchContext.removeCurrent();
    }
  }
  return new ShardValidateQueryResponse(request.index(),request.shardId(),valid,explanation,error);
}
