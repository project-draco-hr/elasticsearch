{
  IndexQueryParserService queryParserService=indicesService.indexServiceSafe(request.index()).queryParserService();
  IndexService indexService=indicesService.indexServiceSafe(request.index());
  IndexShard indexShard=indexService.shardSafe(request.shardId());
  boolean valid;
  String explanation=null;
  String error=null;
  DefaultSearchContext searchContext=new DefaultSearchContext(0,new ShardSearchRequest().types(request.types()).nowInMillis(request.nowInMillis()).filteringAliases(request.filteringAliases()),null,indexShard.acquireSearcher("validate_query"),indexService,indexShard,scriptService,cacheRecycler,pageCacheRecycler,bigArrays);
  SearchContext.setCurrent(searchContext);
  try {
    if (request.source() != null && request.source().length() > 0) {
      searchContext.parsedQuery(queryParserService.parseQuery(request.source()));
    }
    searchContext.preProcess();
    valid=true;
    if (request.explain()) {
      explanation=searchContext.query().toString();
    }
  }
 catch (  QueryParsingException e) {
    valid=false;
    error=e.getDetailedMessage();
  }
catch (  AssertionError e) {
    valid=false;
    error=e.getMessage();
  }
 finally {
    SearchContext.current().close();
    SearchContext.removeCurrent();
  }
  return new ShardValidateQueryResponse(request.index(),request.shardId(),valid,explanation,error);
}
