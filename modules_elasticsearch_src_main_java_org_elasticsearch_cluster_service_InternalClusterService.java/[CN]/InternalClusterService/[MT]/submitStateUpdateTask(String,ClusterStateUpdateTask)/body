{
  if (!lifecycle.started()) {
    return;
  }
  updateTasksExecutor.execute(new Runnable(){
    @Override public void run(){
      if (!lifecycle.started()) {
        return;
      }
      ClusterState previousClusterState=clusterState;
      try {
        clusterState=updateTask.execute(previousClusterState);
      }
 catch (      Exception e) {
        StringBuilder sb=new StringBuilder("Failed to execute cluster state update, state:\nVersion [").append(clusterState.version()).append("], source [").append(source).append("]\n");
        sb.append(clusterState.nodes().prettyPrint());
        sb.append(clusterState.routingTable().prettyPrint());
        sb.append(clusterState.readOnlyRoutingNodes().prettyPrint());
        logger.warn(sb.toString(),e);
        return;
      }
      if (previousClusterState != clusterState) {
        if (clusterState.nodes().localNodeMaster()) {
          clusterState=new ClusterState(clusterState.version() + 1,clusterState.metaData(),clusterState.routingTable(),clusterState.nodes());
        }
 else {
          if (clusterState.version() < previousClusterState.version()) {
            logger.info("Got old cluster state [" + clusterState.version() + "<"+ previousClusterState.version()+ "] from source ["+ source+ "], ignoring");
            return;
          }
        }
        if (logger.isTraceEnabled()) {
          StringBuilder sb=new StringBuilder("Cluster State updated:\nVersion [").append(clusterState.version()).append("], source [").append(source).append("]\n");
          sb.append(clusterState.nodes().prettyPrint());
          sb.append(clusterState.routingTable().prettyPrint());
          sb.append(clusterState.readOnlyRoutingNodes().prettyPrint());
          logger.trace(sb.toString());
        }
 else         if (logger.isDebugEnabled()) {
          logger.debug("Cluster state updated, version [{}], source [{}]",clusterState.version(),source);
        }
        ClusterChangedEvent clusterChangedEvent=new ClusterChangedEvent(source,clusterState,previousClusterState,discoveryService.firstMaster());
        final DiscoveryNodes.Delta nodesDelta=clusterChangedEvent.nodesDelta();
        if (nodesDelta.hasChanges() && logger.isInfoEnabled()) {
          String summary=nodesDelta.shortSummary();
          if (summary.length() > 0) {
            logger.info(summary);
          }
        }
        threadPool.execute(new Runnable(){
          @Override public void run(){
            transportService.nodesAdded(nodesDelta.addedNodes());
          }
        }
);
        for (        TimeoutHolder timeoutHolder : clusterStateTimeoutListeners) {
          timeoutHolder.listener.clusterChanged(clusterChangedEvent);
        }
        for (        ClusterStateListener listener : clusterStateListeners) {
          listener.clusterChanged(clusterChangedEvent);
        }
        threadPool.execute(new Runnable(){
          @Override public void run(){
            transportService.nodesRemoved(nodesDelta.removedNodes());
          }
        }
);
        if (clusterState.nodes().localNodeMaster()) {
          discoveryService.publish(clusterState);
        }
        if (updateTask instanceof ProcessedClusterStateUpdateTask) {
          ((ProcessedClusterStateUpdateTask)updateTask).clusterStateProcessed(clusterState);
        }
      }
    }
  }
);
}
