{
  if (snapshotIds.contains(snapshotId)) {
    throw new IllegalArgumentException("[" + snapshotId + "] already exists in the repository data");
  }
  List<SnapshotId> snapshots=new ArrayList<>(snapshotIds);
  snapshots.add(snapshotId);
  Map<String,IndexMeta> indexMetaMap=getIndices();
  Map<String,IndexMeta> addedIndices=new HashMap<>();
  for (  IndexId indexId : snapshottedIndices) {
    final String indexName=indexId.getName();
    IndexMeta newIndexMeta;
    if (indexMetaMap.containsKey(indexName)) {
      newIndexMeta=indexMetaMap.get(indexName).addSnapshot(snapshotId);
    }
 else {
      Set<SnapshotId> ids=new LinkedHashSet<>();
      ids.add(snapshotId);
      newIndexMeta=new IndexMeta(indexId,ids);
    }
    addedIndices.put(indexName,newIndexMeta);
  }
  Map<String,IndexMeta> allIndices=new HashMap<>(indices);
  allIndices.putAll(addedIndices);
  return new RepositoryData(snapshots,allIndices);
}
