{
  delegate.close();
synchronized (mutex) {
    StoreFileMetaData md=filesMetadata.get(name);
    String md5=md == null ? null : md.md5();
    if (!ignoreDigest) {
      md5=Hex.encodeHexString(digest.digest());
    }
    if (md == null) {
      md=new StoreFileMetaData(name,directory().fileLength(name),directory().fileModified(name),md5);
    }
 else {
      md=new StoreFileMetaData(name,directory().fileLength(name),directory().fileModified(name),md5);
    }
    filesMetadata=MapBuilder.newMapBuilder(filesMetadata).put(name,md).immutableMap();
    files=filesMetadata.keySet().toArray(new String[filesMetadata.size()]);
  }
}
