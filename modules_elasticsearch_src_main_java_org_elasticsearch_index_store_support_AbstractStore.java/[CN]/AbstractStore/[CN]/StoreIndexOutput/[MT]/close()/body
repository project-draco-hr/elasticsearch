{
  delegate.close();
  String checksum=null;
  if (digest != null) {
    checksum=Hex.encodeHexString(digest.digest());
    IndexOutput checkSumOutput=((StoreDirectory)directory()).delegate().createOutput(name + ".cks");
    byte[] checksumBytes=Unicode.fromStringAsBytes(checksum);
    checkSumOutput.writeBytes(checksumBytes,checksumBytes.length);
    checkSumOutput.close();
  }
synchronized (mutex) {
    StoreFileMetaData md=new StoreFileMetaData(name,directory().fileLength(name),directory().fileModified(name),checksum);
    filesMetadata=MapBuilder.newMapBuilder(filesMetadata).put(name,md).immutableMap();
    files=filesMetadata.keySet().toArray(new String[filesMetadata.size()]);
  }
}
