{
  delegate.close();
synchronized (mutex) {
    StoreFileMetaData md=filesMetadata.get(name);
    String md5=md == null ? null : md.md5();
    byte[] digestBytes=digest.digest();
    if (digestBytes != null) {
      md5=Hex.encodeHexString(digestBytes);
      if (shouldWriteMd5(name)) {
        writeMd5File(directory(),name,md5);
      }
    }
    md=new StoreFileMetaData(name,directory().fileLength(name),directory().fileModified(name),md5);
    filesMetadata=MapBuilder.newMapBuilder(filesMetadata).put(name,md).immutableMap();
    files=filesMetadata.keySet().toArray(new String[filesMetadata.size()]);
  }
}
