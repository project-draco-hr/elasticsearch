{
  this.delegate=delegate;
synchronized (mutex) {
    MapBuilder<String,StoreFileMetaData> builder=MapBuilder.newMapBuilder();
    for (    String file : delegate.listAll()) {
      if (file.endsWith(".md5")) {
        continue;
      }
      try {
        String md5=preComputedMd5(file);
        if (md5 != null) {
          if (shouldWriteMd5(file)) {
            byte[] md5Bytes=Digest.md5HexToByteArray(md5);
            IndexOutput output=delegate.createOutput(file + ".md5");
            output.writeBytes(md5Bytes,md5Bytes.length);
            output.close();
          }
        }
        builder.put(file,new StoreFileMetaData(file,delegate.fileLength(file),delegate.fileModified(file),md5));
      }
 catch (      FileNotFoundException e) {
      }
    }
    filesMetadata=builder.immutableMap();
    files=filesMetadata.keySet().toArray(new String[filesMetadata.size()]);
  }
}
