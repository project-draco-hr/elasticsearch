{
  StoreFileMetaData md=metaData(name);
  if (md == null) {
    return null;
  }
  if (md.md5() == null) {
    IndexInput in=directory().openInput(name);
    String md5;
    try {
      InputStreamIndexInput is=new InputStreamIndexInput(in,Long.MAX_VALUE);
      md5=Digest.md5Hex(is);
    }
  finally {
      in.close();
    }
synchronized (mutex) {
      md=metaData(name);
      if (md == null) {
        return null;
      }
      if (md.md5() == null) {
        byte[] md5Bytes=Digest.md5HexToByteArray(md5);
        if (shouldWriteMd5(name)) {
          IndexOutput output=directory().createOutput(name + ".md5");
          output.writeBytes(md5Bytes,md5Bytes.length);
          output.close();
        }
        md=new StoreFileMetaData(md.name(),md.sizeInBytes(),md.sizeInBytes(),md5);
        filesMetadata=MapBuilder.newMapBuilder(filesMetadata).put(name,md).immutableMap();
      }
    }
  }
  return md;
}
