{
  final Balancer balancer=new Balancer(logger,allocation,weightFunction,threshold);
  boolean changed=false;
  if (allocation.routingNodes().unassigned().size() > 0) {
    changed|=balancer.allocateUnassigned();
  }
  changed|=balancer.moveShards();
  if (allocation.hasPendingAsyncFetch() == false) {
    changed|=balancer.balance();
  }
 else {
    logger.debug("skipping rebalance due to in-flight shard/store fetches");
  }
  return changed;
}
