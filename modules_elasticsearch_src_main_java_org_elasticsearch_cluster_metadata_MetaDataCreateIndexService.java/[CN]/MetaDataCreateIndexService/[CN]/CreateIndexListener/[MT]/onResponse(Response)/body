{
  if (notified.compareAndSet(false,true)) {
    if (timeout != null) {
      timeout.cancel();
    }
    long prefetchTime=0;
    if (shardsAllocation.preferUnallocatedStrategy() != null) {
      long start=System.currentTimeMillis();
      shardsAllocation.preferUnallocatedStrategy().prefetch(response.indexMetaData(),clusterService.state().nodes());
      prefetchTime=System.currentTimeMillis() - start;
    }
    final long fPrefetchTime=prefetchTime;
    clusterService.submitStateUpdateTask("reroute after index [" + request.index + "] creation",new ProcessedClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState){
        RoutingTable.Builder routingTableBuilder=new RoutingTable.Builder();
        for (        IndexRoutingTable indexRoutingTable : currentState.routingTable().indicesRouting().values()) {
          routingTableBuilder.add(indexRoutingTable);
        }
        IndexRoutingTable.Builder indexRoutingBuilder=new IndexRoutingTable.Builder(request.index).initializeEmpty(currentState.metaData().index(request.index));
        routingTableBuilder.add(indexRoutingBuilder);
        RoutingTable newRoutingTable=shardsAllocation.reroute(newClusterStateBuilder().state(currentState).routingTable(routingTableBuilder).build());
        return newClusterStateBuilder().state(currentState).routingTable(newRoutingTable).build();
      }
      @Override public void clusterStateProcessed(      ClusterState clusterState){
        logger.info("[{}] created and added to cluster_state, prefetch_took [{}]",request.index,TimeValue.timeValueMillis(fPrefetchTime));
        listener.onResponse(response);
      }
    }
);
  }
}
