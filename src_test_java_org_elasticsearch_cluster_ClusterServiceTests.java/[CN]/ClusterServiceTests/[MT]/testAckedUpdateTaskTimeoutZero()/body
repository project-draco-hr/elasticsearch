{
  Settings settings=settingsBuilder().put("discovery.type","zen").put("discovery.zen.minimum_master_nodes",1).put("discovery.zen.ping_timeout","200ms").put("discovery.initial_state_timeout","500ms").build();
  cluster().startNode(settings);
  ClusterService clusterService=cluster().getInstance(ClusterService.class);
  final AtomicBoolean allNodesAcked=new AtomicBoolean(false);
  final AtomicBoolean ackTimeout=new AtomicBoolean(false);
  final AtomicBoolean onFailure=new AtomicBoolean(false);
  final AtomicBoolean executed=new AtomicBoolean(false);
  final CountDownLatch latch=new CountDownLatch(1);
  clusterService.submitStateUpdateTask("test",new AckedClusterStateUpdateTask(){
    @Override public boolean mustAck(    DiscoveryNode discoveryNode){
      return false;
    }
    @Override public void onAllNodesAcked(    @Nullable Throwable t){
      allNodesAcked.set(true);
      latch.countDown();
    }
    @Override public void onAckTimeout(){
      ackTimeout.set(true);
      latch.countDown();
    }
    @Override public TimeValue ackTimeout(){
      return TimeValue.timeValueSeconds(0);
    }
    @Override public TimeValue timeout(){
      return TimeValue.timeValueSeconds(10);
    }
    @Override public void clusterStateProcessed(    String source,    ClusterState oldState,    ClusterState newState){
    }
    @Override public ClusterState execute(    ClusterState currentState) throws Exception {
      executed.set(true);
      return ClusterState.newClusterStateBuilder().state(currentState).build();
    }
    @Override public void onFailure(    String source,    Throwable t){
      onFailure.set(true);
      latch.countDown();
    }
  }
);
  assertThat(latch.await(1,TimeUnit.SECONDS),equalTo(true));
  assertThat(allNodesAcked.get(),equalTo(false));
  assertThat(ackTimeout.get(),equalTo(true));
  assertThat(executed.get(),equalTo(true));
  assertThat(onFailure.get(),equalTo(false));
}
