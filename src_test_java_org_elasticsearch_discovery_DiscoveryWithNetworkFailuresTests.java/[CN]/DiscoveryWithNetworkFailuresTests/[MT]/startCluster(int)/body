{
  Settings settings=ImmutableSettings.builder().put("discovery.zen.fd.ping_timeout","1s").put("discovery.zen.fd.ping_retries","1").put(DiscoverySettings.PUBLISH_TIMEOUT,"1s").put("http.enabled",false).put("gateway.local.list_timeout","10s").put(TransportModule.TRANSPORT_SERVICE_TYPE_KEY,MockTransportService.class.getName()).put(ElectMasterService.DISCOVERY_ZEN_MINIMUM_MASTER_NODES,numberOfNodes / 2 + 1).build();
  if (discoveryConfig == null) {
    if (randomBoolean()) {
      discoveryConfig=new ClusterDiscoveryConfiguration.UnicastZen(numberOfNodes,numberOfNodes,settings);
    }
 else {
      discoveryConfig=new ClusterDiscoveryConfiguration(numberOfNodes,settings);
    }
  }
  List<String> nodes=internalCluster().startNodesAsync(numberOfNodes).get();
  ensureStableCluster(numberOfNodes);
  for (  ZenPingService pingService : internalCluster().getInstances(ZenPingService.class)) {
    for (    ZenPing zenPing : pingService.zenPings()) {
      if (zenPing instanceof UnicastZenPing) {
        ((UnicastZenPing)zenPing).clearTemporalReponses();
      }
    }
  }
  return nodes;
}
