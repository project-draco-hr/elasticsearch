{
  logger.info(">> put mapping start {}",format);
  assertAcked(client().admin().indices().preparePutMapping("test").setType("type").setSource(XContentFactory.jsonBuilder().startObject().startObject("type").startObject("properties").startObject("s").field("type","string").startObject("fielddata").field("format",format).endObject().endObject().endObject().endObject().endObject()).get());
  logger.info(">> put mapping end {}",format);
  assertBusy(new Callable<Object>(){
    @Override public Object call() throws Exception {
      Set<String> nodes=internalCluster().nodesInclude("test");
      assertFalse(nodes.isEmpty());
      for (      String node : nodes) {
        IndicesService indicesService=internalCluster().getInstance(IndicesService.class,node);
        IndexService indexService=indicesService.indexService("test");
        assertThat(indexService,notNullValue());
        final SmartNameFieldMappers mappers=indexService.mapperService().smartName("s");
        assertThat(mappers,notNullValue());
        assertTrue(mappers.hasMapper());
        final String currentFormat=mappers.mapper().fieldDataType().getFormat(ImmutableSettings.EMPTY);
        assertThat(currentFormat,equalTo(format));
      }
      return null;
    }
  }
);
}
