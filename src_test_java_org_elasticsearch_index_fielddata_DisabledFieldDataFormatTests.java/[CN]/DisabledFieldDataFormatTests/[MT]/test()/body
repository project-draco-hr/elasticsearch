{
  prepareCreate("test").addMapping("type","s","type=string").execute().actionGet();
  ensureGreen();
  logger.info("indexing data start");
  for (int i=0; i < 10; ++i) {
    client().prepareIndex("test","type",Integer.toString(i)).setSource("s","value" + i).execute().actionGet();
  }
  logger.info("indexing data end");
  final int searchCycles=1;
  refresh();
  updateFormat("disabled");
  SubAggCollectionMode aggCollectionMode=randomFrom(SubAggCollectionMode.values());
  SearchResponse resp=null;
  for (int i=0; i < searchCycles; i++) {
    try {
      resp=client().prepareSearch("test").setPreference(Integer.toString(i)).addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
      assertFailures(resp);
    }
 catch (    SearchPhaseExecutionException e) {
    }
  }
  updateFormat("paged_bytes");
  for (int i=0; i < searchCycles; i++) {
    resp=client().prepareSearch("test").setPreference(Integer.toString(i)).addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
    assertNoFailures(resp);
  }
  updateFormat("disabled");
  for (int i=0; i < searchCycles; i++) {
    resp=client().prepareSearch("test").setPreference(Integer.toString(i)).addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
    assertNoFailures(resp);
  }
  client().prepareIndex("test","type","-1").setSource("s","value").execute().actionGet();
  refresh();
  for (int i=0; i < searchCycles; i++) {
    try {
      resp=client().prepareSearch("test").setPreference(Integer.toString(i)).addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
      assertFailures(resp);
    }
 catch (    SearchPhaseExecutionException e) {
    }
  }
}
