{
  createIndex("test");
  ensureGreen();
  for (int i=0; i < 10; ++i) {
    client().prepareIndex("test","type",Integer.toString(i)).setSource("s","value" + i).execute().actionGet();
  }
  refresh();
  updateFormat("disabled");
  SubAggCollectionMode aggCollectionMode=randomFrom(SubAggCollectionMode.values());
  SearchResponse resp=null;
  try {
    resp=client().prepareSearch("test").addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
    assertFailures(resp);
  }
 catch (  SearchPhaseExecutionException e) {
  }
  updateFormat("paged_bytes");
  resp=client().prepareSearch("test").addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
  assertNoFailures(resp);
  updateFormat("disabled");
  resp=client().prepareSearch("test").addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
  assertNoFailures(resp);
  client().prepareIndex("test","type","-1").setSource("s","value").execute().actionGet();
  refresh();
  try {
    resp=client().prepareSearch("test").addAggregation(AggregationBuilders.terms("t").field("s").collectMode(aggCollectionMode)).execute().actionGet();
    assertFailures(resp);
  }
 catch (  SearchPhaseExecutionException e) {
  }
}
