{
  final String sourceIndex=indexNameExpressionResolver.resolveDateMathExpression(shrinkReqeust.getSourceIndex());
  final CreateIndexRequest targetIndex=shrinkReqeust.getShrinkIndexReqeust();
  final String targetIndexName=indexNameExpressionResolver.resolveDateMathExpression(targetIndex.index());
  final IndexMetaData metaData=state.metaData().index(sourceIndex);
  final Settings targetIndexSettings=Settings.builder().put(targetIndex.settings()).normalizePrefix(IndexMetaData.INDEX_SETTING_PREFIX).build();
  long count=docsStats.getCount();
  if (count >= IndexWriter.MAX_DOCS) {
    throw new IllegalStateException("Can't merge index with more than [" + IndexWriter.MAX_DOCS + "] docs -  too many documents");
  }
  targetIndex.cause("shrink_index");
  targetIndex.settings(Settings.builder().put(targetIndexSettings).put("index.number_of_shards",1));
  return new CreateIndexClusterStateUpdateRequest(targetIndex,"shrink_index",targetIndexName,true).ackTimeout(targetIndex.timeout()).masterNodeTimeout(targetIndex.masterNodeTimeout()).settings(targetIndex.settings()).aliases(targetIndex.aliases()).customs(targetIndex.customs()).shrinkFrom(metaData.getIndex());
}
