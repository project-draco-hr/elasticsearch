{
  MemoryIndex memoryIndex=cache.get();
  for (  IndexableField field : parsedDocument.rootDoc().getFields()) {
    Analyzer analyzer=context.analysisService().defaultIndexAnalyzer();
    DocumentMapper documentMapper=context.mapperService().documentMapper(parsedDocument.type());
    if (documentMapper != null && documentMapper.mappers().getMapper(field.name()) != null) {
      analyzer=documentMapper.mappers().indexAnalyzer();
    }
    if (field.fieldType().indexOptions() == IndexOptions.NONE && field.name().equals(UidFieldMapper.NAME)) {
      continue;
    }
    try {
      try (TokenStream tokenStream=field.tokenStream(analyzer,null)){
        if (tokenStream != null) {
          memoryIndex.addField(field.name(),tokenStream,field.boost());
        }
      }
     }
 catch (    Exception e) {
      throw new ElasticsearchException("Failed to create token stream for [" + field.name() + "]",e);
    }
  }
  context.initialize(new DocEngineSearcher(memoryIndex),parsedDocument);
}
