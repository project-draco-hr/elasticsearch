{
  currentSnapshotStatus=new SnapshotStatus();
  currentSnapshotStatus.startTime(System.currentTimeMillis());
  try {
    doSnapshot(snapshot);
    currentSnapshotStatus.time(System.currentTimeMillis() - currentSnapshotStatus.startTime());
    currentSnapshotStatus.updateStage(SnapshotStatus.Stage.DONE);
  }
 catch (  Exception e) {
    currentSnapshotStatus.time(System.currentTimeMillis() - currentSnapshotStatus.startTime());
    currentSnapshotStatus.updateStage(SnapshotStatus.Stage.FAILURE);
    currentSnapshotStatus.failed(e);
    if (e instanceof IndexShardGatewaySnapshotFailedException) {
      throw (IndexShardGatewaySnapshotFailedException)e;
    }
 else {
      throw new IndexShardGatewaySnapshotFailedException(shardId,e.getMessage(),e);
    }
  }
 finally {
    this.lastSnapshotStatus=currentSnapshotStatus;
    this.currentSnapshotStatus=null;
  }
  return this.lastSnapshotStatus;
}
