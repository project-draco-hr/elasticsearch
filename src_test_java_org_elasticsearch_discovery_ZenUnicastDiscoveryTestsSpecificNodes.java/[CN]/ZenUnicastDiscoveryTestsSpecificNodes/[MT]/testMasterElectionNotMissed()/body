{
  final Settings settings=settingsBuilder().put("discovery.zen.ping.multicast.ping.enabled",false).put("discovery.zen.minimum_master_nodes",2).put("discovery.zen.ping.unicast.hosts","localhost:15300,localhost:15301,localhost:15302").put("transport.tcp.port","15300-15400").build();
  List<String> nodes=internalCluster().startNodesAsync(3,settings).get();
  ClusterHealthResponse clusterHealthResponse=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForNodes("3").execute().actionGet();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  DiscoveryNode masterDiscoNode=null;
  for (  String node : nodes.toArray(new String[3])) {
    ClusterState state=internalCluster().client(node).admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
    assertThat(state.nodes().size(),equalTo(3));
    if (masterDiscoNode == null) {
      masterDiscoNode=state.nodes().masterNode();
    }
 else {
      assertThat(masterDiscoNode.equals(state.nodes().masterNode()),equalTo(true));
    }
  }
}
