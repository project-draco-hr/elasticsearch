{
  Settings settings=settingsBuilder().put("discovery.type","zen").put("discovery.zen.minimum_master_nodes",2).put("discovery.zen.ping_timeout","200ms").put("discovery.initial_state_timeout","500ms").put("gateway.type","local").build();
  logger.info("--> start first node");
  internalCluster().startNode(settings);
  logger.info("--> should be blocked, no master...");
  ClusterState state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(true));
  assertThat(state.nodes().size(),equalTo(1));
  logger.info("--> start second node, cluster should be formed");
  internalCluster().startNode(settings);
  ClusterHealthResponse clusterHealthResponse=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForNodes("2").execute().actionGet();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(false));
  state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(false));
  state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.nodes().size(),equalTo(2));
  assertThat(state.metaData().indices().containsKey("test"),equalTo(false));
  createIndex("test");
  NumShards numShards=getNumShards("test");
  logger.info("--> indexing some data");
  for (int i=0; i < 100; i++) {
    client().prepareIndex("test","type1",Integer.toString(i)).setSource("field","value").execute().actionGet();
  }
  assertThat(client().admin().cluster().prepareHealth("test").setWaitForActiveShards(numShards.totalNumShards).execute().actionGet().getActiveShards(),equalTo(numShards.totalNumShards));
  flushAndRefresh();
  logger.info("--> verify we the data back");
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareCount().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(100l));
  }
  internalCluster().stopCurrentMasterNode();
  awaitBusy(new Predicate<Object>(){
    public boolean apply(    Object obj){
      ClusterState state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
      return state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID);
    }
  }
);
  state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(true));
  assertThat(state.nodes().size(),equalTo(1));
  logger.info("--> starting the previous master node again...");
  internalCluster().startNode(settings);
  clusterHealthResponse=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForYellowStatus().setWaitForNodes("2").execute().actionGet();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(false));
  state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(false));
  state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.nodes().size(),equalTo(2));
  assertThat(state.metaData().indices().containsKey("test"),equalTo(true));
  logger.info("Running Cluster Health");
  ClusterHealthResponse clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForGreenStatus()).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("--> verify we the data back");
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareCount().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(100l));
  }
  internalCluster().stopRandomNonMasterNode();
  assertThat(awaitBusy(new Predicate<Object>(){
    public boolean apply(    Object obj){
      ClusterState state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
      return state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID);
    }
  }
),equalTo(true));
  logger.info("--> starting the previous master node again...");
  internalCluster().startNode(settings);
  clusterHealthResponse=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForNodes("2").setWaitForGreenStatus().execute().actionGet();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(false));
  state=client().admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
  assertThat(state.blocks().hasGlobalBlock(DiscoverySettings.NO_MASTER_BLOCK_ID),equalTo(false));
  state=client().admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(state.nodes().size(),equalTo(2));
  assertThat(state.metaData().indices().containsKey("test"),equalTo(true));
  logger.info("Running Cluster Health");
  ensureGreen();
  logger.info("--> verify we the data back");
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareCount().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(100l));
  }
}
