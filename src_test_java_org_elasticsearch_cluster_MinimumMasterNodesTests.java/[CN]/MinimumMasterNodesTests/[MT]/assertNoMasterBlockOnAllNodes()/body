{
  assertThat(awaitBusy(new Predicate<Object>(){
    public boolean apply(    Object obj){
      boolean success=true;
      for (      Client client : internalCluster()) {
        ClusterState state=client.admin().cluster().prepareState().setLocal(true).execute().actionGet().getState();
        success&=state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK);
        if (logger.isDebugEnabled()) {
          logger.debug("Checking for NO_MASTER_BLOCK on client: {} NO_MASTER_BLOCK: [{}]",client,state.blocks().hasGlobalBlock(Discovery.NO_MASTER_BLOCK));
        }
      }
      return success;
    }
  }
,20,TimeUnit.SECONDS),equalTo(true));
}
