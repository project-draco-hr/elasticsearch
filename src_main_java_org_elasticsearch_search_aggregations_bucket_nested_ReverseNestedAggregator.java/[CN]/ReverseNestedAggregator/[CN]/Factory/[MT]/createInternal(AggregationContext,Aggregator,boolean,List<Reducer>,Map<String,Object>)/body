{
  NestedAggregator closestNestedAggregator=findClosestNestedAggregator(parent);
  if (closestNestedAggregator == null) {
    throw new SearchParseException(context.searchContext(),"Reverse nested aggregation [" + name + "] can only be used inside a [nested] aggregation",null);
  }
  final ObjectMapper objectMapper;
  if (path != null) {
    MapperService.SmartNameObjectMapper mapper=context.searchContext().smartNameObjectMapper(path);
    if (mapper == null) {
      return new Unmapped(name,context,parent,reducers,metaData);
    }
    objectMapper=mapper.mapper();
    if (objectMapper == null) {
      return new Unmapped(name,context,parent,reducers,metaData);
    }
    if (!objectMapper.nested().isNested()) {
      throw new AggregationExecutionException("[reverse_nested] nested path [" + path + "] is not nested");
    }
  }
 else {
    objectMapper=null;
  }
  return new ReverseNestedAggregator(name,factories,objectMapper,context,parent,reducers,metaData);
}
