{
  boolean closeAnalyzer=false;
  if (analyzer == null && request.analyzer() != null) {
    if (analysisService == null) {
      analyzer=analysisRegistry.getAnalyzer(request.analyzer());
      if (analyzer == null) {
        throw new IllegalArgumentException("failed to find global analyzer [" + request.analyzer() + "]");
      }
    }
 else {
      analyzer=analysisService.analyzer(request.analyzer());
      if (analyzer == null) {
        throw new IllegalArgumentException("failed to find analyzer [" + request.analyzer() + "]");
      }
    }
  }
 else   if (request.tokenizer() != null) {
    TokenizerFactory tokenizerFactory=parseTokenizerFactory(request,analysisService,analysisRegistry,environment);
    TokenFilterFactory[] tokenFilterFactories=new TokenFilterFactory[0];
    tokenFilterFactories=getTokenFilterFactories(request,analysisService,analysisRegistry,environment,tokenFilterFactories);
    CharFilterFactory[] charFilterFactories=new CharFilterFactory[0];
    charFilterFactories=getCharFilterFactories(request,analysisService,analysisRegistry,environment,charFilterFactories);
    analyzer=new CustomAnalyzer(tokenizerFactory,charFilterFactories,tokenFilterFactories);
    closeAnalyzer=true;
  }
 else   if (analyzer == null) {
    if (analysisService == null) {
      analyzer=analysisRegistry.getAnalyzer("standard");
    }
 else {
      analyzer=analysisService.defaultIndexAnalyzer();
    }
  }
  if (analyzer == null) {
    throw new IllegalArgumentException("failed to find analyzer");
  }
  List<AnalyzeResponse.AnalyzeToken> tokens=null;
  DetailAnalyzeResponse detail=null;
  if (request.explain()) {
    detail=detailAnalyze(request,analyzer,field);
  }
 else {
    tokens=simpleAnalyze(request,analyzer,field);
  }
  if (closeAnalyzer) {
    analyzer.close();
  }
  return new AnalyzeResponse(tokens,detail);
}
