{
  XContentType contentType=XContentType.fromMediaTypeOrFormat(request.param("format",request.header("Accept")));
  if (contentType == null) {
    if (autoDetectSource != null) {
      contentType=XContentFactory.xContentType(autoDetectSource);
    }
  }
  if (contentType == null) {
    contentType=XContentType.JSON;
  }
  String[] filters=useFiltering ? request.paramAsStringArrayOrEmptyIfAll("filter_path") : null;
  XContentBuilder builder=new XContentBuilder(XContentFactory.xContent(contentType),bytesOutput(),filters);
  if (request.paramAsBoolean("pretty",false)) {
    builder.prettyPrint().lfAtEnd();
  }
  builder.humanReadable(request.paramAsBoolean("human",builder.humanReadable()));
  return builder;
}
