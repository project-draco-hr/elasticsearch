{
  int currentNumDocs=reader.numDocs();
  if (currentNumDocs == 0) {
    return BloomFilter.EMPTY;
  }
  ConcurrentMap<String,BloomFilterEntry> fieldCache=cache.get(reader.getCoreCacheKey());
  if (fieldCache == null) {
synchronized (creationMutex) {
      fieldCache=cache.get(reader.getCoreCacheKey());
      if (fieldCache == null) {
        reader.addReaderFinishedListener(this);
        fieldCache=ConcurrentCollections.newConcurrentMap();
        cache.put(reader.getCoreCacheKey(),fieldCache);
      }
    }
  }
  BloomFilterEntry filter=fieldCache.get(fieldName);
  if (filter == null) {
synchronized (fieldCache) {
      filter=fieldCache.get(fieldName);
      if (filter == null) {
        filter=new BloomFilterEntry(currentNumDocs,BloomFilter.NONE);
        fieldCache.put(fieldName,filter);
        if (currentNumDocs < maxSize) {
          filter.loading.set(true);
          BloomFilterLoader loader=new BloomFilterLoader(reader,fieldName);
          if (asyncLoad) {
            threadPool.executor(ThreadPool.Names.CACHE).execute(loader);
          }
 else {
            loader.run();
            filter=fieldCache.get(fieldName);
          }
        }
      }
    }
  }
  if (filter.numDocs > 1000 && filter.numDocs < maxSize && (currentNumDocs / filter.numDocs) < 0.6) {
    if (filter.loading.compareAndSet(false,true)) {
      BloomFilterLoader loader=new BloomFilterLoader(reader,fieldName);
      if (asyncLoad) {
        threadPool.executor(ThreadPool.Names.CACHE).execute(loader);
      }
 else {
        loader.run();
        filter=fieldCache.get(fieldName);
      }
    }
  }
  return filter.filter;
}
