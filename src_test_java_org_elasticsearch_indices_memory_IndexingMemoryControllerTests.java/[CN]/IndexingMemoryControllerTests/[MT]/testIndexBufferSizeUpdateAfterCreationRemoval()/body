{
  createNode(ImmutableSettings.EMPTY);
  prepareCreate("test1").setSettings(IndexMetaData.SETTING_NUMBER_OF_SHARDS,1,IndexMetaData.SETTING_NUMBER_OF_REPLICAS,0).get();
  ensureGreen();
  final InternalIndexShard shard1=(InternalIndexShard)internalCluster().getInstance(IndicesService.class).indexService("test1").shard(0);
  prepareCreate("test2").setSettings(IndexMetaData.SETTING_NUMBER_OF_SHARDS,1,IndexMetaData.SETTING_NUMBER_OF_REPLICAS,0).get();
  ensureGreen();
  final InternalIndexShard shard2=(InternalIndexShard)internalCluster().getInstance(IndicesService.class).indexService("test2").shard(0);
  final long expected1ShardSize=internalCluster().getInstance(IndexingMemoryController.class).indexingBufferSize().bytes();
  final long expected2ShardsSize=expected1ShardSize / 2;
  boolean success=awaitBusy(new Predicate<Object>(){
    @Override public boolean apply(    Object input){
      return ((InternalEngine)shard1.engine()).indexingBufferSize().bytes() <= expected2ShardsSize && ((InternalEngine)shard2.engine()).indexingBufferSize().bytes() <= expected2ShardsSize;
    }
  }
);
  if (!success) {
    fail("failed to update shard indexing buffer size. expected [" + expected2ShardsSize + "] shard1 ["+ ((InternalEngine)shard1.engine()).indexingBufferSize().bytes()+ "] shard2  ["+ ((InternalEngine)shard2.engine()).indexingBufferSize().bytes()+ "]");
  }
  client().admin().indices().prepareDelete("test2").get();
  success=awaitBusy(new Predicate<Object>(){
    @Override public boolean apply(    Object input){
      return ((InternalEngine)shard1.engine()).indexingBufferSize().bytes() >= expected1ShardSize;
    }
  }
);
  if (!success) {
    fail("failed to update shard indexing buffer size after deleting shards. expected [" + expected1ShardSize + "] got ["+ ((InternalEngine)shard1.engine()).indexingBufferSize().bytes()+ "]");
  }
}
