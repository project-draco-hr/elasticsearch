{
  for (  IndexableField field : d.getFields()) {
    Analyzer analyzer=context.analysisService().defaultIndexAnalyzer();
    DocumentMapper documentMapper=context.mapperService().documentMapper(parsedDocument.type());
    if (documentMapper != null && documentMapper.mappers().getMapper(field.name()) != null) {
      analyzer=documentMapper.mappers().indexAnalyzer();
    }
    if (field.fieldType().indexOptions() == IndexOptions.NONE && field.name().equals(UidFieldMapper.NAME)) {
      continue;
    }
    try {
      try (TokenStream tokenStream=field.tokenStream(analyzer,null)){
        if (tokenStream != null) {
          memoryIndex.addField(field.name(),tokenStream,field.boost());
        }
      }
     }
 catch (    IOException e) {
      throw new ElasticsearchException("Failed to create token stream",e);
    }
  }
  return memoryIndex;
}
