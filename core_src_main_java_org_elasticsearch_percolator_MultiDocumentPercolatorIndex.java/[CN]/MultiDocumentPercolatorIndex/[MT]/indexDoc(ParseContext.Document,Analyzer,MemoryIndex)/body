{
  for (  IndexableField field : d.getFields()) {
    if (field.fieldType().indexOptions() == IndexOptions.NONE && field.name().equals(UidFieldMapper.NAME)) {
      continue;
    }
    try {
      try (TokenStream tokenStream=field.tokenStream(analyzer,null)){
        if (tokenStream != null) {
          memoryIndex.addField(field.name(),tokenStream,field.boost());
        }
      }
     }
 catch (    IOException e) {
      throw new ElasticsearchException("Failed to create token stream",e);
    }
  }
  return memoryIndex;
}
