{
  UpdateRequest request=new UpdateRequest("test","type","1");
  request.source(XContentFactory.jsonBuilder().startObject().field("script","script1").endObject());
  Script script=request.script();
  assertThat(script,notNullValue());
  assertThat(script.getScript(),equalTo("script1"));
  assertThat(script.getType(),equalTo(ScriptType.INLINE));
  assertThat(script.getLang(),equalTo(Script.DEFAULT_SCRIPT_LANG));
  Map<String,Object> params=script.getParams();
  assertThat(params,nullValue());
  request.source(XContentFactory.jsonBuilder().startObject().startObject("script").field("inline","script1").endObject().endObject());
  script=request.script();
  assertThat(script,notNullValue());
  assertThat(script.getScript(),equalTo("script1"));
  assertThat(script.getType(),equalTo(ScriptType.INLINE));
  assertThat(script.getLang(),equalTo(Script.DEFAULT_SCRIPT_LANG));
  params=script.getParams();
  assertThat(params,nullValue());
  request=new UpdateRequest("test","type","1");
  request.source(XContentFactory.jsonBuilder().startObject().startObject("script").field("inline","script1").startObject("params").field("param1","value1").endObject().endObject().endObject());
  script=request.script();
  assertThat(script,notNullValue());
  assertThat(script.getScript(),equalTo("script1"));
  assertThat(script.getType(),equalTo(ScriptType.INLINE));
  assertThat(script.getLang(),equalTo(Script.DEFAULT_SCRIPT_LANG));
  params=script.getParams();
  assertThat(params,notNullValue());
  assertThat(params.size(),equalTo(1));
  assertThat(params.get("param1").toString(),equalTo("value1"));
  request=new UpdateRequest("test","type","1");
  request.source(XContentFactory.jsonBuilder().startObject().startObject("script").startObject("params").field("param1","value1").endObject().field("inline","script1").endObject().endObject());
  script=request.script();
  assertThat(script,notNullValue());
  assertThat(script.getScript(),equalTo("script1"));
  assertThat(script.getType(),equalTo(ScriptType.INLINE));
  assertThat(script.getLang(),equalTo(Script.DEFAULT_SCRIPT_LANG));
  params=script.getParams();
  assertThat(params,notNullValue());
  assertThat(params.size(),equalTo(1));
  assertThat(params.get("param1").toString(),equalTo("value1"));
  request=new UpdateRequest("test","type","1");
  request.source(XContentFactory.jsonBuilder().startObject().startObject("script").startObject("params").field("param1","value1").endObject().field("inline","script1").endObject().startObject("upsert").field("field1","value1").startObject("compound").field("field2","value2").endObject().endObject().endObject());
  script=request.script();
  assertThat(script,notNullValue());
  assertThat(script.getScript(),equalTo("script1"));
  assertThat(script.getType(),equalTo(ScriptType.INLINE));
  assertThat(script.getLang(),equalTo(Script.DEFAULT_SCRIPT_LANG));
  params=script.getParams();
  assertThat(params,notNullValue());
  assertThat(params.size(),equalTo(1));
  assertThat(params.get("param1").toString(),equalTo("value1"));
  Map<String,Object> upsertDoc=XContentHelper.convertToMap(request.upsertRequest().source(),true).v2();
  assertThat(upsertDoc.get("field1").toString(),equalTo("value1"));
  assertThat(((Map)upsertDoc.get("compound")).get("field2").toString(),equalTo("value2"));
  request=new UpdateRequest("test","type","1");
  request.source(XContentFactory.jsonBuilder().startObject().startObject("upsert").field("field1","value1").startObject("compound").field("field2","value2").endObject().endObject().startObject("script").startObject("params").field("param1","value1").endObject().field("inline","script1").endObject().endObject());
  script=request.script();
  assertThat(script,notNullValue());
  assertThat(script.getScript(),equalTo("script1"));
  assertThat(script.getType(),equalTo(ScriptType.INLINE));
  assertThat(script.getLang(),equalTo(Script.DEFAULT_SCRIPT_LANG));
  params=script.getParams();
  assertThat(params,notNullValue());
  assertThat(params.size(),equalTo(1));
  assertThat(params.get("param1").toString(),equalTo("value1"));
  upsertDoc=XContentHelper.convertToMap(request.upsertRequest().source(),true).v2();
  assertThat(upsertDoc.get("field1").toString(),equalTo("value1"));
  assertThat(((Map)upsertDoc.get("compound")).get("field2").toString(),equalTo("value2"));
  request=new UpdateRequest("test","type","1");
  request.source(XContentFactory.jsonBuilder().startObject().startObject("doc").field("field1","value1").startObject("compound").field("field2","value2").endObject().endObject().endObject());
  Map<String,Object> doc=request.doc().sourceAsMap();
  assertThat(doc.get("field1").toString(),equalTo("value1"));
  assertThat(((Map)doc.get("compound")).get("field2").toString(),equalTo("value2"));
}
