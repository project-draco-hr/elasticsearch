{
  try (ReleasableLock lock=writeLock.acquire()){
    ensureOpen();
    final long offset=totalOffset;
    if (data.length() >= buffer.length) {
      flush();
      try {
        data.writeTo(channel);
      }
 catch (      Throwable ex) {
        closeWithTragicEvent(ex);
        throw ex;
      }
      writtenOffset+=data.length();
      totalOffset+=data.length();
    }
 else {
      if (data.length() > buffer.length - bufferCount) {
        flush();
      }
      data.writeTo(bufferOs);
      totalOffset+=data.length();
    }
    operationCounter++;
    return new Translog.Location(generation,offset,data.length());
  }
 }
