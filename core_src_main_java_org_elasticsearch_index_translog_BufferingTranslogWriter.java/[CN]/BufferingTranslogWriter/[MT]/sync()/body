{
  if (syncNeeded()) {
    ensureOpen();
    channelReference.incRef();
    try {
      final long offsetToSync;
      final int opsCounter;
      try (ReleasableLock lock=writeLock.acquire()){
        flush();
        offsetToSync=totalOffset;
        opsCounter=operationCounter;
      }
       try {
        ensureOpen();
        checkpoint(offsetToSync,opsCounter,channelReference);
      }
 catch (      IOException ex) {
        closeWithTragicEvent(ex);
        throw ex;
      }
      lastSyncedOffset=offsetToSync;
    }
  finally {
      channelReference.decRef();
    }
  }
}
