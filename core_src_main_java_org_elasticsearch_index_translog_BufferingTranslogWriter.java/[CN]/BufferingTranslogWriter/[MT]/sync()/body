{
  if (syncNeeded()) {
    ensureOpen();
    channelReference.incRef();
    try {
      final long offsetToSync;
      final int opsCounter;
      try (ReleasableLock lock=writeLock.acquire()){
        flush();
        offsetToSync=totalOffset;
        opsCounter=operationCounter;
      }
       ensureOpen();
      try {
        checkpoint(offsetToSync,opsCounter,channelReference);
      }
 catch (      Throwable ex) {
        closeWithTragicEvent(ex);
        throw ex;
      }
      lastSyncedOffset=offsetToSync;
    }
  finally {
      channelReference.decRef();
    }
  }
}
