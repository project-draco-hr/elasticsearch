{
  if (!syncNeeded()) {
    return;
  }
synchronized (this) {
    ensureOpen();
    channelReference.incRef();
    try {
      final long offsetToSync;
      try (ReleasableLock lock=writeLock.acquire()){
        flush();
        offsetToSync=totalOffset;
      }
       try {
        ensureOpen();
        checkpoint(offsetToSync,operationCounter,channelReference);
      }
 catch (      IOException ex) {
        closeWithTragicEvent(ex);
        throw ex;
      }
      lastSyncedOffset=offsetToSync;
    }
  finally {
      channelReference.decRef();
    }
  }
}
