{
  if (!syncNeeded()) {
    return;
  }
synchronized (this) {
    channelReference.incRef();
    try {
      try (ReleasableLock lock=writeLock.acquire()){
        flush();
        lastSyncedOffset=totalOffset;
      }
       checkpoint(lastSyncedOffset,operationCounter,channelReference);
    }
  finally {
      channelReference.decRef();
    }
  }
}
