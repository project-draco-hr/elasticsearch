{
  ExecutorService indicesStopExecutor=Executors.newFixedThreadPool(5,EsExecutors.daemonThreadFactory("indices_shutdown"));
  Set<String> indices=new HashSet<>(this.indices.keySet());
  final CountDownLatch latch=new CountDownLatch(indices.size());
  for (  final String index : indices) {
    indicesStopExecutor.execute(new Runnable(){
      @Override public void run(){
        try {
          removeIndex(index,"shutdown",false);
        }
 catch (        Throwable e) {
          logger.warn("failed to remove index on stop [" + index + "]",e);
        }
 finally {
          latch.countDown();
        }
      }
    }
);
  }
  try {
    if (latch.await(shardsClosedTimeout.seconds(),TimeUnit.SECONDS) == false) {
      logger.warn("Not all shards are closed yet, waited {}sec - stopping service",shardsClosedTimeout.seconds());
    }
  }
 catch (  InterruptedException e) {
  }
 finally {
    indicesStopExecutor.shutdown();
  }
}
