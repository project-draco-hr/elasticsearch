{
  SearchResponse response=client().prepareSearch("idx").setProfile(true).addAggregation(histogram("histo").field(NUMBER_FIELD).interval(1L).subAggregation(terms("terms").field(TAG_FIELD).subAggregation(avg("avg").field(NUMBER_FIELD)))).get();
  assertSearchResponse(response);
  Map<String,ProfileShardResult> profileResults=response.getProfileResults();
  assertThat(profileResults,notNullValue());
  assertThat(profileResults.size(),equalTo(getNumShards("idx").numPrimaries));
  for (  ProfileShardResult profileShardResult : profileResults.values()) {
    assertThat(profileShardResult,notNullValue());
    AggregationProfileShardResult aggProfileResults=profileShardResult.getAggregationProfileResults();
    assertThat(aggProfileResults,notNullValue());
    List<ProfileResult> aggProfileResultsList=aggProfileResults.getProfileResults();
    assertThat(aggProfileResultsList,notNullValue());
    assertThat(aggProfileResultsList.size(),equalTo(1));
    ProfileResult histoAggResult=aggProfileResultsList.get(0);
    assertThat(histoAggResult,notNullValue());
    assertThat(histoAggResult.getQueryName(),equalTo(HistogramAggregator.class.getName()));
    assertThat(histoAggResult.getLuceneDescription(),equalTo("histo"));
    assertThat(histoAggResult.getTime(),greaterThan(0L));
    Map<String,Long> histoBreakdown=histoAggResult.getTimeBreakdown();
    assertThat(histoBreakdown,notNullValue());
    assertThat(histoBreakdown.get(AggregationTimingType.INITIALIZE.toString()),notNullValue());
    assertThat(histoBreakdown.get(AggregationTimingType.INITIALIZE.toString()),greaterThan(0L));
    assertThat(histoBreakdown.get(AggregationTimingType.COLLECT.toString()),notNullValue());
    assertThat(histoBreakdown.get(AggregationTimingType.COLLECT.toString()),greaterThan(0L));
    assertThat(histoBreakdown.get(AggregationTimingType.BUILD_AGGREGATION.toString()),notNullValue());
    assertThat(histoBreakdown.get(AggregationTimingType.BUILD_AGGREGATION.toString()),greaterThan(0L));
    assertThat(histoBreakdown.get(AggregationTimingType.REDUCE.toString()),notNullValue());
    assertThat(histoBreakdown.get(AggregationTimingType.REDUCE.toString()),equalTo(0L));
    assertThat(histoAggResult.getProfiledChildren().size(),equalTo(1));
    ProfileResult termsAggResult=histoAggResult.getProfiledChildren().get(0);
    assertThat(termsAggResult,notNullValue());
    assertThat(termsAggResult.getQueryName(),equalTo(GlobalOrdinalsStringTermsAggregator.WithHash.class.getName()));
    assertThat(termsAggResult.getLuceneDescription(),equalTo("terms"));
    assertThat(termsAggResult.getTime(),greaterThan(0L));
    Map<String,Long> termsBreakdown=termsAggResult.getTimeBreakdown();
    assertThat(termsBreakdown,notNullValue());
    assertThat(termsBreakdown.get(AggregationTimingType.INITIALIZE.toString()),notNullValue());
    assertThat(termsBreakdown.get(AggregationTimingType.INITIALIZE.toString()),greaterThan(0L));
    assertThat(termsBreakdown.get(AggregationTimingType.COLLECT.toString()),notNullValue());
    assertThat(termsBreakdown.get(AggregationTimingType.COLLECT.toString()),greaterThan(0L));
    assertThat(termsBreakdown.get(AggregationTimingType.BUILD_AGGREGATION.toString()),notNullValue());
    assertThat(termsBreakdown.get(AggregationTimingType.BUILD_AGGREGATION.toString()),greaterThan(0L));
    assertThat(termsBreakdown.get(AggregationTimingType.REDUCE.toString()),notNullValue());
    assertThat(termsBreakdown.get(AggregationTimingType.REDUCE.toString()),equalTo(0L));
    assertThat(termsAggResult.getProfiledChildren().size(),equalTo(1));
    ProfileResult avgAggResult=termsAggResult.getProfiledChildren().get(0);
    assertThat(avgAggResult,notNullValue());
    assertThat(avgAggResult.getQueryName(),equalTo(AvgAggregator.class.getName()));
    assertThat(avgAggResult.getLuceneDescription(),equalTo("avg"));
    assertThat(avgAggResult.getTime(),greaterThan(0L));
    Map<String,Long> avgBreakdown=termsAggResult.getTimeBreakdown();
    assertThat(avgBreakdown,notNullValue());
    assertThat(avgBreakdown.get(AggregationTimingType.INITIALIZE.toString()),notNullValue());
    assertThat(avgBreakdown.get(AggregationTimingType.INITIALIZE.toString()),greaterThan(0L));
    assertThat(avgBreakdown.get(AggregationTimingType.COLLECT.toString()),notNullValue());
    assertThat(avgBreakdown.get(AggregationTimingType.COLLECT.toString()),greaterThan(0L));
    assertThat(avgBreakdown.get(AggregationTimingType.BUILD_AGGREGATION.toString()),notNullValue());
    assertThat(avgBreakdown.get(AggregationTimingType.BUILD_AGGREGATION.toString()),greaterThan(0L));
    assertThat(avgBreakdown.get(AggregationTimingType.REDUCE.toString()),notNullValue());
    assertThat(avgBreakdown.get(AggregationTimingType.REDUCE.toString()),equalTo(0L));
    assertThat(avgAggResult.getProfiledChildren().size(),equalTo(0));
  }
}
