{
  BlobStoreIndexShardSnapshots newSnapshots=new BlobStoreIndexShardSnapshots(snapshots);
  for (  String blobName : blobs.keySet()) {
    if (indexShardSnapshotsFormat.isTempBlobName(blobName) || blobName.startsWith(SNAPSHOT_INDEX_PREFIX)) {
      try {
        blobContainer.deleteBlob(blobName);
      }
 catch (      IOException e) {
        throw new IndexShardSnapshotFailedException(shardId,"error deleting index file [" + blobName + "] during cleanup",e);
      }
    }
  }
  for (  String blobName : blobs.keySet()) {
    if (blobName.startsWith(DATA_BLOB_PREFIX)) {
      if (newSnapshots.findNameFile(BlobStoreIndexShardSnapshot.FileInfo.canonicalName(blobName)) == null) {
        try {
          blobContainer.deleteBlob(blobName);
        }
 catch (        IOException e) {
          logger.debug(new ParameterizedMessage("[{}] [{}] error deleting blob [{}] during cleanup",snapshotId,shardId,blobName),e);
        }
      }
    }
  }
  if (snapshots.size() > 0) {
    try {
      indexShardSnapshotsFormat.writeAtomic(newSnapshots,blobContainer,Integer.toString(fileListGeneration));
    }
 catch (    IOException e) {
      throw new IndexShardSnapshotFailedException(shardId,"Failed to write file list",e);
    }
  }
}
