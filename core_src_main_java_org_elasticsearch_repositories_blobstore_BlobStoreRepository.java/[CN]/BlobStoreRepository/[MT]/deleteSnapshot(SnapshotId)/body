{
  List<String> indices=Collections.EMPTY_LIST;
  Snapshot snapshot=null;
  try {
    snapshot=readSnapshot(snapshotId);
    indices=snapshot.indices();
  }
 catch (  SnapshotMissingException ex) {
    throw ex;
  }
catch (  SnapshotException|ElasticsearchParseException ex) {
    logger.warn("cannot read snapshot file [{}]",ex,snapshotId);
  }
  MetaData metaData=null;
  try {
    if (snapshot != null) {
      metaData=readSnapshotMetaData(snapshotId,snapshot.version(),indices,true);
    }
 else {
      try {
        metaData=readSnapshotMetaData(snapshotId,false,indices,true);
      }
 catch (      IOException ex) {
        metaData=readSnapshotMetaData(snapshotId,true,indices,true);
      }
    }
  }
 catch (  IOException|SnapshotException ex) {
    logger.warn("cannot read metadata for snapshot [{}]",ex,snapshotId);
  }
  try {
    String blobName=snapshotBlobName(snapshotId);
    snapshotsBlobContainer.deleteBlob(blobName);
    if (snapshot != null) {
      snapshotsBlobContainer.deleteBlob(metaDataBlobName(snapshotId,legacyMetaData(snapshot.version())));
    }
 else {
      snapshotsBlobContainer.deleteBlob(metaDataBlobName(snapshotId,true));
      snapshotsBlobContainer.deleteBlob(metaDataBlobName(snapshotId,false));
    }
    List<SnapshotId> snapshotIds=snapshots();
    if (snapshotIds.contains(snapshotId)) {
      ImmutableList.Builder<SnapshotId> builder=ImmutableList.builder();
      for (      SnapshotId id : snapshotIds) {
        if (!snapshotId.equals(id)) {
          builder.add(id);
        }
      }
      snapshotIds=builder.build();
    }
    writeSnapshotList(snapshotIds);
    for (    String index : indices) {
      BlobPath indexPath=basePath().add("indices").add(index);
      BlobContainer indexMetaDataBlobContainer=blobStore().blobContainer(indexPath);
      try {
        indexMetaDataBlobContainer.deleteBlob(blobName);
      }
 catch (      IOException ex) {
        logger.warn("[{}] failed to delete metadata for index [{}]",ex,snapshotId,index);
      }
      if (metaData != null) {
        IndexMetaData indexMetaData=metaData.index(index);
        if (indexMetaData != null) {
          for (int i=0; i < indexMetaData.getNumberOfShards(); i++) {
            ShardId shardId=new ShardId(index,i);
            try {
              indexShardRepository.delete(snapshotId,shardId);
            }
 catch (            IndexShardException|SnapshotException ex) {
              logger.warn("[{}] failed to delete shard data for shard [{}]",ex,snapshotId,shardId);
            }
          }
        }
      }
    }
  }
 catch (  IOException ex) {
    throw new RepositoryException(this.repositoryName,"failed to update snapshot in repository",ex);
  }
}
