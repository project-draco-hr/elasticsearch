{
  try {
    String snapshotBlobName=snapshotBlobName(snapshotId);
    if (snapshotsBlobContainer.blobExists(snapshotBlobName)) {
      throw new InvalidSnapshotNameException(snapshotId,"snapshot with such name already exists");
    }
    try (StreamOutput output=compressIfNeeded(snapshotsBlobContainer.createOutput(metaDataBlobName(snapshotId,false)))){
      writeGlobalMetaData(metaData,output);
    }
     for (    String index : indices) {
      final IndexMetaData indexMetaData=metaData.index(index);
      final BlobPath indexPath=basePath().add("indices").add(index);
      final BlobContainer indexMetaDataBlobContainer=blobStore().blobContainer(indexPath);
      try (StreamOutput output=compressIfNeeded(indexMetaDataBlobContainer.createOutput(snapshotBlobName(snapshotId)))){
        XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON,output);
        builder.startObject();
        IndexMetaData.Builder.toXContent(indexMetaData,builder,ToXContent.EMPTY_PARAMS);
        builder.endObject();
        builder.close();
      }
     }
  }
 catch (  IOException ex) {
    throw new SnapshotCreationException(snapshotId,ex);
  }
}
