{
  internalCluster().startNodesAsync(2,Settings.builder().put(InternalClusterInfoService.INTERNAL_CLUSTER_INFO_UPDATE_INTERVAL,"200ms").build()).get();
  assertAcked(prepareCreate("test").setSettings(settingsBuilder().put(Store.INDEX_STORE_STATS_REFRESH_INTERVAL,0).build()));
  ensureGreen("test");
  InternalTestCluster internalTestCluster=internalCluster();
  final InternalClusterInfoService infoService=(InternalClusterInfoService)internalTestCluster.getInstance(ClusterInfoService.class,internalTestCluster.getMasterName());
  InfoListener listener=new InfoListener();
  infoService.addListener(listener);
  ClusterInfo info=listener.get();
  assertNotNull("info should not be null",info);
  Map<String,DiskUsage> usages=info.getNodeDiskUsages();
  Map<String,Long> shardSizes=info.getShardSizes();
  assertNotNull(usages);
  assertNotNull(shardSizes);
  assertThat("some usages are populated",usages.values().size(),Matchers.equalTo(2));
  assertThat("some shard sizes are populated",shardSizes.values().size(),greaterThan(0));
  for (  DiskUsage usage : usages.values()) {
    logger.info("--> usage: {}",usage);
    assertThat("usage has be retrieved",usage.getFreeBytes(),greaterThan(0L));
  }
  for (  Long size : shardSizes.values()) {
    logger.info("--> shard size: {}",size);
    assertThat("shard size is greater than 0",size,greaterThan(0L));
  }
}
