{
  client().admin().indices().prepareRefresh("test").get();
  XContentBuilder builder=filterBuilder.toXContent(JsonXContent.contentBuilder(),ToXContent.EMPTY_PARAMS);
  XContentParser parser=JsonXContent.jsonXContent.createParser(builder.bytes());
  Filter filter=indexService.queryParserService().parseInnerFilter(parser).filter();
  try (Searcher searcher=indexService.shardSafe(0).acquireSearcher("test")){
    final LeafReaderContext ctx=searcher.reader().leaves().get(0);
    DocIdSet set=filter.getDocIdSet(ctx,null);
    assertEquals(broken,DocIdSets.isBroken(set.iterator()));
  }
 }
