{
  String[] concreteIndices=state.metaData().concreteIndices(request.indicesOptions(),request.indices());
  if (concreteIndices.length == 0) {
    listener.onResponse(new DeleteIndexResponse(true));
    return;
  }
  final CountDown count=new CountDown(concreteIndices.length);
  for (  final String index : concreteIndices) {
    deleteIndexService.deleteIndex(new MetaDataDeleteIndexService.Request(index).timeout(request.timeout()).masterTimeout(request.masterNodeTimeout()),new MetaDataDeleteIndexService.Listener(){
      private volatile Throwable lastFailure;
      private volatile boolean ack=true;
      @Override public void onResponse(      MetaDataDeleteIndexService.Response response){
        if (!response.acknowledged()) {
          ack=false;
        }
        if (count.countDown()) {
          if (lastFailure != null) {
            listener.onFailure(lastFailure);
          }
 else {
            listener.onResponse(new DeleteIndexResponse(ack));
          }
        }
      }
      @Override public void onFailure(      Throwable t){
        logger.debug("[{}] failed to delete index",t,index);
        lastFailure=t;
        if (count.countDown()) {
          listener.onFailure(t);
        }
      }
    }
);
  }
}
