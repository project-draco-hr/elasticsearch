{
  Channel targetChannel=nodeChannel(node,options);
  if (compress) {
    options.withCompress(true);
  }
  CachedStreamOutput.Entry cachedEntry=CachedStreamOutput.popEntry();
  TransportStreams.buildRequest(cachedEntry,requestId,action,message,options);
  BytesReference bytes=cachedEntry.bytes().bytes();
  ChannelBuffer buffer=ChannelBuffers.wrappedBuffer(bytes.array(),bytes.arrayOffset(),bytes.length());
  ChannelFuture future=targetChannel.write(buffer);
  future.addListener(new CacheFutureListener(cachedEntry));
}
