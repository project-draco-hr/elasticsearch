{
  final CountDownLatch latch=new CountDownLatch(1);
  threadPool.generic().execute(new Runnable(){
    @Override public void run(){
      globalLock.writeLock().lock();
      try {
        for (Iterator<NodeChannels> it=connectedNodes.values().iterator(); it.hasNext(); ) {
          NodeChannels nodeChannels=it.next();
          it.remove();
          nodeChannels.close();
        }
        if (serverChannel != null) {
          try {
            serverChannel.close().awaitUninterruptibly();
          }
  finally {
            serverChannel=null;
          }
        }
        if (serverOpenChannels != null) {
          serverOpenChannels.close();
          serverOpenChannels=null;
        }
        if (serverBootstrap != null) {
          serverBootstrap.releaseExternalResources();
          serverBootstrap=null;
        }
        for (Iterator<NodeChannels> it=connectedNodes.values().iterator(); it.hasNext(); ) {
          NodeChannels nodeChannels=it.next();
          it.remove();
          nodeChannels.close();
        }
        if (clientBootstrap != null) {
          clientBootstrap.releaseExternalResources();
          clientBootstrap=null;
        }
      }
  finally {
        globalLock.writeLock().unlock();
        latch.countDown();
      }
    }
  }
);
  try {
    latch.await(30,TimeUnit.SECONDS);
  }
 catch (  InterruptedException e) {
  }
}
