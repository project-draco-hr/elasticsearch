{
  Channel targetChannel=nodeChannel(node,options);
  if (compress) {
    options.withCompress(true);
  }
  byte status=0;
  status=TransportStatus.setRequest(status);
  BytesStreamOutput bStream=new BytesStreamOutput();
  bStream.skip(NettyHeader.HEADER_SIZE);
  StreamOutput stream=bStream;
  if (options.compress()) {
    status=TransportStatus.setCompress(status);
    stream=CompressorFactory.defaultCompressor().streamOutput(stream);
  }
  stream=new HandlesStreamOutput(stream);
  Version version=Version.smallest(this.version,node.version());
  stream.setVersion(version);
  stream.writeString(action);
  request.writeTo(stream);
  stream.close();
  ChannelBuffer buffer=bStream.bytes().toChannelBuffer();
  NettyHeader.writeHeader(buffer,requestId,status,version);
  targetChannel.write(buffer);
}
