{
  if (!lifecycle.started()) {
    throw new ElasticsearchIllegalStateException("can't add nodes to a stopped transport");
  }
  if (node == null) {
    throw new ConnectTransportException(null,"can't connect to a null node");
  }
  globalLock.readLock().lock();
  try {
    connectionLock.acquire(node.id());
    try {
      if (!lifecycle.started()) {
        throw new ElasticsearchIllegalStateException("can't add nodes to a stopped transport");
      }
      NodeChannels nodeChannels=connectedNodes.get(node);
      if (nodeChannels != null) {
        return;
      }
      try {
        if (light) {
          nodeChannels=connectToChannelsLight(node);
        }
 else {
          nodeChannels=new NodeChannels(new Channel[connectionsPerNodeRecovery],new Channel[connectionsPerNodeBulk],new Channel[connectionsPerNodeReg],new Channel[connectionsPerNodeState],new Channel[connectionsPerNodePing]);
          try {
            connectToChannels(nodeChannels,node);
          }
 catch (          Throwable e) {
            logger.trace("failed to connect to [{}], cleaning dangling connections",e,node);
            nodeChannels.close();
            throw e;
          }
        }
        nodeChannels.start();
        connectedNodes.put(node,nodeChannels);
        if (logger.isDebugEnabled()) {
          logger.debug("connected to node [{}]",node);
        }
        transportServiceAdapter.raiseNodeConnected(node);
      }
 catch (      ConnectTransportException e) {
        throw e;
      }
catch (      Exception e) {
        throw new ConnectTransportException(node,"general node connection failure",e);
      }
    }
  finally {
      connectionLock.release(node.id());
    }
  }
  finally {
    globalLock.readLock().unlock();
  }
}
