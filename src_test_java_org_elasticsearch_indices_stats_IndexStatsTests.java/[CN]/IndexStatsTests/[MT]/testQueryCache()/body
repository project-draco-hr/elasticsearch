{
  assertAcked(client().admin().indices().prepareCreate("idx").setSettings(IndicesQueryCache.INDEX_CACHE_QUERY_ENABLED,true).get());
  ensureGreen();
  int pageDocs=randomIntBetween(2,100);
  int numDocs=0;
  int counter=0;
  while (true) {
    IndexRequestBuilder[] builders=new IndexRequestBuilder[pageDocs];
    for (int i=0; i < pageDocs; ++i) {
      builders[i]=client().prepareIndex("idx","type",Integer.toString(counter++)).setSource(jsonBuilder().startObject().field("common","field").field("str_value","s" + i).endObject());
    }
    indexRandom(true,builders);
    numDocs+=pageDocs;
    boolean allHaveDocs=true;
    for (    ShardStats stats : client().admin().indices().prepareStats("idx").setDocs(true).get().getShards()) {
      if (stats.getStats().getDocs().getCount() == 0) {
        allHaveDocs=false;
        break;
      }
    }
    if (allHaveDocs) {
      break;
    }
  }
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),equalTo(0l));
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getHitCount(),equalTo(0l));
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMissCount(),equalTo(0l));
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareSearch("idx").setSearchType(SearchType.COUNT).get().getHits().getTotalHits(),equalTo((long)numDocs));
    assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),greaterThan(0l));
  }
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getHitCount(),greaterThan(0l));
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMissCount(),greaterThan(0l));
  IndexRequestBuilder[] builders=new IndexRequestBuilder[numDocs];
  for (int i=0; i < numDocs; ++i) {
    builders[i]=client().prepareIndex("idx","type",Integer.toString(i)).setSource(jsonBuilder().startObject().field("common","field").field("str_value","s" + i).endObject());
  }
  indexRandom(true,builders);
  refresh();
  assertBusy(new Runnable(){
    @Override public void run(){
      assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),equalTo(0l));
    }
  }
);
  for (int i=0; i < 10; i++) {
    assertThat(client().prepareSearch("idx").setSearchType(SearchType.COUNT).get().getHits().getTotalHits(),equalTo((long)numDocs));
    assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),greaterThan(0l));
  }
  client().admin().indices().prepareClearCache().setQueryCache(true).get();
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),equalTo(0l));
  assertThat(client().prepareSearch("idx").setSearchType(SearchType.COUNT).setQueryCache(false).get().getHits().getTotalHits(),equalTo((long)numDocs));
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),equalTo(0l));
  assertThat(client().prepareSearch("idx").setSearchType(SearchType.COUNT).setQueryCache(true).get().getHits().getTotalHits(),equalTo((long)numDocs));
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),greaterThan(0l));
  client().admin().indices().prepareClearCache().setQueryCache(true).get();
  assertAcked(client().admin().indices().prepareUpdateSettings("idx").setSettings(ImmutableSettings.builder().put(IndicesQueryCache.INDEX_CACHE_QUERY_ENABLED,false)));
  assertThat(client().prepareSearch("idx").setSearchType(SearchType.COUNT).get().getHits().getTotalHits(),equalTo((long)numDocs));
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),equalTo(0l));
  assertThat(client().prepareSearch("idx").setSearchType(SearchType.COUNT).setQueryCache(true).get().getHits().getTotalHits(),equalTo((long)numDocs));
  assertThat(client().admin().indices().prepareStats("idx").setQueryCache(true).get().getTotal().getQueryCache().getMemorySizeInBytes(),greaterThan(0l));
}
