{
  assertAcked(prepareCreate("index").setSettings("number_of_replicas",0).get());
  indexRandom(true,client().prepareIndex("index","type","1").setSource("foo","bar"),client().prepareIndex("index","type","2").setSource("foo","baz"));
  ensureGreen();
  IndicesStatsResponse response=client().admin().indices().prepareStats("index").setFilterCache(true).get();
  assertCumulativeFilterCacheStats(response);
  assertEquals(0,response.getTotal().filterCache.getCacheSize());
  SearchResponse r;
  assertSearchResponse(r=client().prepareSearch("index").setQuery(QueryBuilders.constantScoreQuery(QueryBuilders.matchQuery("foo","baz"))).get());
  response=client().admin().indices().prepareStats("index").setFilterCache(true).get();
  assertCumulativeFilterCacheStats(response);
  assertThat(response.getTotal().filterCache.getHitCount(),equalTo(0L));
  assertThat(response.getTotal().filterCache.getEvictions(),equalTo(0L));
  assertThat(response.getTotal().filterCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getCacheSize(),greaterThan(0L));
  assertSearchResponse(client().prepareSearch("index").setQuery(QueryBuilders.constantScoreQuery(QueryBuilders.matchQuery("foo","baz"))).get());
  response=client().admin().indices().prepareStats("index").setFilterCache(true).get();
  assertCumulativeFilterCacheStats(response);
  assertThat(response.getTotal().filterCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getEvictions(),equalTo(0L));
  assertThat(response.getTotal().filterCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getCacheSize(),greaterThan(0L));
  assertTrue(client().prepareDelete("index","type","1").get().isFound());
  assertTrue(client().prepareDelete("index","type","2").get().isFound());
  refresh();
  response=client().admin().indices().prepareStats("index").setFilterCache(true).get();
  assertCumulativeFilterCacheStats(response);
  assertThat(response.getTotal().filterCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getEvictions(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getCacheSize(),equalTo(0L));
  assertThat(response.getTotal().filterCache.getCacheCount(),greaterThan(0L));
  indexRandom(true,client().prepareIndex("index","type","1").setSource("foo","bar"),client().prepareIndex("index","type","2").setSource("foo","baz"));
  assertSearchResponse(client().prepareSearch("index").setQuery(QueryBuilders.constantScoreQuery(QueryBuilders.matchQuery("foo","baz"))).get());
  response=client().admin().indices().prepareStats("index").setFilterCache(true).get();
  assertCumulativeFilterCacheStats(response);
  assertThat(response.getTotal().filterCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getEvictions(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getCacheSize(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getMemorySizeInBytes(),greaterThan(0L));
  assertAllSuccessful(client().admin().indices().prepareClearCache("index").setFilterCache(true).get());
  response=client().admin().indices().prepareStats("index").setFilterCache(true).get();
  assertCumulativeFilterCacheStats(response);
  assertThat(response.getTotal().filterCache.getHitCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getEvictions(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getMissCount(),greaterThan(0L));
  assertThat(response.getTotal().filterCache.getCacheSize(),equalTo(0L));
  assertThat(response.getTotal().filterCache.getMemorySizeInBytes(),equalTo(0L));
}
