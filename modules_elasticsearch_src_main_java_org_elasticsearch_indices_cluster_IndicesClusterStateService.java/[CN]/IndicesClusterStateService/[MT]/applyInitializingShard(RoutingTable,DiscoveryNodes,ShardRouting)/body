{
  final IndexService indexService=indicesService.indexServiceSafe(shardRouting.index());
  final int shardId=shardRouting.id();
  if (indexService.hasShard(shardId)) {
    IndexShard indexShard=indexService.shardSafe(shardId);
    if (indexShard.state() == IndexShardState.STARTED) {
      if (logger.isTraceEnabled()) {
        logger.trace("[{}][{}] master [{}] marked shard as initializing, but shard already created, mark shard as started");
      }
      shardStateAction.shardStarted(shardRouting,"master " + nodes.masterNode() + " marked shard as initializing, but shard already started, mark shard as started");
      return;
    }
 else {
      if (indexShard.ignoreRecoveryAttempt()) {
        return;
      }
    }
  }
  if (!indexService.hasShard(shardId)) {
    try {
      if (logger.isDebugEnabled()) {
        logger.debug("[{}][{}] creating shard",shardRouting.index(),shardId);
      }
      InternalIndexShard indexShard=(InternalIndexShard)indexService.createShard(shardId);
      indexShard.routingEntry(shardRouting);
    }
 catch (    IndexShardAlreadyExistsException e) {
    }
catch (    Exception e) {
      logger.warn("[{}][{}] failed to create shard",e,shardRouting.index(),shardRouting.id());
      try {
        indexService.cleanShard(shardId);
      }
 catch (      IndexShardMissingException e1) {
      }
catch (      Exception e1) {
        logger.warn("[{}][{}] failed to delete shard after failed creation",e1,shardRouting.index(),shardRouting.id());
      }
      shardStateAction.shardFailed(shardRouting,"Failed to create shard, message [" + detailedMessage(e) + "]");
      return;
    }
  }
  final InternalIndexShard indexShard=(InternalIndexShard)indexService.shardSafe(shardId);
  if (indexShard.ignoreRecoveryAttempt()) {
    return;
  }
  threadPool.execute(new Runnable(){
    @Override public void run(){
      if (indexShard.ignoreRecoveryAttempt()) {
        return;
      }
      try {
        RecoveryAction recoveryAction=indexService.shardInjector(shardId).getInstance(RecoveryAction.class);
        if (!shardRouting.primary()) {
          IndexShardRoutingTable shardRoutingTable=routingTable.index(shardRouting.index()).shard(shardRouting.id());
          for (          ShardRouting entry : shardRoutingTable) {
            if (entry.primary() && entry.started()) {
              DiscoveryNode node=nodes.get(entry.currentNodeId());
              try {
                recoveryAction.startRecovery(nodes.localNode(),node,false);
                shardStateAction.shardStarted(shardRouting,"after recovery (backup) from node [" + node + "]");
              }
 catch (              IgnoreRecoveryException e) {
                break;
              }
              break;
            }
          }
        }
 else {
          if (shardRouting.relocatingNodeId() == null) {
            IndexShardGatewayService shardGatewayService=indexService.shardInjector(shardId).getInstance(IndexShardGatewayService.class);
            try {
              shardGatewayService.recover();
              shardStateAction.shardStarted(shardRouting,"after recovery from gateway");
            }
 catch (            IgnoreGatewayRecoveryException e) {
            }
          }
 else {
            DiscoveryNode node=nodes.get(shardRouting.relocatingNodeId());
            try {
              recoveryAction.startRecovery(nodes.localNode(),node,true);
              shardStateAction.shardStarted(shardRouting,"after recovery (primary) from node [" + node + "]");
            }
 catch (            IgnoreRecoveryException e) {
            }
          }
        }
      }
 catch (      Exception e) {
        logger.warn("[{}][{}] failed to start shard",e,indexService.index().name(),shardRouting.id());
        if (indexService.hasShard(shardId)) {
          try {
            indexService.cleanShard(shardId);
          }
 catch (          Exception e1) {
            logger.warn("[{}][{}] failed to delete shard after failed startup",e1,indexService.index().name(),shardRouting.id());
          }
        }
        try {
          shardStateAction.shardFailed(shardRouting,"Failed to start shard, message [" + detailedMessage(e) + "]");
        }
 catch (        Exception e1) {
          logger.warn("[{}][{}] failed to mark shard as failed after a failed start",e1,indexService.index().name(),shardRouting.id());
        }
      }
    }
  }
);
}
