{
  if (!indicesService.changesAllowed())   return;
  if (!lifecycle.started()) {
    return;
  }
synchronized (mutex) {
    if (event.state().blocks().disableStatePersistence()) {
      for (      final String index : indicesService.indices()) {
        IndexService indexService=indicesService.indexService(index);
        for (        Integer shardId : indexService.shardIds()) {
          logger.debug("[{}][{}] removing shard (disabled block persistence)",index,shardId);
          try {
            indexService.removeShard(shardId,"removing shard (disabled block persistence)");
          }
 catch (          Exception e) {
            logger.warn("[{}] failed to remove shard (disabled block persistence)",e,index);
          }
        }
        indicesService.cleanIndex(index,"cleaning index (disabled block persistence)");
      }
      return;
    }
    applyNewIndices(event);
    applyMappings(event);
    applyAliases(event);
    applyNewOrUpdatedShards(event);
    applyDeletedIndices(event);
    applyDeletedShards(event);
    applyCleanedIndices(event);
    applySettings(event);
  }
}
