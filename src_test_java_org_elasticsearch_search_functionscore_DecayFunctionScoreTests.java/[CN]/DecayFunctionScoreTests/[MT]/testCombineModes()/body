{
  assertAcked(prepareCreate("test").addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("test").field("type","string").endObject().startObject("num").field("type","double").endObject().endObject().endObject().endObject()));
  ensureYellow();
  client().prepareIndex().setType("type1").setId("1").setIndex("test").setSource(jsonBuilder().startObject().field("test","value").field("num",1.0).endObject()).setRefresh(true).get();
  ActionFuture<SearchResponse> response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().query(functionScoreQuery(termQuery("test","value"),gaussDecayFunction("num",0.0,1.0).setDecay(0.5)).boost(2.0f).boostMode(CombineFunction.MULT))));
  SearchResponse sr=response.actionGet();
  SearchHits sh=sr.getHits();
  assertThat(sh.getTotalHits(),equalTo((long)(1)));
  assertThat(sh.getAt(0).getId(),equalTo("1"));
  assertThat((double)sh.getAt(0).score(),closeTo(0.30685282,1.e-5));
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().query(functionScoreQuery(termQuery("test","value"),gaussDecayFunction("num",0.0,1.0).setDecay(0.5)).boost(2.0f).boostMode(CombineFunction.REPLACE))));
  sr=response.actionGet();
  sh=sr.getHits();
  assertThat(sh.getTotalHits(),equalTo((long)(1)));
  assertThat(sh.getAt(0).getId(),equalTo("1"));
  assertThat((double)sh.getAt(0).score(),closeTo(1.0,1.e-5));
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().query(functionScoreQuery(termQuery("test","value"),gaussDecayFunction("num",0.0,1.0).setDecay(0.5)).boost(2.0f).boostMode(CombineFunction.SUM))));
  sr=response.actionGet();
  sh=sr.getHits();
  assertThat(sh.getTotalHits(),equalTo((long)(1)));
  assertThat(sh.getAt(0).getId(),equalTo("1"));
  assertThat((double)sh.getAt(0).score(),closeTo(2.0 * (0.30685282 + 0.5),1.e-5));
  logger.info("--> Hit[0] {} Explanation:\n {}",sr.getHits().getAt(0).id(),sr.getHits().getAt(0).explanation());
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().query(functionScoreQuery(termQuery("test","value"),gaussDecayFunction("num",0.0,1.0).setDecay(0.5)).boost(2.0f).boostMode(CombineFunction.AVG))));
  sr=response.actionGet();
  sh=sr.getHits();
  assertThat(sh.getTotalHits(),equalTo((long)(1)));
  assertThat(sh.getAt(0).getId(),equalTo("1"));
  assertThat((double)sh.getAt(0).score(),closeTo((0.30685282 + 0.5),1.e-5));
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().query(functionScoreQuery(termQuery("test","value"),gaussDecayFunction("num",0.0,1.0).setDecay(0.5)).boost(2.0f).boostMode(CombineFunction.MIN))));
  sr=response.actionGet();
  sh=sr.getHits();
  assertThat(sh.getTotalHits(),equalTo((long)(1)));
  assertThat(sh.getAt(0).getId(),equalTo("1"));
  assertThat((double)sh.getAt(0).score(),closeTo(2.0 * (0.30685282),1.e-5));
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().query(functionScoreQuery(termQuery("test","value"),gaussDecayFunction("num",0.0,1.0).setDecay(0.5)).boost(2.0f).boostMode(CombineFunction.MAX))));
  sr=response.actionGet();
  sh=sr.getHits();
  assertThat(sh.getTotalHits(),equalTo((long)(1)));
  assertThat(sh.getAt(0).getId(),equalTo("1"));
  assertThat((double)sh.getAt(0).score(),closeTo(1.0,1.e-5));
}
