{
  IndexWriter writer=new IndexWriter(new RAMDirectory(),new IndexWriterConfig(new StandardAnalyzer()).setMergePolicy(new LogByteSizeMergePolicy()));
  Document document=new Document();
  document.add(new StringField("field","value",Field.Store.NO));
  writer.addDocument(document);
  writer.commit();
  document=new Document();
  document.add(new StringField("field","value",Field.Store.NO));
  writer.addDocument(document);
  writer.commit();
  document=new Document();
  document.add(new StringField("field","value",Field.Store.NO));
  writer.addDocument(document);
  writer.commit();
  IndexReader reader=DirectoryReader.open(writer,false);
  IndexSearcher searcher=new IndexSearcher(reader);
  BitsetFilterCache cache=new BitsetFilterCache(new Index("test"),Settings.EMPTY);
  BitSetProducer filter=cache.getBitSetProducer(new QueryWrapperFilter(new TermQuery(new Term("field","value"))));
  assertThat(matchCount(filter,reader),equalTo(3));
  assertThat(matchCount(filter,reader),equalTo(3));
  assertThat(cache.getLoadedFilters().weight(),equalTo(3L));
  writer.forceMerge(1);
  reader.close();
  reader=DirectoryReader.open(writer,false);
  searcher=new IndexSearcher(reader);
  assertThat(matchCount(filter,reader),equalTo(3));
  assertThat(matchCount(filter,reader),equalTo(3));
  assertThat(cache.getLoadedFilters().weight(),equalTo(1L));
  reader.close();
  writer.close();
  assertThat(cache.getLoadedFilters().weight(),equalTo(0L));
}
