{
  long start=System.currentTimeMillis();
  SnapshotId snapshotId=new SnapshotId(repository,snapshot);
  while (System.currentTimeMillis() - start < timeout.millis()) {
    List<SnapshotInfo> snapshotInfos=client().admin().cluster().prepareGetSnapshots(repository).setSnapshots(snapshot).get().getSnapshots();
    assertThat(snapshotInfos.size(),equalTo(1));
    if (snapshotInfos.get(0).state().completed()) {
      ClusterStateResponse stateResponse=client().admin().cluster().prepareState().get();
      SnapshotMetaData snapshotMetaData=stateResponse.getState().getMetaData().custom(SnapshotMetaData.TYPE);
      if (snapshotMetaData == null || snapshotMetaData.snapshot(snapshotId) == null) {
        return snapshotInfos.get(0);
      }
    }
    Thread.sleep(100);
  }
  fail("Timeout!!!");
  return null;
}
