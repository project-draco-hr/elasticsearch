{
  if (snapshotScheduleFuture != null) {
    snapshotScheduleFuture.cancel(true);
    snapshotScheduleFuture=null;
  }
  if (!delete && snapshotOnClose) {
    logger.debug("snapshotting on close ...");
    try {
      snapshot();
    }
 catch (    Exception e) {
      logger.warn("failed to snapshot on close",e);
    }
  }
  if (!indexShard.routingEntry().primary()) {
    delete=false;
  }
  shardGateway.close(delete);
}
