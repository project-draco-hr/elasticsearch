{
  if (snapshotScheduleFuture != null) {
    snapshotScheduleFuture.cancel(true);
    snapshotScheduleFuture=null;
  }
  if (!delete && snapshotOnClose) {
    logger.debug("Snapshotting on close ...");
    snapshot();
  }
  if (!indexShard.routingEntry().primary()) {
    delete=false;
  }
  shardGateway.close(delete);
}
