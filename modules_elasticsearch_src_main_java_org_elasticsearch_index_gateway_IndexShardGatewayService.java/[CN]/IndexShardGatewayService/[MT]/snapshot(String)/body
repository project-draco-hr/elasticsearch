{
  if (!indexShard.routingEntry().primary()) {
    return;
  }
  if (indexShard.routingEntry().relocating()) {
    return;
  }
  if (indexShard.state() == IndexShardState.CREATED) {
    return;
  }
  if (indexShard.state() == IndexShardState.RECOVERING) {
    return;
  }
  try {
    SnapshotStatus snapshotStatus=indexShard.snapshot(new Engine.SnapshotHandler<SnapshotStatus>(){
      @Override public SnapshotStatus snapshot(      SnapshotIndexCommit snapshotIndexCommit,      Translog.Snapshot translogSnapshot) throws EngineException {
        if (lastIndexVersion != snapshotIndexCommit.getVersion() || lastTranslogId != translogSnapshot.translogId() || lastTranslogLength < translogSnapshot.length()) {
          logger.debug("snapshot ({}) to {} ...",reason,shardGateway);
          SnapshotStatus snapshotStatus=shardGateway.snapshot(new IndexShardGateway.Snapshot(snapshotIndexCommit,translogSnapshot,lastIndexVersion,lastTranslogId,lastTranslogLength,lastTotalTranslogOperations));
          lastIndexVersion=snapshotIndexCommit.getVersion();
          lastTranslogId=translogSnapshot.translogId();
          lastTranslogLength=translogSnapshot.length();
          lastTotalTranslogOperations=translogSnapshot.totalOperations();
          return snapshotStatus;
        }
        return null;
      }
    }
);
    if (snapshotStatus != null) {
      if (logger.isDebugEnabled()) {
        StringBuilder sb=new StringBuilder();
        sb.append("snapshot (").append(reason).append(") completed to ").append(shardGateway).append(", took [").append(TimeValue.timeValueMillis(snapshotStatus.time())).append("]\n");
        sb.append("    index    : version [").append(lastIndexVersion).append("], number_of_files [").append(snapshotStatus.index().numberOfFiles()).append("] with total_size [").append(new ByteSizeValue(snapshotStatus.index().totalSize())).append("], took [").append(TimeValue.timeValueMillis(snapshotStatus.index().time())).append("]\n");
        sb.append("    translog : id      [").append(lastTranslogId).append("], number_of_operations [").append(snapshotStatus.translog().expectedNumberOfOperations()).append("], took [").append(TimeValue.timeValueMillis(snapshotStatus.translog().time())).append("]");
        logger.debug(sb.toString());
      }
    }
  }
 catch (  SnapshotFailedEngineException e) {
    if (e.getCause() instanceof IllegalStateException) {
    }
 else {
      throw new IndexShardGatewaySnapshotFailedException(shardId,"Failed to snapshot",e);
    }
  }
catch (  IllegalIndexShardStateException e) {
  }
catch (  IndexShardGatewaySnapshotFailedException e) {
    throw e;
  }
catch (  Exception e) {
    throw new IndexShardGatewaySnapshotFailedException(shardId,"Failed to snapshot",e);
  }
}
