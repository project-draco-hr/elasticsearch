{
  if (!indexShard.routingEntry().primary()) {
    return;
  }
  if (indexShard.routingEntry().relocating()) {
    return;
  }
  if (indexShard.state() == IndexShardState.CREATED) {
    return;
  }
  try {
    IndexShardGateway.SnapshotStatus snapshotStatus=indexShard.snapshot(new Engine.SnapshotHandler<IndexShardGateway.SnapshotStatus>(){
      @Override public IndexShardGateway.SnapshotStatus snapshot(      SnapshotIndexCommit snapshotIndexCommit,      Translog.Snapshot translogSnapshot) throws EngineException {
        if (lastIndexVersion != snapshotIndexCommit.getVersion() || lastTranslogId != translogSnapshot.translogId() || lastTranslogLength != translogSnapshot.length()) {
          IndexShardGateway.SnapshotStatus snapshotStatus=shardGateway.snapshot(new IndexShardGateway.Snapshot(snapshotIndexCommit,translogSnapshot,lastIndexVersion,lastTranslogId,lastTranslogLength));
          lastIndexVersion=snapshotIndexCommit.getVersion();
          lastTranslogId=translogSnapshot.translogId();
          lastTranslogLength=translogSnapshot.length();
          return snapshotStatus;
        }
        return IndexShardGateway.SnapshotStatus.NA;
      }
    }
);
    if (snapshotStatus != IndexShardGateway.SnapshotStatus.NA) {
      if (logger.isDebugEnabled()) {
        StringBuilder sb=new StringBuilder();
        sb.append("snapshot (").append(reason).append(") completed to ").append(shardGateway).append(", took [").append(snapshotStatus.totalTime()).append("]\n");
        sb.append("    index    : number_of_files [").append(snapshotStatus.index().numberOfFiles()).append("] with total_size [").append(snapshotStatus.index().totalSize()).append("], took [").append(snapshotStatus.index().time()).append("]\n");
        sb.append("    translog : number_of_operations [").append(snapshotStatus.translog().numberOfOperations()).append("], took [").append(snapshotStatus.translog().time()).append("]");
        logger.debug(sb.toString());
      }
    }
  }
 catch (  SnapshotFailedEngineException e) {
    if (e.getCause() instanceof IllegalStateException) {
    }
 else {
      throw new IndexShardGatewaySnapshotFailedException(shardId,"Failed to snapshot",e);
    }
  }
catch (  IllegalIndexShardStateException e) {
  }
catch (  IndexShardGatewaySnapshotFailedException e) {
    throw e;
  }
catch (  Exception e) {
    throw new IndexShardGatewaySnapshotFailedException(shardId,"Failed to snapshot",e);
  }
}
