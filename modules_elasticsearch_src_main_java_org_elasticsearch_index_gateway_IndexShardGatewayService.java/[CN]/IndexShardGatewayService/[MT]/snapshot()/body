{
  if (!indexShard.routingEntry().primary()) {
    return;
  }
  if (indexShard.routingEntry().relocating()) {
    return;
  }
  try {
    indexShard.snapshot(new Engine.SnapshotHandler(){
      @Override public void snapshot(      SnapshotIndexCommit snapshotIndexCommit,      Translog.Snapshot translogSnapshot) throws EngineException {
        if (lastIndexVersion != snapshotIndexCommit.getVersion() || lastTranslogId != translogSnapshot.translogId() || lastTranslogSize != translogSnapshot.size()) {
          shardGateway.snapshot(new IndexShardGateway.Snapshot(snapshotIndexCommit,translogSnapshot,lastIndexVersion,lastTranslogId,lastTranslogSize));
          lastIndexVersion=snapshotIndexCommit.getVersion();
          lastTranslogId=translogSnapshot.translogId();
          lastTranslogSize=translogSnapshot.size();
        }
      }
    }
);
  }
 catch (  IllegalIndexShardStateException e) {
  }
catch (  Exception e) {
    logger.warn("Failed to snapshot on close",e);
  }
}
