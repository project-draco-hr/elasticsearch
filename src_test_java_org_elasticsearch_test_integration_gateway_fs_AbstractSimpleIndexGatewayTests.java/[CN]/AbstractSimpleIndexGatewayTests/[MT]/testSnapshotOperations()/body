{
  startNode("server1");
  Environment environment=((InternalNode)node("server1")).injector().getInstance(Environment.class);
  logger.info("Running Cluster Health (waiting for node to startup properly)");
  ClusterHealthResponse clusterHealth=client("server1").admin().cluster().health(clusterHealthRequest().setWaitForGreenStatus()).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("Creating index [{}]","test");
  client("server1").admin().indices().prepareCreate("test").execute().actionGet();
  PutMappingResponse putMappingResponse=client("server1").admin().indices().preparePutMapping("test").setType("type1").setSource(mappingSource()).execute().actionGet();
  assertThat(putMappingResponse.isAcknowledged(),equalTo(true));
  ClusterStateResponse clusterState=client("server1").admin().cluster().state(clusterStateRequest()).actionGet();
  assertThat(clusterState.getState().metaData().index("test").mapping("type1"),notNullValue());
  logger.info("Indexing #1");
  client("server1").index(Requests.indexRequest("test").setType("type1").setId("1").setSource(source("1","test"))).actionGet();
  logger.info("Indexing #2");
  client("server1").index(Requests.indexRequest("test").setType("type1").setId("2").setSource(source("2","test"))).actionGet();
  logger.info("Gateway Snapshot");
  client("server1").admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Deleting #1");
  client("server1").delete(deleteRequest("test").setType("type1").setId("1")).actionGet();
  logger.info("Gateway Snapshot");
  client("server1").admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Gateway Snapshot (should be a no op)");
  client("server1").admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Closing the server");
  closeNode("server1");
  logger.info("Starting the server, should recover from the gateway (only translog should be populated)");
  startNode("server1");
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client("server1").admin().cluster().health(clusterHealthRequest().setWaitForYellowStatus().setWaitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  clusterState=client("server1").admin().cluster().state(clusterStateRequest()).actionGet();
  assertThat(clusterState.getState().metaData().index("test").mapping("type1"),notNullValue());
  logger.info("Getting #1, should not exists");
  GetResponse getResponse=client("server1").get(getRequest("test").setType("type1").setId("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Flushing, so we have actual content in the index files (#2 should be in the index)");
  client("server1").admin().indices().flush(flushRequest("test")).actionGet();
  logger.info("Indexing #3, so we have something in the translog as well");
  client("server1").index(Requests.indexRequest("test").setType("type1").setId("3").setSource(source("3","test"))).actionGet();
  logger.info("Gateway Snapshot");
  client("server1").admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Gateway Snapshot (should be a no op)");
  client("server1").admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Closing the server");
  closeNode("server1");
  logger.info("Starting the server, should recover from the gateway (both index and translog) and reuse work dir");
  startNode("server1");
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client("server1").admin().cluster().health(clusterHealthRequest().setWaitForYellowStatus().setWaitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  logger.info("Getting #1, should not exists");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2 (not from the translog, but from the index)");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Getting #3 (from the translog)");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("3")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("3","test")));
  logger.info("Closing the server");
  closeNode("server1");
  logger.info("Clearing cluster data dir, so there will be a full recovery from the gateway");
  FileSystemUtils.deleteRecursively(environment.dataWithClusterFiles());
  logger.info("Starting the server, should recover from the gateway (both index and translog) without reusing work dir");
  startNode("server1");
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client("server1").admin().cluster().health(clusterHealthRequest().setWaitForYellowStatus().setWaitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  logger.info("Getting #1, should not exists");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2 (not from the translog, but from the index)");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Getting #3 (from the translog)");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("3")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("3","test")));
  logger.info("Flushing, so we have actual content in the index files (#3 should be in the index now as well)");
  client("server1").admin().indices().flush(flushRequest("test")).actionGet();
  logger.info("Gateway Snapshot");
  client("server1").admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Gateway Snapshot (should be a no op)");
  client("server1").admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Closing the server");
  closeNode("server1");
  logger.info("Starting the server, should recover from the gateway (just from the index, nothing in the translog)");
  startNode("server1");
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client("server1").admin().cluster().health(clusterHealthRequest().setWaitForYellowStatus().setWaitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  logger.info("Getting #1, should not exists");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2 (not from the translog, but from the index)");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Getting #3 (not from the translog, but from the index)");
  getResponse=client("server1").get(getRequest("test").setType("type1").setId("3")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("3","test")));
  logger.info("Deleting the index");
  client("server1").admin().indices().delete(deleteIndexRequest("test")).actionGet();
}
