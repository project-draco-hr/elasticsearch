{
  try {
    threadPool.executor(ThreadPool.Names.SEARCH).execute(new Runnable(){
      @Override public void run(){
        try {
          final InternalSearchResponse internalResponse=searchPhaseController.merge(sortedShardList,firstResults,fetchResults);
          String scrollId=null;
          if (request.scroll() != null) {
            scrollId=TransportSearchHelper.buildScrollId(request.searchType(),firstResults,null);
          }
          listener.onResponse(new SearchResponse(internalResponse,scrollId,expectedSuccessfulOps,successfulOps.get(),buildTookInMillis(),buildShardFailures()));
        }
 catch (        Throwable e) {
          ReduceSearchPhaseException failure=new ReduceSearchPhaseException("fetch","",e,buildShardFailures());
          if (logger.isDebugEnabled()) {
            logger.debug("failed to reduce search",failure);
          }
          listener.onFailure(failure);
        }
 finally {
          releaseIrrelevantSearchContexts(firstResults,docIdsToLoad);
        }
      }
    }
);
  }
 catch (  EsRejectedExecutionException ex) {
    try {
      releaseIrrelevantSearchContexts(firstResults,docIdsToLoad);
    }
  finally {
      listener.onFailure(ex);
    }
  }
}
