{
  try {
    client.admin().indices().prepareDelete("test1").execute().actionGet();
    client.admin().indices().prepareDelete("test2").execute().actionGet();
  }
 catch (  Exception e) {
  }
  client.admin().indices().prepareCreate("test1").execute().actionGet();
  client.admin().indices().prepareCreate("test2").execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test1","alias")).execute().actionGet();
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test1","alias10").routing("0")).execute().actionGet();
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test2","alias20").routing("0")).execute().actionGet();
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test2","alias21").routing("1")).execute().actionGet();
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test1","alias0").routing("0")).execute().actionGet();
  client.admin().indices().prepareAliases().addAliasAction(newAddAliasAction("test2","alias0").routing("0")).execute().actionGet();
  Thread.sleep(300);
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,"alias"),nullValue());
  assertThat(clusterService.state().metaData().resolveSearchRouting("0,1","alias"),equalTo(newMap("test1",newSet("0","1"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,"alias10"),equalTo(newMap("test1",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,"alias10"),equalTo(newMap("test1",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting("0","alias10"),equalTo(newMap("test1",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting("1","alias10"),nullValue());
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,"alias0"),equalTo(newMap("test1",newSet("0"),"test2",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,new String[]{"alias10","alias20"}),equalTo(newMap("test1",newSet("0"),"test2",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,new String[]{"alias10","alias21"}),equalTo(newMap("test1",newSet("0"),"test2",newSet("1"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,new String[]{"alias20","alias21"}),equalTo(newMap("test2",newSet("0","1"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,new String[]{"test1","alias10"}),nullValue());
  assertThat(clusterService.state().metaData().resolveSearchRouting(null,new String[]{"alias10","test1"}),nullValue());
  assertThat(clusterService.state().metaData().resolveSearchRouting("0",new String[]{"alias10","alias20"}),equalTo(newMap("test1",newSet("0"),"test2",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting("0,1",new String[]{"alias10","alias20"}),equalTo(newMap("test1",newSet("0"),"test2",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting("1",new String[]{"alias10","alias20"}),nullValue());
  assertThat(clusterService.state().metaData().resolveSearchRouting("0",new String[]{"alias10","alias21"}),equalTo(newMap("test1",newSet("0"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting("1",new String[]{"alias10","alias21"}),equalTo(newMap("test2",newSet("1"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting("0,1,2",new String[]{"alias10","alias21"}),equalTo(newMap("test1",newSet("0"),"test2",newSet("1"))));
  assertThat(clusterService.state().metaData().resolveSearchRouting("0,1,2",new String[]{"test1","alias10","alias21"}),equalTo(newMap("test1",newSet("0","1","2"),"test2",newSet("1"))));
}
