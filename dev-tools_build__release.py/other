import re
import tempfile
import shutil
import os
import datetime
import json
import time
import sys
import argparse
import hmac
import urllib
import fnmatch
import socket
import urllib.request
import subprocess
from http.client import HTTPConnection
from http.client import HTTPSConnection
" \n This tool builds a release from the a given elasticsearch branch.\n In order to execute it go in the top level directory and run:\n   $ python3 dev_tools/build_release.py --branch 0.90 --publish --remote origin\n\n By default this script runs in 'dry' mode which essentially simulates a release. If the\n '--publish' option is set the actual release is done. The script takes over almost all\n steps necessary for a release from a high level point of view it does the following things:\n\n  - run prerequisit checks ie. check for Java 1.7 being presend or S3 credentials available as env variables\n  - detect the version to release from the specified branch (--branch) or the current branch\n  - creates a release branch & updates pom.xml and Version.java to point to a release version rather than a snapshot\n  - builds the artifacts and runs smoke-tests on the build zip & tar.gz files\n  - commits the new version and merges the release branch into the source branch\n  - creates a tag and pushes the commit to the specified origin (--remote)\n  - publishes the releases to Sonatype and S3\n\nOnce it's done it will print all the remaining steps.\n\n Prerequisites:\n    - Python 3k for script execution\n    - Boto for S3 Upload ($ apt-get install python-boto)\n    - RPM for RPM building ($ apt-get install rpm)\n    - S3 keys exported via ENV Variables (AWS_ACCESS_KEY_ID,  AWS_SECRET_ACCESS_KEY)\n"
env = os.environ
PLUGINS = [('bigdesk', 'lukas-vlcek/bigdesk'), ('paramedic', 'karmi/elasticsearch-paramedic'), ('segmentspy', 'polyfractal/elasticsearch-segmentspy'), ('inquisitor', 'polyfractal/elasticsearch-inquisitor'), ('head', 'mobz/elasticsearch-head')]
LOG = env.get('ES_RELEASE_LOG', '/tmp/elasticsearch_release.log')
try:
    JAVA_HOME = env['JAVA_HOME']
except KeyError:
    raise RuntimeError("\n  Please set JAVA_HOME in the env before running release tool\n  On OSX use: export JAVA_HOME=`/usr/libexec/java_home -v '1.7*'`")
try:
    JAVA_HOME = env['JAVA7_HOME']
except KeyError:
    pass
try:
    subprocess.check_output('mvn3 --version', shell=True, stderr=subprocess.STDOUT)
    MVN = 'mvn3'
except subprocess.CalledProcessError:
    MVN = 'mvn'
verify_java_version('1.7')
verify_mvn_java_version('1.7', MVN)
VERSION_FILE = 'src/main/java/org/elasticsearch/Version.java'
POM_FILE = 'pom.xml'
print_sonatype_notice()
if (__name__ == '__main__'):
    parser = argparse.ArgumentParser(description='Builds and publishes a Elasticsearch Release')
    parser.add_argument('--branch', '-b', metavar='RELEASE_BRANCH', default=get_current_branch(), help='The branch to release from. Defaults to the current branch.')
    parser.add_argument('--cpus', '-c', metavar='1', default=1, help='The number of cpus to use for running the test. Default is [1]')
    parser.add_argument('--skiptests', '-t', dest='tests', action='store_false', help='Skips tests before release. Tests are run by default.')
    parser.set_defaults(tests=True)
    parser.add_argument('--remote', '-r', metavar='origin', default='origin', help='The remote to push the release commit and tag to. Default is [origin]')
    parser.add_argument('--publish', '-d', dest='dryrun', action='store_false', help='Publishes the release. Disable by default.')
    parser.add_argument('--smoke', '-s', dest='smoke', default='', help='Smoke tests the given release')
    parser.add_argument('--bwc', '-w', dest='bwc', metavar='backwards', default='backwards', help='Backwards compatibility version path to use to run compatibility tests against')
    parser.set_defaults(dryrun=True)
    parser.set_defaults(smoke=None)
    args = parser.parse_args()
    bwc_path = args.bwc
    src_branch = args.branch
    remote = args.remote
    run_tests = args.tests
    dry_run = args.dryrun
    cpus = args.cpus
    build = (not args.smoke)
    smoke_test_version = args.smoke
    if os.path.exists(LOG):
        raise RuntimeError(('please remove old release log %s first' % LOG))
    if (not dry_run):
        check_s3_credentials()
        print 'WARNING: dryrun is set to "false" - this will push and publish the release'
        input('Press Enter to continue...')
    print ''.join(['-' for _ in range(80)])
    print ('Preparing Release from branch [%s] running tests: [%s] dryrun: [%s]' % (src_branch, run_tests, dry_run))
    print ('  JAVA_HOME is [%s]' % JAVA_HOME)
    print ('  Running with maven command: [%s] ' % MVN)
    if build:
        ensure_checkout_is_clean(src_branch)
        verify_lucene_version()
        release_version = find_release_version(src_branch)
        ensure_no_open_tickets(release_version)
        if (not dry_run):
            smoke_test_version = release_version
        head_hash = get_head_hash()
        run_mvn('clean')
        print ('  Release version: [%s]' % release_version)
        create_release_branch(remote, src_branch, release_version)
        print ('  Created release branch [%s]' % release_branch(release_version))
        success = False
        try:
            pending_files = [POM_FILE, VERSION_FILE]
            remove_maven_snapshot(POM_FILE, release_version)
            remove_version_snapshot(VERSION_FILE, release_version)
            print '  Done removing snapshot version'
            add_pending_files(*pending_files)
            commit_release(release_version)
            pending_files = update_reference_docs(release_version)
            version_head_hash = None
            if pending_files:
                add_pending_files(*pending_files)
                commit_feature_flags(release_version)
                version_head_hash = get_head_hash()
            print ('  Committed release version [%s]' % release_version)
            print ''.join(['-' for _ in range(80)])
            print 'Building Release candidate'
            input('Press Enter to continue...')
            if (not dry_run):
                print ('  Running maven builds now and publish to Sonatype - run-tests [%s]' % run_tests)
            else:
                print ('  Running maven builds now run-tests [%s]' % run_tests)
            build_release(run_tests=run_tests, dry_run=dry_run, cpus=cpus, bwc_version=find_bwc_version(release_version, bwc_path))
            artifacts = get_artifacts(release_version)
            artifacts_and_checksum = generate_checksums(artifacts)
            smoke_test_release(release_version, artifacts, get_head_hash(), PLUGINS)
            print ''.join(['-' for _ in range(80)])
            print ('Finish Release -- dry_run: %s' % dry_run)
            input('Press Enter to continue...')
            print ('  merge release branch, tag and push to %s %s -- dry_run: %s' % (remote, src_branch, dry_run))
            merge_tag_push(remote, src_branch, release_version, dry_run)
            print ('  publish artifacts to S3 -- dry_run: %s' % dry_run)
            publish_artifacts(artifacts_and_checksum, dry_run=dry_run)
            cherry_pick_command = '.'
            if version_head_hash:
                cherry_pick_command = (" and cherry-pick the documentation changes: 'git cherry-pick %s' to the development branch" % version_head_hash)
            pending_msg = '\n      Release successful pending steps:\n        * create a new vX.Y.Z label on github for the next release, with label color #dddddd (https://github.com/elasticsearch/elasticsearch/labels)\n        * publish the maven artifacts on Sonatype: https://oss.sonatype.org/index.html\n           - here is a guide: http://central.sonatype.org/pages/releasing-the-deployment.html\n        * check if the release is there https://oss.sonatype.org/content/repositories/releases/org/elasticsearch/elasticsearch/%(version)s\n        * announce the release on the website / blog post\n        * tweet about the release\n        * announce the release in the google group/mailinglist\n        * Move to a Snapshot version to the current branch for the next point release%(cherry_pick)s\n      '
            print (pending_msg % {'version': release_version, 'cherry_pick': cherry_pick_command, })
            success = True
        finally:
            if (not success):
                run('git reset --hard HEAD')
                run(('git checkout %s' % src_branch))
            elif dry_run:
                run(('git reset --hard %s' % head_hash))
                run(('git tag -d v%s' % release_version))
            run(('git branch -D %s' % release_branch(release_version)))
    else:
        print ('Skipping build - smoketest only against version %s' % smoke_test_version)
        run_mvn('clean')
    if smoke_test_version:
        fetch(remote)
        download_and_verify(smoke_test_version, artifact_names(smoke_test_version), plugins=PLUGINS)
