import re
import tempfile
import shutil
import os
import datetime
import json
import time
import sys
import argparse
import hmac
import urllib
import fnmatch
import socket
from http.client import HTTPConnection
" \n This tool builds a release from the a given elasticsearch branch.\n In order to execute it go in the top level directory and run:\n   $ python3 dev_tools/build_release.py --branch 0.90 --publish --remote origin\n\n By default this script runs in 'dry' mode which essentially simulates a release. If the\n '--publish' option is set the actual release is done. The script takes over almost all\n steps necessary for a release from a high level point of view it does the following things:\n\n  - run prerequisit checks ie. check for Java 1.6 being presend or S3 credentials available as env variables\n  - detect the version to release from the specified branch (--branch) or the current branch\n  - creates a release branch & updates pom.xml and Version.java to point to a release version rather than a snapshot\n  - builds the artifacts and runs smoke-tests on the build zip & tar.gz files\n  - commits the new version and merges the release branch into the source branch\n  - creates a tag and pushes the commit to the specified origin (--remote)\n  - publishes the releases to sonar-type and S3\n\nOnce it's done it will print all the remaining steps.\n\n"
LOG = '/tmp/release.log'
env = os.environ
try:
    JAVA_HOME = env['JAVA_HOME']
except KeyError:
    raise RuntimeError("\n  Please set JAVA_HOME in the env before running release tool\n  On OSX use: export JAVA_HOME=`/usr/libexec/java_home -v '1.6*'`")
try:
    JAVA_HOME = env['JAVA6_HOME']
except KeyError:
    pass
try:
    MVN = 'mvn'
    run('mvn3 --version', quiet=True)
    MVN = 'mvn3'
except RuntimeError:
    pass
verify_java_version('1.6')
verify_mvn_java_version('1.6', MVN)
VERSION_FILE = 'src/main/java/org/elasticsearch/Version.java'
POM_FILE = 'pom.xml'
print_sonartype_notice()
if (__name__ == '__main__'):
    release_version = '090.7'
    parser = argparse.ArgumentParser(description='Builds and publishes a Elasticsearch Release')
    parser.add_argument('--branch', '-b', metavar='master', default=get_current_branch(), help='The branch to release from. Defaults to the current branch.')
    parser.add_argument('--cpus', '-c', metavar='1', default=1, help='The number of cpus to use for running the test. Default is [1]')
    parser.add_argument('--skiptests', '-t', dest='tests', action='store_false', help='Skips tests before release. Tests are run by default.')
    parser.set_defaults(tests=True)
    parser.add_argument('--remote', '-r', metavar='origin', default='origin', help='The remote to push the release commit and tag to. Default is [origin]')
    parser.add_argument('--publish', '-d', dest='dryrun', action='store_false', help='Publishes the release. Disable by default.')
    parser.set_defaults(dryrun=True)
    args = parser.parse_args()
    src_branch = args.branch
    remote = args.remote
    run_tests = args.tests
    dry_run = args.dryrun
    cpus = args.cpus
    if (not dry_run):
        check_s3_credentials()
        print 'WARNING: dryrun is set to "false" - this will push and publish the release'
        input('Press Enter to continue...')
    print ''.join(['-' for _ in range(80)])
    print ('Preparing Release from branch [%s] running tests: [%s] dryrun: [%s]' % (src_branch, run_tests, dry_run))
    print ('  JAVA_HOME is [%s]' % JAVA_HOME)
    print ('  Running with maven command: [%s] ' % MVN)
    release_version = find_release_version(src_branch)
    head_hash = get_head_hash()
    run_mvn('clean')
    print ('  Release version: [%s]' % release_version)
    create_release_branch(remote, src_branch, release_version)
    print ('  Created release branch [%s]' % release_branch(release_version))
    success = False
    try:
        pending_files = [POM_FILE, VERSION_FILE]
        remove_maven_snapshot(POM_FILE, release_version)
        remove_version_snapshot(VERSION_FILE, release_version)
        pending_files = (pending_files + update_reference_docs(release_version))
        print '  Done removing snapshot version'
        add_pending_files(*pending_files)
        commit_release(release_version)
        print ('  Committed release version [%s]' % release_version)
        print ''.join(['-' for _ in range(80)])
        print 'Building Release candidate'
        input('Press Enter to continue...')
        print ('  Running maven builds now and publish to sonartype- run-tests [%s]' % run_tests)
        build_release(run_tests=run_tests, dry_run=dry_run, cpus=cpus)
        artifacts = get_artifacts(release_version)
        artifacts_and_checksum = generate_checksums(artifacts)
        smoke_test_release(release_version, artifacts)
        print ''.join(['-' for _ in range(80)])
        print ('Finish Release -- dry_run: %s' % dry_run)
        input('Press Enter to continue...')
        print ('  merge release branch, tag and push to %s %s -- dry_run: %s' % (remote, src_branch, dry_run))
        merge_tag_push(remote, src_branch, release_version, dry_run)
        print ('  publish artifacts to S3 -- dry_run: %s' % dry_run)
        publish_artifacts(artifacts_and_checksum, dry_run=dry_run)
        pending_msg = "\n    Release successful pending steps: \n      * create a version tag on github for version 'v%(version)s'\n      * check if there are pending issues for this version (https://github.com/elasticsearch/elasticsearch/issues?labels=v%(version)s&page=1&state=open)\n      * publish the maven artifacts on sonartype: https://oss.sonatype.org/index.html\n         - here is a guide: https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide#SonatypeOSSMavenRepositoryUsageGuide-8a.ReleaseIt\n      * check if the release is there https://oss.sonatype.org/content/repositories/releases/org/elasticsearch/elasticsearch/%(version)s\n      * announce the release on the website / blog post\n      * tweet about the release\n    "
        print (pending_msg % {'version': release_version, })
        success = True
    finally:
        if (not success):
            run('git reset --hard HEAD')
            run(('git checkout %s' % src_branch))
        elif dry_run:
            run(('git reset --hard %s' % head_hash))
            run(('git tag -d v%s' % release_version))
        run(('git branch -D %s' % release_branch(release_version)))
