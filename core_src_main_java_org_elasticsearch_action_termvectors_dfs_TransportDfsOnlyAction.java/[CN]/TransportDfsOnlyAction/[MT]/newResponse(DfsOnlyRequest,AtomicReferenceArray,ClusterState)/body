{
  int successfulShards=0;
  int failedShards=0;
  List<ShardOperationFailedException> shardFailures=null;
  AtomicArray<DfsSearchResult> dfsResults=new AtomicArray<>(shardsResponses.length());
  for (int i=0; i < shardsResponses.length(); i++) {
    Object shardResponse=shardsResponses.get(i);
    if (shardResponse == null) {
    }
 else     if (shardResponse instanceof BroadcastShardOperationFailedException) {
      failedShards++;
      if (shardFailures == null) {
        shardFailures=new ArrayList<>();
      }
      shardFailures.add(new DefaultShardOperationFailedException((BroadcastShardOperationFailedException)shardResponse));
    }
 else {
      dfsResults.set(i,((ShardDfsOnlyResponse)shardResponse).getDfsSearchResult());
      successfulShards++;
    }
  }
  AggregatedDfs dfs=searchPhaseController.aggregateDfs(dfsResults);
  return new DfsOnlyResponse(dfs,shardsResponses.length(),successfulShards,failedShards,shardFailures,buildTookInMillis(request));
}
