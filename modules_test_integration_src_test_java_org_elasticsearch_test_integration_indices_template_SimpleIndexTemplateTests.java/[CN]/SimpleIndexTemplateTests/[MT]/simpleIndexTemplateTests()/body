{
  clean();
  client.admin().indices().preparePutTemplate("template_1").setTemplate("te*").setOrder(0).addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field1").field("type","string").field("store","yes").endObject().startObject("field2").field("type","string").field("store","yes").field("index","not_analyzed").endObject().endObject().endObject().endObject()).execute().actionGet();
  client.admin().indices().preparePutTemplate("template_2").setTemplate("test*").setOrder(1).addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("field2").field("type","string").field("store","no").endObject().endObject().endObject().endObject()).execute().actionGet();
  client.prepareIndex("test_index","type1","1").setSource("field1","value1","field2","value 2").setRefresh(true).execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch("test_index").setQuery(termQuery("field1","value1")).addField("field1").addField("field2").execute().actionGet();
  if (searchResponse.failedShards() > 0) {
    logger.warn("failed search " + Arrays.toString(searchResponse.shardFailures()));
  }
  assertThat(searchResponse.failedShards(),equalTo(0));
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  assertThat(searchResponse.hits().hits().length,equalTo(1));
  assertThat(searchResponse.hits().getAt(0).field("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.hits().getAt(0).field("field2"),nullValue());
  client.prepareIndex("text_index","type1","1").setSource("field1","value1","field2","value 2").setRefresh(true).execute().actionGet();
  searchResponse=client.prepareSearch("text_index").setQuery(termQuery("field1","value1")).addField("field1").addField("field2").execute().actionGet();
  if (searchResponse.failedShards() > 0) {
    logger.warn("failed search " + Arrays.toString(searchResponse.shardFailures()));
  }
  assertThat(searchResponse.failedShards(),equalTo(0));
  assertThat(searchResponse.hits().totalHits(),equalTo(1l));
  assertThat(searchResponse.hits().hits().length,equalTo(1));
  assertThat(searchResponse.hits().getAt(0).field("field1").value().toString(),equalTo("value1"));
  assertThat(searchResponse.hits().getAt(0).field("field2").value().toString(),equalTo("value 2"));
}
