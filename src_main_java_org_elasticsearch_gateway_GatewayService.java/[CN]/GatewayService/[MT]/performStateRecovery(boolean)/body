{
  final Gateway.GatewayStateRecoveredListener recoveryListener=new GatewayRecoveryListener(new CountDownLatch(1));
  if (!ignoreRecoverAfterTime && recoverAfterTime != null) {
    if (scheduledRecovery.compareAndSet(false,true)) {
      logger.debug("delaying initial state recovery for [{}]",recoverAfterTime);
      threadPool.schedule(recoverAfterTime,ThreadPool.Names.GENERIC,new Runnable(){
        @Override public void run(){
          if (recovered.compareAndSet(false,true)) {
            logger.trace("performing state recovery...");
            gateway.performStateRecovery(recoveryListener);
          }
        }
      }
);
    }
  }
 else {
    if (recovered.compareAndSet(false,true)) {
      logger.trace("performing state recovery...");
      gateway.performStateRecovery(recoveryListener);
    }
  }
}
