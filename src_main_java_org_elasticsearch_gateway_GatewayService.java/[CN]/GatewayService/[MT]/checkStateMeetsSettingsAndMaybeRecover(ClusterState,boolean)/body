{
  DiscoveryNodes nodes=state.nodes();
  if (state.blocks().hasGlobalBlock(discoveryService.getNoMasterBlock())) {
    logger.debug("not recovering from gateway, no master elected yet");
  }
 else   if (recoverAfterNodes != -1 && (nodes.masterAndDataNodes().size()) < recoverAfterNodes) {
    logger.debug("not recovering from gateway, nodes_size (data+master) [" + nodes.masterAndDataNodes().size() + "] < recover_after_nodes ["+ recoverAfterNodes+ "]");
  }
 else   if (recoverAfterDataNodes != -1 && nodes.dataNodes().size() < recoverAfterDataNodes) {
    logger.debug("not recovering from gateway, nodes_size (data) [" + nodes.dataNodes().size() + "] < recover_after_data_nodes ["+ recoverAfterDataNodes+ "]");
  }
 else   if (recoverAfterMasterNodes != -1 && nodes.masterNodes().size() < recoverAfterMasterNodes) {
    logger.debug("not recovering from gateway, nodes_size (master) [" + nodes.masterNodes().size() + "] < recover_after_master_nodes ["+ recoverAfterMasterNodes+ "]");
  }
 else {
    boolean enforceRecoverAfterTime;
    String reason;
    if (expectedNodes == -1 && expectedMasterNodes == -1 && expectedDataNodes == -1) {
      enforceRecoverAfterTime=true;
      reason="recover_after_time was set to [" + recoverAfterTime + "]";
    }
 else {
      enforceRecoverAfterTime=false;
      reason="";
      if (expectedNodes != -1 && (nodes.masterAndDataNodes().size() < expectedNodes)) {
        enforceRecoverAfterTime=true;
        reason="expecting [" + expectedNodes + "] nodes, but only have ["+ nodes.masterAndDataNodes().size()+ "]";
      }
 else       if (expectedDataNodes != -1 && (nodes.dataNodes().size() < expectedDataNodes)) {
        enforceRecoverAfterTime=true;
        reason="expecting [" + expectedDataNodes + "] data nodes, but only have ["+ nodes.dataNodes().size()+ "]";
      }
 else       if (expectedMasterNodes != -1 && (nodes.masterNodes().size() < expectedMasterNodes)) {
        enforceRecoverAfterTime=true;
        reason="expecting [" + expectedMasterNodes + "] master nodes, but only have ["+ nodes.masterNodes().size()+ "]";
      }
    }
    performStateRecovery(asyncRecovery,enforceRecoverAfterTime,reason);
  }
}
