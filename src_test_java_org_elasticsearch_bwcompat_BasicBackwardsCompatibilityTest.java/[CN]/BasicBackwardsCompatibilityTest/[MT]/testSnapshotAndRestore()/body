{
  logger.info("-->  creating repository");
  assertAcked(client().admin().cluster().preparePutRepository("test-repo").setType("fs").setSettings(ImmutableSettings.settingsBuilder().put("location",newTempDir(LifecycleScope.SUITE).getAbsolutePath()).put("compress",randomBoolean()).put("chunk_size",randomIntBetween(100,1000))));
  String[] indices=new String[randomIntBetween(1,5)];
  for (int i=0; i < indices.length; i++) {
    indices[i]="index_" + i;
    createIndex(indices[i]);
  }
  ensureYellow();
  logger.info("--> indexing some data");
  IndexRequestBuilder[] builders=new IndexRequestBuilder[randomIntBetween(10,200)];
  for (int i=0; i < builders.length; i++) {
    builders[i]=client().prepareIndex(RandomPicks.randomFrom(getRandom(),indices),"foo",Integer.toString(i)).setSource("{ \"foo\" : \"bar\" } ");
  }
  indexRandom(true,builders);
  assertThat(client().prepareCount(indices).get().getCount(),equalTo((long)builders.length));
  long[] counts=new long[indices.length];
  for (int i=0; i < indices.length; i++) {
    counts[i]=client().prepareCount(indices[i]).get().getCount();
  }
  logger.info("--> snapshot");
  CreateSnapshotResponse createSnapshotResponse=client().admin().cluster().prepareCreateSnapshot("test-repo","test-snap").setWaitForCompletion(true).setIndices("index_*").get();
  assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),greaterThan(0));
  assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),equalTo(createSnapshotResponse.getSnapshotInfo().totalShards()));
  assertThat(client().admin().cluster().prepareGetSnapshots("test-repo").setSnapshots("test-snap").get().getSnapshots().get(0).state(),equalTo(SnapshotState.SUCCESS));
  logger.info("--> delete some data");
  int howMany=randomIntBetween(1,builders.length);
  for (int i=0; i < howMany; i++) {
    IndexRequestBuilder indexRequestBuilder=RandomPicks.randomFrom(getRandom(),builders);
    IndexRequest request=indexRequestBuilder.request();
    client().prepareDelete(request.index(),request.type(),request.id()).get();
  }
  refresh();
  final long numDocs=client().prepareCount(indices).get().getCount();
  assertThat(client().prepareCount(indices).get().getCount(),lessThan((long)builders.length));
  client().admin().indices().prepareUpdateSettings(indices).setSettings(ImmutableSettings.builder().put(EnableAllocationDecider.INDEX_ROUTING_ALLOCATION_ENABLE,"none")).get();
  backwardsCluster().allowOnAllNodes(indices);
  logClusterState();
  boolean upgraded;
  do {
    logClusterState();
    CountResponse countResponse=client().prepareCount().get();
    assertHitCount(countResponse,numDocs);
    upgraded=backwardsCluster().upgradeOneNode();
    ensureYellow();
    countResponse=client().prepareCount().get();
    assertHitCount(countResponse,numDocs);
  }
 while (upgraded);
  client().admin().indices().prepareUpdateSettings(indices).setSettings(ImmutableSettings.builder().put(EnableAllocationDecider.INDEX_ROUTING_ALLOCATION_ENABLE,"all")).get();
  logger.info("--> close indices");
  client().admin().indices().prepareClose(indices).get();
  logger.info("--> restore all indices from the snapshot");
  RestoreSnapshotResponse restoreSnapshotResponse=client().admin().cluster().prepareRestoreSnapshot("test-repo","test-snap").setWaitForCompletion(true).execute().actionGet();
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),greaterThan(0));
  ensureYellow();
  assertThat(client().prepareCount(indices).get().getCount(),equalTo((long)builders.length));
  for (int i=0; i < indices.length; i++) {
    assertThat(counts[i],equalTo(client().prepareCount(indices[i]).get().getCount()));
  }
  logger.info("--> delete indices");
  String index=RandomPicks.randomFrom(getRandom(),indices);
  cluster().wipeIndices(index);
  logger.info("--> restore one index after deletion");
  restoreSnapshotResponse=client().admin().cluster().prepareRestoreSnapshot("test-repo","test-snap").setWaitForCompletion(true).setIndices(index).execute().actionGet();
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),greaterThan(0));
  ensureYellow();
  assertThat(client().prepareCount(indices).get().getCount(),equalTo((long)builders.length));
  for (int i=0; i < indices.length; i++) {
    assertThat(counts[i],equalTo(client().prepareCount(indices[i]).get().getCount()));
  }
}
