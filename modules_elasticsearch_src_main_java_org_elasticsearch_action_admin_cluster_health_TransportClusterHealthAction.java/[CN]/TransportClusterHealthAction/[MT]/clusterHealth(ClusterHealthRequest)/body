{
  ClusterState clusterState=clusterService.state();
  RoutingTableValidation validation=clusterState.routingTable().validate(clusterState.metaData());
  ClusterHealthResponse response=new ClusterHealthResponse(clusterName.value(),validation.failures());
  response.numberOfNodes=clusterState.nodes().size();
  request.indices(clusterState.metaData().concreteIndices(request.indices()));
  for (  String index : request.indices()) {
    IndexRoutingTable indexRoutingTable=clusterState.routingTable().index(index);
    IndexMetaData indexMetaData=clusterState.metaData().index(index);
    if (indexRoutingTable == null) {
      continue;
    }
    ClusterIndexHealth indexHealth=new ClusterIndexHealth(index,indexMetaData.numberOfShards(),indexMetaData.numberOfReplicas(),validation.indexFailures(indexMetaData.index()));
    for (    IndexShardRoutingTable shardRoutingTable : indexRoutingTable) {
      ClusterShardHealth shardHealth=new ClusterShardHealth(shardRoutingTable.shardId().id());
      for (      ShardRouting shardRouting : shardRoutingTable) {
        if (shardRouting.active()) {
          shardHealth.activeShards++;
          if (shardRouting.relocating()) {
            shardHealth.relocatingShards++;
          }
          if (shardRouting.primary()) {
            shardHealth.primaryActive=true;
          }
        }
      }
      if (shardHealth.primaryActive) {
        if (shardHealth.activeShards == shardRoutingTable.size()) {
          shardHealth.status=ClusterHealthStatus.GREEN;
        }
 else {
          shardHealth.status=ClusterHealthStatus.YELLOW;
        }
      }
 else {
        shardHealth.status=ClusterHealthStatus.RED;
      }
      indexHealth.shards.put(shardHealth.id(),shardHealth);
    }
    for (    ClusterShardHealth shardHealth : indexHealth) {
      if (shardHealth.primaryActive()) {
        indexHealth.activePrimaryShards++;
      }
      indexHealth.activeShards+=shardHealth.activeShards;
      indexHealth.relocatingShards+=shardHealth.relocatingShards;
    }
    indexHealth.status=ClusterHealthStatus.GREEN;
    if (!indexHealth.validationFailures().isEmpty()) {
      indexHealth.status=ClusterHealthStatus.RED;
    }
 else {
      for (      ClusterShardHealth shardHealth : indexHealth) {
        if (shardHealth.status() == ClusterHealthStatus.RED) {
          indexHealth.status=ClusterHealthStatus.RED;
          break;
        }
        if (shardHealth.status() == ClusterHealthStatus.YELLOW) {
          indexHealth.status=ClusterHealthStatus.YELLOW;
        }
      }
    }
    response.indices.put(indexHealth.index(),indexHealth);
  }
  for (  ClusterIndexHealth indexHealth : response) {
    response.activePrimaryShards+=indexHealth.activePrimaryShards;
    response.activeShards+=indexHealth.activeShards;
    response.relocatingShards+=indexHealth.relocatingShards;
  }
  response.status=ClusterHealthStatus.GREEN;
  if (!response.validationFailures().isEmpty()) {
    response.status=ClusterHealthStatus.RED;
  }
 else {
    for (    ClusterIndexHealth indexHealth : response) {
      if (indexHealth.status() == ClusterHealthStatus.RED) {
        response.status=ClusterHealthStatus.RED;
        break;
      }
      if (indexHealth.status() == ClusterHealthStatus.YELLOW) {
        response.status=ClusterHealthStatus.YELLOW;
      }
    }
  }
  return response;
}
