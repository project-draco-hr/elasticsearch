{
  this.request=request;
  this.listener=listener;
  ClusterState clusterState=clusterService.state();
  nodes=clusterState.nodes();
  String[] concreteIndices=clusterState.metaData().concreteIndices(request.indices());
  for (  String index : concreteIndices) {
    clusterState.blocks().indexBlockedRaiseException(ClusterBlockLevel.READ,index);
  }
  shardsIts=clusterService.operationRouting().searchShards(clusterState,concreteIndices,request.queryHint(),request.routing(),request.preference());
  expectedSuccessfulOps=shardsIts.size();
  expectedTotalOps=shardsIts.totalSizeActiveWith1ForEmpty();
  if (expectedSuccessfulOps == 0) {
    throw new SearchPhaseExecutionException("initial","No indices / shards to search on, requested indices are " + Arrays.toString(request.indices()),buildShardFailures());
  }
}
