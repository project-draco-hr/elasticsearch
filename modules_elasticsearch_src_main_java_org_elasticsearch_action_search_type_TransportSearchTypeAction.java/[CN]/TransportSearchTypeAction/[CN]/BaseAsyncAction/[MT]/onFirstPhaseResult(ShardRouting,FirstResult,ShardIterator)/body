{
  result.shardTarget(new SearchShardTarget(shard.currentNodeId(),shard.index(),shard.id()));
  processFirstPhaseResult(shard,result);
  while (shardIt.hasNextActive()) {
    totalOps.incrementAndGet();
    shardIt.nextActive();
  }
  if (successulOps.incrementAndGet() == expectedSuccessfulOps || totalOps.incrementAndGet() == expectedTotalOps) {
    try {
      moveToSecondPhase();
    }
 catch (    Exception e) {
      if (logger.isDebugEnabled()) {
        if (shard != null) {
          logger.debug(shard.shortSummary() + ": Failed to execute [" + request+ "] while moving to second phase",e);
        }
 else {
          logger.debug(shardIt.shardId() + ": Failed to execute [" + request+ "] while moving to second phase",e);
        }
      }
      invokeListener(new ReduceSearchPhaseException(firstPhaseName(),"",e,buildShardFailures()));
    }
  }
}
