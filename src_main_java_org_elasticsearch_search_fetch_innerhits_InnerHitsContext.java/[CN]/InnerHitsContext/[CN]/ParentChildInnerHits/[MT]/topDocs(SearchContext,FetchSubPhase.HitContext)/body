{
  final String term;
  final String field;
  if (documentMapper.parentFieldMapper().active()) {
    field=ParentFieldMapper.NAME;
    term=Uid.createUid(hitContext.hit().type(),hitContext.hit().id());
  }
 else {
    field=UidFieldMapper.NAME;
    SearchHitField parentField=hitContext.hit().field(ParentFieldMapper.NAME);
    if (parentField != null) {
      term=parentField.getValue();
    }
 else {
      SingleFieldsVisitor fieldsVisitor=new SingleFieldsVisitor(ParentFieldMapper.NAME);
      hitContext.reader().document(hitContext.docId(),fieldsVisitor);
      if (fieldsVisitor.fields().isEmpty()) {
        return Lucene.EMPTY_TOP_DOCS;
      }
      term=(String)fieldsVisitor.fields().get(ParentFieldMapper.NAME).get(0);
    }
  }
  Filter filter=new TermFilter(new Term(field,term));
  Filter typeFilter=documentMapper.typeFilter();
  if (size() == 0) {
    TotalHitCountCollector collector=new TotalHitCountCollector();
    context.searcher().search(new FilteredQuery(query,new AndFilter(Arrays.asList(filter,typeFilter))),collector);
    return new TopDocs(collector.getTotalHits(),Lucene.EMPTY_SCORE_DOCS,0);
  }
 else {
    int topN=from() + size();
    TopDocsCollector topDocsCollector;
    if (sort() != null) {
      topDocsCollector=TopFieldCollector.create(sort(),topN,true,trackScores(),trackScores());
    }
 else {
      topDocsCollector=TopScoreDocCollector.create(topN);
    }
    context.searcher().search(new FilteredQuery(query,new AndFilter(Arrays.asList(filter,typeFilter))),topDocsCollector);
    return topDocsCollector.topDocs(from(),size());
  }
}
