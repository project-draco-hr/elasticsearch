{
  long sizeInBytes=MemorySizeValue.parseBytesSizeValueOrHeapRatio(size).bytes();
  if (sizeInBytes > ByteSizeValue.MAX_GUAVA_CACHE_SIZE.bytes()) {
    logger.warn("reducing requested query cache size of [{}] to the maximum allowed size of [{}]",new ByteSizeValue(sizeInBytes),ByteSizeValue.MAX_GUAVA_CACHE_SIZE);
    sizeInBytes=ByteSizeValue.MAX_GUAVA_CACHE_SIZE.bytes();
  }
  CacheBuilder<Key,BytesReference> cacheBuilder=CacheBuilder.newBuilder().maximumWeight(sizeInBytes).weigher(new QueryCacheWeigher()).removalListener(this);
  cacheBuilder.concurrencyLevel(16);
  if (expire != null) {
    cacheBuilder.expireAfterAccess(expire.millis(),TimeUnit.MILLISECONDS);
  }
  cache=cacheBuilder.build();
}
