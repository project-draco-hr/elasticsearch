{
  client().admin().indices().prepareCreate("test").execute().actionGet();
  ensureGreen();
  int numLevels=randomIntBetween(1,25);
  long numQueriesPerLevel=randomIntBetween(10,250);
  long totalQueries=numLevels * numQueriesPerLevel;
  logger.info("--> register " + totalQueries + " queries");
  for (int level=1; level <= numLevels; level++) {
    for (int query=1; query <= numQueriesPerLevel; query++) {
      client().prepareIndex("my-index","_percolator",level + "-" + query).setSource(jsonBuilder().startObject().field("query",matchAllQuery()).field("level",level).endObject()).execute().actionGet();
    }
  }
  boolean onlyCount=randomBoolean();
  PercolateResponse response=client().preparePercolate().setIndices("my-index").setDocumentType("my-type").setOnlyCount(onlyCount).setPercolateDoc(docBuilder().setDoc("field","value")).execute().actionGet();
  assertNoFailures(response);
  assertThat(response.getCount(),equalTo(totalQueries));
  if (!onlyCount) {
    assertThat(response.getMatches().length,equalTo((int)totalQueries));
  }
  int size=randomIntBetween(0,(int)totalQueries - 1);
  response=client().preparePercolate().setIndices("my-index").setDocumentType("my-type").setOnlyCount(onlyCount).setPercolateDoc(docBuilder().setDoc("field","value")).setSize(size).execute().actionGet();
  assertNoFailures(response);
  assertThat(response.getCount(),equalTo(totalQueries));
  if (!onlyCount) {
    assertThat(response.getMatches().length,equalTo(size));
  }
  client().admin().indices().prepareRefresh("my-index").execute().actionGet();
  int runs=randomIntBetween(3,16);
  for (int i=0; i < runs; i++) {
    onlyCount=randomBoolean();
    response=client().preparePercolate().setIndices("my-index").setDocumentType("my-type").setOnlyCount(onlyCount).setPercolateDoc(docBuilder().setDoc("field","value")).setPercolateQuery(termQuery("level",1 + randomInt(numLevels - 1))).execute().actionGet();
    assertNoFailures(response);
    assertThat(response.getCount(),equalTo(numQueriesPerLevel));
    if (!onlyCount) {
      assertThat(response.getMatches().length,equalTo((int)numQueriesPerLevel));
    }
  }
  for (int i=0; i < runs; i++) {
    onlyCount=randomBoolean();
    response=client().preparePercolate().setIndices("my-index").setDocumentType("my-type").setOnlyCount(onlyCount).setPercolateDoc(docBuilder().setDoc("field","value")).setPercolateFilter(termFilter("level",1 + randomInt(numLevels - 1))).execute().actionGet();
    assertNoFailures(response);
    assertThat(response.getCount(),equalTo(numQueriesPerLevel));
    if (!onlyCount) {
      assertThat(response.getMatches().length,equalTo((int)numQueriesPerLevel));
    }
  }
  for (int i=0; i < runs; i++) {
    onlyCount=randomBoolean();
    size=randomIntBetween(0,(int)numQueriesPerLevel - 1);
    response=client().preparePercolate().setIndices("my-index").setDocumentType("my-type").setOnlyCount(onlyCount).setSize(size).setPercolateDoc(docBuilder().setDoc("field","value")).setPercolateFilter(termFilter("level",1 + randomInt(numLevels - 1))).execute().actionGet();
    assertNoFailures(response);
    assertThat(response.getCount(),equalTo(numQueriesPerLevel));
    if (!onlyCount) {
      assertThat(response.getMatches().length,equalTo(size));
    }
  }
}
