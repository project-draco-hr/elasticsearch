{
  try (ReleasableLock lock=mappingWriteLock.acquire()){
    mapperService.checkMappersCompatibility(type,mapping,updateAllTypes);
    Mapping merged=this.mapping.merge(mapping,updateAllTypes);
    if (simulate == false) {
      this.mapping=merged;
      Collection<ObjectMapper> objectMappers=new ArrayList<>();
      Collection<FieldMapper> fieldMappers=new ArrayList<>(Arrays.asList(merged.metadataMappers));
      MapperUtils.collect(merged.root,objectMappers,fieldMappers);
      addMappers(objectMappers,fieldMappers,updateAllTypes);
      refreshSource();
    }
  }
 }
