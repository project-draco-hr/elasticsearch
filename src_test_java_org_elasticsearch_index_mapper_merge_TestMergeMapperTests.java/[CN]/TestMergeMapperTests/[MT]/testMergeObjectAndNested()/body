{
  DocumentMapperParser parser=createIndex("test").mapperService().documentMapperParser();
  String objectMapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("obj").field("type","object").endObject().endObject().endObject().endObject().string();
  DocumentMapper objectMapper=parser.parse(objectMapping);
  String nestedMapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("obj").field("type","nested").endObject().endObject().endObject().endObject().string();
  DocumentMapper nestedMapper=parser.parse(nestedMapping);
  DocumentMapper.MergeResult mergeResult=objectMapper.merge(nestedMapper.mapping(),mergeFlags().simulate(true));
  assertThat(mergeResult.hasConflicts(),equalTo(true));
  assertThat(mergeResult.conflicts().length,equalTo(1));
  assertThat(mergeResult.conflicts()[0],equalTo("object mapping [obj] can't be changed from non-nested to nested"));
  mergeResult=nestedMapper.merge(objectMapper.mapping(),mergeFlags().simulate(true));
  assertThat(mergeResult.conflicts().length,equalTo(1));
  assertThat(mergeResult.conflicts()[0],equalTo("object mapping [obj] can't be changed from nested to non-nested"));
}
