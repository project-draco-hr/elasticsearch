{
  client().admin().indices().prepareDelete().execute().actionGet();
  Builder builder=ImmutableSettings.builder();
  builder.put("index.analysis.analyzer.reverse.tokenizer","standard");
  builder.putArray("index.analysis.analyzer.reverse.filter","lowercase","reverse");
  builder.put("index.analysis.analyzer.body.tokenizer","standard");
  builder.putArray("index.analysis.analyzer.body.filter","lowercase");
  builder.put("index.analysis.analyzer.bigram.tokenizer","standard");
  builder.putArray("index.analysis.analyzer.bigram.filter","my_shingle","lowercase");
  builder.put("index.analysis.filter.my_shingle.type","shingle");
  builder.put("index.analysis.filter.my_shingle.output_unigrams",false);
  builder.put("index.analysis.filter.my_shingle.min_shingle_size",2);
  builder.put("index.analysis.filter.my_shingle.max_shingle_size",2);
  XContentBuilder mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("_all").field("store","yes").field("termVector","with_positions_offsets").endObject().startObject("properties").startObject("body").field("type","string").field("analyzer","body").endObject().startObject("body_reverse").field("type","string").field("analyzer","reverse").endObject().startObject("bigram").field("type","string").field("analyzer","bigram").endObject().endObject().endObject().endObject();
  client().admin().indices().prepareCreate("test").setSettings(builder.build()).addMapping("type1",mapping).execute().actionGet();
  client().admin().cluster().prepareHealth("test").setWaitForGreenStatus().execute().actionGet();
  BufferedReader reader=new BufferedReader(new InputStreamReader(SuggestSearchTests.class.getResourceAsStream("/config/names.txt"),Streams.UTF8));
  String line=null;
  while ((line=reader.readLine()) != null) {
    client().prepareIndex("test","type1").setSource(XContentFactory.jsonBuilder().startObject().field("body",line).field("body_reverse",line).field("bigram",line).endObject()).execute().actionGet();
  }
  client().admin().indices().prepareRefresh().execute().actionGet();
  Suggest searchSuggest=searchSuggest(client(),"american ame",phraseSuggestion("simple_phrase").field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("american ame"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("american ace"));
  searchSuggest=searchSuggest(client(),"Xor the Got-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"Xorr the God-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).maxErrors(0.5f).confidence(0.f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xorr the God-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"Xorr the God-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).maxErrors(0.5f).confidence(2.f));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(0));
  searchSuggest=searchSuggest(client(),"Xorr the God-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).maxErrors(0.5f).confidence(0.99f));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xorr the God-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"xor the yod-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body_reverse").minWordLength(1).suggestMode("always").preFilter("reverse").postFilter("reverse")).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("xor the yod-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"Xor the Got-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(1,0,0)).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(0));
  searchSuggest=searchSuggest(client(),"Xor the Got-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(0,1,0)).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"Xor the Got-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(0.4,0.4,0.2)).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"american ame",phraseSuggestion("simple_phrase").field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(0.4,0.4,0.2)).size(1));
  ;
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("american ame"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("american ace"));
  searchSuggest=searchSuggest(client(),"Xor the Got-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(0.4,0.4,0.2)).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"Xor the Got-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.Laplace(0.2)).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
  searchSuggest=searchSuggest(client(),"Xor the Got-Jewel",phraseSuggestion("simple_phrase").realWordErrorLikelihood(0.95f).field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(PhraseSuggestionBuilder.candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.StupidBackoff(0.1)).maxErrors(0.5f).size(1));
  assertThat(searchSuggest,notNullValue());
  assertThat(searchSuggest.size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getName(),equalTo("simple_phrase"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().size(),equalTo(1));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel"));
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getText().string(),equalTo("xorr the god jewel"));
}
