{
  Thread current=Thread.currentThread();
  for (; ; ) {
    long s=getState();
    if ((s & 1L) == 0L || getExclusiveOwnerThread() == current) {
      releaseShared(1L);
      return s;
    }
    if (!tryAcquireSharedNanos(1L,nanos))     throw new TimeoutException();
    nanos=1L;
  }
}
