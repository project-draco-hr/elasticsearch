{
  logger.trace("[{}] writing state, reason [{}]",indexMetaData.index(),reason);
  final boolean deleteOldFiles=previousIndexMetaData != null && previousIndexMetaData.version() != indexMetaData.version();
  final MetaDataStateFormat<IndexMetaData> writer=indexStateFormat(format,formatParams,deleteOldFiles);
  try {
    writer.write(indexMetaData,INDEX_STATE_FILE_PREFIX,indexMetaData.version(),nodeEnv.indexPaths(new Index(indexMetaData.index()),indexMetaData.settings()));
  }
 catch (  Throwable ex) {
    logger.warn("[{}]: failed to write index state",ex,indexMetaData.index());
    throw new IOException("failed to write state for [" + indexMetaData.index() + "]",ex);
  }
}
