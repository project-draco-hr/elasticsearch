{
  final ClusterState state=event.state();
  if (state.blocks().disableStatePersistence()) {
    this.currentMetaData=null;
    return;
  }
  MetaData newMetaData=state.metaData();
  boolean success=true;
  if (state.nodes().localNode().masterNode()) {
    if (currentMetaData == null || !MetaData.isGlobalStateEquals(currentMetaData,newMetaData)) {
      try {
        metaStateService.writeGlobalState("changed",newMetaData);
      }
 catch (      Throwable e) {
        success=false;
      }
    }
    for (    IndexMetaData indexMetaData : newMetaData) {
      String writeReason=null;
      IndexMetaData currentIndexMetaData;
      if (currentMetaData == null) {
        try {
          currentIndexMetaData=metaStateService.loadIndexState(indexMetaData.index());
        }
 catch (        IOException ex) {
          throw new ElasticsearchException("failed to load index state",ex);
        }
      }
 else {
        currentIndexMetaData=currentMetaData.index(indexMetaData.index());
      }
      if (currentIndexMetaData == null) {
        writeReason="freshly created";
      }
 else       if (currentIndexMetaData.version() != indexMetaData.version()) {
        writeReason="version changed from [" + currentIndexMetaData.version() + "] to ["+ indexMetaData.version()+ "]";
      }
      if (writeReason == null) {
        continue;
      }
      try {
        metaStateService.writeIndex(writeReason,indexMetaData,currentIndexMetaData);
      }
 catch (      Throwable e) {
        success=false;
      }
    }
  }
  danglingIndicesState.processDanglingIndices(newMetaData);
  if (success) {
    currentMetaData=newMetaData;
  }
}
