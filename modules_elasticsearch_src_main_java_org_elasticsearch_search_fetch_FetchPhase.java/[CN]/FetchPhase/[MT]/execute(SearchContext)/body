{
  ResetFieldSelector fieldSelector;
  List<String> extractFieldNames=null;
  if (context.hasScriptFields() && !context.hasFieldNames()) {
    fieldSelector=UidFieldSelector.INSTANCE;
  }
 else   if (!context.hasFieldNames()) {
    fieldSelector=new UidAndSourceFieldSelector();
  }
 else   if (context.fieldNames().isEmpty()) {
    fieldSelector=UidFieldSelector.INSTANCE;
  }
 else   if (context.fieldNames().get(0).equals("*")) {
    fieldSelector=AllButSourceFieldSelector.INSTANCE;
  }
 else {
    FieldMappersFieldSelector fieldSelectorMapper=new FieldMappersFieldSelector();
    for (    String fieldName : context.fieldNames()) {
      FieldMappers x=context.smartNameFieldMappers(fieldName);
      if (x != null && x.mapper().stored()) {
        fieldSelectorMapper.add(x);
      }
 else {
        if (extractFieldNames == null) {
          extractFieldNames=Lists.newArrayList();
        }
        extractFieldNames.add(fieldName);
      }
    }
    fieldSelectorMapper.add(UidFieldMapper.NAME);
    fieldSelector=fieldSelectorMapper;
  }
  InternalSearchHit[] hits=new InternalSearchHit[context.docIdsToLoadSize()];
  for (int index=0; index < context.docIdsToLoadSize(); index++) {
    int docId=context.docIdsToLoad()[context.docIdsToLoadFrom() + index];
    Document doc=loadDocument(context,fieldSelector,docId);
    Uid uid=extractUid(context,doc);
    DocumentMapper documentMapper=context.mapperService().documentMapper(uid.type());
    if (documentMapper == null) {
      throw new TypeMissingException(new Index(context.shardTarget().index()),uid.type(),"failed to find type loaded for doc [" + uid.id() + "]");
    }
    byte[] source=extractSource(doc,documentMapper);
    InternalSearchHit searchHit=new InternalSearchHit(docId,uid.id(),uid.type(),source,null);
    hits[index]=searchHit;
    for (    Object oField : doc.getFields()) {
      Fieldable field=(Fieldable)oField;
      String name=field.name();
      if (name.equals(UidFieldMapper.NAME)) {
        continue;
      }
      if (name.equals(SourceFieldMapper.NAME)) {
        continue;
      }
      Object value=null;
      FieldMappers fieldMappers=documentMapper.mappers().indexName(field.name());
      if (fieldMappers != null) {
        FieldMapper mapper=fieldMappers.mapper();
        if (mapper != null) {
          name=mapper.names().fullName();
          value=mapper.valueForSearch(field);
        }
      }
      if (value == null) {
        if (field.isBinary()) {
          value=field.getBinaryValue();
        }
 else {
          value=field.stringValue();
        }
      }
      if (searchHit.fieldsOrNull() == null) {
        searchHit.fields(new HashMap<String,SearchHitField>(2));
      }
      SearchHitField hitField=searchHit.fields().get(name);
      if (hitField == null) {
        hitField=new InternalSearchHitField(name,new ArrayList<Object>(2));
        searchHit.fields().put(name,hitField);
      }
      hitField.values().add(value);
    }
    int readerIndex=context.searcher().readerIndex(docId);
    IndexReader subReader=context.searcher().subReaders()[readerIndex];
    int subDoc=docId - context.searcher().docStarts()[readerIndex];
    context.lookup().setNextReader(subReader);
    context.lookup().setNextDocId(docId);
    if (extractFieldNames != null) {
      for (      String extractFieldName : extractFieldNames) {
        Object value=context.lookup().source().extractValue(extractFieldName);
        if (value != null) {
          if (searchHit.fieldsOrNull() == null) {
            searchHit.fields(new HashMap<String,SearchHitField>(2));
          }
          SearchHitField hitField=searchHit.fields().get(extractFieldName);
          if (hitField == null) {
            hitField=new InternalSearchHitField(extractFieldName,new ArrayList<Object>(2));
            searchHit.fields().put(extractFieldName,hitField);
          }
          hitField.values().add(value);
        }
      }
    }
    for (    SearchHitPhase hitPhase : hitPhases) {
      SearchHitPhase.HitContext hitContext=new SearchHitPhase.HitContext();
      if (hitPhase.executionNeeded(context)) {
        hitContext.reset(searchHit,subReader,subDoc,doc);
        hitPhase.execute(context,hitContext);
      }
    }
  }
  context.fetchResult().hits(new InternalSearchHits(hits,context.queryResult().topDocs().totalHits,context.queryResult().topDocs().getMaxScore()));
}
