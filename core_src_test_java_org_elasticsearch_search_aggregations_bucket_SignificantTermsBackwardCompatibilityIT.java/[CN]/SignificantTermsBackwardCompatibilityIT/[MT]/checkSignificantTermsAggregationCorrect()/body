{
  SearchResponse response=client().prepareSearch(INDEX_NAME).setTypes(DOC_TYPE).addAggregation(new TermsBuilder("class").field(CLASS_FIELD).subAggregation(new SignificantTermsBuilder("sig_terms").field(TEXT_FIELD))).execute().actionGet();
  assertSearchResponse(response);
  StringTerms classes=(StringTerms)response.getAggregations().get("class");
  assertThat(classes.getBuckets().size(),equalTo(2));
  for (  Terms.Bucket classBucket : classes.getBuckets()) {
    Map<String,Aggregation> aggs=classBucket.getAggregations().asMap();
    assertTrue(aggs.containsKey("sig_terms"));
    SignificantTerms agg=(SignificantTerms)aggs.get("sig_terms");
    assertThat(agg.getBuckets().size(),equalTo(1));
    String term=agg.iterator().next().getKeyAsString();
    String classTerm=classBucket.getKeyAsString();
    assertTrue(term.equals(classTerm));
  }
}
