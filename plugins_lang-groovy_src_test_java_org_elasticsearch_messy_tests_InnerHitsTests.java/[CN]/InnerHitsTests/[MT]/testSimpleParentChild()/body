{
  assertAcked(prepareCreate("articles").addMapping("article","title","type=string").addMapping("comment","_parent","type=article","message","type=string"));
  List<IndexRequestBuilder> requests=new ArrayList<>();
  requests.add(client().prepareIndex("articles","article","1").setSource("title","quick brown fox"));
  requests.add(client().prepareIndex("articles","comment","1").setParent("1").setSource("message","fox eat quick"));
  requests.add(client().prepareIndex("articles","comment","2").setParent("1").setSource("message","fox ate rabbit x y z"));
  requests.add(client().prepareIndex("articles","comment","3").setParent("1").setSource("message","rabbit got away"));
  requests.add(client().prepareIndex("articles","article","2").setSource("title","big gray elephant"));
  requests.add(client().prepareIndex("articles","comment","4").setParent("2").setSource("message","elephant captured"));
  requests.add(client().prepareIndex("articles","comment","5").setParent("2").setSource("message","mice squashed by elephant x"));
  requests.add(client().prepareIndex("articles","comment","6").setParent("2").setSource("message","elephant scared by mice x y"));
  indexRandom(true,requests);
  InnerHitsBuilder innerHitsBuilder=new InnerHitsBuilder();
  innerHitsBuilder.addParentChildInnerHits("comment","comment",new InnerHitsBuilder.InnerHit().setQuery(matchQuery("message","fox")));
  SearchRequest[] searchRequests=new SearchRequest[]{client().prepareSearch("articles").setQuery(hasChildQuery("comment",matchQuery("message","fox"))).innerHits(innerHitsBuilder).request(),client().prepareSearch("articles").setQuery(hasChildQuery("comment",matchQuery("message","fox")).innerHit(new QueryInnerHits("comment",null))).request()};
  for (  SearchRequest searchRequest : searchRequests) {
    SearchResponse response=client().search(searchRequest).actionGet();
    assertNoFailures(response);
    assertHitCount(response,1);
    assertSearchHit(response,1,hasId("1"));
    assertThat(response.getHits().getAt(0).getShard(),notNullValue());
    assertThat(response.getHits().getAt(0).getInnerHits().size(),equalTo(1));
    SearchHits innerHits=response.getHits().getAt(0).getInnerHits().get("comment");
    assertThat(innerHits.totalHits(),equalTo(2l));
    assertThat(innerHits.getAt(0).getId(),equalTo("1"));
    assertThat(innerHits.getAt(0).type(),equalTo("comment"));
    assertThat(innerHits.getAt(1).getId(),equalTo("2"));
    assertThat(innerHits.getAt(1).type(),equalTo("comment"));
  }
  innerHitsBuilder=new InnerHitsBuilder();
  innerHitsBuilder.addParentChildInnerHits("comment","comment",new InnerHitsBuilder.InnerHit().setQuery(matchQuery("message","elephant")));
  searchRequests=new SearchRequest[]{client().prepareSearch("articles").setQuery(hasChildQuery("comment",matchQuery("message","elephant"))).innerHits(innerHitsBuilder).request(),client().prepareSearch("articles").setQuery(hasChildQuery("comment",matchQuery("message","elephant")).innerHit(new QueryInnerHits())).request()};
  for (  SearchRequest searchRequest : searchRequests) {
    SearchResponse response=client().search(searchRequest).actionGet();
    assertNoFailures(response);
    assertHitCount(response,1);
    assertSearchHit(response,1,hasId("2"));
    assertThat(response.getHits().getAt(0).getInnerHits().size(),equalTo(1));
    SearchHits innerHits=response.getHits().getAt(0).getInnerHits().get("comment");
    assertThat(innerHits.totalHits(),equalTo(3l));
    assertThat(innerHits.getAt(0).getId(),equalTo("4"));
    assertThat(innerHits.getAt(0).type(),equalTo("comment"));
    assertThat(innerHits.getAt(1).getId(),equalTo("5"));
    assertThat(innerHits.getAt(1).type(),equalTo("comment"));
    assertThat(innerHits.getAt(2).getId(),equalTo("6"));
    assertThat(innerHits.getAt(2).type(),equalTo("comment"));
  }
  InnerHitsBuilder.InnerHit innerHit=new InnerHitsBuilder.InnerHit();
  innerHit.highlighter(new HighlightBuilder().field("message"));
  innerHit.setExplain(true);
  innerHit.addFieldDataField("message");
  innerHit.addScriptField("script",new Script("doc['message'].value"));
  innerHit.setSize(1);
  innerHitsBuilder=new InnerHitsBuilder();
  innerHitsBuilder.addParentChildInnerHits("comment","comment",new InnerHitsBuilder.InnerHit().setQuery(matchQuery("message","fox")).highlighter(new HighlightBuilder().field("message")).setExplain(true).addFieldDataField("message").addScriptField("script",new Script("doc['message'].value")).setSize(1));
  searchRequests=new SearchRequest[]{client().prepareSearch("articles").setQuery(hasChildQuery("comment",matchQuery("message","fox"))).innerHits(innerHitsBuilder).request(),client().prepareSearch("articles").setQuery(hasChildQuery("comment",matchQuery("message","fox")).innerHit(new QueryInnerHits(null,innerHit))).request()};
  for (  SearchRequest searchRequest : searchRequests) {
    SearchResponse response=client().search(searchRequest).actionGet();
    assertNoFailures(response);
    SearchHits innerHits=response.getHits().getAt(0).getInnerHits().get("comment");
    assertThat(innerHits.getHits().length,equalTo(1));
    assertThat(innerHits.getAt(0).getHighlightFields().get("message").getFragments()[0].string(),equalTo("<em>fox</em> eat quick"));
    assertThat(innerHits.getAt(0).explanation().toString(),containsString("weight(message:fox"));
    assertThat(innerHits.getAt(0).getFields().get("message").getValue().toString(),equalTo("eat"));
    assertThat(innerHits.getAt(0).getFields().get("script").getValue().toString(),equalTo("eat"));
  }
}
