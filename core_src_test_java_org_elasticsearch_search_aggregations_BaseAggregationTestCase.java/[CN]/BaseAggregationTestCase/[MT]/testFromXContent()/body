{
  AF testAgg=createTestAggregatorFactory();
  AggregatorFactories factories=AggregatorFactories.builder().addAggregator(testAgg).build();
  String contentString=factories.toString();
  XContentParser parser=XContentFactory.xContent(contentString).createParser(contentString);
  assertSame(XContentParser.Token.START_OBJECT,parser.nextToken());
  assertSame(XContentParser.Token.FIELD_NAME,parser.nextToken());
  assertEquals(testAgg.name,parser.currentName());
  assertSame(XContentParser.Token.START_OBJECT,parser.nextToken());
  assertSame(XContentParser.Token.FIELD_NAME,parser.nextToken());
  assertEquals(testAgg.type,parser.currentName());
  assertSame(XContentParser.Token.START_OBJECT,parser.nextToken());
  AggregatorFactory newAgg=aggParsers.parser(testAgg.getWriteableName()).parse(testAgg.name,parser,SearchContext.current());
  assertSame(XContentParser.Token.END_OBJECT,parser.currentToken());
  assertSame(XContentParser.Token.END_OBJECT,parser.nextToken());
  assertSame(XContentParser.Token.END_OBJECT,parser.nextToken());
  assertNull(parser.nextToken());
  assertNotNull(newAgg);
  assertNotSame(newAgg,testAgg);
  assertEquals(testAgg,newAgg);
  assertEquals(testAgg.hashCode(),newAgg.hashCode());
}
