{
  AB testAgg=createTestAggregatorBuilder();
  try (BytesStreamOutput output=new BytesStreamOutput()){
    testAgg.writeTo(output);
    try (StreamInput in=new NamedWriteableAwareStreamInput(StreamInput.wrap(output.bytes()),namedWriteableRegistry)){
      AggregatorBuilder prototype=(AggregatorBuilder)namedWriteableRegistry.getPrototype(AggregatorBuilder.class,testAgg.getWriteableName());
      AggregatorBuilder deserializedQuery=prototype.readFrom(in);
      assertEquals(deserializedQuery,testAgg);
      assertEquals(deserializedQuery.hashCode(),testAgg.hashCode());
      assertNotSame(deserializedQuery,testAgg);
    }
   }
 }
