{
  try (BytesStreamOutput output=new BytesStreamOutput()){
    agg.writeTo(output);
    try (StreamInput in=new NamedWriteableAwareStreamInput(StreamInput.wrap(output.bytes()),namedWriteableRegistry)){
      AggregatorFactory prototype=(AggregatorFactory)namedWriteableRegistry.getPrototype(AggregatorFactory.class,agg.getWriteableName());
      @SuppressWarnings("unchecked") AF secondAgg=(AF)prototype.readFrom(in);
      return secondAgg;
    }
   }
 }
