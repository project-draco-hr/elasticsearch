{
  Integer numShard=randomFrom(1,2,4,8,16);
  int numberOfReplicas=randomIntBetween(0,10);
  IndexMetaData metaData=IndexMetaData.builder("foo").settings(Settings.builder().put("index.version.created",1).put("index.number_of_shards",numShard).put("index.number_of_replicas",numberOfReplicas).build()).creationDate(randomLong()).primaryTerm(0,2).setRoutingNumShards(32).build();
  final XContentBuilder builder=JsonXContent.contentBuilder();
  builder.startObject();
  metaData.toXContent(builder,ToXContent.EMPTY_PARAMS);
  builder.endObject();
  XContentParser parser=XContentType.JSON.xContent().createParser(builder.bytes());
  final IndexMetaData fromXContentMeta=IndexMetaData.PROTO.fromXContent(parser,null);
  assertEquals(metaData,fromXContentMeta);
  assertEquals(metaData.hashCode(),fromXContentMeta.hashCode());
  assertEquals(metaData.getNumberOfReplicas(),fromXContentMeta.getNumberOfReplicas());
  assertEquals(metaData.getNumberOfShards(),fromXContentMeta.getNumberOfShards());
  assertEquals(metaData.getCreationVersion(),fromXContentMeta.getCreationVersion());
  assertEquals(metaData.getRoutingNumShards(),fromXContentMeta.getRoutingNumShards());
  assertEquals(metaData.getCreationDate(),fromXContentMeta.getCreationDate());
  assertEquals(metaData.getRoutingFactor(),fromXContentMeta.getRoutingFactor());
  assertEquals(metaData.primaryTerm(0),fromXContentMeta.primaryTerm(0));
  final BytesStreamOutput out=new BytesStreamOutput();
  metaData.writeTo(out);
  IndexMetaData deserialized=IndexMetaData.PROTO.readFrom(out.bytes().streamInput());
  assertEquals(metaData,deserialized);
  assertEquals(metaData.hashCode(),deserialized.hashCode());
  assertEquals(metaData.getNumberOfReplicas(),deserialized.getNumberOfReplicas());
  assertEquals(metaData.getNumberOfShards(),deserialized.getNumberOfShards());
  assertEquals(metaData.getCreationVersion(),deserialized.getCreationVersion());
  assertEquals(metaData.getRoutingNumShards(),deserialized.getRoutingNumShards());
  assertEquals(metaData.getCreationDate(),deserialized.getCreationDate());
  assertEquals(metaData.getRoutingFactor(),deserialized.getRoutingFactor());
  assertEquals(metaData.primaryTerm(0),deserialized.primaryTerm(0));
}
