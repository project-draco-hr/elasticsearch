{
  CompletableFuture<?> fst, snd;
  int mid=(lo + hi) >>> 1;
  if ((fst=(lo == mid ? cfs[lo] : allTree(cfs,lo,mid))) == null || (snd=(hi == mid + 1 ? cfs[hi] : allTree(cfs,mid + 1,hi))) == null)   throw new NullPointerException();
  CompletableFuture<Void> dst=new CompletableFuture<Void>();
  AndCompletion d=null;
  CompletionNode p=null, q=null;
  Object r=null, s=null;
  while ((r=fst.result) == null || (s=snd.result) == null) {
    if (d == null)     d=new AndCompletion(fst,snd,dst);
 else     if (p == null)     p=new CompletionNode(d);
 else     if (q == null) {
      if (UNSAFE.compareAndSwapObject(fst,COMPLETIONS,p.next=fst.completions,p))       q=new CompletionNode(d);
    }
 else     if (UNSAFE.compareAndSwapObject(snd,COMPLETIONS,q.next=snd.completions,q))     break;
  }
  if ((r != null || (r=fst.result) != null) && (s != null || (s=snd.result) != null) && (d == null || d.compareAndSet(0,1))) {
    Throwable ex;
    if (r instanceof AltResult)     ex=((AltResult)r).ex;
 else     ex=null;
    if (ex == null && (s instanceof AltResult))     ex=((AltResult)s).ex;
    dst.internalComplete(null,ex);
  }
  fst.helpPostComplete();
  snd.helpPostComplete();
  return dst;
}
