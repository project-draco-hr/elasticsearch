{
  WaitNode q=null;
  boolean queued=false;
  int spins=SPINS;
  for (Object r; ; ) {
    if ((r=result) != null) {
      if (q != null) {
        q.thread=null;
        if (q.interruptControl < 0) {
          if (interruptible) {
            removeWaiter(q);
            return null;
          }
          Thread.currentThread().interrupt();
        }
      }
      postComplete();
      return r;
    }
 else     if (spins > 0) {
      int rnd=ThreadLocalRandom.current().nextInt();
      if (rnd >= 0)       --spins;
    }
 else     if (q == null)     q=new WaitNode(interruptible,0L,0L);
 else     if (!queued)     queued=UNSAFE.compareAndSwapObject(this,WAITERS,q.next=waiters,q);
 else     if (interruptible && q.interruptControl < 0) {
      removeWaiter(q);
      return null;
    }
 else     if (q.thread != null && result == null) {
      try {
        ForkJoinPool.managedBlock(q);
      }
 catch (      InterruptedException ex) {
        q.interruptControl=-1;
      }
    }
  }
}
