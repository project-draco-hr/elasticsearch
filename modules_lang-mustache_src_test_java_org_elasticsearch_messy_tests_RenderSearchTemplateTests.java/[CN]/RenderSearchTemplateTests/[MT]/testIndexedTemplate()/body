{
  Map<String,Object> params=new HashMap<>();
  params.put("value","bar");
  params.put("size",20);
  SearchTemplateResponse response=prepareRenderSearchTemplate("index_template_1",ScriptType.STORED,params).get();
  assertThat(response,notNullValue());
  assertFalse(response.hasResponse());
  BytesReference source=response.getSource();
  assertThat(source,notNullValue());
  Map<String,Object> sourceAsMap=XContentHelper.convertToMap(source,false).v2();
  assertThat(sourceAsMap,notNullValue());
  String expected=TEMPLATE_CONTENTS.replace("{{value}}","bar").replace("{{size}}","20");
  Map<String,Object> expectedMap=XContentHelper.convertToMap(new BytesArray(expected),false).v2();
  assertThat(sourceAsMap,equalTo(expectedMap));
  params=new HashMap<>();
  params.put("value","baz");
  params.put("size",100);
  response=prepareRenderSearchTemplate("index_template_1",ScriptType.STORED,params).get();
  assertThat(response,notNullValue());
  source=response.getSource();
  assertThat(source,notNullValue());
  sourceAsMap=XContentHelper.convertToMap(source,false).v2();
  expected=TEMPLATE_CONTENTS.replace("{{value}}","baz").replace("{{size}}","100");
  expectedMap=XContentHelper.convertToMap(new BytesArray(expected),false).v2();
  assertThat(sourceAsMap,equalTo(expectedMap));
}
