{
  BulkRequest bulkRequest=new BulkRequest(mainRequest);
  ExecutableScript executableScript=null;
  Map<String,Object> scriptCtx=null;
  for (  SearchHit doc : docs) {
    IndexRequest index=buildIndexRequest(doc);
    copyMetadata(index,doc);
    if (script != null) {
      if (executableScript == null) {
        executableScript=scriptService.executable(script,mainRequest.getScript().getParams());
        scriptCtx=new HashMap<>();
      }
      if (false == applyScript(index,doc,executableScript,scriptCtx)) {
        continue;
      }
    }
    bulkRequest.add(index);
  }
  return bulkRequest;
}
