{
  List<Object> aggregationObjects=new ArrayList<>();
  for (  InternalAggregation aggregation : reduceContext.aggregations()) {
    InternalScriptedMetric mapReduceAggregation=(InternalScriptedMetric)aggregation;
    aggregationObjects.add(mapReduceAggregation.aggregation());
  }
  InternalScriptedMetric firstAggregation=((InternalScriptedMetric)reduceContext.aggregations().get(0));
  Object aggregation;
  if (firstAggregation.reduceScript != null) {
    Map<String,Object> params;
    if (firstAggregation.reduceParams != null) {
      params=new HashMap<>(firstAggregation.reduceParams);
    }
 else {
      params=new HashMap<>();
    }
    params.put("_aggs",aggregationObjects);
    ExecutableScript script=reduceContext.scriptService().executable(firstAggregation.scriptLang,firstAggregation.reduceScript,firstAggregation.scriptType,params);
    aggregation=script.run();
  }
 else {
    aggregation=aggregationObjects;
  }
  return new InternalScriptedMetric(firstAggregation.getName(),aggregation,firstAggregation.scriptLang,firstAggregation.scriptType,firstAggregation.reduceScript,firstAggregation.reduceParams,getMetaData());
}
