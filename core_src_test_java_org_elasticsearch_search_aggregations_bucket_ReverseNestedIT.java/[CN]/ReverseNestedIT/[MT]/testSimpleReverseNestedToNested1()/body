{
  SearchResponse response=client().prepareSearch("idx").setTypes("type2").addAggregation(nested("nested1").path("nested1.nested2").subAggregation(terms("field2").field("nested1.nested2.field2").order(Terms.Order.term(true)).collectMode(randomFrom(SubAggCollectionMode.values())).size(0).subAggregation(reverseNested("nested1_to_field1").path("nested1").subAggregation(terms("field1").field("nested1.field1").order(Terms.Order.term(true)).collectMode(randomFrom(SubAggCollectionMode.values())))))).get();
  assertSearchResponse(response);
  Nested nested=response.getAggregations().get("nested1");
  assertThat(nested,notNullValue());
  assertThat(nested.getName(),equalTo("nested1"));
  assertThat(nested.getDocCount(),equalTo(27L));
  assertThat(nested.getAggregations().asList().isEmpty(),is(false));
  Terms usernames=nested.getAggregations().get("field2");
  assertThat(usernames,notNullValue());
  assertThat(usernames.getBuckets().size(),equalTo(5));
  List<Terms.Bucket> usernameBuckets=new ArrayList<>(usernames.getBuckets());
  Terms.Bucket bucket=usernameBuckets.get(0);
  assertThat(bucket.getKeyAsString(),equalTo("0"));
  assertThat(bucket.getDocCount(),equalTo(12L));
  ReverseNested reverseNested=bucket.getAggregations().get("nested1_to_field1");
  assertThat(reverseNested.getDocCount(),equalTo(5L));
  Terms tags=reverseNested.getAggregations().get("field1");
  List<Terms.Bucket> tagsBuckets=new ArrayList<>(tags.getBuckets());
  assertThat(tagsBuckets.size(),equalTo(2));
  assertThat(tagsBuckets.get(0).getKeyAsString(),equalTo("a"));
  assertThat(tagsBuckets.get(0).getDocCount(),equalTo(3L));
  assertThat(tagsBuckets.get(1).getKeyAsString(),equalTo("b"));
  assertThat(tagsBuckets.get(1).getDocCount(),equalTo(2L));
  bucket=usernameBuckets.get(1);
  assertThat(bucket.getKeyAsString(),equalTo("1"));
  assertThat(bucket.getDocCount(),equalTo(6L));
  reverseNested=bucket.getAggregations().get("nested1_to_field1");
  assertThat(reverseNested.getDocCount(),equalTo(4L));
  tags=reverseNested.getAggregations().get("field1");
  tagsBuckets=new ArrayList<>(tags.getBuckets());
  assertThat(tagsBuckets.size(),equalTo(4));
  assertThat(tagsBuckets.get(0).getKeyAsString(),equalTo("a"));
  assertThat(tagsBuckets.get(0).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(1).getKeyAsString(),equalTo("b"));
  assertThat(tagsBuckets.get(1).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(2).getKeyAsString(),equalTo("c"));
  assertThat(tagsBuckets.get(2).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(3).getKeyAsString(),equalTo("e"));
  assertThat(tagsBuckets.get(3).getDocCount(),equalTo(1L));
  bucket=usernameBuckets.get(2);
  assertThat(bucket.getKeyAsString(),equalTo("2"));
  assertThat(bucket.getDocCount(),equalTo(5L));
  reverseNested=bucket.getAggregations().get("nested1_to_field1");
  assertThat(reverseNested.getDocCount(),equalTo(4L));
  tags=reverseNested.getAggregations().get("field1");
  tagsBuckets=new ArrayList<>(tags.getBuckets());
  assertThat(tagsBuckets.size(),equalTo(4));
  assertThat(tagsBuckets.get(0).getKeyAsString(),equalTo("a"));
  assertThat(tagsBuckets.get(0).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(1).getKeyAsString(),equalTo("b"));
  assertThat(tagsBuckets.get(1).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(2).getKeyAsString(),equalTo("c"));
  assertThat(tagsBuckets.get(2).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(3).getKeyAsString(),equalTo("e"));
  assertThat(tagsBuckets.get(3).getDocCount(),equalTo(1L));
  bucket=usernameBuckets.get(3);
  assertThat(bucket.getKeyAsString(),equalTo("3"));
  assertThat(bucket.getDocCount(),equalTo(2L));
  reverseNested=bucket.getAggregations().get("nested1_to_field1");
  assertThat(reverseNested.getDocCount(),equalTo(2L));
  tags=reverseNested.getAggregations().get("field1");
  tagsBuckets=new ArrayList<>(tags.getBuckets());
  assertThat(tagsBuckets.size(),equalTo(2));
  assertThat(tagsBuckets.get(0).getKeyAsString(),equalTo("d"));
  assertThat(tagsBuckets.get(0).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(1).getKeyAsString(),equalTo("f"));
  bucket=usernameBuckets.get(4);
  assertThat(bucket.getKeyAsString(),equalTo("4"));
  assertThat(bucket.getDocCount(),equalTo(2L));
  reverseNested=bucket.getAggregations().get("nested1_to_field1");
  assertThat(reverseNested.getDocCount(),equalTo(2L));
  tags=reverseNested.getAggregations().get("field1");
  tagsBuckets=new ArrayList<>(tags.getBuckets());
  assertThat(tagsBuckets.size(),equalTo(2));
  assertThat(tagsBuckets.get(0).getKeyAsString(),equalTo("d"));
  assertThat(tagsBuckets.get(0).getDocCount(),equalTo(1L));
  assertThat(tagsBuckets.get(1).getKeyAsString(),equalTo("f"));
}
