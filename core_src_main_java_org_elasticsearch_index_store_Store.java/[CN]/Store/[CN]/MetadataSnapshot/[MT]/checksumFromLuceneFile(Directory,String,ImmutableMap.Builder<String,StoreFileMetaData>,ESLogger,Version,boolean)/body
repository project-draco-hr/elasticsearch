{
  final String checksum;
  final BytesRefBuilder fileHash=new BytesRefBuilder();
  try (final IndexInput in=directory.openInput(file,IOContext.READONCE)){
    final long length;
    try {
      length=in.length();
      if (length < CodecUtil.footerLength()) {
        throw new CorruptIndexException("Can't retrieve checksum from file: " + file + " file length must be >= "+ CodecUtil.footerLength()+ " but was: "+ in.length(),in);
      }
      if (readFileAsHash) {
        final VerifyingIndexInput verifyingIndexInput=new VerifyingIndexInput(in);
        hashFile(fileHash,new InputStreamIndexInput(verifyingIndexInput,length),length);
        checksum=digestToString(verifyingIndexInput.verify());
      }
 else {
        checksum=digestToString(CodecUtil.retrieveChecksum(in));
      }
    }
 catch (    Throwable ex) {
      logger.debug("Can retrieve checksum from file [{}]",ex,file);
      throw ex;
    }
    builder.put(file,new StoreFileMetaData(file,length,checksum,version,fileHash.get()));
  }
 }
