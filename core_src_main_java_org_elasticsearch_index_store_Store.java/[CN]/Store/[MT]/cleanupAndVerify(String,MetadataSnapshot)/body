{
  metadataLock.writeLock().lock();
  try (Lock writeLock=directory.obtainLock(IndexWriter.WRITE_LOCK_NAME)){
    final StoreDirectory dir=directory;
    for (    String existingFile : dir.listAll()) {
      if (Store.isAutogenerated(existingFile) || sourceMetaData.contains(existingFile)) {
        continue;
      }
      try {
        dir.deleteFile(reason,existingFile);
      }
 catch (      IOException ex) {
        if (existingFile.startsWith(IndexFileNames.SEGMENTS) || existingFile.equals(IndexFileNames.OLD_SEGMENTS_GEN)) {
          throw new IllegalStateException("Can't delete " + existingFile + " - cleanup failed",ex);
        }
        logger.debug(new ParameterizedMessage("failed to delete file [{}]",existingFile),ex);
      }
    }
    final Store.MetadataSnapshot metadataOrEmpty=getMetadata(null);
    verifyAfterCleanup(sourceMetaData,metadataOrEmpty);
  }
  finally {
    metadataLock.writeLock().unlock();
  }
}
