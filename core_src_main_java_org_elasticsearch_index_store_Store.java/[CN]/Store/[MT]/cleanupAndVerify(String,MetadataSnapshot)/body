{
  metadataLock.writeLock().lock();
  try (Lock writeLock=Lucene.acquireWriteLock(directory)){
    final StoreDirectory dir=directory;
    for (    String existingFile : dir.listAll()) {
      if (Store.isAutogenerated(existingFile) || sourceMetaData.contains(existingFile)) {
        continue;
      }
      try {
        dir.deleteFile(reason,existingFile);
      }
 catch (      IOException ex) {
        if (existingFile.startsWith(IndexFileNames.SEGMENTS) || existingFile.equals(IndexFileNames.OLD_SEGMENTS_GEN)) {
          throw new IllegalStateException("Can't delete " + existingFile + " - cleanup failed",ex);
        }
        logger.debug("failed to delete file [{}]",ex,existingFile);
      }
    }
    final Store.MetadataSnapshot metadataOrEmpty=getMetadata();
    verifyAfterCleanup(sourceMetaData,metadataOrEmpty);
  }
  finally {
    metadataLock.writeLock().unlock();
  }
}
