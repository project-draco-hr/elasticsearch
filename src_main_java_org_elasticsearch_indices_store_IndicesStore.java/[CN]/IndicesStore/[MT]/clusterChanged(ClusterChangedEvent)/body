{
  if (!event.routingTableChanged()) {
    return;
  }
  if (event.state().blocks().disableStatePersistence()) {
    return;
  }
  for (  IndexRoutingTable indexRoutingTable : event.state().routingTable()) {
    for (    IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {
      if (shardCanBeDeleted(event.state(),indexShardRoutingTable)) {
        ShardId shardId=indexShardRoutingTable.shardId();
        IndexService indexService=indicesService.indexService(shardId.getIndex());
        if (indexService == null) {
          if (nodeEnv.hasNodeFile()) {
            Path[] shardLocations=nodeEnv.shardPaths(shardId,ImmutableSettings.EMPTY);
            if (FileSystemUtils.exists(shardLocations)) {
              deleteShardIfExistElseWhere(event.state(),indexShardRoutingTable);
            }
          }
        }
 else {
          if (!indexService.hasShard(shardId.id())) {
            if (indexService.store().canDeleteUnallocated(shardId,indexService.settingsService().getSettings())) {
              deleteShardIfExistElseWhere(event.state(),indexShardRoutingTable);
            }
          }
        }
      }
    }
  }
}
