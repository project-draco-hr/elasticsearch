{
  Map<String,List<ShardId>> waitingIndicesMap=new HashMap<>();
  for (  ImmutableMap.Entry<ShardId,ShardSnapshotStatus> entry : shards.entrySet()) {
    if (entry.getValue().state() == State.WAITING) {
      List<ShardId> waitingShards=waitingIndicesMap.get(entry.getKey().getIndex());
      if (waitingShards == null) {
        waitingShards=new ArrayList<>();
        waitingIndicesMap.put(entry.getKey().getIndex(),waitingShards);
      }
      waitingShards.add(entry.getKey());
    }
  }
  if (!waitingIndicesMap.isEmpty()) {
    ImmutableMap.Builder<String,List<ShardId>> waitingIndicesBuilder=ImmutableMap.builder();
    for (    Map.Entry<String,List<ShardId>> entry : waitingIndicesMap.entrySet()) {
      waitingIndicesBuilder.put(entry.getKey(),Collections.unmodifiableList(entry.getValue()));
    }
    return waitingIndicesBuilder.build();
  }
 else {
    return ImmutableMap.of();
  }
}
