{
  Directory dir=new RAMDirectory();
  IndexWriter indexWriter=new IndexWriter(dir,Lucene.STANDARD_ANALYZER,true,IndexWriter.MaxFieldLength.UNLIMITED);
  IndexReader reader=indexWriter.getReader();
  List<IndexReader> readers=Lists.newArrayList();
  for (int i=0; i < 100; i++) {
    readers.add(reader);
    indexWriter.addDocument(doc().add(field("id",Integer.toString(i))).boost(i).build());
    reader=refreshReader(reader);
  }
  reader.close();
  IdentityHashMap<IndexReader,Boolean> identityReaders=new IdentityHashMap<IndexReader,Boolean>();
  for (  IndexReader reader1 : readers) {
    assertThat(reader1.getRefCount(),equalTo(0));
    assertThat(identityReaders.containsKey(reader1),equalTo(false));
    identityReaders.put(reader1,Boolean.TRUE);
    if (reader1.getSequentialSubReaders() != null) {
      for (      IndexReader reader2 : reader1.getSequentialSubReaders()) {
        assertThat(reader2.getRefCount(),equalTo(0));
        assertThat(reader2.getSequentialSubReaders(),nullValue());
        assertThat(identityReaders.containsKey(reader2),equalTo(false));
        identityReaders.put(reader2,Boolean.TRUE);
      }
    }
  }
  indexWriter.close();
}
