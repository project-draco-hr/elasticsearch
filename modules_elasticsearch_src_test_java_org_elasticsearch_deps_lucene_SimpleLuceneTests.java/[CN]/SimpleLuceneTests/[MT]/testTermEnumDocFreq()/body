{
  Directory dir=new RAMDirectory();
  IndexWriter indexWriter=new IndexWriter(dir,Lucene.STANDARD_ANALYZER,true,IndexWriter.MaxFieldLength.UNLIMITED);
  IndexReader reader=indexWriter.getReader();
  Document doc=new Document();
  doc.add(new Field("id","1",Field.Store.NO,Field.Index.ANALYZED));
  doc.add(new Field("value","aaa",Field.Store.NO,Field.Index.ANALYZED));
  indexWriter.addDocument(doc);
  reader=refreshReader(reader);
  TermEnum termEnum=reader.terms(new Term("value",""));
  assertThat(termEnum.term().text(),equalTo("aaa"));
  assertThat(termEnum.docFreq(),equalTo(1));
  termEnum.close();
  doc=new Document();
  doc.add(new Field("id","2",Field.Store.NO,Field.Index.ANALYZED));
  doc.add(new Field("value","bbb bbb",Field.Store.NO,Field.Index.ANALYZED));
  indexWriter.addDocument(doc);
  reader=refreshReader(reader);
  termEnum=reader.terms(new Term("value",""));
  assertThat(termEnum.term().text(),equalTo("aaa"));
  assertThat(termEnum.docFreq(),equalTo(1));
  termEnum.next();
  assertThat(termEnum.term().text(),equalTo("bbb"));
  assertThat(termEnum.docFreq(),equalTo(1));
  termEnum.close();
  doc=new Document();
  doc.add(new Field("id","3",Field.Store.NO,Field.Index.ANALYZED));
  doc.add(new Field("value","bbb",Field.Store.NO,Field.Index.ANALYZED));
  indexWriter.addDocument(doc);
  reader=refreshReader(reader);
  termEnum=reader.terms(new Term("value",""));
  assertThat(termEnum.term().text(),equalTo("aaa"));
  assertThat(termEnum.docFreq(),equalTo(1));
  termEnum.next();
  assertThat(termEnum.term().text(),equalTo("bbb"));
  assertThat(termEnum.docFreq(),equalTo(2));
  termEnum.close();
  indexWriter.deleteDocuments(new Term("id","3"));
  reader=refreshReader(reader);
  termEnum=reader.terms(new Term("value",""));
  assertThat(termEnum.term().text(),equalTo("aaa"));
  assertThat(termEnum.docFreq(),equalTo(1));
  termEnum.next();
  assertThat(termEnum.term().text(),equalTo("bbb"));
  assertThat(termEnum.docFreq(),equalTo(2));
  termEnum.close();
  indexWriter.expungeDeletes();
  reader=refreshReader(reader);
  termEnum=reader.terms(new Term("value",""));
  assertThat(termEnum.term().text(),equalTo("aaa"));
  assertThat(termEnum.docFreq(),equalTo(1));
  termEnum.next();
  assertThat(termEnum.term().text(),equalTo("bbb"));
  assertThat(termEnum.docFreq(),equalTo(1));
  termEnum.close();
  reader.close();
  indexWriter.close();
}
