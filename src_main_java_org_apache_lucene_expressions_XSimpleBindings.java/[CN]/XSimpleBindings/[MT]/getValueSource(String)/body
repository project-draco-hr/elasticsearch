{
  Object o=map.get(name);
  if (o == null) {
    throw new IllegalArgumentException("Invalid reference '" + name + "'");
  }
 else   if (o instanceof Expression) {
    return ((Expression)o).getValueSource(this);
  }
 else   if (o instanceof ValueSource) {
    return ((ValueSource)o);
  }
  SortField field=(SortField)o;
switch (field.getType()) {
case INT:
    return new IntFieldSource(field.getField());
case LONG:
  return new LongFieldSource(field.getField());
case FLOAT:
return new FloatFieldSource(field.getField());
case DOUBLE:
return new DoubleFieldSource(field.getField());
case SCORE:
return getScoreValueSource();
default :
throw new UnsupportedOperationException();
}
}
