{
  IOException lastEx=null;
  for (int i=0; i < 3; i++) {
    try {
      is=connection.getInputStream();
      break;
    }
 catch (    IOException ex) {
      lastEx=ex;
    }
  }
  if (is == null) {
    throw new IOException("Can't get " + source + " to "+ dest,lastEx);
  }
  os=Files.newOutputStream(dest);
  progress.beginDownload();
  boolean finished=false;
  try {
    byte[] buffer=new byte[1024 * 100];
    int length;
    while (!isInterrupted() && (length=is.read(buffer)) >= 0) {
      os.write(buffer,0,length);
      progress.onTick();
    }
    finished=!isInterrupted();
  }
  finally {
    if (!finished) {
      IOUtils.closeWhileHandlingException(os,is);
      IOUtils.deleteFilesIgnoringExceptions(dest);
    }
 else {
      IOUtils.close(os,is);
    }
  }
  progress.endDownload();
  return true;
}
