{
  ElasticsearchAssertions.assertAcked(prepareCreate("test").addMapping("doc","double0","type=double","double1","type=double","double2","type=double"));
  ensureGreen("test");
  indexRandom(true,client().prepareIndex("test","doc","1").setSource("double0","5.0","double0","1.0","double0","1.5","double1","1.2","double1","2.4","double2","3.0"),client().prepareIndex("test","doc","2").setSource("double0","5.0","double1","3.0"),client().prepareIndex("test","doc","3").setSource("double0","5.0","double0","1.0","double0","1.5","double0","-1.5","double1","4.0"));
  SearchResponse rsp=buildRequest("doc['double0'].count() + doc['double1'].count()").get();
  assertSearchResponse(rsp);
  SearchHits hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(5.0,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(2.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double0'].sum()").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(7.5,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(6.0,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double0'].avg() + doc['double1'].avg()").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(4.3,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(8.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(5.5,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double0'].median()").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(1.5,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(1.25,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double0'].min()").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(1.0,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(-1.5,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double0'].max()").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(5.0,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double0'].sum()/doc['double0'].count()").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(2.5,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(1.5,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double2'].count()").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(1.0,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(0.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(0.0,hits.getAt(2).field("foo").getValue(),0.0D);
  rsp=buildRequest("doc['double2'].empty ? 5.0 : 2.0").get();
  assertSearchResponse(rsp);
  hits=rsp.getHits();
  assertEquals(3,hits.getTotalHits());
  assertEquals(2.0,hits.getAt(0).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(1).field("foo").getValue(),0.0D);
  assertEquals(5.0,hits.getAt(2).field("foo").getValue(),0.0D);
}
