{
  String mappingBefore=jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("copy_test").field("type","string").array("copy_to","foo","bar").endObject().endObject().endObject().endObject().string();
  String mappingAfter=jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("copy_test").field("type","string").array("copy_to","baz","bar").endObject().endObject().endObject().endObject().string();
  DocumentMapperParser parser=createIndex("test").mapperService().documentMapperParser();
  DocumentMapper docMapperBefore=parser.parse(mappingBefore);
  ImmutableList<String> fields=docMapperBefore.mappers().getMapper("copy_test").copyTo().copyToFields();
  assertThat(fields.size(),equalTo(2));
  assertThat(fields.get(0),equalTo("foo"));
  assertThat(fields.get(1),equalTo("bar"));
  DocumentMapper docMapperAfter=parser.parse(mappingAfter);
  DocumentMapper.MergeResult mergeResult=docMapperBefore.merge(docMapperAfter.mapping(),mergeFlags().simulate(true));
  assertThat(Arrays.toString(mergeResult.conflicts()),mergeResult.hasConflicts(),equalTo(false));
  docMapperBefore.merge(docMapperAfter.mapping(),mergeFlags().simulate(false));
  fields=docMapperBefore.mappers().getMapper("copy_test").copyTo().copyToFields();
  assertThat(fields.size(),equalTo(2));
  assertThat(fields.get(0),equalTo("baz"));
  assertThat(fields.get(1),equalTo("bar"));
}
