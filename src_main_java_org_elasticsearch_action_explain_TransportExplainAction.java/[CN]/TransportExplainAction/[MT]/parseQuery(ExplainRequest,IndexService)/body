{
  try {
    XContentParser parser=XContentHelper.createParser(request.source());
    for (XContentParser.Token token=parser.nextToken(); token != XContentParser.Token.END_OBJECT; token=parser.nextToken()) {
      if (token == XContentParser.Token.FIELD_NAME) {
        String fieldName=parser.currentName();
        if ("query".equals(fieldName)) {
          return indexService.queryParserService().parse(parser);
        }
 else         if ("query_binary".equals(fieldName)) {
          byte[] querySource=parser.binaryValue();
          XContentParser qSourceParser=XContentFactory.xContent(querySource).createParser(querySource);
          return indexService.queryParserService().parse(qSourceParser);
        }
      }
    }
  }
 catch (  Exception e) {
    throw new ElasticSearchException("Couldn't parse query from source.",e);
  }
  throw new ElasticSearchException("No query specified");
}
