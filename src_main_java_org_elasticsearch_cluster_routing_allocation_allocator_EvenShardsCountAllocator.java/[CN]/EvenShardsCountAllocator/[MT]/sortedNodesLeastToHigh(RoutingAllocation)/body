{
  final ObjectIntOpenHashMap<String> nodeCounts=new ObjectIntOpenHashMap<>();
  for (  RoutingNode node : allocation.routingNodes()) {
    for (int i=0; i < node.size(); i++) {
      ShardRouting shardRouting=node.get(i);
      String nodeId=shardRouting.relocating() ? shardRouting.relocatingNodeId() : shardRouting.currentNodeId();
      nodeCounts.addTo(nodeId,1);
    }
  }
  RoutingNode[] nodes=allocation.routingNodes().toArray();
  Arrays.sort(nodes,new Comparator<RoutingNode>(){
    @Override public int compare(    RoutingNode o1,    RoutingNode o2){
      return nodeCounts.get(o1.nodeId()) - nodeCounts.get(o2.nodeId());
    }
  }
);
  return nodes;
}
