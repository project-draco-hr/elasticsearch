{
  DeleteIndexResponse deleteIndexResponse=client().admin().indices().prepareDelete().execute().actionGet();
  assertThat("Delete Index failed - not acked",deleteIndexResponse.isAcknowledged(),equalTo(true));
  ensureGreen();
  client().admin().indices().prepareCreate("test1").execute().actionGet();
  client().admin().indices().prepareCreate("test2").execute().actionGet();
  ensureGreen();
  client().prepareIndex("test1",PercolatorService.TYPE_NAME,"1").setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).execute().actionGet();
  client().prepareIndex("test2",PercolatorService.TYPE_NAME,"1").setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).execute().actionGet();
  PercolateResponse response=client().preparePercolate().setIndices("test1","test2").setDocumentType("type").setOnlyCount(true).setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().field("field1","b").endObject())).execute().actionGet();
  assertThat(response.getCount(),equalTo(2l));
  assertAcked(client().admin().indices().prepareDeleteMapping("test1").setType(PercolatorService.TYPE_NAME));
  response=client().preparePercolate().setIndices("test1","test2").setDocumentType("type").setOnlyCount(true).setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().field("field1","b").endObject())).execute().actionGet();
  assertNoFailures(response);
  assertThat(response.getCount(),equalTo(1l));
  assertAcked(client().admin().indices().prepareDeleteMapping("test2").setType(PercolatorService.TYPE_NAME));
  response=client().preparePercolate().setIndices("test1","test2").setDocumentType("type").setOnlyCount(true).setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().field("field1","b").endObject())).execute().actionGet();
  assertNoFailures(response);
  assertThat(response.getCount(),equalTo(0l));
}
