{
  assertAcked(prepareCreate("test").addMapping("type1","field1","type=long,doc_values=true"));
  ensureGreen();
  XContentBuilder doc=XContentFactory.jsonBuilder().startObject().startObject("doc").field("field1",1).field("field2","value").endObject().endObject();
  PercolateResponse response=client().preparePercolate().setSource(doc).setIndices("test").setDocumentType("type1").execute().actionGet();
  assertMatchCount(response,0l);
  assertThat(response.getMatches(),emptyArray());
  waitForConcreteMappingsOnAll("test","type1","field1","field2");
  client().prepareIndex("test",PercolatorService.TYPE_NAME,"test1").setSource(XContentFactory.jsonBuilder().startObject().field("query",termQuery("field2","value")).endObject()).execute().actionGet();
  response=client().preparePercolate().setIndices("test").setDocumentType("type1").setSource(doc).execute().actionGet();
  assertMatchCount(response,1l);
  assertThat(response.getMatches(),arrayWithSize(1));
  assertThat(convertFromTextArray(response.getMatches(),"test"),arrayContaining("test1"));
  client().prepareIndex("test",PercolatorService.TYPE_NAME,"test2").setSource(XContentFactory.jsonBuilder().startObject().field("query",termQuery("field1",1)).endObject()).execute().actionGet();
  response=client().preparePercolate().setIndices("test").setDocumentType("type1").setSource(doc).execute().actionGet();
  assertMatchCount(response,2l);
  assertThat(response.getMatches(),arrayWithSize(2));
  assertThat(convertFromTextArray(response.getMatches(),"test"),arrayContainingInAnyOrder("test1","test2"));
  client().prepareDelete("test",PercolatorService.TYPE_NAME,"test2").execute().actionGet();
  response=client().preparePercolate().setIndices("test").setDocumentType("type1").setSource(doc).execute().actionGet();
  assertMatchCount(response,1l);
  assertThat(response.getMatches(),arrayWithSize(1));
  assertThat(convertFromTextArray(response.getMatches(),"test"),arrayContaining("test1"));
  client().prepareIndex("test",PercolatorService.TYPE_NAME,"test3").setSource(XContentFactory.jsonBuilder().startObject().field("query",constantScoreQuery(rangeFilter("field1").from(1).to(5).includeLower(true).setExecution("fielddata"))).endObject()).execute().actionGet();
  response=client().preparePercolate().setIndices("test").setDocumentType("type1").setSource(doc).execute().actionGet();
  ElasticsearchAssertions.assertFailures(response);
}
