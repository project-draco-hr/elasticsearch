{
  long startTime=System.nanoTime();
  Tuple<DocumentMapper,Boolean> docMapper=mapperService.documentMapperWithAutoCreate(source.type());
  try {
    ParsedDocument doc=docMapper.v1().parse(source).setMappingsModified(docMapper);
    return new Engine.Index(docMapper.v1(),docMapper.v1().uidMapper().term(doc.uid().stringValue()),doc,version,versionType,origin,startTime,state != IndexShardState.STARTED || canHaveDuplicates);
  }
 catch (  Throwable t) {
    if (docMapper.v2() || (t instanceof MapperParsingException && ((MapperParsingException)t).isMappingsModified())) {
      throw new WriteFailureException(t,docMapper.v1().type());
    }
 else {
      throw t;
    }
  }
}
