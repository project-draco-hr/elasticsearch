{
synchronized (mutex) {
    try {
      indexSettingsService.removeListener(applyRefreshSettings);
      if (state != IndexShardState.CLOSED) {
        FutureUtils.cancel(refreshScheduledFuture);
        refreshScheduledFuture=null;
        FutureUtils.cancel(mergeScheduleFuture);
        mergeScheduleFuture=null;
      }
      changeState(IndexShardState.CLOSED,reason);
      indexShardOperationCounter.decRef();
    }
  finally {
      final Engine engine=this.currentEngineReference.getAndSet(null);
      try {
        if (flushEngine && this.flushOnClose) {
          engine.flushAndClose();
        }
      }
  finally {
        IOUtils.close(engine,shardFilterCache);
      }
    }
  }
}
