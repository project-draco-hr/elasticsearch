{
  Settings settings=internalCluster().getInstance(Settings.class);
  AmazonS3 s3Client=internalCluster().getInstance(AwsS3Service.class).client(settings.get("repositories.s3.endpoint"),settings.get("repositories.s3.protocol"),settings.get("repositories.s3.region"),settings.get("cloud.aws.access_key"),settings.get("cloud.aws.secret_key"));
  String bucket=settings.get("repositories.s3.bucket");
  String objectKey=basePath + "/metadata-" + snapshotName;
  S3Object object=s3Client.getObject(bucket,objectKey);
  try {
    JsonReader jsonReader=new JsonReader(new InputStreamReader(object.getObjectContent()));
    jsonReader.beginObject();
    assertThat("The file hasn't been encrypted properly, its content is still readable!",jsonReader.nextName(),not(equalTo("meta-data")));
  }
 catch (  Exception e) {
    assertThat(e,instanceOf(MalformedJsonException.class));
  }
}
