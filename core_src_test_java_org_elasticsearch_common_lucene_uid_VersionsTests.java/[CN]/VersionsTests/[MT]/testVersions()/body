{
  Directory dir=newDirectory();
  IndexWriter writer=new IndexWriter(dir,new IndexWriterConfig(Lucene.STANDARD_ANALYZER));
  DirectoryReader directoryReader=ElasticsearchDirectoryReader.wrap(DirectoryReader.open(writer,true),new ShardId("foo","_na_",1));
  MatcherAssert.assertThat(Versions.loadVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")),equalTo(Versions.NOT_FOUND));
  Document doc=new Document();
  doc.add(new Field(UidFieldMapper.NAME,"1",UidFieldMapper.Defaults.FIELD_TYPE));
  writer.addDocument(doc);
  directoryReader=reopen(directoryReader);
  assertThat(Versions.loadVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")),equalTo(Versions.NOT_SET));
  assertThat(Versions.loadDocIdAndVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")).version,equalTo(Versions.NOT_SET));
  doc=new Document();
  doc.add(new Field(UidFieldMapper.NAME,"1",UidFieldMapper.Defaults.FIELD_TYPE));
  doc.add(new NumericDocValuesField(VersionFieldMapper.NAME,1));
  writer.updateDocument(new Term(UidFieldMapper.NAME,"1"),doc);
  directoryReader=reopen(directoryReader);
  assertThat(Versions.loadVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")),equalTo(1L));
  assertThat(Versions.loadDocIdAndVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")).version,equalTo(1L));
  doc=new Document();
  Field uid=new Field(UidFieldMapper.NAME,"1",UidFieldMapper.Defaults.FIELD_TYPE);
  Field version=new NumericDocValuesField(VersionFieldMapper.NAME,2);
  doc.add(uid);
  doc.add(version);
  writer.updateDocument(new Term(UidFieldMapper.NAME,"1"),doc);
  directoryReader=reopen(directoryReader);
  assertThat(Versions.loadVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")),equalTo(2L));
  assertThat(Versions.loadDocIdAndVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")).version,equalTo(2L));
  doc=new Document();
  version.setLongValue(3);
  doc.add(uid);
  doc.add(version);
  writer.updateDocument(new Term(UidFieldMapper.NAME,"1"),doc);
  directoryReader=reopen(directoryReader);
  assertThat(Versions.loadVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")),equalTo(3L));
  assertThat(Versions.loadDocIdAndVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")).version,equalTo(3L));
  writer.deleteDocuments(new Term(UidFieldMapper.NAME,"1"));
  directoryReader=reopen(directoryReader);
  assertThat(Versions.loadVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")),equalTo(Versions.NOT_FOUND));
  assertThat(Versions.loadDocIdAndVersion(directoryReader,new Term(UidFieldMapper.NAME,"1")),nullValue());
  directoryReader.close();
  writer.close();
  dir.close();
}
