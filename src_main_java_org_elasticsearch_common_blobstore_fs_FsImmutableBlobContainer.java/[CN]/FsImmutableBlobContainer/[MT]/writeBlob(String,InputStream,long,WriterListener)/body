{
  blobStore.executor().execute(new Runnable(){
    @Override public void run(){
      final File file=new File(path,blobName);
      boolean success=false;
      try {
        try (final RandomAccessFile raf=new RandomAccessFile(file,"rw");final InputStream is=stream){
          raf.setLength(0);
          long bytesWritten=0;
          final byte[] buffer=new byte[blobStore.bufferSizeInBytes()];
          int bytesRead;
          while ((bytesRead=is.read(buffer)) != -1) {
            raf.write(buffer,0,bytesRead);
            bytesWritten+=bytesRead;
          }
          if (bytesWritten != sizeInBytes) {
            throw new ElasticsearchIllegalStateException("[" + blobName + "]: wrote ["+ bytesWritten+ "], expected to write ["+ sizeInBytes+ "]");
          }
          raf.getFD().sync();
          FileSystemUtils.syncFile(path,true);
        }
         success=true;
      }
 catch (      Throwable e) {
        listener.onFailure(e);
        FileSystemUtils.tryDeleteFile(file);
      }
 finally {
        if (success) {
          listener.onCompleted();
        }
      }
    }
  }
);
}
