{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.refresh_interval",-1)).execute().actionGet();
  ClusterHealthResponse clusterHealth=client.admin().cluster().health(clusterHealthRequest().setWaitForGreenStatus()).actionGet();
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  GetResponse response=client.prepareGet("test","type1","1").execute().actionGet();
  assertThat(response.isExists(),equalTo(false));
  logger.info("--> index doc 1");
  client.prepareIndex("test","type1","1").setSource("field1","value1","field2","value2").execute().actionGet();
  logger.info("--> realtime get 1");
  response=client.prepareGet("test","type1","1").execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsMap().get("field1").toString(),equalTo("value1"));
  assertThat(response.getSourceAsMap().get("field2").toString(),equalTo("value2"));
  logger.info("--> realtime get 1 (no source)");
  response=client.prepareGet("test","type1","1").setFields(Strings.EMPTY_ARRAY).execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsBytes(),nullValue());
  logger.info("--> realtime get 1 (no type)");
  response=client.prepareGet("test",null,"1").execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsMap().get("field1").toString(),equalTo("value1"));
  assertThat(response.getSourceAsMap().get("field2").toString(),equalTo("value2"));
  logger.info("--> non realtime get 1");
  response=client.prepareGet("test","type1","1").setRealtime(false).execute().actionGet();
  assertThat(response.isExists(),equalTo(false));
  logger.info("--> realtime fetch of field (requires fetching parsing source)");
  response=client.prepareGet("test","type1","1").setFields("field1").execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsBytes(),nullValue());
  assertThat(response.getField("field1").getValues().get(0).toString(),equalTo("value1"));
  assertThat(response.getField("field2"),nullValue());
  logger.info("--> flush the index, so we load it from it");
  client.admin().indices().prepareFlush().execute().actionGet();
  logger.info("--> realtime get 1 (loaded from index)");
  response=client.prepareGet("test","type1","1").execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsMap().get("field1").toString(),equalTo("value1"));
  assertThat(response.getSourceAsMap().get("field2").toString(),equalTo("value2"));
  logger.info("--> non realtime get 1 (loaded from index)");
  response=client.prepareGet("test","type1","1").setRealtime(false).execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsMap().get("field1").toString(),equalTo("value1"));
  assertThat(response.getSourceAsMap().get("field2").toString(),equalTo("value2"));
  logger.info("--> realtime fetch of field (loaded from index)");
  response=client.prepareGet("test","type1","1").setFields("field1").execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsBytes(),nullValue());
  assertThat(response.getField("field1").getValues().get(0).toString(),equalTo("value1"));
  assertThat(response.getField("field2"),nullValue());
  logger.info("--> update doc 1");
  client.prepareIndex("test","type1","1").setSource("field1","value1_1","field2","value2_1").execute().actionGet();
  logger.info("--> realtime get 1");
  response=client.prepareGet("test","type1","1").execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsMap().get("field1").toString(),equalTo("value1_1"));
  assertThat(response.getSourceAsMap().get("field2").toString(),equalTo("value2_1"));
  logger.info("--> update doc 1 again");
  client.prepareIndex("test","type1","1").setSource("field1","value1_2","field2","value2_2").execute().actionGet();
  response=client.prepareGet("test","type1","1").execute().actionGet();
  assertThat(response.isExists(),equalTo(true));
  assertThat(response.getSourceAsMap().get("field1").toString(),equalTo("value1_2"));
  assertThat(response.getSourceAsMap().get("field2").toString(),equalTo("value2_2"));
  DeleteResponse deleteResponse=client.prepareDelete("test","type1","1").execute().actionGet();
  assertThat(deleteResponse.isNotFound(),equalTo(false));
  response=client.prepareGet("test","type1","1").execute().actionGet();
  assertThat(response.isExists(),equalTo(false));
}
