{
  assertAcked(client().admin().indices().prepareCreate("my-index").addMapping("my-type",createTypeSource()));
  GetMappingsResponse getMappingsResponse=client().admin().indices().prepareGetMappings("my-index").get();
  MappingMetaData mappingMetaData=getMappingsResponse.mappings().get("my-index").get("my-type");
  assertThat(mappingMetaData,not(nullValue()));
  Map<String,Object> mappingSource=mappingMetaData.sourceAsMap();
  assertThat(((Map)XContentMapValues.extractValue("properties.title.fields",mappingSource)).size(),equalTo(1));
  client().prepareIndex("my-index","my-type","1").setSource("title","Multi fields").setRefresh(true).get();
  SearchResponse searchResponse=client().prepareSearch("my-index").setQuery(QueryBuilders.matchQuery("title","multi")).get();
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
  searchResponse=client().prepareSearch("my-index").setQuery(QueryBuilders.matchQuery("title.not_analyzed","Multi fields")).get();
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
  assertAcked(client().admin().indices().preparePutMapping("my-index").setType("my-type").setSource(createPutMappingSource()).setIgnoreConflicts(true));
  getMappingsResponse=client().admin().indices().prepareGetMappings("my-index").get();
  mappingMetaData=getMappingsResponse.mappings().get("my-index").get("my-type");
  assertThat(mappingMetaData,not(nullValue()));
  mappingSource=mappingMetaData.sourceAsMap();
  assertThat(((Map)XContentMapValues.extractValue("properties.title",mappingSource)).size(),equalTo(2));
  assertThat(((Map)XContentMapValues.extractValue("properties.title.fields",mappingSource)).size(),equalTo(2));
  searchResponse=client().prepareSearch("my-index").setQuery(QueryBuilders.matchQuery("title.uncased","multi")).get();
  assertThat(searchResponse.getHits().totalHits(),equalTo(0l));
  searchResponse=client().prepareSearch("my-index").setQuery(QueryBuilders.matchQuery("title.uncased","Multi")).get();
  assertThat(searchResponse.getHits().totalHits(),equalTo(0l));
  client().prepareIndex("my-index","my-type","1").setSource("title","Multi fields").setRefresh(true).get();
  searchResponse=client().prepareSearch("my-index").setQuery(QueryBuilders.matchQuery("title.uncased","Multi")).get();
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
}
