{
  ValueFormatterStreams.writeOptional(valueFormatter,out);
  out.writeInt(keys.length);
  for (int i=0; i < keys.length; ++i) {
    out.writeDouble(keys[i]);
  }
  out.writeLong(state.getHighestToLowestValueRatio());
  ByteBuffer stateBuffer=ByteBuffer.allocate(state.getNeededByteBufferCapacity());
  final int serializedLen=state.encodeIntoCompressedByteBuffer(stateBuffer);
  out.writeVInt(serializedLen);
  out.writeBytes(stateBuffer.array(),0,serializedLen);
  out.writeBoolean(keyed);
}
