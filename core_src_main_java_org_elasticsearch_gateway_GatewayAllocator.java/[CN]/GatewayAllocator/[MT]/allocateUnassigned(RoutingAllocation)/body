{
  long lastAllocateUnassignedRun=System.currentTimeMillis();
  this.routingService.setUnassignedShardsAllocatedTimestamp(lastAllocateUnassignedRun);
  boolean changed=false;
  RoutingNodes.UnassignedShards unassigned=allocation.routingNodes().unassigned();
  unassigned.sort(new PriorityComparator(){
    @Override protected Settings getIndexSettings(    String index){
      IndexMetaData indexMetaData=allocation.metaData().index(index);
      return indexMetaData.getSettings();
    }
  }
);
  changed|=primaryShardAllocator.allocateUnassigned(allocation);
  changed|=replicaShardAllocator.processExistingRecoveries(allocation);
  changed|=replicaShardAllocator.allocateUnassigned(allocation,lastAllocateUnassignedRun);
  return changed;
}
