{
  long lastAllocateUnassignedRun=System.currentTimeMillis();
  this.routingService.setUnassignedShardsAllocatedTimestamp(lastAllocateUnassignedRun);
  boolean changed=false;
  RoutingNodes.UnassignedShards unassigned=allocation.routingNodes().unassigned();
  unassigned.sort(PriorityComparator.getAllocationComparator(allocation));
  changed|=primaryShardAllocator.allocateUnassigned(allocation);
  changed|=replicaShardAllocator.processExistingRecoveries(allocation);
  changed|=replicaShardAllocator.allocateUnassigned(allocation,lastAllocateUnassignedRun);
  return changed;
}
