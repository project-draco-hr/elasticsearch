{
  final AtomicReference<Throwable> failureRef=new AtomicReference<Throwable>();
  final AtomicReference<ClusterState> clusterStateResponse=new AtomicReference<ClusterState>();
  final CountDownLatch latch=new CountDownLatch(1);
  clusterService.submitStateUpdateTask("cluster_reroute (api)",new ProcessedClusterStateUpdateTask(){
    @Override public ClusterState execute(    ClusterState currentState){
      try {
        RoutingAllocation.Result routingResult=allocationService.reroute(currentState,request.commands);
        ClusterState newState=newClusterStateBuilder().state(currentState).routingResult(routingResult).build();
        clusterStateResponse.set(newState);
        if (request.dryRun) {
          return currentState;
        }
        return newState;
      }
 catch (      Exception e) {
        logger.debug("failed to reroute",e);
        failureRef.set(e);
        latch.countDown();
        return currentState;
      }
 finally {
      }
    }
    @Override public void clusterStateProcessed(    ClusterState clusterState){
      latch.countDown();
    }
  }
);
  try {
    latch.await();
  }
 catch (  InterruptedException e) {
    failureRef.set(e);
  }
  if (failureRef.get() != null) {
    if (failureRef.get() instanceof ElasticSearchException) {
      throw (ElasticSearchException)failureRef.get();
    }
 else {
      throw new ElasticSearchException(failureRef.get().getMessage(),failureRef.get());
    }
  }
  return new ClusterRerouteResponse(clusterStateResponse.get());
}
