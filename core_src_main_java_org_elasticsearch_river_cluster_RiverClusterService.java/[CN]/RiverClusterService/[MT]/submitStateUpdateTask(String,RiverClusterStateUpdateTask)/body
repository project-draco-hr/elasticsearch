{
  if (!lifecycle.started()) {
    return;
  }
  updateTasksExecutor.execute(new Runnable(){
    @Override public void run(){
      if (!lifecycle.started()) {
        logger.debug("processing [{}]: ignoring, cluster_service not started",source);
        return;
      }
      logger.debug("processing [{}]: execute",source);
      RiverClusterState previousClusterState=clusterState;
      try {
        clusterState=updateTask.execute(previousClusterState);
      }
 catch (      Exception e) {
        StringBuilder sb=new StringBuilder("failed to execute cluster state update, state:\nversion [").append(clusterState.version()).append("], source [").append(source).append("]\n");
        logger.warn(sb.toString(),e);
        return;
      }
      if (previousClusterState != clusterState) {
        if (clusterService.state().nodes().localNodeMaster()) {
          clusterState=new RiverClusterState(clusterState.version() + 1,clusterState);
        }
 else {
          if (clusterState.version() < previousClusterState.version()) {
            logger.debug("got old cluster state [" + clusterState.version() + "<"+ previousClusterState.version()+ "] from source ["+ source+ "], ignoring");
            return;
          }
        }
        if (logger.isTraceEnabled()) {
          StringBuilder sb=new StringBuilder("cluster state updated:\nversion [").append(clusterState.version()).append("], source [").append(source).append("]\n");
          logger.trace(sb.toString());
        }
 else         if (logger.isDebugEnabled()) {
          logger.debug("cluster state updated, version [{}], source [{}]",clusterState.version(),source);
        }
        RiverClusterChangedEvent clusterChangedEvent=new RiverClusterChangedEvent(source,clusterState,previousClusterState);
        for (        RiverClusterStateListener listener : clusterStateListeners) {
          listener.riverClusterChanged(clusterChangedEvent);
        }
        if (clusterService.state().nodes().localNodeMaster()) {
          publishAction.publish(clusterState);
        }
        logger.debug("processing [{}]: done applying updated cluster_state",source);
      }
 else {
        logger.debug("processing [{}]: no change in cluster_state",source);
      }
    }
  }
);
}
