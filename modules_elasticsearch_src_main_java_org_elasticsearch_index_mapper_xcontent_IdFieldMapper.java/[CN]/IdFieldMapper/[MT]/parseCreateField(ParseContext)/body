{
  if (context.parsedIdState() == ParseContext.ParsedIdState.NO) {
    String id=context.parser().text();
    if (context.id() != null && !context.id().equals(id)) {
      throw new MapperParsingException("Provided id [" + context.id() + "] does not match the content one ["+ id+ "]");
    }
    context.id(id);
    context.parsedId(ParseContext.ParsedIdState.PARSED);
    ArrayDeque<Field> cache=fieldCache.get();
    Field field=cache.poll();
    if (field == null) {
      field=new Field(names.indexName(),"",store,index);
    }
    field.setValue(context.id());
    return field;
  }
 else   if (context.parsedIdState() == ParseContext.ParsedIdState.EXTERNAL) {
    if (context.id() == null) {
      throw new MapperParsingException("No id mapping with [" + names.name() + "] found in the content, and not explicitly set");
    }
    ArrayDeque<Field> cache=fieldCache.get();
    Field field=cache.poll();
    if (field == null) {
      field=new Field(names.indexName(),"",store,index);
    }
    field.setValue(context.id());
    return field;
  }
 else {
    throw new MapperParsingException("Illegal parsed id state");
  }
}
