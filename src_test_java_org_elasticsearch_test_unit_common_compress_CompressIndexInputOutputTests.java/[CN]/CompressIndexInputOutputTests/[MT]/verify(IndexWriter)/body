{
  CheckIndex checkIndex=new CheckIndex(writer.getDirectory());
  CheckIndex.Status status=checkIndex.checkIndex();
  assertThat(status.clean,equalTo(true));
  IndexReader reader=DirectoryReader.open(writer,true);
  final Bits liveDocs=MultiFields.getLiveDocs(reader);
  for (int i=0; i < reader.maxDoc(); i++) {
    if (liveDocs != null && !liveDocs.get(i)) {
      continue;
    }
    Document document=reader.document(i);
    checkDoc(document);
    DocumentStoredFieldVisitor visitor=new DocumentStoredFieldVisitor("id","field","count");
    reader.document(i,visitor);
    document=visitor.getDocument();
    checkDoc(document);
  }
  for (int i=0; i < 100; i++) {
    int doc=ThreadLocalRandom.current().nextInt(reader.maxDoc());
    if (liveDocs != null && !liveDocs.get(i)) {
      continue;
    }
    Document document=reader.document(doc);
    checkDoc(document);
    DocumentStoredFieldVisitor visitor=new DocumentStoredFieldVisitor("id","field","count");
    reader.document(doc,visitor);
    document=visitor.getDocument();
    checkDoc(document);
  }
}
