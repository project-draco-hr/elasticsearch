{
  Message message=new Message();
  message.putHeader("key1","value1");
  message.putHeader("key2","value2");
  message.putInContext("key3","value3");
  BytesStreamOutput out=new BytesStreamOutput();
  out.setVersion(Version.CURRENT);
  message.writeTo(out);
  StreamInput in=StreamInput.wrap(out.bytes());
  in.setVersion(Version.CURRENT);
  message=new Message();
  message.readFrom(in);
  assertThat(message.getHeaders().size(),is(2));
  assertThat((String)message.getHeader("key1"),equalTo("value1"));
  assertThat((String)message.getHeader("key2"),equalTo("value2"));
  assertThat(message.isContextEmpty(),is(true));
}
