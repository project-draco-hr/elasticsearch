{
  int numIndexes=randomIntBetween(2,4);
  String[] indexNames=new String[numIndexes];
  for (int i=0; i < numIndexes; ++i) {
    final String indexName="test" + i;
    indexNames[i]=indexName;
    Settings settings=ImmutableSettings.builder().put("index.routing.allocation.exclude._name",backwardsCluster().newNodePattern()).put("index.merge.policy.segments_per_tier",1000000f).put(indexSettings()).build();
    assertAcked(prepareCreate(indexName).setSettings(settings));
    ensureGreen(indexName);
    assertAllShardsOnNodes(indexName,backwardsCluster().backwardsNodePattern());
    int numDocs=scaledRandomIntBetween(100,1000);
    List<IndexRequestBuilder> builder=new ArrayList<>();
    for (int j=0; j < numDocs; ++j) {
      String id=Integer.toString(j);
      builder.add(client().prepareIndex(indexName,"type1",id).setSource("text","sometext"));
    }
    indexRandom(true,builder);
    ensureGreen(indexName);
    if (globalCompatibilityVersion().before(Version.V_1_4_0_Beta1)) {
      assertTrue(awaitBusy(new Predicate<Object>(){
        @Override public boolean apply(        Object o){
          return flush(indexName).getFailedShards() == 0;
        }
      }
));
    }
 else {
      assertEquals(0,flush(indexName).getFailedShards());
    }
    numDocs=scaledRandomIntBetween(100,1000);
    builder=new ArrayList<>();
    for (int j=0; j < numDocs; ++j) {
      String id=Integer.toString(j);
      builder.add(client().prepareIndex(indexName,"type2",id).setSource("text","someothertext"));
    }
    indexRandom(true,builder);
    ensureGreen(indexName);
  }
  backwardsCluster().allowOnAllNodes(indexNames);
  backwardsCluster().upgradeAllNodes();
  ensureGreen();
  final HttpRequestBuilder httpClient=httpClient();
  assertNotUpgraded(httpClient,null);
  final String indexToUpgrade="test" + randomInt(numIndexes - 1);
  logger.debug("--> Running upgrade on index " + indexToUpgrade);
  logClusterState();
  logSegmentsState(indexToUpgrade);
  runUpgrade(httpClient,indexToUpgrade);
  awaitBusy(new Predicate<Object>(){
    @Override public boolean apply(    Object o){
      try {
        return isUpgraded(httpClient,indexToUpgrade);
      }
 catch (      Exception e) {
        throw ExceptionsHelper.convertToRuntime(e);
      }
    }
  }
);
  logger.debug("--> Single index upgrade complete");
  logClusterState();
  logSegmentsState(indexToUpgrade);
  logger.debug("--> Running upgrade on the rest of the indexes");
  logClusterState();
  logSegmentsState(null);
  runUpgrade(httpClient,null,"wait_for_completion","true");
  logger.debug("--> Full upgrade complete");
  logClusterState();
  logSegmentsState(null);
  assertUpgraded(httpClient,null);
}
