{
  final String newMetaData="metadata-" + (currentIndex + 1);
  XContentBuilder builder;
  try {
    builder=XContentFactory.contentBuilder(XContentType.JSON);
    builder.startObject();
    MetaData.Builder.toXContent(metaData,builder,ToXContent.EMPTY_PARAMS);
    builder.endObject();
  }
 catch (  IOException e) {
    throw new GatewayException("Failed to serialize metadata into gateway",e);
  }
  try {
    byte[] data=builder.unsafeBytes();
    int size=builder.unsafeBytesLength();
    if (compress) {
      data=LZFEncoder.encode(data,size);
      size=data.length;
    }
    metaDataBlobContainer.writeBlob(newMetaData,new ByteArrayInputStream(data,0,size),size);
  }
 catch (  IOException e) {
    throw new GatewayException("Failed to write metadata [" + newMetaData + "]",e);
  }
  currentIndex++;
  try {
    metaDataBlobContainer.deleteBlobsByFilter(new BlobContainer.BlobNameFilter(){
      @Override public boolean accept(      String blobName){
        return blobName.startsWith("metadata-") && !newMetaData.equals(blobName);
      }
    }
);
  }
 catch (  IOException e) {
    logger.debug("Failed to delete old metadata, will do it next time",e);
  }
}
