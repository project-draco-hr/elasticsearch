{
  final String newMetaData="metadata-" + (currentIndex + 1);
  try {
    FastByteArrayOutputStream out=new FastByteArrayOutputStream();
    OutputStream os=out;
    if (compress) {
      os=new LZFOutputStream(os);
    }
    XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON,os);
    builder.startObject();
    MetaData.Builder.toXContent(metaData,builder,ToXContent.EMPTY_PARAMS);
    builder.endObject();
    builder.close();
    metaDataBlobContainer.writeBlob(newMetaData,new ByteArrayInputStream(out.unsafeByteArray(),0,out.size()),out.size());
  }
 catch (  IOException e) {
    throw new GatewayException("Failed to write metadata [" + newMetaData + "]",e);
  }
  currentIndex++;
  try {
    metaDataBlobContainer.deleteBlobsByFilter(new BlobContainer.BlobNameFilter(){
      @Override public boolean accept(      String blobName){
        return blobName.startsWith("metadata-") && !newMetaData.equals(blobName);
      }
    }
);
  }
 catch (  IOException e) {
    logger.debug("Failed to delete old metadata, will do it next time",e);
  }
}
