{
  Random random=new Random(seed);
  Builder builder=ImmutableSettings.settingsBuilder().put("cluster.routing.schedule",(30 + random.nextInt(50)) + "ms").put(SETTING_CLUSTER_NODE_SEED,seed);
  if (ENABLE_MOCK_MODULES && usually(random)) {
    builder.put("index.store.type",MockFSIndexStoreModule.class.getName());
    builder.put(IndexShardModule.ENGINE_FACTORY,MockEngineFactory.class);
    builder.put(PageCacheRecyclerModule.CACHE_IMPL,MockPageCacheRecyclerModule.class.getName());
    builder.put(BigArraysModule.IMPL,MockBigArraysModule.class.getName());
    builder.put(TransportModule.TRANSPORT_SERVICE_TYPE_KEY,MockTransportService.class.getName());
    builder.put(SearchServiceModule.IMPL,MockSearchServiceModule.class.getName());
  }
  if (isLocalTransportConfigured()) {
    builder.put(TransportModule.TRANSPORT_TYPE_KEY,AssertingLocalTransport.class.getName());
  }
 else {
    builder.put(Transport.TransportSettings.TRANSPORT_TCP_COMPRESS,rarely(random));
  }
  if (random.nextBoolean()) {
    builder.put("cache.recycler.page.type",RandomPicks.randomFrom(random,PageCacheRecycler.Type.values()));
  }
  if (random.nextInt(10) == 0) {
    builder.put(SearchService.KEEPALIVE_INTERVAL_KEY,TimeValue.timeValueMillis(10 + random.nextInt(2000)));
  }
 else   if (random.nextInt(10) != 0) {
    builder.put(SearchService.KEEPALIVE_INTERVAL_KEY,TimeValue.timeValueSeconds(10 + random.nextInt(5 * 60)));
  }
  if (random.nextBoolean()) {
    builder.put(SearchService.DEFAULT_KEEPALIVE_KEY,TimeValue.timeValueSeconds(100 + random.nextInt(5 * 60)));
  }
  if (random.nextBoolean()) {
    for (    String name : Arrays.asList(ThreadPool.Names.BULK,ThreadPool.Names.FLUSH,ThreadPool.Names.GET,ThreadPool.Names.INDEX,ThreadPool.Names.MANAGEMENT,ThreadPool.Names.OPTIMIZE,ThreadPool.Names.PERCOLATE,ThreadPool.Names.REFRESH,ThreadPool.Names.SEARCH,ThreadPool.Names.SNAPSHOT,ThreadPool.Names.SUGGEST,ThreadPool.Names.WARMER)) {
      if (random.nextBoolean()) {
        final String type=RandomPicks.randomFrom(random,Arrays.asList("fixed","cached","scaling"));
        builder.put(ThreadPool.THREADPOOL_GROUP + name + ".type",type);
      }
    }
  }
  if (random.nextInt(10) == 0) {
    builder.put(EsExecutors.PROCESSORS,1 + random.nextInt(AbstractRandomizedTest.TESTS_PROCESSORS));
  }
 else {
    builder.put(EsExecutors.PROCESSORS,AbstractRandomizedTest.TESTS_PROCESSORS);
  }
  if (random.nextBoolean()) {
    if (random.nextBoolean()) {
      builder.put("indices.fielddata.cache.size",1 + random.nextInt(1000),ByteSizeUnit.MB);
    }
    if (random.nextBoolean()) {
      builder.put("indices.fielddata.cache.expire",TimeValue.timeValueMillis(1 + random.nextInt(10000)));
    }
  }
  if (random.nextBoolean()) {
    builder.put(NettyTransport.WORKER_COUNT,random.nextInt(3) + 1);
    builder.put(NettyTransport.CONNECTIONS_PER_NODE_RECOVERY,random.nextInt(2) + 1);
    builder.put(NettyTransport.CONNECTIONS_PER_NODE_BULK,random.nextInt(3) + 1);
    builder.put(NettyTransport.CONNECTIONS_PER_NODE_REG,random.nextInt(6) + 1);
  }
  if (random.nextBoolean()) {
    builder.put(MappingUpdatedAction.INDICES_MAPPING_ADDITIONAL_MAPPING_CHANGE_TIME,RandomInts.randomIntBetween(random,0,500));
  }
  if (random.nextInt(10) == 0) {
    builder.put(HierarchyCircuitBreakerService.REQUEST_CIRCUIT_BREAKER_TYPE_SETTING,"noop");
    builder.put(HierarchyCircuitBreakerService.FIELDDATA_CIRCUIT_BREAKER_TYPE_SETTING,"noop");
  }
  if (random.nextBoolean()) {
    builder.put(FilterCacheModule.FilterCacheSettings.FILTER_CACHE_TYPE,random.nextBoolean() ? WeightedFilterCache.class : NoneFilterCache.class);
  }
  if (random.nextBoolean()) {
    final int freqCacheable=1 + random.nextInt(5);
    final int freqCostly=1 + random.nextInt(5);
    final int freqOther=Math.max(freqCacheable,freqCostly) + random.nextInt(2);
    int historySize=3 + random.nextInt(100);
    historySize=Math.max(historySize,freqCacheable);
    historySize=Math.max(historySize,freqCostly);
    historySize=Math.max(historySize,freqOther);
    builder.put(AutoFilterCachingPolicy.HISTORY_SIZE,historySize);
    builder.put(AutoFilterCachingPolicy.MIN_FREQUENCY_CACHEABLE,freqCacheable);
    builder.put(AutoFilterCachingPolicy.MIN_FREQUENCY_COSTLY,freqCostly);
    builder.put(AutoFilterCachingPolicy.MIN_FREQUENCY_OTHER,freqOther);
    builder.put(AutoFilterCachingPolicy.MIN_SEGMENT_SIZE_RATIO,random.nextFloat());
  }
  return builder.build();
}
