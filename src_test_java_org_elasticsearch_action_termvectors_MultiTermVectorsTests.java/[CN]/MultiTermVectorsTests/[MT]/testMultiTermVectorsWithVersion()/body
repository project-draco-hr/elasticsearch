{
  assertAcked(prepareCreate("test").addAlias(new Alias("alias")).setSettings(ImmutableSettings.settingsBuilder().put("index.refresh_interval",-1)));
  ensureGreen();
  MultiTermVectorsResponse response=client().prepareMultiTermVectors().add(indexOrAlias(),"type1","1").get();
  assertThat(response.getResponses().length,equalTo(1));
  assertThat(response.getResponses()[0].getResponse().isExists(),equalTo(false));
  for (int i=0; i < 3; i++) {
    client().prepareIndex("test","type1",Integer.toString(i)).setSource("field","value" + i).get();
  }
  response=client().prepareMultiTermVectors().add(new TermVectorsRequest(indexOrAlias(),"type1","1").selectedFields("field").version(0)).add(new TermVectorsRequest(indexOrAlias(),"type1","1").selectedFields("field").version(1)).add(new TermVectorsRequest(indexOrAlias(),"type1","1").selectedFields("field").version(2)).get();
  assertThat(response.getResponses().length,equalTo(3));
  assertThat(response.getResponses()[0].getFailure(),nullValue());
  assertThat(response.getResponses()[0].getId(),equalTo("1"));
  assertThat(response.getResponses()[0].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[0].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[0].getResponse().getFields().terms("field"),new String[]{"value1"});
  assertThat(response.getResponses()[1].getId(),equalTo("1"));
  assertThat(response.getResponses()[1].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[1].getFailure(),nullValue());
  assertThat(response.getResponses()[1].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[1].getResponse().getFields().terms("field"),new String[]{"value1"});
  assertThat(response.getResponses()[2].getFailure(),notNullValue());
  assertThat(response.getResponses()[2].getFailure().getId(),equalTo("1"));
  assertThat(response.getResponses()[2].getFailure().getMessage(),startsWith("VersionConflictEngineException"));
  refresh();
  response=client().prepareMultiTermVectors().add(new TermVectorsRequest(indexOrAlias(),"type1","1").selectedFields("field").version(0).realtime(false)).add(new TermVectorsRequest(indexOrAlias(),"type1","1").selectedFields("field").version(1).realtime(false)).add(new TermVectorsRequest(indexOrAlias(),"type1","1").selectedFields("field").version(2).realtime(false)).get();
  assertThat(response.getResponses().length,equalTo(3));
  assertThat(response.getResponses()[0].getFailure(),nullValue());
  assertThat(response.getResponses()[0].getId(),equalTo("1"));
  assertThat(response.getResponses()[0].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[0].getResponse().getFields().terms("field"),new String[]{"value1"});
  assertThat(response.getResponses()[1].getId(),equalTo("1"));
  assertThat(response.getResponses()[1].getFailure(),nullValue());
  assertThat(response.getResponses()[1].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[1].getResponse().getFields().terms("field"),new String[]{"value1"});
  assertThat(response.getResponses()[2].getFailure(),notNullValue());
  assertThat(response.getResponses()[2].getFailure().getId(),equalTo("1"));
  assertThat(response.getResponses()[2].getFailure().getMessage(),startsWith("VersionConflictEngineException"));
  for (int i=0; i < 3; i++) {
    client().prepareIndex("test","type1",Integer.toString(i)).setSource("field","value" + i).get();
  }
  response=client().prepareMultiTermVectors().add(new TermVectorsRequest(indexOrAlias(),"type1","2").selectedFields("field").version(0)).add(new TermVectorsRequest(indexOrAlias(),"type1","2").selectedFields("field").version(1)).add(new TermVectorsRequest(indexOrAlias(),"type1","2").selectedFields("field").version(2)).get();
  assertThat(response.getResponses().length,equalTo(3));
  assertThat(response.getResponses()[0].getFailure(),nullValue());
  assertThat(response.getResponses()[0].getId(),equalTo("2"));
  assertThat(response.getResponses()[0].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[0].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[0].getResponse().getFields().terms("field"),new String[]{"value2"});
  assertThat(response.getResponses()[1].getFailure(),notNullValue());
  assertThat(response.getResponses()[1].getFailure().getId(),equalTo("2"));
  assertThat(response.getResponses()[1].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[1].getFailure().getMessage(),startsWith("VersionConflictEngineException"));
  assertThat(response.getResponses()[2].getId(),equalTo("2"));
  assertThat(response.getResponses()[2].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[2].getFailure(),nullValue());
  assertThat(response.getResponses()[2].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[2].getResponse().getFields().terms("field"),new String[]{"value2"});
  refresh();
  response=client().prepareMultiTermVectors().add(new TermVectorsRequest(indexOrAlias(),"type1","2").selectedFields("field").version(0)).add(new TermVectorsRequest(indexOrAlias(),"type1","2").selectedFields("field").version(1)).add(new TermVectorsRequest(indexOrAlias(),"type1","2").selectedFields("field").version(2)).get();
  assertThat(response.getResponses().length,equalTo(3));
  assertThat(response.getResponses()[0].getFailure(),nullValue());
  assertThat(response.getResponses()[0].getId(),equalTo("2"));
  assertThat(response.getResponses()[0].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[0].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[0].getResponse().getFields().terms("field"),new String[]{"value2"});
  assertThat(response.getResponses()[1].getFailure(),notNullValue());
  assertThat(response.getResponses()[1].getFailure().getId(),equalTo("2"));
  assertThat(response.getResponses()[1].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[1].getFailure().getMessage(),startsWith("VersionConflictEngineException"));
  assertThat(response.getResponses()[2].getId(),equalTo("2"));
  assertThat(response.getResponses()[2].getIndex(),equalTo("test"));
  assertThat(response.getResponses()[2].getFailure(),nullValue());
  assertThat(response.getResponses()[2].getResponse().isExists(),equalTo(true));
  checkTermTexts(response.getResponses()[2].getResponse().getFields().terms("field"),new String[]{"value2"});
}
