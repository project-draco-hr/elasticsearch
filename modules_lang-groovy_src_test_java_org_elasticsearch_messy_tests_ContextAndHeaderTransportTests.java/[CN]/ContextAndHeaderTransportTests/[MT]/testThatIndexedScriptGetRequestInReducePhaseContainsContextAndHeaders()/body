{
  PutIndexedScriptResponse scriptResponse=transportClient().preparePutIndexedScript(GroovyScriptEngineService.NAME,"my_script",jsonBuilder().startObject().field("script","_value0 * 10").endObject().string()).get();
  assertThat(scriptResponse.isCreated(),is(true));
  transportClient().prepareIndex(queryIndex,"type","1").setSource(jsonBuilder().startObject().field("s_field","foo").field("l_field",10).endObject()).get();
  transportClient().admin().indices().prepareRefresh(queryIndex).get();
  SearchResponse searchResponse=transportClient().prepareSearch(queryIndex).addAggregation(AggregationBuilders.terms("terms").field("s_field").subAggregation(AggregationBuilders.max("max").field("l_field")).subAggregation(PipelineAggregatorBuilders.bucketScript("scripted").setBucketsPaths("max").script(new Script("my_script",ScriptType.INDEXED,GroovyScriptEngineService.NAME,null)))).get();
  assertNoFailures(searchResponse);
  assertHitCount(searchResponse,1);
  assertGetRequestsContainHeaders(".scripts");
  assertRequestsContainHeader(PutIndexedScriptRequest.class);
}
