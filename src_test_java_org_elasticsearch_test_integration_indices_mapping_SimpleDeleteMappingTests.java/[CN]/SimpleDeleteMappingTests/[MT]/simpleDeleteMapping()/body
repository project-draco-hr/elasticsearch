{
  for (int i=0; i < 10; i++) {
    client1.prepareIndex("test","type1",Integer.toString(i)).setSource(jsonBuilder().startObject().field("value","test" + i).endObject()).execute().actionGet();
  }
  ClusterHealthResponse clusterHealth=client1.admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  client1.admin().indices().prepareRefresh().execute().actionGet();
  for (int i=0; i < 10; i++) {
    CountResponse countResponse=client1.prepareCount().setQuery(matchAllQuery()).execute().actionGet();
    assertThat(countResponse.getCount(),equalTo(10l));
  }
  ClusterState clusterState=client1.admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(clusterState.metaData().index("test").mappings().containsKey("type1"),equalTo(true));
  client1.admin().indices().prepareDeleteMapping().setType("type1").execute().actionGet();
  Thread.sleep(500);
  for (int i=0; i < 10; i++) {
    CountResponse countResponse=client1.prepareCount().setQuery(matchAllQuery()).execute().actionGet();
    assertThat(countResponse.getCount(),equalTo(0l));
  }
  clusterState=client1.admin().cluster().prepareState().execute().actionGet().getState();
  assertThat(clusterState.metaData().index("test").mappings().containsKey("type1"),equalTo(false));
}
