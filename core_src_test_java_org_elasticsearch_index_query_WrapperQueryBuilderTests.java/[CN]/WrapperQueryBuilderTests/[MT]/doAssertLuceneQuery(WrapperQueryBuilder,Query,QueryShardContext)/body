{
  try (XContentParser qSourceParser=XContentFactory.xContent(queryBuilder.source()).createParser(queryBuilder.source())){
    final QueryShardContext contextCopy=new QueryShardContext(context);
    contextCopy.reset(qSourceParser);
    QueryBuilder<?> innerQuery=contextCopy.parseContext().parseInnerQueryBuilder();
    Query expected=innerQuery.toQuery(context);
    assertThat(query,equalTo(expected));
  }
 }
