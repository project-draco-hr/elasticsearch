{
  try (XContentParser qSourceParser=XContentFactory.xContent(queryBuilder.source()).createParser(queryBuilder.source())){
    final QueryShardContext contextCopy=new QueryShardContext(context.index(),context.indexQueryParserService());
    contextCopy.reset(qSourceParser);
    QueryBuilder<?> innerQuery=contextCopy.parseContext().parseInnerQueryBuilder();
    Query expected=innerQuery.toQuery(context);
    if (expected != null && queryBuilder.boost() != AbstractQueryBuilder.DEFAULT_BOOST) {
      expected.setBoost(queryBuilder.boost());
    }
    assertThat(query,equalTo(expected));
  }
 }
