{
  boolean parent=context.docMapper().isParent(context.type());
  if (parent && hasDocValues()) {
    fields.add(createJoinField(context.type(),context.id()));
  }
  if (!active()) {
    return;
  }
  if (context.parser().currentName() != null && context.parser().currentName().equals(Defaults.NAME)) {
    String parentId=context.parser().text();
    context.sourceToParse().parent(parentId);
    fields.add(new Field(names.indexName(),Uid.createUid(context.stringBuilder(),type,parentId),fieldType));
    if (hasDocValues()) {
      fields.add(createJoinField(type,parentId));
    }
  }
 else {
    String parsedParentId=context.doc().get(Defaults.NAME);
    if (context.sourceToParse().parent() != null) {
      String parentId=context.sourceToParse().parent();
      if (parsedParentId == null) {
        if (parentId == null) {
          throw new MapperParsingException("No parent id provided, not within the document, and not externally");
        }
        fields.add(new Field(names.indexName(),Uid.createUid(context.stringBuilder(),type,parentId),fieldType));
        if (hasDocValues()) {
          fields.add(createJoinField(type,parentId));
        }
      }
 else       if (parentId != null && !parsedParentId.equals(Uid.createUid(context.stringBuilder(),type,parentId))) {
        throw new MapperParsingException("Parent id mismatch, document value is [" + Uid.createUid(parsedParentId).id() + "], while external value is ["+ parentId+ "]");
      }
    }
  }
}
