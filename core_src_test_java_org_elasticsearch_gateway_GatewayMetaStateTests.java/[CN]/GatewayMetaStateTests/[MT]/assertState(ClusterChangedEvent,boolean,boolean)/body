{
  MetaData inMemoryMetaData=null;
  ImmutableSet<String> oldIndicesList=ImmutableSet.of();
  if (stateInMemory) {
    inMemoryMetaData=event.previousState().metaData();
    ImmutableSet.Builder<String> relevantIndices=ImmutableSet.builder();
    oldIndicesList=relevantIndices.addAll(GatewayMetaState.getRelevantIndices(event.previousState(),event.previousState(),oldIndicesList)).build();
  }
  Set<String> newIndicesList=GatewayMetaState.getRelevantIndices(event.state(),event.previousState(),oldIndicesList);
  Iterator<GatewayMetaState.IndexMetaWriteInfo> indices=GatewayMetaState.resolveStatesToBeWritten(oldIndicesList,newIndicesList,inMemoryMetaData,event.state().metaData()).iterator();
  if (expectMetaData) {
    assertThat(indices.hasNext(),equalTo(true));
    assertThat(indices.next().getNewMetaData().index(),equalTo("test"));
    assertThat(indices.hasNext(),equalTo(false));
  }
 else {
    assertThat(indices.hasNext(),equalTo(false));
  }
}
