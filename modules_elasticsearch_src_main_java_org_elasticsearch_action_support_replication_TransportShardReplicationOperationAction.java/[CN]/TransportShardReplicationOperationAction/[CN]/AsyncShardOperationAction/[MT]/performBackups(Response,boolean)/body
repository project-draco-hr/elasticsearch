{
  if (ignoreBackups() || shards.size() == 1) {
    if (alreadyThreaded || !request.listenerThreaded()) {
      listener.onResponse(response);
    }
 else {
      threadPool.execute(new Runnable(){
        @Override public void run(){
          listener.onResponse(response);
        }
      }
);
    }
    return;
  }
  int backupCounter=0;
  if (replicationType == ReplicationType.ASYNC) {
    if (alreadyThreaded || !request.listenerThreaded()) {
      listener.onResponse(response);
    }
 else {
      threadPool.execute(new Runnable(){
        @Override public void run(){
          listener.onResponse(response);
        }
      }
);
    }
    backupCounter=-100;
  }
  for (  final ShardRouting shard : shards.reset()) {
    if (shard.primary()) {
      continue;
    }
    backupCounter++;
    if (shard.relocating()) {
      backupCounter++;
    }
  }
  AtomicInteger counter=new AtomicInteger(backupCounter);
  for (  final ShardRouting shard : shards.reset()) {
    if (shard.primary()) {
      continue;
    }
    if (shard.unassigned() || !nodes.nodeExists(shard.currentNodeId())) {
      if (counter.decrementAndGet() == 0) {
        if (alreadyThreaded || !request.listenerThreaded()) {
          listener.onResponse(response);
        }
 else {
          threadPool.execute(new Runnable(){
            @Override public void run(){
              listener.onResponse(response);
            }
          }
);
        }
        break;
      }
      continue;
    }
    performOnBackup(response,counter,shard,shard.currentNodeId());
    if (shard.relocating()) {
      performOnBackup(response,counter,shard,shard.relocatingNodeId());
    }
  }
}
