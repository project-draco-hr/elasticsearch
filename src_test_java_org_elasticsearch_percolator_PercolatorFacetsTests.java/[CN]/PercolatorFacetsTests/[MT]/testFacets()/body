{
  client().admin().indices().prepareCreate("test").execute().actionGet();
  ensureGreen();
  int numQueries=atLeast(250);
  int numUniqueQueries=between(1,numQueries / 2);
  String[] values=new String[numUniqueQueries];
  for (int i=0; i < values.length; i++) {
    values[i]="value" + i;
  }
  int[] expectedCount=new int[numUniqueQueries];
  logger.info("--> registering {} queries",numQueries);
  for (int i=0; i < numQueries; i++) {
    String value=values[i % numUniqueQueries];
    expectedCount[i % numUniqueQueries]++;
    QueryBuilder queryBuilder=matchQuery("field1",value);
    client().prepareIndex("test",PercolatorService.TYPE_NAME,Integer.toString(i)).setSource(jsonBuilder().startObject().field("query",queryBuilder).field("field2","b").endObject()).execute().actionGet();
  }
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  for (int i=0; i < numQueries; i++) {
    String value=values[i % numUniqueQueries];
    PercolateRequestBuilder percolateRequestBuilder=client().preparePercolate().setIndices("test").setDocumentType("type").setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().field("field1",value).endObject())).addFacet(FacetBuilders.termsFacet("a").field("field2"));
    if (randomBoolean()) {
      percolateRequestBuilder.setPercolateQuery(matchAllQuery());
    }
    if (randomBoolean()) {
      percolateRequestBuilder.setScore(true);
    }
 else {
      percolateRequestBuilder.setSort(true).setSize(numQueries);
    }
    boolean countOnly=randomBoolean();
    if (countOnly) {
      percolateRequestBuilder.setOnlyCount(countOnly);
    }
    PercolateResponse response=percolateRequestBuilder.execute().actionGet();
    assertMatchCount(response,expectedCount[i % numUniqueQueries]);
    if (!countOnly) {
      assertThat(response.getMatches(),arrayWithSize(expectedCount[i % numUniqueQueries]));
    }
    assertThat(response.getFacets().facets().size(),equalTo(1));
    assertThat(response.getFacets().facets().get(0).getName(),equalTo("a"));
    assertThat(((TermsFacet)response.getFacets().facets().get(0)).getEntries().size(),equalTo(1));
    assertThat(((TermsFacet)response.getFacets().facets().get(0)).getEntries().get(0).getCount(),equalTo(expectedCount[i % values.length]));
    assertThat(((TermsFacet)response.getFacets().facets().get(0)).getEntries().get(0).getTerm().string(),equalTo("b"));
  }
}
