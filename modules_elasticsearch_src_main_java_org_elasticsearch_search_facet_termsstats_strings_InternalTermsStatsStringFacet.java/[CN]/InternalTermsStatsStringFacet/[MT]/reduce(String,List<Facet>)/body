{
  if (facets.size() == 1) {
    if (requiredSize == 0) {
      InternalTermsStatsStringFacet tsFacet=(InternalTermsStatsStringFacet)facets.get(0);
      if (!tsFacet.entries.isEmpty()) {
        List<StringEntry> entries=tsFacet.mutableList();
        Collections.sort(entries,comparatorType.comparator());
      }
    }
    return facets.get(0);
  }
  int missing=0;
  ExtTHashMap<String,StringEntry> map=CacheRecycler.popHashMap();
  for (  Facet facet : facets) {
    InternalTermsStatsStringFacet tsFacet=(InternalTermsStatsStringFacet)facet;
    missing+=tsFacet.missing;
    for (    Entry entry : tsFacet) {
      StringEntry stringEntry=(StringEntry)entry;
      StringEntry current=map.get(stringEntry.term());
      if (current != null) {
        current.count+=stringEntry.count;
        current.totalCount+=stringEntry.totalCount;
        current.total+=stringEntry.total;
        if (stringEntry.min < current.min) {
          current.min=stringEntry.min;
        }
        if (stringEntry.max > current.max) {
          current.max=stringEntry.max;
        }
      }
 else {
        map.put(stringEntry.term(),stringEntry);
      }
    }
  }
  if (requiredSize == 0) {
    StringEntry[] entries1=map.values().toArray(new StringEntry[map.size()]);
    Arrays.sort(entries1,comparatorType.comparator());
    CacheRecycler.pushHashMap(map);
    return new InternalTermsStatsStringFacet(name,comparatorType,requiredSize,Arrays.asList(entries1),missing);
  }
 else {
    Object[] values=map.internalValues();
    Arrays.sort(values,(Comparator)comparatorType.comparator());
    List<StringEntry> ordered=new ArrayList<StringEntry>(map.size());
    for (int i=0; i < requiredSize; i++) {
      StringEntry value=(StringEntry)values[i];
      if (value == null) {
        break;
      }
      ordered.add(value);
    }
    CacheRecycler.pushHashMap(map);
    return new InternalTermsStatsStringFacet(name,comparatorType,requiredSize,ordered,missing);
  }
}
