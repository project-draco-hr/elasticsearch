{
  client.admin().indices().prepareDelete().execute().actionGet();
  String mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("locations").field("type","geo_point").field("lat_lon",true).endObject().endObject().endObject().endObject().string();
  client.admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",1).put("index.number_of_replicas",0)).addMapping("type1",mapping).execute().actionGet();
  client.admin().cluster().prepareHealth("test").setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  client.prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("names","New York").startObject("locations").field("lat",40.7143528).field("lon",-74.0059731).endObject().endObject()).execute().actionGet();
  client.prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().field("names","Times Square","Tribeca").startArray("locations").startObject().field("lat",40.759011).field("lon",-73.9844722).endObject().startObject().field("lat",40.718266).field("lon",-74.007819).endObject().endArray().endObject()).execute().actionGet();
  client.prepareIndex("test","type1","3").setSource(jsonBuilder().startObject().field("names","Wall Street","Soho").startArray("locations").startObject().field("lat",40.7051157).field("lon",-74.0088305).endObject().startObject().field("lat",40.7247222).field("lon",-74).endObject().endArray().endObject()).execute().actionGet();
  client.prepareIndex("test","type1","4").setSource(jsonBuilder().startObject().field("names","Greenwich Village","Brooklyn").startArray("locations").startObject().field("lat",40.731033).field("lon",-73.9962255).endObject().startObject().field("lat",40.65).field("lon",-73.95).endObject().endArray().endObject()).execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch("test").setQuery(matchAllQuery()).addSort(SortBuilders.geoDistanceSort("locations").point(40.7143528,-74.0059731).order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().hits().length,equalTo(4));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
  assertThat(((Number)searchResponse.getHits().getAt(0).sortValues()[0]).doubleValue(),equalTo(0d));
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("2"));
  assertThat(((Number)searchResponse.getHits().getAt(1).sortValues()[0]).doubleValue(),closeTo(0.4621d,0.01d));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("3"));
  assertThat(((Number)searchResponse.getHits().getAt(2).sortValues()[0]).doubleValue(),closeTo(1.055d,0.01d));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("4"));
  assertThat(((Number)searchResponse.getHits().getAt(3).sortValues()[0]).doubleValue(),closeTo(2.029d,0.01d));
  searchResponse=client.prepareSearch("test").setQuery(matchAllQuery()).addSort(SortBuilders.geoDistanceSort("locations").point(40.7143528,-74.0059731).order(SortOrder.ASC).sortMode("max")).execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().hits().length,equalTo(4));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
  assertThat(((Number)searchResponse.getHits().getAt(0).sortValues()[0]).doubleValue(),equalTo(0d));
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("3"));
  assertThat(((Number)searchResponse.getHits().getAt(1).sortValues()[0]).doubleValue(),closeTo(1.258d,0.01d));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("2"));
  assertThat(((Number)searchResponse.getHits().getAt(2).sortValues()[0]).doubleValue(),closeTo(5.286d,0.01d));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("4"));
  assertThat(((Number)searchResponse.getHits().getAt(3).sortValues()[0]).doubleValue(),closeTo(8.572d,0.01d));
  searchResponse=client.prepareSearch("test").setQuery(matchAllQuery()).addSort(SortBuilders.geoDistanceSort("locations").point(40.7143528,-74.0059731).order(SortOrder.DESC)).execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().hits().length,equalTo(4));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("4"));
  assertThat(((Number)searchResponse.getHits().getAt(0).sortValues()[0]).doubleValue(),closeTo(8.572d,0.01d));
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("2"));
  assertThat(((Number)searchResponse.getHits().getAt(1).sortValues()[0]).doubleValue(),closeTo(5.286d,0.01d));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("3"));
  assertThat(((Number)searchResponse.getHits().getAt(2).sortValues()[0]).doubleValue(),closeTo(1.258d,0.01d));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("1"));
  assertThat(((Number)searchResponse.getHits().getAt(3).sortValues()[0]).doubleValue(),equalTo(0d));
  searchResponse=client.prepareSearch("test").setQuery(matchAllQuery()).addSort(SortBuilders.geoDistanceSort("locations").point(40.7143528,-74.0059731).order(SortOrder.DESC).sortMode("min")).execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().hits().length,equalTo(4));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("4"));
  assertThat(((Number)searchResponse.getHits().getAt(0).sortValues()[0]).doubleValue(),closeTo(2.029d,0.01d));
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("3"));
  assertThat(((Number)searchResponse.getHits().getAt(1).sortValues()[0]).doubleValue(),closeTo(1.055d,0.01d));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("2"));
  assertThat(((Number)searchResponse.getHits().getAt(2).sortValues()[0]).doubleValue(),closeTo(0.4621d,0.01d));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("1"));
  assertThat(((Number)searchResponse.getHits().getAt(3).sortValues()[0]).doubleValue(),equalTo(0d));
}
