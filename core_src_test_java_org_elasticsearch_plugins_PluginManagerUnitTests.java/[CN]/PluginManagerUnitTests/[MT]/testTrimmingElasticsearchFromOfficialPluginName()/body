{
  String randomPluginName=randomFrom(PluginManager.OFFICIAL_PLUGINS.asList()).replaceFirst("elasticsearch-","");
  PluginManager.PluginHandle handle=PluginManager.PluginHandle.parse(randomPluginName);
  assertThat(handle.name,is(randomPluginName.replaceAll("^elasticsearch-","")));
  boolean supportStagingUrls=randomBoolean();
  if (supportStagingUrls) {
    System.setProperty(PluginManager.PROPERTY_SUPPORT_STAGING_URLS,"true");
  }
  Iterator<URL> iterator=handle.urls().iterator();
  if (supportStagingUrls) {
    String expectedStagingUrl=String.format(Locale.ROOT,"http://download.elastic.co/elasticsearch/staging/elasticsearch-%s-%s/org/elasticsearch/plugin/elasticsearch-%s/%s/elasticsearch-%s-%s.zip",Version.CURRENT.number(),Build.CURRENT.hashShort(),randomPluginName,Version.CURRENT.number(),randomPluginName,Version.CURRENT.number());
    assertThat(iterator.next(),is(new URL(expectedStagingUrl)));
  }
  String releaseUrl=String.format(Locale.ROOT,"http://download.elastic.co/elasticsearch/release/org/elasticsearch/plugin/elasticsearch-%s/%s/elasticsearch-%s-%s.zip",randomPluginName,Version.CURRENT.number(),randomPluginName,Version.CURRENT.number());
  assertThat(iterator.next(),is(new URL(releaseUrl)));
  assertThat(iterator.hasNext(),is(false));
}
