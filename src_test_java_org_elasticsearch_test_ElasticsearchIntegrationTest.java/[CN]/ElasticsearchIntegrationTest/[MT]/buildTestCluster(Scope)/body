{
  long currentClusterSeed=randomLong();
  int numNodes=getNumNodes();
  NodeSettingsSource nodeSettingsSource;
  if (numNodes > 0) {
    NodeSettingsSource.Immutable.Builder nodesSettings=NodeSettingsSource.Immutable.builder();
    for (int i=0; i < numNodes; i++) {
      nodesSettings.set(i,nodeSettings(i));
    }
    nodeSettingsSource=nodesSettings.build();
  }
 else {
    nodeSettingsSource=new NodeSettingsSource(){
      @Override public Settings settings(      int nodeOrdinal){
        return nodeSettings(nodeOrdinal);
      }
    }
;
  }
  int minNumNodes, maxNumNodes;
  if (numNodes >= 0) {
    minNumNodes=maxNumNodes=numNodes;
  }
 else {
    minNumNodes=getMinNumNodes();
    maxNumNodes=getMaxNumNodes();
  }
  return new TestCluster(currentClusterSeed,minNumNodes,maxNumNodes,clusterName(scope.name(),ElasticsearchTestCase.CHILD_VM_ID,currentClusterSeed),nodeSettingsSource);
}
