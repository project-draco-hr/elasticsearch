{
  if (cluster().size() > 0) {
    ImmutableSettings.Builder randomSettingsBuilder=setRandomSettings(getRandom(),ImmutableSettings.builder()).put(SETTING_INDEX_SEED,getRandom().nextLong());
    randomSettingsBuilder.put(SETTING_NUMBER_OF_SHARDS,numberOfShards()).put(SETTING_NUMBER_OF_REPLICAS,numberOfReplicas());
    XContentBuilder mappings=null;
    if (frequently() && randomDynamicTemplates()) {
      mappings=XContentFactory.jsonBuilder().startObject().startObject("_default_");
      if (randomBoolean()) {
        mappings.startObject(IdFieldMapper.NAME).field("index",randomFrom("not_analyzed","no")).endObject();
      }
      if (randomBoolean()) {
        mappings.startObject(TypeFieldMapper.NAME).field("index",randomFrom("no","not_analyzed")).endObject();
      }
      if (randomBoolean()) {
        mappings.startObject(TimestampFieldMapper.NAME).field("enabled",randomBoolean()).startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("array","doc_values")).endObject().endObject();
      }
      if (randomBoolean()) {
        mappings.startObject(SizeFieldMapper.NAME).field("enabled",randomBoolean()).endObject();
      }
      if (randomBoolean()) {
        mappings.startObject(AllFieldMapper.NAME).field("auto_boost",true).endObject();
      }
      if (randomBoolean()) {
        mappings.startObject(SourceFieldMapper.NAME).field("compress",randomBoolean()).endObject();
      }
      if (compatibilityVersion().onOrAfter(Version.V_1_3_0)) {
        mappings.startObject(FieldNamesFieldMapper.NAME).startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("paged_bytes","fst","doc_values")).endObject().endObject();
      }
      mappings.startArray("dynamic_templates").startObject().startObject("template-strings").field("match_mapping_type","string").startObject("mapping").startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("paged_bytes","fst")).field(Loading.KEY,randomLoadingValues()).endObject().endObject().endObject().endObject().startObject().startObject("template-longs").field("match_mapping_type","long").startObject("mapping").startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("array","doc_values")).field(Loading.KEY,randomFrom(Loading.LAZY,Loading.EAGER)).endObject().endObject().endObject().endObject().startObject().startObject("template-doubles").field("match_mapping_type","double").startObject("mapping").startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("array","doc_values")).field(Loading.KEY,randomFrom(Loading.LAZY,Loading.EAGER)).endObject().endObject().endObject().endObject().startObject().startObject("template-geo_points").field("match_mapping_type","geo_point").startObject("mapping").startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("array","doc_values")).field(Loading.KEY,randomFrom(Loading.LAZY,Loading.EAGER)).endObject().endObject().endObject().endObject().endArray();
      mappings.endObject().endObject();
    }
    PutIndexTemplateRequestBuilder putTemplate=client().admin().indices().preparePutTemplate("random_index_template").setTemplate("*").setOrder(0).setSettings(randomSettingsBuilder);
    if (mappings != null) {
      putTemplate.addMapping("_default_",mappings);
    }
    assertAcked(putTemplate.execute().actionGet());
  }
}
