{
  final long[] lastKnownCount={-1};
  long lastStartCount=-1;
  Predicate<Object> testDocs=new Predicate<Object>(){
    @Override public boolean apply(    Object o){
      lastKnownCount[0]=indexer.totalIndexedDocs();
      if (lastKnownCount[0] >= numDocs) {
        long count=client().prepareCount().setQuery(matchAllQuery()).execute().actionGet().getCount();
        if (count == lastKnownCount[0]) {
          client().admin().indices().prepareRefresh().get();
        }
        lastKnownCount[0]=count;
        logger.debug("[{}] docs visible for search. waiting for [{}]",lastKnownCount[0],numDocs);
      }
 else {
        logger.debug("[{}] docs indexed. waiting for [{}]",lastKnownCount[0],numDocs);
      }
      return lastKnownCount[0] >= numDocs;
    }
  }
;
  while (!awaitBusy(testDocs,maxWaitTime,maxWaitTimeUnit)) {
    if (lastStartCount == lastKnownCount[0]) {
      fail("failed to reach " + numDocs + "docs");
    }
    lastStartCount=lastKnownCount[0];
  }
  return lastKnownCount[0];
}
