{
  if (cluster() != null) {
    boolean getResolvedAddress=InetSocketTransportAddress.getResolveAddress();
    try {
      InetSocketTransportAddress.setResolveAddress(false);
      ClusterState masterClusterState=client().admin().cluster().prepareState().all().get().getState();
      byte[] masterClusterStateBytes=ClusterState.Builder.toBytes(masterClusterState);
      masterClusterState=ClusterState.Builder.fromBytes(masterClusterStateBytes,null);
      Map<String,Object> masterStateMap=convertToMap(masterClusterState);
      int masterClusterStateSize=ClusterState.Builder.toBytes(masterClusterState).length;
      for (      Client client : cluster()) {
        ClusterState localClusterState=client.admin().cluster().prepareState().all().setLocal(true).get().getState();
        byte[] localClusterStateBytes=ClusterState.Builder.toBytes(localClusterState);
        localClusterState=ClusterState.Builder.fromBytes(localClusterStateBytes,null);
        Map<String,Object> localStateMap=convertToMap(localClusterState);
        int localClusterStateSize=localClusterStateBytes.length;
        if (masterClusterState.version() == localClusterState.version()) {
          try {
            assertThat(masterClusterState.uuid(),equalTo(localClusterState.uuid()));
            assertThat(masterClusterStateSize,equalTo(localClusterStateSize));
            assertThat(mapsEqualIgnoringArrayOrder(masterStateMap,localStateMap),equalTo(true));
          }
 catch (          AssertionError error) {
            logger.error("Cluster state from master:\n{}\nLocal cluster state:\n{}",masterClusterState.toString(),localClusterState.toString());
            throw error;
          }
        }
      }
    }
  finally {
      InetSocketTransportAddress.setResolveAddress(getResolvedAddress);
    }
  }
}
