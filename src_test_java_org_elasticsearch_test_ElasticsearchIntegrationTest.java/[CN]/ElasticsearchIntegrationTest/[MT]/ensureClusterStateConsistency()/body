{
  if (cluster() != null) {
    ClusterState masterClusterState=client().admin().cluster().prepareState().all().get().getState();
    Map<String,Object> masterStateMap=convertToMap(masterClusterState);
    int masterClusterStateSize=ClusterState.Builder.toBytes(masterClusterState).length;
    for (    Client client : cluster()) {
      ClusterState localClusterState=client.admin().cluster().prepareState().all().setLocal(true).get().getState();
      if (masterClusterState.version() == localClusterState.version()) {
        try {
          assertThat(masterClusterState.uuid(),equalTo(localClusterState.uuid()));
          int localClusterStateSize=ClusterState.Builder.toBytes(localClusterState).length;
          assertThat(masterClusterStateSize,equalTo(localClusterStateSize));
          assertThat(mapsEqualIgnoringArrayOrder(masterStateMap,convertToMap(localClusterState)),equalTo(true));
        }
 catch (        AssertionError error) {
          logger.error("Cluster state from master:\n{}\nLocal cluster state:\n{}",masterClusterState.toString(),localClusterState.toString());
          throw error;
        }
      }
    }
  }
}
