{
  Settings commonSettings=ImmutableSettings.settingsBuilder().put("cluster.routing.allocation.awareness.force.zone.values","a,b").put("cluster.routing.allocation.awareness.attributes","zone").build();
  logger.info("--> starting 6 nodes on different zones");
  startNode("A-0",ImmutableSettings.settingsBuilder().put(commonSettings).put("node.zone","a"));
  startNode("B-0",ImmutableSettings.settingsBuilder().put(commonSettings).put("node.zone","b"));
  startNode("B-1",ImmutableSettings.settingsBuilder().put(commonSettings).put("node.zone","b"));
  startNode("A-1",ImmutableSettings.settingsBuilder().put(commonSettings).put("node.zone","a"));
  client().admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",5).put("index.number_of_replicas",1)).execute().actionGet();
  ClusterHealthResponse health=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().setWaitForNodes("4").setWaitForRelocatingShards(0).execute().actionGet();
  assertThat(health.isTimedOut(),equalTo(false));
  ClusterState clusterState=client().admin().cluster().prepareState().execute().actionGet().getState();
  TObjectIntHashMap<String> counts=new TObjectIntHashMap<String>();
  for (  IndexRoutingTable indexRoutingTable : clusterState.routingTable()) {
    for (    IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {
      for (      ShardRouting shardRouting : indexShardRoutingTable) {
        counts.adjustOrPutValue(clusterState.nodes().get(shardRouting.currentNodeId()).name(),1,1);
      }
    }
  }
  assertThat(counts.get("A-1"),anyOf(equalTo(2),equalTo(3)));
  assertThat(counts.get("B-1"),anyOf(equalTo(2),equalTo(3)));
  assertThat(counts.get("A-0"),anyOf(equalTo(2),equalTo(3)));
  assertThat(counts.get("B-0"),anyOf(equalTo(2),equalTo(3)));
}
