{
  Settings commonSettings=ImmutableSettings.settingsBuilder().put("cluster.routing.schedule","10ms").put("cluster.routing.allocation.awareness.attributes","rack_id").build();
  logger.info("--> starting 2 nodes on the same rack");
  cluster().startNode(ImmutableSettings.settingsBuilder().put(commonSettings).put("node.rack_id","rack_1").build());
  cluster().startNode(ImmutableSettings.settingsBuilder().put(commonSettings).put("node.rack_id","rack_1").build());
  createIndex("test1");
  createIndex("test2");
  ClusterHealthResponse health=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  assertThat(health.isTimedOut(),equalTo(false));
  logger.info("--> starting 1 node on a different rack");
  String node3=cluster().startNode(ImmutableSettings.settingsBuilder().put(commonSettings).put("node.rack_id","rack_2").build());
  long start=System.currentTimeMillis();
  TObjectIntHashMap<String> counts;
  do {
    Thread.sleep(100);
    logger.info("--> waiting for no relocation");
    health=client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().setWaitForNodes("3").setWaitForRelocatingShards(0).execute().actionGet();
    assertThat(health.isTimedOut(),equalTo(false));
    logger.info("--> checking current state");
    ClusterState clusterState=client().admin().cluster().prepareState().execute().actionGet().getState();
    counts=new TObjectIntHashMap<String>();
    for (    IndexRoutingTable indexRoutingTable : clusterState.routingTable()) {
      for (      IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {
        for (        ShardRouting shardRouting : indexShardRoutingTable) {
          counts.adjustOrPutValue(clusterState.nodes().get(shardRouting.currentNodeId()).name(),1,1);
        }
      }
    }
  }
 while (counts.get(node3) != 10 && (System.currentTimeMillis() - start) < 10000);
  assertThat(counts.get(node3),equalTo(10));
}
