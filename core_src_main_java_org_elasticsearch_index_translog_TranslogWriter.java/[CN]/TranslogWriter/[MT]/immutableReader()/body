{
  ensureOpen();
  if (channelReference.tryIncRef()) {
    try (ReleasableLock lock=writeLock.acquire()){
      flush();
      ImmutableTranslogReader reader=new ImmutableTranslogReader(this.generation,channelReference,firstOperationOffset,writtenOffset,operationCounter);
      channelReference.incRef();
      return reader;
    }
 catch (    Exception e) {
      throw new TranslogException(shardId,"exception while creating an immutable reader",e);
    }
 finally {
      channelReference.decRef();
    }
  }
 else {
    throw new TranslogException(shardId,"can't increment channel [" + channelReference + "] ref count");
  }
}
