{
  if (syncNeeded()) {
synchronized (this) {
      ensureOpen();
      channelReference.incRef();
      try {
        final long offsetToSync;
        final int opsCounter;
        outputStream.flush();
        offsetToSync=totalOffset;
        opsCounter=operationCounter;
        ensureOpen();
        try {
          checkpoint(offsetToSync,opsCounter,channelReference);
        }
 catch (        Throwable ex) {
          closeWithTragicEvent(ex);
          throw ex;
        }
        lastSyncedOffset=offsetToSync;
      }
  finally {
        channelReference.decRef();
      }
    }
  }
}
