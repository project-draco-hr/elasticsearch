{
  Map<String,TestDiffable> before=new HashMap<>();
  before.put("foo",new TestDiffable("1"));
  before.put("bar",new TestDiffable("2"));
  before.put("baz",new TestDiffable("3"));
  before=unmodifiableMap(before);
  Map<String,TestDiffable> map=new HashMap<>();
  map.putAll(before);
  map.remove("bar");
  map.put("baz",new TestDiffable("4"));
  map.put("new",new TestDiffable("5"));
  Map<String,TestDiffable> after=unmodifiableMap(new HashMap<>(map));
  Diff diff=DiffableUtils.diff(before,after);
  BytesStreamOutput out=new BytesStreamOutput();
  diff.writeTo(out);
  StreamInput in=StreamInput.wrap(out.bytes());
  Map<String,TestDiffable> serialized=DiffableUtils.readJdkMapDiff(in,TestDiffable.PROTO).apply(before);
  assertThat(serialized.size(),equalTo(3));
  assertThat(serialized.get("foo").value(),equalTo("1"));
  assertThat(serialized.get("baz").value(),equalTo("4"));
  assertThat(serialized.get("new").value(),equalTo("5"));
}
