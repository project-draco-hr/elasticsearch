{
  try {
    DocumentMapperParser mapperParser=MapperTestUtils.newMapperService(createTempDir(),Settings.builder().put("index.mapping.attachment.ignore_errors",false).build()).documentMapperParser();
    String mapping=copyToStringFromClasspath("/org/elasticsearch/index/mapper/attachment/test/unit/encrypted/test-mapping.json");
    DocumentMapper docMapper=mapperParser.parse(mapping);
    byte[] html=copyToBytesFromClasspath("/org/elasticsearch/index/mapper/attachment/test/sample-files/htmlWithValidDateMeta.html");
    byte[] pdf=copyToBytesFromClasspath("/org/elasticsearch/index/mapper/attachment/test/sample-files/encrypted.pdf");
    BytesReference json=jsonBuilder().startObject().field("file1",pdf).field("file2",html).endObject().bytes();
    docMapper.parse("person","person","1",json);
    fail("Expected doc parsing exception");
  }
 catch (  MapperParsingException e) {
    if (e.getMessage() == null || e.getMessage().contains("is encrypted") == false) {
      throw e;
    }
  }
}
