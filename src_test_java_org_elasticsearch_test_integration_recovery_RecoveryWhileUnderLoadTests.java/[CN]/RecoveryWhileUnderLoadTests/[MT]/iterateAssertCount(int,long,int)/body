{
  CountResponse[] iterationResults=new CountResponse[iterations];
  boolean error=false;
  for (int i=0; i < iterations; i++) {
    CountResponse countResponse=client().prepareCount().setQuery(matchAllQuery()).execute().actionGet();
    logCountResponse(numberOfShards,numberOfDocs,i,countResponse);
    iterationResults[i]=countResponse;
    if (countResponse.getCount() != numberOfDocs) {
      error=true;
    }
  }
  if (error) {
    logger.info("--> refreshing again");
    refresh();
    for (int i=0; i < iterations; i++) {
      CountResponse countResponse=client().prepareCount().setQuery(matchAllQuery()).execute().actionGet();
      logCountResponse(numberOfShards,numberOfDocs,i,countResponse);
    }
  }
  for (int i=0; i < iterations; i++) {
    assertHitCount(iterationResults[i],numberOfDocs);
  }
}
