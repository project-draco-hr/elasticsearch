{
  try {
    if (lifecycle.stopped()) {
      return;
    }
    if (rerouting.compareAndSet(false,true) == false) {
      logger.trace("already has pending reroute, ignoring {}",reason);
      return;
    }
    logger.trace("rerouting {}",reason);
    clusterService.submitStateUpdateTask(CLUSTER_UPDATE_TASK_SOURCE + "(" + reason+ ")",new ClusterStateUpdateTask(Priority.HIGH){
      @Override public ClusterState execute(      ClusterState currentState){
        rerouting.set(false);
        RoutingAllocation.Result routingResult=allocationService.reroute(currentState,reason);
        if (!routingResult.changed()) {
          return currentState;
        }
        return ClusterState.builder(currentState).routingResult(routingResult).build();
      }
      @Override public void onNoLongerMaster(      String source){
        rerouting.set(false);
      }
      @Override public void onFailure(      String source,      Exception e){
        rerouting.set(false);
        ClusterState state=clusterService.state();
        if (logger.isTraceEnabled()) {
          logger.error("unexpected failure during [{}], current state:\n{}",e,source,state.prettyPrint());
        }
 else {
          logger.error("unexpected failure during [{}], current state version [{}]",e,source,state.version());
        }
      }
    }
);
  }
 catch (  Exception e) {
    rerouting.set(false);
    ClusterState state=clusterService.state();
    logger.warn("failed to reroute routing table, current state:\n{}",e,state.prettyPrint());
  }
}
