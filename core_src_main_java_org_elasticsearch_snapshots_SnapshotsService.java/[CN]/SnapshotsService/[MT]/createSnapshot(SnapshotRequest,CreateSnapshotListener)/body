{
  final SnapshotId snapshotId=new SnapshotId(request.repository(),request.name());
  validate(snapshotId);
  clusterService.submitStateUpdateTask(request.cause(),new ClusterStateUpdateTask(){
    private SnapshotsInProgress.Entry newSnapshot=null;
    @Override public ClusterState execute(    ClusterState currentState){
      validate(request,currentState);
      SnapshotsInProgress snapshots=currentState.custom(SnapshotsInProgress.TYPE);
      if (snapshots == null || snapshots.entries().isEmpty()) {
        List<String> indices=Arrays.asList(indexNameExpressionResolver.concreteIndices(currentState,request.indicesOptions(),request.indices()));
        logger.trace("[{}][{}] creating snapshot for indices [{}]",request.repository(),request.name(),indices);
        newSnapshot=new SnapshotsInProgress.Entry(snapshotId,request.includeGlobalState(),State.INIT,indices,System.currentTimeMillis(),null);
        snapshots=new SnapshotsInProgress(newSnapshot);
      }
 else {
        throw new ConcurrentSnapshotExecutionException(snapshotId,"a snapshot is already running");
      }
      return ClusterState.builder(currentState).putCustom(SnapshotsInProgress.TYPE,snapshots).build();
    }
    @Override public void onFailure(    String source,    Throwable t){
      logger.warn("[{}][{}] failed to create snapshot",t,request.repository(),request.name());
      newSnapshot=null;
      listener.onFailure(t);
    }
    @Override public void clusterStateProcessed(    String source,    ClusterState oldState,    final ClusterState newState){
      if (newSnapshot != null) {
        threadPool.executor(ThreadPool.Names.SNAPSHOT).execute(new Runnable(){
          @Override public void run(){
            beginSnapshot(newState,newSnapshot,request.partial,listener);
          }
        }
);
      }
    }
    @Override public TimeValue timeout(){
      return request.masterNodeTimeout();
    }
  }
);
}
