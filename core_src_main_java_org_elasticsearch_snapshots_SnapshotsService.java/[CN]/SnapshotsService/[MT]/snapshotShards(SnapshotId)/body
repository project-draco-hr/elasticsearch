{
  validate(snapshotId);
  Map<ShardId,IndexShardSnapshotStatus> shardStatus=new HashMap<>();
  Repository repository=repositoriesService.repository(snapshotId.getRepository());
  IndexShardRepository indexShardRepository=repositoriesService.indexShardRepository(snapshotId.getRepository());
  Snapshot snapshot=repository.readSnapshot(snapshotId);
  MetaData metaData=repository.readSnapshotMetaData(snapshotId,snapshot,snapshot.indices());
  for (  String index : snapshot.indices()) {
    IndexMetaData indexMetaData=metaData.indices().get(index);
    if (indexMetaData != null) {
      int numberOfShards=indexMetaData.getNumberOfShards();
      for (int i=0; i < numberOfShards; i++) {
        ShardId shardId=new ShardId(indexMetaData.getIndex(),i);
        SnapshotShardFailure shardFailure=findShardFailure(snapshot.shardFailures(),shardId);
        if (shardFailure != null) {
          IndexShardSnapshotStatus shardSnapshotStatus=new IndexShardSnapshotStatus();
          shardSnapshotStatus.updateStage(IndexShardSnapshotStatus.Stage.FAILURE);
          shardSnapshotStatus.failure(shardFailure.reason());
          shardStatus.put(shardId,shardSnapshotStatus);
        }
 else {
          IndexShardSnapshotStatus shardSnapshotStatus=indexShardRepository.snapshotStatus(snapshotId,snapshot.version(),shardId);
          shardStatus.put(shardId,shardSnapshotStatus);
        }
      }
    }
  }
  return unmodifiableMap(shardStatus);
}
