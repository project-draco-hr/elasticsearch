{
  SnapshotsInProgress snapshots=currentState.custom(SnapshotsInProgress.TYPE);
  Set<String> indicesToFail=null;
  if (snapshots != null) {
    for (    final SnapshotsInProgress.Entry entry : snapshots.entries()) {
      if (entry.partial() == false) {
        if (entry.state() == State.INIT) {
          for (          String index : entry.indices()) {
            if (indices.contains(index)) {
              if (indicesToFail == null) {
                indicesToFail=new HashSet<>();
              }
              indicesToFail.add(index);
            }
          }
        }
 else {
          for (          ObjectObjectCursor<ShardId,SnapshotsInProgress.ShardSnapshotStatus> shard : entry.shards()) {
            if (!shard.value.state().completed()) {
              if (indices.contains(shard.key.getIndexName())) {
                if (indicesToFail == null) {
                  indicesToFail=new HashSet<>();
                }
                indicesToFail.add(shard.key.getIndexName());
              }
            }
          }
        }
      }
    }
  }
  return indicesToFail;
}
