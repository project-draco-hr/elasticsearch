{
  threadPool.executor(ThreadPool.Names.SNAPSHOT).execute(new Runnable(){
    @Override public void run(){
      SnapshotId snapshotId=entry.snapshotId();
      try {
        final Repository repository=repositoriesService.repository(snapshotId.getRepository());
        logger.trace("[{}] finalizing snapshot in repository, state: [{}], failure[{}]",snapshotId,entry.state(),failure);
        ArrayList<ShardSearchFailure> failures=newArrayList();
        ArrayList<SnapshotShardFailure> shardFailures=newArrayList();
        for (        Map.Entry<ShardId,ShardSnapshotStatus> shardStatus : entry.shards().entrySet()) {
          ShardId shardId=shardStatus.getKey();
          ShardSnapshotStatus status=shardStatus.getValue();
          if (status.state().failed()) {
            failures.add(new ShardSearchFailure(status.reason(),new SearchShardTarget(status.nodeId(),shardId.getIndex(),shardId.id())));
            shardFailures.add(new SnapshotShardFailure(status.nodeId(),shardId.getIndex(),shardId.id(),status.reason()));
          }
        }
        Snapshot snapshot=repository.finalizeSnapshot(snapshotId,entry.indices(),entry.startTime(),failure,entry.shards().size(),ImmutableList.copyOf(shardFailures));
        removeSnapshotFromClusterState(snapshotId,new SnapshotInfo(snapshot),null);
      }
 catch (      Throwable t) {
        logger.warn("[{}] failed to finalize snapshot",t,snapshotId);
        removeSnapshotFromClusterState(snapshotId,null,t);
      }
    }
  }
);
}
