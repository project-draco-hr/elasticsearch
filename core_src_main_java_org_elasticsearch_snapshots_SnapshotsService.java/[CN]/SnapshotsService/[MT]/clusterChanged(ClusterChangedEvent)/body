{
  try {
    if (event.localNodeMaster()) {
      if (event.nodesRemoved()) {
        processSnapshotsOnRemovedNodes(event);
      }
      if (event.routingTableChanged()) {
        processStartedShards(event);
      }
    }
    SnapshotsInProgress prev=event.previousState().custom(SnapshotsInProgress.TYPE);
    SnapshotsInProgress curr=event.state().custom(SnapshotsInProgress.TYPE);
    if (prev == null) {
      if (curr != null) {
        processIndexShardSnapshots(event);
      }
    }
 else {
      if (!prev.equals(curr)) {
        processIndexShardSnapshots(event);
      }
    }
    if (event.state().nodes().masterNodeId() != null && event.state().nodes().masterNodeId().equals(event.previousState().nodes().masterNodeId()) == false) {
      syncShardStatsOnNewMaster(event);
    }
  }
 catch (  Throwable t) {
    logger.warn("Failed to update snapshot state ",t);
  }
}
