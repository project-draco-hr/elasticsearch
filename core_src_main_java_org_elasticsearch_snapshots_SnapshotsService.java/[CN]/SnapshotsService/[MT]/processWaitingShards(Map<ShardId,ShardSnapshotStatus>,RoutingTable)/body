{
  boolean snapshotChanged=false;
  ImmutableMap.Builder<ShardId,ShardSnapshotStatus> shards=ImmutableMap.builder();
  for (  ImmutableMap.Entry<ShardId,ShardSnapshotStatus> shardEntry : snapshotShards.entrySet()) {
    ShardSnapshotStatus shardStatus=shardEntry.getValue();
    if (shardStatus.state() == State.WAITING) {
      ShardId shardId=shardEntry.getKey();
      IndexRoutingTable indexShardRoutingTable=routingTable.index(shardId.getIndex());
      if (indexShardRoutingTable != null) {
        IndexShardRoutingTable shardRouting=indexShardRoutingTable.shard(shardId.id());
        if (shardRouting != null && shardRouting.primaryShard() != null) {
          if (shardRouting.primaryShard().started()) {
            snapshotChanged=true;
            logger.trace("starting shard that we were waiting for [{}] on node [{}]",shardEntry.getKey(),shardStatus.nodeId());
            shards.put(shardEntry.getKey(),new ShardSnapshotStatus(shardRouting.primaryShard().currentNodeId()));
            continue;
          }
 else           if (shardRouting.primaryShard().initializing() || shardRouting.primaryShard().relocating()) {
            shards.put(shardEntry);
            continue;
          }
        }
      }
      snapshotChanged=true;
      logger.warn("failing snapshot of shard [{}] on unassigned shard [{}]",shardEntry.getKey(),shardStatus.nodeId());
      shards.put(shardEntry.getKey(),new ShardSnapshotStatus(shardStatus.nodeId(),State.FAILED,"shard is unassigned"));
    }
 else {
      shards.put(shardEntry);
    }
  }
  if (snapshotChanged) {
    return shards.build();
  }
 else {
    return null;
  }
}
