{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().create(createIndexRequest("test")).actionGet();
  client.index(indexRequest("test").type("type1").id("1").source(jsonBuilder().startObject().field("test","value beck").field("num1",1.0f).endObject())).actionGet();
  client.index(indexRequest("test").type("type1").id("2").source(jsonBuilder().startObject().field("test","value check").field("num1",2.0f).endObject())).actionGet();
  client.admin().indices().refresh(refreshRequest()).actionGet();
  logger.info("--- QUERY_THEN_FETCH");
  logger.info("running doc['num1'].value");
  SearchResponse response=client.search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("doc['num1'].value")))).actionGet();
  assertThat(response.hits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.hits().getAt(0).id(),response.hits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.hits().getAt(1).id(),response.hits().getAt(1).explanation());
  assertThat(response.hits().getAt(0).id(),equalTo("2"));
  assertThat(response.hits().getAt(1).id(),equalTo("1"));
  logger.info("running -doc['num1'].value");
  response=client.search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("-doc['num1'].value")))).actionGet();
  assertThat(response.hits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.hits().getAt(0).id(),response.hits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.hits().getAt(1).id(),response.hits().getAt(1).explanation());
  assertThat(response.hits().getAt(0).id(),equalTo("1"));
  assertThat(response.hits().getAt(1).id(),equalTo("2"));
  logger.info("running pow(doc['num1'].value, 2)");
  response=client.search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("pow(doc['num1'].value, 2)")))).actionGet();
  assertThat(response.hits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.hits().getAt(0).id(),response.hits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.hits().getAt(1).id(),response.hits().getAt(1).explanation());
  assertThat(response.hits().getAt(0).id(),equalTo("2"));
  assertThat(response.hits().getAt(1).id(),equalTo("1"));
  logger.info("running max(doc['num1'].value, 1)");
  response=client.search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("max(doc['num1'].value, 1d)")))).actionGet();
  assertThat(response.hits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.hits().getAt(0).id(),response.hits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.hits().getAt(1).id(),response.hits().getAt(1).explanation());
  assertThat(response.hits().getAt(0).id(),equalTo("2"));
  assertThat(response.hits().getAt(1).id(),equalTo("1"));
  logger.info("running doc['num1'].value * _score");
  response=client.search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("doc['num1'].value * _score")))).actionGet();
  assertThat(response.hits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.hits().getAt(0).id(),response.hits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.hits().getAt(1).id(),response.hits().getAt(1).explanation());
  assertThat(response.hits().getAt(0).id(),equalTo("2"));
  assertThat(response.hits().getAt(1).id(),equalTo("1"));
  logger.info("running param1 * param2 * _score");
  response=client.search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("param1 * param2 * _score").param("param1",2).param("param2",2)))).actionGet();
  assertThat(response.hits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.hits().getAt(0).id(),response.hits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.hits().getAt(1).id(),response.hits().getAt(1).explanation());
  assertThat(response.hits().getAt(0).id(),equalTo("1"));
  assertThat(response.hits().getAt(1).id(),equalTo("2"));
}
