{
  String json="{" + "\"user\":\"kimchy\"," + "\"postDate\":\"2013-01-30\","+ "\"message\":\"trying out Elastic Search\""+ "}";
  client().prepareIndex("twitter","tweet").setSource(json).setRefresh(true).execute().actionGet();
  ensureGreen("twitter");
  SearchResponse search=client().prepareSearch().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertThat(search.getHits().totalHits(),equalTo(1l));
  DeleteByQueryRequestBuilder deleteByQueryRequestBuilder=client().prepareDeleteByQuery();
  deleteByQueryRequestBuilder.setIndices("twitter","missing");
  deleteByQueryRequestBuilder.setQuery(QueryBuilders.matchAllQuery());
  try {
    deleteByQueryRequestBuilder.execute().actionGet();
    fail("Exception should have been thrown.");
  }
 catch (  IndexMissingException e) {
  }
  deleteByQueryRequestBuilder.setIndicesOptions(IndicesOptions.lenientExpandOpen());
  DeleteByQueryResponse response=deleteByQueryRequestBuilder.execute().actionGet();
  assertThat(response.status(),equalTo(RestStatus.OK));
  assertSyncShardInfo(response.getIndex("twitter").getShardInfo(),getNumShards("twitter"));
  client().admin().indices().prepareRefresh().execute().actionGet();
  search=client().prepareSearch().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  assertThat(search.getHits().totalHits(),equalTo(0l));
}
