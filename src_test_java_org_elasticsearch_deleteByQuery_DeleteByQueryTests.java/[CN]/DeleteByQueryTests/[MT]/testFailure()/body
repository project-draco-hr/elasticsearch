{
  client().admin().indices().prepareCreate("twitter").execute().actionGet();
  DeleteByQueryResponse response=client().prepareDeleteByQuery("twitter").setQuery(QueryBuilders.hasChildQuery("type",QueryBuilders.matchAllQuery())).execute().actionGet();
  NumShards twitter=getNumShards("twitter");
  assertThat(response.status(),equalTo(RestStatus.BAD_REQUEST));
  assertThat(response.getIndex("twitter").getSuccessfulShards(),equalTo(0));
  assertThat(response.getIndex("twitter").getFailedShards(),equalTo(twitter.numPrimaries));
  assertThat(response.getIndices().size(),equalTo(1));
  assertThat(response.getIndices().get("twitter").getFailedShards(),equalTo(twitter.numPrimaries));
  assertThat(response.getIndices().get("twitter").getFailures().length,equalTo(twitter.numPrimaries));
  for (  ShardOperationFailedException failure : response.getIndices().get("twitter").getFailures()) {
    assertThat(failure.reason(),containsString("[twitter] [has_child] unsupported in delete_by_query api"));
    assertThat(failure.status(),equalTo(RestStatus.BAD_REQUEST));
    assertThat(failure.shardId(),greaterThan(-1));
  }
}
