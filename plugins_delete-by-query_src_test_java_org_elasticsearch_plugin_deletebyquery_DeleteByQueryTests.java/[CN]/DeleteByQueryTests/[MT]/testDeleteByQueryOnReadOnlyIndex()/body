{
  createIndex("test");
  ensureGreen();
  final long docs=randomIntBetween(1,50);
  for (int i=0; i < docs; i++) {
    index("test","test",String.valueOf(i),"field",1);
  }
  refresh();
  assertHitCount(client().prepareSearch("test").setSize(0).get(),docs);
  try {
    enableIndexBlock("test",IndexMetaData.SETTING_READ_ONLY);
    DeleteByQueryResponse rsp=newDeleteByQuery().setQuery(QueryBuilders.matchAllQuery()).get();
    assertDBQResponse(rsp,docs,0L,docs,0L);
  }
  finally {
    disableIndexBlock("test",IndexMetaData.SETTING_READ_ONLY);
  }
  assertHitCount(client().prepareSearch("test").setSize(0).get(),docs);
  assertSearchContextsClosed();
}
