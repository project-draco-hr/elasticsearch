{
  if (indices == null || indices.length == 0) {
    indices=clusterState.metaData().concreteAllIndices();
  }
  String[] routings=null;
  if (routing != null) {
    routings=routingPattern.split(routing);
  }
  if (routings != null && routings.length > 0) {
    HashSet<ShardIterator> set=new HashSet<ShardIterator>();
    for (    String index : indices) {
      IndexRoutingTable indexRouting=indexRoutingTable(clusterState,index);
      for (      String r : routings) {
        int shardId=shardId(clusterState,index,null,null,r);
        IndexShardRoutingTable indexShard=indexRouting.shard(shardId);
        if (indexShard == null) {
          throw new IndexShardMissingException(new ShardId(index,shardId));
        }
        set.add(preferenceShardIterator(indexShard,clusterState.nodes().localNodeId(),preference));
      }
    }
    return new GroupShardsIterator(set);
  }
 else {
    ArrayList<ShardIterator> set=new ArrayList<ShardIterator>();
    for (    String index : indices) {
      IndexRoutingTable indexRouting=indexRoutingTable(clusterState,index);
      for (      IndexShardRoutingTable indexShard : indexRouting) {
        set.add(preferenceShardIterator(indexShard,clusterState.nodes().localNodeId(),preference));
      }
    }
    return new GroupShardsIterator(set);
  }
}
