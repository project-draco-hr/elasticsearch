{
  if (preference == null) {
    String[] awarenessAttributes=awarenessAllocationDecider.awarenessAttributes();
    if (awarenessAttributes.length == 0) {
      return indexShard.activeShardsRandomIt();
    }
 else {
      return indexShard.preferAttributesActiveShardsIt(awarenessAttributes,nodes);
    }
  }
  if ("_local".equals(preference)) {
    return indexShard.preferNodeActiveShardsIt(nodeId);
  }
  if ("_primary".equals(preference)) {
    return indexShard.primaryShardIt();
  }
  String[] awarenessAttributes=awarenessAllocationDecider.awarenessAttributes();
  if (awarenessAttributes.length == 0) {
    return indexShard.activeShardsIt(DjbHashFunction.DJB_HASH(preference));
  }
 else {
    return indexShard.preferAttributesActiveShardsIt(awarenessAttributes,nodes,DjbHashFunction.DJB_HASH(preference));
  }
}
