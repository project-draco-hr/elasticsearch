{
  ClusterState currentState=clusterService.state();
  ClusterState.Builder builder=newClusterStateBuilder();
  if (!request.filterNodes()) {
    builder.nodes(currentState.nodes());
  }
  if (!request.filterRoutingTable()) {
    builder.routingTable(currentState.routingTable());
  }
  if (!request.filterMetaData()) {
    if (request.filteredIndices().length > 0) {
      MetaData.Builder mdBuilder=newMetaDataBuilder();
      String[] indices=currentState.metaData().concreteIndices(request.filteredIndices());
      for (      String filteredIndex : indices) {
        IndexMetaData indexMetaData=currentState.metaData().index(filteredIndex);
        if (indexMetaData == null) {
          throw new IndexMissingException(new Index(filteredIndex));
        }
        mdBuilder.put(indexMetaData);
      }
      builder.metaData(mdBuilder);
    }
 else {
      builder.metaData(currentState.metaData());
    }
  }
  builder.blocks(currentState.blocks());
  return new ClusterStateResponse(clusterName,builder.build());
}
