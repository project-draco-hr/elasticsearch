{
  wipeIndices();
  client().admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client().index(indexRequest("test").type("type1").id("1").source(jsonBuilder().startObject().field("test","value beck").field("num1",1.0f).endObject())).actionGet();
  client().index(indexRequest("test").type("type1").id("2").source(jsonBuilder().startObject().field("test","value check").field("num1",2.0f).endObject())).actionGet();
  client().admin().indices().refresh(refreshRequest()).actionGet();
  logger.info("--- QUERY_THEN_FETCH");
  logger.info("running doc['num1'].value");
  SearchResponse response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(functionScoreQuery(termQuery("test","value"),scriptFunction("doc['num1'].value"))))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running -doc['num1'].value");
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(functionScoreQuery(termQuery("test","value"),scriptFunction("-doc['num1'].value"))))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("1"));
  assertThat(response.getHits().getAt(1).id(),equalTo("2"));
  logger.info("running pow(doc['num1'].value, 2)");
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(functionScoreQuery(termQuery("test","value"),scriptFunction("pow(doc['num1'].value, 2)"))))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running max(doc['num1'].value, 1)");
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(functionScoreQuery(termQuery("test","value"),scriptFunction("max(doc['num1'].value, 1d)"))))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running doc['num1'].value * _score");
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(functionScoreQuery(termQuery("test","value"),scriptFunction("doc['num1'].value * _score"))))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running param1 * param2 * _score");
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(functionScoreQuery(termQuery("test","value"),scriptFunction("param1 * param2 * _score").param("param1",2).param("param2",2))))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertSearchHits(response,"1","2");
  logger.info("running param1 * param2 * _score with filter instead of query");
  response=client().search(searchRequest().searchType(SearchType.QUERY_THEN_FETCH).source(searchSource().explain(true).query(functionScoreQuery(termFilter("test","value"),scriptFunction("param1 * param2 * _score").param("param1",2).param("param2",2))))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertSearchHits(response,"1","2");
  assertThat(response.getHits().getAt(0).score(),equalTo(4f));
  assertThat(response.getHits().getAt(1).score(),equalTo(4f));
}
