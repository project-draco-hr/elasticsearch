{
  if (optimizeSingleShard && searchRequest.searchType() != SCAN && searchRequest.searchType() != COUNT) {
    try {
      ClusterState clusterState=clusterService.state();
      String[] concreteIndices=indexNameExpressionResolver.concreteIndices(clusterState,searchRequest);
      Map<String,Set<String>> routingMap=indexNameExpressionResolver.resolveSearchRouting(clusterState,searchRequest.routing(),searchRequest.indices());
      int shardCount=clusterService.operationRouting().searchShardsCount(clusterState,concreteIndices,routingMap);
      if (shardCount == 1) {
        searchRequest.searchType(QUERY_AND_FETCH);
      }
    }
 catch (    IndexNotFoundException|IndexClosedException e) {
    }
catch (    Exception e) {
      logger.debug("failed to optimize search type, continue as normal",e);
    }
  }
  if (searchRequest.searchType() == DFS_QUERY_THEN_FETCH) {
    dfsQueryThenFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.searchType() == SearchType.QUERY_THEN_FETCH) {
    queryThenFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.searchType() == SearchType.DFS_QUERY_AND_FETCH) {
    dfsQueryAndFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.searchType() == SearchType.QUERY_AND_FETCH) {
    queryAndFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.searchType() == SearchType.SCAN) {
    scanAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.searchType() == SearchType.COUNT) {
    countAction.execute(searchRequest,listener);
  }
 else {
    throw new IllegalStateException("Unknown search type: [" + searchRequest.searchType() + "]");
  }
}
