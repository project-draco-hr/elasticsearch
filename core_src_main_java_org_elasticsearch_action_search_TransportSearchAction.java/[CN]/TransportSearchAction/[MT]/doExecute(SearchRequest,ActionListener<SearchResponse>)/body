{
  try {
    ClusterState clusterState=clusterService.state();
    String[] concreteIndices=indexNameExpressionResolver.concreteIndices(clusterState,searchRequest);
    Map<String,Set<String>> routingMap=indexNameExpressionResolver.resolveSearchRouting(clusterState,searchRequest.routing(),searchRequest.indices());
    int shardCount=clusterService.operationRouting().searchShardsCount(clusterState,concreteIndices,routingMap);
    if (shardCount == 1) {
      searchRequest.searchType(QUERY_AND_FETCH);
    }
  }
 catch (  IndexNotFoundException|IndexClosedException e) {
  }
catch (  Exception e) {
    logger.debug("failed to optimize search type, continue as normal",e);
  }
  AbstractSearchAsyncAction searchAsyncAction;
switch (searchRequest.searchType()) {
case DFS_QUERY_THEN_FETCH:
    searchAsyncAction=new SearchDfsQueryThenFetchAsyncAction(logger,searchService,clusterService,indexNameExpressionResolver,searchPhaseController,threadPool,searchRequest,listener);
  break;
case QUERY_THEN_FETCH:
searchAsyncAction=new SearchQueryThenFetchAsyncAction(logger,searchService,clusterService,indexNameExpressionResolver,searchPhaseController,threadPool,searchRequest,listener);
break;
case DFS_QUERY_AND_FETCH:
searchAsyncAction=new SearchDfsQueryAndFetchAsyncAction(logger,searchService,clusterService,indexNameExpressionResolver,searchPhaseController,threadPool,searchRequest,listener);
break;
case QUERY_AND_FETCH:
searchAsyncAction=new SearchQueryAndFetchAsyncAction(logger,searchService,clusterService,indexNameExpressionResolver,searchPhaseController,threadPool,searchRequest,listener);
break;
default :
throw new IllegalStateException("Unknown search type: [" + searchRequest.searchType() + "]");
}
searchAsyncAction.start();
}
