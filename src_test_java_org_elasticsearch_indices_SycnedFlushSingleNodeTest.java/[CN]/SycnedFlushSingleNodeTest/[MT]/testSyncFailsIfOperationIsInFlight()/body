{
  createIndex("test");
  client().prepareIndex("test","test","1").setSource("{}").get();
  IndexService test=getInstanceFromNode(IndicesService.class).indexService("test");
  IndexShard shard=test.shard(0);
  SyncedFlushService flushService=getInstanceFromNode(SyncedFlushService.class);
  final ShardId shardId=shard.shardId();
  shard.incrementOperationCounter();
  try {
    SyncedFlushUtil.LatchedListener<SyncedFlushService.SyncedFlushResult> listener=new SyncedFlushUtil.LatchedListener();
    flushService.attemptSyncedFlush(shardId,listener);
    listener.latch.await();
    assertNull(listener.error);
    SyncedFlushService.SyncedFlushResult syncedFlushResult=listener.result;
    assertNotNull(syncedFlushResult);
    assertEquals(0,syncedFlushResult.successfulShards());
    assertEquals(0,syncedFlushResult.totalShards());
    assertEquals("operation counter on primary is non zero [2]",syncedFlushResult.failureReason());
    ElasticsearchAssertions.assertVersionSerializable(syncedFlushResult);
  }
  finally {
    shard.decrementOperationCounter();
  }
}
