{
  int numDocs=randomIntBetween(100,1000);
  int numberOfFields=scaledRandomIntBetween(1,50);
  Set<Integer> fieldsIdx=Sets.newHashSet();
  IndexRequestBuilder[] builders=new IndexRequestBuilder[numDocs];
  XContentBuilder mappings=XContentFactory.jsonBuilder().startObject().startObject("_default_");
  mappings.startArray("dynamic_templates").startObject().startObject("template-strings").field("match_mapping_type","string").startObject("mapping").startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("paged_bytes","fst")).field(FieldMapper.Loading.KEY,FieldMapper.Loading.LAZY).endObject().endObject().endObject().endObject().startObject().startObject("template-longs").field("match_mapping_type","long").startObject("mapping").startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("array","doc_values")).field(FieldMapper.Loading.KEY,FieldMapper.Loading.LAZY).endObject().endObject().endObject().endObject().startObject().startObject("template-doubles").field("match_mapping_type","double").startObject("mapping").startObject("fielddata").field(FieldDataType.FORMAT_KEY,randomFrom("array","doc_values")).field(FieldMapper.Loading.KEY,FieldMapper.Loading.LAZY).endObject().endObject().endObject().endObject().endArray();
  mappings.endObject().endObject();
  assertAcked(client().admin().indices().prepareCreate("idx").addMapping("_default_",mappings));
  ensureGreen("idx");
  for (int i=0; i < numDocs; ++i) {
    int fieldIdx=i % numberOfFields;
    fieldsIdx.add(fieldIdx);
    builders[i]=client().prepareIndex("idx","type").setSource(jsonBuilder().startObject().field("str_value_" + fieldIdx,"s" + i).field("l_value_" + fieldIdx,i).field("d_value_" + fieldIdx,(double)i + 0.01).endObject());
  }
  indexRandom(false,builders);
  for (  Integer fieldIdx : fieldsIdx) {
    waitForConcreteMappingsOnAll("idx","type","str_value_" + fieldIdx,"l_value_" + fieldIdx,"d_value_" + fieldIdx);
  }
}
