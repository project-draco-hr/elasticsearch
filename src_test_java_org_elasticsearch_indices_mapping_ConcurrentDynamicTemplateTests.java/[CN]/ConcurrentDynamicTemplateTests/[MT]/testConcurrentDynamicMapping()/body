{
  final String mapping="{" + mappingType + ": {"+ "\"properties\": {"+ "\"an_id\": {"+ "\"type\": \"string\","+ "\"store\": \"yes\","+ "\"index\": \"not_analyzed\""+ "}"+ "},"+ "\"dynamic_templates\": ["+ "{"+ "\"participants\": {"+ "\"path_match\": \"*\","+ "\"mapping\": {"+ "\"type\": \"string\","+ "\"store\": \"yes\","+ "\"index\": \"analyzed\","+ "\"analyzer\": \"whitespace\""+ "}"+ "}"+ "}"+ "]"+ "}"+ "}";
  final String fieldName="participants.ACCEPTED";
  int iters=atLeast(5);
  for (int i=0; i < iters; i++) {
    wipeIndex("test");
    client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("number_of_shards",between(1,5)).put("number_of_replicas",between(0,1)).build()).addMapping(mappingType,mapping).execute().actionGet();
    ensureYellow();
    int numDocs=atLeast(10);
    final CountDownLatch latch=new CountDownLatch(numDocs);
    final List<Throwable> throwable=new CopyOnWriteArrayList<Throwable>();
    for (int j=0; j < numDocs; j++) {
      Map<String,Object> source=new HashMap<String,Object>();
      source.put("an_id",Strings.randomBase64UUID(getRandom()));
      source.put(fieldName,"test-user");
      client().prepareIndex("test",mappingType).setSource(source).execute(new ActionListener<IndexResponse>(){
        @Override public void onResponse(        IndexResponse response){
          latch.countDown();
        }
        @Override public void onFailure(        Throwable e){
          throwable.add(e);
          latch.countDown();
        }
      }
);
    }
    latch.await();
    assertThat(throwable,emptyIterable());
    refresh();
    assertHitCount(client().prepareSearch("test").setQuery(QueryBuilders.matchQuery(fieldName,"test-user")).get(),numDocs);
    assertHitCount(client().prepareSearch("test").setQuery(QueryBuilders.matchQuery(fieldName,"test user")).get(),0);
  }
}
