{
  while (true) {
    if (closed) {
      return;
    }
    String lastSeq=null;
    try {
      client.admin().indices().prepareRefresh(riverIndexName).execute().actionGet();
      GetResponse lastSeqGetResponse=client.prepareGet(riverIndexName,riverName().name(),"_seq").execute().actionGet();
      if (lastSeqGetResponse.exists()) {
        Map<String,Object> couchdbState=(Map<String,Object>)lastSeqGetResponse.sourceAsMap().get("couchdb");
        if (couchdbState != null) {
          lastSeq=couchdbState.get("last_seq").toString();
        }
      }
    }
 catch (    Exception e) {
      logger.warn("failed to get last_seq, throttling....",e);
      try {
        Thread.sleep(5000);
        continue;
      }
 catch (      InterruptedException e1) {
        if (closed) {
          return;
        }
      }
    }
    String file="/" + couchDb + "/_changes?feed=continuous&include_docs=true&heartbeat=10000";
    if (couchFilter != null) {
      try {
        file=file + "&filter=" + URLEncoder.encode(couchFilter,"UTF-8");
      }
 catch (      UnsupportedEncodingException e) {
      }
      if (couchFilterParamsUrl != null) {
        file=file + couchFilterParamsUrl;
      }
    }
    if (lastSeq != null) {
      file=file + "&since=" + lastSeq;
    }
    if (logger.isDebugEnabled()) {
      logger.debug("using host [{}], port [{}], path [{}]",couchHost,couchPort,file);
    }
    HttpURLConnection connection=null;
    InputStream is=null;
    try {
      URL url=new URL("http",couchHost,couchPort,file);
      connection=(HttpURLConnection)url.openConnection();
      if (basicAuth != null) {
        connection.addRequestProperty("Authorization",basicAuth);
      }
      connection.setDoInput(true);
      connection.setUseCaches(false);
      is=connection.getInputStream();
      final BufferedReader reader=new BufferedReader(new InputStreamReader(is,"UTF-8"));
      String line;
      while ((line=reader.readLine()) != null) {
        if (closed) {
          return;
        }
        if (line.length() == 0) {
          logger.trace("[couchdb] heartbeat");
          continue;
        }
        if (logger.isTraceEnabled()) {
          logger.trace("[couchdb] {}",line);
        }
        stream.put(line);
      }
    }
 catch (    Exception e) {
      Closeables.closeQuietly(is);
      if (connection != null) {
        try {
          connection.disconnect();
        }
 catch (        Exception e1) {
        }
 finally {
          connection=null;
        }
      }
      if (closed) {
        return;
      }
      logger.warn("failed to read from _changes, throttling....",e);
      try {
        Thread.sleep(5000);
      }
 catch (      InterruptedException e1) {
        if (closed) {
          return;
        }
      }
    }
 finally {
      Closeables.closeQuietly(is);
      if (connection != null) {
        try {
          connection.disconnect();
        }
 catch (        Exception e1) {
        }
 finally {
          connection=null;
        }
      }
    }
  }
}
