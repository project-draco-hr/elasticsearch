{
  Map<String,Object> ctx;
  try {
    ctx=XContentFactory.xContent(XContentType.JSON).createParser(s).mapAndClose();
  }
 catch (  IOException e) {
    logger.warn("failed to parse {}",e,s);
    return null;
  }
  if (ctx.containsKey("error")) {
    logger.warn("received error {}",s);
    return null;
  }
  String seq=ctx.get("seq").toString();
  String id=ctx.get("id").toString();
  if (id.startsWith("_design/")) {
    logger.trace("ignoring design document {}",id);
    return seq;
  }
  if (script != null) {
    script.setNextVar("ctx",ctx);
    try {
      script.run();
    }
 catch (    Exception e) {
      logger.warn("failed to script process {}, ignoring",e,ctx);
      return seq;
    }
  }
  if (ctx.containsKey("ignore") && ctx.get("ignore").equals(Boolean.TRUE)) {
  }
 else   if (ctx.containsKey("deleted") && ctx.get("deleted").equals(Boolean.TRUE)) {
    String index=extractIndex(ctx);
    String type=extractType(ctx);
    if (logger.isTraceEnabled()) {
      logger.trace("processing [delete]: [{}]/[{}]/[{}]",index,type,id);
    }
    bulk.add(deleteRequest(index).type(type).id(id).routing(extractRouting(ctx)));
  }
 else   if (ctx.containsKey("doc")) {
    String index=extractIndex(ctx);
    String type=extractType(ctx);
    Map<String,Object> doc=(Map<String,Object>)ctx.get("doc");
    if (logger.isTraceEnabled()) {
      logger.trace("processing [index ]: [{}]/[{}]/[{}], source {}",index,type,id,doc);
    }
    bulk.add(indexRequest(index).type(type).id(id).source(doc).routing(extractRouting(ctx)));
  }
 else {
    logger.warn("ignoring unknown change {}",s);
  }
  return seq;
}
