{
  if (results1.isEmpty()) {
    return EMPTY;
  }
  if (optimizeSingleShard) {
    boolean canOptimize=false;
    QuerySearchResult result=null;
    if (results1.size() == 1) {
      canOptimize=true;
      result=results1.iterator().next().queryResult();
    }
 else {
      for (      QuerySearchResultProvider queryResult : results1) {
        if (queryResult.queryResult().topDocs().scoreDocs.length > 0) {
          if (result != null) {
            canOptimize=false;
            break;
          }
          canOptimize=true;
          result=queryResult.queryResult();
        }
      }
    }
    if (canOptimize) {
      ScoreDoc[] scoreDocs=result.topDocs().scoreDocs;
      if (scoreDocs.length < result.from()) {
        return EMPTY;
      }
      int resultDocsSize=result.size();
      if ((scoreDocs.length - result.from()) < resultDocsSize) {
        resultDocsSize=scoreDocs.length - result.from();
      }
      if (result.topDocs() instanceof TopFieldDocs) {
        ShardDoc[] docs=new ShardDoc[resultDocsSize];
        for (int i=0; i < resultDocsSize; i++) {
          ScoreDoc scoreDoc=scoreDocs[result.from() + i];
          docs[i]=new ShardFieldDoc(result.shardTarget(),scoreDoc.doc,scoreDoc.score,((FieldDoc)scoreDoc).fields);
        }
        return docs;
      }
 else {
        ShardDoc[] docs=new ShardDoc[resultDocsSize];
        for (int i=0; i < resultDocsSize; i++) {
          ScoreDoc scoreDoc=scoreDocs[result.from() + i];
          docs[i]=new ShardScoreDoc(result.shardTarget(),scoreDoc.doc,scoreDoc.score);
        }
        return docs;
      }
    }
  }
  List<? extends QuerySearchResultProvider> results=QUERY_RESULT_ORDERING.sortedCopy(results1);
  QuerySearchResultProvider queryResultProvider=results.get(0);
  int totalNumDocs=0;
  int queueSize=queryResultProvider.queryResult().from() + queryResultProvider.queryResult().size();
  if (queryResultProvider.includeFetch()) {
    queueSize*=results.size();
  }
  PriorityQueue queue;
  if (queryResultProvider.queryResult().topDocs() instanceof TopFieldDocs) {
    TopFieldDocs fieldDocs=(TopFieldDocs)queryResultProvider.queryResult().topDocs();
    for (int i=0; i < fieldDocs.fields.length; i++) {
      boolean allValuesAreNull=true;
      boolean resolvedField=false;
      for (      QuerySearchResultProvider resultProvider : results) {
        for (        ScoreDoc doc : resultProvider.queryResult().topDocs().scoreDocs) {
          FieldDoc fDoc=(FieldDoc)doc;
          if (fDoc.fields[i] != null) {
            allValuesAreNull=false;
            if (fDoc.fields[i] instanceof String) {
              fieldDocs.fields[i]=new SortField(fieldDocs.fields[i].getField(),SortField.STRING,fieldDocs.fields[i].getReverse());
            }
            resolvedField=true;
            break;
          }
        }
        if (resolvedField) {
          break;
        }
      }
      if (!resolvedField && allValuesAreNull && fieldDocs.fields[i].getField() != null) {
        fieldDocs.fields[i]=new SortField(fieldDocs.fields[i].getField(),SortField.STRING,fieldDocs.fields[i].getReverse());
      }
    }
    queue=new ShardFieldDocSortedHitQueue(fieldDocs.fields,queueSize);
    for (    QuerySearchResultProvider resultProvider : results) {
      QuerySearchResult result=resultProvider.queryResult();
      ScoreDoc[] scoreDocs=result.topDocs().scoreDocs;
      totalNumDocs+=scoreDocs.length;
      for (      ScoreDoc doc : scoreDocs) {
        ShardFieldDoc nodeFieldDoc=new ShardFieldDoc(result.shardTarget(),doc.doc,doc.score,((FieldDoc)doc).fields);
        if (queue.insertWithOverflow(nodeFieldDoc) == nodeFieldDoc) {
          break;
        }
      }
    }
  }
 else {
    queue=new ScoreDocQueue(queueSize);
    for (    QuerySearchResultProvider resultProvider : results) {
      QuerySearchResult result=resultProvider.queryResult();
      ScoreDoc[] scoreDocs=result.topDocs().scoreDocs;
      totalNumDocs+=scoreDocs.length;
      for (      ScoreDoc doc : scoreDocs) {
        ShardScoreDoc nodeScoreDoc=new ShardScoreDoc(result.shardTarget(),doc.doc,doc.score);
        if (queue.insertWithOverflow(nodeScoreDoc) == nodeScoreDoc) {
          break;
        }
      }
    }
  }
  int resultDocsSize=queryResultProvider.queryResult().size();
  if (queryResultProvider.includeFetch()) {
    resultDocsSize*=results.size();
  }
  if (totalNumDocs < queueSize) {
    resultDocsSize=totalNumDocs - queryResultProvider.queryResult().from();
  }
  if (resultDocsSize <= 0) {
    return EMPTY;
  }
  ShardDoc[] shardDocs=new ShardDoc[resultDocsSize];
  for (int i=resultDocsSize - 1; i >= 0; i--)   shardDocs[i]=(ShardDoc)queue.pop();
  return shardDocs;
}
