{
  LeafReader leafReader=context.reader();
  ShardId shardId=ShardUtils.extractShardId(leafReader);
  if (shardId == null) {
    throw new IllegalStateException("can't resolve shard id");
  }
  if (indexSettings.getIndex().equals(shardId.getIndex()) == false) {
    String message="Trying to load queries for index " + shardId.getIndex() + " with cache of index "+ indexSettings.getIndex();
    throw new IllegalStateException(message);
  }
  IntObjectHashMap<Query> queries=new IntObjectHashMap<>();
  boolean legacyLoading=indexVersionCreated.before(Version.V_5_0_0_alpha1);
  PostingsEnum postings=leafReader.postings(new Term(TypeFieldMapper.NAME,PercolatorFieldMapper.TYPE_NAME),PostingsEnum.NONE);
  if (postings != null) {
    if (legacyLoading) {
      LegacyQueryFieldVisitor visitor=new LegacyQueryFieldVisitor();
      for (int docId=postings.nextDoc(); docId != DocIdSetIterator.NO_MORE_DOCS; docId=postings.nextDoc()) {
        leafReader.document(docId,visitor);
        queries.put(docId,parseLegacyPercolatorDocument(docId,visitor.source));
        visitor.source=null;
      }
    }
 else {
      BinaryDocValues binaryDocValues=leafReader.getBinaryDocValues(PercolatorFieldMapper.QUERY_BUILDER_FULL_FIELD_NAME);
      if (binaryDocValues != null) {
        for (int docId=postings.nextDoc(); docId != DocIdSetIterator.NO_MORE_DOCS; docId=postings.nextDoc()) {
          BytesRef queryBuilder=binaryDocValues.get(docId);
          if (queryBuilder.length > 0) {
            queries.put(docId,parseQueryBuilder(docId,queryBuilder));
          }
        }
      }
    }
  }
  leafReader.addCoreClosedListener(this);
  return new QueriesLeaf(shardId,queries);
}
