{
  for (  IndexShard shardToPurge : shardsToPurge) {
    Query query=NumericRangeQuery.newLongRange(TTLFieldMapper.NAME,null,System.currentTimeMillis(),false,true);
    Engine.Searcher searcher=shardToPurge.searcher();
    try {
      logger.debug("[{}][{}] purging shard",shardToPurge.routingEntry().index(),shardToPurge.routingEntry().id());
      ExpiredDocsCollector expiredDocsCollector=new ExpiredDocsCollector(shardToPurge.routingEntry().index());
      searcher.searcher().search(query,expiredDocsCollector);
      List<DocToPurge> docsToPurge=expiredDocsCollector.getDocsToPurge();
      BulkRequestBuilder bulkRequest=client.prepareBulk();
      for (      DocToPurge docToPurge : docsToPurge) {
        bulkRequest.add(new DeleteRequest().setIndex(shardToPurge.routingEntry().index()).setType(docToPurge.type).setId(docToPurge.id).setVersion(docToPurge.version).setRouting(docToPurge.routing));
        bulkRequest=processBulkIfNeeded(bulkRequest,false);
      }
      processBulkIfNeeded(bulkRequest,true);
    }
 catch (    Exception e) {
      logger.warn("failed to purge",e);
    }
 finally {
      searcher.release();
    }
  }
}
