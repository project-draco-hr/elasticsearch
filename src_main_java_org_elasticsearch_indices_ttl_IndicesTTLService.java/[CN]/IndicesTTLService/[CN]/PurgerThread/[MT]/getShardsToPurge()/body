{
  List<IndexShard> shardsToPurge=new ArrayList<IndexShard>();
  for (  IndexService indexService : indicesService) {
    IndexMetaData indexMetaData=clusterService.state().metaData().index(indexService.index().name());
    boolean disablePurge=indexMetaData.settings().getAsBoolean("index.ttl.disable_purge",false);
    if (disablePurge) {
      continue;
    }
    FieldMappers ttlFieldMappers=indexService.mapperService().name(TTLFieldMapper.NAME);
    if (ttlFieldMappers == null) {
      continue;
    }
    boolean hasTTLEnabled=false;
    for (    FieldMapper ttlFieldMapper : ttlFieldMappers) {
      if (((TTLFieldMapper)ttlFieldMapper).enabled()) {
        hasTTLEnabled=true;
        break;
      }
    }
    if (hasTTLEnabled) {
      for (      IndexShard indexShard : indexService) {
        if (indexShard.state() == IndexShardState.STARTED && indexShard.routingEntry().primary() && indexShard.routingEntry().started()) {
          shardsToPurge.add(indexShard);
        }
      }
    }
  }
  return shardsToPurge;
}
