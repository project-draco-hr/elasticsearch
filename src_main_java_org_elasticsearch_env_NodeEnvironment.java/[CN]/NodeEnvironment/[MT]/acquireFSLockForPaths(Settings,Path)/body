{
  Lock[] locks=new Lock[shardPaths.length];
  Directory[] dirs=new Directory[shardPaths.length];
  try {
    for (int i=0; i < shardPaths.length; i++) {
      Path p=shardPaths[i].resolve("index");
      dirs[i]=new SimpleFSDirectory(p,FsDirectoryService.buildLockFactory(indexSettings));
      locks[i]=dirs[i].makeLock(IndexWriter.WRITE_LOCK_NAME);
      if (locks[i].obtain() == false) {
        throw new ElasticsearchException("unable to acquire " + IndexWriter.WRITE_LOCK_NAME + " for "+ p);
      }
    }
  }
  finally {
    IOUtils.closeWhileHandlingException(locks);
    IOUtils.closeWhileHandlingException(dirs);
  }
}
