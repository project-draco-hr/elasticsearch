{
  Set<ShardId> allShardIds=findAllShardIds(index);
  List<ShardLock> allLocks=new ArrayList<>();
  boolean success=false;
  long startTime=System.currentTimeMillis();
  try {
    for (    ShardId shardId : allShardIds) {
      long timeoutLeft=Math.max(0,lockTimeoutMS - (System.currentTimeMillis() - startTime));
      allLocks.add(shardLock(shardId,timeoutLeft));
    }
    success=true;
  }
  finally {
    if (success == false) {
      IOUtils.closeWhileHandlingException(allLocks);
    }
  }
  return allLocks;
}
