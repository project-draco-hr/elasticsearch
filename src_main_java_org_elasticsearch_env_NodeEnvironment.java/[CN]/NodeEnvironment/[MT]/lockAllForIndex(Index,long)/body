{
  Set<ShardId> allShardIds=findAllShardIds(index);
  logger.trace("locking all shards for index {} - [{}]",index,allShardIds);
  List<ShardLock> allLocks=new ArrayList<>(allShardIds.size());
  boolean success=false;
  long startTime=System.currentTimeMillis();
  try {
    for (    ShardId shardId : allShardIds) {
      long timeoutLeft=Math.max(0,lockTimeoutMS - (System.currentTimeMillis() - startTime));
      allLocks.add(shardLock(shardId,timeoutLeft));
    }
    success=true;
  }
  finally {
    if (success == false) {
      logger.trace("unable to lock all shards for index {}",index);
      IOUtils.closeWhileHandlingException(allLocks);
    }
  }
  return allLocks;
}
