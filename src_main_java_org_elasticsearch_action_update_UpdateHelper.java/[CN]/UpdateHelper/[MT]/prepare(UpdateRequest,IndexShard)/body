{
  long getDate=System.currentTimeMillis();
  final GetResult getResult=indexShard.getService().get(request.type(),request.id(),new String[]{SourceFieldMapper.NAME,RoutingFieldMapper.NAME,ParentFieldMapper.NAME,TTLFieldMapper.NAME},true,request.version(),request.versionType());
  if (!getResult.isExists()) {
    if (request.upsertRequest() == null && !request.docAsUpsert()) {
      throw new DocumentMissingException(new ShardId(request.index(),request.shardId()),request.type(),request.id());
    }
    IndexRequest indexRequest=request.docAsUpsert() ? request.doc() : request.upsertRequest();
    indexRequest.index(request.index()).type(request.type()).id(request.id()).create(true).routing(request.routing()).refresh(request.refresh()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel());
    indexRequest.operationThreaded(false);
    if (request.versionType() == VersionType.EXTERNAL) {
      indexRequest.version(request.version()).versionType(VersionType.EXTERNAL);
    }
    return new Result(indexRequest,Operation.UPSERT,null,null);
  }
  long updateVersion=getResult.getVersion();
  if (request.versionType() == VersionType.EXTERNAL) {
    updateVersion=request.version();
  }
  if (getResult.internalSourceRef() == null) {
    throw new DocumentSourceMissingException(new ShardId(request.index(),request.shardId()),request.type(),request.id());
  }
  Tuple<XContentType,Map<String,Object>> sourceAndContent=XContentHelper.convertToMap(getResult.internalSourceRef(),true);
  String operation=null;
  String timestamp=null;
  Long ttl=null;
  Object fetchedTTL=null;
  final Map<String,Object> updatedSourceAsMap;
  final XContentType updateSourceContentType=sourceAndContent.v1();
  String routing=getResult.getFields().containsKey(RoutingFieldMapper.NAME) ? getResult.field(RoutingFieldMapper.NAME).getValue().toString() : null;
  String parent=getResult.getFields().containsKey(ParentFieldMapper.NAME) ? getResult.field(ParentFieldMapper.NAME).getValue().toString() : null;
  if (request.script() == null && request.doc() != null) {
    IndexRequest indexRequest=request.doc();
    updatedSourceAsMap=sourceAndContent.v2();
    if (indexRequest.ttl() > 0) {
      ttl=indexRequest.ttl();
    }
    timestamp=indexRequest.timestamp();
    if (indexRequest.routing() != null) {
      routing=indexRequest.routing();
    }
    if (indexRequest.parent() != null) {
      parent=indexRequest.parent();
    }
    XContentHelper.update(updatedSourceAsMap,indexRequest.sourceAsMap());
  }
 else {
    Map<String,Object> ctx=new HashMap<String,Object>(2);
    ctx.put("_source",sourceAndContent.v2());
    try {
      ExecutableScript script=scriptService.executable(request.scriptLang,request.script,request.scriptParams);
      script.setNextVar("ctx",ctx);
      script.run();
      ctx=(Map<String,Object>)script.unwrap(ctx);
    }
 catch (    Exception e) {
      throw new ElasticSearchIllegalArgumentException("failed to execute script",e);
    }
    operation=(String)ctx.get("op");
    timestamp=(String)ctx.get("_timestamp");
    fetchedTTL=ctx.get("_ttl");
    if (fetchedTTL != null) {
      if (fetchedTTL instanceof Number) {
        ttl=((Number)fetchedTTL).longValue();
      }
 else {
        ttl=TimeValue.parseTimeValue((String)fetchedTTL,null).millis();
      }
    }
    updatedSourceAsMap=(Map<String,Object>)ctx.get("_source");
  }
  if (ttl == null) {
    ttl=getResult.getFields().containsKey(TTLFieldMapper.NAME) ? (Long)getResult.field(TTLFieldMapper.NAME).getValue() : null;
    if (ttl != null) {
      ttl=ttl - (System.currentTimeMillis() - getDate);
    }
  }
  if (operation == null || "index".equals(operation)) {
    final IndexRequest indexRequest=Requests.indexRequest(request.index()).type(request.type()).id(request.id()).routing(routing).parent(parent).source(updatedSourceAsMap,updateSourceContentType).version(updateVersion).versionType(request.versionType()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel()).timestamp(timestamp).ttl(ttl).refresh(request.refresh());
    indexRequest.operationThreaded(false);
    return new Result(indexRequest,Operation.INDEX,updatedSourceAsMap,updateSourceContentType);
  }
 else   if ("delete".equals(operation)) {
    DeleteRequest deleteRequest=Requests.deleteRequest(request.index()).type(request.type()).id(request.id()).routing(routing).parent(parent).version(updateVersion).versionType(request.versionType()).replicationType(request.replicationType()).consistencyLevel(request.consistencyLevel());
    deleteRequest.operationThreaded(false);
    return new Result(deleteRequest,Operation.DELETE,updatedSourceAsMap,updateSourceContentType);
  }
 else   if ("none".equals(operation)) {
    UpdateResponse update=new UpdateResponse(getResult.getIndex(),getResult.getType(),getResult.getId(),getResult.getVersion(),false);
    update.setGetResult(extractGetResult(request,getResult.getVersion(),updatedSourceAsMap,updateSourceContentType,null));
    return new Result(update,Operation.NONE,updatedSourceAsMap,updateSourceContentType);
  }
 else {
    logger.warn("Used update operation [{}] for script [{}], doing nothing...",operation,request.script);
    UpdateResponse update=new UpdateResponse(getResult.getIndex(),getResult.getType(),getResult.getId(),getResult.getVersion(),false);
    return new Result(update,Operation.NONE,updatedSourceAsMap,updateSourceContentType);
  }
}
