{
  if (externalPingData.containsKey("response")) {
    logger.trace("got an external ping response (ignoring) from {}, content {}",remoteAddress,externalPingData);
    return;
  }
  if (multicastSocket == null) {
    logger.debug("can't send ping response, no socket, from {}, content {}",remoteAddress,externalPingData);
    return;
  }
  Map<String,Object> request=(Map<String,Object>)externalPingData.get("request");
  if (request == null) {
    logger.warn("malformed external ping request, no 'request' element from {}, content {}",remoteAddress,externalPingData);
    return;
  }
  String clusterName=request.containsKey("cluster_name") ? request.get("cluster_name").toString() : request.containsKey("clusterName") ? request.get("clusterName").toString() : null;
  if (clusterName == null) {
    logger.warn("malformed external ping request, missing 'cluster_name' element within request, from {}, content {}",remoteAddress,externalPingData);
    return;
  }
  if (!clusterName.equals(MulticastZenPing.this.clusterName.value())) {
    logger.trace("got request for cluster_name {}, but our cluster_name is {}, from {}, content {}",clusterName,MulticastZenPing.this.clusterName.value(),remoteAddress,externalPingData);
    return;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("got external ping request from {}, content {}",remoteAddress,externalPingData);
  }
  try {
    DiscoveryNode localNode=nodesProvider.nodes().localNode();
    XContentBuilder builder=XContentFactory.contentBuilder(contentType);
    builder.startObject().startObject("response");
    builder.field("cluster_name",MulticastZenPing.this.clusterName.value());
    builder.startObject("version").field("number",Version.CURRENT.number()).field("snapshot_build",Version.CURRENT.snapshot).endObject();
    builder.field("transport_address",localNode.address().toString());
    if (nodesProvider.nodeService() != null) {
      for (      Map.Entry<String,String> attr : nodesProvider.nodeService().attributes().entrySet()) {
        builder.field(attr.getKey(),attr.getValue());
      }
    }
    builder.startObject("attributes");
    for (    Map.Entry<String,String> attr : localNode.attributes().entrySet()) {
      builder.field(attr.getKey(),attr.getValue());
    }
    builder.endObject();
    builder.endObject().endObject();
synchronized (sendMutex) {
      BytesReference bytes=builder.bytes();
      datagramPacketSend.setData(bytes.array(),bytes.arrayOffset(),bytes.length());
      multicastSocket.send(datagramPacketSend);
      if (logger.isTraceEnabled()) {
        logger.trace("sending external ping response {}",builder.string());
      }
    }
  }
 catch (  Exception e) {
    logger.warn("failed to send external multicast response",e);
  }
}
