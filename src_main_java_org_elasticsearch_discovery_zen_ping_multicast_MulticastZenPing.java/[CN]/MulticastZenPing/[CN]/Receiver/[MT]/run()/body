{
  while (running) {
    try {
      int id=-1;
      DiscoveryNode requestingNodeX=null;
      ClusterName clusterName=null;
      Map<String,Object> externalPingData=null;
      XContentType xContentType=null;
synchronized (receiveMutex) {
        try {
          multicastSocket.receive(datagramPacketReceive);
        }
 catch (        SocketTimeoutException ignore) {
          continue;
        }
catch (        Exception e) {
          if (running) {
            logger.warn("failed to receive packet",e);
          }
          continue;
        }
        try {
          boolean internal=false;
          if (datagramPacketReceive.getLength() > 4) {
            int counter=0;
            for (; counter < INTERNAL_HEADER.length; counter++) {
              if (datagramPacketReceive.getData()[datagramPacketReceive.getOffset() + counter] != INTERNAL_HEADER[counter]) {
                break;
              }
            }
            if (counter == INTERNAL_HEADER.length) {
              internal=true;
            }
          }
          if (internal) {
            StreamInput input=CachedStreamInput.cachedHandles(new BytesStreamInput(datagramPacketReceive.getData(),datagramPacketReceive.getOffset() + INTERNAL_HEADER.length,datagramPacketReceive.getLength(),true));
            Version version=Version.readVersion(input);
            id=input.readInt();
            clusterName=ClusterName.readClusterName(input);
            requestingNodeX=readNode(input);
          }
 else {
            xContentType=XContentFactory.xContentType(datagramPacketReceive.getData(),datagramPacketReceive.getOffset(),datagramPacketReceive.getLength());
            if (xContentType != null) {
              externalPingData=XContentFactory.xContent(xContentType).createParser(datagramPacketReceive.getData(),datagramPacketReceive.getOffset(),datagramPacketReceive.getLength()).mapAndClose();
            }
 else {
              throw new ElasticSearchIllegalStateException("failed multicast message, probably message from previous version");
            }
          }
        }
 catch (        Exception e) {
          logger.warn("failed to read requesting data from {}",e,datagramPacketReceive.getSocketAddress());
          continue;
        }
      }
      if (externalPingData != null) {
        handleExternalPingRequest(externalPingData,xContentType,datagramPacketReceive.getSocketAddress());
      }
 else {
        handleNodePingRequest(id,requestingNodeX,clusterName);
      }
    }
 catch (    Exception e) {
      logger.warn("unexpected exception in multicast receiver",e);
    }
  }
}
