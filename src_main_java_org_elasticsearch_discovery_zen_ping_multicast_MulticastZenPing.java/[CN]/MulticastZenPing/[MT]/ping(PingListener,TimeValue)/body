{
  if (!pingEnabled) {
    threadPool.generic().execute(new Runnable(){
      @Override public void run(){
        listener.onPing(PingResponse.EMPTY);
      }
    }
);
    return;
  }
  final int id=pingIdGenerator.incrementAndGet();
  receivedResponses.put(id,new PingCollection());
  sendPingRequest(id);
  threadPool.schedule(TimeValue.timeValueMillis(timeout.millis() / 2),ThreadPool.Names.GENERIC,new Runnable(){
    @Override public void run(){
      try {
        sendPingRequest(id);
      }
 catch (      Exception e) {
        logger.warn("[{}] failed to send second ping request",e,id);
      }
    }
  }
);
  threadPool.schedule(timeout,ThreadPool.Names.GENERIC,new Runnable(){
    @Override public void run(){
      PingCollection responses=receivedResponses.remove(id);
      listener.onPing(responses.toArray());
    }
  }
);
}
