{
  XContentParser parser=parseContext.parser();
  Filter filter=null;
  Filter noMatchFilter=Queries.MATCH_ALL_FILTER;
  Filter chosenFilter=null;
  boolean filterFound=false;
  boolean indicesFound=false;
  boolean matchesConcreteIndices=false;
  String currentFieldName=null;
  XContentParser.Token token;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if ("filter".equals(currentFieldName)) {
        filterFound=true;
        if (indicesFound) {
          if (matchesConcreteIndices) {
            filter=parseContext.parseInnerFilter();
            chosenFilter=filter;
          }
 else {
            parseContext.parser().skipChildren();
          }
        }
 else {
          filter=parseContext.parseInnerFilter();
        }
      }
 else       if ("no_match_filter".equals(currentFieldName)) {
        if (indicesFound) {
          if (!matchesConcreteIndices) {
            noMatchFilter=parseContext.parseInnerFilter();
            chosenFilter=noMatchFilter;
          }
 else {
            parseContext.parser().skipChildren();
          }
        }
 else {
          noMatchFilter=parseContext.parseInnerFilter();
        }
      }
 else {
        throw new QueryParsingException(parseContext.index(),"[indices] filter does not support [" + currentFieldName + "]");
      }
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if ("indices".equals(currentFieldName)) {
        if (indicesFound) {
          throw new QueryParsingException(parseContext.index(),"[indices] indices already specified");
        }
        indicesFound=true;
        Collection<String> indices=new ArrayList<String>();
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          String value=parser.textOrNull();
          if (value == null) {
            throw new QueryParsingException(parseContext.index(),"No value specified for term filter");
          }
          indices.add(value);
        }
        matchesConcreteIndices=matchesIndices(parseContext,getConcreteIndices(indices));
      }
 else {
        throw new QueryParsingException(parseContext.index(),"[indices] filter does not support [" + currentFieldName + "]");
      }
    }
 else     if (token.isValue()) {
      if ("index".equals(currentFieldName)) {
        if (indicesFound) {
          throw new QueryParsingException(parseContext.index(),"[indices] indices already specified");
        }
        indicesFound=true;
        matchesConcreteIndices=matchesIndices(parseContext,getConcreteIndices(Arrays.asList(parser.text())));
      }
 else       if ("no_match_filter".equals(currentFieldName)) {
        String type=parser.text();
        if ("all".equals(type)) {
          noMatchFilter=Queries.MATCH_ALL_FILTER;
        }
 else         if ("none".equals(type)) {
          noMatchFilter=Queries.MATCH_NO_FILTER;
        }
        if (indicesFound) {
          if (!matchesConcreteIndices) {
            chosenFilter=noMatchFilter;
          }
        }
      }
 else {
        throw new QueryParsingException(parseContext.index(),"[indices] filter does not support [" + currentFieldName + "]");
      }
    }
  }
  if (!filterFound) {
    throw new QueryParsingException(parseContext.index(),"[indices] requires 'filter' element");
  }
  if (!indicesFound) {
    throw new QueryParsingException(parseContext.index(),"[indices] requires 'indices' element");
  }
  if (chosenFilter == null) {
    if (matchesConcreteIndices) {
      chosenFilter=filter;
    }
 else {
      chosenFilter=noMatchFilter;
    }
  }
  return chosenFilter;
}
