{
  String queryString=request.param("q");
  if (queryString == null) {
    return null;
  }
  QueryStringQueryBuilder queryBuilder=QueryBuilders.queryStringQuery(queryString);
  queryBuilder.defaultField(request.param("df"));
  queryBuilder.analyzer(request.param("analyzer"));
  queryBuilder.analyzeWildcard(request.paramAsBoolean("analyze_wildcard",false));
  queryBuilder.lowercaseExpandedTerms(request.paramAsBoolean("lowercase_expanded_terms",true));
  queryBuilder.lenient(request.paramAsBoolean("lenient",null));
  String defaultOperator=request.param("default_operator");
  if (defaultOperator != null) {
    if ("OR".equals(defaultOperator)) {
      queryBuilder.defaultOperator(QueryStringQueryBuilder.Operator.OR);
    }
 else     if ("AND".equals(defaultOperator)) {
      queryBuilder.defaultOperator(QueryStringQueryBuilder.Operator.AND);
    }
 else {
      throw new IllegalArgumentException("Unsupported defaultOperator [" + defaultOperator + "], can either be [OR] or [AND]");
    }
  }
  return new QuerySourceBuilder().setQuery(queryBuilder);
}
