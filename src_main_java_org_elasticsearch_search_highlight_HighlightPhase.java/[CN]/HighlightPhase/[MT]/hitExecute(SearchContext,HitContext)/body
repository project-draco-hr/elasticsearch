{
  Map<String,HighlightField> highlightFields=newHashMap();
  for (  SearchContextHighlight.Field field : context.highlight().fields()) {
    List<String> fieldNamesToHighlight;
    if (Regex.isSimpleMatchPattern(field.field())) {
      DocumentMapper documentMapper=context.mapperService().documentMapper(hitContext.hit().type());
      fieldNamesToHighlight=documentMapper.mappers().simpleMatchToFullName(field.field());
    }
 else {
      fieldNamesToHighlight=ImmutableList.of(field.field());
    }
    if (context.highlight().forceSource(field)) {
      SourceFieldMapper sourceFieldMapper=context.mapperService().documentMapper(hitContext.hit().type()).sourceMapper();
      if (!sourceFieldMapper.enabled()) {
        throw new IllegalArgumentException("source is forced for fields " + fieldNamesToHighlight + " but type ["+ hitContext.hit().type()+ "] has disabled _source");
      }
    }
    for (    String fieldName : fieldNamesToHighlight) {
      FieldMapper<?> fieldMapper=getMapperForField(fieldName,context,hitContext);
      if (fieldMapper == null) {
        continue;
      }
      String highlighterType=field.fieldOptions().highlighterType();
      if (highlighterType == null) {
        boolean useFastVectorHighlighter=fieldMapper.fieldType().storeTermVectors() && fieldMapper.fieldType().storeTermVectorOffsets() && fieldMapper.fieldType().storeTermVectorPositions();
        if (useFastVectorHighlighter) {
          highlighterType="fvh";
        }
 else         if (fieldMapper.fieldType().indexOptions() == IndexOptions.DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS) {
          highlighterType="postings";
        }
 else {
          highlighterType="plain";
        }
      }
      Highlighter highlighter=highlighters.get(highlighterType);
      if (highlighter == null) {
        throw new IllegalArgumentException("unknown highlighter type [" + highlighterType + "] for the field ["+ fieldName+ "]");
      }
      HighlighterContext.HighlightQuery highlightQuery;
      if (field.fieldOptions().highlightQuery() == null) {
        highlightQuery=new HighlighterContext.HighlightQuery(context.parsedQuery().query(),context.query(),context.queryRewritten());
      }
 else {
        highlightQuery=new HighlighterContext.HighlightQuery(field.fieldOptions().highlightQuery(),field.fieldOptions().highlightQuery(),false);
      }
      HighlighterContext highlighterContext=new HighlighterContext(fieldName,field,fieldMapper,context,hitContext,highlightQuery);
      HighlightField highlightField=highlighter.highlight(highlighterContext);
      if (highlightField != null) {
        highlightFields.put(highlightField.name(),highlightField);
      }
    }
  }
  hitContext.hit().highlightFields(highlightFields);
}
