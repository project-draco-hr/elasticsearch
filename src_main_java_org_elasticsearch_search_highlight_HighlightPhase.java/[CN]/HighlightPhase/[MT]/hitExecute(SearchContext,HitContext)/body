{
  Map<String,HighlightField> highlightFields=newHashMap();
  for (  SearchContextHighlight.Field field : context.highlight().fields()) {
    Set<String> fieldNamesToHighlight;
    if (Regex.isSimpleMatchPattern(field.field())) {
      DocumentMapper documentMapper=context.mapperService().documentMapper(hitContext.hit().type());
      fieldNamesToHighlight=documentMapper.mappers().simpleMatchToFullName(field.field());
    }
 else {
      fieldNamesToHighlight=ImmutableSet.of(field.field());
    }
    if (field.forceSource()) {
      SourceFieldMapper sourceFieldMapper=context.mapperService().documentMapper(hitContext.hit().type()).sourceMapper();
      if (!sourceFieldMapper.enabled()) {
        throw new ElasticSearchIllegalArgumentException("source is forced for field [" + field.field() + "] but type ["+ hitContext.hit().type()+ "] has disabled _source");
      }
    }
    for (    String fieldName : fieldNamesToHighlight) {
      FieldMapper<?> fieldMapper=getMapperForField(fieldName,context,hitContext);
      if (fieldMapper == null) {
        continue;
      }
      if (field.highlighterType() == null) {
        boolean useFastVectorHighlighter=fieldMapper.fieldType().storeTermVectors() && fieldMapper.fieldType().storeTermVectorOffsets() && fieldMapper.fieldType().storeTermVectorPositions();
        if (useFastVectorHighlighter) {
          field.highlighterType("fvh");
        }
 else         if (fieldMapper.fieldType().indexOptions() == FieldInfo.IndexOptions.DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS) {
          field.highlighterType("postings");
        }
 else {
          field.highlighterType("plain");
        }
      }
      Highlighter highlighter=highlighters.get(field.highlighterType());
      if (highlighter == null) {
        throw new ElasticSearchIllegalArgumentException("unknown highlighter type [" + field.highlighterType() + "] for the field ["+ fieldName+ "]");
      }
      HighlighterContext.HighlightQuery highlightQuery;
      if (field.highlightQuery() == null) {
        highlightQuery=new HighlighterContext.HighlightQuery(context.parsedQuery().query(),context.query(),context.queryRewritten());
      }
 else {
        highlightQuery=new HighlighterContext.HighlightQuery(field.highlightQuery(),field.highlightQuery(),false);
      }
      HighlighterContext highlighterContext=new HighlighterContext(fieldName,field,fieldMapper,context,hitContext,highlightQuery);
      HighlightField highlightField=highlighter.highlight(highlighterContext);
      if (highlightField != null) {
        highlightFields.put(highlightField.name(),highlightField);
      }
    }
  }
  hitContext.hit().highlightFields(highlightFields);
}
