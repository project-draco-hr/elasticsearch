{
  int numberOfHits=0;
  for (  AtomicArray.Entry<QueryFetchSearchResult> entry : queryFetchResults.asList()) {
    numberOfHits+=entry.value.queryResult().topDocs().scoreDocs.length;
  }
  ScoreDoc[] docs=new ScoreDoc[numberOfHits];
  int counter=0;
  for (  AtomicArray.Entry<QueryFetchSearchResult> entry : queryFetchResults.asList()) {
    ScoreDoc[] scoreDocs=entry.value.queryResult().topDocs().scoreDocs;
    for (    ScoreDoc scoreDoc : scoreDocs) {
      scoreDoc.shardIndex=entry.index;
      docs[counter++]=scoreDoc;
    }
  }
  final InternalSearchResponse internalResponse=searchPhaseController.merge(docs,queryFetchResults,queryFetchResults);
  ((InternalSearchHits)internalResponse.hits()).totalHits=Long.parseLong(this.scrollId.getAttributes().get("total_hits"));
  for (  AtomicArray.Entry<QueryFetchSearchResult> entry : queryFetchResults.asList()) {
    if (entry.value.queryResult().topDocs().scoreDocs.length < entry.value.queryResult().size()) {
      queryFetchResults.set(entry.index,null);
    }
  }
  String scrollId=null;
  if (request.scroll() != null) {
    scrollId=TransportSearchHelper.buildScrollId(this.scrollId.getType(),queryFetchResults,this.scrollId.getAttributes());
  }
  listener.onResponse(new SearchResponse(internalResponse,scrollId,this.scrollId.getContext().length,successfulOps.get(),buildTookInMillis(),buildShardFailures()));
}
