{
  TopDocsAndLeafCollector topDocsCollector=topDocsCollectors.get(owningBucketOrdinal);
  if (topDocsCollector == null) {
    return buildEmptyAggregation();
  }
 else {
    TopDocs topDocs=topDocsCollector.topLevelCollector.topDocs();
    if (topDocs.totalHits == 0) {
      return buildEmptyAggregation();
    }
    subSearchContext.queryResult().topDocs(topDocs);
    int[] docIdsToLoad=new int[topDocs.scoreDocs.length];
    for (int i=0; i < topDocs.scoreDocs.length; i++) {
      docIdsToLoad[i]=topDocs.scoreDocs[i].doc;
    }
    subSearchContext.docIdsToLoad(docIdsToLoad,0,docIdsToLoad.length);
    fetchPhase.execute(subSearchContext);
    FetchSearchResult fetchResult=subSearchContext.fetchResult();
    InternalSearchHit[] internalHits=fetchResult.fetchResult().hits().internalHits();
    for (int i=0; i < internalHits.length; i++) {
      ScoreDoc scoreDoc=topDocs.scoreDocs[i];
      InternalSearchHit searchHitFields=internalHits[i];
      searchHitFields.shard(subSearchContext.shardTarget());
      searchHitFields.score(scoreDoc.score);
      if (scoreDoc instanceof FieldDoc) {
        FieldDoc fieldDoc=(FieldDoc)scoreDoc;
        searchHitFields.sortValues(fieldDoc.fields);
      }
    }
    return new InternalTopHits(name,subSearchContext.from(),subSearchContext.size(),topDocs,fetchResult.hits(),reducers(),metaData());
  }
}
