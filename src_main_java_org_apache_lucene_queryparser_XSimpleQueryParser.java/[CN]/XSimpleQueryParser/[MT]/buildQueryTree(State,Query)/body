{
  if (branch != null) {
    if (state.not % 2 == 1) {
      BooleanQuery nq=new BooleanQuery();
      nq.add(branch,BooleanClause.Occur.MUST_NOT);
      nq.add(new MatchAllDocsQuery(),BooleanClause.Occur.SHOULD);
      branch=nq;
    }
    if (state.top == null) {
      state.top=branch;
    }
 else {
      if (state.currentOperation == null) {
        state.currentOperation=defaultOperator;
      }
      if (state.previousOperation != state.currentOperation) {
        BooleanQuery bq=new BooleanQuery();
        bq.add(state.top,state.currentOperation);
        state.top=bq;
      }
      ((BooleanQuery)state.top).add(branch,state.currentOperation);
      state.previousOperation=state.currentOperation;
    }
    state.currentOperation=null;
  }
}
