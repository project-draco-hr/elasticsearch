{
  ClusterState clusterState=clusterService.state();
  ClusterBlockException blockException=checkGlobalBlock(clusterState,request);
  if (blockException != null) {
    throw blockException;
  }
  request.setIndex(clusterState.metaData().concreteIndex(request.getIndex()));
  blockException=checkRequestBlock(clusterState,request);
  if (blockException != null) {
    throw blockException;
  }
  GroupShardsIterator groups;
  try {
    groups=shards(request);
  }
 catch (  Exception e) {
    listener.onFailure(e);
    return;
  }
  final AtomicInteger indexCounter=new AtomicInteger();
  final AtomicInteger completionCounter=new AtomicInteger(groups.size());
  final AtomicReferenceArray<Object> shardsResponses=new AtomicReferenceArray<Object>(groups.size());
  for (  final ShardIterator shardIt : groups) {
    ShardRequest shardRequest=newShardRequestInstance(request,shardIt.shardId().id());
    shardRequest.beforeLocalFork();
    shardRequest.setOperationThreaded(true);
    shardRequest.setListenerThreaded(false);
    shardAction.execute(shardRequest,new ActionListener<ShardResponse>(){
      @Override public void onResponse(      ShardResponse result){
        shardsResponses.set(indexCounter.getAndIncrement(),result);
        if (completionCounter.decrementAndGet() == 0) {
          listener.onResponse(newResponseInstance(request,shardsResponses));
        }
      }
      @Override public void onFailure(      Throwable e){
        int index=indexCounter.getAndIncrement();
        if (accumulateExceptions()) {
          shardsResponses.set(index,e);
        }
        if (completionCounter.decrementAndGet() == 0) {
          listener.onResponse(newResponseInstance(request,shardsResponses));
        }
      }
    }
);
  }
}
