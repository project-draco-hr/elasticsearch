{
  SearchResponse searchResponse=client().prepareSearch("idx").setQuery(matchAllQuery()).addAggregation(global("global").subAggregation(stats("stats").field("value"))).execute().actionGet();
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(10l));
  Global global=searchResponse.getAggregations().get("global");
  assertThat(global,notNullValue());
  assertThat(global.getName(),equalTo("global"));
  assertThat(global.getDocCount(),equalTo(10l));
  assertThat(global.getAggregations(),notNullValue());
  assertThat(global.getAggregations().asMap().size(),equalTo(1));
  Stats stats=global.getAggregations().get("stats");
  assertThat(stats,notNullValue());
  assertThat(stats.getName(),equalTo("stats"));
  Stats statsFromProperty=(Stats)global.getProperty("stats");
  assertThat(statsFromProperty,notNullValue());
  assertThat(statsFromProperty,sameInstance(stats));
  double expectedAvgValue=(double)(1 + 2 + 3+ 4+ 5+ 6+ 7+ 8+ 9+ 10) / 10;
  assertThat(stats.getAvg(),equalTo(expectedAvgValue));
  assertThat((double)global.getProperty("stats.avg"),equalTo(expectedAvgValue));
  double expectedMinValue=1.0;
  assertThat(stats.getMin(),equalTo(expectedMinValue));
  assertThat((double)global.getProperty("stats.min"),equalTo(expectedMinValue));
  double expectedMaxValue=10.0;
  assertThat(stats.getMax(),equalTo(expectedMaxValue));
  assertThat((double)global.getProperty("stats.max"),equalTo(expectedMaxValue));
  double expectedSumValue=1 + 2 + 3+ 4+ 5+ 6+ 7+ 8+ 9+ 10;
  assertThat(stats.getSum(),equalTo(expectedSumValue));
  assertThat((double)global.getProperty("stats.sum"),equalTo(expectedSumValue));
  long expectedCountValue=10;
  assertThat(stats.getCount(),equalTo(expectedCountValue));
  assertThat((double)global.getProperty("stats.count"),equalTo((double)expectedCountValue));
}
