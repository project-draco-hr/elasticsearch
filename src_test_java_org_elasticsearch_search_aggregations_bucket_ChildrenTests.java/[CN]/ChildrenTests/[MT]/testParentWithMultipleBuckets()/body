{
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(matchQuery("randomized",false)).addAggregation(terms("category").field("category").size(0).subAggregation(children("to_comment").childType("comment").subAggregation(topHits("top_comments").addSort("_id",SortOrder.ASC)))).get();
  assertSearchResponse(searchResponse);
  Terms categoryTerms=searchResponse.getAggregations().get("category");
  assertThat(categoryTerms.getBuckets().size(),equalTo(3));
  Terms.Bucket categoryBucket=categoryTerms.getBucketByKey("a");
  assertThat(categoryBucket.getKey(),equalTo("a"));
  assertThat(categoryBucket.getDocCount(),equalTo(3l));
  Children childrenBucket=categoryBucket.getAggregations().get("to_comment");
  assertThat(childrenBucket.getName(),equalTo("to_comment"));
  assertThat(childrenBucket.getDocCount(),equalTo(2l));
  TopHits topHits=childrenBucket.getAggregations().get("top_comments");
  assertThat(topHits.getHits().totalHits(),equalTo(2l));
  assertThat(topHits.getHits().getAt(0).sortValues()[0].toString(),equalTo("a"));
  assertThat(topHits.getHits().getAt(0).getId(),equalTo("a"));
  assertThat(topHits.getHits().getAt(1).sortValues()[0].toString(),equalTo("c"));
  assertThat(topHits.getHits().getAt(1).getId(),equalTo("c"));
  categoryBucket=categoryTerms.getBucketByKey("b");
  assertThat(categoryBucket.getKey(),equalTo("b"));
  assertThat(categoryBucket.getDocCount(),equalTo(2l));
  childrenBucket=categoryBucket.getAggregations().get("to_comment");
  assertThat(childrenBucket.getName(),equalTo("to_comment"));
  assertThat(childrenBucket.getDocCount(),equalTo(1l));
  topHits=childrenBucket.getAggregations().get("top_comments");
  assertThat(topHits.getHits().totalHits(),equalTo(1l));
  assertThat(topHits.getHits().getAt(0).getId(),equalTo("c"));
  categoryBucket=categoryTerms.getBucketByKey("c");
  assertThat(categoryBucket.getKey(),equalTo("c"));
  assertThat(categoryBucket.getDocCount(),equalTo(2l));
  childrenBucket=categoryBucket.getAggregations().get("to_comment");
  assertThat(childrenBucket.getName(),equalTo("to_comment"));
  assertThat(childrenBucket.getDocCount(),equalTo(1l));
  topHits=childrenBucket.getAggregations().get("top_comments");
  assertThat(topHits.getHits().totalHits(),equalTo(1l));
  assertThat(topHits.getHits().getAt(0).getId(),equalTo("c"));
}
