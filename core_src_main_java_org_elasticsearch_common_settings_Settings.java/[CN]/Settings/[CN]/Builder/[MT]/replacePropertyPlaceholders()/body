{
  PropertyPlaceholder propertyPlaceholder=new PropertyPlaceholder("${","}",false);
  PropertyPlaceholder.PlaceholderResolver placeholderResolver=new PropertyPlaceholder.PlaceholderResolver(){
    @Override public String resolvePlaceholder(    String placeholderName){
      if (placeholderName.startsWith("env.")) {
        return System.getenv(placeholderName.substring("env.".length()));
      }
      String value=System.getProperty(placeholderName);
      if (value != null) {
        return value;
      }
      value=System.getenv(placeholderName);
      if (value != null) {
        return value;
      }
      return map.get(placeholderName);
    }
    @Override public boolean shouldIgnoreMissing(    String placeholderName){
      if (placeholderName.startsWith("env.") || placeholderName.startsWith("prompt.")) {
        return true;
      }
      return false;
    }
    @Override public boolean shouldRemoveMissingPlaceholder(    String placeholderName){
      if (placeholderName.startsWith("prompt.")) {
        return false;
      }
      return true;
    }
  }
;
  for (  Map.Entry<String,String> entry : Maps.newHashMap(map).entrySet()) {
    String value=propertyPlaceholder.replacePlaceholders(entry.getValue(),placeholderResolver);
    if (Strings.hasLength(value)) {
      map.put(entry.getKey(),value);
    }
 else {
      map.remove(entry.getKey());
    }
  }
  return this;
}
