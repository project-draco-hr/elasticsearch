{
  if (shardResults.get(0).aggregations() == null) {
    return null;
  }
  List<InternalAggregations> aggregationsList=new ArrayList<>(shardResults.size());
  for (  PercolateShardResponse shardResult : shardResults) {
    aggregationsList.add(shardResult.aggregations());
  }
  InternalAggregations aggregations=InternalAggregations.reduce(aggregationsList,new ReduceContext(bigArrays,scriptService));
  if (aggregations != null) {
    List<SiblingPipelineAggregator> pipelineAggregators=shardResults.get(0).pipelineAggregators();
    if (pipelineAggregators != null) {
      List<InternalAggregation> newAggs=new ArrayList<>(Lists.transform(aggregations.asList(),PipelineAggregator.AGGREGATION_TRANFORM_FUNCTION));
      for (      SiblingPipelineAggregator pipelineAggregator : pipelineAggregators) {
        InternalAggregation newAgg=pipelineAggregator.doReduce(new InternalAggregations(newAggs),new ReduceContext(bigArrays,scriptService));
        newAggs.add(newAgg);
      }
      aggregations=new InternalAggregations(newAggs);
    }
  }
  return aggregations;
}
