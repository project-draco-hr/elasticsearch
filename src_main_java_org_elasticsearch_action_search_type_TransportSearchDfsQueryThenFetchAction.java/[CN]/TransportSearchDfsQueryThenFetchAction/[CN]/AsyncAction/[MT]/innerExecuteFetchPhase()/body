{
  sortedShardList=searchPhaseController.sortDocs(request,useSlowScroll,queryResults);
  searchPhaseController.fillDocIdsToLoad(docIdsToLoad,sortedShardList);
  if (docIdsToLoad.asList().isEmpty()) {
    finishHim();
    return;
  }
  final ScoreDoc[] lastEmittedDocPerShard=searchPhaseController.getLastEmittedDocPerShard(request,sortedShardList,firstResults.length());
  final AtomicInteger counter=new AtomicInteger(docIdsToLoad.asList().size());
  int localOperations=0;
  for (  final AtomicArray.Entry<IntArrayList> entry : docIdsToLoad.asList()) {
    QuerySearchResult queryResult=queryResults.get(entry.index);
    DiscoveryNode node=nodes.get(queryResult.shardTarget().nodeId());
    if (node.id().equals(nodes.localNodeId())) {
      localOperations++;
    }
 else {
      FetchSearchRequest fetchSearchRequest=createFetchRequest(queryResult,entry,lastEmittedDocPerShard);
      executeFetch(entry.index,queryResult.shardTarget(),counter,fetchSearchRequest,node);
    }
  }
  if (localOperations > 0) {
    if (request.operationThreading() == SearchOperationThreading.SINGLE_THREAD) {
      threadPool.executor(ThreadPool.Names.SEARCH).execute(new Runnable(){
        @Override public void run(){
          for (          final AtomicArray.Entry<IntArrayList> entry : docIdsToLoad.asList()) {
            QuerySearchResult queryResult=queryResults.get(entry.index);
            DiscoveryNode node=nodes.get(queryResult.shardTarget().nodeId());
            if (node.id().equals(nodes.localNodeId())) {
              FetchSearchRequest fetchSearchRequest=createFetchRequest(queryResult,entry,lastEmittedDocPerShard);
              executeFetch(entry.index,queryResult.shardTarget(),counter,fetchSearchRequest,node);
            }
          }
        }
      }
);
    }
 else {
      boolean localAsync=request.operationThreading() == SearchOperationThreading.THREAD_PER_SHARD;
      for (      final AtomicArray.Entry<IntArrayList> entry : docIdsToLoad.asList()) {
        final QuerySearchResult queryResult=queryResults.get(entry.index);
        final DiscoveryNode node=nodes.get(queryResult.shardTarget().nodeId());
        if (node.id().equals(nodes.localNodeId())) {
          final FetchSearchRequest fetchSearchRequest=createFetchRequest(queryResult,entry,lastEmittedDocPerShard);
          try {
            if (localAsync) {
              threadPool.executor(ThreadPool.Names.SEARCH).execute(new Runnable(){
                @Override public void run(){
                  executeFetch(entry.index,queryResult.shardTarget(),counter,fetchSearchRequest,node);
                }
              }
);
            }
 else {
              executeFetch(entry.index,queryResult.shardTarget(),counter,fetchSearchRequest,node);
            }
          }
 catch (          Throwable t) {
            onFetchFailure(t,fetchSearchRequest,entry.index,queryResult.shardTarget(),counter);
          }
        }
      }
    }
  }
}
