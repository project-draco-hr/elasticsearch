{
  CloseableThreadLocal<PerThreadIDAndVersionLookup> ctl=lookupStates.get(reader);
  if (ctl == null) {
    ctl=new CloseableThreadLocal<PerThreadIDAndVersionLookup>();
    CloseableThreadLocal<PerThreadIDAndVersionLookup> other=lookupStates.putIfAbsent(reader,ctl);
    if (other == null) {
      reader.addReaderClosedListener(removeLookupState);
    }
 else {
      ctl=other;
    }
  }
  PerThreadIDAndVersionLookup lookupState=ctl.get();
  if (lookupState == null) {
    lookupState=new PerThreadIDAndVersionLookup(reader);
    ctl.set(lookupState);
  }
  return lookupState;
}
