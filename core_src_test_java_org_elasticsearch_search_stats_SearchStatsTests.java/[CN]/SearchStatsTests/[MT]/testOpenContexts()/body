{
  String index="test1";
  createIndex(index);
  ensureGreen(index);
  final int docs=scaledRandomIntBetween(20,50);
  for (int s=0; s < numAssignedShards(index); s++) {
    for (int i=0; i < docs; i++) {
      client().prepareIndex(index,"type",Integer.toString(s * docs + i)).setSource("field","value").setRouting(Integer.toString(s)).execute().actionGet();
    }
  }
  client().admin().indices().prepareRefresh(index).execute().actionGet();
  IndicesStatsResponse indicesStats=client().admin().indices().prepareStats(index).execute().actionGet();
  assertThat(indicesStats.getTotal().getSearch().getOpenContexts(),equalTo(0l));
  int size=scaledRandomIntBetween(1,docs);
  SearchResponse searchResponse=client().prepareSearch().setSearchType(SearchType.SCAN).setQuery(matchAllQuery()).setSize(size).setScroll(TimeValue.timeValueMinutes(2)).execute().actionGet();
  assertSearchResponse(searchResponse);
  indicesStats=client().admin().indices().prepareStats(index).execute().actionGet();
  assertThat(indicesStats.getTotal().getSearch().getOpenContexts(),equalTo((long)numAssignedShards(index)));
  assertThat(indicesStats.getTotal().getSearch().getTotal().getScrollCurrent(),equalTo((long)numAssignedShards(index)));
  int hits=0;
  while (true) {
    hits+=searchResponse.getHits().getHits().length;
    searchResponse=client().prepareSearchScroll(searchResponse.getScrollId()).setScroll(TimeValue.timeValueMinutes(2)).execute().actionGet();
    if (searchResponse.getHits().getHits().length == 0) {
      break;
    }
  }
  long expected=0;
  IndicesStatsResponse r=client().admin().indices().prepareStats(index).execute().actionGet();
  for (int s=0; s < numAssignedShards(index); s++) {
    expected+=1 + (long)Math.ceil(r.getShards()[s].getStats().getDocs().getCount() / size);
  }
  indicesStats=client().admin().indices().prepareStats().execute().actionGet();
  Stats stats=indicesStats.getTotal().getSearch().getTotal();
  assertEquals(hits,docs * numAssignedShards(index));
  assertThat(stats.getQueryCount(),equalTo(expected));
  assertThat(stats.getScrollCount(),equalTo((long)numAssignedShards(index)));
  assertThat(stats.getScrollTimeInMillis(),greaterThan(0l));
  searchResponse=client().prepareSearchScroll(searchResponse.getScrollId()).execute().actionGet();
  indicesStats=client().admin().indices().prepareStats().execute().actionGet();
  assertThat(indicesStats.getTotal().getSearch().getOpenContexts(),equalTo(0l));
}
