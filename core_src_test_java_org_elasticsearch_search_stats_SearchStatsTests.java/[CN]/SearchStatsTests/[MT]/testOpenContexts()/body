{
  createIndex("test1");
  ensureGreen("test1");
  final int docs=scaledRandomIntBetween(20,50);
  for (int i=0; i < docs; i++) {
    client().prepareIndex("test1","type",Integer.toString(i)).setSource("field","value").execute().actionGet();
  }
  IndicesStatsResponse indicesStats=client().admin().indices().prepareStats().execute().actionGet();
  assertThat(indicesStats.getTotal().getSearch().getOpenContexts(),equalTo(0l));
  SearchResponse searchResponse=client().prepareSearch().setSearchType(SearchType.SCAN).setQuery(matchAllQuery()).setSize(5).setScroll(TimeValue.timeValueMinutes(2)).execute().actionGet();
  assertSearchResponse(searchResponse);
  indicesStats=client().admin().indices().prepareStats().execute().actionGet();
  assertThat(indicesStats.getTotal().getSearch().getOpenContexts(),equalTo((long)numAssignedShards("test1")));
  assertThat(indicesStats.getTotal().getSearch().getTotal().getScrollCurrent(),equalTo((long)numAssignedShards("test1")));
  int count=0;
  while (true) {
    count++;
    searchResponse=client().prepareSearchScroll(searchResponse.getScrollId()).setScroll(TimeValue.timeValueMinutes(2)).execute().actionGet();
    if (searchResponse.getHits().getHits().length == 0) {
      break;
    }
  }
  indicesStats=client().admin().indices().prepareStats().execute().actionGet();
  Stats stats=indicesStats.getTotal().getSearch().getTotal();
  assertThat(stats.getQueryCount(),equalTo(count * (long)numAssignedShards("test1")));
  assertThat(stats.getScrollCount(),equalTo((long)numAssignedShards("test1")));
  assertThat(stats.getScrollTimeInMillis(),greaterThan(0l));
  searchResponse=client().prepareSearchScroll(searchResponse.getScrollId()).execute().actionGet();
  indicesStats=client().admin().indices().prepareStats().execute().actionGet();
  assertThat(indicesStats.getTotal().getSearch().getOpenContexts(),equalTo(0l));
}
