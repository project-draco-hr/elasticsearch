{
  RoutingTable routingTable;
  AllocationService strategy=createAllocationService(Settings.builder().build());
  RoutingAllocation.Result routingResult=strategy.reroute(clusterState,"reroute");
  clusterState=ClusterState.builder(clusterState).routingResult(routingResult).build();
  int numRelocations=0;
  while (true) {
    List<ShardRouting> initializing=clusterState.routingTable().shardsWithState(INITIALIZING);
    if (initializing.isEmpty()) {
      break;
    }
    logger.debug("Initializing shards: {}",initializing);
    numRelocations+=initializing.size();
    routingResult=strategy.applyStartedShards(clusterState,initializing);
    clusterState=ClusterState.builder(clusterState).routingResult(routingResult).build();
  }
  logger.debug("--> num relocations to get balance: {}",numRelocations);
  return clusterState;
}
