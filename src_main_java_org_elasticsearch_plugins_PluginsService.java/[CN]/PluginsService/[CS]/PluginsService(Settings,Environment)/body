{
  super(settings);
  this.environment=environment;
  loadPluginsIntoClassLoader();
  Map<String,Plugin> plugins=Maps.newHashMap();
  plugins.putAll(loadPluginsFromClasspath(settings));
  logger.info("loaded {}, sites {}",plugins.keySet(),sitePlugins());
  this.plugins=ImmutableMap.copyOf(plugins);
  MapBuilder<Plugin,List<OnModuleReference>> onModuleReferences=MapBuilder.newMapBuilder();
  for (  Plugin plugin : plugins.values()) {
    List<OnModuleReference> list=Lists.newArrayList();
    for (    Method method : plugin.getClass().getDeclaredMethods()) {
      if (!method.getName().equals("onModule")) {
        continue;
      }
      if (method.getParameterTypes().length == 0 || method.getParameterTypes().length > 1) {
        logger.warn("Plugin: {} implementing onModule with no parameters or more than one parameter",plugin.name());
        continue;
      }
      Class moduleClass=method.getParameterTypes()[0];
      if (!Module.class.isAssignableFrom(moduleClass)) {
        logger.warn("Plugin: {} implementing onModule by the type is not of Module type {}",plugin.name(),moduleClass);
        continue;
      }
      method.setAccessible(true);
      list.add(new OnModuleReference(moduleClass,method));
    }
    if (!list.isEmpty()) {
      onModuleReferences.put(plugin,list);
    }
  }
  this.onModuleReferences=onModuleReferences.immutableMap();
}
