{
  ImmutableMap.Builder<String,TestDiffable> builder=ImmutableMap.builder();
  builder.put("foo",new TestDiffable("1"));
  builder.put("bar",new TestDiffable("2"));
  builder.put("baz",new TestDiffable("3"));
  ImmutableMap<String,TestDiffable> before=builder.build();
  Map<String,TestDiffable> map=newHashMap();
  map.putAll(before);
  map.remove("bar");
  map.put("baz",new TestDiffable("4"));
  map.put("new",new TestDiffable("5"));
  ImmutableMap<String,TestDiffable> after=ImmutableMap.copyOf(map);
  Diff diff=DiffableUtils.diff(before,after);
  BytesStreamOutput out=new BytesStreamOutput();
  diff.writeTo(out);
  StreamInput in=StreamInput.wrap(out.bytes());
  ImmutableMap<String,TestDiffable> serialized=DiffableUtils.readImmutableMapDiff(in,TestDiffable.PROTO).apply(before);
  assertThat(serialized.size(),equalTo(3));
  assertThat(serialized.get("foo").value(),equalTo("1"));
  assertThat(serialized.get("baz").value(),equalTo("4"));
  assertThat(serialized.get("new").value(),equalTo("5"));
}
