{
  ChannelPipeline pipeline=super.getPipeline();
  pipeline.replace("dispatcher","dispatcher",new MessageChannelHandler(nettyTransport,logger,TransportSettings.DEFAULT_PROFILE){
    @Override protected String handleRequest(    Channel channel,    Marker marker,    StreamInput buffer,    long requestId,    int messageLengthBytes,    Version version) throws IOException {
      String action=super.handleRequest(channel,marker,buffer,requestId,messageLengthBytes,version);
      channelProfileName=this.profileName;
      return action;
    }
    @Override protected void validateRequest(    Marker marker,    StreamInput buffer,    long requestId,    String action) throws IOException {
      super.validateRequest(marker,buffer,requestId,action);
      String error=threadPool.getThreadContext().getHeader("ERROR");
      if (error != null) {
        throw new ElasticsearchException(error);
      }
    }
  }
);
  return pipeline;
}
