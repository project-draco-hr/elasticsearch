{
  return preparePercolate(request,new PercolateAction(){
    @Override public PercolateShardResponse doPercolateAction(    PercolateContext context){
      long count=0;
      if (context.query == null) {
        Lucene.ExistsCollector collector=new Lucene.ExistsCollector();
        for (        Map.Entry<Text,Query> entry : context.percolateQueries.entrySet()) {
          collector.reset();
          try {
            context.docSearcher.search(entry.getValue(),collector);
          }
 catch (          IOException e) {
            logger.warn("[" + entry.getKey() + "] failed to execute query",e);
          }
          if (collector.exists()) {
            count++;
          }
        }
      }
 else {
        Engine.Searcher percolatorSearcher=context.indexShard.searcher();
        try {
          Count countCollector=count(logger,context.percolateQueries,context.docSearcher,context.fieldDataService);
          percolatorSearcher.searcher().search(context.query,countCollector);
          count=countCollector.counter();
        }
 catch (        IOException e) {
          logger.warn("failed to execute",e);
        }
 finally {
          percolatorSearcher.release();
        }
      }
      return new PercolateShardResponse(count,context,request.index(),request.shardId());
    }
  }
);
}
