{
  IndexService percolateIndexService=indicesService.indexServiceSafe(request.index());
  IndexShard indexShard=percolateIndexService.shardSafe(request.shardId());
  ShardPercolateService shardPercolateService=indexShard.shardPercolateService();
  shardPercolateService.prePercolate();
  long startTime=System.nanoTime();
  try {
    SearchShardTarget searchShardTarget=new SearchShardTarget(clusterService.localNode().id(),request.index(),request.shardId());
    final PercolateContext context=new PercolateContext(request,searchShardTarget,indexShard,percolateIndexService);
    ParsedDocument parsedDocument=parseRequest(percolateIndexService,request,context);
    if (context.percolateQueries().isEmpty()) {
      return new PercolateShardResponse(context,request.index(),request.shardId());
    }
    if (request.docSource() != null && request.docSource().length() != 0) {
      parsedDocument=parseFetchedDoc(request.docSource(),percolateIndexService,request.documentType());
    }
 else     if (parsedDocument == null) {
      throw new ElasticSearchIllegalArgumentException("Nothing to percolate");
    }
    if (context.percolateQuery() == null && (context.score || context.sort)) {
      throw new ElasticSearchIllegalArgumentException("Can't sort or score if query isn't specified");
    }
    if (context.sort && !context.limit) {
      throw new ElasticSearchIllegalArgumentException("Can't sort if size isn't specified");
    }
    if (context.highlight() != null && !context.limit) {
      throw new ElasticSearchIllegalArgumentException("Can't highlight if size isn't specified");
    }
    if (context.size < 0) {
      context.size=0;
    }
    final MemoryIndex memoryIndex=cache.get();
    try {
      for (      IndexableField field : parsedDocument.rootDoc().getFields()) {
        if (!field.fieldType().indexed()) {
          continue;
        }
        if (field.name().equals(UidFieldMapper.NAME)) {
          continue;
        }
        TokenStream tokenStream;
        try {
          tokenStream=field.tokenStream(parsedDocument.analyzer());
          if (tokenStream != null) {
            memoryIndex.addField(field.name(),tokenStream,field.boost());
          }
        }
 catch (        IOException e) {
          throw new ElasticSearchException("Failed to create token stream",e);
        }
      }
      PercolatorType action;
      if (request.onlyCount()) {
        action=context.percolateQuery() != null ? queryCountPercolator : countPercolator;
      }
 else {
        if (context.sort) {
          action=topMatchingPercolator;
        }
 else         if (context.percolateQuery() != null) {
          action=context.score ? scoringPercolator : queryPercolator;
        }
 else {
          action=matchPercolator;
        }
      }
      context.percolatorTypeId=action.id();
      context.initialize(memoryIndex,parsedDocument);
      return action.doPercolate(request,context);
    }
  finally {
      context.release();
    }
  }
  finally {
    shardPercolateService.postPercolate(System.nanoTime() - startTime);
  }
}
