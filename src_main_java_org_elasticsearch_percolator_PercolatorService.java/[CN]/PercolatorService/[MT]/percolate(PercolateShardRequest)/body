{
  IndexService percolateIndexService=indicesService.indexServiceSafe(request.index());
  IndexShard indexShard=percolateIndexService.shardSafe(request.shardId());
  ShardPercolateService shardPercolateService=indexShard.shardPercolateService();
  shardPercolateService.prePercolate();
  long startTime=System.nanoTime();
  try {
    final PercolateContext context=new PercolateContext();
    context.percolateQueries=indexShard.percolateRegistry().percolateQueries();
    context.indexShard=indexShard;
    context.percolateIndexService=percolateIndexService;
    ParsedDocument parsedDocument=parsePercolate(percolateIndexService,request,context);
    if (context.percolateQueries.isEmpty()) {
      return new PercolateShardResponse(context,request.index(),request.shardId());
    }
    if (request.docSource() != null && request.docSource().length() != 0) {
      parsedDocument=parseFetchedDoc(request.docSource(),percolateIndexService,request.documentType());
    }
 else     if (parsedDocument == null) {
      throw new ElasticSearchIllegalArgumentException("Nothing to percolate");
    }
    if (context.query == null && (context.score || context.sort)) {
      throw new ElasticSearchIllegalArgumentException("Can't sort or score if no query is specified");
    }
    if (context.size < 0) {
      context.size=0;
    }
    final MemoryIndex memoryIndex=cache.get();
    try {
      for (      IndexableField field : parsedDocument.rootDoc().getFields()) {
        if (!field.fieldType().indexed()) {
          continue;
        }
        if (field.name().equals(UidFieldMapper.NAME)) {
          continue;
        }
        TokenStream tokenStream;
        try {
          tokenStream=field.tokenStream(parsedDocument.analyzer());
          if (tokenStream != null) {
            memoryIndex.addField(field.name(),tokenStream,field.boost());
          }
        }
 catch (        IOException e) {
          throw new ElasticSearchException("Failed to create token stream",e);
        }
      }
      PercolatorType action;
      if (request.onlyCount()) {
        action=context.query != null ? queryCountPercolator : countPercolator;
      }
 else {
        if (context.sort) {
          action=topMatchingPercolator;
        }
 else         if (context.query != null) {
          action=context.score ? scoringPercolator : queryPercolator;
        }
 else {
          action=matchPercolator;
        }
      }
      context.docSearcher=memoryIndex.createSearcher();
      context.fieldData=percolateIndexService.fieldData();
      IndexCache indexCache=percolateIndexService.cache();
      try {
        return action.doPercolate(request,context);
      }
  finally {
        indexCache.clear(context.docSearcher.getIndexReader());
        context.fieldData.clear(context.docSearcher.getIndexReader());
      }
    }
  finally {
      memoryIndex.reset();
    }
  }
  finally {
    shardPercolateService.postPercolate(System.nanoTime() - startTime);
  }
}
