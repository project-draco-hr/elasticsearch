{
  SearchResponse searchResponse=client().prepareSearch("articles").setQuery(matchQuery("title","title")).addAggregation(nested("to-comments").path("comments").subAggregation(nested("to-reviewers").path("comments.reviewers").subAggregation(topHits("top-reviewers").addSort("comments.reviewers.name",SortOrder.ASC).addSort("_doc",SortOrder.DESC).setSize(7))).subAggregation(topHits("top-comments").addSort("comments.date",SortOrder.DESC).setSize(4))).get();
  assertNoFailures(searchResponse);
  Nested toComments=searchResponse.getAggregations().get("to-comments");
  assertThat(toComments.getDocCount(),equalTo(4l));
  TopHits topComments=toComments.getAggregations().get("top-comments");
  assertThat(topComments.getHits().totalHits(),equalTo(4l));
  assertThat(topComments.getHits().getHits().length,equalTo(4));
  assertThat(topComments.getHits().getAt(0).getId(),equalTo("2"));
  assertThat(topComments.getHits().getAt(0).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topComments.getHits().getAt(0).getNestedIdentity().getOffset(),equalTo(1));
  assertThat(topComments.getHits().getAt(0).getNestedIdentity().getChild(),nullValue());
  assertThat(topComments.getHits().getAt(1).getId(),equalTo("2"));
  assertThat(topComments.getHits().getAt(1).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topComments.getHits().getAt(1).getNestedIdentity().getOffset(),equalTo(0));
  assertThat(topComments.getHits().getAt(1).getNestedIdentity().getChild(),nullValue());
  assertThat(topComments.getHits().getAt(2).getId(),equalTo("1"));
  assertThat(topComments.getHits().getAt(2).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topComments.getHits().getAt(2).getNestedIdentity().getOffset(),equalTo(1));
  assertThat(topComments.getHits().getAt(2).getNestedIdentity().getChild(),nullValue());
  assertThat(topComments.getHits().getAt(3).getId(),equalTo("1"));
  assertThat(topComments.getHits().getAt(3).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topComments.getHits().getAt(3).getNestedIdentity().getOffset(),equalTo(0));
  assertThat(topComments.getHits().getAt(3).getNestedIdentity().getChild(),nullValue());
  Nested toReviewers=toComments.getAggregations().get("to-reviewers");
  assertThat(toReviewers.getDocCount(),equalTo(7l));
  TopHits topReviewers=toReviewers.getAggregations().get("top-reviewers");
  assertThat(topReviewers.getHits().totalHits(),equalTo(7l));
  assertThat(topReviewers.getHits().getHits().length,equalTo(7));
  assertThat(topReviewers.getHits().getAt(0).getId(),equalTo("1"));
  assertThat((String)topReviewers.getHits().getAt(0).sourceAsMap().get("name"),equalTo("user a"));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getOffset(),equalTo(0));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getChild().getField().string(),equalTo("reviewers"));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getChild().getOffset(),equalTo(0));
  assertThat(topReviewers.getHits().getAt(1).getId(),equalTo("1"));
  assertThat((String)topReviewers.getHits().getAt(1).sourceAsMap().get("name"),equalTo("user b"));
  assertThat(topReviewers.getHits().getAt(1).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topReviewers.getHits().getAt(1).getNestedIdentity().getOffset(),equalTo(0));
  assertThat(topReviewers.getHits().getAt(1).getNestedIdentity().getChild().getField().string(),equalTo("reviewers"));
  assertThat(topReviewers.getHits().getAt(1).getNestedIdentity().getChild().getOffset(),equalTo(1));
  assertThat(topReviewers.getHits().getAt(2).getId(),equalTo("1"));
  assertThat((String)topReviewers.getHits().getAt(2).sourceAsMap().get("name"),equalTo("user c"));
  assertThat(topReviewers.getHits().getAt(2).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topReviewers.getHits().getAt(2).getNestedIdentity().getOffset(),equalTo(0));
  assertThat(topReviewers.getHits().getAt(2).getNestedIdentity().getChild().getField().string(),equalTo("reviewers"));
  assertThat(topReviewers.getHits().getAt(2).getNestedIdentity().getChild().getOffset(),equalTo(2));
  assertThat(topReviewers.getHits().getAt(3).getId(),equalTo("1"));
  assertThat((String)topReviewers.getHits().getAt(3).sourceAsMap().get("name"),equalTo("user c"));
  assertThat(topReviewers.getHits().getAt(3).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topReviewers.getHits().getAt(3).getNestedIdentity().getOffset(),equalTo(1));
  assertThat(topReviewers.getHits().getAt(3).getNestedIdentity().getChild().getField().string(),equalTo("reviewers"));
  assertThat(topReviewers.getHits().getAt(3).getNestedIdentity().getChild().getOffset(),equalTo(0));
  assertThat(topReviewers.getHits().getAt(4).getId(),equalTo("1"));
  assertThat((String)topReviewers.getHits().getAt(4).sourceAsMap().get("name"),equalTo("user d"));
  assertThat(topReviewers.getHits().getAt(4).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topReviewers.getHits().getAt(4).getNestedIdentity().getOffset(),equalTo(1));
  assertThat(topReviewers.getHits().getAt(4).getNestedIdentity().getChild().getField().string(),equalTo("reviewers"));
  assertThat(topReviewers.getHits().getAt(4).getNestedIdentity().getChild().getOffset(),equalTo(1));
  assertThat(topReviewers.getHits().getAt(5).getId(),equalTo("1"));
  assertThat((String)topReviewers.getHits().getAt(5).sourceAsMap().get("name"),equalTo("user e"));
  assertThat(topReviewers.getHits().getAt(5).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topReviewers.getHits().getAt(5).getNestedIdentity().getOffset(),equalTo(1));
  assertThat(topReviewers.getHits().getAt(5).getNestedIdentity().getChild().getField().string(),equalTo("reviewers"));
  assertThat(topReviewers.getHits().getAt(5).getNestedIdentity().getChild().getOffset(),equalTo(2));
  assertThat(topReviewers.getHits().getAt(6).getId(),equalTo("2"));
  assertThat((String)topReviewers.getHits().getAt(6).sourceAsMap().get("name"),equalTo("user f"));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getOffset(),equalTo(0));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getChild().getField().string(),equalTo("reviewers"));
  assertThat(topReviewers.getHits().getAt(0).getNestedIdentity().getChild().getOffset(),equalTo(0));
}
