{
  String hlType=randomFrom("plain","fvh","postings");
  HighlightBuilder.Field hlField=new HighlightBuilder.Field("comments.message").highlightQuery(matchQuery("comments.message","comment")).forceSource(randomBoolean()).highlighterType(hlType);
  SearchResponse searchResponse=client().prepareSearch("articles").setQuery(nestedQuery("comments",matchQuery("comments.message","comment").queryName("test"))).addAggregation(nested("to-comments").path("comments").subAggregation(topHits("top-comments").setSize(1).highlighter(new HighlightBuilder().field(hlField)).setExplain(true).addFieldDataField("comments.user").addScriptField("script",new Script("doc['comments.user'].value")).setFetchSource("message",null).setVersion(true).addSort("comments.date",SortOrder.ASC))).get();
  assertHitCount(searchResponse,2);
  Nested nested=searchResponse.getAggregations().get("to-comments");
  assertThat(nested.getDocCount(),equalTo(4l));
  SearchHits hits=((TopHits)nested.getAggregations().get("top-comments")).getHits();
  assertThat(hits.totalHits(),equalTo(4l));
  SearchHit searchHit=hits.getAt(0);
  assertThat(searchHit.getId(),equalTo("1"));
  assertThat(searchHit.getNestedIdentity().getField().string(),equalTo("comments"));
  assertThat(searchHit.getNestedIdentity().getOffset(),equalTo(0));
  HighlightField highlightField=searchHit.getHighlightFields().get("comments.message");
  assertThat(highlightField.getFragments().length,equalTo(1));
  assertThat(highlightField.getFragments()[0].string(),equalTo("some <em>comment</em>"));
  Explanation explanation=searchHit.explanation();
  assertFalse(explanation.isMatch());
  long version=searchHit.version();
  assertThat(version,equalTo(1l));
  assertThat(searchHit.matchedQueries(),arrayContaining("test"));
  SearchHitField field=searchHit.field("comments.user");
  assertThat(field.getValue().toString(),equalTo("a"));
  field=searchHit.field("script");
  assertThat(field.getValue().toString(),equalTo("a"));
  assertThat(searchHit.sourceAsMap().size(),equalTo(1));
  assertThat(searchHit.sourceAsMap().get("message").toString(),equalTo("some comment"));
}
