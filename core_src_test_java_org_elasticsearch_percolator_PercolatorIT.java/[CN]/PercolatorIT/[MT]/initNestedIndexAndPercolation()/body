{
  XContentBuilder mapping=XContentFactory.jsonBuilder();
  mapping.startObject().startObject("properties").startObject("companyname").field("type","string").endObject().startObject("employee").field("type","nested").startObject("properties").startObject("name").field("type","string").endObject().endObject().endObject().endObject().endObject();
  assertAcked(client().admin().indices().prepareCreate("nestedindex").addMapping("company",mapping));
  ensureGreen("nestedindex");
  client().prepareIndex("nestedindex",PercolatorService.TYPE_NAME,"Q").setSource(jsonBuilder().startObject().field("query",QueryBuilders.nestedQuery("employee",QueryBuilders.matchQuery("employee.name","virginia potts").operator(MatchQueryBuilder.Operator.AND)).scoreMode("avg")).endObject()).get();
  refresh();
}
