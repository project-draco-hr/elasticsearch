{
  XContentBuilder mapping=XContentFactory.jsonBuilder();
  mapping.startObject().startObject("properties").startObject("companyname").field("type","text").endObject().startObject("employee").field("type","nested").startObject("properties").startObject("name").field("type","text").endObject().endObject().endObject().endObject().endObject();
  assertAcked(client().admin().indices().prepareCreate("nestedindex").addMapping("company",mapping));
  ensureGreen("nestedindex");
  client().prepareIndex("nestedindex",PercolatorFieldMapper.TYPE_NAME,"Q").setSource(jsonBuilder().startObject().field("query",QueryBuilders.nestedQuery("employee",QueryBuilders.matchQuery("employee.name","virginia potts").operator(Operator.AND)).scoreMode(ScoreMode.Avg)).endObject()).get();
  refresh();
}
