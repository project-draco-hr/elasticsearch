{
  client().admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",2)).execute().actionGet();
  ensureGreen();
  logger.info("--> register a queries");
  for (int i=1; i <= 100; i++) {
    client().prepareIndex("test",PercolatorFieldMapper.TYPE_NAME,Integer.toString(i)).setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).setRouting(Integer.toString(i % 2)).execute().actionGet();
  }
  refresh();
  logger.info("--> Percolate doc with no routing");
  PercolateResponse response=client().preparePercolate().setIndices("test").setDocumentType("type").setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject())).setSize(100).execute().actionGet();
  assertMatchCount(response,100L);
  assertThat(response.getMatches(),arrayWithSize(100));
  logger.info("--> Percolate doc with routing=0");
  response=client().preparePercolate().setIndices("test").setDocumentType("type").setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject())).setSize(100).setRouting("0").execute().actionGet();
  assertMatchCount(response,50L);
  assertThat(response.getMatches(),arrayWithSize(50));
  logger.info("--> Percolate doc with routing=1");
  response=client().preparePercolate().setIndices("test").setDocumentType("type").setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject())).setSize(100).setRouting("1").execute().actionGet();
  assertMatchCount(response,50L);
  assertThat(response.getMatches(),arrayWithSize(50));
}
