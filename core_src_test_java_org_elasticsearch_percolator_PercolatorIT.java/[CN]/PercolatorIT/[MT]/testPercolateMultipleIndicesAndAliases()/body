{
  createIndex("test1","test2");
  ensureGreen();
  logger.info("--> registering queries");
  for (int i=1; i <= 10; i++) {
    String index=i % 2 == 0 ? "test1" : "test2";
    client().prepareIndex(index,PercolatorService.TYPE_NAME,Integer.toString(i)).setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).execute().actionGet();
  }
  logger.info("--> Percolate doc to index test1");
  PercolateResponse response=client().preparePercolate().setIndices("test1").setDocumentType("type").setSource(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject()).execute().actionGet();
  assertMatchCount(response,5l);
  assertThat(response.getMatches(),arrayWithSize(5));
  logger.info("--> Percolate doc to index test2");
  response=client().preparePercolate().setIndices("test2").setDocumentType("type").setSource(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject()).execute().actionGet();
  assertMatchCount(response,5l);
  assertThat(response.getMatches(),arrayWithSize(5));
  logger.info("--> Percolate doc to index test1 and test2");
  response=client().preparePercolate().setIndices("test1","test2").setDocumentType("type").setSource(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject()).execute().actionGet();
  assertMatchCount(response,10l);
  assertThat(response.getMatches(),arrayWithSize(10));
  logger.info("--> Percolate doc to index test2 and test3, with ignore missing");
  response=client().preparePercolate().setIndices("test1","test3").setDocumentType("type").setIndicesOptions(IndicesOptions.lenientExpandOpen()).setSource(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject()).execute().actionGet();
  assertMatchCount(response,5l);
  assertThat(response.getMatches(),arrayWithSize(5));
  logger.info("--> Adding aliases");
  IndicesAliasesResponse aliasesResponse=client().admin().indices().prepareAliases().addAlias("test1","my-alias1").addAlias("test2","my-alias1").addAlias("test2","my-alias2").setTimeout(TimeValue.timeValueHours(10)).execute().actionGet();
  assertTrue(aliasesResponse.isAcknowledged());
  logger.info("--> Percolate doc to my-alias1");
  response=client().preparePercolate().setIndices("my-alias1").setDocumentType("type").setSource(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject()).execute().actionGet();
  assertMatchCount(response,10l);
  assertThat(response.getMatches(),arrayWithSize(10));
  for (  PercolateResponse.Match match : response) {
    assertThat(match.getIndex().string(),anyOf(equalTo("test1"),equalTo("test2")));
  }
  logger.info("--> Percolate doc to my-alias2");
  response=client().preparePercolate().setIndices("my-alias2").setDocumentType("type").setSource(jsonBuilder().startObject().startObject("doc").field("field1","value").endObject().endObject()).execute().actionGet();
  assertMatchCount(response,5l);
  assertThat(response.getMatches(),arrayWithSize(5));
  for (  PercolateResponse.Match match : response) {
    assertThat(match.getIndex().string(),equalTo("test2"));
  }
}
