{
  final String nodeId=generateNodeId(settings);
  Map<String,String> attributes=new HashMap<>(Node.NODE_ATTRIBUTES.get(this.settings).getAsMap());
  Set<DiscoveryNode.Role> roles=new HashSet<>();
  if (Node.NODE_INGEST_SETTING.get(settings)) {
    roles.add(DiscoveryNode.Role.INGEST);
  }
  if (Node.NODE_MASTER_SETTING.get(settings)) {
    roles.add(DiscoveryNode.Role.MASTER);
  }
  if (Node.NODE_DATA_SETTING.get(settings)) {
    roles.add(DiscoveryNode.Role.DATA);
  }
  for (  CustomAttributesProvider provider : customAttributesProviders) {
    try {
      Map<String,String> customAttributes=provider.buildAttributes();
      if (customAttributes != null) {
        for (        Map.Entry<String,String> entry : customAttributes.entrySet()) {
          if (!attributes.containsKey(entry.getKey())) {
            attributes.put(entry.getKey(),entry.getValue());
          }
        }
      }
    }
 catch (    Exception e) {
      logger.warn("failed to build custom attributes from provider [{}]",e,provider);
    }
  }
  return new DiscoveryNode(Node.NODE_NAME_SETTING.get(settings),nodeId,publishAddress,attributes,roles,version);
}
