{
  int activeShardCount=0;
  for (  ShardId shardId : availableShards()) {
    Boolean isActive=getShardActive(shardId);
    if (isActive == null) {
      continue;
    }
 else     if (isActive) {
      activeShardCount++;
    }
    Boolean wasActive=shardWasActive.get(shardId);
    if (wasActive == null) {
      shardWasActive.put(shardId,isActive);
      changes.add(ShardStatusChangeType.ADDED);
    }
 else     if (isActive) {
      if (wasActive == false) {
        changes.add(ShardStatusChangeType.BECAME_ACTIVE);
        logger.debug("marking shard {} as active indexing wise",shardId);
        shardWasActive.put(shardId,true);
      }
 else       if (isShardInactive(shardId,inactiveTime.nanos())) {
        changes.add(ShardStatusChangeType.BECAME_INACTIVE);
        logger.debug("marking shard {} as inactive (inactive_time[{}]) indexing wise",shardId,inactiveTime);
        markShardAsInactive(shardId);
        shardWasActive.put(shardId,false);
      }
    }
  }
  return activeShardCount;
}
