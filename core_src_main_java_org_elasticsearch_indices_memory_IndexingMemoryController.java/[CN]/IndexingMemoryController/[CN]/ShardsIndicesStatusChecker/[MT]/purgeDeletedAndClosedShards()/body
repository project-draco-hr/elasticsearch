{
  EnumSet<ShardStatusChangeType> changes=EnumSet.noneOf(ShardStatusChangeType.class);
  Iterator<ShardId> statusShardIdIterator=shardsIndicesStatus.keySet().iterator();
  while (statusShardIdIterator.hasNext()) {
    ShardId statusShardId=statusShardIdIterator.next();
    IndexService indexService=indicesService.indexService(statusShardId.getIndex());
    boolean remove;
    if (indexService == null) {
      remove=true;
    }
 else {
      IndexShard indexShard=indexService.shard(statusShardId.id());
      if (indexShard == null) {
        remove=true;
      }
 else {
        remove=!CAN_UPDATE_INDEX_BUFFER_STATES.contains(indexShard.state());
      }
    }
    if (remove) {
      changes.add(ShardStatusChangeType.DELETED);
      statusShardIdIterator.remove();
    }
  }
  return changes;
}
