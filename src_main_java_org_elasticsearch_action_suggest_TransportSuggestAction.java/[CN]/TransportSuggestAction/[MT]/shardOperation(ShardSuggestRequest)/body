{
  IndexService indexService=indicesService.indexServiceSafe(request.index());
  IndexShard indexShard=indexService.shardSafe(request.shardId());
  final Engine.Searcher searcher=indexShard.acquireSearcher("suggest");
  XContentParser parser=null;
  try {
    BytesReference suggest=request.suggest();
    if (suggest != null && suggest.length() > 0) {
      parser=XContentFactory.xContent(suggest).createParser(suggest);
      if (parser.nextToken() != XContentParser.Token.START_OBJECT) {
        throw new ElasticsearchIllegalArgumentException("suggest content missing");
      }
      final SuggestionSearchContext context=suggestPhase.parseElement().parseInternal(parser,indexService.mapperService(),request.index(),request.shardId());
      final Suggest result=suggestPhase.execute(context,searcher.reader());
      return new ShardSuggestResponse(request.index(),request.shardId(),result);
    }
    return new ShardSuggestResponse(request.index(),request.shardId(),new Suggest());
  }
 catch (  Throwable ex) {
    throw new ElasticsearchException("failed to execute suggest",ex);
  }
 finally {
    searcher.release();
    if (parser != null) {
      parser.close();
    }
  }
}
