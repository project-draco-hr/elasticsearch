{
  Compressor compressor=CompressorFactory.compressor(request.bytes());
  StreamInput in;
  if (compressor != null) {
    in=compressor.streamInput(request.bytes().streamInput());
  }
 else {
    in=request.bytes().streamInput();
  }
  in.setVersion(request.version());
synchronized (this) {
    if (in.readBoolean()) {
      lastSeenClusterState=ClusterState.Builder.readFrom(in,nodesProvider.nodes().localNode());
      logger.debug("received full cluster state version {} with size {}",lastSeenClusterState.version(),request.bytes().length());
    }
 else     if (lastSeenClusterState != null) {
      Diff<ClusterState> diff=lastSeenClusterState.readDiffFrom(in);
      lastSeenClusterState=diff.apply(lastSeenClusterState);
      logger.debug("received diff cluster state version {} with uuid {}, diff size {}",lastSeenClusterState.version(),lastSeenClusterState.stateUUID(),request.bytes().length());
    }
 else {
      logger.debug("received diff for but don't have any local cluster state - requesting full state");
      throw new IncompatibleClusterStateVersionException("have no local cluster state");
    }
    lastSeenClusterState.status(ClusterState.ClusterStateStatus.RECEIVED);
  }
  try {
    listener.onNewClusterState(lastSeenClusterState,new NewClusterStateListener.NewStateProcessed(){
      @Override public void onNewClusterStateProcessed(){
        try {
          channel.sendResponse(TransportResponse.Empty.INSTANCE);
        }
 catch (        Throwable e) {
          logger.debug("failed to send response on cluster state processed",e);
        }
      }
      @Override public void onNewClusterStateFailed(      Throwable t){
        try {
          channel.sendResponse(t);
        }
 catch (        Throwable e) {
          logger.debug("failed to send response on cluster state processed",e);
        }
      }
    }
);
  }
 catch (  Exception e) {
    logger.warn("unexpected error while processing cluster state version [{}]",e,lastSeenClusterState.version());
    try {
      channel.sendResponse(e);
    }
 catch (    Throwable e1) {
      logger.debug("failed to send response on cluster state processed",e1);
    }
  }
}
