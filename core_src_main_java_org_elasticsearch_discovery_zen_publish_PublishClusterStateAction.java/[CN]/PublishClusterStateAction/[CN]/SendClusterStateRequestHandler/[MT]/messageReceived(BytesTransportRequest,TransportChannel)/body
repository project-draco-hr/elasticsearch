{
  Compressor compressor=CompressorFactory.compressor(request.bytes());
  StreamInput in;
  if (compressor != null) {
    in=compressor.streamInput(request.bytes().streamInput());
  }
 else {
    in=request.bytes().streamInput();
  }
  in.setVersion(request.version());
synchronized (lastSeenClusterStateMutex) {
    final ClusterState incomingState;
    if (in.readBoolean()) {
      incomingState=ClusterState.Builder.readFrom(in,nodesProvider.nodes().localNode());
      logger.debug("received full cluster state version [{}] with size [{}]",incomingState.version(),request.bytes().length());
    }
 else     if (lastSeenClusterState != null) {
      Diff<ClusterState> diff=lastSeenClusterState.readDiffFrom(in);
      incomingState=diff.apply(lastSeenClusterState);
      logger.debug("received diff cluster state version [{}] with uuid [{}], diff size [{}]",incomingState.version(),incomingState.stateUUID(),request.bytes().length());
    }
 else {
      logger.debug("received diff for but don't have any local cluster state - requesting full state");
      throw new IncompatibleClusterStateVersionException("have no local cluster state");
    }
    final ClusterName incomingClusterName=incomingState.getClusterName();
    if (!incomingClusterName.equals(PublishClusterStateAction.this.clusterName)) {
      logger.warn("received cluster state from [{}] which is also master but with a different cluster name [{}]",incomingState.nodes().masterNode(),incomingClusterName);
      throw new IllegalStateException("received state from a node that is not part of the cluster");
    }
    if (incomingState.nodes().localNode() == null) {
      logger.warn("received a cluster state from [{}] and not part of the cluster, should not happen",incomingState.nodes().masterNode());
      throw new IllegalStateException("received state from a node that is not part of the cluster");
    }
    if (nodesProvider.nodes().localNodeMaster() == false) {
      ZenDiscovery.rejectNewClusterStateIfNeeded(logger,nodesProvider.nodes(),incomingState);
    }
    lastSeenClusterState=incomingState;
    lastSeenClusterState.status(ClusterState.ClusterStateStatus.RECEIVED);
  }
  channel.sendResponse(TransportResponse.Empty.INSTANCE);
}
