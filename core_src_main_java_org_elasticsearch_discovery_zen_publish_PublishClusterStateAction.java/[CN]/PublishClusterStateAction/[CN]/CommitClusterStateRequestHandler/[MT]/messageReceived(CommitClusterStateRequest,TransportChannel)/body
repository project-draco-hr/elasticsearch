{
  ClusterState committedClusterState;
synchronized (lastSeenClusterStateMutex) {
    committedClusterState=lastSeenClusterState;
  }
  if (committedClusterState.stateUUID().equals(request.stateUUID) == false) {
    channel.sendResponse(TransportResponse.Empty.INSTANCE);
    return;
  }
  try {
    listener.onNewClusterState(committedClusterState,new NewClusterStateListener.NewStateProcessed(){
      @Override public void onNewClusterStateProcessed(){
        try {
          channel.sendResponse(TransportResponse.Empty.INSTANCE);
        }
 catch (        Throwable e) {
          logger.debug("failed to send response on cluster state processed",e);
        }
      }
      @Override public void onNewClusterStateFailed(      Throwable t){
        try {
          channel.sendResponse(t);
        }
 catch (        Throwable e) {
          logger.debug("failed to send response on cluster state processed",e);
        }
      }
    }
);
  }
 catch (  Exception e) {
    logger.warn("unexpected error while processing cluster state version [{}]",e,lastSeenClusterState.version());
    try {
      channel.sendResponse(e);
    }
 catch (    Throwable e1) {
      logger.debug("failed to send response on cluster state processed",e1);
    }
  }
}
