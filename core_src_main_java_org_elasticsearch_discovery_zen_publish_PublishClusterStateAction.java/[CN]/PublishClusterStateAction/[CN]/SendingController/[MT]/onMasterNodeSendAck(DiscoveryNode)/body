{
  logger.trace("master node {} acked cluster state version [{}]. processing ... (current pending [{}], needed [{}])",node,clusterState.version(),pendingMasterNodes,neededMastersToCommit);
  neededMastersToCommit--;
  if (neededMastersToCommit == 0) {
    logger.trace("committing version [{}]",clusterState.version());
    for (    DiscoveryNode nodeToCommit : sendAckedBeforeCommit) {
      sendCommitToNode(nodeToCommit,clusterState,this);
    }
    sendAckedBeforeCommit.clear();
    boolean success=committed.compareAndSet(false,true);
    assert success;
    comittedOrFailed.countDown();
  }
  onMasterNodeDone(node);
}
