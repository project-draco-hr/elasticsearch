{
  Diff<ClusterState> diff=null;
  for (  final DiscoveryNode node : nodesToPublishTo) {
    try {
      if (sendFullVersion || !previousState.nodes().nodeExists(node.id())) {
        if (serializedStates.containsKey(node.version()) == false) {
          serializedStates.put(node.version(),serializeFullClusterState(clusterState,node.version()));
        }
      }
 else {
        if (diff == null) {
          diff=clusterState.diff(previousState);
        }
        if (serializedDiffs.containsKey(node.version()) == false) {
          serializedDiffs.put(node.version(),serializeDiffClusterState(diff,node.version()));
        }
      }
    }
 catch (    IOException e) {
      throw new ElasticsearchException("failed to serialize cluster_state for publishing to node {}",e,node);
    }
  }
}
