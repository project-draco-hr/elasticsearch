{
  final ClusterName incomingClusterName=incomingState.getClusterName();
  if (!incomingClusterName.equals(this.clusterName)) {
    logger.warn("received cluster state from [{}] which is also master but with a different cluster name [{}]",incomingState.nodes().masterNode(),incomingClusterName);
    throw new IllegalStateException("received state from a node that is not part of the cluster");
  }
  final DiscoveryNodes currentNodes=nodesProvider.nodes();
  if (currentNodes.localNode().equals(incomingState.nodes().localNode()) == false) {
    logger.warn("received a cluster state from [{}] and not part of the cluster, should not happen",incomingState.nodes().masterNode());
    throw new IllegalStateException("received state from a node that is not part of the cluster");
  }
  ZenDiscovery.validateStateIsFromCurrentMaster(logger,currentNodes,incomingState);
  if (lastSeenClusterState != null && lastSeenClusterState.supersedes(incomingState)) {
    final String message=String.format(Locale.ROOT,"received cluster state from current master superseded by last seen cluster state; " + "received version [%s] with uuid [%s], last seen version [%s] with uuid [%s]",incomingState.version(),incomingState.stateUUID(),lastSeenClusterState.version(),lastSeenClusterState.stateUUID());
    logger.warn(message);
    throw new IllegalStateException(message);
  }
}
