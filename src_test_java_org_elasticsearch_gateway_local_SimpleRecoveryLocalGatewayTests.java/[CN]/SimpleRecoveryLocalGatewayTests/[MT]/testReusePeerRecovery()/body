{
  ImmutableSettings.Builder settings=settingsBuilder().put("action.admin.cluster.node.shutdown.delay","10ms").put("gateway.recover_after_nodes",4).put(BalancedShardsAllocator.SETTING_THRESHOLD,1.1f);
  cluster().startNode(settings);
  cluster().startNode(settings);
  cluster().startNode(settings);
  cluster().startNode(settings);
  logger.info("--> indexing docs");
  for (int i=0; i < 1000; i++) {
    client().prepareIndex("test","type").setSource("field","value").execute().actionGet();
    if ((i % 200) == 0) {
      client().admin().indices().prepareFlush().execute().actionGet();
    }
  }
  logger.info("Running Cluster Health");
  ClusterHealthResponse clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForGreenStatus().waitForRelocatingShards(0)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("--> shutting down the nodes");
  client().admin().cluster().prepareUpdateSettings().setTransientSettings(settingsBuilder().put(DisableAllocationDecider.CLUSTER_ROUTING_ALLOCATION_DISABLE_ALLOCATION,true)).execute().actionGet();
  cluster().fullRestart();
  logger.info("Running Cluster Health");
  clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForGreenStatus().waitForActiveShards(10)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("--> shutting down the nodes");
  client().admin().cluster().prepareUpdateSettings().setTransientSettings(settingsBuilder().put(DisableAllocationDecider.CLUSTER_ROUTING_ALLOCATION_DISABLE_ALLOCATION,true)).execute().actionGet();
  cluster().fullRestart();
  logger.info("Running Cluster Health");
  clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForGreenStatus().waitForActiveShards(10)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  IndicesStatusResponse statusResponse=client().admin().indices().prepareStatus("test").setRecovery(true).execute().actionGet();
  for (  IndexShardStatus indexShardStatus : statusResponse.getIndex("test")) {
    for (    ShardStatus shardStatus : indexShardStatus) {
      if (!shardStatus.getShardRouting().primary()) {
        logger.info("--> shard {}, recovered {}, reuse {}",shardStatus.getShardId(),shardStatus.getPeerRecoveryStatus().getRecoveredIndexSize(),shardStatus.getPeerRecoveryStatus().getReusedIndexSize());
        assertThat(shardStatus.getPeerRecoveryStatus().getRecoveredIndexSize().bytes(),greaterThan(0l));
        assertThat(shardStatus.getPeerRecoveryStatus().getReusedIndexSize().bytes(),greaterThan(0l));
        assertThat(shardStatus.getPeerRecoveryStatus().getReusedIndexSize().bytes(),greaterThan(shardStatus.getPeerRecoveryStatus().getRecoveredIndexSize().bytes()));
      }
    }
  }
}
