{
  boolean changed=false;
  for (Iterator<RoutingNode> it=allocation.routingNodes().nodesToShards().values().iterator(); it.hasNext(); ) {
    RoutingNode node=it.next();
    if (allocation.nodes().dataNodes().containsKey(node.nodeId())) {
      continue;
    }
    changed=true;
    for (    MutableShardRouting shardRouting : new ArrayList<MutableShardRouting>(node.shards())) {
      applyFailedShard(allocation,shardRouting);
    }
    it.remove();
  }
  return changed;
}
