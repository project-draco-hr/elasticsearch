{
  Iterable<DiscoveryNode> dataNodes=allocation.nodes().dataNodes().values();
  boolean changed=false;
  changed|=deassociateDeadNodes(allocation);
  applyNewNodes(allocation);
  changed|=electPrimariesAndUnassignDanglingReplicas(allocation);
  if (allocation.routingNodes().hasUnassigned()) {
    changed|=shardsAllocators.allocateUnassigned(allocation);
    changed|=electPrimariesAndUnassignDanglingReplicas(allocation);
  }
  changed|=moveShards(allocation);
  changed|=shardsAllocators.rebalance(allocation);
  return changed;
}
