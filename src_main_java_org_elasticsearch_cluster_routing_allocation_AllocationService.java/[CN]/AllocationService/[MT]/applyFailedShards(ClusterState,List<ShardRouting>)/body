{
  RoutingNodes routingNodes=clusterState.routingNodes();
  Collections.shuffle(routingNodes.unassigned());
  FailedRerouteAllocation allocation=new FailedRerouteAllocation(allocationDeciders,routingNodes,clusterState.nodes(),failedShards);
  boolean changed=false;
  for (  ShardRouting failedShard : failedShards) {
    changed|=applyFailedShard(allocation,failedShard,true);
  }
  if (!changed) {
    return new RoutingAllocation.Result(false,clusterState.routingTable(),allocation.explanation());
  }
  shardsAllocators.applyFailedShards(allocation);
  reroute(allocation);
  return new RoutingAllocation.Result(true,new RoutingTable.Builder().updateNodes(routingNodes).build().validateRaiseException(clusterState.metaData()),allocation.explanation());
}
