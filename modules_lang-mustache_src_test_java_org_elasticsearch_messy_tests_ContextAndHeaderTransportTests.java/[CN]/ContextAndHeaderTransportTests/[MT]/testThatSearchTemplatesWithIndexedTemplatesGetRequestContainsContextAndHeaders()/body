{
  PutIndexedScriptResponse scriptResponse=transportClient().preparePutIndexedScript(MustacheScriptEngineService.NAME,"the_template",jsonBuilder().startObject().startObject("template").startObject("query").startObject("match").field("name","{{query_string}}").endObject().endObject().endObject().endObject().string()).get();
  assertThat(scriptResponse.isCreated(),is(true));
  transportClient().prepareIndex(queryIndex,"type","1").setSource(jsonBuilder().startObject().field("name","Star Wars - The new republic").endObject()).get();
  transportClient().admin().indices().prepareRefresh(queryIndex).get();
  Map<String,Object> params=new HashMap<>();
  params.put("query_string","star wars");
  SearchResponse searchResponse=transportClient().prepareSearch(queryIndex).setTemplate(new Template("the_template",ScriptType.INDEXED,MustacheScriptEngineService.NAME,null,params)).get();
  assertNoFailures(searchResponse);
  assertHitCount(searchResponse,1);
  assertGetRequestsContainHeaders(".scripts");
  assertRequestsContainHeader(PutIndexedScriptRequest.class);
}
