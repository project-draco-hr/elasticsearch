{
  for (  long missingValue : new long[]{0,randomLong()}) {
    for (    MultiValueMode mode : MultiValueMode.values()) {
      if (MultiValueMode.MEDIAN.equals(mode)) {
        continue;
      }
      final NumericDoubleValues selected=mode.select(values,missingValue);
      for (int i=0; i < maxDoc; ++i) {
        final double actual=selected.get(i);
        double expected;
        values.setDocument(i);
        int numValues=values.count();
        if (numValues == 0) {
          expected=missingValue;
        }
 else {
          expected=mode.startLong();
          for (int j=0; j < numValues; ++j) {
            expected=mode.apply(expected,values.valueAt(j));
          }
          expected=mode.reduce(expected,numValues);
        }
        assertEquals(mode.toString() + " docId=" + i,expected,actual,0.1);
      }
    }
  }
}
