{
  List<FiltersAggregator.KeyedFilter> filters=new ArrayList<>();
  XContentParser.Token token=null;
  String currentFieldName=null;
  Boolean keyed=null;
  String otherBucketKey=null;
  boolean otherBucket=false;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.VALUE_BOOLEAN) {
      if (context.parseFieldMatcher().match(currentFieldName,OTHER_BUCKET_FIELD)) {
        otherBucket=parser.booleanValue();
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else     if (token == XContentParser.Token.VALUE_STRING) {
      if (context.parseFieldMatcher().match(currentFieldName,OTHER_BUCKET_KEY_FIELD)) {
        otherBucketKey=parser.text();
        otherBucket=true;
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if (context.parseFieldMatcher().match(currentFieldName,FILTERS_FIELD)) {
        keyed=true;
        String key=null;
        while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
          if (token == XContentParser.Token.FIELD_NAME) {
            key=parser.currentName();
          }
 else {
            ParsedQuery filter=context.getQueryShardContext().parseInnerFilter(parser);
            filters.add(new FiltersAggregator.KeyedFilter(key,filter == null ? Queries.newMatchAllQuery() : filter.query()));
          }
        }
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else     if (token == XContentParser.Token.START_ARRAY) {
      if (context.parseFieldMatcher().match(currentFieldName,FILTERS_FIELD)) {
        keyed=false;
        int idx=0;
        while ((token=parser.nextToken()) != XContentParser.Token.END_ARRAY) {
          ParsedQuery filter=context.getQueryShardContext().parseInnerFilter(parser);
          filters.add(new FiltersAggregator.KeyedFilter(String.valueOf(idx),filter == null ? Queries.newMatchAllQuery() : filter.query()));
          idx++;
        }
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else {
      throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
    }
  }
  if (otherBucket && otherBucketKey == null) {
    otherBucketKey="_other_";
  }
  return new FiltersAggregator.Factory(aggregationName,filters,keyed,otherBucketKey);
}
