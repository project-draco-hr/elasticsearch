{
  BulkRequest bulkRequest=Requests.bulkRequest();
  String defaultIndex=request.param("index");
  String defaultType=request.param("type");
  String defaultRouting=request.param("routing");
  String fieldsParam=request.param("fields");
  String defaultPipeline=request.param("pipeline");
  String[] defaultFields=fieldsParam != null ? Strings.commaDelimitedListToStringArray(fieldsParam) : null;
  String consistencyLevel=request.param("consistency");
  if (consistencyLevel != null) {
    bulkRequest.consistencyLevel(WriteConsistencyLevel.fromString(consistencyLevel));
  }
  bulkRequest.timeout(request.paramAsTime("timeout",BulkShardRequest.DEFAULT_TIMEOUT));
  bulkRequest.refresh(request.paramAsBoolean("refresh",bulkRequest.refresh()));
  bulkRequest.add(request.content(),defaultIndex,defaultType,defaultRouting,defaultFields,defaultPipeline,null,allowExplicitIndex);
  client.bulk(bulkRequest,new RestBuilderListener<BulkResponse>(channel){
    @Override public RestResponse buildResponse(    BulkResponse response,    XContentBuilder builder) throws Exception {
      builder.startObject();
      builder.field(Fields.TOOK,response.getTookInMillis());
      if (response.getIngestTookInMillis() != BulkResponse.NO_INGEST_TOOK) {
        builder.field(Fields.INGEST_TOOK,response.getIngestTookInMillis());
      }
      builder.field(Fields.ERRORS,response.hasFailures());
      builder.startArray(Fields.ITEMS);
      for (      BulkItemResponse itemResponse : response) {
        builder.startObject();
        itemResponse.toXContent(builder,request);
        builder.endObject();
      }
      builder.endArray();
      builder.endObject();
      return new BytesRestResponse(OK,builder);
    }
  }
);
}
