{
  CreateIndexRequestBuilder builder=prepareCreate("test").setSettings(settingsBuilder().put(indexSettings()).put("index.analysis.analyzer.reverse.tokenizer","standard").putArray("index.analysis.analyzer.reverse.filter","lowercase","reverse").put("index.analysis.analyzer.body.tokenizer","standard").putArray("index.analysis.analyzer.body.filter","lowercase").put("index.analysis.analyzer.bigram.tokenizer","standard").putArray("index.analysis.analyzer.bigram.filter","my_shingle","lowercase").put("index.analysis.filter.my_shingle.type","shingle").put("index.analysis.filter.my_shingle.output_unigrams",false).put("index.analysis.filter.my_shingle.min_shingle_size",2).put("index.analysis.filter.my_shingle.max_shingle_size",2));
  XContentBuilder mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("_all").field("store",true).field("termVector","with_positions_offsets").endObject().startObject("properties").startObject("body").field("type","text").field("analyzer","body").endObject().startObject("body_reverse").field("type","text").field("analyzer","reverse").endObject().startObject("bigram").field("type","text").field("analyzer","bigram").endObject().endObject().endObject().endObject();
  assertAcked(builder.addMapping("type1",mapping));
  ensureGreen();
  for (  String line : readMarvelHeroNames()) {
    index("test","type1",line,"body",line,"body_reverse",line,"bigram",line);
  }
  refresh();
  PhraseSuggestionBuilder phraseSuggest=phraseSuggestion("simple_phrase").field("bigram").gramSize(2).analyzer("body").addCandidateGenerator(candidateGenerator("body").minWordLength(1).suggestMode("always")).size(1);
  Suggest searchSuggest=searchSuggest("american ame",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","american ace");
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("american ame"));
  phraseSuggest.realWordErrorLikelihood(0.95f);
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel"));
  phraseSuggest.highlight("<em>","</em>");
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getOptions().get(0).getHighlighted().string(),equalTo("<em>xorr</em> the <em>god</em> jewel"));
  phraseSuggest.highlight(null,null).confidence(0f).size(1).maxErrors(0.5f);
  searchSuggest=searchSuggest("Xorr the God-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  phraseSuggest.confidence(2f);
  searchSuggest=searchSuggest("Xorr the God-Jewel",phraseSuggest);
  assertSuggestionSize(searchSuggest,0,0,"simple_phrase");
  phraseSuggest.confidence(0.99f);
  searchSuggest=searchSuggest("Xorr the God-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  phraseSuggest.addCandidateGenerator(candidateGenerator("body").minWordLength(1).suggestMode("always")).addCandidateGenerator(candidateGenerator("body_reverse").minWordLength(1).suggestMode("always").preFilter("reverse").postFilter("reverse"));
  searchSuggest=searchSuggest("xor the yod-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  phraseSuggest.clearCandidateGenerators().addCandidateGenerator(candidateGenerator("body").minWordLength(1).suggestMode("always")).smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(1,0,0));
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestionSize(searchSuggest,0,0,"simple_phrase");
  phraseSuggest.smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(0,1,0));
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  phraseSuggest.smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(0.4,0.4,0.2));
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  searchSuggest=searchSuggest("american ame",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","american ace");
  phraseSuggest.smoothingModel(new PhraseSuggestionBuilder.LinearInterpolation(0.4,0.4,0.2));
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  phraseSuggest.smoothingModel(new PhraseSuggestionBuilder.Laplace(0.2));
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  phraseSuggest.smoothingModel(new PhraseSuggestionBuilder.StupidBackoff(0.1));
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel");
  phraseSuggest.smoothingModel(null).tokenLimit(4);
  searchSuggest=searchSuggest("Xor the Got-Jewel",phraseSuggest);
  assertSuggestionSize(searchSuggest,0,0,"simple_phrase");
  phraseSuggest.tokenLimit(15).smoothingModel(new PhraseSuggestionBuilder.StupidBackoff(0.1));
  searchSuggest=searchSuggest("Xor the Got-Jewel Xor the Got-Jewel Xor the Got-Jewel",phraseSuggest);
  assertSuggestion(searchSuggest,0,"simple_phrase","xorr the god jewel xorr the god jewel xorr the god jewel");
  assertThat(searchSuggest.getSuggestion("simple_phrase").getEntries().get(0).getText().string(),equalTo("Xor the Got-Jewel Xor the Got-Jewel Xor the Got-Jewel"));
}
