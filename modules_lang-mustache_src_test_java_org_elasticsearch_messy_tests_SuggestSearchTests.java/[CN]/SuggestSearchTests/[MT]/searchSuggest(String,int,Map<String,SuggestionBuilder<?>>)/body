{
  if (randomBoolean()) {
    SearchRequestBuilder builder=client().prepareSearch().setSize(0);
    SuggestBuilder suggestBuilder=new SuggestBuilder();
    if (suggestText != null) {
      suggestBuilder.setGlobalText(suggestText);
    }
    for (    Entry<String,SuggestionBuilder<?>> suggestion : suggestions.entrySet()) {
      suggestBuilder.addSuggestion(suggestion.getKey(),suggestion.getValue());
    }
    builder.suggest(suggestBuilder);
    SearchResponse actionGet=builder.execute().actionGet();
    assertThat(Arrays.toString(actionGet.getShardFailures()),actionGet.getFailedShards(),equalTo(expectShardsFailed));
    return actionGet.getSuggest();
  }
 else {
    SuggestRequestBuilder builder=client().prepareSuggest();
    if (suggestText != null) {
      builder.setSuggestText(suggestText);
    }
    for (    Entry<String,SuggestionBuilder<?>> suggestion : suggestions.entrySet()) {
      builder.addSuggestion(suggestion.getKey(),suggestion.getValue());
    }
    SuggestResponse actionGet=builder.execute().actionGet();
    assertThat(Arrays.toString(actionGet.getShardFailures()),actionGet.getFailedShards(),equalTo(expectShardsFailed));
    if (expectShardsFailed > 0) {
      throw new SearchPhaseExecutionException("suggest","Suggest execution failed",new ShardSearchFailure[0]);
    }
    return actionGet.getSuggest();
  }
}
