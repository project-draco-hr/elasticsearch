{
  readAllowed();
  IndexQueryParser queryParser=queryParserService.defaultIndexQueryParser();
  if (queryParserName != null) {
    queryParser=queryParserService.indexQueryParser(queryParserName);
    if (queryParser == null) {
      throw new IndexQueryParserMissingException(queryParserName);
    }
  }
  Query query=queryParser.parse(querySource);
  query=new ConstantScoreQuery(filterCache.cache(new QueryWrapperFilter(query)));
  query=filterByTypesIfNeeded(query,types);
  Engine.Searcher searcher=engine.searcher();
  try {
    long count=Lucene.count(searcher.searcher(),query,minScore);
    if (logger.isTraceEnabled()) {
      logger.trace("Count of [{}] is [{}]",query,count);
    }
    return count;
  }
 catch (  IOException e) {
    throw new ElasticSearchException("Failed to count query [" + query + "]",e);
  }
 finally {
    searcher.release();
  }
}
