{
  if (types != null && types.length > 0) {
    if (types.length == 1) {
      String type=types[0];
      DocumentMapper docMapper=mapperService.documentMapper(type);
      if (docMapper == null) {
        throw new TypeMissingException(shardId.index(),type);
      }
      query=new FilteredQuery(query,indexCache.filter().cache(docMapper.typeFilter()));
    }
 else {
      XBooleanFilter booleanFilter=new XBooleanFilter();
      for (      String type : types) {
        DocumentMapper docMapper=mapperService.documentMapper(type);
        if (docMapper == null) {
          throw new TypeMissingException(shardId.index(),type);
        }
        booleanFilter.add(new FilterClause(indexCache.filter().cache(docMapper.typeFilter()),BooleanClause.Occur.SHOULD));
      }
      query=new FilteredQuery(query,booleanFilter);
    }
  }
  return query;
}
