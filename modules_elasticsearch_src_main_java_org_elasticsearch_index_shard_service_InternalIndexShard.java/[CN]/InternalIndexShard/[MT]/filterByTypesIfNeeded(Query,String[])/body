{
  if (types != null && types.length > 0) {
    if (types.length == 1) {
      String type=types[0];
      DocumentMapper docMapper=mapperService.documentMapper(type);
      if (docMapper == null) {
        throw new TypeMissingException(shardId.index(),type);
      }
      Filter typeFilter=new TermFilter(docMapper.typeMapper().term(docMapper.type()));
      typeFilter=indexCache.filter().cache(typeFilter);
      query=new FilteredQuery(query,typeFilter);
    }
 else {
      BooleanFilter booleanFilter=new BooleanFilter();
      for (      String type : types) {
        DocumentMapper docMapper=mapperService.documentMapper(type);
        if (docMapper == null) {
          throw new TypeMissingException(shardId.index(),type);
        }
        Filter typeFilter=new TermFilter(docMapper.typeMapper().term(docMapper.type()));
        typeFilter=indexCache.filter().cache(typeFilter);
        booleanFilter.add(new FilterClause(typeFilter,BooleanClause.Occur.SHOULD));
      }
      query=new FilteredQuery(query,booleanFilter);
    }
  }
  return query;
}
