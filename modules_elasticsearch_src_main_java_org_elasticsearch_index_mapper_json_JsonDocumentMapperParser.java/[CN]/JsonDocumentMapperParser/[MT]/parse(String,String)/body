{
  JsonNode root;
  try {
    root=objectMapper.readValue(new FastStringReader(source),JsonNode.class);
  }
 catch (  IOException e) {
    throw new MapperParsingException("Failed to parse json mapping definition",e);
  }
  String rootName=root.getFieldNames().next();
  ObjectNode rootObj;
  if (type == null) {
    rootObj=(ObjectNode)root.get(rootName);
    type=rootName;
  }
 else {
    if (type.equals(rootName)) {
      JsonNode tmpNode=root.get(type);
      if (!tmpNode.isObject()) {
        throw new MapperParsingException("Expected root node name [" + rootName + "] to be of json object type, but its not");
      }
      rootObj=(ObjectNode)tmpNode;
    }
 else {
      rootObj=(ObjectNode)root;
    }
  }
  JsonTypeParser.ParserContext parserContext=new JsonTypeParser.ParserContext(rootObj,analysisService,typeParsers);
  JsonDocumentMapper.Builder docBuilder=doc((JsonObjectMapper.Builder)rootObjectTypeParser.parse(type,rootObj,parserContext));
  for (Iterator<Map.Entry<String,JsonNode>> fieldsIt=rootObj.getFields(); fieldsIt.hasNext(); ) {
    Map.Entry<String,JsonNode> entry=fieldsIt.next();
    String fieldName=Strings.toUnderscoreCase(entry.getKey());
    JsonNode fieldNode=entry.getValue();
    if (JsonSourceFieldMapper.JSON_TYPE.equals(fieldName) || "sourceField".equals(fieldName)) {
      docBuilder.sourceField(parseSourceField((ObjectNode)fieldNode,parserContext));
    }
 else     if (JsonIdFieldMapper.JSON_TYPE.equals(fieldName) || "idField".equals(fieldName)) {
      docBuilder.idField(parseIdField((ObjectNode)fieldNode,parserContext));
    }
 else     if (JsonTypeFieldMapper.JSON_TYPE.equals(fieldName) || "typeField".equals(fieldName)) {
      docBuilder.typeField(parseTypeField((ObjectNode)fieldNode,parserContext));
    }
 else     if (JsonUidFieldMapper.JSON_TYPE.equals(fieldName) || "uidField".equals(fieldName)) {
      docBuilder.uidField(parseUidField((ObjectNode)fieldNode,parserContext));
    }
 else     if (JsonBoostFieldMapper.JSON_TYPE.equals(fieldName) || "boostField".equals(fieldName)) {
      docBuilder.boostField(parseBoostField((ObjectNode)fieldNode,parserContext));
    }
 else     if (JsonAllFieldMapper.JSON_TYPE.equals(fieldName) || "allField".equals(fieldName)) {
      docBuilder.allField(parseAllField((ObjectNode)fieldNode,parserContext));
    }
 else     if ("index_analyzer".equals(fieldName)) {
      docBuilder.indexAnalyzer(analysisService.analyzer(fieldNode.getTextValue()));
    }
 else     if ("search_analyzer".equals(fieldName)) {
      docBuilder.searchAnalyzer(analysisService.analyzer(fieldNode.getTextValue()));
    }
 else     if ("analyzer".equals(fieldName)) {
      docBuilder.indexAnalyzer(analysisService.analyzer(fieldNode.getTextValue()));
      docBuilder.searchAnalyzer(analysisService.analyzer(fieldNode.getTextValue()));
    }
  }
  if (!docBuilder.hasIndexAnalyzer()) {
    docBuilder.indexAnalyzer(analysisService.defaultIndexAnalyzer());
  }
  if (!docBuilder.hasSearchAnalyzer()) {
    docBuilder.searchAnalyzer(analysisService.defaultSearchAnalyzer());
  }
  docBuilder.mappingSource(source);
  JsonDocumentMapper documentMapper=docBuilder.build();
  documentMapper.mappingSource(documentMapper.buildSource());
  return documentMapper;
}
