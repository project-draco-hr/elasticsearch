{
  final String[] concreteIndices=indexNameExpressionResolver.concreteIndices(state,request);
  clusterService.submitStateUpdateTask("delete_warmer [" + Arrays.toString(request.names()) + "]",new AckedClusterStateUpdateTask<DeleteWarmerResponse>(request,listener){
    @Override protected DeleteWarmerResponse newResponse(    boolean acknowledged){
      return new DeleteWarmerResponse(acknowledged);
    }
    @Override public void onFailure(    String source,    Throwable t){
      logger.debug("failed to delete warmer [{}] on indices [{}]",t,Arrays.toString(request.names()),concreteIndices);
      super.onFailure(source,t);
    }
    @Override public ClusterState execute(    ClusterState currentState){
      MetaData.Builder mdBuilder=MetaData.builder(currentState.metaData());
      boolean globalFoundAtLeastOne=false;
      boolean deleteAll=false;
      for (int i=0; i < request.names().length; i++) {
        if (request.names()[i].equals(MetaData.ALL)) {
          deleteAll=true;
          break;
        }
      }
      for (      String index : concreteIndices) {
        IndexMetaData indexMetaData=currentState.metaData().index(index);
        if (indexMetaData == null) {
          throw new IndexNotFoundException(index);
        }
        IndexWarmersMetaData warmers=indexMetaData.custom(IndexWarmersMetaData.TYPE);
        if (warmers != null) {
          List<IndexWarmersMetaData.Entry> entries=Lists.newArrayList();
          for (          IndexWarmersMetaData.Entry entry : warmers.entries()) {
            boolean keepWarmer=true;
            for (            String warmer : request.names()) {
              if (Regex.simpleMatch(warmer,entry.name()) || warmer.equals(MetaData.ALL)) {
                globalFoundAtLeastOne=true;
                keepWarmer=false;
                break;
              }
            }
            if (keepWarmer) {
              entries.add(entry);
            }
          }
          if (entries.size() != warmers.entries().size()) {
            warmers=new IndexWarmersMetaData(entries.toArray(new IndexWarmersMetaData.Entry[entries.size()]));
            IndexMetaData.Builder indexBuilder=IndexMetaData.builder(indexMetaData).putCustom(IndexWarmersMetaData.TYPE,warmers);
            mdBuilder.put(indexBuilder);
          }
        }
      }
      if (globalFoundAtLeastOne == false && deleteAll == false) {
        throw new IndexWarmerMissingException(request.names());
      }
      if (logger.isInfoEnabled()) {
        for (        String index : concreteIndices) {
          IndexMetaData indexMetaData=currentState.metaData().index(index);
          if (indexMetaData == null) {
            throw new IndexNotFoundException(index);
          }
          IndexWarmersMetaData warmers=indexMetaData.custom(IndexWarmersMetaData.TYPE);
          if (warmers != null) {
            for (            IndexWarmersMetaData.Entry entry : warmers.entries()) {
              for (              String warmer : request.names()) {
                if (Regex.simpleMatch(warmer,entry.name()) || warmer.equals(MetaData.ALL)) {
                  logger.info("[{}] delete warmer [{}]",index,entry.name());
                }
              }
            }
          }
 else           if (deleteAll) {
            logger.debug("no warmers to delete on index [{}]",index);
          }
        }
      }
      return ClusterState.builder(currentState).metaData(mdBuilder).build();
    }
  }
);
}
