{
  final CompletionFieldMapper.CompletionFieldType fieldType=suggestionContext.getFieldType();
  if (fieldType == null) {
    throw new ElasticsearchException("field [" + suggestionContext.getField() + "] is not a completion field");
  }
  CompletionSuggestion completionSuggestion=new CompletionSuggestion(name,suggestionContext.getSize());
  spare.copyUTF8Bytes(suggestionContext.getText());
  CompletionSuggestion.Entry completionSuggestEntry=new CompletionSuggestion.Entry(new StringText(spare.toString()),0,spare.length());
  completionSuggestion.addTerm(completionSuggestEntry);
  TopSuggestDocsCollector collector=new TopDocumentsCollector(suggestionContext.getSize());
  suggest(searcher,suggestionContext.toQuery(),collector);
  int numResult=0;
  for (  TopSuggestDocs.SuggestScoreDoc suggestScoreDoc : collector.get().scoreLookupDocs()) {
    TopDocumentsCollector.SuggestDoc suggestDoc=(TopDocumentsCollector.SuggestDoc)suggestScoreDoc;
    Map<String,Set<CharSequence>> contexts=Collections.emptyMap();
    if (fieldType.hasContextMappings() && !suggestDoc.getContexts().isEmpty()) {
      contexts=fieldType.getContextMappings().getNamedContexts(suggestDoc.getContexts());
    }
    Map<String,List<Object>> payload=Collections.emptyMap();
    Set<String> payloadFields=suggestionContext.getPayloadFields();
    if (!payloadFields.isEmpty()) {
      int readerIndex=ReaderUtil.subIndex(suggestDoc.doc,searcher.getIndexReader().leaves());
      LeafReaderContext subReaderContext=searcher.getIndexReader().leaves().get(readerIndex);
      int subDocId=suggestDoc.doc - subReaderContext.docBase;
      payload=new LinkedHashMap<>(payloadFields.size());
      for (      String field : payloadFields) {
        MappedFieldType payloadFieldType=suggestionContext.getMapperService().smartNameFieldType(field);
        if (payloadFieldType != null) {
          AtomicFieldData data=suggestionContext.getFieldData().getForField(payloadFieldType).load(subReaderContext);
          ScriptDocValues scriptValues=data.getScriptValues();
          scriptValues.setNextDocId(subDocId);
          payload.put(field,new ArrayList<>(scriptValues.getValues()));
        }
 else {
          throw new ElasticsearchException("payload field [" + field + "] does not exist");
        }
      }
    }
    if (numResult++ < suggestionContext.getSize()) {
      CompletionSuggestion.Entry.Option option=new CompletionSuggestion.Entry.Option(new StringText(suggestDoc.key.toString()),suggestDoc.score,contexts,payload);
      completionSuggestEntry.addOption(option);
    }
 else {
      break;
    }
  }
  return completionSuggestion;
}
