{
  StreamOutput out=null;
  boolean success=false;
  try {
    out=new OutputStreamStreamOutput(output);
    if (compress) {
      out=CompressorFactory.defaultCompressor().streamOutput(out);
    }
    success=true;
    return out;
  }
  finally {
    if (!success) {
      IOUtils.closeWhileHandlingException(out,output);
    }
  }
}
