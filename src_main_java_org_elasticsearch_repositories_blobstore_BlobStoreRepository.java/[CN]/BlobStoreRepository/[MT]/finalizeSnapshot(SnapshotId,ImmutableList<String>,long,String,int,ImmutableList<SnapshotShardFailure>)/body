{
  try {
    String tempBlobName=tempSnapshotBlobName(snapshotId);
    String blobName=snapshotBlobName(snapshotId);
    Snapshot blobStoreSnapshot=new Snapshot(snapshotId.getSnapshot(),indices,startTime,failure,System.currentTimeMillis(),totalShards,shardFailures);
    try (StreamOutput output=compressIfNeeded(snapshotsBlobContainer.createOutput(tempBlobName))){
      writeSnapshot(blobStoreSnapshot,output);
    }
     snapshotsBlobContainer.move(tempBlobName,blobName);
    ImmutableList<SnapshotId> snapshotIds=snapshots();
    if (!snapshotIds.contains(snapshotId)) {
      snapshotIds=ImmutableList.<SnapshotId>builder().addAll(snapshotIds).add(snapshotId).build();
    }
    writeSnapshotList(snapshotIds);
    return blobStoreSnapshot;
  }
 catch (  IOException ex) {
    throw new RepositoryException(this.repositoryName,"failed to update snapshot in repository",ex);
  }
}
