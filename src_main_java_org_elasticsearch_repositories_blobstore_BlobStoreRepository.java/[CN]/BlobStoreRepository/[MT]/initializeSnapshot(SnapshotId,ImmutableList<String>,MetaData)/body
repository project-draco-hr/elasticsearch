{
  try {
    BlobStoreSnapshot blobStoreSnapshot=BlobStoreSnapshot.builder().name(snapshotId.getSnapshot()).indices(indices).startTime(System.currentTimeMillis()).build();
    String snapshotBlobName=snapshotBlobName(snapshotId);
    if (snapshotsBlobContainer.blobExists(snapshotBlobName)) {
      throw new InvalidSnapshotNameException(snapshotId,"snapshot with such name already exists");
    }
    try (OutputStream output=snapshotsBlobContainer.createOutput(snapshotBlobName)){
      writeSnapshot(blobStoreSnapshot,output);
    }
     try (OutputStream output=snapshotsBlobContainer.createOutput(metaDataBlobName(snapshotId))){
      writeGlobalMetaData(metaData,output);
    }
     for (    String index : indices) {
      final IndexMetaData indexMetaData=metaData.index(index);
      final BlobPath indexPath=basePath().add("indices").add(index);
      final BlobContainer indexMetaDataBlobContainer=blobStore().blobContainer(indexPath);
      try (OutputStream output=indexMetaDataBlobContainer.createOutput(snapshotBlobName(snapshotId))){
        StreamOutput stream=new OutputStreamStreamOutput(output);
        if (isCompress()) {
          stream=CompressorFactory.defaultCompressor().streamOutput(stream);
        }
        XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON,stream);
        builder.startObject();
        IndexMetaData.Builder.toXContent(indexMetaData,builder,ToXContent.EMPTY_PARAMS);
        builder.endObject();
        builder.close();
      }
     }
  }
 catch (  IOException ex) {
    throw new SnapshotCreationException(snapshotId,ex);
  }
}
