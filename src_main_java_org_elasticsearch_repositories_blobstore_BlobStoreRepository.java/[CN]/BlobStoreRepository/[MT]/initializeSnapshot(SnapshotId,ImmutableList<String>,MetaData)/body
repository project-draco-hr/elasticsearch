{
  try {
    BlobStoreSnapshot blobStoreSnapshot=BlobStoreSnapshot.builder().name(snapshotId.getSnapshot()).indices(indices).startTime(System.currentTimeMillis()).build();
    BytesStreamOutput bStream=writeSnapshot(blobStoreSnapshot);
    String snapshotBlobName=snapshotBlobName(snapshotId);
    if (snapshotsBlobContainer.blobExists(snapshotBlobName)) {
      throw new InvalidSnapshotNameException(snapshotId,"snapshot with such name already exists");
    }
    BytesReference bRef=bStream.bytes();
    snapshotsBlobContainer.writeBlob(snapshotBlobName,bRef.streamInput(),bRef.length());
    bStream=writeGlobalMetaData(metaData);
    bRef=bStream.bytes();
    snapshotsBlobContainer.writeBlob(metaDataBlobName(snapshotId),bRef.streamInput(),bRef.length());
    for (    String index : indices) {
      IndexMetaData indexMetaData=metaData.index(index);
      BlobPath indexPath=basePath().add("indices").add(index);
      ImmutableBlobContainer indexMetaDataBlobContainer=blobStore().immutableBlobContainer(indexPath);
      bStream=new BytesStreamOutput();
      StreamOutput stream=bStream;
      if (isCompress()) {
        stream=CompressorFactory.defaultCompressor().streamOutput(stream);
      }
      XContentBuilder builder=XContentFactory.contentBuilder(XContentType.JSON,stream);
      builder.startObject();
      IndexMetaData.Builder.toXContent(indexMetaData,builder,ToXContent.EMPTY_PARAMS);
      builder.endObject();
      builder.close();
      bRef=bStream.bytes();
      indexMetaDataBlobContainer.writeBlob(snapshotBlobName(snapshotId),bRef.streamInput(),bRef.length());
    }
  }
 catch (  IOException ex) {
    throw new SnapshotCreationException(snapshotId,ex);
  }
}
