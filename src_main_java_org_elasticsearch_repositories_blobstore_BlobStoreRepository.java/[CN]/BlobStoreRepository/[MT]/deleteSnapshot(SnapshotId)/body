{
  Snapshot snapshot=readSnapshot(snapshotId);
  MetaData metaData=null;
  try {
    metaData=readSnapshotMetaData(snapshotId,snapshot.indices(),true);
  }
 catch (  SnapshotException ex) {
    logger.warn("cannot read metadata for snapshot [{}]",ex,snapshotId);
  }
  try {
    String blobName=snapshotBlobName(snapshotId);
    snapshotsBlobContainer.deleteBlob(blobName);
    snapshotsBlobContainer.deleteBlob(metaDataBlobName(snapshotId));
    ImmutableList<SnapshotId> snapshotIds=snapshots();
    if (snapshotIds.contains(snapshotId)) {
      ImmutableList.Builder<SnapshotId> builder=ImmutableList.builder();
      for (      SnapshotId id : snapshotIds) {
        if (!snapshotId.equals(id)) {
          builder.add(id);
        }
      }
      snapshotIds=builder.build();
    }
    writeSnapshotList(snapshotIds);
    for (    String index : snapshot.indices()) {
      BlobPath indexPath=basePath().add("indices").add(index);
      BlobContainer indexMetaDataBlobContainer=blobStore().blobContainer(indexPath);
      try {
        indexMetaDataBlobContainer.deleteBlob(blobName);
      }
 catch (      IOException ex) {
        logger.warn("[{}] failed to delete metadata for index [{}]",ex,snapshotId,index);
      }
      if (metaData != null) {
        IndexMetaData indexMetaData=metaData.index(index);
        if (indexMetaData != null) {
          for (int i=0; i < indexMetaData.getNumberOfShards(); i++) {
            ShardId shardId=new ShardId(index,i);
            try {
              indexShardRepository.delete(snapshotId,shardId);
            }
 catch (            IndexShardException|SnapshotException ex) {
              logger.warn("[{}] failed to delete shard data for shard [{}]",ex,snapshotId,shardId);
            }
          }
        }
      }
    }
  }
 catch (  IOException ex) {
    throw new RepositoryException(this.repositoryName,"failed to update snapshot in repository",ex);
  }
}
