{
  RestoreSource restoreSource=indexShard.routingEntry().restoreSource();
  if (restoreSource == null) {
    throw new IndexShardRestoreFailedException(shardId,"empty restore source");
  }
  if (logger.isTraceEnabled()) {
    logger.trace("[{}] restoring shard  [{}]",restoreSource.snapshotId(),shardId);
  }
  try {
    IndexShardRepository indexShardRepository=repositoriesService.indexShardRepository(restoreSource.snapshotId().getRepository());
    ShardId snapshotShardId=shardId;
    if (!shardId.getIndex().equals(restoreSource.index())) {
      snapshotShardId=new ShardId(restoreSource.index(),shardId.id());
    }
    indexShardRepository.restore(restoreSource.snapshotId(),shardId,snapshotShardId,recoveryStatus);
    restoreService.indexShardRestoreCompleted(restoreSource.snapshotId(),shardId);
  }
 catch (  Throwable t) {
    throw new IndexShardRestoreFailedException(shardId,"restore failed",t);
  }
}
