{
  assertAcked(prepareCreate("idx").addMapping("type",SINGLE_VALUED_FIELD_NAME,"type=geo_point",MULTI_VALUED_FIELD_NAME,"type=geo_point",NUMBER_FIELD_NAME,"type=long","tag","type=string,index=not_analyzed"));
  createIndex("idx_unmapped");
  unmappedTopLeft=new GeoPoint(Double.NEGATIVE_INFINITY,Double.POSITIVE_INFINITY);
  unmappedBottomRight=new GeoPoint(Double.POSITIVE_INFINITY,Double.NEGATIVE_INFINITY);
  singleTopLeft=new GeoPoint(Double.NEGATIVE_INFINITY,Double.POSITIVE_INFINITY);
  singleBottomRight=new GeoPoint(Double.POSITIVE_INFINITY,Double.NEGATIVE_INFINITY);
  multiTopLeft=new GeoPoint(Double.NEGATIVE_INFINITY,Double.POSITIVE_INFINITY);
  multiBottomRight=new GeoPoint(Double.POSITIVE_INFINITY,Double.NEGATIVE_INFINITY);
  numDocs=randomIntBetween(6,20);
  numUniqueGeoPoints=randomIntBetween(1,numDocs);
  singleValues=new GeoPoint[numUniqueGeoPoints];
  for (int i=0; i < singleValues.length; i++) {
    singleValues[i]=randomGeoPoint();
    updateBoundsTopLeft(singleValues[i],singleTopLeft);
    updateBoundsBottomRight(singleValues[i],singleBottomRight);
  }
  multiValues=new GeoPoint[numUniqueGeoPoints];
  for (int i=0; i < multiValues.length; i++) {
    multiValues[i]=randomGeoPoint();
    updateBoundsTopLeft(multiValues[i],multiTopLeft);
    updateBoundsBottomRight(multiValues[i],multiBottomRight);
  }
  List<IndexRequestBuilder> builders=new ArrayList<>();
  for (int i=0; i < numDocs; i++) {
    builders.add(client().prepareIndex("idx","type").setSource(jsonBuilder().startObject().array(SINGLE_VALUED_FIELD_NAME,singleValues[i % numUniqueGeoPoints].lon(),singleValues[i % numUniqueGeoPoints].lat()).startArray(MULTI_VALUED_FIELD_NAME).startArray().value(multiValues[i % numUniqueGeoPoints].lon()).value(multiValues[i % numUniqueGeoPoints].lat()).endArray().startArray().value(multiValues[(i + 1) % numUniqueGeoPoints].lon()).value(multiValues[(i + 1) % numUniqueGeoPoints].lat()).endArray().endArray().field(NUMBER_FIELD_NAME,i).field("tag","tag" + i).endObject()));
  }
  assertAcked(prepareCreate("empty_idx").addMapping("type",SINGLE_VALUED_FIELD_NAME,"type=geo_point"));
  assertAcked(prepareCreate("idx_dateline").addMapping("type",SINGLE_VALUED_FIELD_NAME,"type=geo_point",MULTI_VALUED_FIELD_NAME,"type=geo_point",NUMBER_FIELD_NAME,"type=long","tag","type=string,index=not_analyzed"));
  GeoPoint[] geoValues=new GeoPoint[5];
  geoValues[0]=new GeoPoint(38,178);
  geoValues[1]=new GeoPoint(12,-179);
  geoValues[2]=new GeoPoint(-24,170);
  geoValues[3]=new GeoPoint(32,-175);
  geoValues[4]=new GeoPoint(-11,178);
  for (int i=0; i < 5; i++) {
    builders.add(client().prepareIndex("idx_dateline","type").setSource(jsonBuilder().startObject().array(SINGLE_VALUED_FIELD_NAME,geoValues[i].lon(),geoValues[i].lat()).field(NUMBER_FIELD_NAME,i).field("tag","tag" + i).endObject()));
  }
  assertAcked(prepareCreate("high_card_idx").setSettings(Settings.builder().put("number_of_shards",2)).addMapping("type",SINGLE_VALUED_FIELD_NAME,"type=geo_point",MULTI_VALUED_FIELD_NAME,"type=geo_point",NUMBER_FIELD_NAME,"type=long","tag","type=string,index=not_analyzed"));
  for (int i=0; i < 2000; i++) {
    builders.add(client().prepareIndex("high_card_idx","type").setSource(jsonBuilder().startObject().array(SINGLE_VALUED_FIELD_NAME,singleValues[i % numUniqueGeoPoints].lon(),singleValues[i % numUniqueGeoPoints].lat()).startArray(MULTI_VALUED_FIELD_NAME).startArray().value(multiValues[i % numUniqueGeoPoints].lon()).value(multiValues[i % numUniqueGeoPoints].lat()).endArray().startArray().value(multiValues[(i + 1) % numUniqueGeoPoints].lon()).value(multiValues[(i + 1) % numUniqueGeoPoints].lat()).endArray().endArray().field(NUMBER_FIELD_NAME,i).field("tag","tag" + i).endObject()));
  }
  builders.add(client().prepareIndex("idx_zero","type").setSource(jsonBuilder().startObject().array(SINGLE_VALUED_FIELD_NAME,0.0,1.0).endObject()));
  assertAcked(prepareCreate("idx_zero").addMapping("type",SINGLE_VALUED_FIELD_NAME,"type=geo_point"));
  indexRandom(true,builders);
  ensureSearchable();
  SearchResponse response=client().prepareSearch("high_card_idx").addField(NUMBER_FIELD_NAME).addSort(SortBuilders.fieldSort(NUMBER_FIELD_NAME).order(SortOrder.ASC)).setSize(5000).get();
  assertSearchResponse(response);
  long totalHits=response.getHits().totalHits();
  XContentBuilder builder=XContentFactory.jsonBuilder().startObject();
  response.toXContent(builder,ToXContent.EMPTY_PARAMS);
  builder.endObject();
  logger.info("Full high_card_idx Response Content:\n{ {} }",builder.string());
  for (int i=0; i < totalHits; i++) {
    SearchHit searchHit=response.getHits().getAt(i);
    assertThat("Hit " + i + " with id: "+ searchHit.getId(),searchHit.getIndex(),equalTo("high_card_idx"));
    assertThat("Hit " + i + " with id: "+ searchHit.getId(),searchHit.getType(),equalTo("type"));
    SearchHitField hitField=searchHit.field(NUMBER_FIELD_NAME);
    assertThat("Hit " + i + " has wrong number of values",hitField.getValues().size(),equalTo(1));
    Integer value=hitField.getValue();
    assertThat("Hit " + i + " has wrong value",value,equalTo(i));
  }
  assertThat(totalHits,equalTo(2000l));
}
