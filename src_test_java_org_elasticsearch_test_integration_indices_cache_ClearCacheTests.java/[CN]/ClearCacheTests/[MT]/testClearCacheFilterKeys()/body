{
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client.prepareIndex("test","type","1").setSource("field","value").execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  NodesStatsResponse nodesStats=client.admin().cluster().prepareNodesStats().setIndices(true).execute().actionGet();
  assertThat(nodesStats.nodes()[0].indices().getCache().filterSizeInBytes(),equalTo(0l));
  SearchResponse searchResponse=client.prepareSearch().setQuery(filteredQuery(matchAllQuery(),FilterBuilders.termFilter("field","value").cacheKey("test_key"))).execute().actionGet();
  assertThat(searchResponse.hits().getHits().length,equalTo(1));
  nodesStats=client.admin().cluster().prepareNodesStats().setIndices(true).execute().actionGet();
  assertThat(nodesStats.nodes()[0].indices().getCache().filterSizeInBytes(),greaterThan(0l));
  client.admin().indices().prepareClearCache().setFilterKeys("test_key").execute().actionGet();
  nodesStats=client.admin().cluster().prepareNodesStats().setIndices(true).execute().actionGet();
  assertThat(nodesStats.nodes()[0].indices().getCache().filterSizeInBytes(),equalTo(0l));
}
