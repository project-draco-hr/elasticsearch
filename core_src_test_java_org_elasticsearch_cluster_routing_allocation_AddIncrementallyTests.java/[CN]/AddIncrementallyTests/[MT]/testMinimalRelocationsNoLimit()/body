{
  Settings.Builder settings=Settings.builder();
  settings.put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(),ClusterRebalanceAllocationDecider.ClusterRebalanceType.ALWAYS.toString()).put("cluster.routing.allocation.node_concurrent_recoveries",100).put("cluster.routing.allocation.node_initial_primaries_recoveries",100);
  AllocationService service=createAllocationService(settings.build());
  ClusterState clusterState=initCluster(service,1,3,3,1);
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(STARTED).size(),Matchers.equalTo(9));
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(9));
  int nodeOffset=1;
  clusterState=addNodes(clusterState,service,1,nodeOffset++);
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(STARTED).size(),Matchers.equalTo(9));
  assertThat(clusterState.getRoutingNodes().node("node1").shardsWithState(STARTED).size(),Matchers.equalTo(9));
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(0));
  assertNumIndexShardsPerNode(clusterState,Matchers.equalTo(3));
  logger.info("now, start one more node, check that rebalancing will happen because we set it to always");
  DiscoveryNodes.Builder nodes=DiscoveryNodes.builder(clusterState.nodes());
  nodes.add(newNode("node2"));
  clusterState=ClusterState.builder(clusterState).nodes(nodes.build()).build();
  RoutingAllocation.Result routingResult=service.reroute(clusterState,"reroute");
  clusterState=ClusterState.builder(clusterState).routingResult(routingResult).build();
  RoutingNodes routingNodes=clusterState.getRoutingNodes();
  assertThat(clusterState.getRoutingNodes().node("node2").shardsWithState(INITIALIZING).size(),Matchers.equalTo(2));
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  assertThat(clusterState.getRoutingNodes().node("node1").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  routingResult=service.applyStartedShards(clusterState,routingNodes.shardsWithState(INITIALIZING));
  clusterState=ClusterState.builder(clusterState).routingResult(routingResult).build();
  routingNodes=clusterState.getRoutingNodes();
  assertTrue(routingResult.changed());
  assertThat(clusterState.getRoutingNodes().node("node2").shardsWithState(STARTED).size(),Matchers.equalTo(2));
  assertThat(clusterState.getRoutingNodes().node("node2").shardsWithState(INITIALIZING).size(),Matchers.equalTo(2));
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  assertThat(clusterState.getRoutingNodes().node("node1").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  routingResult=service.applyStartedShards(clusterState,routingNodes.shardsWithState(INITIALIZING));
  clusterState=ClusterState.builder(clusterState).routingResult(routingResult).build();
  routingNodes=clusterState.getRoutingNodes();
  assertThat(clusterState.getRoutingNodes().node("node2").shardsWithState(STARTED).size(),Matchers.equalTo(4));
  assertThat(clusterState.getRoutingNodes().node("node2").shardsWithState(INITIALIZING).size(),Matchers.equalTo(2));
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  assertThat(clusterState.getRoutingNodes().node("node1").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  assertTrue(routingResult.changed());
  routingResult=service.applyStartedShards(clusterState,routingNodes.shardsWithState(INITIALIZING));
  clusterState=ClusterState.builder(clusterState).routingResult(routingResult).build();
  routingNodes=clusterState.getRoutingNodes();
  assertThat(clusterState.getRoutingNodes().node("node2").shardsWithState(STARTED).size(),Matchers.equalTo(6));
  assertThat(clusterState.getRoutingNodes().node("node2").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  assertThat(clusterState.getRoutingNodes().node("node1").shardsWithState(INITIALIZING).size(),Matchers.equalTo(0));
  assertTrue(routingResult.changed());
  routingResult=service.applyStartedShards(clusterState,routingNodes.shardsWithState(INITIALIZING));
  clusterState=ClusterState.builder(clusterState).routingResult(routingResult).build();
  assertFalse(routingResult.changed());
  assertNumIndexShardsPerNode(clusterState,Matchers.equalTo(2));
  logger.debug("ClusterState: {}",clusterState.getRoutingNodes().prettyPrint());
}
