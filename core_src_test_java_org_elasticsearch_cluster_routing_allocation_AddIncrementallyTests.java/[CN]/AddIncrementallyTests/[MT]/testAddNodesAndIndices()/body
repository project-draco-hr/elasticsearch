{
  Settings.Builder settings=settingsBuilder();
  settings.put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(),ClusterRebalanceAllocationDecider.ClusterRebalanceType.ALWAYS.toString());
  AllocationService service=createAllocationService(settings.build());
  ClusterState clusterState=initCluster(service,1,3,3,1);
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(STARTED).size(),Matchers.equalTo(9));
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(9));
  int nodeOffset=1;
  clusterState=addNodes(clusterState,service,1,nodeOffset++);
  assertThat(clusterState.getRoutingNodes().node("node0").shardsWithState(STARTED).size(),Matchers.equalTo(9));
  assertThat(clusterState.getRoutingNodes().node("node1").shardsWithState(STARTED).size(),Matchers.equalTo(9));
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(0));
  assertNumIndexShardsPerNode(clusterState,Matchers.equalTo(3));
  clusterState=addNodes(clusterState,service,1,nodeOffset++);
  assertNumIndexShardsPerNode(clusterState,Matchers.equalTo(2));
  clusterState=addNodes(clusterState,service,1,nodeOffset++);
  assertNumIndexShardsPerNode(clusterState,Matchers.lessThanOrEqualTo(2));
  assertAtLeastOneIndexShardPerNode(clusterState);
  clusterState=removeNodes(clusterState,service,1);
  assertNumIndexShardsPerNode(clusterState,Matchers.equalTo(2));
  clusterState=addIndex(clusterState,service,3,2,3);
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(2));
  assertNumIndexShardsPerNode(clusterState,"test3",Matchers.equalTo(2));
  assertNumIndexShardsPerNode(clusterState,Matchers.lessThanOrEqualTo(2));
  clusterState=addIndex(clusterState,service,4,2,3);
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(4));
  assertNumIndexShardsPerNode(clusterState,"test4",Matchers.equalTo(2));
  assertNumIndexShardsPerNode(clusterState,Matchers.lessThanOrEqualTo(2));
  clusterState=addNodes(clusterState,service,1,nodeOffset++);
  assertNumIndexShardsPerNode(clusterState,Matchers.lessThanOrEqualTo(2));
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(0));
  clusterState=removeNodes(clusterState,service,1);
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(4));
  assertNumIndexShardsPerNode(clusterState,Matchers.lessThanOrEqualTo(2));
  clusterState=addNodes(clusterState,service,1,nodeOffset++);
  assertNumIndexShardsPerNode(clusterState,Matchers.lessThanOrEqualTo(2));
  assertThat(clusterState.getRoutingNodes().unassigned().size(),Matchers.equalTo(0));
  logger.debug("ClusterState: {}",clusterState.getRoutingNodes().prettyPrint());
}
