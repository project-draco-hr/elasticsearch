{
  if (lastSettingsApplied != null && newSettings.equals(lastSettingsApplied)) {
    return newSettings;
  }
  final Settings build=Settings.builder().put(this.settings).put(newSettings).build();
  boolean success=false;
  try {
    for (    SettingUpdater settingUpdater : settingUpdaters) {
      try {
        settingUpdater.prepareApply(build);
      }
 catch (      Exception ex) {
        logger.warn("failed to prepareCommit settings for [{}]",ex,settingUpdater);
        throw ex;
      }
    }
    for (    SettingUpdater settingUpdater : settingUpdaters) {
      settingUpdater.apply();
    }
    success=true;
  }
 catch (  Exception ex) {
    logger.warn("failed to apply settings",ex);
    throw ex;
  }
 finally {
    if (success == false) {
      for (      SettingUpdater settingUpdater : settingUpdaters) {
        try {
          settingUpdater.rollback();
        }
 catch (        Exception e) {
          logger.error("failed to refresh settings for [{}]",e,settingUpdater);
        }
      }
    }
  }
  return lastSettingsApplied=newSettings;
}
