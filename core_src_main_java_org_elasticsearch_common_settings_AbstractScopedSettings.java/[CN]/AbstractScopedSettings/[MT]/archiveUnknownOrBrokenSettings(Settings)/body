{
  Settings.Builder builder=Settings.builder();
  boolean changed=false;
  for (  Map.Entry<String,String> entry : settings.getAsMap().entrySet()) {
    try {
      Setting<?> setting=get(entry.getKey());
      if (setting != null) {
        setting.get(settings);
        builder.put(entry.getKey(),entry.getValue());
      }
 else {
        if (entry.getKey().startsWith(ARCHIVED_SETTINGS_PREFIX) || isPrivateSetting(entry.getKey())) {
          builder.put(entry.getKey(),entry.getValue());
        }
 else {
          changed=true;
          logger.warn("found unknown setting: {} value: {} - archiving",entry.getKey(),entry.getValue());
          builder.put(ARCHIVED_SETTINGS_PREFIX + entry.getKey(),entry.getValue());
        }
      }
    }
 catch (    IllegalArgumentException ex) {
      changed=true;
      logger.warn("found invalid setting: {} value: {} - archiving",ex,entry.getKey(),entry.getValue());
      builder.put(ARCHIVED_SETTINGS_PREFIX + entry.getKey(),entry.getValue());
    }
  }
  if (changed) {
    return builder.build();
  }
 else {
    return settings;
  }
}
