{
  verifyNotClosed();
  if (getEngine().refreshNeeded()) {
    if (canIndex()) {
      long bytes=getEngine().getIndexBufferRAMBytesUsed();
      writingBytes.addAndGet(bytes);
      try {
        logger.debug("refresh with source [{}] indexBufferRAMBytesUsed [{}]",source,new ByteSizeValue(bytes));
        long time=System.nanoTime();
        getEngine().refresh(source);
        refreshMetric.inc(System.nanoTime() - time);
      }
  finally {
        logger.debug("remove [{}] writing bytes for shard [{}]",new ByteSizeValue(bytes),shardId());
        writingBytes.addAndGet(-bytes);
      }
    }
 else {
      logger.debug("refresh with source [{}]",source);
      long time=System.nanoTime();
      getEngine().refresh(source);
      refreshMetric.inc(System.nanoTime() - time);
    }
  }
}
