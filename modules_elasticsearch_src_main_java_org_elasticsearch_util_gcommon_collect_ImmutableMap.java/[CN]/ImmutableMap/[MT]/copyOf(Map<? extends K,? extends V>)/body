{
  if ((map instanceof ImmutableMap) && !(map instanceof ImmutableSortedMap)) {
    @SuppressWarnings("unchecked") ImmutableMap<K,V> kvMap=(ImmutableMap<K,V>)map;
    return kvMap;
  }
  @SuppressWarnings("unchecked") Entry<K,V>[] entries=map.entrySet().toArray(new Entry[0]);
switch (entries.length) {
case 0:
    return of();
case 1:
  return new SingletonImmutableMap<K,V>(entryOf(entries[0].getKey(),entries[0].getValue()));
default :
for (int i=0; i < entries.length; i++) {
  K k=entries[i].getKey();
  V v=entries[i].getValue();
  entries[i]=entryOf(k,v);
}
return new RegularImmutableMap<K,V>(entries);
}
}
