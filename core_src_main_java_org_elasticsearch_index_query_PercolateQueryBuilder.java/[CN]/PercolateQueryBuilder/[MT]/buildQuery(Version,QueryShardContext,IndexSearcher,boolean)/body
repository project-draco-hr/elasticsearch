{
  if (indexVersionCreated.onOrAfter(Version.V_5_0_0_alpha1)) {
    MappedFieldType fieldType=context.fieldMapper(field);
    if (fieldType == null) {
      throw new QueryShardException(context,"field [" + field + "] does not exist");
    }
    if (!(fieldType instanceof PercolatorFieldMapper.PercolatorFieldType)) {
      throw new QueryShardException(context,"expected field [" + field + "] to be of type [percolator], but is of type ["+ fieldType.typeName()+ "]");
    }
    PercolatorFieldMapper.PercolatorFieldType pft=(PercolatorFieldMapper.PercolatorFieldType)fieldType;
    PercolateQuery.Builder builder=new PercolateQuery.Builder(documentType,createStore(pft,context,mapUnmappedFieldsAsString),document,docSearcher);
    builder.extractQueryTermsQuery(pft.getExtractedTermsField(),pft.getUnknownQueryFieldName());
    return builder.build();
  }
 else {
    Query percolateTypeQuery=new TermQuery(new Term(TypeFieldMapper.NAME,PercolatorFieldMapper.LEGACY_TYPE_NAME));
    PercolateQuery.Builder builder=new PercolateQuery.Builder(documentType,createLegacyStore(context,mapUnmappedFieldsAsString),document,docSearcher);
    builder.setPercolateTypeQuery(percolateTypeQuery);
    return builder.build();
  }
}
