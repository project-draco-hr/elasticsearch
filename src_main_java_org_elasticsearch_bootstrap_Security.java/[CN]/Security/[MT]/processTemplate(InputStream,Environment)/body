{
  Path processed=Files.createTempFile(null,null);
  try (OutputStream output=new BufferedOutputStream(Files.newOutputStream(processed))){
    try (InputStream in=new BufferedInputStream(template)){
      ByteStreams.copy(in,output);
    }
     try (Writer writer=new OutputStreamWriter(output,StandardCharsets.UTF_8)){
      writer.write(System.lineSeparator());
      writer.write("grant {");
      writer.write(System.lineSeparator());
      addPath(writer,environment.homeFile(),"read,readlink,write,delete");
      addPath(writer,environment.configFile(),"read,readlink,write,delete");
      addPath(writer,environment.logsFile(),"read,readlink,write,delete");
      addPath(writer,environment.pluginsFile(),"read,readlink,write,delete");
      for (      Path path : environment.dataFiles()) {
        addPath(writer,path,"read,readlink,write,delete");
      }
      for (      Path path : environment.dataWithClusterFiles()) {
        addPath(writer,path,"read,readlink,write,delete");
      }
      writer.write("};");
      writer.write(System.lineSeparator());
    }
   }
   return processed;
}
