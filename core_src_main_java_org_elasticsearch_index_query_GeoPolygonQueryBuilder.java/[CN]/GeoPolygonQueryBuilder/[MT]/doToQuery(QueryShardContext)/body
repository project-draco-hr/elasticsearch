{
  List<GeoPoint> shell=new ArrayList<GeoPoint>();
  for (  GeoPoint geoPoint : this.shell) {
    shell.add(new GeoPoint(geoPoint));
  }
  final boolean indexCreatedBeforeV2_0=context.indexVersionCreated().before(Version.V_2_0_0);
  if (!indexCreatedBeforeV2_0 && !GeoValidationMethod.isIgnoreMalformed(validationMethod)) {
    for (    GeoPoint point : shell) {
      if (!GeoUtils.isValidLatitude(point.lat())) {
        throw new QueryShardException(context,"illegal latitude value [{}] for [{}]",point.lat(),GeoPolygonQueryBuilder.NAME);
      }
      if (!GeoUtils.isValidLongitude(point.lat())) {
        throw new QueryShardException(context,"illegal longitude value [{}] for [{}]",point.lon(),GeoPolygonQueryBuilder.NAME);
      }
    }
  }
  if (GeoValidationMethod.isCoerce(validationMethod)) {
    for (    GeoPoint point : shell) {
      GeoUtils.normalizePoint(point,true,true);
    }
  }
  MappedFieldType fieldType=context.fieldMapper(fieldName);
  if (fieldType == null) {
    throw new QueryShardException(context,"failed to find geo_point field [" + fieldName + "]");
  }
  if (!(fieldType instanceof GeoPointFieldMapper.GeoPointFieldType)) {
    throw new QueryShardException(context,"field [" + fieldName + "] is not a geo_point field");
  }
  IndexGeoPointFieldData indexFieldData=context.getForField(fieldType);
  return new GeoPolygonQuery(indexFieldData,shell.toArray(new GeoPoint[shell.size()]));
}
