{
  CachedStreamOutput.Entry cachedEntry=CachedStreamOutput.popEntry();
  try {
    HandlesStreamOutput stream=cachedEntry.cachedHandlesBytes();
    stream.writeLong(requestId);
    byte status=0;
    status=TransportStreams.statusSetRequest(status);
    stream.writeByte(status);
    stream.writeUTF(action);
    message.writeTo(stream);
    final LocalTransport targetTransport=connectedNodes.get(node);
    if (targetTransport == null) {
      throw new NodeNotConnectedException(node,"Node not connected");
    }
    final byte[] data=((BytesStreamOutput)stream.wrappedOut()).copiedByteArray();
    transportServiceAdapter.sent(data.length);
    threadPool.generic().execute(new Runnable(){
      @Override public void run(){
        targetTransport.messageReceived(data,action,LocalTransport.this,requestId);
      }
    }
);
  }
  finally {
    CachedStreamOutput.pushEntry(cachedEntry);
  }
}
