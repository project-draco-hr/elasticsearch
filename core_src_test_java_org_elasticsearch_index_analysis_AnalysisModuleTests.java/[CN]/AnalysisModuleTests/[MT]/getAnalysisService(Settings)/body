{
  Index index=new Index("test");
  Injector parentInjector=new ModulesBuilder().add(new SettingsModule(settings),new EnvironmentModule(new Environment(settings))).createInjector();
  AnalysisModule analysisModule=new AnalysisModule(settings,parentInjector.getInstance(IndicesAnalysisService.class));
  analysisModule.addTokenFilter("myfilter",MyFilterTokenFilterFactory.class);
  injector=new ModulesBuilder().add(new IndexNameAndSettingsModule(index,settings),analysisModule).createChildInjector(parentInjector);
  return injector.getInstance(AnalysisService.class);
}
