{
  logger.info("--> starting [node1] ...");
  startNode("node1");
  logger.info("--> creating test index ...");
  client("node1").admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1).put("index.number_of_replicas",0)).execute().actionGet();
  logger.info("--> index 10 docs");
  for (int i=0; i < 10; i++) {
    client("node1").prepareIndex("test","type",Integer.toString(i)).setSource("field","value" + i).execute().actionGet();
  }
  logger.info("--> flush so we have an actual index");
  client("node1").admin().indices().prepareFlush().execute().actionGet();
  logger.info("--> index more docs so we have something in the translog");
  for (int i=10; i < 20; i++) {
    client("node1").prepareIndex("test","type",Integer.toString(i)).setSource("field","value" + i).execute().actionGet();
  }
  logger.info("--> verifying count");
  client("node1").admin().indices().prepareRefresh().execute().actionGet();
  assertThat(client("node1").prepareCount("test").execute().actionGet().getCount(),equalTo(20l));
  logger.info("--> start another node");
  startNode("node2");
  ClusterHealthResponse clusterHealthResponse=client("node2").admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForNodes("2").execute().actionGet();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  logger.info("--> relocate the shard from node1 to node2");
  client("node1").admin().cluster().prepareReroute().add(new MoveAllocationCommand(new ShardId("test",0),"node1","node2")).execute().actionGet();
  clusterHealthResponse=client("node1").admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForRelocatingShards(0).setTimeout(ACCEPTABLE_RELOCATION_TIME).execute().actionGet();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  clusterHealthResponse=client("node2").admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForRelocatingShards(0).setTimeout(ACCEPTABLE_RELOCATION_TIME).execute().actionGet();
  assertThat(clusterHealthResponse.isTimedOut(),equalTo(false));
  logger.info("--> verifying count again...");
  client("node1").admin().indices().prepareRefresh().execute().actionGet();
  assertThat(client("node1").prepareCount("test").execute().actionGet().getCount(),equalTo(20l));
}
