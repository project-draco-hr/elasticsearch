{
  setFailure(shardIt,shardIndex,e);
  ShardRouting nextShard=shardIt.nextOrNull();
  if (nextShard != null) {
    if (e != null) {
      if (logger.isTraceEnabled()) {
        if (!TransportActions.isShardNotAvailableException(e)) {
          logger.trace("{}: failed to execute [{}]",e,shard != null ? shard.shortSummary() : shardIt.shardId(),request);
        }
      }
    }
    performOperation(shardIt,nextShard,shardIndex);
  }
 else {
    if (logger.isDebugEnabled()) {
      if (e != null) {
        if (!TransportActions.isShardNotAvailableException(e)) {
          logger.debug("{}: failed to execute [{}]",e,shard != null ? shard.shortSummary() : shardIt.shardId(),request);
        }
      }
    }
    if (expectedOps == counterOps.incrementAndGet()) {
      finishHim();
    }
  }
}
