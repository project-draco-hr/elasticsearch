{
  super.setUp();
  defaultSettings=ImmutableSettings.builder().put(InternalEngineHolder.INDEX_COMPOUND_ON_FLUSH,randomBoolean()).put(InternalEngineHolder.INDEX_GC_DELETES,"1h").put(InternalEngineHolder.INDEX_FAIL_ON_CORRUPTION,randomBoolean()).build();
  threadPool=new ThreadPool(getClass().getName());
  store=createStore();
  store.deleteContent();
  storeReplica=createStore();
  storeReplica.deleteContent();
  engineSettingsService=new IndexSettingsService(shardId.index(),ImmutableSettings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT).build());
  engine=createEngine(engineSettingsService,store,createTranslog());
  if (randomBoolean()) {
    engine.enableGcDeletes(false);
  }
  engine.start();
  if (randomBoolean()) {
    engine.stop();
    engine.start();
  }
  replicaSettingsService=new IndexSettingsService(shardId.index(),ImmutableSettings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT).build());
  replicaEngine=createEngine(replicaSettingsService,storeReplica,createTranslogReplica());
  if (randomBoolean()) {
    replicaEngine.enableGcDeletes(false);
  }
  replicaEngine.start();
  if (randomBoolean()) {
    engine.stop();
    engine.start();
  }
}
