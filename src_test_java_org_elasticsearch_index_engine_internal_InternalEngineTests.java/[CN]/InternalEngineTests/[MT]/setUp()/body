{
  super.setUp();
  defaultSettings=ImmutableSettings.builder().put(InternalEngine.INDEX_COMPOUND_ON_FLUSH,getRandom().nextBoolean()).put(InternalEngine.INDEX_CHECKSUM_ON_MERGE,getRandom().nextBoolean()).put(InternalEngine.INDEX_GC_DELETES,"1h").put(InternalEngine.INDEX_FAIL_ON_CORRUPTION,randomBoolean()).build();
  threadPool=new ThreadPool(getClass().getName());
  store=createStore();
  store.deleteContent();
  storeReplica=createStoreReplica();
  storeReplica.deleteContent();
  engineSettingsService=new IndexSettingsService(shardId.index(),ImmutableSettings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT).build());
  engine=createEngine(engineSettingsService,store,createTranslog());
  if (randomBoolean()) {
    engine.enableGcDeletes(false);
  }
  engine.start();
  replicaSettingsService=new IndexSettingsService(shardId.index(),ImmutableSettings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT).build());
  replicaEngine=createEngine(replicaSettingsService,storeReplica,createTranslogReplica());
  if (randomBoolean()) {
    replicaEngine.enableGcDeletes(false);
  }
  replicaEngine.start();
}
