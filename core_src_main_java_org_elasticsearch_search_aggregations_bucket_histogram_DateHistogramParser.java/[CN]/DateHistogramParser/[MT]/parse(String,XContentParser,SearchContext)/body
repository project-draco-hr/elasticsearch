{
  ValuesSourceParser vsParser=ValuesSourceParser.numeric(aggregationName,InternalDateHistogram.TYPE,context).targetValueType(ValueType.DATE).formattable(true).timezoneAware(true).build();
  boolean keyed=false;
  long minDocCount=0;
  ExtendedBounds extendedBounds=null;
  InternalOrder order=(InternalOrder)Histogram.Order.KEY_ASC;
  String interval=null;
  long offset=0;
  XContentParser.Token token;
  String currentFieldName=null;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if (vsParser.token(currentFieldName,token,parser)) {
      continue;
    }
 else     if (token == XContentParser.Token.VALUE_STRING) {
      if (context.parseFieldMatcher().match(currentFieldName,OFFSET)) {
        offset=parseOffset(parser.text());
      }
 else       if (context.parseFieldMatcher().match(currentFieldName,INTERVAL)) {
        interval=parser.text();
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else     if (token == XContentParser.Token.VALUE_BOOLEAN) {
      if ("keyed".equals(currentFieldName)) {
        keyed=parser.booleanValue();
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else     if (token == XContentParser.Token.VALUE_NUMBER) {
      if ("min_doc_count".equals(currentFieldName) || "minDocCount".equals(currentFieldName)) {
        minDocCount=parser.longValue();
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      if ("order".equals(currentFieldName)) {
        while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
          if (token == XContentParser.Token.FIELD_NAME) {
            currentFieldName=parser.currentName();
          }
 else           if (token == XContentParser.Token.VALUE_STRING) {
            String dir=parser.text();
            boolean asc="asc".equals(dir);
            order=resolveOrder(currentFieldName,asc);
          }
        }
      }
 else       if (context.parseFieldMatcher().match(currentFieldName,EXTENDED_BOUNDS)) {
        extendedBounds=new ExtendedBounds();
        while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
          if (token == XContentParser.Token.FIELD_NAME) {
            currentFieldName=parser.currentName();
          }
 else           if (token == XContentParser.Token.VALUE_STRING) {
            if ("min".equals(currentFieldName)) {
              extendedBounds.minAsStr=parser.text();
            }
 else             if ("max".equals(currentFieldName)) {
              extendedBounds.maxAsStr=parser.text();
            }
 else {
              throw new SearchParseException(context,"Unknown extended_bounds key for a " + token + " in aggregation ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
            }
          }
 else           if (token == XContentParser.Token.VALUE_NUMBER) {
            if ("min".equals(currentFieldName)) {
              extendedBounds.min=parser.longValue();
            }
 else             if ("max".equals(currentFieldName)) {
              extendedBounds.max=parser.longValue();
            }
 else {
              throw new SearchParseException(context,"Unknown extended_bounds key for a " + token + " in aggregation ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
            }
          }
 else {
            throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
          }
        }
      }
 else {
        throw new SearchParseException(context,"Unknown key for a " + token + " in ["+ aggregationName+ "]: ["+ currentFieldName+ "].",parser.getTokenLocation());
      }
    }
 else {
      throw new SearchParseException(context,"Unexpected token " + token + " in ["+ aggregationName+ "].",parser.getTokenLocation());
    }
  }
  if (interval == null) {
    throw new SearchParseException(context,"Missing required field [interval] for histogram aggregation [" + aggregationName + "]",parser.getTokenLocation());
  }
  TimeZoneRounding.Builder tzRoundingBuilder;
  DateTimeUnit dateTimeUnit=DATE_FIELD_UNITS.get(interval);
  if (dateTimeUnit != null) {
    tzRoundingBuilder=TimeZoneRounding.builder(dateTimeUnit);
  }
 else {
    tzRoundingBuilder=TimeZoneRounding.builder(TimeValue.parseTimeValue(interval,null,getClass().getSimpleName() + ".interval"));
  }
  Rounding rounding=tzRoundingBuilder.timeZone(vsParser.input().timezone()).offset(offset).build();
  ValuesSourceConfig config=vsParser.config();
  return new HistogramAggregator.Factory(aggregationName,config,rounding,order,keyed,minDocCount,extendedBounds,new InternalDateHistogram.Factory());
}
