{
  try {
    System.setProperty("name","sys-prop-name");
    Settings settings=settingsBuilder().put("node.name","node-name").put(baseEnvSettings).build();
    Environment env=InternalSettingsPreparer.prepareEnvironment(settings,null);
    assertThat(env.settings().get("name"),equalTo("sys-prop-name"));
    settings=settingsBuilder().put("name","name-in-settings").put("node.name","node-name").put(baseEnvSettings).build();
    env=InternalSettingsPreparer.prepareEnvironment(settings,null);
    assertThat(env.settings().get("name"),equalTo("name-in-settings"));
    System.clearProperty("name");
    settings=settingsBuilder().put("node.name","node-name").put(baseEnvSettings).build();
    env=InternalSettingsPreparer.prepareEnvironment(settings,null);
    assertThat(env.settings().get("name"),equalTo("node-name"));
    env=InternalSettingsPreparer.prepareEnvironment(baseEnvSettings,null);
    assertThat(env.settings().get("name"),not("name-in-settings"));
    assertThat(env.settings().get("name"),not("sys-prop-name"));
    assertThat(env.settings().get("name"),not("node-name"));
    assertThat(env.settings().get("name"),notNullValue());
  }
  finally {
    System.clearProperty("name");
  }
}
