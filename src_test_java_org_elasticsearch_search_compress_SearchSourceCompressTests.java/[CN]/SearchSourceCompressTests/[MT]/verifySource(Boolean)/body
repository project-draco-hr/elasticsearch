{
  try {
    client().admin().indices().prepareDelete("test").execute().actionGet();
  }
 catch (  Exception e) {
  }
  Settings settings=ImmutableSettings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,Version.V_1_4_2.id).build();
  createIndex("test",settings);
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  String mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("_source").field("compress",compress).endObject().endObject().endObject().string();
  client().admin().indices().preparePutMapping().setType("type1").setSource(mapping).execute().actionGet();
  for (int i=1; i < 100; i++) {
    client().prepareIndex("test","type1",Integer.toString(i)).setSource(buildSource(i)).execute().actionGet();
  }
  client().prepareIndex("test","type1",Integer.toString(10000)).setSource(buildSource(10000)).execute().actionGet();
  client().admin().indices().prepareRefresh().execute().actionGet();
  for (int i=1; i < 100; i++) {
    GetResponse getResponse=client().prepareGet("test","type1",Integer.toString(i)).execute().actionGet();
    assertThat(getResponse.getSourceAsBytes(),equalTo(buildSource(i).bytes().toBytes()));
  }
  GetResponse getResponse=client().prepareGet("test","type1",Integer.toString(10000)).execute().actionGet();
  assertThat(getResponse.getSourceAsBytes(),equalTo(buildSource(10000).bytes().toBytes()));
  for (int i=1; i < 100; i++) {
    SearchResponse searchResponse=client().prepareSearch().setQuery(QueryBuilders.idsQuery("type1").ids(Integer.toString(i))).execute().actionGet();
    assertThat(searchResponse.getHits().getTotalHits(),equalTo(1l));
    assertThat(searchResponse.getHits().getAt(0).source(),equalTo(buildSource(i).bytes().toBytes()));
  }
}
