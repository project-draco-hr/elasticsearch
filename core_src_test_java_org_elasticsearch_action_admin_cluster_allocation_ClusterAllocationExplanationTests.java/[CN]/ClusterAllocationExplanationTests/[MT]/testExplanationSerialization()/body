{
  ShardId shard=new ShardId("test","uuid",0);
  Map<DiscoveryNode,Decision> nodeToDecisions=new HashMap<>();
  Map<DiscoveryNode,Float> nodeToWeight=new HashMap<>();
  for (int i=randomIntBetween(2,5); i > 0; i--) {
    DiscoveryNode dn=new DiscoveryNode("node-" + i,DummyTransportAddress.INSTANCE,emptyMap(),emptySet(),Version.CURRENT);
    Decision.Multi d=new Decision.Multi();
    d.add(Decision.single(Decision.Type.NO,"no label","because I said no"));
    d.add(Decision.single(Decision.Type.YES,"yes label","yes please"));
    d.add(Decision.single(Decision.Type.THROTTLE,"throttle label","wait a sec"));
    nodeToDecisions.put(dn,d);
    nodeToWeight.put(dn,randomFloat());
  }
  long remainingDelay=randomIntBetween(0,500);
  DiscoveryNode nodeWithStore=new DiscoveryNode("node-1",DummyTransportAddress.INSTANCE,emptyMap(),emptySet(),Version.CURRENT);
  IndicesShardStoresResponse.StoreStatus storeStatus=new IndicesShardStoresResponse.StoreStatus(nodeWithStore,42,"eggplant",IndicesShardStoresResponse.StoreStatus.AllocationStatus.PRIMARY,new ElasticsearchException("stuff's broke, yo"));
  List<IndicesShardStoresResponse.StoreStatus> storeStatusList=Collections.singletonList(storeStatus);
  Set<String> allocationIds=new HashSet<>();
  allocationIds.add("eggplant");
  allocationIds.add("potato");
  ClusterAllocationExplanation cae=new ClusterAllocationExplanation(shard,true,"assignedNode",null,nodeToDecisions,nodeToWeight,remainingDelay,storeStatusList,allocationIds);
  BytesStreamOutput out=new BytesStreamOutput();
  cae.writeTo(out);
  StreamInput in=StreamInput.wrap(out.bytes());
  ClusterAllocationExplanation cae2=new ClusterAllocationExplanation(in);
  assertEquals(shard,cae2.getShard());
  assertTrue(cae2.isPrimary());
  assertTrue(cae2.isAssigned());
  assertEquals("assignedNode",cae2.getAssignedNodeId());
  assertNull(cae2.getUnassignedInfo());
  assertEquals(remainingDelay,cae2.getRemainingDelayNanos());
  assertEquals(allocationIds,cae2.getActiveAllocationIds());
  for (  Map.Entry<DiscoveryNode,ClusterAllocationExplanation.NodeExplanation> entry : cae2.getNodeExplanations().entrySet()) {
    DiscoveryNode node=entry.getKey();
    ClusterAllocationExplanation.NodeExplanation explanation=entry.getValue();
    IndicesShardStoresResponse.StoreStatus status=explanation.getStoreStatus();
    if (status != null) {
      assertEquals(nodeWithStore,node);
      assertEquals(storeStatus.getLegacyVersion(),status.getLegacyVersion());
      assertEquals(storeStatus.getAllocationId(),status.getAllocationId());
      assertEquals(storeStatus.getAllocationStatus(),status.getAllocationStatus());
      assertEquals(ExceptionsHelper.detailedMessage(storeStatus.getStoreException()),ExceptionsHelper.detailedMessage(status.getStoreException()));
    }
    assertEquals(nodeToDecisions.get(node),explanation.getDecision());
    assertEquals(nodeToWeight.get(node),explanation.getWeight());
  }
}
