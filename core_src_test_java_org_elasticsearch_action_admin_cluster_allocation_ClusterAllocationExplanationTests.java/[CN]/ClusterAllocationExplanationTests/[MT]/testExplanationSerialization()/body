{
  ShardId shard=new ShardId("test","uuid",0);
  Map<DiscoveryNode,Decision> nodeToDecisions=new HashMap<>();
  Map<DiscoveryNode,Float> nodeToWeight=new HashMap<>();
  for (int i=randomIntBetween(2,5); i > 0; i--) {
    DiscoveryNode dn=new DiscoveryNode("node-" + i,DummyTransportAddress.INSTANCE,emptyMap(),emptySet(),Version.CURRENT);
    Decision.Multi d=new Decision.Multi();
    d.add(Decision.single(Decision.Type.NO,"no label","because I said no"));
    d.add(Decision.single(Decision.Type.YES,"yes label","yes please"));
    d.add(Decision.single(Decision.Type.THROTTLE,"throttle label","wait a sec"));
    nodeToDecisions.put(dn,d);
    nodeToWeight.put(dn,randomFloat());
  }
  long remainingDelay=randomIntBetween(0,500);
  Map<DiscoveryNode,NodeExplanation> nodeExplanations=new HashMap<>(1);
  NodeExplanation ne=makeNodeExplanation("bar",true);
  nodeExplanations.put(ne.getNode(),ne);
  ClusterAllocationExplanation cae=new ClusterAllocationExplanation(shard,true,"assignedNode",remainingDelay,null,nodeExplanations);
  BytesStreamOutput out=new BytesStreamOutput();
  cae.writeTo(out);
  StreamInput in=StreamInput.wrap(out.bytes());
  ClusterAllocationExplanation cae2=new ClusterAllocationExplanation(in);
  assertEquals(shard,cae2.getShard());
  assertTrue(cae2.isPrimary());
  assertTrue(cae2.isAssigned());
  assertEquals("assignedNode",cae2.getAssignedNodeId());
  assertNull(cae2.getUnassignedInfo());
  assertEquals(remainingDelay,cae2.getRemainingDelayMillis());
  for (  Map.Entry<DiscoveryNode,NodeExplanation> entry : cae2.getNodeExplanations().entrySet()) {
    DiscoveryNode node=entry.getKey();
    NodeExplanation explanation=entry.getValue();
    IndicesShardStoresResponse.StoreStatus status=explanation.getStoreStatus();
    assertNotNull(explanation.getStoreStatus());
    assertNotNull(explanation.getDecision());
    assertNotNull(explanation.getWeight());
  }
}
