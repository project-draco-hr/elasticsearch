{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client.prepareIndex("test","type","1").setSource("field","value1","color","red").execute().actionGet();
  client.prepareIndex("test","type","2").setSource("field","value2","color","blue").execute().actionGet();
  client.prepareIndex("test","type","3").setSource("field","value3","color","red").execute().actionGet();
  client.prepareIndex("test","type","4").setSource("field","value4","color","blue").execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(matchAllQuery()).add(termFilter("field","value4"),"2").add(termFilter("field","value2"),"3")).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(3.0f));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("4"));
  assertThat(searchResponse.getHits().getAt(1).score(),equalTo(2.0f));
  assertThat(searchResponse.getHits().getAt(2).id(),anyOf(equalTo("1"),equalTo("3")));
  assertThat(searchResponse.getHits().getAt(2).score(),equalTo(1.0f));
  assertThat(searchResponse.getHits().getAt(3).id(),anyOf(equalTo("1"),equalTo("3")));
  assertThat(searchResponse.getHits().getAt(3).score(),equalTo(1.0f));
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(matchAllQuery()).add(termFilter("field","value4"),2).add(termFilter("field","value2"),3)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(3.0f));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("4"));
  assertThat(searchResponse.getHits().getAt(1).score(),equalTo(2.0f));
  assertThat(searchResponse.getHits().getAt(2).id(),anyOf(equalTo("1"),equalTo("3")));
  assertThat(searchResponse.getHits().getAt(2).score(),equalTo(1.0f));
  assertThat(searchResponse.getHits().getAt(3).id(),anyOf(equalTo("1"),equalTo("3")));
  assertThat(searchResponse.getHits().getAt(3).score(),equalTo(1.0f));
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(matchAllQuery()).scoreMode("total").add(termFilter("field","value4"),2).add(termFilter("field","value1"),3).add(termFilter("color","red"),5)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(8.0f));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(matchAllQuery()).scoreMode("max").add(termFilter("field","value4"),2).add(termFilter("field","value1"),3).add(termFilter("color","red"),5)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(5.0f));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(matchAllQuery()).scoreMode("avg").add(termFilter("field","value4"),2).add(termFilter("field","value1"),3).add(termFilter("color","red"),5)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("3"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(5.0f));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(1).score(),equalTo(4.0f));
  logger.info("--> Hit[1] {} Explanation {}",searchResponse.getHits().getAt(1).id(),searchResponse.getHits().getAt(1).explanation());
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(matchAllQuery()).scoreMode("min").add(termFilter("field","value4"),2).add(termFilter("field","value1"),3).add(termFilter("color","red"),5)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("3"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(5.0f));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(1).score(),equalTo(3.0f));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("4"));
  assertThat(searchResponse.getHits().getAt(2).score(),equalTo(2.0f));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(3).score(),equalTo(1.0f));
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(matchAllQuery()).scoreMode("multiply").add(termFilter("field","value4"),2).add(termFilter("field","value1"),3).add(termFilter("color","red"),5)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(15.0f));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("3"));
  assertThat(searchResponse.getHits().getAt(1).score(),equalTo(5.0f));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("4"));
  assertThat(searchResponse.getHits().getAt(2).score(),equalTo(2.0f));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(3).score(),equalTo(1.0f));
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(termsQuery("field","value1","value2","value3","value4")).scoreMode("first").add(termFilter("field","value4"),2).add(termFilter("field","value3"),3).add(termFilter("field","value2"),4)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(searchResponse.getHits().getAt(0).explanation().getValue()));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("3"));
  assertThat(searchResponse.getHits().getAt(1).score(),equalTo(searchResponse.getHits().getAt(1).explanation().getValue()));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("4"));
  assertThat(searchResponse.getHits().getAt(2).score(),equalTo(searchResponse.getHits().getAt(2).explanation().getValue()));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(3).score(),equalTo(searchResponse.getHits().getAt(3).explanation().getValue()));
  searchResponse=client.prepareSearch("test").setQuery(customFiltersScoreQuery(termsQuery("field","value1","value2","value3","value4")).scoreMode("multiply").add(termFilter("field","value4"),2).add(termFilter("field","value1"),3).add(termFilter("color","red"),5)).setExplain(true).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(4l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(0).score(),equalTo(searchResponse.getHits().getAt(0).explanation().getValue()));
  logger.info("--> Hit[0] {} Explanation {}",searchResponse.getHits().getAt(0).id(),searchResponse.getHits().getAt(0).explanation());
  assertThat(searchResponse.getHits().getAt(1).id(),equalTo("3"));
  assertThat(searchResponse.getHits().getAt(1).score(),equalTo(searchResponse.getHits().getAt(1).explanation().getValue()));
  assertThat(searchResponse.getHits().getAt(2).id(),equalTo("4"));
  assertThat(searchResponse.getHits().getAt(2).score(),equalTo(searchResponse.getHits().getAt(2).explanation().getValue()));
  assertThat(searchResponse.getHits().getAt(3).id(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(3).score(),equalTo(searchResponse.getHits().getAt(3).explanation().getValue()));
}
