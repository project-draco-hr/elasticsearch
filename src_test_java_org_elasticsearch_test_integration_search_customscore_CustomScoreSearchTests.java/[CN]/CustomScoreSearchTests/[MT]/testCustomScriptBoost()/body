{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client.index(indexRequest("test").setType("type1").setId("1").setSource(jsonBuilder().startObject().field("test","value beck").field("num1",1.0f).endObject())).actionGet();
  client.index(indexRequest("test").setType("type1").setId("2").setSource(jsonBuilder().startObject().field("test","value check").field("num1",2.0f).endObject())).actionGet();
  client.admin().indices().refresh(refreshRequest()).actionGet();
  logger.info("--- QUERY_THEN_FETCH");
  logger.info("running doc['num1'].value");
  SearchResponse response=client.search(searchRequest().setSearchType(SearchType.QUERY_THEN_FETCH).setSource(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("doc['num1'].value")))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running -doc['num1'].value");
  response=client.search(searchRequest().setSearchType(SearchType.QUERY_THEN_FETCH).setSource(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("-doc['num1'].value")))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("1"));
  assertThat(response.getHits().getAt(1).id(),equalTo("2"));
  logger.info("running pow(doc['num1'].value, 2)");
  response=client.search(searchRequest().setSearchType(SearchType.QUERY_THEN_FETCH).setSource(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("pow(doc['num1'].value, 2)")))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running max(doc['num1'].value, 1)");
  response=client.search(searchRequest().setSearchType(SearchType.QUERY_THEN_FETCH).setSource(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("max(doc['num1'].value, 1d)")))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running doc['num1'].value * _score");
  response=client.search(searchRequest().setSearchType(SearchType.QUERY_THEN_FETCH).setSource(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("doc['num1'].value * _score")))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("2"));
  assertThat(response.getHits().getAt(1).id(),equalTo("1"));
  logger.info("running param1 * param2 * _score");
  response=client.search(searchRequest().setSearchType(SearchType.QUERY_THEN_FETCH).setSource(searchSource().explain(true).query(customScoreQuery(termQuery("test","value")).script("param1 * param2 * _score").param("param1",2).param("param2",2)))).actionGet();
  assertThat(response.getHits().totalHits(),equalTo(2l));
  logger.info("Hit[0] {} Explanation {}",response.getHits().getAt(0).id(),response.getHits().getAt(0).explanation());
  logger.info("Hit[1] {} Explanation {}",response.getHits().getAt(1).id(),response.getHits().getAt(1).explanation());
  assertThat(response.getHits().getAt(0).id(),equalTo("1"));
  assertThat(response.getHits().getAt(1).id(),equalTo("2"));
}
