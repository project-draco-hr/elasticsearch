{
  joinThreadControl.stop();
  pingService.stop();
  masterFD.stop("zen disco stop");
  nodesFD.stop();
  initialStateSent.set(false);
  DiscoveryNodes nodes=nodes();
  if (sendLeaveRequest) {
    if (nodes.masterNode() == null) {
    }
 else     if (!nodes.localNodeMaster()) {
      try {
        membership.sendLeaveRequestBlocking(nodes.masterNode(),nodes.localNode(),TimeValue.timeValueSeconds(1));
      }
 catch (      Exception e) {
        logger.debug("failed to send leave request to master [{}]",e,nodes.masterNode());
      }
    }
 else {
      DiscoveryNode[] possibleMasters=electMaster.nextPossibleMasters(nodes.nodes().values(),5);
      for (      DiscoveryNode possibleMaster : possibleMasters) {
        if (nodes.localNode().equals(possibleMaster)) {
          continue;
        }
        try {
          membership.sendLeaveRequest(nodes.localNode(),possibleMaster);
        }
 catch (        Exception e) {
          logger.debug("failed to send leave request from master [{}] to possible master [{}]",e,nodes.masterNode(),possibleMaster);
        }
      }
    }
  }
}
