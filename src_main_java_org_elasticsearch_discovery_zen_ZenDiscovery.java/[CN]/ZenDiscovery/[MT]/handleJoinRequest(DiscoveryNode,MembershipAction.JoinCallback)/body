{
  if (!master) {
    throw new ElasticsearchIllegalStateException("Node [" + localNode + "] not master for join request from ["+ node+ "]");
  }
  if (!transportService.addressSupported(node.address().getClass())) {
    logger.warn("received a wrong address type from [{}], ignoring...",node);
  }
 else {
    transportService.connectToNode(node);
    membership.sendValidateJoinRequestBlocking(node,joinTimeout);
    processJoinRequests.add(new Tuple<>(node,callback));
    clusterService.submitStateUpdateTask("zen-disco-receive(join from node[" + node + "])",Priority.IMMEDIATE,new ProcessedClusterStateUpdateTask(){
      private final List<Tuple<DiscoveryNode,MembershipAction.JoinCallback>> drainedTasks=new ArrayList<>();
      @Override public ClusterState execute(      ClusterState currentState){
        processJoinRequests.drainTo(drainedTasks);
        if (drainedTasks.isEmpty()) {
          return currentState;
        }
        boolean modified=false;
        DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.builder(currentState.nodes());
        for (        Tuple<DiscoveryNode,MembershipAction.JoinCallback> task : drainedTasks) {
          DiscoveryNode node=task.v1();
          if (currentState.nodes().nodeExists(node.id())) {
            logger.debug("received a join request for an existing node [{}]",node);
          }
 else {
            modified=true;
            nodesBuilder.put(node);
            for (            DiscoveryNode existingNode : currentState.nodes()) {
              if (node.address().equals(existingNode.address())) {
                nodesBuilder.remove(existingNode.id());
                logger.warn("received join request from node [{}], but found existing node {} with same address, removing existing node",node,existingNode);
              }
            }
          }
        }
        ClusterState.Builder stateBuilder=ClusterState.builder(currentState);
        if (modified) {
          latestDiscoNodes=nodesBuilder.build();
          stateBuilder.nodes(latestDiscoNodes);
        }
        return stateBuilder.build();
      }
      @Override public void onFailure(      String source,      Throwable t){
        if (t instanceof ClusterService.NoLongerMasterException) {
          logger.debug("not processing [{}] as we are no longer master",source);
        }
 else {
          logger.error("unexpected failure during [{}]",t,source);
        }
        for (        Tuple<DiscoveryNode,MembershipAction.JoinCallback> drainedTask : drainedTasks) {
          drainedTask.v2().onFailure(t);
        }
      }
      @Override public void clusterStateProcessed(      String source,      ClusterState oldState,      ClusterState newState){
        for (        Tuple<DiscoveryNode,MembershipAction.JoinCallback> drainedTask : drainedTasks) {
          drainedTask.v2().onSuccess();
        }
      }
    }
);
  }
}
