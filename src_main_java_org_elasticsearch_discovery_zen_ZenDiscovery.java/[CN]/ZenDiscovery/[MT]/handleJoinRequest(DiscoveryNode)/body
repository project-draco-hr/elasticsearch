{
  if (!master) {
    throw new ElasticSearchIllegalStateException("Node [" + localNode + "] not master for join request from ["+ node+ "]");
  }
  ClusterState state=clusterService.state();
  if (!transportService.addressSupported(node.address().getClass())) {
    logger.warn("received a wrong address type from [{}], ignoring...",node);
  }
 else {
    transportService.connectToNode(node);
    state=clusterService.state();
    membership.sendValidateJoinRequestBlocking(node,state,pingTimeout);
    clusterService.submitStateUpdateTask("zen-disco-receive(join from node[" + node + "])",Priority.URGENT,new ClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState){
        if (currentState.nodes().nodeExists(node.id())) {
          logger.warn("received a join request for an existing node [{}]",node);
          return ClusterState.builder().state(currentState).build();
        }
        return newClusterStateBuilder().state(currentState).nodes(currentState.nodes().newNode(node)).build();
      }
      @Override public void onFailure(      String source,      Throwable t){
        logger.error("unexpected failure during [{}]",t,source);
      }
    }
);
  }
  return state;
}
