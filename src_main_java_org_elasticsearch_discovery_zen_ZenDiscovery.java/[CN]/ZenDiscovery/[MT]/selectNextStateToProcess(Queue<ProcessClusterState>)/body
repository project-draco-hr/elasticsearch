{
  ProcessClusterState stateToProcess=processNewClusterStates.poll();
  if (stateToProcess == null) {
    return null;
  }
  stateToProcess.processed=true;
  while (true) {
    ProcessClusterState potentialState=processNewClusterStates.peek();
    if (potentialState == null) {
      break;
    }
    if (!Objects.equal(stateToProcess.clusterState.nodes().masterNodeId(),potentialState.clusterState.nodes().masterNodeId())) {
      break;
    }
    potentialState=processNewClusterStates.poll();
    if (potentialState == null) {
      break;
    }
    potentialState.processed=true;
    if (potentialState.clusterState.version() > stateToProcess.clusterState.version()) {
      stateToProcess=potentialState;
    }
  }
  return stateToProcess.clusterState;
}
