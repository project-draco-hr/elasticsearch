{
  if (lifecycleState() != Lifecycle.State.STARTED) {
    return;
  }
  if (master) {
    clusterService.submitStateUpdateTask("zen-disco-node_left(" + node + ")",Priority.IMMEDIATE,new ClusterStateUpdateTask(){
      @Override public ClusterState execute(      ClusterState currentState){
        DiscoveryNodes.Builder builder=DiscoveryNodes.builder(currentState.nodes()).remove(node.id());
        latestDiscoNodes=builder.build();
        currentState=ClusterState.builder(currentState).nodes(latestDiscoNodes).build();
        if (!electMaster.hasEnoughMasterNodes(currentState.nodes())) {
          return rejoin(currentState,"not enough master nodes");
        }
        RoutingAllocation.Result routingResult=allocationService.reroute(ClusterState.builder(currentState).build());
        return ClusterState.builder(currentState).routingResult(routingResult).build();
      }
      @Override public void onFailure(      String source,      Throwable t){
        if (t instanceof ClusterService.NoLongerMasterException) {
          logger.debug("not processing {} leave request as we are no longer master",node);
        }
 else {
          logger.error("unexpected failure during [{}]",t,source);
        }
      }
    }
);
  }
 else {
    handleMasterGone(node,"shut_down");
  }
}
