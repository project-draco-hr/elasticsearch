{
  routing(metaData.resolveIndexRouting(routing,aliasOrIndex));
  if (timestamp != null) {
    timestamp=MappingMetaData.Timestamp.parseStringTimestamp(timestamp,mappingMd != null ? mappingMd.timestamp().dateTimeFormatter() : TimestampFieldMapper.Defaults.DATE_TIME_FORMATTER);
  }
  if (mappingMd != null) {
    MappingMetaData.ParseContext parseContext=mappingMd.createParseContext(id,routing,timestamp);
    if (parseContext.shouldParse()) {
      XContentParser parser=null;
      try {
        parser=XContentHelper.createParser(source);
        mappingMd.parse(parser,parseContext);
        if (parseContext.shouldParseId()) {
          id=parseContext.id();
        }
        if (parseContext.shouldParseRouting()) {
          if (routing != null && !routing.equals(parseContext.routing())) {
            throw new MapperParsingException("The provided routing value [" + routing + "] doesn't match the routing key stored in the document: ["+ parseContext.routing()+ "]");
          }
          routing=parseContext.routing();
        }
        if (parseContext.shouldParseTimestamp()) {
          timestamp=parseContext.timestamp();
          if (timestamp != null) {
            timestamp=MappingMetaData.Timestamp.parseStringTimestamp(timestamp,mappingMd.timestamp().dateTimeFormatter());
          }
        }
      }
 catch (      MapperParsingException e) {
        throw e;
      }
catch (      Exception e) {
        throw new ElasticsearchParseException("failed to parse doc to extract routing/timestamp/id",e);
      }
 finally {
        if (parser != null) {
          parser.close();
        }
      }
    }
    if (mappingMd.routing().required() && routing == null) {
      throw new RoutingMissingException(index,type,id);
    }
    if (parent != null && !mappingMd.hasParentField()) {
      throw new ElasticsearchIllegalArgumentException("Can't specify parent if no parent field has been configured");
    }
  }
 else {
    if (parent != null) {
      throw new ElasticsearchIllegalArgumentException("Can't specify parent if no parent field has been configured");
    }
  }
  if (allowIdGeneration) {
    if (id == null) {
      id(Strings.randomBase64UUID());
      opType(IndexRequest.OpType.CREATE);
      autoGeneratedId=true;
    }
  }
  if (timestamp == null) {
    String defaultTimestamp=TimestampFieldMapper.Defaults.DEFAULT_TIMESTAMP;
    if (mappingMd != null && mappingMd.timestamp() != null) {
      defaultTimestamp=mappingMd.timestamp().defaultTimestamp();
    }
    if (!Strings.hasText(defaultTimestamp)) {
      throw new TimestampParsingException("timestamp is required by mapping");
    }
    if (defaultTimestamp.equals(TimestampFieldMapper.Defaults.DEFAULT_TIMESTAMP)) {
      timestamp=Long.toString(System.currentTimeMillis());
    }
 else {
      timestamp=MappingMetaData.Timestamp.parseStringTimestamp(defaultTimestamp,mappingMd.timestamp().dateTimeFormatter());
    }
  }
}
