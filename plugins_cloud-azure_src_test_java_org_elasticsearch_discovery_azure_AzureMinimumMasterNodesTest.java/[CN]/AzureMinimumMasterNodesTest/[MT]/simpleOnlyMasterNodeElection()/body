{
  logger.info("--> start data node / non master node");
  internalCluster().startNode(settingsBuilder());
  try {
    assertThat(client().admin().cluster().prepareState().setMasterNodeTimeout("100ms").execute().actionGet().getState().nodes().masterNodeId(),nullValue());
    fail("should not be able to find master");
  }
 catch (  MasterNotDiscoveredException e) {
  }
  logger.info("--> start another node");
  internalCluster().startNode(settingsBuilder());
  assertThat(client().admin().cluster().prepareState().setMasterNodeTimeout("1s").execute().actionGet().getState().nodes().masterNodeId(),notNullValue());
  logger.info("--> stop master node");
  internalCluster().stopCurrentMasterNode();
  try {
    assertThat(client().admin().cluster().prepareState().setMasterNodeTimeout("1s").execute().actionGet().getState().nodes().masterNodeId(),nullValue());
    fail("should not be able to find master");
  }
 catch (  MasterNotDiscoveredException e) {
  }
  logger.info("--> start another node");
  internalCluster().startNode(settingsBuilder());
  assertThat(client().admin().cluster().prepareState().setMasterNodeTimeout("1s").execute().actionGet().getState().nodes().masterNodeId(),notNullValue());
}
