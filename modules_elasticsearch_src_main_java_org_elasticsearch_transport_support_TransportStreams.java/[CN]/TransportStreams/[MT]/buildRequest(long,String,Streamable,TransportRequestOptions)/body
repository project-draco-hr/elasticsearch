{
  byte status=0;
  status=TransportStreams.statusSetRequest(status);
  BytesStreamOutput wrapped;
  if (options.compress()) {
    status=TransportStreams.statusSetCompress(status);
    HandlesStreamOutput stream=CachedStreamOutput.cachedHandlesLzfBytes();
    stream.writeUTF(action);
    message.writeTo(stream);
    stream.flush();
    wrapped=((BytesStreamOutput)((LZFStreamOutput)stream.wrappedOut()).wrappedOut());
    stream.cleanHandles();
  }
 else {
    HandlesStreamOutput stream=CachedStreamOutput.cachedHandlesBytes();
    stream.writeUTF(action);
    message.writeTo(stream);
    stream.flush();
    wrapped=((BytesStreamOutput)stream.wrappedOut());
    stream.cleanHandles();
  }
  byte[] data=new byte[HEADER_SIZE + wrapped.size()];
  TransportStreams.writeHeader(data,wrapped.size(),requestId,status);
  System.arraycopy(wrapped.unsafeByteArray(),0,data,HEADER_SIZE,wrapped.size());
  return data;
}
