{
  client().admin().indices().prepareCreate(INDEX_NAME).addMapping(TYPE_NAME,"query","type=percolator").get();
  ensureGreen();
  logger.info("--> Adding docs");
  client().prepareIndex(INDEX_NAME,"type","1").setSource("field1","b").execute().actionGet();
  client().prepareIndex(INDEX_NAME,"type","2").setSource("field1","c").execute().actionGet();
  client().prepareIndex(INDEX_NAME,"type","3").setSource("field1","b c").execute().actionGet();
  client().prepareIndex(INDEX_NAME,"type","4").setSource("field1","d").execute().actionGet();
  logger.info("--> register a queries");
  client().prepareIndex(INDEX_NAME,TYPE_NAME,"1").setSource(jsonBuilder().startObject().field("query",matchQuery("field1","b")).field("a","b").endObject()).execute().actionGet();
  client().prepareIndex(INDEX_NAME,TYPE_NAME,"2").setSource(jsonBuilder().startObject().field("query",matchQuery("field1","c")).endObject()).execute().actionGet();
  client().prepareIndex(INDEX_NAME,TYPE_NAME,"3").setSource(jsonBuilder().startObject().field("query",boolQuery().must(matchQuery("field1","b")).must(matchQuery("field1","c"))).endObject()).execute().actionGet();
  client().prepareIndex(INDEX_NAME,TYPE_NAME,"4").setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).execute().actionGet();
  refresh();
  logger.info("--> Count percolate existing doc with id 1");
  PercolateResponse response=preparePercolate(client()).setIndices(INDEX_NAME).setDocumentType("type").setOnlyCount(true).setGetRequest(Requests.getRequest(INDEX_NAME).type("type").id("1")).execute().actionGet();
  assertMatchCount(response,2L);
  assertThat(response.getMatches(),nullValue());
  logger.info("--> Count percolate existing doc with id 2");
  response=preparePercolate(client()).setIndices(INDEX_NAME).setDocumentType("type").setOnlyCount(true).setGetRequest(Requests.getRequest(INDEX_NAME).type("type").id("2")).execute().actionGet();
  assertMatchCount(response,2L);
  assertThat(response.getMatches(),nullValue());
  logger.info("--> Count percolate existing doc with id 3");
  response=preparePercolate(client()).setIndices(INDEX_NAME).setDocumentType("type").setOnlyCount(true).setGetRequest(Requests.getRequest(INDEX_NAME).type("type").id("3")).execute().actionGet();
  assertMatchCount(response,4L);
  assertThat(response.getMatches(),nullValue());
  logger.info("--> Count percolate existing doc with id 4");
  response=preparePercolate(client()).setIndices(INDEX_NAME).setDocumentType("type").setOnlyCount(true).setGetRequest(Requests.getRequest(INDEX_NAME).type("type").id("4")).execute().actionGet();
  assertMatchCount(response,1L);
  assertThat(response.getMatches(),nullValue());
}
