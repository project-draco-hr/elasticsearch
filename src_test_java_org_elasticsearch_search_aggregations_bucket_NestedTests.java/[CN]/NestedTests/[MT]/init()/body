{
  prepareCreate("idx").addMapping("type","nested","type=nested").setSettings(indexSettings()).execute().actionGet();
  List<IndexRequestBuilder> builders=new ArrayList<IndexRequestBuilder>();
  numParents=randomIntBetween(3,10);
  numChildren=new int[numParents];
  for (int i=0; i < numParents; ++i) {
    numChildren[i]=randomInt(5);
  }
  for (int i=0; i < numParents; i++) {
    XContentBuilder source=jsonBuilder().startObject().field("value",i + 1).startArray("nested");
    for (int j=0; j < numChildren[i]; ++j) {
      source=source.startObject().field("value",i + 1 + j).endObject();
    }
    source=source.endArray().endObject();
    builders.add(client().prepareIndex("idx","type","" + i + 1).setSource(source));
  }
  indexRandom(true,builders);
}
