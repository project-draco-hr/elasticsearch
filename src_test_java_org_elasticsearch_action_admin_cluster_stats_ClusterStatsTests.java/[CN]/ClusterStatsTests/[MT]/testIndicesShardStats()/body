{
  cluster().startNode();
  prepareCreate("test1").setSettings("number_of_shards",2,"number_of_replicas",1).get();
  ensureYellow();
  ClusterStatsResponse response=client().admin().cluster().prepareClusterStats().get();
  assertThat(response.indicesStats.getDocs().getCount(),Matchers.equalTo(0l));
  assertThat(response.indicesStats.getIndexCount(),Matchers.equalTo(1));
  assertShardStats(response.getIndicesStats().getShards(),1,2,2,0.0);
  cluster().startNode();
  ensureGreen();
  index("test1","type","1","f","f");
  refresh();
  response=client().admin().cluster().prepareClusterStats().get();
  assertThat(response.indicesStats.getDocs().getCount(),Matchers.equalTo(1l));
  assertShardStats(response.getIndicesStats().getShards(),1,4,2,1.0);
  prepareCreate("test2").setSettings("number_of_shards",3,"number_of_replicas",0).get();
  ensureGreen();
  response=client().admin().cluster().prepareClusterStats().get();
  assertThat(response.indicesStats.getIndexCount(),Matchers.equalTo(2));
  assertShardStats(response.getIndicesStats().getShards(),2,7,5,2.0 / 5);
  assertThat(response.getIndicesStats().getShards().getAvgIndexPrimaryShards(),Matchers.equalTo(2.5));
  assertThat(response.getIndicesStats().getShards().getMinIndexPrimaryShards(),Matchers.equalTo(2));
  assertThat(response.getIndicesStats().getShards().getMaxIndexPrimaryShards(),Matchers.equalTo(3));
  assertThat(response.getIndicesStats().getShards().getAvgIndexShards(),Matchers.equalTo(3.5));
  assertThat(response.getIndicesStats().getShards().getMinIndexShards(),Matchers.equalTo(3));
  assertThat(response.getIndicesStats().getShards().getMaxIndexShards(),Matchers.equalTo(4));
  assertThat(response.getIndicesStats().getShards().getAvgIndexReplication(),Matchers.equalTo(0.5));
  assertThat(response.getIndicesStats().getShards().getMinIndexReplication(),Matchers.equalTo(0.0));
  assertThat(response.getIndicesStats().getShards().getMaxIndexReplication(),Matchers.equalTo(1.0));
}
