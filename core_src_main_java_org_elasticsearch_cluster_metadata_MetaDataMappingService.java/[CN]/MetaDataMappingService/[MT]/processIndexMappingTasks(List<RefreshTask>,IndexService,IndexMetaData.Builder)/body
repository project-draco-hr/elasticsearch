{
  boolean dirty=false;
  String index=indexService.index().name();
  Set<String> processedRefreshes=new HashSet<>();
  for (  RefreshTask refreshTask : tasks) {
    try {
      List<String> updatedTypes=new ArrayList<>();
      for (      String type : refreshTask.types) {
        if (processedRefreshes.contains(type)) {
          continue;
        }
        DocumentMapper mapper=indexService.mapperService().documentMapper(type);
        if (mapper == null) {
          continue;
        }
        if (!mapper.mappingSource().equals(builder.mapping(type).source())) {
          updatedTypes.add(type);
          builder.putMapping(new MappingMetaData(mapper));
        }
        processedRefreshes.add(type);
      }
      if (updatedTypes.isEmpty()) {
        continue;
      }
      logger.warn("[{}] re-syncing mappings with cluster state for types [{}]",index,updatedTypes);
      dirty=true;
    }
 catch (    Throwable t) {
      logger.warn("[{}] failed to refresh-mapping in cluster state, types [{}]",index,refreshTask.types);
    }
  }
  return dirty;
}
