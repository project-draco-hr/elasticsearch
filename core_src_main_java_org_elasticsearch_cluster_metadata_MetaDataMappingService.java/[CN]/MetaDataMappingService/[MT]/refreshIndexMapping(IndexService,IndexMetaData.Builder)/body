{
  boolean dirty=false;
  String index=indexService.index().getName();
  try {
    List<String> updatedTypes=new ArrayList<>();
    for (    DocumentMapper mapper : indexService.mapperService().docMappers(true)) {
      final String type=mapper.type();
      if (!mapper.mappingSource().equals(builder.mapping(type).source())) {
        updatedTypes.add(type);
      }
    }
    if (updatedTypes.isEmpty() == false) {
      logger.warn("[{}] re-syncing mappings with cluster state because of types [{}]",index,updatedTypes);
      dirty=true;
      for (      DocumentMapper mapper : indexService.mapperService().docMappers(true)) {
        builder.putMapping(new MappingMetaData(mapper));
      }
    }
  }
 catch (  Exception e) {
    logger.warn(new ParameterizedMessage("[{}] failed to refresh-mapping in cluster state",index),e);
  }
  return dirty;
}
