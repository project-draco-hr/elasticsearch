{
  try (ReleasableLock lock=writeLock.acquire()){
    ensureOpen();
    onGoingRecoveries.startRecovery();
  }
   SnapshotIndexCommit phase1Snapshot;
  try {
    phase1Snapshot=deletionPolicy.snapshot();
  }
 catch (  Throwable e) {
    maybeFailEngine("recovery",e);
    Releasables.closeWhileHandlingException(onGoingRecoveries);
    throw new RecoveryEngineException(shardId,1,"Snapshot failed",e);
  }
  try {
    recoveryHandler.phase1(phase1Snapshot);
  }
 catch (  Throwable e) {
    maybeFailEngine("recovery phase 1",e);
    Releasables.closeWhileHandlingException(phase1Snapshot,onGoingRecoveries);
    throw new RecoveryEngineException(shardId,1,"Execution failed",wrapIfClosed(e));
  }
  Translog.Snapshot phase2Snapshot;
  try {
    phase2Snapshot=translog.snapshot();
  }
 catch (  Throwable e) {
    maybeFailEngine("snapshot recovery",e);
    Releasables.closeWhileHandlingException(phase1Snapshot,onGoingRecoveries);
    throw new RecoveryEngineException(shardId,2,"Snapshot failed",wrapIfClosed(e));
  }
  try {
    recoveryHandler.phase2(phase2Snapshot);
  }
 catch (  Throwable e) {
    maybeFailEngine("recovery phase 2",e);
    Releasables.closeWhileHandlingException(phase1Snapshot,phase2Snapshot,onGoingRecoveries);
    throw new RecoveryEngineException(shardId,2,"Execution failed",wrapIfClosed(e));
  }
  writeLock.acquire();
  Translog.Snapshot phase3Snapshot=null;
  boolean success=false;
  try {
    ensureOpen();
    phase3Snapshot=translog.snapshot(phase2Snapshot);
    recoveryHandler.phase3(phase3Snapshot);
    success=true;
  }
 catch (  Throwable e) {
    maybeFailEngine("recovery phase 3",e);
    throw new RecoveryEngineException(shardId,3,"Execution failed",wrapIfClosed(e));
  }
 finally {
    Releasables.close(success,phase1Snapshot,phase2Snapshot,phase3Snapshot,onGoingRecoveries,writeLock);
  }
}
