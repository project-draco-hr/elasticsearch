{
  final NodesInfoResponse nodeInfos=client().admin().cluster().prepareNodesInfo().get();
  final List<NodeInfo> nodes=nodeInfos.getNodes();
  assertFalse(nodeInfos.hasFailures());
  List<HttpHost> hosts=new ArrayList<>();
  for (  NodeInfo node : nodes) {
    if (node.getHttp() != null) {
      TransportAddress publishAddress=node.getHttp().address().publishAddress();
      assertEquals(1,publishAddress.uniqueAddressTypeId());
      InetSocketAddress address=((InetSocketTransportAddress)publishAddress).address();
      hosts.add(new HttpHost(NetworkAddress.format(address.getAddress()),address.getPort(),protocol));
    }
  }
  RestClient.Builder builder=RestClient.builder().setHosts(hosts.toArray(new HttpHost[hosts.size()]));
  if (httpClient != null) {
    builder.setHttpClient(httpClient);
  }
  return builder.build();
}
