{
  cluster().ensureAtLeastNumNodes(2);
  cluster().ensureAtMostNumNodes(2);
  assertAcked(client().admin().indices().prepareCreate("test").setSettings(settingsBuilder().put(IndexMetaData.SETTING_NUMBER_OF_SHARDS,2).put(IndexMetaData.SETTING_NUMBER_OF_REPLICAS,1)));
  ensureGreen();
  logger.info("--> Add dummy docs");
  client().prepareIndex("test","type1","1").setSource("field1",0).execute().actionGet();
  client().prepareIndex("test","type2","1").setSource("field1","0").execute().actionGet();
  logger.info("--> register a queries");
  for (int i=1; i <= 100; i++) {
    client().prepareIndex("test",PercolatorService.TYPE_NAME,Integer.toString(i)).setSource(jsonBuilder().startObject().field("query",rangeQuery("field1").from(0).to(i)).field("type","type1").endObject()).execute().actionGet();
  }
  logger.info("--> Percolate doc with field1=95");
  PercolateResponse response=client().preparePercolate().setIndices("test").setDocumentType("type1").setSource(jsonBuilder().startObject().startObject("doc").field("field1",95).endObject().endObject()).execute().actionGet();
  assertMatchCount(response,6l);
  assertThat(response.getMatches(),arrayWithSize(6));
  assertThat(convertFromTextArray(response.getMatches(),"test"),arrayContainingInAnyOrder("95","96","97","98","99","100"));
  logger.info("--> Close and open index to trigger percolate queries loading...");
  assertAcked(client().admin().indices().prepareClose("test"));
  assertAcked(client().admin().indices().prepareOpen("test"));
  ensureGreen();
  logger.info("--> Percolate doc with field1=100");
  response=client().preparePercolate().setIndices("test").setDocumentType("type1").setSource(jsonBuilder().startObject().startObject("doc").field("field1",100).endObject().endObject()).get();
  assertMatchCount(response,1l);
  assertThat(response.getMatches(),arrayWithSize(1));
  assertThat(response.getMatches()[0].getId().string(),equalTo("100"));
}
