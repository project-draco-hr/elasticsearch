{
  try {
    logger.info("[{}#{}]: cleaning up after test",getTestClass().getSimpleName(),getTestName());
    Scope currentClusterScope=getCurrentClusterScope();
    if (currentClusterScope == Scope.TEST) {
      clearClusters();
    }
 else {
      MetaData metaData=client().admin().cluster().prepareState().execute().actionGet().getState().getMetaData();
      assertThat("test leaves persistent cluster metadata behind: " + metaData.persistentSettings().getAsMap(),metaData.persistentSettings().getAsMap().size(),equalTo(0));
      assertThat("test leaves transient cluster metadata behind: " + metaData.transientSettings().getAsMap(),metaData.persistentSettings().getAsMap().size(),equalTo(0));
    }
    wipeIndices();
    wipeTemplates();
    ensureAllSearchersClosed();
    ensureAllFilesClosed();
    logger.info("[{}#{}]: cleaned up after test",getTestClass().getSimpleName(),getTestName());
  }
  finally {
    currentCluster.afterTest();
    currentCluster=null;
  }
}
