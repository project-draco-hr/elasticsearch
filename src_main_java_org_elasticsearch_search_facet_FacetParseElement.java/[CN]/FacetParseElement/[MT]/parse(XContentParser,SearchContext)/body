{
  XContentParser.Token token;
  List<FacetCollector> facetCollectors=null;
  String topLevelFieldName=null;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      topLevelFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      FacetCollector facet=null;
      String scope=ContextIndexSearcher.Scopes.MAIN;
      String facetFieldName=null;
      Filter filter=null;
      boolean cacheFilter=true;
      String nestedPath=null;
      while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
        if (token == XContentParser.Token.FIELD_NAME) {
          facetFieldName=parser.currentName();
        }
 else         if (token == XContentParser.Token.START_OBJECT) {
          if ("facet_filter".equals(facetFieldName) || "facetFilter".equals(facetFieldName)) {
            filter=context.queryParserService().parseInnerFilter(parser);
          }
 else {
            FacetProcessor facetProcessor=facetProcessors.processor(facetFieldName);
            if (facetProcessor == null) {
              throw new SearchParseException(context,"No facet type found for [" + facetFieldName + "]");
            }
            facet=facetProcessor.parse(topLevelFieldName,parser,context);
          }
        }
 else         if (token.isValue()) {
          if ("global".equals(facetFieldName)) {
            if (parser.booleanValue()) {
              scope=ContextIndexSearcher.Scopes.GLOBAL;
            }
          }
 else           if ("scope".equals(facetFieldName) || "_scope".equals(facetFieldName)) {
            throw new SearchParseException(context,"the [scope] support in facets have been removed");
          }
 else           if ("cache_filter".equals(facetFieldName) || "cacheFilter".equals(facetFieldName)) {
            cacheFilter=parser.booleanValue();
          }
 else           if ("nested".equals(facetFieldName)) {
            nestedPath=parser.text();
          }
        }
      }
      if (filter != null) {
        if (cacheFilter) {
          filter=context.filterCache().cache(filter);
        }
        facet.setFilter(filter);
      }
      if (nestedPath != null) {
        MapperService.SmartNameObjectMapper mapper=context.smartNameObjectMapper(nestedPath);
        if (mapper == null) {
          throw new SearchParseException(context,"facet nested path [" + nestedPath + "] not found");
        }
        ObjectMapper objectMapper=mapper.mapper();
        if (objectMapper == null) {
          throw new SearchParseException(context,"facet nested path [" + nestedPath + "] not found");
        }
        if (!objectMapper.nested().isNested()) {
          throw new SearchParseException(context,"facet nested path [" + nestedPath + "] is not nested");
        }
        facet=new NestedChildrenCollector(facet,context.filterCache().cache(NonNestedDocsFilter.INSTANCE),context.filterCache().cache(objectMapper.nestedTypeFilter()));
      }
      if (facet == null) {
        throw new SearchParseException(context,"no facet type found for facet named [" + topLevelFieldName + "]");
      }
      if (facetCollectors == null) {
        facetCollectors=Lists.newArrayList();
      }
      facetCollectors.add(facet);
      context.searcher().addCollector(scope,facet);
    }
  }
  context.facets(new SearchContextFacets(facetCollectors));
}
