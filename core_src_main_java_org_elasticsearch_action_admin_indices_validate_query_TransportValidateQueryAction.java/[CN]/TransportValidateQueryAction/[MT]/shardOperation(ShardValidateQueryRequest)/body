{
  IndexService indexService=indicesService.indexServiceSafe(request.shardId().getIndex());
  IndexShard indexShard=indexService.getShard(request.shardId().id());
  final QueryShardContext queryShardContext=indexService.newQueryShardContext();
  queryShardContext.setTypes(request.types());
  boolean valid;
  String explanation=null;
  String error=null;
  Engine.Searcher searcher=indexShard.acquireSearcher("validate_query");
  DefaultSearchContext searchContext=new DefaultSearchContext(0,new ShardSearchLocalRequest(request.types(),request.nowInMillis(),request.filteringAliases()),null,searcher,indexService,indexShard,scriptService,pageCacheRecycler,bigArrays,threadPool.estimatedTimeInMillisCounter(),parseFieldMatcher,SearchService.NO_TIMEOUT);
  SearchContext.setCurrent(searchContext);
  try {
    searchContext.parsedQuery(queryShardContext.toQuery(request.query()));
    searchContext.preProcess();
    valid=true;
    if (request.rewrite()) {
      explanation=getRewrittenQuery(searcher.searcher(),searchContext.query());
    }
 else     if (request.explain()) {
      explanation=searchContext.filteredQuery().query().toString();
    }
  }
 catch (  QueryShardException|ParsingException e) {
    valid=false;
    error=e.getDetailedMessage();
  }
catch (  AssertionError|IOException e) {
    valid=false;
    error=e.getMessage();
  }
 finally {
    searchContext.close();
    SearchContext.removeCurrent();
  }
  return new ShardValidateQueryResponse(request.shardId(),valid,explanation,error);
}
