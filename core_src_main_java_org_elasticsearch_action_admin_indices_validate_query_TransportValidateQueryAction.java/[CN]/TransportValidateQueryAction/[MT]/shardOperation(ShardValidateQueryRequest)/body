{
  IndexService indexService=indicesService.indexServiceSafe(request.shardId().getIndex());
  IndexQueryParserService queryParserService=indexService.queryParserService();
  IndexShard indexShard=indexService.getShard(request.shardId().id());
  boolean valid;
  String explanation=null;
  String error=null;
  Engine.Searcher searcher=indexShard.acquireSearcher("validate_query");
  DefaultSearchContext searchContext=new DefaultSearchContext(0,new ShardSearchLocalRequest(request.types(),request.nowInMillis(),request.filteringAliases()),null,searcher,indexService,indexShard,scriptService,pageCacheRecycler,bigArrays,threadPool.estimatedTimeInMillisCounter(),parseFieldMatcher,SearchService.NO_TIMEOUT);
  SearchContext.setCurrent(searchContext);
  try {
    if (request.source() != null && request.source().length() > 0) {
      searchContext.parsedQuery(queryParserService.parseQuery(request.source()));
    }
    searchContext.preProcess();
    valid=true;
    if (request.explain()) {
      explanation=searchContext.parsedQuery().query().toString();
    }
    if (request.rewrite()) {
      explanation=getRewrittenQuery(searcher.searcher(),searchContext.query());
    }
  }
 catch (  QueryShardException|ParsingException e) {
    valid=false;
    error=e.getDetailedMessage();
  }
catch (  AssertionError|IOException e) {
    valid=false;
    error=e.getMessage();
  }
 finally {
    searchContext.close();
    SearchContext.removeCurrent();
  }
  return new ShardValidateQueryResponse(request.shardId(),valid,explanation,error);
}
