{
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",between(1,3))).get();
  indexRandom("test",true,client().prepareIndex("test","type","1").setSource("field","value"),client().prepareIndex("test","type","2").setSource("field","value"),client().prepareIndex("test","type","3").setSource("field","value"),client().prepareIndex("test","type","4").setSource("field","value"),client().prepareIndex("test","type","5").setSource("field","value"),client().prepareIndex("test","type","6").setSource("field","value"));
  int iters=atLeast(10);
  for (int i=0; i < iters; i++) {
    CountResponse countResponse=client().prepareCount().setQuery(QueryBuilders.matchAllQuery()).setPreference(randomUnicodeOfLengthBetween(0,4)).get();
    assertHitCount(countResponse,6l);
  }
}
