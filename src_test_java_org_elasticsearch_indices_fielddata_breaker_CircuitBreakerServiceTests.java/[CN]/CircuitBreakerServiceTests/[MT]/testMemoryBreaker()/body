{
  assertAcked(prepareCreate("cb-test",1));
  final Client client=client();
  try {
    int docCount=atLeast(300);
    for (long id=0; id < docCount; id++) {
      client.prepareIndex("cb-test","type",Long.toString(id)).setSource(MapBuilder.<String,Object>newMapBuilder().put("test","value" + id).map()).execute().actionGet();
    }
    refresh();
    client.prepareSearch("cb-test").setSource("{\"sort\": \"test\",\"query\":{\"match_all\":{}}}").execute().actionGet();
    client.admin().indices().prepareClearCache("cb-test").setFieldDataCache(true).execute().actionGet();
    Settings settings=settingsBuilder().put(InternalCircuitBreakerService.CIRCUIT_BREAKER_MAX_BYTES_SETTING,randomRidiculouslySmallLimit()).put(InternalCircuitBreakerService.CIRCUIT_BREAKER_OVERHEAD_SETTING,1.05).build();
    client.admin().cluster().prepareUpdateSettings().setTransientSettings(settings).execute().actionGet();
    try {
      client.prepareSearch("cb-test").setSource("{\"sort\": \"test\",\"query\":{\"match_all\":{}}}").execute().actionGet();
      fail("should not reach this point");
    }
 catch (    SearchPhaseExecutionException e) {
    }
  }
  finally {
    Settings resetSettings=settingsBuilder().put(InternalCircuitBreakerService.CIRCUIT_BREAKER_MAX_BYTES_SETTING,"-1").put(InternalCircuitBreakerService.CIRCUIT_BREAKER_OVERHEAD_SETTING,InternalCircuitBreakerService.DEFAULT_OVERHEAD_CONSTANT).build();
    client.admin().cluster().prepareUpdateSettings().setTransientSettings(resetSettings).execute().actionGet();
  }
}
