{
  if (context.facets() != null && context.facets().hasQuery()) {
    for (    SearchContextFacets.Entry entry : context.facets().entries()) {
      if (entry.isGlobal()) {
        continue;
      }
      if (entry.getMode() == FacetExecutor.Mode.COLLECTOR) {
        Collector collector=entry.getFacetExecutor().collector();
        if (entry.getFilter() != null) {
          if (collector instanceof NestedFacetExecutor.Collector) {
            collector=new NestedFacetExecutor.Collector((NestedFacetExecutor.Collector)collector,entry.getFilter());
          }
 else {
            collector=new FilteredCollector(collector,entry.getFilter());
          }
        }
        context.searcher().addMainQueryCollector(collector);
      }
 else       if (entry.getMode() == FacetExecutor.Mode.POST) {
        context.searcher().enableMainDocIdSetCollector();
      }
 else {
        throw new ElasticSearchIllegalStateException("what mode?");
      }
    }
  }
}
