{
  Path[] dirs=new Path[randomIntBetween(1,5)];
  for (int i=0; i < dirs.length; i++) {
    dirs[i]=newTempDirPath(LifecycleScope.TEST);
  }
  final boolean deleteOldFiles=randomBoolean();
  Format format=new Format(randomFrom(XContentType.values()),deleteOldFiles);
  DummyState state=new DummyState(randomRealisticUnicodeOfCodepointLengthBetween(1,1000),randomInt(),randomLong(),randomDouble(),randomBoolean());
  int version=between(0,Integer.MAX_VALUE / 2);
  format.write(state,"foo-",version,dirs);
  for (  Path file : dirs) {
    Path[] list=content(file);
    assertEquals(list.length,1);
    assertThat(list[0].getFileName().toString(),equalTo(MetaDataStateFormat.STATE_DIR_NAME));
    Path stateDir=list[0];
    assertThat(Files.isDirectory(stateDir),is(true));
    list=content(stateDir);
    assertEquals(list.length,1);
    assertThat(list[0].getFileName().toString(),equalTo("foo-" + version + ".st"));
    try {
      format.read(list[0],between(version + 1,Integer.MAX_VALUE));
      fail("corruption expected");
    }
 catch (    CorruptStateException ex) {
    }
    DummyState read=format.read(list[0],version);
    assertThat(read,equalTo(state));
  }
}
