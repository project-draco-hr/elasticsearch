{
  boolean mustRewrite=!highlighterContext.query.queryRewritten();
  Query original=highlighterContext.query.originalQuery();
  MultiTermQuery originalMultiTermQuery=null;
  MultiTermQuery.RewriteMethod originalRewriteMethod=null;
  if (original instanceof MultiTermQuery) {
    originalMultiTermQuery=(MultiTermQuery)original;
    if (!allowsForTermExtraction(originalMultiTermQuery.getRewriteMethod())) {
      originalRewriteMethod=originalMultiTermQuery.getRewriteMethod();
      originalMultiTermQuery.setRewriteMethod(new MultiTermQuery.TopTermsScoringBooleanQueryRewrite(50));
      mustRewrite=true;
    }
  }
  if (!mustRewrite) {
    return highlighterContext.query.query();
  }
  Query query=original;
  for (Query rewrittenQuery=query.rewrite(reader); rewrittenQuery != query; rewrittenQuery=query.rewrite(reader)) {
    query=rewrittenQuery;
  }
  if (originalMultiTermQuery != null) {
    if (originalRewriteMethod != null) {
      originalMultiTermQuery.setRewriteMethod(originalRewriteMethod);
    }
  }
  return query;
}
