{
  IndexService indexService=indicesService.indexServiceSafe(request.index());
  IndexShard indexShard=indexService.shardSafe(request.shardId());
  SearchShardTarget shardTarget=new SearchShardTarget(clusterService.localNode().id(),request.index(),request.shardId());
  Engine.Searcher engineSearcher=indexShard.searcher();
  SearchContext context=new SearchContext(idGenerator.incrementAndGet(),shardTarget,request.searchType(),request.numberOfShards(),request.timeout(),request.types(),engineSearcher,indexService,scriptService);
  SearchContext.setCurrent(context);
  try {
    context.scroll(request.scroll());
    parseSource(context,request.source(),request.sourceOffset(),request.sourceLength());
    parseSource(context,request.extraSource(),request.extraSourceOffset(),request.extraSourceLength());
    if (context.from() == -1) {
      context.from(0);
    }
    if (context.size() == -1) {
      context.size(10);
    }
    Filter aliasFilter=indexService.aliasesService().aliasFilter(request.filteringAliases());
    context.aliasFilter(aliasFilter);
    dfsPhase.preProcess(context);
    queryPhase.preProcess(context);
    fetchPhase.preProcess(context);
    long keepAlive=defaultKeepAlive;
    if (request.scroll() != null && request.scroll().keepAlive() != null) {
      keepAlive=request.scroll().keepAlive().millis();
    }
    context.keepAlive(keepAlive);
  }
 catch (  RuntimeException e) {
    context.release();
    throw e;
  }
  return context;
}
