{
  try (BytesStreamOutput output=new BytesStreamOutput()){
    output.writeNamedWriteable(testQuery);
    try (StreamInput in=new NamedWriteableAwareStreamInput(StreamInput.wrap(output.bytes()),namedWriteableRegistry)){
      QueryBuilder<?> deserializedQuery=in.readNamedWriteable(QueryBuilder.class);
      assertEquals(testQuery,deserializedQuery);
      assertEquals(testQuery.hashCode(),deserializedQuery.hashCode());
      assertNotSame(testQuery,deserializedQuery);
      return (QB)deserializedQuery;
    }
   }
 }
