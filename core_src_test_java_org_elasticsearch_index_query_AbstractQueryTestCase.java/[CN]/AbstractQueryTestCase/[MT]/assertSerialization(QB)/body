{
  try (BytesStreamOutput output=new BytesStreamOutput()){
    testQuery.writeTo(output);
    try (StreamInput in=new NamedWriteableAwareStreamInput(StreamInput.wrap(output.bytes()),namedWriteableRegistry)){
      QueryParser<?> queryParser=queryParser(testQuery.getName());
      assertNotNull("queryparser not found for query: [" + testQuery.getName() + "]",queryParser);
      QueryBuilder<?> prototype=queryParser.getBuilderPrototype();
      QueryBuilder<?> deserializedQuery=prototype.readFrom(in);
      assertEquals(deserializedQuery,testQuery);
      assertEquals(deserializedQuery.hashCode(),testQuery.hashCode());
      assertNotSame(deserializedQuery,testQuery);
      return (QB)deserializedQuery;
    }
   }
 }
