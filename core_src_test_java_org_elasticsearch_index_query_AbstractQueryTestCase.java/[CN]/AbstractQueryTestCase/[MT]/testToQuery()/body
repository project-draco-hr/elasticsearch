{
  QueryShardContext context=createShardContext();
  context.setAllowUnmappedFields(true);
  QB firstQuery=createTestQueryBuilder();
  setSearchContext(randomTypes);
  Query firstLuceneQuery=firstQuery.toQuery(context);
  assertLuceneQuery(firstQuery,firstLuceneQuery,context);
  SearchContext.removeCurrent();
  QB secondQuery=copyQuery(firstQuery);
  if (randomBoolean()) {
    secondQuery.queryName(secondQuery.queryName() == null ? randomAsciiOfLengthBetween(1,30) : secondQuery.queryName() + randomAsciiOfLengthBetween(1,10));
  }
  setSearchContext(randomTypes);
  Query secondLuceneQuery=secondQuery.toQuery(context);
  assertLuceneQuery(secondQuery,secondLuceneQuery,context);
  SearchContext.removeCurrent();
  assertThat("two equivalent query builders lead to different lucene queries",secondLuceneQuery,equalTo(firstLuceneQuery));
  if (firstLuceneQuery != null && supportsBoostAndQueryName()) {
    secondQuery.boost(firstQuery.boost() + 1f + randomFloat());
    setSearchContext(randomTypes);
    Query thirdLuceneQuery=secondQuery.toQuery(context);
    SearchContext.removeCurrent();
    assertThat("modifying the boost doesn't affect the corresponding lucene query",firstLuceneQuery,not(equalTo(thirdLuceneQuery)));
  }
}
