{
  createIndex("test");
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForYellowStatus().execute().actionGet();
  String mapping=XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("num1").field("type","double").field("store","yes").endObject().endObject().endObject().endObject().string();
  client().admin().indices().preparePutMapping().setType("type1").setSource(mapping).execute().actionGet();
  client().prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("test","value beck").field("num1",1.0f).field("date","1970-01-01T00:00:00").endObject()).execute().actionGet();
  client().admin().indices().prepareFlush().execute().actionGet();
  client().prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().field("test","value beck").field("num1",2.0f).field("date","1970-01-01T00:00:25").endObject()).execute().actionGet();
  client().admin().indices().prepareFlush().execute().actionGet();
  client().prepareIndex("test","type1","3").setSource(jsonBuilder().startObject().field("test","value beck").field("num1",3.0f).field("date","1970-01-01T00:02:00").endObject()).execute().actionGet();
  client().admin().indices().refresh(refreshRequest()).actionGet();
  logger.info("running doc['num1'].value");
  SearchResponse response=client().prepareSearch().setQuery(matchAllQuery()).addSort("num1",SortOrder.ASC).addScriptField("sNum1","doc['num1'].value").addScriptField("sNum1_field","_fields['num1'].value").addScriptField("date1","doc['date'].date.millis").execute().actionGet();
  assertNoFailures(response);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().getAt(0).isSourceEmpty(),equalTo(true));
  assertThat(response.getHits().getAt(0).id(),equalTo("1"));
  assertThat((Double)response.getHits().getAt(0).fields().get("sNum1").values().get(0),equalTo(1.0));
  assertThat((Double)response.getHits().getAt(0).fields().get("sNum1_field").values().get(0),equalTo(1.0));
  assertThat((Long)response.getHits().getAt(0).fields().get("date1").values().get(0),equalTo(0l));
  assertThat(response.getHits().getAt(1).id(),equalTo("2"));
  assertThat((Double)response.getHits().getAt(1).fields().get("sNum1").values().get(0),equalTo(2.0));
  assertThat((Double)response.getHits().getAt(1).fields().get("sNum1_field").values().get(0),equalTo(2.0));
  assertThat((Long)response.getHits().getAt(1).fields().get("date1").values().get(0),equalTo(25000l));
  assertThat(response.getHits().getAt(2).id(),equalTo("3"));
  assertThat((Double)response.getHits().getAt(2).fields().get("sNum1").values().get(0),equalTo(3.0));
  assertThat((Double)response.getHits().getAt(2).fields().get("sNum1_field").values().get(0),equalTo(3.0));
  assertThat((Long)response.getHits().getAt(2).fields().get("date1").values().get(0),equalTo(120000l));
  logger.info("running doc['num1'].value * factor");
  Map<String,Object> params=MapBuilder.<String,Object>newMapBuilder().put("factor",2.0).map();
  response=client().prepareSearch().setQuery(matchAllQuery()).addSort("num1",SortOrder.ASC).addScriptField("sNum1","doc['num1'].value * factor",params).execute().actionGet();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().getAt(0).id(),equalTo("1"));
  assertThat((Double)response.getHits().getAt(0).fields().get("sNum1").values().get(0),equalTo(2.0));
  assertThat(response.getHits().getAt(1).id(),equalTo("2"));
  assertThat((Double)response.getHits().getAt(1).fields().get("sNum1").values().get(0),equalTo(4.0));
  assertThat(response.getHits().getAt(2).id(),equalTo("3"));
  assertThat((Double)response.getHits().getAt(2).fields().get("sNum1").values().get(0),equalTo(6.0));
}
