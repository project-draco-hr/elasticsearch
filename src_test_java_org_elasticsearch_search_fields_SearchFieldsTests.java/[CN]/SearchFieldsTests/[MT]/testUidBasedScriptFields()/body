{
  prepareCreate("test").addMapping("type1","num1","type=long").execute().actionGet();
  ensureYellow();
  int numDocs=randomIntBetween(1,30);
  IndexRequestBuilder[] indexRequestBuilders=new IndexRequestBuilder[numDocs];
  for (int i=0; i < numDocs; i++) {
    indexRequestBuilders[i]=client().prepareIndex("test","type1",Integer.toString(i)).setSource(jsonBuilder().startObject().field("num1",i).endObject());
  }
  indexRandom(true,indexRequestBuilders);
  SearchResponse response=client().prepareSearch().setQuery(matchAllQuery()).addSort("num1",SortOrder.ASC).setSize(numDocs).addScriptField("uid","_fields._uid.value").get();
  assertNoFailures(response);
  assertThat(response.getHits().totalHits(),equalTo((long)numDocs));
  for (int i=0; i < numDocs; i++) {
    assertThat(response.getHits().getAt(i).id(),equalTo(Integer.toString(i)));
    assertThat(response.getHits().getAt(i).fields().size(),equalTo(1));
    assertThat((String)response.getHits().getAt(i).fields().get("uid").value(),equalTo("type1#" + Integer.toString(i)));
  }
  response=client().prepareSearch().setQuery(matchAllQuery()).addSort("num1",SortOrder.ASC).setSize(numDocs).addScriptField("id","_fields._id.value").get();
  assertNoFailures(response);
  assertThat(response.getHits().totalHits(),equalTo((long)numDocs));
  for (int i=0; i < numDocs; i++) {
    assertThat(response.getHits().getAt(i).id(),equalTo(Integer.toString(i)));
    assertThat(response.getHits().getAt(i).fields().size(),equalTo(1));
    assertThat((String)response.getHits().getAt(i).fields().get("id").value(),equalTo(Integer.toString(i)));
  }
  response=client().prepareSearch().setQuery(matchAllQuery()).addSort("num1",SortOrder.ASC).setSize(numDocs).addScriptField("type","_fields._type.value").get();
  assertNoFailures(response);
  assertThat(response.getHits().totalHits(),equalTo((long)numDocs));
  for (int i=0; i < numDocs; i++) {
    assertThat(response.getHits().getAt(i).id(),equalTo(Integer.toString(i)));
    assertThat(response.getHits().getAt(i).fields().size(),equalTo(1));
    assertThat((String)response.getHits().getAt(i).fields().get("type").value(),equalTo("type1"));
  }
  response=client().prepareSearch().setQuery(matchAllQuery()).addSort("num1",SortOrder.ASC).setSize(numDocs).addScriptField("id","_fields._id.value").addScriptField("uid","_fields._uid.value").addScriptField("type","_fields._type.value").get();
  assertNoFailures(response);
  assertThat(response.getHits().totalHits(),equalTo((long)numDocs));
  for (int i=0; i < numDocs; i++) {
    assertThat(response.getHits().getAt(i).id(),equalTo(Integer.toString(i)));
    assertThat(response.getHits().getAt(i).fields().size(),equalTo(3));
    assertThat((String)response.getHits().getAt(i).fields().get("uid").value(),equalTo("type1#" + Integer.toString(i)));
    assertThat((String)response.getHits().getAt(i).fields().get("type").value(),equalTo("type1"));
    assertThat((String)response.getHits().getAt(i).fields().get("id").value(),equalTo(Integer.toString(i)));
  }
}
