{
  InputStream empty_dict=getClass().getResourceAsStream("empty_user_dict.txt");
  InputStream dict=getClass().getResourceAsStream("user_dict.txt");
  Path home=createTempDir();
  Path config=home.resolve("config");
  Files.createDirectory(config);
  Files.copy(empty_dict,config.resolve("empty_user_dict.txt"));
  Files.copy(dict,config.resolve("user_dict.txt"));
  String json="/org/elasticsearch/index/analysis/kuromoji_analysis.json";
  Settings settings=Settings.settingsBuilder().put("path.home",home).loadFromStream(json,getClass().getResourceAsStream(json)).put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT).build();
  Index index=new Index("test");
  AnalysisModule analysisModule=new AnalysisModule(new Environment(settings));
  new AnalysisKuromojiPlugin().onModule(analysisModule);
  Injector parentInjector=new ModulesBuilder().add(new SettingsModule(settings),new EnvironmentModule(new Environment(settings)),analysisModule).createInjector();
  return parentInjector.getInstance(AnalysisRegistry.class).build(IndexSettingsModule.newIndexSettings(index,settings,Collections.emptyList()));
}
