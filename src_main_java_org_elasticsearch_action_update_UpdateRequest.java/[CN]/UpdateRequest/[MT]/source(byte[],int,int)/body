{
  XContentType xContentType=XContentFactory.xContentType(source,offset,length);
  XContentParser parser=XContentFactory.xContent(xContentType).createParser(source,offset,length);
  XContentParser.Token t=parser.nextToken();
  if (t == null) {
    return this;
  }
  String currentFieldName=null;
  while ((t=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (t == XContentParser.Token.FIELD_NAME) {
      currentFieldName=parser.currentName();
    }
 else     if ("script".equals(currentFieldName)) {
      script=parser.textOrNull();
    }
 else     if ("params".equals(currentFieldName)) {
      scriptParams=parser.map();
    }
 else     if ("lang".equals(currentFieldName)) {
      scriptLang=parser.text();
    }
 else     if ("upsert".equals(currentFieldName)) {
      XContentBuilder builder=XContentFactory.contentBuilder(xContentType);
      builder.copyCurrentStructure(parser);
      safeUpsertRequest().source(builder);
    }
  }
  return this;
}
