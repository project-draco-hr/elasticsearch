{
  Map<String,String> expectedAttributes=new HashMap<>();
  int numCustomSettings=randomIntBetween(0,5);
  Settings.Builder builder=Settings.builder();
  for (int i=0; i < numCustomSettings; i++) {
    builder.put("node.attr" + i,"value" + i);
    expectedAttributes.put("attr" + i,"value" + i);
  }
  Set<DiscoveryNode.Role> selectedRoles=new HashSet<>();
  for (  DiscoveryNode.Role role : DiscoveryNode.Role.values()) {
    if (randomBoolean()) {
      selectedRoles.add(role);
    }
 else {
      boolean isRoleEnabled=randomBoolean();
      builder.put("node." + role.getRoleName(),isRoleEnabled);
      if (isRoleEnabled) {
        selectedRoles.add(role);
      }
    }
  }
  DiscoveryNodeService discoveryNodeService=new DiscoveryNodeService(builder.build(),Version.CURRENT);
  DiscoveryNode discoveryNode=discoveryNodeService.buildLocalNode(DummyTransportAddress.INSTANCE);
  assertThat(discoveryNode.getRoles(),equalTo(selectedRoles));
  assertThat(copyAttributes(discoveryNode.getAttributes()),equalTo(expectedAttributes));
}
