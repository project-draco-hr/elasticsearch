{
  if (randomBoolean()) {
    client().preparePutIndexedScript(GroovyScriptEngineService.NAME,"script1","{\"script\":\"2\"}").get();
  }
 else {
    client().prepareIndex(ScriptService.SCRIPT_INDEX,GroovyScriptEngineService.NAME,"script1").setSource("{\"script\":\"2\"}").get();
  }
  client().prepareIndex("test","scriptTest","1").setSource("{\"theField\":\"foo\"}").get();
  refresh();
  String source="{\"aggs\": {\"test\": { \"terms\" : { \"script_id\":\"script1\" } } } }";
  SearchResponse searchResponse=client().prepareSearch("test").setSource(new BytesArray(source)).get();
  assertHitCount(searchResponse,1);
  assertThat(searchResponse.getAggregations().get("test"),notNullValue());
}
