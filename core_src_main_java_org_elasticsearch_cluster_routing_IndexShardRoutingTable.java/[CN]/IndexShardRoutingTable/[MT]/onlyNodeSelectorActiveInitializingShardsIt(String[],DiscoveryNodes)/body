{
  ArrayList<ShardRouting> ordered=new ArrayList<>(activeShards.size() + allInitializingShards.size());
  Set<String> selectedNodes=Sets.newHashSet(discoveryNodes.resolveNodesIds(nodeAttributes));
  int seed=shuffler.nextSeed();
  for (  ShardRouting shardRouting : shuffler.shuffle(activeShards,seed)) {
    if (selectedNodes.contains(shardRouting.currentNodeId())) {
      ordered.add(shardRouting);
    }
  }
  for (  ShardRouting shardRouting : shuffler.shuffle(allInitializingShards,seed)) {
    if (selectedNodes.contains(shardRouting.currentNodeId())) {
      ordered.add(shardRouting);
    }
  }
  if (ordered.isEmpty()) {
    throw new IllegalArgumentException("no data nodes with critera(s) " + Strings.arrayToCommaDelimitedString(nodeAttributes) + "] found for shard:"+ shardId());
  }
  return new PlainShardIterator(shardId,ordered);
}
