{
  int changed=0;
  Map<String,PipelineReference> newPipelines=new HashMap<>(pipelines);
  for (  SearchHit hit : client.readAllPipelines()) {
    String pipelineId=hit.getId();
    BytesReference pipelineSource=hit.getSourceRef();
    PipelineReference previous=newPipelines.get(pipelineId);
    if (previous != null) {
      if (previous.getSource().equals(pipelineSource)) {
        continue;
      }
    }
    changed++;
    Pipeline.Builder builder=new Pipeline.Builder(hit.getId());
    builder.fromMap(hit.sourceAsMap(),processorFactoryRegistry);
    newPipelines.put(pipelineId,new PipelineReference(builder.build(),hit.getVersion(),pipelineSource));
  }
  int removed=0;
  for (  String existingPipelineId : pipelines.keySet()) {
    if (!client.existPipeline(existingPipelineId)) {
      newPipelines.remove(existingPipelineId);
      removed++;
    }
  }
  if (changed != 0 || removed != 0) {
    logger.debug("adding or updating [{}] pipelines and [{}] pipelines removed",changed,removed);
    pipelines=newPipelines;
  }
 else {
    logger.debug("no pipelines changes detected");
  }
}
