{
  int changed=0;
  Map<String,PipelineDefinition> newPipelines=new HashMap<>(pipelines);
  for (  SearchHit hit : readAllPipelines()) {
    String pipelineId=hit.getId();
    BytesReference pipelineSource=hit.getSourceRef();
    PipelineDefinition previous=newPipelines.get(pipelineId);
    if (previous != null) {
      if (previous.getSource().equals(pipelineSource)) {
        continue;
      }
    }
    changed++;
    Pipeline pipeline=constructPipeline(hit.getId(),hit.sourceAsMap());
    newPipelines.put(pipelineId,new PipelineDefinition(pipeline,hit.getVersion(),pipelineSource));
  }
  int removed=0;
  for (  String existingPipelineId : pipelines.keySet()) {
    if (!existPipeline(existingPipelineId)) {
      newPipelines.remove(existingPipelineId);
      removed++;
    }
  }
  if (changed != 0 || removed != 0) {
    logger.debug("adding or updating [{}] pipelines and [{}] pipelines removed",changed,removed);
    pipelines=newPipelines;
  }
 else {
    logger.debug("no pipelines changes detected");
  }
}
