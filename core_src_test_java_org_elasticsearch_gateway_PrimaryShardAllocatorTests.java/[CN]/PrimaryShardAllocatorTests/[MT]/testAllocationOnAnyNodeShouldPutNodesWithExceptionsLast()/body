{
  ShardRouting shard=TestShardRouting.newShardRouting("test",0,null,null,null,false,ShardRoutingState.UNASSIGNED,0,new UnassignedInfo(UnassignedInfo.Reason.CLUSTER_RECOVERED,null));
  Map<DiscoveryNode,TransportNodesListGatewayStartedShards.NodeGatewayStartedShards> data=new HashMap<>();
  data.put(node1,new TransportNodesListGatewayStartedShards.NodeGatewayStartedShards(node1,1));
  data.put(node2,new TransportNodesListGatewayStartedShards.NodeGatewayStartedShards(node2,1));
  data.put(node3,new TransportNodesListGatewayStartedShards.NodeGatewayStartedShards(node3,1,new IOException("I failed to open")));
  HashSet<String> ignoredNodes=new HashSet<>();
  ignoredNodes.add(node2.id());
  AsyncShardFetch.FetchResult<TransportNodesListGatewayStartedShards.NodeGatewayStartedShards> fetches=new AsyncShardFetch.FetchResult(shardId,data,new HashSet<>(),ignoredNodes);
  PrimaryShardAllocator.NodesAndVersions nAndV=testAllocator.buildNodesAndVersions(shard,false,ignoredNodes,fetches);
  assertThat(nAndV.allocationsFound,equalTo(1));
  assertThat(nAndV.highestVersion,equalTo(1L));
  assertThat(nAndV.nodes,contains(node1));
  nAndV=testAllocator.buildNodesAndVersions(shard,true,ignoredNodes,fetches);
  assertThat(nAndV.allocationsFound,equalTo(2));
  assertThat(nAndV.highestVersion,equalTo(1L));
  assertThat(nAndV.nodes.size(),equalTo(2));
  assertThat(nAndV.nodes,contains(node1,node3));
}
