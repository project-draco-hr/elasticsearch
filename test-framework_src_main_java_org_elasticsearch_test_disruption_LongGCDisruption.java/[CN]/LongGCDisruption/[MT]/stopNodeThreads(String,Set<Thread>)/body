{
  Thread[] allThreads=null;
  while (allThreads == null) {
    allThreads=new Thread[Thread.activeCount()];
    if (Thread.enumerate(allThreads) > allThreads.length) {
      allThreads=null;
    }
  }
  boolean stopped=false;
  final String nodeThreadNamePart="[" + node + "]";
  for (  Thread thread : allThreads) {
    if (thread == null) {
      continue;
    }
    String name=thread.getName();
    if (name.contains(nodeThreadNamePart)) {
      if (thread.isAlive() && nodeThreads.add(thread)) {
        stopped=true;
        thread.suspend();
        boolean safe=true;
        safe:         for (        StackTraceElement stackElement : thread.getStackTrace()) {
          String className=stackElement.getClassName();
          for (          Pattern unsafePattern : unsafeClasses) {
            if (unsafePattern.matcher(className).find()) {
              safe=false;
              break safe;
            }
          }
        }
        if (!safe) {
          thread.resume();
          nodeThreads.remove(thread);
        }
      }
    }
  }
  return stopped;
}
