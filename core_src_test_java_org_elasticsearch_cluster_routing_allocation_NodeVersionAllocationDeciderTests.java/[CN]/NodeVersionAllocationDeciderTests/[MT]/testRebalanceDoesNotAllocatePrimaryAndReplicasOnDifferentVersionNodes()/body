{
  ShardId shard1=new ShardId("test1",0);
  ShardId shard2=new ShardId("test2",0);
  final DiscoveryNode newNode=new DiscoveryNode("newNode",DummyTransportAddress.INSTANCE,Version.CURRENT);
  final DiscoveryNode oldNode1=new DiscoveryNode("oldNode1",DummyTransportAddress.INSTANCE,VersionUtils.getPreviousVersion());
  final DiscoveryNode oldNode2=new DiscoveryNode("oldNode2",DummyTransportAddress.INSTANCE,VersionUtils.getPreviousVersion());
  MetaData metaData=MetaData.builder().put(IndexMetaData.builder(shard1.getIndex()).settings(settings(Version.CURRENT).put(Settings.EMPTY)).numberOfShards(1).numberOfReplicas(1)).put(IndexMetaData.builder(shard2.getIndex()).settings(settings(Version.CURRENT).put(Settings.EMPTY)).numberOfShards(1).numberOfReplicas(1)).build();
  RoutingTable routingTable=RoutingTable.builder().add(IndexRoutingTable.builder(shard1.getIndex()).addIndexShard(new IndexShardRoutingTable.Builder(shard1).addShard(TestShardRouting.newShardRouting(shard1.getIndex(),shard1.getId(),newNode.id(),true,ShardRoutingState.STARTED,10)).addShard(TestShardRouting.newShardRouting(shard1.getIndex(),shard1.getId(),oldNode1.id(),false,ShardRoutingState.STARTED,10)).build())).add(IndexRoutingTable.builder(shard2.getIndex()).addIndexShard(new IndexShardRoutingTable.Builder(shard2).addShard(TestShardRouting.newShardRouting(shard2.getIndex(),shard2.getId(),newNode.id(),true,ShardRoutingState.STARTED,10)).addShard(TestShardRouting.newShardRouting(shard2.getIndex(),shard2.getId(),oldNode1.id(),false,ShardRoutingState.STARTED,10)).build())).build();
  ClusterState state=ClusterState.builder(org.elasticsearch.cluster.ClusterName.DEFAULT).metaData(metaData).routingTable(routingTable).nodes(DiscoveryNodes.builder().put(newNode).put(oldNode1).put(oldNode2)).build();
  AllocationDeciders allocationDeciders=new AllocationDeciders(Settings.EMPTY,new AllocationDecider[]{new NodeVersionAllocationDecider(Settings.EMPTY)});
  AllocationService strategy=new MockAllocationService(Settings.EMPTY,allocationDeciders,new ShardsAllocators(Settings.EMPTY,NoopGatewayAllocator.INSTANCE),EmptyClusterInfoService.INSTANCE);
  RoutingAllocation.Result result=strategy.reroute(state,new AllocationCommands(),true);
  state=ClusterState.builder(state).routingResult(result).build();
  assertThat(result.routingTable().index(shard2.getIndex()).shardsWithState(ShardRoutingState.RELOCATING).size(),equalTo(0));
  assertThat(result.routingTable().index(shard1.getIndex()).shardsWithState(ShardRoutingState.RELOCATING).size(),equalTo(0));
}
