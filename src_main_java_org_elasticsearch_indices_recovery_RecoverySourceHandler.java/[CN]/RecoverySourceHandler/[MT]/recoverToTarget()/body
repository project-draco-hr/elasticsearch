{
  try (Translog.View translogView=shard.translog().newView()){
    logger.trace("captured translog id [{}] for recovery",translogView.minTranslogId());
    final SnapshotIndexCommit phase1Snapshot;
    try {
      phase1Snapshot=shard.snapshotIndex(false);
    }
 catch (    Throwable e) {
      Releasables.closeWhileHandlingException(translogView);
      throw new RecoveryEngineException(shard.shardId(),1,"Snapshot failed",e);
    }
    try {
      phase1(phase1Snapshot,translogView);
    }
 catch (    Throwable e) {
      throw new RecoveryEngineException(shard.shardId(),1,"phase1 failed",e);
    }
 finally {
      Releasables.closeWhileHandlingException(phase1Snapshot);
    }
    logger.trace("snapshot translog for recovery. current size is [{}]",translogView.totalOperations());
    try (Translog.Snapshot phase2Snapshot=translogView.snapshot()){
      phase2(phase2Snapshot);
    }
 catch (    Throwable e) {
      throw new RecoveryEngineException(shard.shardId(),2,"phase2 failed",e);
    }
    finalizeRecovery();
  }
   return response;
}
