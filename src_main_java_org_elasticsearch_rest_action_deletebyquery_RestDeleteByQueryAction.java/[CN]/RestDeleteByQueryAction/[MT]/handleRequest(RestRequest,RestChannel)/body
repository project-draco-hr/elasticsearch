{
  DeleteByQueryRequest deleteByQueryRequest=new DeleteByQueryRequest(splitIndices(request.param("index")));
  deleteByQueryRequest.listenerThreaded(false);
  try {
    if (request.hasContent()) {
      deleteByQueryRequest.query(request.content(),request.contentUnsafe());
    }
 else {
      String source=request.param("source");
      if (source != null) {
        deleteByQueryRequest.query(source);
      }
 else {
        BytesReference bytes=RestActions.parseQuerySource(request);
        deleteByQueryRequest.query(bytes,false);
      }
    }
    deleteByQueryRequest.types(splitTypes(request.param("type")));
    deleteByQueryRequest.timeout(request.paramAsTime("timeout",ShardDeleteByQueryRequest.DEFAULT_TIMEOUT));
    deleteByQueryRequest.routing(request.param("routing"));
    String replicationType=request.param("replication");
    if (replicationType != null) {
      deleteByQueryRequest.replicationType(ReplicationType.fromString(replicationType));
    }
    String consistencyLevel=request.param("consistency");
    if (consistencyLevel != null) {
      deleteByQueryRequest.consistencyLevel(WriteConsistencyLevel.fromString(consistencyLevel));
    }
    final String ignoreIndices=request.param("ignore_indices");
    if (ignoreIndices != null) {
      deleteByQueryRequest.ignoreIndices(IgnoreIndices.fromString(ignoreIndices));
    }
  }
 catch (  Exception e) {
    try {
      XContentBuilder builder=RestXContentBuilder.restContentBuilder(request);
      channel.sendResponse(new XContentRestResponse(request,PRECONDITION_FAILED,builder.startObject().field("error",e.getMessage()).endObject()));
    }
 catch (    IOException e1) {
      logger.error("Failed to send failure response",e1);
    }
    return;
  }
  client.deleteByQuery(deleteByQueryRequest,new ActionListener<DeleteByQueryResponse>(){
    @Override public void onResponse(    DeleteByQueryResponse result){
      try {
        XContentBuilder builder=RestXContentBuilder.restContentBuilder(request);
        RestStatus restStatus=result.status();
        builder.startObject().field("ok",restStatus == RestStatus.OK);
        builder.startObject("_indices");
        for (        IndexDeleteByQueryResponse indexDeleteByQueryResponse : result.getIndices().values()) {
          builder.startObject(indexDeleteByQueryResponse.getIndex(),XContentBuilder.FieldCaseConversion.NONE);
          builder.startObject("_shards");
          builder.field("total",indexDeleteByQueryResponse.getTotalShards());
          builder.field("successful",indexDeleteByQueryResponse.getSuccessfulShards());
          builder.field("failed",indexDeleteByQueryResponse.getFailedShards());
          builder.endObject();
          builder.endObject();
        }
        builder.endObject();
        builder.endObject();
        channel.sendResponse(new XContentRestResponse(request,restStatus,builder));
      }
 catch (      Throwable e) {
        onFailure(e);
      }
    }
    @Override public void onFailure(    Throwable e){
      try {
        channel.sendResponse(new XContentThrowableRestResponse(request,e));
      }
 catch (      IOException e1) {
        logger.error("Failed to send failure response",e1);
      }
    }
  }
);
}
