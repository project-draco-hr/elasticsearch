{
  logger.trace("listing store meta data for {}",shardId);
  long startTimeNS=System.nanoTime();
  boolean exists=false;
  try {
    IndexService indexService=indicesService.indexService(shardId.getIndex());
    if (indexService != null) {
      IndexShard indexShard=indexService.getShardOrNull(shardId.id());
      if (indexShard != null) {
        final Store store=indexShard.store();
        store.incRef();
        try {
          exists=true;
          return new StoreFilesMetaData(shardId,store.getMetadataOrEmpty());
        }
  finally {
          store.decRef();
        }
      }
    }
    IndexMetaData metaData=clusterService.state().metaData().index(shardId.getIndex());
    if (metaData == null) {
      metaData=IndexMetaData.FORMAT.loadLatestState(logger,nodeEnv.indexPaths(shardId.getIndex()));
    }
    if (metaData == null) {
      logger.trace("{} node doesn't have meta data for the requests index, responding with empty",shardId);
      return new StoreFilesMetaData(shardId,Store.MetadataSnapshot.EMPTY);
    }
    final IndexSettings indexSettings=indexService != null ? indexService.getIndexSettings() : new IndexSettings(metaData,settings);
    final ShardPath shardPath=ShardPath.loadShardPath(logger,nodeEnv,shardId,indexSettings);
    if (shardPath == null) {
      return new StoreFilesMetaData(shardId,Store.MetadataSnapshot.EMPTY);
    }
    return new StoreFilesMetaData(shardId,Store.readMetadataSnapshot(shardPath.resolveIndex(),shardId,logger));
  }
  finally {
    TimeValue took=new TimeValue(System.nanoTime() - startTimeNS,TimeUnit.NANOSECONDS);
    if (exists) {
      logger.debug("{} loaded store meta data (took [{}])",shardId,took);
    }
 else {
      logger.trace("{} didn't find any store meta data to load (took [{}])",shardId,took);
    }
  }
}
