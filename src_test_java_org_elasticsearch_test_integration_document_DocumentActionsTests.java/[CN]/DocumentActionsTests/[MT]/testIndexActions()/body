{
  createIndex();
  logger.info("Running Cluster Health");
  ClusterHealthResponse clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForGreenStatus()).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("Indexing [type1/1]");
  IndexResponse indexResponse=client().prepareIndex().setIndex("test").setType("type1").setId("1").setSource(source("1","test")).setRefresh(true).execute().actionGet();
  assertThat(indexResponse.getIndex(),equalTo(getConcreteIndexName()));
  assertThat(indexResponse.getId(),equalTo("1"));
  assertThat(indexResponse.getType(),equalTo("type1"));
  logger.info("Refreshing");
  RefreshResponse refreshResponse=client().admin().indices().prepareRefresh("test").execute().actionGet();
  assertThat(refreshResponse.getSuccessfulShards(),equalTo(10));
  assertThat(refreshResponse.getFailedShards(),equalTo(0));
  logger.info("--> index exists?");
  IndicesExistsResponse indicesExistsResponse=client().admin().indices().prepareExists(getConcreteIndexName()).execute().actionGet();
  assertThat(indicesExistsResponse.isExists(),equalTo(true));
  logger.info("--> index exists?, fake index");
  indicesExistsResponse=client().admin().indices().prepareExists("test1234565").execute().actionGet();
  assertThat(indicesExistsResponse.isExists(),equalTo(false));
  logger.info("Clearing cache");
  ClearIndicesCacheResponse clearIndicesCacheResponse=client().admin().indices().clearCache(clearIndicesCacheRequest("test").recycler(true).fieldDataCache(true).filterCache(true).idCache(true)).actionGet();
  assertThat(clearIndicesCacheResponse.getSuccessfulShards(),equalTo(10));
  assertThat(clearIndicesCacheResponse.getFailedShards(),equalTo(0));
  logger.info("Optimizing");
  OptimizeResponse optimizeResponse=client().admin().indices().prepareOptimize("test").execute().actionGet();
  assertThat(optimizeResponse.getSuccessfulShards(),equalTo(10));
  assertThat(optimizeResponse.getFailedShards(),equalTo(0));
  GetResponse getResult;
  logger.info("Get [type1/1]");
  for (int i=0; i < 5; i++) {
    getResult=client().prepareGet("test","type1","1").setOperationThreaded(false).execute().actionGet();
    assertThat(getResult.getIndex(),equalTo(getConcreteIndexName()));
    assertThat("cycle #" + i,getResult.getSourceAsString(),equalTo(source("1","test").string()));
    assertThat("cycle(map) #" + i,(String)((Map)getResult.getSourceAsMap().get("type1")).get("name"),equalTo("test"));
    getResult=client().get(getRequest("test").type("type1").id("1").operationThreaded(true)).actionGet();
    assertThat("cycle #" + i,getResult.getSourceAsString(),equalTo(source("1","test").string()));
    assertThat(getResult.getIndex(),equalTo(getConcreteIndexName()));
  }
  logger.info("Get [type1/1] with script");
  for (int i=0; i < 5; i++) {
    getResult=client().prepareGet("test","type1","1").setFields("_source.type1.name").execute().actionGet();
    assertThat(getResult.getIndex(),equalTo(getConcreteIndexName()));
    assertThat(getResult.isExists(),equalTo(true));
    assertThat(getResult.getSourceAsBytes(),nullValue());
    assertThat(getResult.getField("_source.type1.name").getValues().get(0).toString(),equalTo("test"));
  }
  logger.info("Get [type1/2] (should be empty)");
  for (int i=0; i < 5; i++) {
    getResult=client().get(getRequest("test").type("type1").id("2")).actionGet();
    assertThat(getResult.isExists(),equalTo(false));
  }
  logger.info("Delete [type1/1]");
  DeleteResponse deleteResponse=client().prepareDelete("test","type1","1").setReplicationType(ReplicationType.SYNC).execute().actionGet();
  assertThat(deleteResponse.getIndex(),equalTo(getConcreteIndexName()));
  assertThat(deleteResponse.getId(),equalTo("1"));
  assertThat(deleteResponse.getType(),equalTo("type1"));
  logger.info("Refreshing");
  client().admin().indices().refresh(refreshRequest("test")).actionGet();
  logger.info("Get [type1/1] (should be empty)");
  for (int i=0; i < 5; i++) {
    getResult=client().get(getRequest("test").type("type1").id("1")).actionGet();
    assertThat(getResult.isExists(),equalTo(false));
  }
  logger.info("Index [type1/1]");
  client().index(indexRequest("test").type("type1").id("1").source(source("1","test"))).actionGet();
  logger.info("Index [type1/2]");
  client().index(indexRequest("test").type("type1").id("2").source(source("2","test2"))).actionGet();
  logger.info("Flushing");
  FlushResponse flushResult=client().admin().indices().prepareFlush("test").execute().actionGet();
  assertThat(flushResult.getSuccessfulShards(),equalTo(10));
  assertThat(flushResult.getFailedShards(),equalTo(0));
  logger.info("Refreshing");
  client().admin().indices().refresh(refreshRequest("test")).actionGet();
  logger.info("Get [type1/1] and [type1/2]");
  for (int i=0; i < 5; i++) {
    getResult=client().get(getRequest("test").type("type1").id("1")).actionGet();
    assertThat(getResult.getIndex(),equalTo(getConcreteIndexName()));
    assertThat("cycle #" + i,getResult.getSourceAsString(),equalTo(source("1","test").string()));
    getResult=client().get(getRequest("test").type("type1").id("2")).actionGet();
    String ste1=getResult.getSourceAsString();
    String ste2=source("2","test2").string();
    assertThat("cycle #" + i,ste1,equalTo(ste2));
    assertThat(getResult.getIndex(),equalTo(getConcreteIndexName()));
  }
  logger.info("Count");
  for (int i=0; i < 5; i++) {
    CountResponse countResponse=client().prepareCount("test").setQuery(termQuery("_type","type1")).setOperationThreading(BroadcastOperationThreading.NO_THREADS).execute().actionGet();
    assertThat("Failures " + countResponse.getShardFailures(),countResponse.getShardFailures() == null ? 0 : countResponse.getShardFailures().length,equalTo(0));
    assertThat(countResponse.getCount(),equalTo(2l));
    assertThat(countResponse.getSuccessfulShards(),equalTo(5));
    assertThat(countResponse.getFailedShards(),equalTo(0));
    countResponse=client().count(countRequest("test").query(termQuery("_type","type1")).operationThreading(BroadcastOperationThreading.SINGLE_THREAD)).actionGet();
    assertThat(countResponse.getCount(),equalTo(2l));
    assertThat(countResponse.getSuccessfulShards(),equalTo(5));
    assertThat(countResponse.getFailedShards(),equalTo(0));
    countResponse=client().count(countRequest("test").query(termQuery("_type","type1")).operationThreading(BroadcastOperationThreading.THREAD_PER_SHARD)).actionGet();
    assertThat(countResponse.getCount(),equalTo(2l));
    assertThat(countResponse.getSuccessfulShards(),equalTo(5));
    assertThat(countResponse.getFailedShards(),equalTo(0));
    countResponse=client().count(countRequest("test").query(Unicode.fromStringAsBytes("{ term : { _type : \"type1 } }"))).actionGet();
    assertThat(countResponse.getCount(),equalTo(0l));
    assertThat(countResponse.getSuccessfulShards(),equalTo(0));
    assertThat(countResponse.getFailedShards(),equalTo(5));
    countResponse=client().prepareCount("test").execute().actionGet();
    assertThat("Failures " + countResponse.getShardFailures(),countResponse.getShardFailures() == null ? 0 : countResponse.getShardFailures().length,equalTo(0));
    assertThat(countResponse.getCount(),equalTo(2l));
    assertThat(countResponse.getSuccessfulShards(),equalTo(5));
    assertThat(countResponse.getFailedShards(),equalTo(0));
  }
  logger.info("Delete by query");
  DeleteByQueryResponse queryResponse=client().prepareDeleteByQuery().setIndices("test").setQuery(termQuery("name","test2")).execute().actionGet();
  assertThat(queryResponse.getIndex(getConcreteIndexName()).getSuccessfulShards(),equalTo(5));
  assertThat(queryResponse.getIndex(getConcreteIndexName()).getFailedShards(),equalTo(0));
  client().admin().indices().refresh(refreshRequest("test")).actionGet();
  logger.info("Get [type1/1] and [type1/2], should be empty");
  for (int i=0; i < 5; i++) {
    getResult=client().get(getRequest("test").type("type1").id("1")).actionGet();
    assertThat(getResult.getIndex(),equalTo(getConcreteIndexName()));
    assertThat("cycle #" + i,getResult.getSourceAsString(),equalTo(source("1","test").string()));
    getResult=client().get(getRequest("test").type("type1").id("2")).actionGet();
    assertThat("cycle #" + i,getResult.isExists(),equalTo(false));
    assertThat(getResult.getIndex(),equalTo(getConcreteIndexName()));
  }
}
