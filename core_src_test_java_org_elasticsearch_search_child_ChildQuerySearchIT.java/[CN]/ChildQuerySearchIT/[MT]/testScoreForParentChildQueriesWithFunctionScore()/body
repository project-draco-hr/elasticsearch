{
  assertAcked(prepareCreate("test").addMapping("parent").addMapping("child","_parent","type=parent").addMapping("child1","_parent","type=parent"));
  ensureGreen();
  indexRandom(true,createDocBuilders().toArray(new IndexRequestBuilder[0]));
  SearchResponse response=client().prepareSearch("test").setQuery(QueryBuilders.hasChildQuery("child",QueryBuilders.functionScoreQuery(matchQuery("c_field2",0),fieldValueFactorFunction("c_field1")).boostMode(CombineFunction.REPLACE)).scoreMode(ScoreMode.Total)).get();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("1"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(4f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(3f));
  response=client().prepareSearch("test").setQuery(QueryBuilders.hasChildQuery("child",QueryBuilders.functionScoreQuery(matchQuery("c_field2",0),fieldValueFactorFunction("c_field1")).boostMode(CombineFunction.REPLACE)).scoreMode(ScoreMode.Max)).get();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(4f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("1"));
  assertThat(response.getHits().hits()[2].score(),equalTo(2f));
  response=client().prepareSearch("test").setQuery(QueryBuilders.hasChildQuery("child",QueryBuilders.functionScoreQuery(matchQuery("c_field2",0),fieldValueFactorFunction("c_field1")).boostMode(CombineFunction.REPLACE)).scoreMode(ScoreMode.Avg)).get();
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(4f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("1"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1.5f));
  response=client().prepareSearch("test").setQuery(QueryBuilders.hasParentQuery("parent",QueryBuilders.functionScoreQuery(matchQuery("p_field1","p_value3"),fieldValueFactorFunction("p_field2")).boostMode(CombineFunction.REPLACE)).score(true)).addSort(SortBuilders.fieldSort("c_field3")).addSort(SortBuilders.scoreSort()).get();
  assertThat(response.getHits().totalHits(),equalTo(7l));
  assertThat(response.getHits().hits()[0].id(),equalTo("13"));
  assertThat(response.getHits().hits()[0].score(),equalTo(5f));
  assertThat(response.getHits().hits()[1].id(),equalTo("14"));
  assertThat(response.getHits().hits()[1].score(),equalTo(5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("15"));
  assertThat(response.getHits().hits()[2].score(),equalTo(5f));
  assertThat(response.getHits().hits()[3].id(),equalTo("16"));
  assertThat(response.getHits().hits()[3].score(),equalTo(5f));
  assertThat(response.getHits().hits()[4].id(),equalTo("17"));
  assertThat(response.getHits().hits()[4].score(),equalTo(5f));
  assertThat(response.getHits().hits()[5].id(),equalTo("18"));
  assertThat(response.getHits().hits()[5].score(),equalTo(5f));
  assertThat(response.getHits().hits()[6].id(),equalTo("1"));
  assertThat(response.getHits().hits()[6].score(),equalTo(5f));
}
