{
  assertAcked(prepareCreate("test").addMapping("parent","id","type=long").addMapping("child","_parent","type=parent"));
  ensureGreen();
  indexRandom(true,createMinMaxDocBuilders().toArray(new IndexRequestBuilder[0]));
  SearchResponse response;
  response=minMaxQuery(ScoreType.NONE,0,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.NONE,1,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.NONE,2,0);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("4"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.NONE,3,0);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.NONE,4,0);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=minMaxQuery(ScoreType.NONE,0,4);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.NONE,0,3);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.NONE,0,2);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.NONE,2,2);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  try {
    response=minMaxQuery(ScoreType.NONE,3,2);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.toString(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=minMaxQuery(ScoreType.SUM,0,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.SUM,1,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.SUM,2,0);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  response=minMaxQuery(ScoreType.SUM,3,0);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  response=minMaxQuery(ScoreType.SUM,4,0);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=minMaxQuery(ScoreType.SUM,0,4);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.SUM,0,3);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.SUM,0,2);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.SUM,2,2);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  try {
    response=minMaxQuery(ScoreType.SUM,3,2);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.toString(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=minMaxQuery(ScoreType.MAX,0,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.MAX,1,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.MAX,2,0);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  response=minMaxQuery(ScoreType.MAX,3,0);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  response=minMaxQuery(ScoreType.MAX,4,0);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=minMaxQuery(ScoreType.MAX,0,4);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.MAX,0,3);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.MAX,0,2);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.MAX,2,2);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  try {
    response=minMaxQuery(ScoreType.MAX,3,2);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.toString(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=minMaxQuery(ScoreType.AVG,0,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.AVG,1,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.AVG,2,0);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  response=minMaxQuery(ScoreType.AVG,3,0);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  response=minMaxQuery(ScoreType.AVG,4,0);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=minMaxQuery(ScoreType.AVG,0,4);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.AVG,0,3);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.AVG,0,2);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=minMaxQuery(ScoreType.AVG,2,2);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1.5f));
  try {
    response=minMaxQuery(ScoreType.AVG,3,2);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.toString(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=minMaxFilter(0,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxFilter(1,0);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxFilter(2,0);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("4"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=minMaxFilter(3,0);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  response=minMaxFilter(4,0);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=minMaxFilter(0,4);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxFilter(0,3);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=minMaxFilter(0,2);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=minMaxFilter(2,2);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  try {
    response=minMaxFilter(3,2);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.toString(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
}
