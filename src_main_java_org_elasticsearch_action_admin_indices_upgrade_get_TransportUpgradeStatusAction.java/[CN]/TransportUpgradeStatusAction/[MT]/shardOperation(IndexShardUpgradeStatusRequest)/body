{
  IndexService indexService=indicesService.indexServiceSafe(request.shardId().getIndex());
  IndexShard indexShard=indexService.shardSafe(request.shardId().id());
  List<Segment> segments=indexShard.engine().segments(false);
  long total_bytes=0;
  long to_upgrade_bytes=0;
  long to_upgrade_bytes_ancient=0;
  for (  Segment seg : segments) {
    total_bytes+=seg.sizeInBytes;
    if (seg.version.major != Version.CURRENT.luceneVersion.major) {
      to_upgrade_bytes_ancient+=seg.sizeInBytes;
      to_upgrade_bytes+=seg.sizeInBytes;
    }
 else     if (seg.version.minor != Version.CURRENT.luceneVersion.minor) {
      to_upgrade_bytes+=seg.sizeInBytes;
    }
  }
  return new ShardUpgradeStatus(indexShard.routingEntry(),total_bytes,to_upgrade_bytes,to_upgrade_bytes_ancient);
}
