{
  ClusterState clusterState=clusterService.state();
  ClusterBlockException blockException=checkGlobalBlock(clusterState,request);
  if (blockException != null) {
    throw blockException;
  }
  String[] concreteIndices=clusterState.metaData().concreteIndices(request.indices());
  blockException=checkRequestBlock(clusterState,request,concreteIndices);
  if (blockException != null) {
    throw blockException;
  }
  final AtomicInteger indexCounter=new AtomicInteger();
  final AtomicInteger completionCounter=new AtomicInteger(concreteIndices.length);
  final AtomicReferenceArray<Object> indexResponses=new AtomicReferenceArray<Object>(concreteIndices.length);
  Map<String,Set<String>> routingMap=resolveRouting(clusterState,request);
  for (  final String index : concreteIndices) {
    Set<String> routing=null;
    if (routingMap != null) {
      routing=routingMap.get(index);
    }
    IndexRequest indexRequest=newIndexRequestInstance(request,index,routing);
    indexRequest.listenerThreaded(false);
    indexAction.execute(indexRequest,new ActionListener<IndexResponse>(){
      @Override public void onResponse(      IndexResponse result){
        indexResponses.set(indexCounter.getAndIncrement(),result);
        if (completionCounter.decrementAndGet() == 0) {
          listener.onResponse(newResponseInstance(request,indexResponses));
        }
      }
      @Override public void onFailure(      Throwable e){
        e.printStackTrace();
        int index=indexCounter.getAndIncrement();
        if (accumulateExceptions()) {
          indexResponses.set(index,e);
        }
        if (completionCounter.decrementAndGet() == 0) {
          listener.onResponse(newResponseInstance(request,indexResponses));
        }
      }
    }
);
  }
}
