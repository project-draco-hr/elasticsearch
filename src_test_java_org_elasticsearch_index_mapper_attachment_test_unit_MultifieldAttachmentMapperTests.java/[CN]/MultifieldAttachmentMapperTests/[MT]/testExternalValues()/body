{
  String originalText="This is an elasticsearch mapper attachment test.";
  String contentType="text/plain; charset=ISO-8859-1";
  String forcedName="dummyname.txt";
  String bytes=Base64.encodeBytes(originalText.getBytes(StandardCharsets.ISO_8859_1));
  threadPool=new ThreadPool("testing-only");
  MapperService mapperService=MapperTestUtils.newMapperService(createTempDir(),threadPool);
  mapperService.documentMapperParser().putTypeParser(AttachmentMapper.CONTENT_TYPE,new AttachmentMapper.TypeParser());
  String mapping=copyToStringFromClasspath("/org/elasticsearch/index/mapper/attachment/test/unit/multifield/multifield-mapping.json");
  DocumentMapper documentMapper=mapperService.documentMapperParser().parse(mapping);
  ParsedDocument doc=documentMapper.parse("person","1",XContentFactory.jsonBuilder().startObject().field("file",bytes).endObject().bytes());
  assertThat(doc.rootDoc().getField("file.content"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content").stringValue(),is(originalText + "\n"));
  assertThat(doc.rootDoc().getField("file.content_type"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content_type").stringValue(),is(contentType));
  assertThat(doc.rootDoc().getField("file.content_type.suggest"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content_type.suggest").stringValue(),is(contentType));
  assertThat(doc.rootDoc().getField("file.content_length"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content_length").numericValue().intValue(),is(originalText.length()));
  assertThat(doc.rootDoc().getField("file.content.suggest"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content.suggest").stringValue(),is(originalText + "\n"));
  doc=documentMapper.parse("person","1",XContentFactory.jsonBuilder().startObject().startObject("file").field("_content",bytes).field("_name",forcedName).endObject().endObject().bytes());
  assertThat(doc.rootDoc().getField("file.content"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content").stringValue(),is(originalText + "\n"));
  assertThat(doc.rootDoc().getField("file.content_type"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content_type").stringValue(),is(contentType));
  assertThat(doc.rootDoc().getField("file.content_type.suggest"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content_type.suggest").stringValue(),is(contentType));
  assertThat(doc.rootDoc().getField("file.content_length"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content_length").numericValue().intValue(),is(originalText.length()));
  assertThat(doc.rootDoc().getField("file.content.suggest"),notNullValue());
  assertThat(doc.rootDoc().getField("file.content.suggest").stringValue(),is(originalText + "\n"));
  assertThat(doc.rootDoc().getField("file.name"),notNullValue());
  assertThat(doc.rootDoc().getField("file.name").stringValue(),is(forcedName));
  assertThat(doc.rootDoc().getField("file.name").fieldType().stored(),is(false));
  assertThat(doc.rootDoc().getField("file.name.suggest"),notNullValue());
  assertThat(doc.rootDoc().getField("file.name.suggest").stringValue(),is(forcedName));
  assertThat(doc.rootDoc().getField("file.name.suggest").fieldType().stored(),is(true));
}
