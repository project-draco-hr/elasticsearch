{
  IndexFieldData fieldData=loadedFieldData.get(fieldNames.indexName());
  if (fieldData == null) {
synchronized (loadedFieldData) {
      fieldData=loadedFieldData.get(fieldNames.indexName());
      if (fieldData == null) {
        IndexFieldData.Builder builder=null;
        if (type.getFormat() != null) {
          builder=buildersByTypeAndFormat.get(Tuple.tuple(type.getType(),type.getFormat()));
          if (builder == null) {
            logger.warn("failed to find format [" + type.getFormat() + "] for field ["+ fieldNames.fullName()+ "], will use default");
          }
        }
        String format=indexSettings.get("index.fielddata.type." + type.getType() + ".format",null);
        if (format != null) {
          builder=buildersByTypeAndFormat.get(Tuple.tuple(type.getType(),type.getFormat()));
          if (builder == null) {
            logger.warn("failed to find index level type format [" + format + "] for field ["+ fieldNames.fullName()+ "], will use default");
          }
        }
        if (builder == null) {
          builder=buildersByType.get(type.getType());
        }
        if (builder == null) {
          throw new ElasticSearchIllegalArgumentException("failed to find field data builder for field " + fieldNames.fullName() + ", and type "+ type);
        }
        IndexFieldDataCache cache;
        if (type.getOptions().containsKey("cache")) {
          String cacheType=type.getOptions().get("cache");
          if ("resident".equals(cacheType)) {
            cache=new IndexFieldDataCache.Resident();
          }
 else           if ("soft".equals(cacheType)) {
            cache=new IndexFieldDataCache.Soft();
          }
 else {
            throw new ElasticSearchIllegalArgumentException("cache type not supported [" + cacheType + "] for field ["+ fieldNames.fullName()+ "]");
          }
        }
 else {
          cache=new IndexFieldDataCache.Resident();
        }
        fieldData=builder.build(index,indexSettings,fieldNames,type,cache);
        loadedFieldData.put(fieldNames.indexName(),fieldData);
      }
    }
  }
  return (IFD)fieldData;
}
