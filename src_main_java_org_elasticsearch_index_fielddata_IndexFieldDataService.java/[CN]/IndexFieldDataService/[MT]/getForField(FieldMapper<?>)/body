{
  final FieldMapper.Names fieldNames=mapper.names();
  final FieldDataType type=mapper.fieldDataType();
  if (type == null) {
    throw new ElasticsearchIllegalArgumentException("found no fielddata type for field [" + fieldNames.fullName() + "]");
  }
  final boolean docValues=mapper.hasDocValues();
  IndexFieldData<?> fieldData=loadedFieldData.get(fieldNames.indexName());
  if (fieldData == null) {
synchronized (loadedFieldData) {
      fieldData=loadedFieldData.get(fieldNames.indexName());
      if (fieldData == null) {
        IndexFieldData.Builder builder=null;
        String format=type.getFormat(indexSettings);
        if (format != null && FieldDataType.DOC_VALUES_FORMAT_VALUE.equals(format) && !docValues) {
          logger.warn("field [" + fieldNames.fullName() + "] has no doc values, will use default field data format");
          format=null;
        }
        if (format != null) {
          builder=buildersByTypeAndFormat.get(Tuple.tuple(type.getType(),format));
          if (builder == null) {
            logger.warn("failed to find format [" + format + "] for field ["+ fieldNames.fullName()+ "], will use default");
          }
        }
        if (builder == null && docValues) {
          builder=docValuesBuildersByType.get(type.getType());
        }
        if (builder == null) {
          builder=buildersByType.get(type.getType());
        }
        if (builder == null) {
          throw new ElasticsearchIllegalArgumentException("failed to find field data builder for field " + fieldNames.fullName() + ", and type "+ type.getType());
        }
        IndexFieldDataCache cache=fieldDataCaches.get(fieldNames.indexName());
        if (cache == null) {
          String cacheType=type.getSettings().get("cache",indexSettings.get("index.fielddata.cache","node"));
          if ("resident".equals(cacheType)) {
            cache=new IndexFieldDataCache.Resident(logger,indexService,fieldNames,type,indicesFieldDataCacheListener);
          }
 else           if ("soft".equals(cacheType)) {
            cache=new IndexFieldDataCache.Soft(logger,indexService,fieldNames,type,indicesFieldDataCacheListener);
          }
 else           if ("node".equals(cacheType)) {
            cache=indicesFieldDataCache.buildIndexFieldDataCache(indexService,index,fieldNames,type);
          }
 else           if ("none".equals(cacheType)) {
            cache=new IndexFieldDataCache.None();
          }
 else {
            throw new ElasticsearchIllegalArgumentException("cache type not supported [" + cacheType + "] for field ["+ fieldNames.fullName()+ "]");
          }
          fieldDataCaches.put(fieldNames.indexName(),cache);
        }
        GlobalOrdinalsBuilder globalOrdinalBuilder=new InternalGlobalOrdinalsBuilder(index(),indexSettings);
        fieldData=builder.build(index,indexSettings,mapper,cache,circuitBreakerService,indexService.mapperService(),globalOrdinalBuilder);
        loadedFieldData.put(fieldNames.indexName(),fieldData);
      }
    }
  }
  return (IFD)fieldData;
}
