{
  internalCluster().ensureAtLeastNumDataNodes(2);
  prepareCreate("test").setSettings(IndexMetaData.SETTING_NUMBER_OF_SHARDS,1).get();
  ensureGreen();
  IndexStats indexStats=client().admin().indices().prepareStats("test").get().getIndex("test");
  for (  ShardStats shardStats : indexStats.getShards()) {
    assertNull(shardStats.getCommitStats().getUserData().get(Engine.SYNC_COMMIT_ID));
  }
  SyncedFlushService.SyncedFlushResult result=internalCluster().getInstance(SyncedFlushService.class).attemptSyncedFlush(new ShardId("test",0));
  assertTrue(result.success());
  assertThat(result.totalShards(),equalTo(indexStats.getShards().length));
  assertThat(result.successfulShards(),equalTo(indexStats.getShards().length));
  indexStats=client().admin().indices().prepareStats("test").get().getIndex("test");
  String syncId=result.syncId();
  for (  ShardStats shardStats : indexStats.getShards()) {
    final String shardSyncId=shardStats.getCommitStats().getUserData().get(Engine.SYNC_COMMIT_ID);
    assertThat(shardSyncId,equalTo(syncId));
  }
}
