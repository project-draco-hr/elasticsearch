{
  Version version=VersionUtils.randomVersionBetween(random(),Version.V_1_0_0,Version.CURRENT);
  Settings settings=Settings.settingsBuilder().put(IndexMetaData.SETTING_VERSION_CREATED,version).build();
  IndexService indexService=createIndex("test",settings);
  Map<String,Mapper.TypeParser> mapperParsers=new HashMap<>();
  mapperParsers.put(ExternalMapperPlugin.EXTERNAL,new ExternalMapper.TypeParser(ExternalMapperPlugin.EXTERNAL,"foo"));
  mapperParsers.put(ExternalMapperPlugin.EXTERNAL_BIS,new ExternalMapper.TypeParser(ExternalMapperPlugin.EXTERNAL,"bar"));
  mapperParsers.put(StringFieldMapper.CONTENT_TYPE,new StringFieldMapper.TypeParser());
  MapperRegistry mapperRegistry=new MapperRegistry(mapperParsers,Collections.emptyMap());
  DocumentMapperParser parser=new DocumentMapperParser(indexService.getIndexSettings(),indexService.mapperService(),indexService.analysisService(),indexService.similarityService(),mapperRegistry);
  DocumentMapper documentMapper=parser.parse(XContentFactory.jsonBuilder().startObject().startObject("type").startObject("properties").startObject("field").field("type",ExternalMapperPlugin.EXTERNAL).startObject("fields").startObject("field").field("type","string").startObject("fields").startObject("generated").field("type",ExternalMapperPlugin.EXTERNAL_BIS).endObject().startObject("raw").field("type","string").endObject().endObject().endObject().startObject("raw").field("type","string").endObject().endObject().endObject().endObject().endObject().endObject().string());
  ParsedDocument doc=documentMapper.parse("test","type","1",XContentFactory.jsonBuilder().startObject().field("field","1234").endObject().bytes());
  assertThat(doc.rootDoc().getField("field.bool"),notNullValue());
  assertThat(doc.rootDoc().getField("field.bool").stringValue(),is("T"));
  assertThat(doc.rootDoc().getField("field.point"),notNullValue());
  if (version.before(Version.V_2_2_0)) {
    assertThat(doc.rootDoc().getField("field.point").stringValue(),is("42.0,51.0"));
  }
 else {
    assertThat(Long.parseLong(doc.rootDoc().getField("field.point").stringValue()),is(GeoUtils.mortonHash(51.0,42.0)));
  }
  assertThat(doc.rootDoc().getField("field.shape"),notNullValue());
  assertThat(doc.rootDoc().getField("field.field"),notNullValue());
  assertThat(doc.rootDoc().getField("field.field").stringValue(),is("foo"));
  assertThat(doc.rootDoc().getField("field.field.generated.generated"),notNullValue());
  assertThat(doc.rootDoc().getField("field.field.generated.generated").stringValue(),is("bar"));
  assertThat(doc.rootDoc().getField("field.field.raw"),notNullValue());
  assertThat(doc.rootDoc().getField("field.field.raw").stringValue(),is("foo"));
  assertThat(doc.rootDoc().getField("field.raw"),notNullValue());
  assertThat(doc.rootDoc().getField("field.raw").stringValue(),is("foo"));
}
