{
  if (multimap.isEmpty()) {
    return of();
  }
  if (multimap instanceof ImmutableSetMultimap) {
    @SuppressWarnings("unchecked") ImmutableSetMultimap<K,V> kvMultimap=(ImmutableSetMultimap<K,V>)multimap;
    return kvMultimap;
  }
  ImmutableMap.Builder<K,ImmutableSet<V>> builder=ImmutableMap.builder();
  int size=0;
  for (  Map.Entry<? extends K,? extends Collection<? extends V>> entry : multimap.asMap().entrySet()) {
    K key=entry.getKey();
    Collection<? extends V> values=entry.getValue();
    ImmutableSet<V> set=ImmutableSet.copyOf(values);
    if (!set.isEmpty()) {
      builder.put(key,set);
      size+=set.size();
    }
  }
  return new ImmutableSetMultimap<K,V>(builder.build(),size);
}
