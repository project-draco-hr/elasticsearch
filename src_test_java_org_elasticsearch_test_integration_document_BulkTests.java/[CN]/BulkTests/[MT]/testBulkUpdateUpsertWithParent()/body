{
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",2).put("index.number_of_replicas",1)).addMapping("child","{\"child\": {\"_parent\": {\"type\": \"parent\"}}}").execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  BulkRequestBuilder builder=client().prepareBulk();
  byte[] addParent=("{\"index\" : { \"_index\" : \"test\", \"_type\" : \"parent\", \"_id\" : \"parent1\"}}\n" + "{\"field1\" : \"value1\"}\n").getBytes("utf-8");
  byte[] addChild=("{\"update\" : { \"_id\" : \"child1\", \"_type\" : \"child\", \"_index\" : \"test\", \"parent\" : \"parent1\"} }\n" + "{ \"script\" : \"ctx._source.field2 = 'value2'\", \"upsert\" : {\"field1\" : \"value1\"}}\n").getBytes("utf-8");
  builder.add(addParent,0,addParent.length,false);
  builder.add(addChild,0,addChild.length,false);
  BulkResponse bulkResponse=builder.get();
  assertThat(bulkResponse.getItems().length,equalTo(2));
  assertThat(bulkResponse.getItems()[0].isFailed(),equalTo(false));
  assertThat(bulkResponse.getItems()[1].isFailed(),equalTo(false));
  client().admin().indices().prepareRefresh("test").get();
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.hasParentQuery("parent",QueryBuilders.matchAllQuery())).get();
  assertThat(searchResponse.getFailedShards(),equalTo(0));
  SearchHit[] hits=searchResponse.getHits().getHits();
  assertThat(hits.length,equalTo(1));
  assertThat(hits[0].getId(),equalTo("child1"));
}
