{
  failures=new CopyOnWriteArrayList<>();
  writers=new Thread[writerCount];
  stopLatch=new CountDownLatch(writers.length);
  logger.info("--> starting {} indexing threads",writerCount);
  for (int i=0; i < writers.length; i++) {
    final int indexerId=i;
    final Client client=client();
    writers[i]=new Thread(){
      @Override public void run(){
        long id=-1;
        try {
          startLatch.await();
          logger.info("**** starting indexing thread {}",indexerId);
          while (!stop.get()) {
            id=idGenerator.incrementAndGet();
            client.prepareIndex("test","type1",Long.toString(id) + "-" + indexerId).setSource(MapBuilder.<String,Object>newMapBuilder().put("test","value" + id).map()).execute().actionGet();
            indexCounter.incrementAndGet();
          }
          logger.info("**** done indexing thread {}",indexerId);
        }
 catch (        Throwable e) {
          failures.add(e);
          logger.warn("**** failed indexing thread {} on doc id {}",e,indexerId,id);
        }
 finally {
          stopLatch.countDown();
        }
      }
    }
;
    writers[i].start();
  }
  if (autoStart) {
    startLatch.countDown();
  }
}
