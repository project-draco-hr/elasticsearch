{
  SearchResponse[] iterationResults=new SearchResponse[iterations];
  boolean error=false;
  for (int i=0; i < iterations; i++) {
    SearchResponse searchResponse=client().prepareSearch().setSearchType(SearchType.COUNT).setQuery(matchAllQuery()).get();
    logSearchResponse(numberOfShards,numberOfDocs,i,searchResponse);
    iterationResults[i]=searchResponse;
    if (searchResponse.getHits().totalHits() != numberOfDocs) {
      error=true;
    }
  }
  if (error) {
    logger.info("--> refreshing again");
    refresh();
    for (int i=0; i < iterations; i++) {
      SearchResponse searchResponse=client().prepareSearch().setSearchType(SearchType.COUNT).setQuery(matchAllQuery()).execute().actionGet();
      logSearchResponse(numberOfShards,numberOfDocs,i,searchResponse);
    }
  }
  for (int i=0; i < iterations; i++) {
    assertHitCount(iterationResults[i],numberOfDocs);
  }
}
