{
  logger.info("--> creating test index ...");
  int numberOfShards=numberOfShards();
  assertAcked(prepareCreate("test",1,settingsBuilder().put(SETTING_NUMBER_OF_SHARDS,numberOfShards).put(SETTING_NUMBER_OF_REPLICAS,1)));
  final int totalNumDocs=scaledRandomIntBetween(200,20000);
  int waitFor=totalNumDocs / 10;
  int extraDocs=waitFor;
  try (BackgroundIndexer indexer=new BackgroundIndexer("test","type",client(),extraDocs)){
    logger.info("--> waiting for {} docs to be indexed ...",waitFor);
    waitForDocs(waitFor,indexer);
    indexer.assertNoFailures();
    logger.info("--> {} docs indexed",waitFor);
    extraDocs=totalNumDocs / 10;
    waitFor+=extraDocs;
    indexer.continueIndexing(extraDocs);
    logger.info("--> flushing the index ....");
    client().admin().indices().prepareFlush().execute().actionGet();
    logger.info("--> waiting for {} docs to be indexed ...",waitFor);
    waitForDocs(waitFor,indexer);
    indexer.assertNoFailures();
    logger.info("--> {} docs indexed",waitFor);
    extraDocs=totalNumDocs - waitFor;
    indexer.continueIndexing(extraDocs);
    logger.info("--> allow 2 nodes for index [test] ...");
    allowNodes("test",2);
    logger.info("--> waiting for GREEN health status ...");
    assertThat(client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setTimeout("1m").setWaitForGreenStatus().setWaitForNodes(">=2").execute().actionGet().isTimedOut(),equalTo(false));
    logger.info("--> waiting for {} docs to be indexed ...",totalNumDocs);
    waitForDocs(totalNumDocs,indexer);
    indexer.assertNoFailures();
    logger.info("--> {} docs indexed",totalNumDocs);
    logger.info("--> marking and waiting for indexing threads to stop ...");
    indexer.stop();
    logger.info("--> indexing threads stopped");
    logger.info("--> refreshing the index");
    refreshAndAssert();
    logger.info("--> verifying indexed content");
    iterateAssertCount(numberOfShards,indexer.totalIndexedDocs(),10);
  }
 }
