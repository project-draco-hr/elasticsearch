{
  if (master) {
    logger.warn("master should not receive new cluster state from [{}]",newState.nodes().masterNode());
  }
 else {
    if (newState.nodes().localNode() == null) {
      logger.warn("received a cluster state from [{}] and not part of the cluster, should not happen",newState.nodes().masterNode());
    }
 else {
      clusterService.submitStateUpdateTask("zen-disco-receive(from master [" + newState.nodes().masterNode() + "])",new ProcessedClusterStateUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          latestDiscoNodes=newState.nodes();
          if (masterFD.masterNode() == null || !masterFD.masterNode().equals(latestDiscoNodes.masterNode())) {
            masterFD.restart(latestDiscoNodes.masterNode(),"new cluster stare received and we monitor the wrong master [" + masterFD.masterNode() + "]");
          }
          ClusterState.Builder builder=ClusterState.builder().state(newState);
          if (newState.routingTable().version() == currentState.routingTable().version()) {
            builder.routingTable(currentState.routingTable());
          }
          if (newState.metaData().version() == currentState.metaData().version()) {
            builder.metaData(currentState.metaData());
          }
          return builder.build();
        }
        @Override public void clusterStateProcessed(        ClusterState clusterState){
          sendInitialStateEventIfNeeded();
        }
      }
);
    }
  }
}
