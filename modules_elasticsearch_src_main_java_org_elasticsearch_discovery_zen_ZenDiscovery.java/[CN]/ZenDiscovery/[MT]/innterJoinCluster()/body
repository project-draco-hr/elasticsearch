{
  boolean retry=true;
  while (retry) {
    if (lifecycle.stoppedOrClosed()) {
      return;
    }
    retry=false;
    DiscoveryNode masterNode=findMaster();
    if (masterNode == null) {
      retry=true;
      continue;
    }
    if (localNode.equals(masterNode)) {
      this.master=true;
      nodesFD.start();
      clusterService.submitStateUpdateTask("zen-disco-join (elected_as_master)",new ProcessedClusterStateUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          DiscoveryNodes.Builder builder=new DiscoveryNodes.Builder().localNodeId(localNode.id()).masterNodeId(localNode.id()).put(localNode);
          latestDiscoNodes=builder.build();
          ClusterBlocks clusterBlocks=ClusterBlocks.builder().blocks(currentState.blocks()).removeGlobalBlock(NO_MASTER_BLOCK).build();
          return newClusterStateBuilder().state(currentState).nodes(builder).blocks(clusterBlocks).build();
        }
        @Override public void clusterStateProcessed(        ClusterState clusterState){
          sendInitialStateEventIfNeeded();
        }
      }
);
    }
 else {
      this.master=false;
      try {
        transportService.connectToNode(masterNode);
      }
 catch (      Exception e) {
        logger.warn("failed to connect to master [{}], retrying...",e,masterNode);
        retry=true;
        continue;
      }
      ClusterState clusterState;
      try {
        clusterState=membership.sendJoinRequestBlocking(masterNode,localNode,initialPingTimeout);
      }
 catch (      Exception e) {
        if (e instanceof ElasticSearchException) {
          logger.info("failed to send join request to master [{}], reason [{}]",masterNode,((ElasticSearchException)e).getDetailedMessage());
        }
 else {
          logger.info("failed to send join request to master [{}], reason [{}]",masterNode,e.getMessage());
        }
        if (logger.isTraceEnabled()) {
          logger.trace("detailed failed reason",e);
        }
        retry=true;
        continue;
      }
      masterFD.start(masterNode,"initial_join");
      final MetaData metaData=clusterState.metaData();
      final long version=clusterState.version();
      clusterService.submitStateUpdateTask("zen-disco-join (detected master)",new ProcessedClusterStateUpdateTask(){
        @Override public ClusterState execute(        ClusterState currentState){
          ClusterBlocks clusterBlocks=ClusterBlocks.builder().blocks(currentState.blocks()).removeGlobalBlock(NO_MASTER_BLOCK).build();
          DiscoveryNodes.Builder nodesBuilder=DiscoveryNodes.newNodesBuilder().putAll(currentState.nodes()).put(localNode).localNodeId(localNode.id());
          return newClusterStateBuilder().state(currentState).nodes(nodesBuilder).blocks(clusterBlocks).metaData(metaData).version(version).build();
        }
        @Override public void clusterStateProcessed(        ClusterState clusterState){
        }
      }
);
    }
  }
}
