{
  pingService.stop();
  if (masterFD.masterNode() != null) {
    masterFD.stop("zen disco stop");
  }
  nodesFD.stop();
  initialStateSent.set(false);
  if (!master) {
    try {
      membership.sendLeaveRequestBlocking(latestDiscoNodes.masterNode(),localNode,TimeValue.timeValueSeconds(1));
    }
 catch (    Exception e) {
      logger.debug("Failed to send leave request to master [{}]",e,latestDiscoNodes.masterNode());
    }
  }
 else {
    DiscoveryNode[] possibleMasters=electMaster.nextPossibleMasters(latestDiscoNodes.nodes().values(),5);
    for (    DiscoveryNode possibleMaster : possibleMasters) {
      if (localNode.equals(possibleMaster)) {
        continue;
      }
      try {
        membership.sendLeaveRequest(latestDiscoNodes.masterNode(),possibleMaster);
      }
 catch (      Exception e) {
        logger.debug("Failed to send leave request from master [{}] to possible master [{}]",e,latestDiscoNodes.masterNode(),possibleMaster);
      }
    }
  }
  master=false;
}
