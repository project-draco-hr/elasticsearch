{
  Set<String> result=null;
  for (int i=0; i < aliasesOrIndices.length; i++) {
    String aliasOrIndex=aliasesOrIndices[i];
    if (aliasAndIndexToIndexMap.containsKey(aliasOrIndex)) {
      if (result != null) {
        result.add(aliasOrIndex);
      }
      continue;
    }
    boolean add=true;
    if (aliasOrIndex.charAt(0) == '+') {
      add=true;
      aliasOrIndex=aliasOrIndex.substring(1);
    }
 else     if (aliasOrIndex.charAt(0) == '-') {
      if (i == 0) {
        result=new THashSet<String>(Arrays.asList(wildcardOnlyOpen ? concreteAllOpenIndices() : concreteAllIndices()));
      }
      add=false;
      aliasOrIndex=aliasOrIndex.substring(1);
    }
    if (!Regex.isSimpleMatchPattern(aliasOrIndex)) {
      if (result != null) {
        if (add) {
          result.add(aliasOrIndex);
        }
 else {
          result.remove(aliasOrIndex);
        }
      }
      continue;
    }
    if (result == null) {
      result=new THashSet<String>();
      result.addAll(Arrays.asList(aliasesOrIndices).subList(0,i));
    }
    String[] indices=wildcardOnlyOpen ? concreteAllOpenIndices() : concreteAllIndices();
    boolean found=false;
    for (    String index : indices) {
      if (Regex.simpleMatch(aliasOrIndex,index)) {
        found=true;
        if (add) {
          result.add(index);
        }
 else {
          result.remove(index);
        }
      }
    }
    for (    String alias : aliases.keySet()) {
      if (Regex.simpleMatch(aliasOrIndex,alias)) {
        found=true;
        if (add) {
          result.add(alias);
        }
 else {
          result.remove(alias);
        }
      }
    }
    if (!found && !ignoreMissing) {
      throw new IndexMissingException(new Index(aliasOrIndex));
    }
  }
  if (result == null) {
    return aliasesOrIndices;
  }
  return result.toArray(new String[result.size()]);
}
