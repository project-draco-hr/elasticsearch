{
  if (logger.isDebugEnabled()) {
    logger.debug(new ParameterizedMessage("[{}] Failed to execute query phase",searchId),failure);
  }
  addShardFailure(shardIndex,new ShardSearchFailure(failure));
  successfulOps.decrementAndGet();
  if (counter.decrementAndGet() == 0) {
    if (successfulOps.get() == 0) {
      listener.onFailure(new SearchPhaseExecutionException("query","all shards failed",failure,buildShardFailures()));
    }
 else {
      try {
        executeFetchPhase();
      }
 catch (      Exception e) {
        e.addSuppressed(failure);
        listener.onFailure(new SearchPhaseExecutionException("query","Fetch failed",e,ShardSearchFailure.EMPTY_ARRAY));
      }
    }
  }
}
