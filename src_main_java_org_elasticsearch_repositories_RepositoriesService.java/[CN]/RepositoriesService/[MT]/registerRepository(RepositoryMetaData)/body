{
  RepositoryHolder previous=repositories.get(repositoryMetaData.name());
  if (previous != null) {
    if (!previous.type.equals(repositoryMetaData.type()) && previous.settings.equals(repositoryMetaData.settings())) {
      return false;
    }
  }
  RepositoryHolder holder=createRepositoryHolder(repositoryMetaData);
  if (previous != null) {
    closeRepository(repositoryMetaData.name(),previous);
  }
  Map<String,RepositoryHolder> newRepositories=newHashMap(repositories);
  newRepositories.put(repositoryMetaData.name(),holder);
  repositories=ImmutableMap.copyOf(newRepositories);
  return true;
}
