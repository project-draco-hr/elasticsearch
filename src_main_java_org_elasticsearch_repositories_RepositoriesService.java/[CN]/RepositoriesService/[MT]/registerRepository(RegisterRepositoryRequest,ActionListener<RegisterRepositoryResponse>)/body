{
  final RepositoryMetaData newRepositoryMetaData=new RepositoryMetaData(request.name,request.type,request.settings);
  clusterService.submitStateUpdateTask(request.cause,new AckedClusterStateUpdateTask(){
    @Override public ClusterState execute(    ClusterState currentState){
      if (!registerRepository(newRepositoryMetaData)) {
        return currentState;
      }
      MetaData metaData=currentState.metaData();
      MetaData.Builder mdBuilder=MetaData.builder(currentState.metaData());
      RepositoriesMetaData repositories=metaData.custom(RepositoriesMetaData.TYPE);
      if (repositories == null) {
        logger.info("put repository [{}]",request.name);
        repositories=new RepositoriesMetaData(new RepositoryMetaData(request.name,request.type,request.settings));
      }
 else {
        boolean found=false;
        List<RepositoryMetaData> repositoriesMetaData=new ArrayList<RepositoryMetaData>(repositories.repositories().size() + 1);
        for (        RepositoryMetaData repositoryMetaData : repositories.repositories()) {
          if (repositoryMetaData.name().equals(newRepositoryMetaData.name())) {
            found=true;
            repositoriesMetaData.add(newRepositoryMetaData);
          }
 else {
            repositoriesMetaData.add(repositoryMetaData);
          }
        }
        if (!found) {
          logger.info("put repository [{}]",request.name);
          repositoriesMetaData.add(new RepositoryMetaData(request.name,request.type,request.settings));
        }
 else {
          logger.info("update repository [{}]",request.name);
        }
        repositories=new RepositoriesMetaData(repositoriesMetaData.toArray(new RepositoryMetaData[repositoriesMetaData.size()]));
      }
      mdBuilder.putCustom(RepositoriesMetaData.TYPE,repositories);
      return ClusterState.builder(currentState).metaData(mdBuilder).build();
    }
    @Override public void onFailure(    String source,    Throwable t){
      logger.warn("failed to create repository [{}]",t,request.name);
      listener.onFailure(t);
    }
    @Override public TimeValue timeout(){
      return request.masterNodeTimeout;
    }
    @Override public void clusterStateProcessed(    String source,    ClusterState oldState,    ClusterState newState){
    }
    @Override public boolean mustAck(    DiscoveryNode discoveryNode){
      return discoveryNode.masterNode();
    }
    @Override public void onAllNodesAcked(    @Nullable Throwable t){
      listener.onResponse(new RegisterRepositoryResponse(true));
    }
    @Override public void onAckTimeout(){
      listener.onResponse(new RegisterRepositoryResponse(false));
    }
    @Override public TimeValue ackTimeout(){
      return request.ackTimeout();
    }
  }
);
}
