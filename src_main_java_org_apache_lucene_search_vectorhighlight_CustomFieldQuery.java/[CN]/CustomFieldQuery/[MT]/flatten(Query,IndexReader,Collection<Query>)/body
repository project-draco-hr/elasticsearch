{
  if (sourceQuery instanceof DisjunctionMaxQuery) {
    DisjunctionMaxQuery dmq=(DisjunctionMaxQuery)sourceQuery;
    for (    Query query : dmq) {
      flatten(query,reader,flatQueries);
    }
  }
 else   if (sourceQuery instanceof SpanTermQuery) {
    TermQuery termQuery=new TermQuery(((SpanTermQuery)sourceQuery).getTerm());
    if (!flatQueries.contains(termQuery)) {
      flatQueries.add(termQuery);
    }
  }
 else   if (sourceQuery instanceof ConstantScoreQuery) {
    ConstantScoreQuery constantScoreQuery=(ConstantScoreQuery)sourceQuery;
    if (constantScoreQuery.getFilter() != null) {
      flatten(constantScoreQuery.getFilter(),reader,flatQueries);
    }
 else {
      flatten(constantScoreQuery.getQuery(),reader,flatQueries);
    }
  }
 else   if (sourceQuery instanceof FunctionScoreQuery) {
    flatten(((FunctionScoreQuery)sourceQuery).getSubQuery(),reader,flatQueries);
  }
 else   if (sourceQuery instanceof FilteredQuery) {
    flatten(((FilteredQuery)sourceQuery).getQuery(),reader,flatQueries);
    flatten(((FilteredQuery)sourceQuery).getFilter(),reader,flatQueries);
  }
 else   if (sourceQuery instanceof XFilteredQuery) {
    flatten(((XFilteredQuery)sourceQuery).getQuery(),reader,flatQueries);
    flatten(((XFilteredQuery)sourceQuery).getFilter(),reader,flatQueries);
  }
 else   if (sourceQuery instanceof MultiPhrasePrefixQuery) {
    flatten(sourceQuery.rewrite(reader),reader,flatQueries);
  }
 else   if (sourceQuery instanceof FiltersFunctionScoreQuery) {
    flatten(((FiltersFunctionScoreQuery)sourceQuery).getSubQuery(),reader,flatQueries);
  }
 else   if (sourceQuery instanceof MultiPhraseQuery) {
    MultiPhraseQuery q=((MultiPhraseQuery)sourceQuery);
    convertMultiPhraseQuery(0,new int[q.getTermArrays().size()],q,q.getTermArrays(),q.getPositions(),reader,flatQueries);
  }
 else {
    super.flatten(sourceQuery,reader,flatQueries);
  }
}
