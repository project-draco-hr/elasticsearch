{
  Directory directory=null;
  if (isChecksum(name)) {
    directory=delegates[0];
  }
 else {
    if (delegates.length == 1) {
      directory=delegates[0];
    }
 else {
      long size=Long.MIN_VALUE;
      for (      Directory delegate : delegates) {
        if (delegate instanceof FSDirectory) {
          long currentSize=((FSDirectory)delegate).getDirectory().getUsableSpace();
          if (currentSize > size) {
            size=currentSize;
            directory=delegate;
          }
 else           if (currentSize == size && ThreadLocalRandom.current().nextBoolean()) {
            directory=delegate;
          }
 else {
          }
        }
 else {
          directory=delegate;
        }
      }
    }
  }
  IndexOutput out=directory.createOutput(name,context);
synchronized (mutex) {
    StoreFileMetaData metaData=new StoreFileMetaData(name,-1,null,directory);
    filesMetadata=MapBuilder.newMapBuilder(filesMetadata).put(name,metaData).immutableMap();
    files=filesMetadata.keySet().toArray(new String[filesMetadata.size()]);
    boolean computeChecksum=!raw;
    if (computeChecksum) {
      if ("segments.gen".equals(name) || name.startsWith("segments")) {
        computeChecksum=false;
      }
    }
    if (!raw && ((compressStored && name.endsWith(".fdt")) || (compressTv && name.endsWith(".tvf")))) {
      if (computeChecksum) {
        out=new ChecksumIndexOutput(out,new Adler32());
      }
      out=CompressorFactory.defaultCompressor().indexOutput(out);
    }
 else {
      if (computeChecksum) {
        out=new BufferedChecksumIndexOutput(out,new Adler32());
      }
    }
    return new StoreIndexOutput(metaData,out,name);
  }
}
