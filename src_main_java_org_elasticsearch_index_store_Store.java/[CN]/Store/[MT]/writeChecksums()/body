{
  String checksumName=CHECKSUMS_PREFIX + System.currentTimeMillis();
  ImmutableMap<String,StoreFileMetaData> files=list();
synchronized (mutex) {
    Map<String,String> checksums=new HashMap<String,String>();
    for (    StoreFileMetaData metaData : files.values()) {
      if (metaData.checksum() != null) {
        checksums.put(metaData.name(),metaData.checksum());
      }
    }
    IndexOutput output=directory.createOutput(checksumName,IOContext.DEFAULT,true);
    output.writeInt(0);
    output.writeStringStringMap(checksums);
    output.close();
  }
  for (  StoreFileMetaData metaData : files.values()) {
    if (metaData.name().startsWith(CHECKSUMS_PREFIX) && !checksumName.equals(metaData.name())) {
      try {
        directory.deleteFileChecksum(metaData.name());
      }
 catch (      Exception e) {
      }
    }
  }
}
