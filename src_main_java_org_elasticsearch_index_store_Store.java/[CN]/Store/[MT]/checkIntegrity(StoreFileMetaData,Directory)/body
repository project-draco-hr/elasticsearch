{
  try (IndexInput input=directory.openInput(md.name(),IOContext.READONCE)){
    if (input.length() != md.length()) {
      throw new CorruptIndexException("expected length=" + md.length() + " != actual length: "+ input.length()+ " : file truncated?",input);
    }
    if (md.writtenBy() != null && md.writtenBy().onOrAfter(Version.LUCENE_4_8_0)) {
      String checksum=Store.digestToString(CodecUtil.checksumEntireFile(input));
      if (!checksum.equals(md.checksum())) {
        throw new CorruptIndexException("inconsistent metadata: lucene checksum=" + checksum + ", metadata checksum="+ md.checksum(),input);
      }
    }
 else     if (md.hasLegacyChecksum()) {
      final Checksum checksum=new Adler32();
      final byte[] buffer=new byte[md.length() > 4096 ? 4096 : (int)md.length()];
      final long len=input.length();
      long read=0;
      while (len > read) {
        final long bytesLeft=len - read;
        final int bytesToRead=bytesLeft < buffer.length ? (int)bytesLeft : buffer.length;
        input.readBytes(buffer,0,bytesToRead,false);
        checksum.update(buffer,0,bytesToRead);
        read+=bytesToRead;
      }
      String adler32=Store.digestToString(checksum.getValue());
      if (!adler32.equals(md.checksum())) {
        throw new CorruptIndexException("checksum failed (hardware problem?) : expected=" + md.checksum() + " actual="+ adler32,input);
      }
    }
  }
 }
