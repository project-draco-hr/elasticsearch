{
  builder.startObject();
  if (keyedFilters == null && nonKeyedFilters == null) {
    throw new SearchSourceBuilderException("At least one filter must be set on filter aggregation [" + getName() + "]");
  }
  if (keyedFilters != null && nonKeyedFilters != null) {
    throw new SearchSourceBuilderException("Cannot add both keyed and non-keyed filters to filters aggregation");
  }
  if (keyedFilters != null) {
    builder.startObject(FiltersParser.FILTERS_FIELD.getPreferredName());
    for (    Map.Entry<String,QueryBuilder> entry : keyedFilters.entrySet()) {
      builder.field(entry.getKey());
      entry.getValue().toXContent(builder,params);
    }
    builder.endObject();
  }
  if (nonKeyedFilters != null) {
    builder.startArray(FiltersParser.FILTERS_FIELD.getPreferredName());
    for (    QueryBuilder filterBuilder : nonKeyedFilters) {
      filterBuilder.toXContent(builder,params);
    }
    builder.endArray();
  }
  if (otherBucketKey != null) {
    builder.field(FiltersParser.OTHER_BUCKET_KEY_FIELD.getPreferredName(),otherBucketKey);
  }
  if (otherBucket != null) {
    builder.field(FiltersParser.OTHER_BUCKET_FIELD.getPreferredName(),otherBucket);
  }
  return builder.endObject();
}
