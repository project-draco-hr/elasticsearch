{
  IntHashSet ports=new IntHashSet();
  int nextPort=randomIntBetween(49152,65535);
  for (int i=0; i < numberOfPorts; i++) {
    boolean foundPortInRange=false;
    while (!foundPortInRange) {
      if (!ports.contains(nextPort)) {
        logger.debug("looking to see if port [{}]is available",nextPort);
        try (ServerSocket serverSocket=new ServerSocket()){
          serverSocket.setReuseAddress(NetworkUtils.defaultReuseAddress());
          serverSocket.bind(new InetSocketAddress(nextPort));
          logger.debug("port [{}] available.",nextPort);
          foundPortInRange=true;
          ports.add(nextPort);
        }
 catch (        IOException e) {
          logger.debug("port [{}] not available.",e,nextPort);
        }
      }
      nextPort=randomIntBetween(49152,65535);
    }
  }
  return ports.toArray();
}
