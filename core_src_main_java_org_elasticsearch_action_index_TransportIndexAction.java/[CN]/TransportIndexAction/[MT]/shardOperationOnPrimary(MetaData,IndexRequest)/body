{
  IndexMetaData indexMetaData=metaData.index(request.shardId().getIndex());
  MappingMetaData mappingMd=indexMetaData.mappingOrDefault(request.type());
  if (mappingMd != null && mappingMd.routing().required()) {
    if (request.routing() == null) {
      throw new RoutingMissingException(request.shardId().getIndex().getName(),request.type(),request.id());
    }
  }
  IndexService indexService=indicesService.indexServiceSafe(request.shardId().getIndex());
  IndexShard indexShard=indexService.getShard(request.shardId().id());
  final WriteResult<IndexResponse> result=executeIndexRequestOnPrimary(request,indexShard,mappingUpdatedAction);
  final IndexResponse response=result.response;
  final Translog.Location location=result.location;
  processAfterWrite(request.refresh(),indexShard,location);
  return new Tuple<>(response,request);
}
