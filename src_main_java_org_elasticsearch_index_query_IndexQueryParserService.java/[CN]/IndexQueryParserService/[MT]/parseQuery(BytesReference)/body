{
  try {
    XContentParser parser=XContentHelper.createParser(source);
    for (XContentParser.Token token=parser.nextToken(); token != XContentParser.Token.END_OBJECT; token=parser.nextToken()) {
      if (token == XContentParser.Token.FIELD_NAME) {
        String fieldName=parser.currentName();
        if ("query".equals(fieldName)) {
          return parse(parser);
        }
 else         if ("query_binary".equals(fieldName) || "queryBinary".equals(fieldName)) {
          byte[] querySource=parser.binaryValue();
          XContentParser qSourceParser=XContentFactory.xContent(querySource).createParser(querySource);
          return parse(qSourceParser);
        }
 else {
          throw new QueryParsingException(index(),"request does not support [" + fieldName + "]");
        }
      }
    }
  }
 catch (  QueryParsingException e) {
    throw e;
  }
catch (  Throwable e) {
    throw new QueryParsingException(index,"Failed to parse",e);
  }
  throw new QueryParsingException(index(),"Required query is missing");
}
