{
  TopHitsAggregatorBuilder factory=new TopHitsAggregatorBuilder(name);
  factory.explain=in.readBoolean();
  factory.fetchSourceContext=FetchSourceContext.optionalReadFromStream(in);
  if (in.readBoolean()) {
    int size=in.readVInt();
    List<String> fieldDataFields=new ArrayList<>(size);
    for (int i=0; i < size; i++) {
      fieldDataFields.add(in.readString());
    }
    factory.fieldDataFields=fieldDataFields;
  }
  if (in.readBoolean()) {
    int size=in.readVInt();
    List<String> fieldNames=new ArrayList<>(size);
    for (int i=0; i < size; i++) {
      fieldNames.add(in.readString());
    }
    factory.fieldNames=fieldNames;
  }
  factory.from=in.readVInt();
  if (in.readBoolean()) {
    factory.highlightBuilder=HighlightBuilder.PROTOTYPE.readFrom(in);
  }
  if (in.readBoolean()) {
    int size=in.readVInt();
    List<ScriptField> scriptFields=new ArrayList<>(size);
    for (int i=0; i < size; i++) {
      scriptFields.add(ScriptField.PROTOTYPE.readFrom(in));
    }
    factory.scriptFields=scriptFields;
  }
  factory.size=in.readVInt();
  if (in.readBoolean()) {
    int size=in.readVInt();
    List<BytesReference> sorts=new ArrayList<>();
    for (int i=0; i < size; i++) {
      sorts.add(in.readBytesReference());
    }
    factory.sorts=sorts;
  }
  factory.trackScores=in.readBoolean();
  factory.version=in.readBoolean();
  return factory;
}
