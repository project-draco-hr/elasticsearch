{
  Facets facets=null;
  if (!queryResults.isEmpty()) {
    QuerySearchResult queryResult=queryResults.values().iterator().next().queryResult();
    if (queryResult.facets() != null && queryResult.facets().facets() != null && !queryResult.facets().facets().isEmpty()) {
      List<Facet> allFacets=Lists.newArrayList();
      for (      QuerySearchResultProvider queryResultProvider : queryResults.values()) {
        allFacets.addAll(queryResultProvider.queryResult().facets().facets());
      }
      List<Facet> mergedFacets=Lists.newArrayList();
      for (      Facet facet : queryResult.facets().facets()) {
        mergedFacets.add(((InternalFacet)facet).aggregate(allFacets));
      }
      facets=new Facets(mergedFacets);
    }
  }
  long totalHits=0;
  for (  QuerySearchResultProvider queryResultProvider : queryResults.values()) {
    totalHits+=queryResultProvider.queryResult().topDocs().totalHits;
  }
  for (  FetchSearchResultProvider fetchSearchResultProvider : fetchResults.values()) {
    fetchSearchResultProvider.fetchResult().initCounter();
  }
  List<InternalSearchHit> hits=new ArrayList<InternalSearchHit>();
  if (!fetchResults.isEmpty()) {
    for (    ShardDoc shardDoc : sortedDocs) {
      FetchSearchResultProvider fetchResultProvider=fetchResults.get(shardDoc.shardTarget());
      if (fetchResultProvider == null) {
        continue;
      }
      FetchSearchResult fetchResult=fetchResultProvider.fetchResult();
      int index=fetchResult.counterGetAndIncrement();
      if (index < fetchResult.hits().internalHits().length) {
        InternalSearchHit searchHit=fetchResult.hits().internalHits()[index];
        searchHit.shard(fetchResult.shardTarget());
        hits.add(searchHit);
      }
    }
  }
  InternalSearchHits searchHits=new InternalSearchHits(hits.toArray(new InternalSearchHit[hits.size()]),totalHits);
  return new InternalSearchResponse(searchHits,facets);
}
