{
  logger.debug("close now acquire writeLock");
  try (InternalLock _=writeLock.acquire()){
    logger.debug("close acquired writeLock");
    if (isClosed.compareAndSet(false,true)) {
      try {
        closedOrFailed=true;
        this.versionMap.clear();
        logger.debug("close searcherManager");
        try {
          IOUtils.close(searcherManager);
        }
 catch (        Throwable t) {
          logger.warn("Failed to close SearcherManager",t);
        }
        if (indexWriter != null) {
          logger.debug("rollback indexWriter");
          try {
            indexWriter.rollback();
          }
 catch (          AlreadyClosedException e) {
          }
          logger.debug("rollback indexWriter done");
        }
      }
 catch (      Throwable e) {
        logger.warn("failed to rollback writer on close",e);
      }
 finally {
        store.decRef();
        this.mergeScheduler.removeListener(mergeSchedulerListener);
        this.mergeScheduler.removeFailureListener(mergeSchedulerFailureListener);
        engineConfig.getIndexSettingsService().removeListener(listener);
      }
    }
  }
 }
