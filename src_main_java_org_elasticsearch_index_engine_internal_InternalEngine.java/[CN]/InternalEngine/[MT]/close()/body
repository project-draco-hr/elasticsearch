{
  try (InternalLock _=writeLock.acquire()){
    if (!closed) {
      try {
        closed=true;
        indexSettingsService.removeListener(applySettings);
        this.versionMap.clear();
        this.failedEngineListeners.clear();
        try {
          IOUtils.close(searcherManager);
        }
 catch (        Throwable t) {
          logger.warn("Failed to close SearcherManager",t);
        }
        if (indexWriter != null) {
          long t0=System.nanoTime();
          try {
            indexWriter.rollback();
          }
 catch (          AlreadyClosedException e) {
          }
          long t1=System.nanoTime();
          if (logger.isDebugEnabled()) {
            logger.debug("indexWriter.rollback took {} nanoseconds",t1 - t0);
          }
        }
      }
 catch (      Throwable e) {
        logger.warn("failed to rollback writer on close",e);
      }
 finally {
        indexWriter=null;
        store.decRef();
      }
    }
  }
 }
