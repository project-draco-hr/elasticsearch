{
synchronized (dirtyLock(index.uid())) {
    final long currentVersion;
    VersionValue versionValue=versionMap.getUnderLock(index.uid().bytes());
    if (versionValue == null) {
      currentVersion=loadCurrentVersionFromIndex(index.uid());
    }
 else {
      if (engineConfig.isEnableGcDeletes() && versionValue.delete() && (engineConfig.getThreadPool().estimatedTimeInMillis() - versionValue.time()) > engineConfig.getGcDeletesInMillis()) {
        currentVersion=Versions.NOT_FOUND;
      }
 else {
        currentVersion=versionValue.version();
      }
    }
    long updatedVersion;
    long expectedVersion=index.version();
    if (index.versionType().isVersionConflictForWrites(currentVersion,expectedVersion)) {
      if (index.origin() == Operation.Origin.RECOVERY) {
        return;
      }
 else {
        throw new VersionConflictEngineException(shardId,index.type(),index.id(),currentVersion,expectedVersion);
      }
    }
    updatedVersion=index.versionType().updateVersion(currentVersion,expectedVersion);
    index.updateVersion(updatedVersion);
    if (currentVersion == Versions.NOT_FOUND) {
      index.created(true);
      if (index.docs().size() > 1) {
        writer.addDocuments(index.docs());
      }
 else {
        writer.addDocument(index.docs().get(0));
      }
    }
 else {
      if (versionValue != null) {
        index.created(versionValue.delete());
      }
      if (index.docs().size() > 1) {
        writer.updateDocuments(index.uid(),index.docs());
      }
 else {
        writer.updateDocument(index.uid(),index.docs().get(0));
      }
    }
    Translog.Location translogLocation=translog.add(new Translog.Index(index));
    versionMap.putUnderLock(index.uid().bytes(),new VersionValue(updatedVersion,translogLocation));
    indexingService.postIndexUnderLock(index);
  }
}
