{
  rwl.writeLock().lock();
  try {
    if (closed) {
      throw new EngineClosedException(shardId);
    }
    onGoingRecoveries.startRecovery();
  }
  finally {
    rwl.writeLock().unlock();
  }
  SnapshotIndexCommit phase1Snapshot;
  try {
    phase1Snapshot=deletionPolicy.snapshot();
  }
 catch (  Throwable e) {
    Releasables.releaseWhileHandlingException(onGoingRecoveries);
    throw new RecoveryEngineException(shardId,1,"Snapshot failed",e);
  }
  try {
    recoveryHandler.phase1(phase1Snapshot);
  }
 catch (  Throwable e) {
    Releasables.releaseWhileHandlingException(onGoingRecoveries,phase1Snapshot);
    if (closed) {
      e=new EngineClosedException(shardId,e);
    }
    throw new RecoveryEngineException(shardId,1,"Execution failed",e);
  }
  Translog.Snapshot phase2Snapshot;
  try {
    phase2Snapshot=translog.snapshot();
  }
 catch (  Throwable e) {
    Releasables.releaseWhileHandlingException(onGoingRecoveries,phase1Snapshot);
    if (closed) {
      e=new EngineClosedException(shardId,e);
    }
    throw new RecoveryEngineException(shardId,2,"Snapshot failed",e);
  }
  try {
    recoveryHandler.phase2(phase2Snapshot);
  }
 catch (  Throwable e) {
    Releasables.releaseWhileHandlingException(onGoingRecoveries,phase1Snapshot,phase2Snapshot);
    if (closed) {
      e=new EngineClosedException(shardId,e);
    }
    throw new RecoveryEngineException(shardId,2,"Execution failed",e);
  }
  rwl.writeLock().lock();
  Translog.Snapshot phase3Snapshot=null;
  boolean success=false;
  try {
    phase3Snapshot=translog.snapshot(phase2Snapshot);
    recoveryHandler.phase3(phase3Snapshot);
    success=true;
  }
 catch (  Throwable e) {
    throw new RecoveryEngineException(shardId,3,"Execution failed",e);
  }
 finally {
    Releasables.release(success,onGoingRecoveries);
    rwl.writeLock().unlock();
    Releasables.release(success,phase1Snapshot,phase2Snapshot,phase3Snapshot);
  }
}
