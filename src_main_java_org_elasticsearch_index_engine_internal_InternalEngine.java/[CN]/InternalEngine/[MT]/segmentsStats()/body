{
  try (InternalLock _=readLock.acquire()){
    ensureOpen();
    try (final Searcher searcher=acquireSearcher("segments_stats")){
      SegmentsStats stats=new SegmentsStats();
      for (      LeafReaderContext reader : searcher.reader().leaves()) {
        final SegmentReader segmentReader=segmentReader(reader.reader());
        stats.add(1,segmentReader.ramBytesUsed());
        stats.addTermsMemoryInBytes(guardedRamBytesUsed(segmentReader.fields()));
        stats.addStoredFieldsMemoryInBytes(guardedRamBytesUsed(segmentReader.getFieldsReader()));
        stats.addTermVectorsMemoryInBytes(guardedRamBytesUsed(segmentReader.getTermVectorsReader()));
        stats.addNormsMemoryInBytes(guardedRamBytesUsed(segmentReader.getNormsReader()));
        stats.addDocValuesMemoryInBytes(guardedRamBytesUsed(segmentReader.getDocValuesReader()));
      }
      stats.addVersionMapMemoryInBytes(versionMap.ramBytesUsed());
      stats.addIndexWriterMemoryInBytes(indexWriter.ramBytesUsed());
      stats.addIndexWriterMaxMemoryInBytes((long)(indexWriter.getConfig().getRAMBufferSizeMB() * 1024 * 1024));
      return stats;
    }
   }
 }
