{
  try {
    Method method=IndexWriter.class.getDeclaredMethod("waitForMerges");
    method.setAccessible(true);
    method.invoke(indexWriter);
  }
 catch (  ReflectiveOperationException e) {
    throw new OptimizeFailedEngineException(shardId,e);
  }
  if (flushAfter) {
    flush(true,true,true);
  }
  if (upgrade) {
    logger.info("Finished upgrade of " + shardId);
  }
}
