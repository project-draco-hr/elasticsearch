{
  final int min=2;
  final int max=4;
  final ThreadBarrier barrier=new ThreadBarrier(max + 1);
  ThreadPoolExecutor pool=EsExecutors.newScalingExecutorService(min,max,10,TimeUnit.MILLISECONDS,EsExecutors.daemonThreadFactory("test"));
  assertThat("Min property",pool.getCorePoolSize(),equalTo(min));
  assertThat("Max property",pool.getMaximumPoolSize(),equalTo(max));
  for (int i=0; i < max; ++i) {
    pool.execute(new Runnable(){
      public void run(){
        try {
          barrier.await();
          barrier.await();
        }
 catch (        Throwable e) {
          barrier.reset(e);
        }
      }
    }
);
    Thread.sleep(100);
  }
  barrier.await();
  assertThat("wrong pool size",pool.getPoolSize(),equalTo(max));
  assertThat("wrong active size",pool.getActiveCount(),equalTo(max));
  barrier.await();
  Thread.sleep(1000);
  assertThat("wrong active count",pool.getActiveCount(),equalTo(0));
  assertThat("idle threads didn't shrink below max. (" + pool.getPoolSize() + ")",pool.getPoolSize(),lessThan(max));
  pool.shutdown();
}
