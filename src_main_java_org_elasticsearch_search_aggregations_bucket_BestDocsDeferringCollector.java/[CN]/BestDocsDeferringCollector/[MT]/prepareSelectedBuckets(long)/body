{
  if (!finished) {
    throw new IllegalStateException("Cannot replay yet, collection is not finished: postCollect() has not been called");
  }
  if (selectedBuckets.length > 1) {
    throw new IllegalStateException("Collection only supported on a single bucket");
  }
  deferred.preCollection();
  TopDocs topDocs=tdc.topDocs();
  ScoreDoc[] sd=topDocs.scoreDocs;
  matchedDocs=sd.length;
  Arrays.sort(sd,new Comparator<ScoreDoc>(){
    @Override public int compare(    ScoreDoc o1,    ScoreDoc o2){
      return o1.doc - o2.doc;
    }
  }
);
  try {
    for (    PerSegmentCollects perSegDocs : entries) {
      perSegDocs.replayRelatedMatches(sd);
    }
  }
 catch (  IOException e) {
    throw new ElasticsearchException("IOException collecting best scoring results",e);
  }
  deferred.postCollection();
}
