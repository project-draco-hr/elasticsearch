{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",1).put("index.referesh_interval",-1).build()).addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("nested1").field("type","nested").endObject().endObject().endObject().endObject()).execute().actionGet();
  client.admin().indices().prepareAliases().addAlias("test","alias1",FilterBuilders.termFilter("field1","value1")).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  client.prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("field1","value1").startArray("nested1").startObject().field("n_field1","n_value1_1").field("n_field2","n_value2_1").endObject().startObject().field("n_field1","n_value1_2").field("n_field2","n_value2_2").endObject().endArray().endObject()).execute().actionGet();
  client.prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().field("field1","value2").startArray("nested1").startObject().field("n_field1","n_value1_1").field("n_field2","n_value2_1").endObject().startObject().field("n_field1","n_value1_2").field("n_field2","n_value2_2").endObject().endArray().endObject()).execute().actionGet();
  client.admin().indices().prepareFlush().setRefresh(true).execute().actionGet();
  IndicesStatusResponse statusResponse=client.admin().indices().prepareStatus().execute().actionGet();
  assertThat(statusResponse.getIndex("test").getDocs().getNumDocs(),equalTo(6l));
  client.prepareDeleteByQuery("alias1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet();
  client.admin().indices().prepareFlush().setRefresh(true).execute().actionGet();
  statusResponse=client.admin().indices().prepareStatus().execute().actionGet();
  assertThat(statusResponse.getIndex("test").getDocs().getNumDocs(),equalTo(3l));
  assertThat(client.prepareGet("test","type1","1").execute().actionGet().isExists(),equalTo(false));
}
