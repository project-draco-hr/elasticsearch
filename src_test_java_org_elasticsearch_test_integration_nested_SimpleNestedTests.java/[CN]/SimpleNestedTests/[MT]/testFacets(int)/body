{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",numberOfShards)).addMapping("type1",jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("nested1").field("type","nested").startObject("properties").startObject("nested2").field("type","nested").endObject().endObject().endObject().endObject().endObject().endObject()).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  client.prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("field","value").startArray("nested1").startObject().field("field1_1","1").startArray("nested2").startObject().field("field2_1","blue").field("field2_2",5).endObject().startObject().field("field2_1","yellow").field("field2_2",3).endObject().endArray().endObject().startObject().field("field1_1","4").startArray("nested2").startObject().field("field2_1","green").field("field2_2",6).endObject().startObject().field("field2_1","blue").field("field2_2",1).endObject().endArray().endObject().endArray().endObject()).execute().actionGet();
  client.prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().field("field","value").startArray("nested1").startObject().field("field1_1","2").startArray("nested2").startObject().field("field2_1","yellow").field("field2_2",10).endObject().startObject().field("field2_1","green").field("field2_2",8).endObject().endArray().endObject().startObject().field("field1_1","1").startArray("nested2").startObject().field("field2_1","blue").field("field2_2",2).endObject().startObject().field("field2_1","red").field("field2_2",12).endObject().endArray().endObject().endArray().endObject()).execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch("test").setQuery(matchAllQuery()).addFacet(FacetBuilders.termsStatsFacet("facet1").keyField("nested1.nested2.field2_1").valueField("nested1.nested2.field2_2").nested("nested1.nested2")).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  TermsStatsFacet termsStatsFacet=searchResponse.getFacets().facet("facet1");
  assertThat(termsStatsFacet.getEntries().size(),equalTo(4));
  assertThat(termsStatsFacet.getEntries().get(0).getTerm().string(),equalTo("blue"));
  assertThat(termsStatsFacet.getEntries().get(0).getCount(),equalTo(3l));
  assertThat(termsStatsFacet.getEntries().get(0).getTotal(),equalTo(8d));
  assertThat(termsStatsFacet.getEntries().get(1).getTerm().string(),equalTo("yellow"));
  assertThat(termsStatsFacet.getEntries().get(1).getCount(),equalTo(2l));
  assertThat(termsStatsFacet.getEntries().get(1).getTotal(),equalTo(13d));
  assertThat(termsStatsFacet.getEntries().get(2).getTerm().string(),equalTo("green"));
  assertThat(termsStatsFacet.getEntries().get(2).getCount(),equalTo(2l));
  assertThat(termsStatsFacet.getEntries().get(2).getTotal(),equalTo(14d));
  assertThat(termsStatsFacet.getEntries().get(3).getTerm().string(),equalTo("red"));
  assertThat(termsStatsFacet.getEntries().get(3).getCount(),equalTo(1l));
  assertThat(termsStatsFacet.getEntries().get(3).getTotal(),equalTo(12d));
  searchResponse=client.prepareSearch("test").setQuery(nestedQuery("nested1.nested2",termQuery("nested1.nested2.field2_1","blue"))).addFacet(FacetBuilders.termsStatsFacet("facet1").keyField("nested1.nested2.field2_1").valueField("nested1.nested2.field2_2").nested("nested1.nested2").facetFilter(nestedFilter("nested1.nested2",termFilter("nested1.nested2.field2_1","blue")).join(false))).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  termsStatsFacet=searchResponse.getFacets().facet("facet1");
  assertThat(termsStatsFacet.getEntries().size(),equalTo(1));
  assertThat(termsStatsFacet.getEntries().get(0).getTerm().string(),equalTo("blue"));
  assertThat(termsStatsFacet.getEntries().get(0).getCount(),equalTo(3l));
  assertThat(termsStatsFacet.getEntries().get(0).getTotal(),equalTo(8d));
  searchResponse=client.prepareSearch("test").setQuery(nestedQuery("nested1.nested2",termQuery("nested1.nested2.field2_1","blue"))).addFacet(FacetBuilders.filterFacet("facet1").global(true).filter(rangeFilter("nested1.nested2.field2_2").gte(0).lte(2)).nested("nested1.nested2").facetFilter(nestedFilter("nested1.nested2",termFilter("nested1.nested2.field2_1","blue")).join(false))).execute().actionGet();
  assertThat(Arrays.toString(searchResponse.getShardFailures()),searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(2l));
  FilterFacet filterFacet=searchResponse.getFacets().facet("facet1");
  assertThat(filterFacet.getCount(),equalTo(2l));
  assertThat(filterFacet.getName(),equalTo("facet1"));
}
