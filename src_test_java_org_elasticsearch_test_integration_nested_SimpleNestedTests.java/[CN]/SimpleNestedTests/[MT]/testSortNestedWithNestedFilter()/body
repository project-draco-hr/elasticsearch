{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1).put("index.number_of_replicas",0)).addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("grand_parent_values").field("type","long").endObject().startObject("parent").field("type","nested").startObject("properties").startObject("parent_values").field("type","long").endObject().startObject("child").field("type","nested").startObject("properties").startObject("child_values").field("type","long").endObject().endObject().endObject().endObject().endObject().endObject().endObject().endObject()).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  client.prepareIndex("test","type1",Integer.toString(1)).setSource(jsonBuilder().startObject().field("grand_parent_values",1l).startObject("parent").field("filter",false).field("parent_values",1l).startObject("child").field("filter",true).field("child_values",1l).startObject("child_obj").field("value",1l).endObject().endObject().startObject("child").field("filter",false).field("child_values",6l).endObject().endObject().startObject("parent").field("filter",true).field("parent_values",2l).startObject("child").field("filter",false).field("child_values",-1l).endObject().startObject("child").field("filter",false).field("child_values",5l).endObject().endObject().endObject()).execute().actionGet();
  client.prepareIndex("test","type1",Integer.toString(2)).setSource(jsonBuilder().startObject().field("grand_parent_values",2l).startObject("parent").field("filter",false).field("parent_values",2l).startObject("child").field("filter",true).field("child_values",2l).startObject("child_obj").field("value",2l).endObject().endObject().startObject("child").field("filter",false).field("child_values",4l).endObject().endObject().startObject("parent").field("parent_values",3l).field("filter",true).startObject("child").field("child_values",-2l).field("filter",false).endObject().startObject("child").field("filter",false).field("child_values",3l).endObject().endObject().endObject()).execute().actionGet();
  client.prepareIndex("test","type1",Integer.toString(3)).setSource(jsonBuilder().startObject().field("grand_parent_values",3l).startObject("parent").field("parent_values",3l).field("filter",false).startObject("child").field("filter",true).field("child_values",3l).startObject("child_obj").field("value",3l).endObject().endObject().startObject("child").field("filter",false).field("child_values",1l).endObject().endObject().startObject("parent").field("parent_values",4l).field("filter",true).startObject("child").field("filter",false).field("child_values",-3l).endObject().startObject("child").field("filter",false).field("child_values",1l).endObject().endObject().endObject()).execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("-3"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("-2"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("-1"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").setNestedFilter(FilterBuilders.termFilter("parent.child.filter",true)).order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("3"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedFilter(FilterBuilders.termFilter("parent.child.filter",true)).order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("3"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.parent_values").setNestedPath("parent.child").setNestedFilter(FilterBuilders.termFilter("parent.filter",false)).order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("3"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").setNestedFilter(FilterBuilders.termFilter("parent.filter",false)).order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_obj.value").setNestedFilter(FilterBuilders.termFilter("parent.child.filter",true)).order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("3"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").sortMode("sum").order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("7"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("11"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").sortMode("sum").order(SortOrder.DESC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("11"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("7"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("2"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").setNestedFilter(FilterBuilders.termFilter("parent.child.filter",true)).sortMode("sum").order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("3"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").sortMode("avg").order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("0"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("2"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").sortMode("avg").order(SortOrder.DESC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("0"));
  searchResponse=client.prepareSearch().setQuery(matchAllQuery()).addSort(SortBuilders.fieldSort("parent.child.child_values").setNestedPath("parent.child").setNestedFilter(FilterBuilders.termFilter("parent.child.filter",true)).sortMode("avg").order(SortOrder.ASC)).execute().actionGet();
  assertThat(searchResponse.getHits().totalHits(),equalTo(3l));
  assertThat(searchResponse.getHits().getHits().length,equalTo(3));
  assertThat(searchResponse.getHits().getHits()[0].getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[0].sortValues()[0].toString(),equalTo("1"));
  assertThat(searchResponse.getHits().getHits()[1].getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[1].sortValues()[0].toString(),equalTo("2"));
  assertThat(searchResponse.getHits().getHits()[2].getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getHits()[2].sortValues()[0].toString(),equalTo("3"));
}
