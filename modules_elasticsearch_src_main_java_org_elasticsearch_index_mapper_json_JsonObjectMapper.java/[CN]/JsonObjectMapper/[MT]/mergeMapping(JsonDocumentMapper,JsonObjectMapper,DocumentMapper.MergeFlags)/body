{
synchronized (mutex) {
    for (    JsonMapper mapper : mergeWith.mappers.values()) {
      if (mapper instanceof JsonObjectMapper) {
        JsonObjectMapper mergeWithMapper=(JsonObjectMapper)mapper;
        JsonMapper mergeIntoMapper=mappers.get(mergeWithMapper.name());
        if (mergeIntoMapper != null) {
          if (!(mergeIntoMapper instanceof JsonObjectMapper)) {
            throw new MergeMappingException("Can't merge an object mapping [" + mergeWithMapper.name() + "] into a non object mapper");
          }
          ((JsonObjectMapper)mergeIntoMapper).mergeMapping(docMapper,mergeWithMapper,mergeFlags);
        }
 else {
          if (!mergeFlags.simulate()) {
            putMapper(mergeWithMapper);
          }
        }
      }
 else {
        JsonFieldMapper mergeWithMapper=(JsonFieldMapper)mapper;
        JsonFieldMapper mergeIntoMapper=(JsonFieldMapper)mappers.get(mergeWithMapper.name());
        if (mergeIntoMapper != null) {
          mergeIntoMapper.merge(mergeWithMapper,mergeFlags);
        }
 else {
          if (!mergeFlags.simulate()) {
            putMapper(mergeWithMapper);
            docMapper.addFieldMapper(mergeWithMapper);
          }
        }
      }
    }
  }
}
