{
  int numberOfShards=5;
  Node node=NodeBuilder.nodeBuilder().local(true).loadConfigSettings(false).clusterName("testCluster").settings(ImmutableSettings.settingsBuilder().put("node.name","node1").put("index.number_of_shards",numberOfShards).build()).node();
  Node node2=NodeBuilder.nodeBuilder().local(true).loadConfigSettings(false).clusterName("testCluster").settings(ImmutableSettings.settingsBuilder().put("node.name","node2").put("index.number_of_shards",numberOfShards).build()).node();
  Client client=node.client();
  for (int loop=1; loop < 1000; loop++) {
    String indexName="testindex" + loop;
    String typeName="testType" + loop;
    String id=UUID.randomUUID().toString();
    String mapping="{ \"" + typeName + "\" :  {\"dynamic_templates\" : [{\"no_analyze_strings\" : {\"match_mapping_type\" : \"string\",\"match\" : \"*\",\"mapping\" : {\"type\" : \"string\",\"index\" : \"not_analyzed\"}}}]}}";
    client.admin().indices().prepareCreate(indexName).execute().actionGet();
    client.admin().indices().preparePutMapping(indexName).setType(typeName).setSource(mapping).execute().actionGet();
    System.out.println("indexing " + loop);
    String name="name" + id;
    client.prepareIndex(indexName,typeName,id).setSource("{ \"id\": \"" + id + "\", \"name\": \""+ name+ "\" }").execute().actionGet();
    client.admin().indices().prepareRefresh(indexName).execute().actionGet();
    System.out.println("searching " + loop);
    SearchResponse result=client.prepareSearch(indexName).setPostFilter(QueryBuilders.termQuery("name",name)).execute().actionGet();
    if (result.getHits().hits().length != 1) {
      for (int i=1; i <= 100; i++) {
        System.out.println("retry " + loop + ", "+ i+ ", previous total hits: "+ result.getHits().getTotalHits());
        client.admin().indices().prepareRefresh(indexName).execute().actionGet();
        Thread.sleep(100);
        result=client.prepareSearch(indexName).setPostFilter(QueryBuilders.termQuery("name",name)).execute().actionGet();
        if (result.getHits().hits().length == 1) {
          client.admin().indices().prepareRefresh(indexName).execute().actionGet();
          result=client.prepareSearch(indexName).setPostFilter(QueryBuilders.termQuery("name",name)).execute().actionGet();
          throw new RuntimeException("Record found after " + (i * 100) + " ms, second go: "+ result.getHits().hits().length);
        }
 else         if (i == 100) {
          if (client.prepareGet(indexName,typeName,id).execute().actionGet().isExists())           throw new RuntimeException("Record wasn't found after 10s but can be get by id");
 else           throw new RuntimeException("Record wasn't found after 10s and can't be get by id");
        }
      }
    }
  }
  client.close();
  node2.close();
  node.close();
}
