{
  client().admin().indices().prepareCreate("test").addMapping("type1",XContentFactory.jsonBuilder().startObject().startObject("type1").startObject("_timestamp").field("enabled",true).field("store","yes").endObject().startObject("_ttl").field("enabled",true).field("store","yes").endObject().endObject().endObject()).addMapping("type2",XContentFactory.jsonBuilder().startObject().startObject("type2").startObject("_timestamp").field("enabled",true).field("store","yes").endObject().startObject("_ttl").field("enabled",true).field("store","yes").field("default","1d").endObject().endObject().endObject()).execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  long providedTTLValue=3000;
  logger.info("--> checking ttl");
  client().prepareIndex("test","type1","1").setSource("field1","value1").setTTL(providedTTLValue).setRefresh(true).execute().actionGet();
  long now=System.currentTimeMillis();
  client().prepareIndex("test","type1","with_routing").setSource("field1","value1").setTTL(providedTTLValue).setRouting("routing").setRefresh(true).execute().actionGet();
  client().prepareIndex("test","type1","no_ttl").setSource("field1","value1").execute().actionGet();
  client().prepareIndex("test","type2","default_ttl").setSource("field1","value1").execute().actionGet();
  long currentTime=System.currentTimeMillis();
  GetResponse getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(true).execute().actionGet();
  long ttl0;
  if (getResponse.isExists()) {
    ttl0=((Number)getResponse.getField("_ttl").getValue()).longValue();
    assertThat(ttl0,greaterThan(-PURGE_INTERVAL));
    assertThat(ttl0,lessThan(providedTTLValue - (currentTime - now)));
  }
 else {
    assertThat(providedTTLValue - (currentTime - now),lessThan(0l));
  }
  currentTime=System.currentTimeMillis();
  getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(true).execute().actionGet();
  if (getResponse.isExists()) {
    ttl0=((Number)getResponse.getField("_ttl").getValue()).longValue();
    assertThat(ttl0,greaterThan(-PURGE_INTERVAL));
    assertThat(ttl0,lessThan(providedTTLValue - (currentTime - now)));
  }
 else {
    assertThat(providedTTLValue - (currentTime - now),lessThan(0l));
  }
  currentTime=System.currentTimeMillis();
  getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(false).execute().actionGet();
  if (getResponse.isExists()) {
    ttl0=((Number)getResponse.getField("_ttl").getValue()).longValue();
    assertThat(ttl0,greaterThan(-PURGE_INTERVAL));
    assertThat(ttl0,lessThan(providedTTLValue - (currentTime - now)));
  }
 else {
    assertThat(providedTTLValue - (currentTime - now),lessThan(0l));
  }
  currentTime=System.currentTimeMillis();
  getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(false).execute().actionGet();
  if (getResponse.isExists()) {
    ttl0=((Number)getResponse.getField("_ttl").getValue()).longValue();
    assertThat(ttl0,greaterThan(-PURGE_INTERVAL));
    assertThat(ttl0,lessThan(providedTTLValue - (currentTime - now)));
  }
 else {
    assertThat(providedTTLValue - (currentTime - now),lessThan(0l));
  }
  getResponse=client().prepareGet("test","type1","no_ttl").setFields("_ttl").setRealtime(true).execute().actionGet();
  assertThat(getResponse.getField("_ttl"),nullValue());
  getResponse=client().prepareGet("test","type2","default_ttl").setFields("_ttl").setRealtime(true).execute().actionGet();
  ttl0=((Number)getResponse.getField("_ttl").getValue()).longValue();
  assertThat(ttl0,greaterThan(0L));
  long shouldBeExpiredDate=now + providedTTLValue + PURGE_INTERVAL+ 2000;
  currentTime=System.currentTimeMillis();
  if (shouldBeExpiredDate - currentTime > 0) {
    Thread.sleep(shouldBeExpiredDate - currentTime);
  }
  logger.info("--> checking purger");
  long currentDeleteCount;
  do {
    if (rarely()) {
      client().admin().indices().prepareFlush("test").setFull(true).execute().actionGet();
    }
 else     if (rarely()) {
      client().admin().indices().prepareOptimize("test").setMaxNumSegments(1).execute().actionGet();
    }
    IndicesStatsResponse response=client().admin().indices().prepareStats("test").clear().setIndexing(true).execute().actionGet();
    currentDeleteCount=response.getIndices().get("test").getTotal().getIndexing().getTotal().getDeleteCount();
  }
 while (currentDeleteCount < 4);
  assertThat(currentDeleteCount,equalTo(4l));
  getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(true).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet("test","type1","with_routing").setRouting("routing").setFields("_ttl").setRealtime(true).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(true).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet("test","type1","with_routing").setRouting("routing").setFields("_ttl").setRealtime(true).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(false).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet("test","type1","with_routing").setRouting("routing").setFields("_ttl").setRealtime(false).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet("test","type1","1").setFields("_ttl").setRealtime(false).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet("test","type1","with_routing").setRouting("routing").setFields("_ttl").setRealtime(false).execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
}
