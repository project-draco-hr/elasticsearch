{
  this.metaData=clusterState.metaData();
  this.blocks=clusterState.blocks();
  this.routingTable=clusterState.routingTable();
  Map<String,List<MutableShardRouting>> nodesToShards=newHashMap();
  for (  DiscoveryNode node : clusterState.nodes().dataNodes().values()) {
    nodesToShards.put(node.id(),new ArrayList<MutableShardRouting>());
  }
  for (  IndexRoutingTable indexRoutingTable : routingTable.indicesRouting().values()) {
    for (    IndexShardRoutingTable indexShard : indexRoutingTable) {
      for (      ShardRouting shard : indexShard) {
        if (shard.assignedToNode()) {
          List<MutableShardRouting> entries=nodesToShards.get(shard.currentNodeId());
          if (entries == null) {
            entries=newArrayList();
            nodesToShards.put(shard.currentNodeId(),entries);
          }
          entries.add(new MutableShardRouting(shard));
          if (shard.relocating()) {
            entries=nodesToShards.get(shard.relocatingNodeId());
            if (entries == null) {
              entries=newArrayList();
              nodesToShards.put(shard.relocatingNodeId(),entries);
            }
            entries.add(new MutableShardRouting(shard.index(),shard.id(),shard.relocatingNodeId(),shard.currentNodeId(),shard.primary(),ShardRoutingState.INITIALIZING,shard.version()));
          }
        }
 else {
          unassigned.add(new MutableShardRouting(shard));
        }
      }
    }
  }
  for (  Map.Entry<String,List<MutableShardRouting>> entry : nodesToShards.entrySet()) {
    String nodeId=entry.getKey();
    this.nodesToShards.put(nodeId,new RoutingNode(nodeId,clusterState.nodes().get(nodeId),entry.getValue()));
  }
}
