{
  if (scrollContext == null) {
    long from=from() == -1 ? 0 : from();
    long size=size() == -1 ? 10 : size();
    long resultWindow=from + size;
    int maxResultWindow=indexService.getIndexSettings().getSettings().getAsInt(MAX_RESULT_WINDOW,Defaults.MAX_RESULT_WINDOW);
    if (resultWindow > maxResultWindow) {
      throw new QueryPhaseExecutionException(this,"Result window is too large, from + size must be less than or equal to: [" + maxResultWindow + "] but was ["+ resultWindow+ "]. See the scroll api for a more efficient way to request large data sets. "+ "This limit can be set by changing the ["+ DefaultSearchContext.MAX_RESULT_WINDOW+ "] index level parameter.");
    }
  }
  aliasFilter=indexService.aliasFilter(indexShard.getQueryShardContext(),request.filteringAliases());
  if (query() == null) {
    parsedQuery(ParsedQuery.parsedMatchAllQuery());
  }
  if (queryBoost() != AbstractQueryBuilder.DEFAULT_BOOST) {
    parsedQuery(new ParsedQuery(new FunctionScoreQuery(query(),new WeightFactorFunction(queryBoost)),parsedQuery()));
  }
  filteredQuery(buildFilteredQuery());
  try {
    this.query=searcher().rewrite(this.query);
  }
 catch (  IOException e) {
    throw new QueryPhaseExecutionException(this,"Failed to rewrite main query",e);
  }
}
