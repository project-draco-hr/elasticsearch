{
  String ipField=readStringProperty(config,"source_field");
  String targetField=readStringProperty(config,"target_field","geoip");
  String databaseFile=readStringProperty(config,"database_file","GeoLite2-City.mmdb");
  final Set<Field> fields;
  if (config.containsKey("fields")) {
    fields=EnumSet.noneOf(Field.class);
    List<String> fieldNames=readList(config,"fields");
    for (    String fieldName : fieldNames) {
      try {
        fields.add(Field.parse(fieldName));
      }
 catch (      Exception e) {
        throw new IllegalArgumentException("illegal field option [" + fieldName + "]. valid values are ["+ Arrays.toString(Field.values())+ "]",e);
      }
    }
  }
 else {
    fields=DEFAULT_FIELDS;
  }
  Path databasePath=geoIpConfigDirectory.resolve(databaseFile);
  if (Files.exists(databasePath) && Files.isRegularFile(databasePath)) {
    try (InputStream database=Files.newInputStream(databasePath,StandardOpenOption.READ)){
      DatabaseReader databaseReader=databaseReaderService.getOrCreateDatabaseReader(databaseFile,database);
      return new GeoIpProcessor(ipField,databaseReader,targetField,fields);
    }
   }
 else {
    throw new IllegalArgumentException("database file [" + databaseFile + "] doesn't exist in ["+ geoIpConfigDirectory+ "]");
  }
}
