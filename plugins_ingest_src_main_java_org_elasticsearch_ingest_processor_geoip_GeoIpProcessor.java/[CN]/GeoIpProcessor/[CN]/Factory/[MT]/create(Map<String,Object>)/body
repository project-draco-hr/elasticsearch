{
  String ipField=(String)config.get("ip_field");
  String targetField=(String)config.get("target_field");
  if (targetField == null) {
    targetField="geoip";
  }
  String databaseFile=(String)config.get("database_file");
  if (databaseFile == null) {
    databaseFile="GeoLite2-City.mmdb";
  }
  Path databasePath=geoIpConfigDirectory.resolve(databaseFile);
  if (Files.exists(databasePath)) {
    try (InputStream database=Files.newInputStream(databasePath,StandardOpenOption.READ)){
      DatabaseReader databaseReader=databaseReaderService.getOrCreateDatabaseReader(databaseFile,database);
      return new GeoIpProcessor(ipField,databaseReader,targetField);
    }
   }
 else {
    throw new IllegalArgumentException("database file [" + databaseFile + "] doesn't exist in ["+ geoIpConfigDirectory+ "]");
  }
}
