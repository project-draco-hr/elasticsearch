{
  DocIdSorter sorter=new DocIdSorter();
  sorter.array=primary.scoreDocs;
  sorter.sort(0,sorter.array.length);
  ScoreDoc[] primaryDocs=sorter.array;
  sorter.array=secondary.scoreDocs;
  sorter.sort(0,sorter.array.length);
  ScoreDoc[] secondaryDocs=sorter.array;
  int j=0;
  float primaryWeight=context.queryWeight();
  float secondaryWeight=context.rescoreQueryWeight();
  ScoreMode scoreMode=context.scoreMode();
  for (int i=0; i < primaryDocs.length; i++) {
    if (j < secondaryDocs.length && primaryDocs[i].doc == secondaryDocs[j].doc) {
      primaryDocs[i].score=scoreMode.combine(primaryDocs[i].score * primaryWeight,secondaryDocs[j++].score * secondaryWeight);
    }
 else {
      primaryDocs[i].score*=primaryWeight;
    }
  }
  ScoreSorter scoreSorter=new ScoreSorter();
  scoreSorter.array=primaryDocs;
  scoreSorter.sort(0,primaryDocs.length);
  primary.setMaxScore(primaryDocs[0].score);
  return primary;
}
