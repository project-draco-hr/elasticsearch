{
  String pluginName="fake-plugin";
  Path pluginDir=createTempDir().resolve(pluginName);
  Files.createDirectories(pluginDir.resolve("config"));
  Files.write(pluginDir.resolve("config").resolve("test.txt"),"version1".getBytes(StandardCharsets.UTF_8));
  String pluginUrl=createPlugin(pluginDir,"description","fake desc","version","1.0","elasticsearch.version",Version.CURRENT.toString(),"java.version",System.getProperty("java.specification.version"),"jvm","true","classname","FakePlugin");
  Environment env=initialSettings.v2();
  Path pluginConfigDir=env.configFile().resolve(pluginName);
  assertStatusOk(String.format(Locale.ROOT,"install %s --url %s --verbose",pluginName,pluginUrl));
  assertFileContent(pluginConfigDir,"test.txt","version1");
  assertStatusOk("remove " + pluginName);
  assertFileContent(pluginConfigDir,"test.txt","version1");
  Files.write(pluginDir.resolve("config").resolve("test.txt"),"version2".getBytes(StandardCharsets.UTF_8));
  Files.createDirectories(pluginDir.resolve("config").resolve("dir").resolve("subdir"));
  Files.write(pluginDir.resolve("config").resolve("dir").resolve("testdir.txt"),"version1".getBytes(StandardCharsets.UTF_8));
  Files.write(pluginDir.resolve("config").resolve("dir").resolve("subdir").resolve("testsubdir.txt"),"version1".getBytes(StandardCharsets.UTF_8));
  pluginUrl=createPlugin(pluginDir,"description","fake desc","version","2.0","elasticsearch.version",Version.CURRENT.toString(),"java.version",System.getProperty("java.specification.version"),"jvm","true","classname","FakePlugin");
  assertStatusOk(String.format(Locale.ROOT,"install %s --url %s --verbose",pluginName,pluginUrl));
  assertFileContent(pluginConfigDir,"test.txt","version1");
  assertFileContent(pluginConfigDir,"test.txt.new","version2");
  assertFileContent(pluginConfigDir,"dir/testdir.txt","version1");
  assertFileContent(pluginConfigDir,"dir/subdir/testsubdir.txt","version1");
  assertStatusOk("remove " + pluginName);
  assertFileContent(pluginConfigDir,"test.txt","version1");
  assertFileContent(pluginConfigDir,"test.txt.new","version2");
  assertFileContent(pluginConfigDir,"dir/testdir.txt","version1");
  assertFileContent(pluginConfigDir,"dir/subdir/testsubdir.txt","version1");
  Files.write(pluginDir.resolve("config").resolve("test.txt"),"version3".getBytes(StandardCharsets.UTF_8));
  Files.write(pluginDir.resolve("config").resolve("test2.txt"),"version1".getBytes(StandardCharsets.UTF_8));
  Files.write(pluginDir.resolve("config").resolve("dir").resolve("testdir.txt"),"version2".getBytes(StandardCharsets.UTF_8));
  Files.write(pluginDir.resolve("config").resolve("dir").resolve("testdir2.txt"),"version1".getBytes(StandardCharsets.UTF_8));
  Files.write(pluginDir.resolve("config").resolve("dir").resolve("subdir").resolve("testsubdir.txt"),"version2".getBytes(StandardCharsets.UTF_8));
  pluginUrl=createPlugin(pluginDir,"description","fake desc","version","3.0","elasticsearch.version",Version.CURRENT.toString(),"java.version",System.getProperty("java.specification.version"),"jvm","true","classname","FakePlugin");
  assertStatusOk(String.format(Locale.ROOT,"install %s --url %s --verbose",pluginName,pluginUrl));
  assertFileContent(pluginConfigDir,"test.txt","version1");
  assertFileContent(pluginConfigDir,"test2.txt","version1");
  assertFileContent(pluginConfigDir,"test.txt.new","version3");
  assertFileContent(pluginConfigDir,"dir/testdir.txt","version1");
  assertFileContent(pluginConfigDir,"dir/testdir.txt.new","version2");
  assertFileContent(pluginConfigDir,"dir/testdir2.txt","version1");
  assertFileContent(pluginConfigDir,"dir/subdir/testsubdir.txt","version1");
  assertFileContent(pluginConfigDir,"dir/subdir/testsubdir.txt.new","version2");
}
