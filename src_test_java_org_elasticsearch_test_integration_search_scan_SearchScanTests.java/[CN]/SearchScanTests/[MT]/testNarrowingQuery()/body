{
  try {
    client.admin().indices().prepareDelete("test").execute().actionGet();
  }
 catch (  Exception e) {
  }
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",5)).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  Set<String> ids=Sets.newHashSet();
  Set<String> expectedIds=Sets.newHashSet();
  for (int i=0; i < 100; i++) {
    expectedIds.add(Integer.toString(i));
    client.prepareIndex("test","tweet",Integer.toString(i)).setSource(jsonBuilder().startObject().field("user","kimchy1").field("postDate",System.currentTimeMillis()).field("message","test").endObject()).execute().actionGet();
  }
  for (int i=100; i < 200; i++) {
    client.prepareIndex("test","tweet",Integer.toString(i)).setSource(jsonBuilder().startObject().field("user","kimchy2").field("postDate",System.currentTimeMillis()).field("message","test").endObject()).execute().actionGet();
  }
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch().setSearchType(SearchType.SCAN).setQuery(termQuery("user","kimchy1")).setSize(35).setScroll(TimeValue.timeValueMinutes(2)).execute().actionGet();
  assertThat(searchResponse.hits().totalHits(),equalTo(100l));
  while (true) {
    searchResponse=client.prepareSearchScroll(searchResponse.scrollId()).setScroll(TimeValue.timeValueMinutes(2)).execute().actionGet();
    assertThat(searchResponse.hits().totalHits(),equalTo(100l));
    assertThat(searchResponse.failedShards(),equalTo(0));
    for (    SearchHit hit : searchResponse.hits()) {
      assertThat(hit.id() + "should not exists in the result set",ids.contains(hit.id()),equalTo(false));
      ids.add(hit.id());
    }
    if (searchResponse.hits().hits().length == 0) {
      break;
    }
  }
  assertThat(expectedIds,equalTo(ids));
}
