{
  Objects.requireNonNull(clusterStatePublisher,"please set a cluster state publisher before starting");
  add(localNodeMasterListeners);
  add(taskManager);
  this.clusterState=ClusterState.builder(clusterState).blocks(initialBlocks).build();
  this.updateTasksExecutor=EsExecutors.newSinglePrioritizing(UPDATE_THREAD_NAME,daemonThreadFactory(settings,UPDATE_THREAD_NAME),threadPool.getThreadContext());
  this.reconnectToNodes=threadPool.schedule(reconnectInterval,ThreadPool.Names.GENERIC,new ReconnectToNodes());
  Map<String,String> nodeAttributes=discoveryNodeService.buildAttributes();
  final String nodeId=generateNodeId(settings);
  final TransportAddress publishAddress=transportService.boundAddress().publishAddress();
  DiscoveryNode localNode=new DiscoveryNode(settings.get("node.name"),nodeId,publishAddress,nodeAttributes,version);
  DiscoveryNodes.Builder nodeBuilder=DiscoveryNodes.builder().put(localNode).localNodeId(localNode.id());
  this.clusterState=ClusterState.builder(clusterState).nodes(nodeBuilder).blocks(initialBlocks).build();
  this.transportService.setLocalNode(localNode);
}
