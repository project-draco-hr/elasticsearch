{
  XContentBuilder mapping=jsonBuilder();
  mapping.startObject().startObject("type").startObject("properties").startObject("location").field("type","geo_point").endObject().endObject().endObject().endObject();
  IndexService indexService=createIndex("testidx",Settings.settingsBuilder().build(),"type",mapping);
  TestSearchContext context=(TestSearchContext)createSearchContext(indexService);
  context.getQueryShardContext().setTypes("type");
  XContentBuilder sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.startArray("location");
  sortBuilder.startArray().value(1.2).value(3).endArray().startArray().value(5).value(6).endArray();
  sortBuilder.endArray();
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  XContentParser parser=XContentHelper.createParser(sortBuilder.bytes());
  parser.nextToken();
  GeoDistanceSortParser geoParser=new GeoDistanceSortParser();
  geoParser.parse(parser,context);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.startArray("location");
  sortBuilder.value(new GeoPoint(1.2,3)).value(new GeoPoint(1.2,3));
  sortBuilder.endArray();
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.startArray("location");
  sortBuilder.value("1,2").value("3,4");
  sortBuilder.endArray();
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.startArray("location");
  sortBuilder.value("s3y0zh7w1z0g").value("s6wjr4et3f8v");
  sortBuilder.endArray();
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.startArray("location");
  sortBuilder.value(1.2).value(3);
  sortBuilder.endArray();
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.field("location",new GeoPoint(1,2));
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.field("location","1,2");
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.field("location","s3y0zh7w1z0g");
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
  sortBuilder=jsonBuilder();
  sortBuilder.startObject();
  sortBuilder.startArray("location");
  sortBuilder.value(new GeoPoint(1,2)).value("s3y0zh7w1z0g").startArray().value(1).value(2).endArray().value("1,2");
  sortBuilder.endArray();
  sortBuilder.field("order","desc");
  sortBuilder.field("unit","km");
  sortBuilder.field("sort_mode","max");
  sortBuilder.endObject();
  parse(context,sortBuilder);
}
