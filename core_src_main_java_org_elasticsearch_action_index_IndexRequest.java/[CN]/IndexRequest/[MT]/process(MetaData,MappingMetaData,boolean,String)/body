{
  routing(metaData.resolveIndexRouting(parent,routing,index));
  if (timestamp != null) {
    timestamp=MappingMetaData.Timestamp.parseStringTimestamp(timestamp,mappingMd != null ? mappingMd.timestamp().dateTimeFormatter() : TimestampFieldMapper.Defaults.DATE_TIME_FORMATTER,getVersion(metaData,concreteIndex));
  }
  if (mappingMd != null) {
    if (mappingMd.routing().required() && routing == null) {
      throw new RoutingMissingException(concreteIndex,type,id);
    }
    if (parent != null && !mappingMd.hasParentField()) {
      throw new IllegalArgumentException("Can't specify parent if no parent field has been configured");
    }
  }
 else {
    if (parent != null) {
      throw new IllegalArgumentException("Can't specify parent if no parent field has been configured");
    }
  }
  if (allowIdGeneration) {
    if (id == null) {
      id(Strings.base64UUID());
    }
  }
  if (timestamp == null) {
    String defaultTimestamp=TimestampFieldMapper.Defaults.DEFAULT_TIMESTAMP;
    if (mappingMd != null && mappingMd.timestamp() != null) {
      if (mappingMd.timestamp().ignoreMissing() != null && mappingMd.timestamp().ignoreMissing() == false) {
        throw new TimestampParsingException("timestamp is required by mapping");
      }
      defaultTimestamp=mappingMd.timestamp().defaultTimestamp();
    }
    if (defaultTimestamp.equals(TimestampFieldMapper.Defaults.DEFAULT_TIMESTAMP)) {
      timestamp=Long.toString(System.currentTimeMillis());
    }
 else {
      timestamp=MappingMetaData.Timestamp.parseStringTimestamp(defaultTimestamp,mappingMd.timestamp().dateTimeFormatter(),getVersion(metaData,concreteIndex));
    }
  }
}
