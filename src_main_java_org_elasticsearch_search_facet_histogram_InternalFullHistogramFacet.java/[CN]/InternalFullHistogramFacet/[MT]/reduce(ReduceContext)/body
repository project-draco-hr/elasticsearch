{
  List<Facet> facets=context.facets();
  if (facets.size() == 1) {
    InternalFullHistogramFacet internalFacet=(InternalFullHistogramFacet)facets.get(0);
    List<FullEntry> entries=internalFacet.getEntries();
    CollectionUtil.timSort(entries,comparatorType.comparator());
    return internalFacet;
  }
  Recycler.V<ExtTLongObjectHashMap<FullEntry>> map=context.cacheRecycler().longObjectMap(-1);
  for (  Facet facet : facets) {
    InternalFullHistogramFacet histoFacet=(InternalFullHistogramFacet)facet;
    for (    FullEntry fullEntry : histoFacet.entries) {
      FullEntry current=map.v().get(fullEntry.key);
      if (current != null) {
        current.count+=fullEntry.count;
        current.total+=fullEntry.total;
        current.totalCount+=fullEntry.totalCount;
        if (fullEntry.min < current.min) {
          current.min=fullEntry.min;
        }
        if (fullEntry.max > current.max) {
          current.max=fullEntry.max;
        }
      }
 else {
        map.v().put(fullEntry.key,fullEntry);
      }
    }
  }
  Object[] values=map.v().internalValues();
  Arrays.sort(values,(Comparator)comparatorType.comparator());
  List<FullEntry> ordered=new ArrayList<FullEntry>(map.v().size());
  for (int i=0; i < map.v().size(); i++) {
    FullEntry value=(FullEntry)values[i];
    if (value == null) {
      break;
    }
    ordered.add(value);
  }
  map.release();
  InternalFullHistogramFacet ret=new InternalFullHistogramFacet(getName());
  ret.comparatorType=comparatorType;
  ret.entries=ordered;
  return ret;
}
