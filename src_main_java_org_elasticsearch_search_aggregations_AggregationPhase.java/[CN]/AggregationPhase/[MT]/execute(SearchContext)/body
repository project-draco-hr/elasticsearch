{
  if (context.aggregations() == null) {
    context.queryResult().aggregations(null);
    return;
  }
  if (context.queryResult().aggregations() != null) {
    return;
  }
  Aggregator[] aggregators=context.aggregations().aggregators();
  List<Aggregator> globals=new ArrayList<>();
  for (int i=0; i < aggregators.length; i++) {
    if (aggregators[i] instanceof GlobalAggregator) {
      globals.add(aggregators[i]);
    }
  }
  if (!globals.isEmpty()) {
    BucketCollector globalsCollector=BucketCollector.wrap(globals);
    Query query=new ConstantScoreQuery(Queries.MATCH_ALL_FILTER);
    Filter searchFilter=context.searchFilter(context.types());
    if (searchFilter != null) {
      query=new FilteredQuery(query,searchFilter);
    }
    try {
      globalsCollector.preCollection();
      context.searcher().search(query,globalsCollector);
    }
 catch (    Exception e) {
      throw new QueryPhaseExecutionException(context,"Failed to execute global aggregators",e);
    }
  }
  List<InternalAggregation> aggregations=new ArrayList<>(aggregators.length);
  for (  Aggregator aggregator : context.aggregations().aggregators()) {
    try {
      aggregator.postCollection();
      aggregations.add(aggregator.buildAggregation(0));
    }
 catch (    IOException e) {
      throw new AggregationExecutionException("Failed to build aggregation [" + aggregator.name() + "]",e);
    }
  }
  context.queryResult().aggregations(new InternalAggregations(aggregations));
  try {
    List<Reducer> reducers=context.aggregations().factories().createReducers();
    List<SiblingReducer> siblingReducers=new ArrayList<>(reducers.size());
    for (    Reducer reducer : reducers) {
      if (reducer instanceof SiblingReducer) {
        siblingReducers.add((SiblingReducer)reducer);
      }
 else {
        throw new AggregationExecutionException("Invalid reducer named [" + reducer.name() + "] of type ["+ reducer.type().name()+ "]. Only sibling reducers are allowed at the top level");
      }
    }
    context.queryResult().reducers(siblingReducers);
  }
 catch (  IOException e) {
    throw new AggregationExecutionException("Failed to build top level reducers",e);
  }
  context.aggregations(null);
  context.searcher().queryCollectors().remove(AggregationPhase.class);
}
