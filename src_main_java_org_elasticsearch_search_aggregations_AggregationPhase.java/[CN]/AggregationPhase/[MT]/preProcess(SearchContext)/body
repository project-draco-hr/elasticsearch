{
  if (context.aggregations() != null) {
    AggregationContext aggregationContext=new AggregationContext(context);
    context.aggregations().aggregationContext(aggregationContext);
    List<Aggregator> collectors=new ArrayList<Aggregator>();
    Aggregator[] aggregators=context.aggregations().factories().createTopLevelAggregators(aggregationContext);
    for (int i=0; i < aggregators.length; i++) {
      if (!(aggregators[i] instanceof GlobalAggregator)) {
        Aggregator aggregator=aggregators[i];
        if (aggregator.shouldCollect()) {
          collectors.add(aggregator);
        }
      }
    }
    context.aggregations().aggregators(aggregators);
    if (!collectors.isEmpty()) {
      context.searcher().addMainQueryCollector(new AggregationsCollector(collectors,aggregationContext));
    }
  }
}
