{
  InternalIndexShard shard=(InternalIndexShard)indicesService.indexServiceSafe(request.shardId().index().name()).shardSafe(request.shardId().id());
  RecoveryStatus onGoingRecovery=onGoingRecoveries.get(shard.shardId());
  if (onGoingRecovery == null) {
    throw new IndexShardClosedException(shard.shardId());
  }
  if (onGoingRecovery.canceled) {
    onGoingRecovery.sentCanceledToSource=true;
    throw new IndexShardClosedException(shard.shardId());
  }
  IndexOutput indexOutput;
  if (request.position() == 0) {
    onGoingRecovery.checksums.remove(request.name());
    indexOutput=onGoingRecovery.openIndexOutputs.remove(request.name());
    if (indexOutput != null) {
      try {
        indexOutput.close();
      }
 catch (      IOException e) {
      }
    }
    String name=request.name();
    if (shard.store().directory().fileExists(name)) {
      name="recovery." + onGoingRecovery.startTime + "."+ name;
    }
    indexOutput=shard.store().createOutputRaw(name);
    onGoingRecovery.openIndexOutputs.put(request.name(),indexOutput);
  }
 else {
    indexOutput=onGoingRecovery.openIndexOutputs.get(request.name());
  }
  if (indexOutput == null) {
    throw new IndexShardClosedException(shard.shardId());
  }
synchronized (indexOutput) {
    try {
      if (recoverySettings.rateLimiter() != null) {
        recoverySettings.rateLimiter().pause(request.content().length());
      }
      indexOutput.writeBytes(request.content().bytes(),request.content().offset(),request.content().length());
      onGoingRecovery.currentFilesSize.addAndGet(request.length());
      if (indexOutput.getFilePointer() == request.length()) {
        indexOutput.close();
        if (request.checksum() != null) {
          onGoingRecovery.checksums.put(request.name(),request.checksum());
        }
        shard.store().directory().sync(Collections.singleton(request.name()));
        onGoingRecovery.openIndexOutputs.remove(request.name());
      }
    }
 catch (    IOException e) {
      onGoingRecovery.openIndexOutputs.remove(request.name());
      try {
        indexOutput.close();
      }
 catch (      IOException e1) {
      }
      throw e;
    }
  }
  channel.sendResponse(VoidStreamable.INSTANCE);
}
