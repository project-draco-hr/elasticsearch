{
  RecoveryStatus onGoingRecovery=onGoingRecoveries.get(request.recoveryId());
  if (onGoingRecovery == null) {
    throw new IndexShardClosedException(request.shardId());
  }
  if (onGoingRecovery.canceled) {
    onGoingRecovery.sentCanceledToSource=true;
    throw new IndexShardClosedException(request.shardId());
  }
  onGoingRecovery.stage=RecoveryStatus.Stage.FINALIZE;
  onGoingRecovery.indexShard.performRecoveryFinalization(false,onGoingRecovery);
  onGoingRecovery.time=System.currentTimeMillis() - onGoingRecovery.startTime;
  onGoingRecovery.stage=RecoveryStatus.Stage.DONE;
  channel.sendResponse(VoidStreamable.INSTANCE);
}
