{
  try (RecoveriesCollection.StatusRef statusRef=onGoingRecoveries.getStatusSafe(request.recoveryId(),request.shardId())){
    final RecoveryStatus recoveryStatus=statusRef.status();
    recoveryStatus.renameAllTempFiles();
    final Store store=recoveryStatus.store();
    recoveryStatus.legacyChecksums().write(store);
    Store.MetadataSnapshot sourceMetaData=request.sourceMetaSnapshot();
    try {
      store.cleanupAndVerify("recovery CleanFilesRequestHandler",sourceMetaData);
    }
 catch (    Exception ex) {
      throw new RecoveryFailedException(recoveryStatus.state(),"failed to clean after recovery",ex);
    }
    channel.sendResponse(TransportResponse.Empty.INSTANCE);
  }
 }
