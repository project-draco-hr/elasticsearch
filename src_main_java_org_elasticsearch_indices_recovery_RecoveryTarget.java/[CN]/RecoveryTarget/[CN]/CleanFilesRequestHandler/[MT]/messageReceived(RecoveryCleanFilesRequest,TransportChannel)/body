{
  try (RecoveriesCollection.StatusRef statusRef=onGoingRecoveries.getStatusSafe(request.recoveryId(),request.shardId())){
    final RecoveryStatus recoveryStatus=statusRef.status();
    recoveryStatus.state().getTranslog().totalOperations(request.totalTranslogOps());
    recoveryStatus.renameAllTempFiles();
    final Store store=recoveryStatus.store();
    recoveryStatus.legacyChecksums().write(store);
    Store.MetadataSnapshot sourceMetaData=request.sourceMetaSnapshot();
    try {
      store.cleanupAndVerify("recovery CleanFilesRequestHandler",sourceMetaData);
    }
 catch (    CorruptIndexException|IndexFormatTooNewException|IndexFormatTooOldException ex) {
      try {
        Lucene.cleanLuceneIndex(store.directory());
      }
 catch (      Throwable e) {
        logger.debug("Failed to clean lucene index",e);
        ex.addSuppressed(e);
      }
      throw new RecoveryFailedException(recoveryStatus.state(),"failed to clean after recovery",ex);
    }
catch (    Exception ex) {
      throw new RecoveryFailedException(recoveryStatus.state(),"failed to clean after recovery",ex);
    }
    channel.sendResponse(TransportResponse.Empty.INSTANCE);
  }
 }
