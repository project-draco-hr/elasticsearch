{
  final Query queryRewritten=query.rewrite(reader);
  if (queryRewritten instanceof MatchAllDocsQuery || Queries.isConstantMatchAllQuery(queryRewritten)) {
    final Query rewritten=new ConstantScoreQuery(filter);
    rewritten.setBoost(this.getBoost() * queryRewritten.getBoost());
    return rewritten;
  }
  if (queryRewritten != query) {
    final Query rewritten=new XFilteredQuery(queryRewritten,filter);
    rewritten.setBoost(this.getBoost());
    return rewritten;
  }
 else {
    return this;
  }
}
