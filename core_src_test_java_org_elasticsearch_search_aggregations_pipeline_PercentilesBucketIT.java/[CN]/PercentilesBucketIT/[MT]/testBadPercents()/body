{
  double[] badPercents={-1.0,110.0};
  try {
    client().prepareSearch("idx").addAggregation(terms("terms").field("tag").subAggregation(sum("sum").field(SINGLE_VALUED_FIELD_NAME))).addAggregation(percentilesBucket("percentiles_bucket","terms>sum").percents(badPercents)).execute().actionGet();
    fail("Illegal percent's were provided but no exception was thrown.");
  }
 catch (  SearchPhaseExecutionException exception) {
    ElasticsearchException[] rootCauses=exception.guessRootCauses();
    assertThat(rootCauses.length,equalTo(1));
    ElasticsearchException rootCause=rootCauses[0];
    assertThat(rootCause.getMessage(),containsString("must only contain non-null doubles from 0.0-100.0 inclusive"));
  }
}
