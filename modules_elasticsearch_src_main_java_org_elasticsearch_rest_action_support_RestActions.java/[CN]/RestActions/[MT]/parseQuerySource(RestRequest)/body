{
  if (request.hasContent()) {
    return request.contentAsBytes();
  }
  String source=request.param("source");
  if (source != null) {
    return Unicode.fromStringAsBytes(source);
  }
  String queryString=request.param("q");
  if (queryString == null) {
    throw new ElasticSearchIllegalArgumentException("No query to execute, not in body, and not bounded to 'q' parameter");
  }
  QueryStringQueryBuilder queryBuilder=QueryBuilders.queryString(queryString);
  queryBuilder.defaultField(request.param("df"));
  queryBuilder.analyzer(request.param("analyzer"));
  String defaultOperator=request.param("default_operator");
  if (defaultOperator != null) {
    if ("OR".equals(defaultOperator)) {
      queryBuilder.defaultOperator(QueryStringQueryBuilder.Operator.OR);
    }
 else     if ("AND".equals(defaultOperator)) {
      queryBuilder.defaultOperator(QueryStringQueryBuilder.Operator.AND);
    }
 else {
      throw new ElasticSearchIllegalArgumentException("Unsupported defaultOperator [" + defaultOperator + "], can either be [OR] or [AND]");
    }
  }
  return queryBuilder.buildAsBytes();
}
