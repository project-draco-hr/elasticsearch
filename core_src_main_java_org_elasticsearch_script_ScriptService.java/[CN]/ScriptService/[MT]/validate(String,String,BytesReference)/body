{
  validateScriptSize(id,scriptBytes.length());
  try (XContentParser parser=XContentFactory.xContent(scriptBytes).createParser(scriptBytes)){
    parser.nextToken();
    Template template=TemplateQueryBuilder.parse(scriptLang,parser,parseFieldMatcher,"params","script","template");
    if (Strings.hasLength(template.getScript())) {
      try {
        ScriptEngineService scriptEngineService=getScriptEngineServiceForLang(scriptLang);
        if (isAnyScriptContextEnabled(scriptLang,scriptEngineService,ScriptType.STORED)) {
          Object compiled=scriptEngineService.compile(id,template.getScript(),Collections.emptyMap());
          if (compiled == null) {
            throw new IllegalArgumentException("Unable to parse [" + template.getScript() + "] lang ["+ scriptLang+ "] (ScriptService.compile returned null)");
          }
        }
 else {
          logger.warn("skipping compile of script [{}], lang [{}] as all scripted operations are disabled for indexed scripts",template.getScript(),scriptLang);
        }
      }
 catch (      Exception e) {
        throw new IllegalArgumentException("Unable to parse [" + template.getScript() + "] lang ["+ scriptLang+ "]",e);
      }
    }
 else {
      throw new IllegalArgumentException("Unable to find script in : " + scriptBytes.toUtf8());
    }
  }
 catch (  IOException e) {
    throw new IllegalArgumentException("failed to parse template script",e);
  }
}
