{
  client.admin().indices().prepareCreate("test").execute().actionGet();
  client.prepareIndex("test","type1","1").setSource(jsonBuilder().startObject().field("test","value beck").field("num1",1.0f).endObject()).execute().actionGet();
  client.admin().indices().prepareFlush().execute().actionGet();
  client.prepareIndex("test","type1","2").setSource(jsonBuilder().startObject().field("test","value beck").field("num1",2.0f).endObject()).execute().actionGet();
  client.admin().indices().prepareFlush().execute().actionGet();
  client.prepareIndex("test","type1","3").setSource(jsonBuilder().startObject().field("test","value beck").field("num1",3.0f).endObject()).execute().actionGet();
  client.admin().indices().refresh(refreshRequest()).actionGet();
  logger.info("running doc['num1'].value");
  SearchResponse response=client.prepareSearch().setQuery(matchAllQuery()).addSort("num1",Order.ASC).addScriptField("sNum1","doc['num1'].value").execute().actionGet();
  assertThat(response.hits().totalHits(),equalTo(3l));
  assertThat(response.hits().getAt(0).isSourceEmpty(),equalTo(true));
  assertThat(response.hits().getAt(0).id(),equalTo("1"));
  assertThat((Double)response.hits().getAt(0).fields().get("sNum1").values().get(0),equalTo(1.0));
  assertThat(response.hits().getAt(1).id(),equalTo("2"));
  assertThat((Double)response.hits().getAt(1).fields().get("sNum1").values().get(0),equalTo(2.0));
  assertThat(response.hits().getAt(2).id(),equalTo("3"));
  assertThat((Double)response.hits().getAt(2).fields().get("sNum1").values().get(0),equalTo(3.0));
  logger.info("running doc['num1'].value * factor");
  Map<String,Object> params=MapBuilder.<String,Object>newMapBuilder().put("factor",2.0).map();
  response=client.prepareSearch().setQuery(matchAllQuery()).addSort("num1",Order.ASC).addScriptField("sNum1","doc['num1'].value * factor",params).execute().actionGet();
  assertThat(response.hits().totalHits(),equalTo(3l));
  assertThat(response.hits().getAt(0).id(),equalTo("1"));
  assertThat((Double)response.hits().getAt(0).fields().get("sNum1").values().get(0),equalTo(2.0));
  assertThat(response.hits().getAt(1).id(),equalTo("2"));
  assertThat((Double)response.hits().getAt(1).fields().get("sNum1").values().get(0),equalTo(4.0));
  assertThat(response.hits().getAt(2).id(),equalTo("3"));
  assertThat((Double)response.hits().getAt(2).fields().get("sNum1").values().get(0),equalTo(6.0));
}
