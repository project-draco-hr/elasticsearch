{
  Settings nodeSettings=Settings.builder().put("path.home",tempDir).build();
  indexSettings=Settings.builder().put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT).put(indexSettings).build();
  IndexSettings idxSettings=IndexSettingsModule.newIndexSettings(new Index("test"),indexSettings);
  AnalysisService analysisService=new AnalysisRegistry(null,new Environment(nodeSettings)).build(idxSettings);
  SimilarityService similarityService=new SimilarityService(idxSettings,Collections.emptyMap());
  IndicesModule indicesModule=new IndicesModule();
  indicesModule.registerMapper(AttachmentMapper.CONTENT_TYPE,new AttachmentMapper.TypeParser());
  MapperRegistry mapperRegistry=indicesModule.getMapperRegistry();
  return new MapperService(idxSettings,analysisService,similarityService,mapperRegistry);
}
