{
  Context ctx=Context.enter();
  try {
    ctx.setWrapFactory(wrapFactory);
    Scriptable scope=ctx.newObject(globalScope);
    scope.setPrototype(globalScope);
    scope.setParentScope(null);
    for (    Map.Entry<String,Object> entry : lookup.asMap().entrySet()) {
      ScriptableObject.putProperty(scope,entry.getKey(),entry.getValue());
    }
    if (vars != null) {
      for (      Map.Entry<String,Object> entry : vars.entrySet()) {
        ScriptableObject.putProperty(scope,entry.getKey(),entry.getValue());
      }
    }
    return new JavaScriptSearchScript((Script)compiledScript,scope,lookup);
  }
  finally {
    Context.exit();
  }
}
