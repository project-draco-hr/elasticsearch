{
synchronized (mutex) {
    boolean activeInactiveStatusChanges=false;
    for (    IndexService indexService : indicesService) {
      for (      IndexShard indexShard : indexService) {
        long time=threadPool.estimatedTimeInMillis();
        Translog translog=((InternalIndexShard)indexShard).translog();
        ShardIndexingStatus status=shardsIndicesStatus.get(indexShard.shardId());
        if (status == null) {
          continue;
        }
        if (status.translogId == translog.currentId() && translog.estimatedNumberOfOperations() == 0) {
          if (status.time == -1) {
            status.time=time;
          }
          if (!status.inactive) {
            if ((time - status.time) > inactiveTime.millis() && indexShard.mergeStats().current() == 0) {
              try {
                ((InternalIndexShard)indexShard).engine().updateIndexingBufferSize(Engine.INACTIVE_SHARD_INDEXING_BUFFER);
              }
 catch (              EngineClosedException e) {
                continue;
              }
catch (              FlushNotAllowedEngineException e) {
                continue;
              }
              status.inactive=true;
              activeInactiveStatusChanges=true;
              logger.debug("marking shard [{}][{}] as inactive (inactive_time[{}]) indexing wise, setting size to [{}]",indexShard.shardId().index().name(),indexShard.shardId().id(),inactiveTime,Engine.INACTIVE_SHARD_INDEXING_BUFFER);
            }
          }
        }
 else {
          if (status.inactive) {
            status.inactive=false;
            activeInactiveStatusChanges=true;
            logger.debug("marking shard [{}][{}] as active indexing wise",indexShard.shardId().index().name(),indexShard.shardId().id());
          }
          status.time=-1;
        }
        status.translogId=translog.currentId();
        status.translogNumberOfOperations=translog.estimatedNumberOfOperations();
      }
    }
    if (activeInactiveStatusChanges) {
      calcAndSetShardIndexingBuffer("shards became active/inactive (indexing wise)");
    }
  }
}
