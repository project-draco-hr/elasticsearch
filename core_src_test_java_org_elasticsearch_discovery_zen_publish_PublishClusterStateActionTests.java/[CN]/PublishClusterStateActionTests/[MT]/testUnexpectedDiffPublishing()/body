{
  MockNode nodeA=createMockNode("nodeA",Settings.EMPTY,Version.CURRENT,new ClusterStateListener(){
    @Override public void clusterChanged(    ClusterChangedEvent event){
      fail("Shouldn't send cluster state to myself");
    }
  }
).setAsMaster();
  MockNode nodeB=createMockNode("nodeB",Settings.EMPTY,Version.CURRENT);
  DiscoveryNodes discoveryNodes=DiscoveryNodes.builder(nodeA.nodes()).put(nodeB.discoveryNode).build();
  ClusterState previousClusterState=ClusterState.builder(ClusterName.DEFAULT).nodes(discoveryNodes).build();
  ClusterState clusterState=ClusterState.builder(previousClusterState).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromFull(nodeB.clusterState,clusterState);
  previousClusterState=clusterState;
  clusterState=ClusterState.builder(clusterState).blocks(ClusterBlocks.builder().addGlobalBlock(MetaData.CLUSTER_READ_ONLY_BLOCK)).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromDiff(nodeB.clusterState,clusterState);
}
