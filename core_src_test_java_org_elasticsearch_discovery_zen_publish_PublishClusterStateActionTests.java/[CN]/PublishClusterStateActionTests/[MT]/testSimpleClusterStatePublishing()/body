{
  MockNode nodeA=createMockNode("nodeA").setAsMaster();
  MockNode nodeB=createMockNode("nodeB");
  ClusterState clusterState=nodeA.clusterState;
  DiscoveryNodes discoveryNodes=DiscoveryNodes.builder(clusterState.nodes()).add(nodeB.discoveryNode).build();
  ClusterState previousClusterState=clusterState;
  clusterState=ClusterState.builder(clusterState).nodes(discoveryNodes).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromFull(nodeB.clusterState,clusterState);
  previousClusterState=clusterState;
  clusterState=ClusterState.builder(clusterState).blocks(ClusterBlocks.builder().addGlobalBlock(MetaData.CLUSTER_READ_ONLY_BLOCK)).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromDiff(nodeB.clusterState,clusterState);
  assertThat(nodeB.clusterState.blocks().global().size(),equalTo(1));
  previousClusterState=clusterState;
  clusterState=ClusterState.builder(clusterState).blocks(ClusterBlocks.EMPTY_CLUSTER_BLOCK).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromDiff(nodeB.clusterState,clusterState);
  assertTrue(nodeB.clusterState.wasReadFromDiff());
  MockNode nodeC=createMockNode("nodeC");
  previousClusterState=clusterState;
  discoveryNodes=DiscoveryNodes.builder(discoveryNodes).add(nodeC.discoveryNode).build();
  clusterState=ClusterState.builder(clusterState).nodes(discoveryNodes).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromDiff(nodeB.clusterState,clusterState);
  assertSameStateFromFull(nodeC.clusterState,clusterState);
  previousClusterState=clusterState;
  MetaData metaData=MetaData.builder(clusterState.metaData()).transientSettings(Settings.builder().put("foo","bar").build()).build();
  clusterState=ClusterState.builder(clusterState).metaData(metaData).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromDiff(nodeB.clusterState,clusterState);
  assertThat(nodeB.clusterState.blocks().global().size(),equalTo(0));
  assertSameStateFromDiff(nodeC.clusterState,clusterState);
  assertThat(nodeC.clusterState.blocks().global().size(),equalTo(0));
  previousClusterState=ClusterState.builder(clusterState).incrementVersion().build();
  clusterState=ClusterState.builder(clusterState).incrementVersion().build();
  publishStateAndWait(nodeA.action,clusterState,previousClusterState);
  assertSameStateFromFull(nodeB.clusterState,clusterState);
  assertSameStateFromFull(nodeC.clusterState,clusterState);
  assertFalse(nodeC.clusterState.wasReadFromDiff());
  nodeA.resetMasterId();
  nodeB.resetMasterId();
  nodeC.resetMasterId();
  discoveryNodes=DiscoveryNodes.builder(discoveryNodes).add(nodeA.discoveryNode).add(nodeB.discoveryNode).add(nodeC.discoveryNode).masterNodeId(nodeB.discoveryNode.getId()).localNodeId(nodeB.discoveryNode.getId()).build();
  previousClusterState=ClusterState.builder(new ClusterName("test")).nodes(discoveryNodes).build();
  clusterState=ClusterState.builder(clusterState).nodes(discoveryNodes).incrementVersion().build();
  publishStateAndWait(nodeB.action,clusterState,previousClusterState);
  assertSameStateFromFull(nodeA.clusterState,clusterState);
  assertSameStateFromFull(nodeC.clusterState,clusterState);
}
