{
  ArrayList<ShardIterator> set=new ArrayList<>();
  for (  String index : indices) {
    IndexRoutingTable indexRoutingTable=index(index);
    if (indexRoutingTable == null) {
      continue;
    }
    for (    IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {
      for (      ShardRouting shardRouting : indexShardRoutingTable) {
        if (shardRouting.assignedToNode()) {
          set.add(shardRouting.shardsIt());
          if (includeRelocationTargets && shardRouting.relocating()) {
            set.add(new PlainShardIterator(shardRouting.shardId(),ImmutableList.of(shardRouting.targetRoutingIfRelocating())));
          }
        }
 else         if (includeEmpty) {
          set.add(new PlainShardIterator(shardRouting.shardId(),ImmutableList.<ShardRouting>of()));
        }
      }
    }
  }
  return new GroupShardsIterator(set);
}
