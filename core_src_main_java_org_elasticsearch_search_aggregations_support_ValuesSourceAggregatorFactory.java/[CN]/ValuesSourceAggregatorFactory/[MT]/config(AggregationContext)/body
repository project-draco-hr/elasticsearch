{
  ValueType valueType=this.valueType != null ? this.valueType : targetValueType;
  if (field == null) {
    if (script == null) {
      ValuesSourceConfig<VS> config=new ValuesSourceConfig(ValuesSource.class);
      config.format=resolveFormat(null,valueType);
      return config;
    }
    Class valuesSourceType=valueType != null ? (Class<VS>)valueType.getValuesSourceType() : this.valuesSourceType;
    if (valuesSourceType == null || valuesSourceType == ValuesSource.class) {
      valuesSourceType=ValuesSource.Bytes.class;
    }
    ValuesSourceConfig<VS> config=new ValuesSourceConfig<VS>(valuesSourceType);
    config.missing=missing;
    config.format=resolveFormat(format,valueType);
    config.script=createScript(script,context.searchContext());
    config.scriptValueType=valueType;
    return config;
  }
  MappedFieldType fieldType=context.searchContext().smartNameFieldTypeFromAnyType(field);
  if (fieldType == null) {
    Class<VS> valuesSourceType=valueType != null ? (Class<VS>)valueType.getValuesSourceType() : this.valuesSourceType;
    ValuesSourceConfig<VS> config=new ValuesSourceConfig<>(valuesSourceType);
    config.missing=missing;
    config.format=resolveFormat(format,valueType);
    config.unmapped=true;
    if (valueType != null) {
      config.scriptValueType=valueType;
    }
    return config;
  }
  IndexFieldData<?> indexFieldData=context.searchContext().fieldData().getForField(fieldType);
  ValuesSourceConfig config;
  if (valuesSourceType == ValuesSource.class) {
    if (indexFieldData instanceof IndexNumericFieldData) {
      config=new ValuesSourceConfig<>(ValuesSource.Numeric.class);
    }
 else     if (indexFieldData instanceof IndexGeoPointFieldData) {
      config=new ValuesSourceConfig<>(ValuesSource.GeoPoint.class);
    }
 else {
      config=new ValuesSourceConfig<>(ValuesSource.Bytes.class);
    }
  }
 else {
    config=new ValuesSourceConfig(valuesSourceType);
  }
  config.fieldContext=new FieldContext(field,indexFieldData,fieldType);
  config.missing=missing;
  config.script=createScript(script,context.searchContext());
  config.format=resolveFormat(format,this.timeZone,fieldType);
  return config;
}
