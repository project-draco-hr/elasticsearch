{
  ValueType valueType=input.valueType != null ? input.valueType : input.targetValueType;
  if (input.field == null) {
    if (input.script == null) {
      ValuesSourceConfig<VS> config=new ValuesSourceConfig(ValuesSource.class);
      config.format=resolveFormat(null,valueType);
      return config;
    }
    Class valuesSourceType=valueType != null ? (Class<VS>)valueType.getValuesSourceType() : input.valuesSourceType;
    if (valuesSourceType == null || valuesSourceType == ValuesSource.class) {
      valuesSourceType=ValuesSource.Bytes.class;
    }
    ValuesSourceConfig<VS> config=new ValuesSourceConfig<VS>(valuesSourceType);
    config.missing=input.missing;
    config.format=resolveFormat(input.format,valueType);
    config.script=createScript(input.script,context.searchContext());
    config.scriptValueType=valueType;
    return config;
  }
  MappedFieldType fieldType=context.searchContext().smartNameFieldTypeFromAnyType(input.field);
  if (fieldType == null) {
    Class<VS> valuesSourceType=valueType != null ? (Class<VS>)valueType.getValuesSourceType() : input.valuesSourceType;
    ValuesSourceConfig<VS> config=new ValuesSourceConfig<>(valuesSourceType);
    config.missing=input.missing;
    config.format=resolveFormat(input.format,valueType);
    config.unmapped=true;
    if (valueType != null) {
      config.scriptValueType=valueType;
    }
    return config;
  }
  IndexFieldData<?> indexFieldData=context.searchContext().fieldData().getForField(fieldType);
  ValuesSourceConfig config;
  if (input.valuesSourceType == ValuesSource.class) {
    if (indexFieldData instanceof IndexNumericFieldData) {
      config=new ValuesSourceConfig<>(ValuesSource.Numeric.class);
    }
 else     if (indexFieldData instanceof IndexGeoPointFieldData) {
      config=new ValuesSourceConfig<>(ValuesSource.GeoPoint.class);
    }
 else {
      config=new ValuesSourceConfig<>(ValuesSource.Bytes.class);
    }
  }
 else {
    config=new ValuesSourceConfig(input.valuesSourceType);
  }
  config.fieldContext=new FieldContext(input.field,indexFieldData,fieldType);
  config.missing=input.missing;
  config.script=createScript(input.script,context.searchContext());
  config.format=resolveFormat(input.format,fieldType);
  return config;
}
