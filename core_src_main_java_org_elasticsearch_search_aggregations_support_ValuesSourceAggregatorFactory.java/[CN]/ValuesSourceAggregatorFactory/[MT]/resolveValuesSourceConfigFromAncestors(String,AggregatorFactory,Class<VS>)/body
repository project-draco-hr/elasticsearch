{
  ValuesSourceConfig config;
  while (parent != null) {
    if (parent instanceof ValuesSourceAggregatorFactory) {
      config=((ValuesSourceAggregatorFactory)parent).config;
      if (config != null && config.valid()) {
        if (requiredValuesSourceType == null || requiredValuesSourceType.isAssignableFrom(config.valueSourceType)) {
          ValueFormat format=config.format;
          this.config=config;
          if (this.config.formatPattern != null && format != null && format instanceof ValueFormat.Patternable) {
            this.config.format=((ValueFormat.Patternable)format).create(this.config.formatPattern);
          }
          return;
        }
      }
    }
    parent=parent.parent();
  }
  throw new AggregationExecutionException("could not find the appropriate value context to perform aggregation [" + aggName + "]");
}
