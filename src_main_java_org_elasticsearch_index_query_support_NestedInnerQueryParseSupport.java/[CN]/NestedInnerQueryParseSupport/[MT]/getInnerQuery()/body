{
  if (queryParsed) {
    return innerQuery;
  }
 else {
    if (path == null) {
      throw new QueryParsingException(parseContext,"[nested] requires 'path' field");
    }
    if (!queryFound) {
      throw new QueryParsingException(parseContext,"[nested] requires either 'query' or 'filter' field");
    }
    XContentParser old=parseContext.parser();
    try {
      XContentParser innerParser=XContentHelper.createParser(source);
      parseContext.parser(innerParser);
      setPathLevel();
      try {
        innerQuery=parseContext.parseInnerQuery();
      }
  finally {
        resetPathLevel();
      }
      queryParsed=true;
      return innerQuery;
    }
  finally {
      parseContext.parser(old);
    }
  }
}
