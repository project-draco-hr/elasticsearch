{
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1).put("index.number_of_replicas",0)).addMapping("parent").addMapping("child","_parent","type=parent").get();
  ensureGreen();
  client().prepareIndex("test","parent","1").setSource("p_field",1).get();
  client().prepareIndex("test","child","1").setParent("1").setSource("c_field",1).get();
  client().admin().indices().prepareFlush("test").get();
  client().prepareIndex("test","type1","1").setSource("p_field","p_value1").get();
  client().admin().indices().prepareFlush("test").get();
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(filteredQuery(matchAllQuery(),hasChildFilter("child",matchAllQuery()))).get();
  assertNoFailures(searchResponse);
  assertThat(searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
  searchResponse=client().prepareSearch("test").setQuery(filteredQuery(matchAllQuery(),hasParentFilter("parent",matchAllQuery()))).get();
  assertNoFailures(searchResponse);
  assertThat(searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
}
