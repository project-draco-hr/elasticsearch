{
  client().admin().indices().prepareCreate("test").addMapping("parent").addMapping("test","_parent","type=foo").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1).put("index.number_of_replicas",0)).get();
  ensureGreen();
  client().prepareIndex("test","foo","1").setSource("foo",1).get();
  client().prepareIndex("test","test").setSource("foo",1).setParent("1").get();
  client().admin().indices().prepareRefresh().get();
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(hasChildQuery("test",matchQuery("foo",1))).execute().actionGet();
  assertThat(searchResponse.getFailedShards(),equalTo(0));
  assertThat(searchResponse.getHits().totalHits(),equalTo(1l));
  assertThat(searchResponse.getHits().getAt(0).id(),equalTo("1"));
}
