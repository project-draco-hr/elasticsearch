{
  assertAcked(prepareCreate("test").setSettings(builder().put(indexSettings()).put(SETTING_NUMBER_OF_REPLICAS,0)).addMapping("child","_parent","type=parent"));
  ensureGreen();
  client().prepareIndex("test","parent","1").setSource("field","value").get();
  client().prepareIndex("test","child","1").setParent("1").setSource("field","value").setRefresh(true).get();
  SearchResponse searchResponse=client().prepareSearch("test").setQuery(hasChildQuery("child",matchAllQuery())).get();
  assertHitCount(searchResponse,1l);
  searchResponse=client().prepareSearch("test").setQuery(hasParentQuery("parent",matchAllQuery())).get();
  assertHitCount(searchResponse,1l);
  IndicesStatsResponse statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  long initialCacheSize=statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes();
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.hasChildFilter("child",matchAllQuery()).cache(true))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),equalTo(initialCacheSize));
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.hasParentFilter("parent",matchAllQuery()).cache(true))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),equalTo(initialCacheSize));
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.matchAllFilter()).must(FilterBuilders.hasChildFilter("child",matchAllQuery()).cache(true)))).get();
  assertHitCount(searchResponse,1l);
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.matchAllFilter()).must(FilterBuilders.hasParentFilter("parent",matchAllQuery()).cache(true)))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),equalTo(initialCacheSize));
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.termFilter("field","value").cache(true)).must(FilterBuilders.hasChildFilter("child",matchAllQuery()).cache(true)))).get();
  assertHitCount(searchResponse,1l);
  searchResponse=client().prepareSearch("test").setQuery(QueryBuilders.filteredQuery(matchAllQuery(),FilterBuilders.boolFilter().cache(true).must(FilterBuilders.termFilter("field","value").cache(true)).must(FilterBuilders.hasParentFilter("parent",matchAllQuery()).cache(true)))).get();
  assertHitCount(searchResponse,1l);
  statsResponse=client().admin().indices().prepareStats("test").clear().setFilterCache(true).get();
  assertThat(statsResponse.getIndex("test").getTotal().getFilterCache().getMemorySizeInBytes(),cluster().hasFilterCache() ? greaterThan(initialCacheSize) : is(initialCacheSize));
}
