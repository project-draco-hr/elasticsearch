{
  assertAcked(prepareCreate("test").addMapping("parent").addMapping("child","_parent","type=parent"));
  ensureGreen();
  indexRandom(true,createMinMaxDocBuilders().toArray(new IndexRequestBuilder[0]));
  SearchResponse response;
  int cutoff=getRandom().nextInt(4);
  response=MinMaxQuery("none",0,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("none",1,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("none",2,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("4"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=MinMaxQuery("none",3,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  response=MinMaxQuery("none",4,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=MinMaxQuery("none",0,4,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("none",0,3,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("none",0,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=MinMaxQuery("none",2,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  try {
    response=MinMaxQuery("none",3,2,cutoff);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.getMessage(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=MinMaxQuery("sum",0,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("sum",1,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("sum",2,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  response=MinMaxQuery("sum",3,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  response=MinMaxQuery("sum",4,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=MinMaxQuery("sum",0,4,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("sum",0,3,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(6f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(3f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("sum",0,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=MinMaxQuery("sum",2,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  try {
    response=MinMaxQuery("sum",3,2,cutoff);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.getMessage(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=MinMaxQuery("max",0,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("max",1,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("max",2,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  response=MinMaxQuery("max",3,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  response=MinMaxQuery("max",4,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=MinMaxQuery("max",0,4,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("max",0,3,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(3f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(2f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("max",0,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=MinMaxQuery("max",2,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  try {
    response=MinMaxQuery("max",3,2,cutoff);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.getMessage(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=MinMaxQuery("avg",0,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("avg",1,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("avg",2,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  response=MinMaxQuery("avg",3,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  response=MinMaxQuery("avg",4,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=MinMaxQuery("avg",0,4,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("avg",0,3,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(2f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[2].id(),equalTo("2"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxQuery("avg",0,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1.5f));
  assertThat(response.getHits().hits()[1].id(),equalTo("2"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=MinMaxQuery("avg",2,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1.5f));
  try {
    response=MinMaxQuery("avg",3,2,cutoff);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.getMessage(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
  response=MinMaxFilter(0,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxFilter(1,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxFilter(2,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("4"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=MinMaxFilter(3,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("4"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  response=MinMaxFilter(4,0,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(0l));
  response=MinMaxFilter(0,4,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxFilter(0,3,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(3l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  assertThat(response.getHits().hits()[2].id(),equalTo("4"));
  assertThat(response.getHits().hits()[2].score(),equalTo(1f));
  response=MinMaxFilter(0,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(2l));
  assertThat(response.getHits().hits()[0].id(),equalTo("2"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  assertThat(response.getHits().hits()[1].id(),equalTo("3"));
  assertThat(response.getHits().hits()[1].score(),equalTo(1f));
  response=MinMaxFilter(2,2,cutoff);
  assertThat(response.getHits().totalHits(),equalTo(1l));
  assertThat(response.getHits().hits()[0].id(),equalTo("3"));
  assertThat(response.getHits().hits()[0].score(),equalTo(1f));
  try {
    response=MinMaxFilter(3,2,cutoff);
    fail();
  }
 catch (  SearchPhaseExecutionException e) {
    assertThat(e.getMessage(),containsString("[has_child] 'max_children' is less than 'min_children'"));
  }
}
