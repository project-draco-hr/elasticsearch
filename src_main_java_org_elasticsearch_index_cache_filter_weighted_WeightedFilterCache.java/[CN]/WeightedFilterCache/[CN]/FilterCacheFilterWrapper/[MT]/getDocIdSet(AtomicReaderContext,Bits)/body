{
  Object filterKey=filter;
  if (filter instanceof CacheKeyFilter) {
    filterKey=((CacheKeyFilter)filter).cacheKey();
  }
  FilterCacheKey cacheKey=new FilterCacheKey(context.reader().getCoreCacheKey(),filterKey);
  Cache<FilterCacheKey,DocIdSet> innerCache=cache.indicesFilterCache.cache();
  DocIdSet cacheValue=innerCache.getIfPresent(cacheKey);
  if (cacheValue == null) {
    if (!cache.seenReaders.containsKey(context.reader().getCoreCacheKey())) {
      Boolean previous=cache.seenReaders.putIfAbsent(context.reader().getCoreCacheKey(),Boolean.TRUE);
      if (previous == null) {
        if (context.reader() instanceof SegmentReader) {
          ((SegmentReader)context.reader()).addCoreClosedListener(cache);
        }
      }
    }
    cacheValue=DocIdSets.toCacheable(context.reader(),filter.getDocIdSet(context,context.reader().getLiveDocs()));
    ShardId shardId=ShardUtils.extractShardId(context.reader());
    if (shardId != null) {
      IndexShard shard=cache.indexService.shard(shardId.id());
      if (shard != null) {
        cacheKey.removalListener=shard.filterCache();
        shard.filterCache().onCached(DocIdSets.sizeInBytes(cacheValue));
      }
    }
    innerCache.put(cacheKey,cacheValue);
  }
  return cacheValue == DocIdSet.EMPTY_DOCIDSET ? null : cacheValue;
}
