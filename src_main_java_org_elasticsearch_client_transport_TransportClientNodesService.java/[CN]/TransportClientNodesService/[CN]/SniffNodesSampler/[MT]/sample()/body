{
  if (closed) {
    return;
  }
  Map<TransportAddress,DiscoveryNode> nodesToPing=Maps.newHashMap();
  for (  DiscoveryNode node : listedNodes) {
    nodesToPing.put(node.address(),node);
  }
  for (  DiscoveryNode node : nodes) {
    nodesToPing.put(node.address(),node);
  }
  final CountDownLatch latch=new CountDownLatch(nodesToPing.size());
  final CopyOnWriteArrayList<NodesInfoResponse> nodesInfoResponses=new CopyOnWriteArrayList<NodesInfoResponse>();
  for (  final DiscoveryNode listedNode : nodesToPing.values()) {
    threadPool.executor(ThreadPool.Names.MANAGEMENT).execute(new Runnable(){
      @Override public void run(){
        try {
          if (!transportService.nodeConnected(listedNode)) {
            try {
              logger.trace("connecting to node [{}]",listedNode);
              transportService.connectToNode(listedNode);
            }
 catch (            Exception e) {
              logger.debug("failed to connect to node [{}], ignoring...",e,listedNode);
              latch.countDown();
              return;
            }
          }
          transportService.sendRequest(listedNode,NodesInfoAction.NAME,Requests.nodesInfoRequest("_all"),TransportRequestOptions.options().withHighType().withTimeout(pingTimeout),new BaseTransportResponseHandler<NodesInfoResponse>(){
            @Override public NodesInfoResponse newInstance(){
              return new NodesInfoResponse();
            }
            @Override public String executor(){
              return ThreadPool.Names.SAME;
            }
            @Override public void handleResponse(            NodesInfoResponse response){
              nodesInfoResponses.add(response);
              latch.countDown();
            }
            @Override public void handleException(            TransportException e){
              logger.info("failed to get node info for {}, disconnecting...",e,listedNode);
              transportService.disconnectFromNode(listedNode);
              latch.countDown();
            }
          }
);
        }
 catch (        Exception e) {
          logger.info("failed to get node info for {}, disconnecting...",e,listedNode);
          transportService.disconnectFromNode(listedNode);
          latch.countDown();
        }
      }
    }
);
  }
  try {
    latch.await();
  }
 catch (  InterruptedException e) {
    return;
  }
  HashSet<DiscoveryNode> newNodes=new HashSet<DiscoveryNode>();
  for (  NodesInfoResponse nodesInfoResponse : nodesInfoResponses) {
    for (    NodeInfo nodeInfo : nodesInfoResponse) {
      if (!clusterName.equals(nodesInfoResponse.clusterName())) {
        logger.warn("node {} not part of the cluster {}, ignoring...",nodeInfo.node(),clusterName);
      }
 else {
        if (nodeInfo.node().dataNode()) {
          newNodes.add(nodeInfo.node());
        }
      }
    }
  }
  for (Iterator<DiscoveryNode> it=newNodes.iterator(); it.hasNext(); ) {
    DiscoveryNode node=it.next();
    if (!transportService.nodeConnected(node)) {
      try {
        logger.trace("connecting to node [{}]",node);
        transportService.connectToNode(node);
      }
 catch (      Exception e) {
        it.remove();
        logger.debug("failed to connect to discovered node [" + node + "]",e);
      }
    }
  }
  nodes=new ImmutableList.Builder<DiscoveryNode>().addAll(newNodes).build();
}
