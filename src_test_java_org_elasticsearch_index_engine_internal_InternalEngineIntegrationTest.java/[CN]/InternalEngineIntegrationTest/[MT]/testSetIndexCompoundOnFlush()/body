{
  client().admin().indices().prepareCreate("test").setSettings(ImmutableSettings.builder().put("number_of_replicas",0).put("number_of_shards",1)).get();
  ensureGreen();
  client().prepareIndex("test","foo").setSource("field","foo").get();
  refresh();
  assertTotalCompoundSegments(1,1,"test");
  client().admin().indices().prepareUpdateSettings("test").setSettings(ImmutableSettings.builder().put(InternalEngineHolder.INDEX_COMPOUND_ON_FLUSH,false)).get();
  client().prepareIndex("test","foo").setSource("field","foo").get();
  refresh();
  assertTotalCompoundSegments(1,2,"test");
  client().admin().indices().prepareUpdateSettings("test").setSettings(ImmutableSettings.builder().put(InternalEngineHolder.INDEX_COMPOUND_ON_FLUSH,true)).get();
  client().prepareIndex("test","foo").setSource("field","foo").get();
  refresh();
  assertTotalCompoundSegments(2,3,"test");
}
