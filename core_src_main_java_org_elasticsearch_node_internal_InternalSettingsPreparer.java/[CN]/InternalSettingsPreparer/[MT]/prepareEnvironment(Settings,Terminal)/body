{
  Settings.Builder output=settingsBuilder();
  initializeSettings(output,input,true);
  Environment environment=new Environment(output.build());
  boolean settingsFileFound=false;
  Set<String> foundSuffixes=new HashSet<>();
  for (  String allowedSuffix : ALLOWED_SUFFIXES) {
    Path path=environment.configFile().resolve("elasticsearch" + allowedSuffix);
    if (Files.exists(path)) {
      if (!settingsFileFound) {
        output.loadFromPath(path);
      }
      settingsFileFound=true;
      foundSuffixes.add(allowedSuffix);
    }
  }
  if (foundSuffixes.size() > 1) {
    throw new SettingsException("multiple settings files found with suffixes: " + Strings.collectionToDelimitedString(foundSuffixes,","));
  }
  initializeSettings(output,input,false);
  finalizeSettings(output,terminal,environment.configFile());
  environment=new Environment(output.build());
  output.put("path.logs",cleanPath(environment.logsFile().toAbsolutePath().toString()));
  return new Environment(output.build());
}
