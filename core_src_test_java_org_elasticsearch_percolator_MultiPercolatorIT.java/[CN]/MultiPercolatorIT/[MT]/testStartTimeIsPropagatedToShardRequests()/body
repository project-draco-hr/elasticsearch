{
  internalCluster().ensureAtLeastNumDataNodes(2);
  client().admin().indices().prepareCreate(INDEX_NAME).setSettings(Settings.builder().put("index.number_of_shards",1).put("index.number_of_replicas",1)).addMapping("type","date_field","type=date,format=strict_date_optional_time||epoch_millis").addMapping(TYPE_NAME,"query","type=percolator").get();
  ensureGreen();
  client().prepareIndex(INDEX_NAME,TYPE_NAME,"1").setSource(jsonBuilder().startObject().field("query",rangeQuery("date_field").lt("now+90d")).endObject()).setRefresh(true).get();
  for (int i=0; i < 32; i++) {
    MultiPercolateResponse response=client().prepareMultiPercolate().add(client().preparePercolate().setDocumentType("type").setIndices(INDEX_NAME).setPercolateDoc(new PercolateSourceBuilder.DocBuilder().setDoc("date_field","2015-07-21T10:28:01-07:00"))).get();
    assertThat(response.getItems()[0].getResponse().getCount(),equalTo(1L));
    assertThat(response.getItems()[0].getResponse().getMatches()[0].getId().string(),equalTo("1"));
  }
}
