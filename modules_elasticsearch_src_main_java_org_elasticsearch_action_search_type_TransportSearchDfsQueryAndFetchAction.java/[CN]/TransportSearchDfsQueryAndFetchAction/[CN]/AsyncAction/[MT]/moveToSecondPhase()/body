{
  final AggregatedDfs dfs=searchPhaseController.aggregateDfs(dfsResults);
  final AtomicInteger counter=new AtomicInteger(dfsResults.size());
  int localOperations=0;
  for (  DfsSearchResult dfsResult : dfsResults) {
    Node node=nodes.get(dfsResult.shardTarget().nodeId());
    if (node.id().equals(nodes.localNodeId())) {
      localOperations++;
    }
 else {
      QuerySearchRequest querySearchRequest=new QuerySearchRequest(dfsResult.id(),dfs);
      executeSecondPhase(counter,node,querySearchRequest);
    }
  }
  if (localOperations > 0) {
    if (request.operationThreading() == SearchOperationThreading.SINGLE_THREAD) {
      threadPool.execute(new Runnable(){
        @Override public void run(){
          for (          DfsSearchResult dfsResult : dfsResults) {
            Node node=nodes.get(dfsResult.shardTarget().nodeId());
            if (node.id().equals(nodes.localNodeId())) {
              QuerySearchRequest querySearchRequest=new QuerySearchRequest(dfsResult.id(),dfs);
              executeSecondPhase(counter,node,querySearchRequest);
            }
          }
          searchCache.releaseDfsResults(dfsResults);
        }
      }
);
    }
 else {
      boolean localAsync=request.operationThreading() == SearchOperationThreading.THREAD_PER_SHARD;
      for (      DfsSearchResult dfsResult : dfsResults) {
        final Node node=nodes.get(dfsResult.shardTarget().nodeId());
        if (node.id().equals(nodes.localNodeId())) {
          final QuerySearchRequest querySearchRequest=new QuerySearchRequest(dfsResult.id(),dfs);
          if (localAsync) {
            threadPool.execute(new Runnable(){
              @Override public void run(){
                executeSecondPhase(counter,node,querySearchRequest);
              }
            }
);
          }
 else {
            executeSecondPhase(counter,node,querySearchRequest);
          }
        }
      }
      searchCache.releaseDfsResults(dfsResults);
    }
  }
}
