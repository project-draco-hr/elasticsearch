{
  logger.info("--> add another node");
  startNode("node3");
  logger.info("--> creating index test with auto expand replicas set to 0-2");
  client1.admin().indices().prepareCreate("test").setSettings(settingsBuilder().put("index.number_of_shards",2).put("auto_expand_replicas","0-2")).execute().actionGet();
  logger.info("--> running cluster health");
  ClusterHealthResponse clusterHealth=client1.admin().cluster().prepareHealth().setWaitForGreenStatus().setWaitForActiveShards(6).execute().actionGet();
  logger.info("--> done cluster health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  assertThat(clusterHealth.getIndices().get("test").getActivePrimaryShards(),equalTo(2));
  assertThat(clusterHealth.getIndices().get("test").getNumberOfReplicas(),equalTo(2));
  assertThat(clusterHealth.getIndices().get("test").getActiveShards(),equalTo(6));
  logger.info("--> add two more nodes");
  startNode("node4");
  startNode("node5");
  logger.info("--> update the auto expand replicas to 0-3");
  client1.admin().indices().prepareUpdateSettings("test").setSettings(settingsBuilder().put("auto_expand_replicas","0-3")).execute().actionGet();
  logger.info("--> running cluster health");
  clusterHealth=client1.admin().cluster().prepareHealth().setWaitForGreenStatus().setWaitForActiveShards(8).execute().actionGet();
  logger.info("--> done cluster health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  assertThat(clusterHealth.getIndices().get("test").getActivePrimaryShards(),equalTo(2));
  assertThat(clusterHealth.getIndices().get("test").getNumberOfReplicas(),equalTo(3));
  assertThat(clusterHealth.getIndices().get("test").getActiveShards(),equalTo(8));
}
