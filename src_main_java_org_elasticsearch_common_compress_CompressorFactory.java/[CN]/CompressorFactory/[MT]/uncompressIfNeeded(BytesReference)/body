{
  Compressor compressor=compressor(bytes);
  if (compressor != null) {
    if (bytes.hasArray()) {
      return new BytesArray(compressor.uncompress(bytes.array(),bytes.arrayOffset(),bytes.length()));
    }
    StreamInput compressed=compressor.streamInput(bytes.streamInput());
    CachedStreamOutput.Entry entry=CachedStreamOutput.popEntry();
    try {
      Streams.copy(compressed,entry.bytes());
      compressed.close();
      return new BytesArray(entry.bytes().bytes().toBytes());
    }
  finally {
      CachedStreamOutput.pushEntry(entry);
    }
  }
  return bytes;
}
