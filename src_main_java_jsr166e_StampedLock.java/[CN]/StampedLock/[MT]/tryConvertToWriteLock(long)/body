{
  long a=stamp & ABITS, m, s, next;
  while (((s=state) & SBITS) == (stamp & SBITS)) {
    if ((m=s & ABITS) == 0L) {
      if (a != 0L)       break;
      if (U.compareAndSwapLong(this,STATE,s,next=s + WBIT))       return next;
    }
 else     if (m == WBIT) {
      if (a != m)       break;
      return stamp;
    }
 else     if (m == RUNIT && a != 0L) {
      if (U.compareAndSwapLong(this,STATE,s,next=s - RUNIT + WBIT))       return next;
    }
 else     break;
  }
  return 0L;
}
