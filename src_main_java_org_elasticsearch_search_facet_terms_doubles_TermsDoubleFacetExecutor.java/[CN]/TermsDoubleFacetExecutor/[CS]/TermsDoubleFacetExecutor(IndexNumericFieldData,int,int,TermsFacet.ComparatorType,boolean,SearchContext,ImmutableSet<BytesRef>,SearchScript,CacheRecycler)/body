{
  this.indexFieldData=indexFieldData;
  this.size=size;
  this.shardSize=shardSize;
  this.comparatorType=comparatorType;
  this.script=script;
  this.excluded=excluded;
  this.facets=cacheRecycler.doubleIntMap(-1);
  if (allTerms) {
    for (    AtomicReaderContext readerContext : context.searcher().getTopReaderContext().leaves()) {
      int maxDoc=readerContext.reader().maxDoc();
      DoubleValues values=indexFieldData.load(readerContext).getDoubleValues();
      if (values instanceof DoubleValues.WithOrdinals) {
        DoubleValues.WithOrdinals valuesWithOrds=(DoubleValues.WithOrdinals)values;
        Ordinals.Docs ordinals=valuesWithOrds.ordinals();
        for (long ord=Ordinals.MIN_ORDINAL; ord < ordinals.getMaxOrd(); ord++) {
          facets.v().putIfAbsent(valuesWithOrds.getValueByOrd(ord),0);
        }
      }
 else {
        if (values.isMultiValued()) {
          for (int docId=0; docId < maxDoc; docId++) {
            if (!values.hasValue(docId)) {
              continue;
            }
            int numValues=values.setDocument(docId);
            DoubleIntOpenHashMap map=facets.v();
            for (int i=0; i < numValues; i++) {
              map.putIfAbsent(values.nextValue(),0);
            }
          }
        }
 else {
          for (int docId=0; docId < maxDoc; docId++) {
            if (!values.hasValue(docId)) {
              continue;
            }
            double value=values.getValue(docId);
            facets.v().putIfAbsent(value,0);
          }
        }
      }
    }
  }
}
