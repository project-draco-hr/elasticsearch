{
  int ops=0;
  long size=0;
  int totalOperations=0;
  List<Translog.Operation> operations=Lists.newArrayList();
  Translog.Operation operation=snapshot.next();
  TransportRequestOptions recoveryOptions=TransportRequestOptions.options().withCompress(recoverySettings.compress()).withType(TransportRequestOptions.Type.RECOVERY).withTimeout(internalActionLongTimeout);
  while (operation != null) {
    if (shard.state() == IndexShardState.CLOSED) {
      throw new IndexShardClosedException(request.shardId());
    }
    operations.add(operation);
    ops+=1;
    size+=operation.estimateSize();
    totalOperations++;
    if (ops >= recoverySettings.translogOps() || size >= recoverySettings.translogSize().bytes()) {
      RecoveryTranslogOperationsRequest translogOperationsRequest=new RecoveryTranslogOperationsRequest(request.recoveryId(),request.shardId(),operations);
      transportService.submitRequest(request.targetNode(),RecoveryTarget.Actions.TRANSLOG_OPS,translogOperationsRequest,recoveryOptions,EmptyTransportResponseHandler.INSTANCE_SAME).txGet();
      ops=0;
      size=0;
      operations.clear();
    }
    operation=snapshot.next();
  }
  if (!operations.isEmpty()) {
    RecoveryTranslogOperationsRequest translogOperationsRequest=new RecoveryTranslogOperationsRequest(request.recoveryId(),request.shardId(),operations);
    transportService.submitRequest(request.targetNode(),RecoveryTarget.Actions.TRANSLOG_OPS,translogOperationsRequest,recoveryOptions,EmptyTransportResponseHandler.INSTANCE_SAME).txGet();
  }
  return totalOperations;
}
