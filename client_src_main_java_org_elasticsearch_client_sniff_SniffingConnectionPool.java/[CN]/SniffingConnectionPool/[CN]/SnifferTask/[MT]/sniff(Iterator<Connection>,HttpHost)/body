{
  IOException lastSeenException=null;
  while (connectionIterator.hasNext()) {
    Connection connection=connectionIterator.next();
    try {
      List<HttpHost> sniffedNodes=sniffer.sniffNodes(connection.getHost());
      if (excludeHost != null) {
        sniffedNodes.remove(excludeHost);
      }
      connections=createConnections(sniffedNodes.toArray(new HttpHost[sniffedNodes.size()]));
      onSuccess(connection);
      return;
    }
 catch (    IOException e) {
      onFailure(connection);
      if (lastSeenException != null) {
        e.addSuppressed(lastSeenException);
      }
      lastSeenException=e;
    }
  }
  logger.warn("failed to sniff nodes",lastSeenException);
}
