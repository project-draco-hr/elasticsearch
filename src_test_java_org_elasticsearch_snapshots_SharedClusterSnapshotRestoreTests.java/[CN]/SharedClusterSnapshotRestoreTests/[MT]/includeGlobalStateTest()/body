{
  Client client=client();
  logger.info("-->  creating repository");
  File location=newTempDir();
  PutRepositoryResponse putRepositoryResponse=client.admin().cluster().preparePutRepository("test-repo").setType("fs").setSettings(ImmutableSettings.settingsBuilder().put("location",location)).get();
  assertThat(putRepositoryResponse.isAcknowledged(),equalTo(true));
  logger.info("-->  creating test template");
  assertThat(client.admin().indices().preparePutTemplate("test-template").setTemplate("te*").addMapping("test-mapping","{}").get().isAcknowledged(),equalTo(true));
  logger.info("--> snapshot without global state");
  CreateSnapshotResponse createSnapshotResponse=client.admin().cluster().prepareCreateSnapshot("test-repo","test-snap-no-global-state").setIndices().setIncludeGlobalState(false).setWaitForCompletion(true).get();
  assertThat(createSnapshotResponse.getSnapshotInfo().totalShards(),equalTo(0));
  assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),equalTo(0));
  assertThat(client.admin().cluster().prepareGetSnapshots("test-repo").setSnapshots("test-snap-no-global-state").get().getSnapshots().get(0).state(),equalTo(SnapshotState.SUCCESS));
  logger.info("--> snapshot with global state");
  createSnapshotResponse=client.admin().cluster().prepareCreateSnapshot("test-repo","test-snap-with-global-state").setIndices().setIncludeGlobalState(true).setWaitForCompletion(true).get();
  assertThat(createSnapshotResponse.getSnapshotInfo().totalShards(),equalTo(0));
  assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),equalTo(0));
  assertThat(client.admin().cluster().prepareGetSnapshots("test-repo").setSnapshots("test-snap-with-global-state").get().getSnapshots().get(0).state(),equalTo(SnapshotState.SUCCESS));
  logger.info("-->  delete test template");
  wipeTemplates("test-template");
  ClusterStateResponse clusterStateResponse=client.admin().cluster().prepareState().setRoutingTable(false).setNodes(false).setIndexTemplates("test-template").setIndices().get();
  assertThat(clusterStateResponse.getState().getMetaData().templates().containsKey("test-template"),equalTo(false));
  logger.info("--> try restoring cluster state from snapshot without global state");
  RestoreSnapshotResponse restoreSnapshotResponse=client.admin().cluster().prepareRestoreSnapshot("test-repo","test-snap-no-global-state").setWaitForCompletion(true).setRestoreGlobalState(true).execute().actionGet();
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),equalTo(0));
  logger.info("--> check that template wasn't restored");
  clusterStateResponse=client.admin().cluster().prepareState().setRoutingTable(false).setNodes(false).setIndexTemplates("test-template").setIndices().get();
  assertThat(clusterStateResponse.getState().getMetaData().templates().containsKey("test-template"),equalTo(false));
  logger.info("--> restore cluster state");
  restoreSnapshotResponse=client.admin().cluster().prepareRestoreSnapshot("test-repo","test-snap-with-global-state").setWaitForCompletion(true).setRestoreGlobalState(true).execute().actionGet();
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),equalTo(0));
  logger.info("--> check that template is restored");
  clusterStateResponse=client.admin().cluster().prepareState().setRoutingTable(false).setNodes(false).setIndexTemplates("test-template").setIndices().get();
  assertThat(clusterStateResponse.getState().getMetaData().templates().containsKey("test-template"),equalTo(true));
  createIndex("test-idx");
  ensureGreen();
  logger.info("--> indexing some data");
  for (int i=0; i < 100; i++) {
    index("test-idx","doc",Integer.toString(i),"foo","bar" + i);
  }
  refresh();
  assertThat(client.prepareCount("test-idx").get().getCount(),equalTo(100L));
  logger.info("--> snapshot without global state but with indices");
  createSnapshotResponse=client.admin().cluster().prepareCreateSnapshot("test-repo","test-snap-no-global-state-with-index").setIndices("test-idx").setIncludeGlobalState(false).setWaitForCompletion(true).get();
  assertThat(createSnapshotResponse.getSnapshotInfo().totalShards(),greaterThan(0));
  assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),equalTo(createSnapshotResponse.getSnapshotInfo().totalShards()));
  assertThat(client.admin().cluster().prepareGetSnapshots("test-repo").setSnapshots("test-snap-no-global-state-with-index").get().getSnapshots().get(0).state(),equalTo(SnapshotState.SUCCESS));
  logger.info("-->  delete test template and index ");
  wipeIndices("test-idx");
  wipeTemplates("test-template");
  clusterStateResponse=client.admin().cluster().prepareState().setRoutingTable(false).setNodes(false).setIndexTemplates("test-template").setIndices().get();
  assertThat(clusterStateResponse.getState().getMetaData().templates().containsKey("test-template"),equalTo(false));
  logger.info("--> try restoring index and cluster state from snapshot without global state");
  restoreSnapshotResponse=client.admin().cluster().prepareRestoreSnapshot("test-repo","test-snap-no-global-state-with-index").setWaitForCompletion(true).setRestoreGlobalState(true).execute().actionGet();
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),greaterThan(0));
  assertThat(restoreSnapshotResponse.getRestoreInfo().failedShards(),equalTo(0));
  ensureGreen();
  logger.info("--> check that template wasn't restored but index was");
  clusterStateResponse=client.admin().cluster().prepareState().setRoutingTable(false).setNodes(false).setIndexTemplates("test-template").setIndices().get();
  assertThat(clusterStateResponse.getState().getMetaData().templates().containsKey("test-template"),equalTo(false));
  assertThat(client.prepareCount("test-idx").get().getCount(),equalTo(100L));
}
