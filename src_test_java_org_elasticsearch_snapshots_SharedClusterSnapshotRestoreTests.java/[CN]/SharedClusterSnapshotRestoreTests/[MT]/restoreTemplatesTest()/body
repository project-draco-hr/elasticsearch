{
  Client client=client();
  logger.info("-->  creating repository");
  PutRepositoryResponse putRepositoryResponse=run(client.admin().cluster().preparePutRepository("test-repo").setType("fs").setSettings(ImmutableSettings.settingsBuilder().put("location",newTempDir())));
  assertThat(putRepositoryResponse.isAcknowledged(),equalTo(true));
  logger.info("-->  creating test template");
  assertThat(run(client.admin().indices().preparePutTemplate("test-template").setTemplate("te*").addMapping("test-mapping","{}")).isAcknowledged(),equalTo(true));
  logger.info("--> snapshot");
  CreateSnapshotResponse createSnapshotResponse=run(client.admin().cluster().prepareCreateSnapshot("test-repo","test-snap").setIndices().setWaitForCompletion(true));
  assertThat(createSnapshotResponse.getSnapshotInfo().totalShards(),equalTo(0));
  assertThat(createSnapshotResponse.getSnapshotInfo().successfulShards(),equalTo(0));
  assertThat(run(client.admin().cluster().prepareGetSnapshots("test-repo").setSnapshots("test-snap")).getSnapshots().get(0).state(),equalTo(SnapshotState.SUCCESS));
  logger.info("-->  delete test template");
  assertThat(run(client.admin().indices().prepareDeleteTemplate("test-template")).isAcknowledged(),equalTo(true));
  ClusterStateResponse clusterStateResponse=run(client.admin().cluster().prepareState().setFilterRoutingTable(true).setFilterNodes(true).setFilterIndexTemplates("test-template").setFilterIndices());
  assertThat(clusterStateResponse.getState().getMetaData().templates().containsKey("test-template"),equalTo(false));
  logger.info("--> restore cluster state");
  RestoreSnapshotResponse restoreSnapshotResponse=client.admin().cluster().prepareRestoreSnapshot("test-repo","test-snap").setWaitForCompletion(true).setRestoreGlobalState(true).execute().actionGet();
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),equalTo(0));
  logger.info("--> check that template is restored");
  clusterStateResponse=run(client.admin().cluster().prepareState().setFilterRoutingTable(true).setFilterNodes(true).setFilterIndexTemplates("test-template").setFilterIndices());
  assertThat(clusterStateResponse.getState().getMetaData().templates().containsKey("test-template"),equalTo(true));
}
