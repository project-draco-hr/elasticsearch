{
  File repositoryLocation=newTempDir(LifecycleScope.TEST);
  Client client=client();
  logger.info("-->  creating repository");
  PutRepositoryResponse putRepositoryResponse=client.admin().cluster().preparePutRepository("test-repo").setType("fs").setSettings(ImmutableSettings.settingsBuilder().put("location",repositoryLocation)).get();
  assertThat(putRepositoryResponse.isAcknowledged(),equalTo(true));
  createIndex("test-idx");
  ensureGreen();
  logger.info("--> indexing some data");
  for (int i=0; i < 100; i++) {
    index("test-idx","doc",Integer.toString(i),"foo","bar" + i);
  }
  refresh();
  assertThat(client.prepareCount("test-idx").get().getCount(),equalTo(100L));
  logger.info("--> snapshot");
  CreateSnapshotResponse createSnapshotResponse=client.admin().cluster().prepareCreateSnapshot("test-repo","test-snap").setWaitForCompletion(true).setIndices("test-idx").get();
  assertThat(createSnapshotResponse.getSnapshotInfo().state(),equalTo(SnapshotState.SUCCESS));
  assertThat(createSnapshotResponse.getSnapshotInfo().totalShards(),equalTo(createSnapshotResponse.getSnapshotInfo().successfulShards()));
  logger.info("-->  update repository with mock version");
  putRepositoryResponse=client.admin().cluster().preparePutRepository("test-repo").setType(MockRepositoryModule.class.getCanonicalName()).setSettings(ImmutableSettings.settingsBuilder().put("location",repositoryLocation).put("random",randomAsciiOfLength(10)).put("random_data_file_io_exception_rate",1.0)).get();
  assertThat(putRepositoryResponse.isAcknowledged(),equalTo(true));
  logger.info("--> delete index");
  wipeIndices("test-idx");
  logger.info("--> restore index after deletion");
  ListenableActionFuture<RestoreSnapshotResponse> restoreSnapshotResponseFuture=client.admin().cluster().prepareRestoreSnapshot("test-repo","test-snap").setWaitForCompletion(true).execute();
  logger.info("--> wait for the index to appear");
  assertThat(waitForIndex("test-idx",TimeValue.timeValueSeconds(10)),equalTo(true));
  logger.info("--> delete index");
  wipeIndices("test-idx");
  logger.info("--> get restore results");
  RestoreSnapshotResponse restoreSnapshotResponse=restoreSnapshotResponseFuture.actionGet(TimeValue.timeValueSeconds(10));
  assertThat(restoreSnapshotResponse.getRestoreInfo().failedShards(),greaterThan(0));
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),equalTo(restoreSnapshotResponse.getRestoreInfo().failedShards()));
  logger.info("--> restoring working repository");
  putRepositoryResponse=client.admin().cluster().preparePutRepository("test-repo").setType("fs").setSettings(ImmutableSettings.settingsBuilder().put("location",repositoryLocation)).get();
  assertThat(putRepositoryResponse.isAcknowledged(),equalTo(true));
  logger.info("--> trying to restore index again");
  restoreSnapshotResponse=client.admin().cluster().prepareRestoreSnapshot("test-repo","test-snap").setWaitForCompletion(true).execute().actionGet();
  assertThat(restoreSnapshotResponse.getRestoreInfo().totalShards(),greaterThan(0));
  assertThat(restoreSnapshotResponse.getRestoreInfo().failedShards(),equalTo(0));
  ensureGreen();
  CountResponse countResponse=client.prepareCount("test-idx").get();
  assertThat(countResponse.getCount(),equalTo(100L));
}
