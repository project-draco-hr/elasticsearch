{
  Client client=client();
  logger.info("-->  creating repository");
  assertAcked(client.admin().cluster().preparePutRepository("test-repo").setType("fs").setSettings(Settings.settingsBuilder().put("location",randomRepoPath())));
  createIndex("test-idx");
  ensureGreen();
  logger.info("-->  closing index test-idx");
  assertAcked(client.admin().indices().prepareClose("test-idx"));
  logger.info("--> snapshot");
  CreateSnapshotResponse createSnapshotResponse=client.admin().cluster().prepareCreateSnapshot("test-repo","test-snap-1").setWaitForCompletion(true).setIndices("test-idx").get();
  assertThat(createSnapshotResponse.getSnapshotInfo().indices().size(),equalTo(1));
  assertThat(createSnapshotResponse.getSnapshotInfo().state(),equalTo(SnapshotState.FAILED));
}
