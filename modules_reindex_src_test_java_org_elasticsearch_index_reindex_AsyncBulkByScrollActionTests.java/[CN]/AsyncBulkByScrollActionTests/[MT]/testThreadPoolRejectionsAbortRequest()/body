{
  TimeValue expectedDelay=parseTimeValue(randomPositiveTimeValue(),"test");
  threadPool.shutdown();
  threadPool=new ThreadPool(getTestName()){
    @Override public ScheduledFuture<?> schedule(    TimeValue delay,    String name,    Runnable command){
      assertEquals(expectedDelay,delay);
      ((AbstractRunnable)command).onRejection(new EsRejectedExecutionException("test"));
      return null;
    }
  }
;
  InternalSearchHits hits=new InternalSearchHits(null,0,0);
  InternalSearchResponse searchResponse=new InternalSearchResponse(hits,null,null,null,false,false);
  new DummyAbstractAsyncBulkByScrollAction().onScrollResponse(expectedDelay,new SearchResponse(searchResponse,scrollId(),5,4,randomLong(),null));
  try {
    listener.get();
    fail("Expected a failure");
  }
 catch (  ExecutionException e) {
    assertThat(e.getMessage(),equalTo("EsRejectedExecutionException[test]"));
  }
  assertThat(client.scrollsCleared,contains(scrollId));
  assertEquals(timeValueMillis(0),task.getStatus().getThrottled());
}
