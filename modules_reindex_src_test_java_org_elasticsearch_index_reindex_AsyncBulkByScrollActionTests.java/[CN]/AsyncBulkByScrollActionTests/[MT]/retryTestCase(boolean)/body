{
  int totalFailures=randomIntBetween(1,mainRequest.getMaxRetries());
  int size=randomIntBetween(1,100);
  int retryAttempts=totalFailures - (failWithRejection ? 1 : 0);
  client.bulksToReject=client.bulksAttempts.get() + totalFailures;
  CountDownLatch successLatch=new CountDownLatch(1);
  DummyAbstractAsyncBulkByScrollAction action=new DummyAbstractAsyncBulkByScrollAction(){
    @Override BackoffPolicy backoffPolicy(){
      return constantBackoff(timeValueMillis(0),retryAttempts);
    }
    @Override void startNextScroll(    int lastBatchSize){
      successLatch.countDown();
    }
  }
;
  BulkRequest request=new BulkRequest();
  for (int i=0; i < size + 1; i++) {
    request.add(new IndexRequest("index","type","id" + i));
  }
  action.sendBulkRequest(request);
  if (failWithRejection) {
    BulkIndexByScrollResponse response=listener.get();
    assertThat(response.getIndexingFailures(),hasSize(1));
    assertEquals(response.getIndexingFailures().get(0).getStatus(),RestStatus.TOO_MANY_REQUESTS);
    assertThat(response.getSearchFailures(),emptyCollectionOf(ShardSearchFailure.class));
    assertNull(response.getReasonCancelled());
  }
 else {
    successLatch.await(10,TimeUnit.SECONDS);
  }
  return retryAttempts;
}
