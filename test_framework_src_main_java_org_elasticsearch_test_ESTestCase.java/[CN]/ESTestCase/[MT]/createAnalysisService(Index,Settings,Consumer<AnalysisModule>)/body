{
  Settings indexSettings=settingsBuilder().put(settings).put(IndexMetaData.SETTING_VERSION_CREATED,Version.CURRENT).build();
  Settings nodeSettings=Settings.builder().put(Environment.PATH_HOME_SETTING.getKey(),createTempDir()).build();
  Environment env=new Environment(nodeSettings);
  AnalysisModule analysisModule=new AnalysisModule(env);
  for (  Consumer<AnalysisModule> consumer : moduleConsumers) {
    consumer.accept(analysisModule);
  }
  SettingsModule settingsModule=new SettingsModule(nodeSettings);
  settingsModule.registerSetting(InternalSettingsPlugin.VERSION_CREATED);
  final AnalysisService analysisService=analysisModule.buildRegistry().build(IndexSettingsModule.newIndexSettings(index,indexSettings));
  return analysisService;
}
