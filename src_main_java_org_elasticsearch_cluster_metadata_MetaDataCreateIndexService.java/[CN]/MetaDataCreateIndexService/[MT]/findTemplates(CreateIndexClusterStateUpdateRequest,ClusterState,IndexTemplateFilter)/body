{
  List<IndexTemplateMetaData> templates=Lists.newArrayList();
  for (  ObjectCursor<IndexTemplateMetaData> cursor : state.metaData().templates().values()) {
    IndexTemplateMetaData template=cursor.value;
    if (indexTemplateFilter.apply(request,template)) {
      templates.add(template);
    }
  }
  File templatesDir=new File(environment.configFile(),"templates");
  if (templatesDir.exists() && templatesDir.isDirectory()) {
    File[] templatesFiles=templatesDir.listFiles();
    if (templatesFiles != null) {
      for (      File templatesFile : templatesFiles) {
        if (templatesFile.isFile()) {
          XContentParser parser=null;
          try {
            byte[] templatesData=Streams.copyToByteArray(templatesFile);
            parser=XContentHelper.createParser(templatesData,0,templatesData.length);
            IndexTemplateMetaData template=IndexTemplateMetaData.Builder.fromXContent(parser,templatesFile.getName());
            if (indexTemplateFilter.apply(request,template)) {
              templates.add(template);
            }
          }
 catch (          Exception e) {
            logger.warn("[{}] failed to read template [{}] from config",e,request.index(),templatesFile.getAbsolutePath());
          }
 finally {
            Releasables.closeWhileHandlingException(parser);
          }
        }
      }
    }
  }
  CollectionUtil.timSort(templates,new Comparator<IndexTemplateMetaData>(){
    @Override public int compare(    IndexTemplateMetaData o1,    IndexTemplateMetaData o2){
      return o2.order() - o1.order();
    }
  }
);
  return templates;
}
