{
  final SendPingsHandler sendPingsHandler=new SendPingsHandler(pingHandlerIdGenerator.incrementAndGet());
  receivedResponses.put(sendPingsHandler.id(),new PingCollection());
  sendPings(timeout,null,sendPingsHandler);
  threadPool.schedule(TimeValue.timeValueMillis(timeout.millis() / 2),ThreadPool.Names.GENERIC,new Runnable(){
    @Override public void run(){
      try {
        sendPings(timeout,null,sendPingsHandler);
        threadPool.schedule(TimeValue.timeValueMillis(timeout.millis() / 2),ThreadPool.Names.GENERIC,new Runnable(){
          @Override public void run(){
            try {
              sendPings(timeout,TimeValue.timeValueMillis(timeout.millis() / 2),sendPingsHandler);
              PingCollection responses=receivedResponses.remove(sendPingsHandler.id());
              sendPingsHandler.close();
              for (              DiscoveryNode node : sendPingsHandler.nodeToDisconnect) {
                logger.trace("[{}] disconnecting from {}",sendPingsHandler.id(),node);
                transportService.disconnectFromNode(node);
              }
              listener.onPing(responses.toArray());
            }
 catch (            EsRejectedExecutionException ex) {
              logger.debug("Ping execution rejected",ex);
            }
          }
        }
);
      }
 catch (      EsRejectedExecutionException ex) {
        logger.debug("Ping execution rejected",ex);
      }
    }
  }
);
}
