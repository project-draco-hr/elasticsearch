{
  if (lifecycle.stoppedOrClosed()) {
    throw new ElasticSearchIllegalStateException("received ping request while stopped/closed");
  }
  temporalResponses.add(request.pingResponse);
  threadPool.schedule(TimeValue.timeValueMillis(request.timeout.millis() * 2),ThreadPool.Names.SAME,new Runnable(){
    @Override public void run(){
      temporalResponses.remove(request.pingResponse);
    }
  }
);
  List<PingResponse> pingResponses=newArrayList(temporalResponses);
  DiscoveryNodes discoNodes=nodesProvider.nodes();
  pingResponses.add(new PingResponse(discoNodes.localNode(),discoNodes.masterNode(),clusterName));
  UnicastPingResponse unicastPingResponse=new UnicastPingResponse();
  unicastPingResponse.id=request.id;
  unicastPingResponse.pingResponses=pingResponses.toArray(new PingResponse[pingResponses.size()]);
  return unicastPingResponse;
}
