{
  List<DiscoveryNode> discoNodes=newArrayList();
  Map<String,? extends ComputeMetadata> nodes=computeService.context().getComputeService().getNodes();
  for (  Map.Entry<String,? extends ComputeMetadata> node : nodes.entrySet()) {
    NodeMetadata nodeMetadata=computeService.context().getComputeService().getNodeMetadata(node.getValue());
    if (tag != null && !nodeMetadata.getTag().equals(tag)) {
      continue;
    }
    if (nodeMetadata.getState() == NodeState.PENDING || nodeMetadata.getState() == NodeState.RUNNING) {
      logger.debug("Adding {}/{}",nodeMetadata.getName(),nodeMetadata.getPrivateAddresses());
      for (      InetAddress inetAddress : nodeMetadata.getPrivateAddresses()) {
        for (        int port : new PortsRange(ports).ports()) {
          discoNodes.add(new DiscoveryNode("#cloud-" + inetAddress.getHostAddress() + "-"+ port,new InetSocketTransportAddress(new InetSocketAddress(inetAddress,port))));
        }
      }
    }
  }
  return discoNodes;
}
