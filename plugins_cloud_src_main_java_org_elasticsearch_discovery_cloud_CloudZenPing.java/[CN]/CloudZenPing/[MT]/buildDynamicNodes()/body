{
  List<DiscoveryNode> discoNodes=newArrayList();
  Set<? extends ComputeMetadata> nodes=computeService.listNodes(GetNodesOptions.Builder.withDetails());
  if (logger.isTraceEnabled()) {
    StringBuilder sb=new StringBuilder("Processing Nodes:");
    for (    ComputeMetadata node : nodes) {
      sb.append("\n   -> ").append(node);
    }
    logger.trace(sb.toString());
  }
  for (  ComputeMetadata node : nodes) {
    NodeMetadata nodeMetadata=(NodeMetadata)node;
    if (tag != null && !nodeMetadata.getTag().equals(tag)) {
      logger.trace("Filtering node {} with unmatched tag {}",nodeMetadata.getName(),nodeMetadata.getTag());
      continue;
    }
    boolean filteredByLocation=true;
    if (location != null) {
      Location nodeLocation=nodeMetadata.getLocation();
      if (location.equals(nodeLocation.getId())) {
        filteredByLocation=false;
      }
 else {
        if (nodeLocation.getParent() != null) {
          if (location.equals(nodeLocation.getParent().getId())) {
            filteredByLocation=false;
          }
        }
      }
    }
 else {
      filteredByLocation=false;
    }
    if (filteredByLocation) {
      logger.trace("Filtering node {} with unmatched location {}",nodeMetadata.getName(),nodeMetadata.getLocation());
      continue;
    }
    if (nodeMetadata.getState() == NodeState.PENDING || nodeMetadata.getState() == NodeState.RUNNING) {
      logger.debug("Adding {}/{}",nodeMetadata.getName(),nodeMetadata.getPrivateAddresses());
      for (      InetAddress inetAddress : nodeMetadata.getPrivateAddresses()) {
        for (        int port : new PortsRange(ports).ports()) {
          discoNodes.add(new DiscoveryNode("#cloud-" + inetAddress.getHostAddress() + "-"+ port,new InetSocketTransportAddress(inetAddress,port)));
        }
      }
    }
  }
  return discoNodes;
}
