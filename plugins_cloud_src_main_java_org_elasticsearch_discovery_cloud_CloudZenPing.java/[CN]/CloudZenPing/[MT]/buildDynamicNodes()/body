{
  List<DiscoveryNode> discoNodes=newArrayList();
  Map<String,? extends ComputeMetadata> nodes=computeService.getNodes(GetNodesOptions.Builder.withDetails());
  logger.trace("Processing Nodes {}",nodes);
  for (  Map.Entry<String,? extends ComputeMetadata> node : nodes.entrySet()) {
    NodeMetadata nodeMetadata=(NodeMetadata)node.getValue();
    if (tag != null && !nodeMetadata.getTag().equals(tag)) {
      logger.trace("Filtering node {} with unmatched tag {}",nodeMetadata.getName(),nodeMetadata.getTag());
      continue;
    }
    boolean filteredByLocation=true;
    if (location != null) {
      Location nodeLocation=nodeMetadata.getLocation();
      if (location.equals(nodeLocation.getId())) {
        filteredByLocation=false;
      }
 else {
        if (nodeLocation.getParent() != null) {
          if (location.equals(nodeLocation.getParent().getId())) {
            filteredByLocation=false;
          }
        }
      }
    }
 else {
      filteredByLocation=false;
    }
    if (filteredByLocation) {
      logger.trace("Filtering node {} with unmatched location {}",nodeMetadata.getName(),nodeMetadata.getLocation());
      continue;
    }
    if (nodeMetadata.getState() == NodeState.PENDING || nodeMetadata.getState() == NodeState.RUNNING) {
      logger.debug("Adding {}/{}",nodeMetadata.getName(),nodeMetadata.getPrivateAddresses());
      for (      InetAddress inetAddress : nodeMetadata.getPrivateAddresses()) {
        for (        int port : new PortsRange(ports).ports()) {
          discoNodes.add(new DiscoveryNode("#cloud-" + inetAddress.getHostAddress() + "-"+ port,new InetSocketTransportAddress(new InetSocketAddress(inetAddress,port))));
        }
      }
    }
  }
  return discoNodes;
}
