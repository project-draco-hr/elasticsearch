{
  List<DiscoveryNode> nodes=new ArrayList<>();
  nodes.add(clusterService.localNode());
  int nodeId=0;
  for (int i=randomInt(5); i > 0; i--) {
    DiscoveryNode node=newNode(nodeId++);
    nodes.add(node);
    joinNode(node);
  }
  nodeJoinController.startAccumulatingJoins();
  ArrayList<Future<Void>> pendingJoins=new ArrayList<>();
  for (int i=randomInt(5); i > 0; i--) {
    DiscoveryNode node=newNode(nodeId++);
    nodes.add(node);
    pendingJoins.add(joinNodeAsync(node));
  }
  nodeJoinController.stopAccumulatingJoins();
  for (int i=randomInt(5); i > 0; i--) {
    DiscoveryNode node=newNode(nodeId++);
    nodes.add(node);
    joinNode(node);
  }
  assertNodesInCurrentState(nodes);
  for (  Future<Void> joinFuture : pendingJoins) {
    assertThat(joinFuture.isDone(),equalTo(true));
  }
}
