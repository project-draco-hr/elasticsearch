{
  assertAcked(prepareCreate("test").addAlias(new Alias("alias")));
  ensureGreen();
  BulkResponse bulkResponse=client().prepareBulk().add(client().prepareIndex().setIndex(indexOrAlias()).setType("type1").setId("1").setSource("field",1)).add(client().prepareIndex().setIndex(indexOrAlias()).setType("type1").setId("2").setSource("field",2).setCreate(true)).add(client().prepareIndex().setIndex(indexOrAlias()).setType("type1").setId("3").setSource("field",3)).add(client().prepareIndex().setIndex(indexOrAlias()).setType("type1").setId("4").setSource("field",4)).add(client().prepareIndex().setIndex(indexOrAlias()).setType("type1").setId("5").setSource("field",5)).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(false));
  assertThat(bulkResponse.getItems().length,equalTo(5));
  for (  BulkItemResponse bulkItemResponse : bulkResponse) {
    assertThat(bulkItemResponse.getIndex(),equalTo("test"));
  }
  bulkResponse=client().prepareBulk().add(client().prepareUpdate().setIndex(indexOrAlias()).setType("type1").setId("1").setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null))).add(client().prepareUpdate().setIndex(indexOrAlias()).setType("type1").setId("2").setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null)).setRetryOnConflict(3)).add(client().prepareUpdate().setIndex(indexOrAlias()).setType("type1").setId("3").setDoc(jsonBuilder().startObject().field("field1","test").endObject())).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(false));
  assertThat(bulkResponse.getItems().length,equalTo(3));
  for (  BulkItemResponse bulkItemResponse : bulkResponse) {
    assertThat(bulkItemResponse.getIndex(),equalTo("test"));
  }
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getId(),equalTo("1"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getVersion(),equalTo(2L));
  assertThat(((UpdateResponse)bulkResponse.getItems()[1].getResponse()).getId(),equalTo("2"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[1].getResponse()).getVersion(),equalTo(2L));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getId(),equalTo("3"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getVersion(),equalTo(2L));
  GetResponse getResponse=client().prepareGet().setIndex("test").setType("type1").setId("1").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(2L));
  assertThat(((Number)getResponse.getField("field").getValue()).longValue(),equalTo(2L));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("2").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(2L));
  assertThat(((Number)getResponse.getField("field").getValue()).longValue(),equalTo(3L));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("3").setFields("field1").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(2L));
  assertThat(getResponse.getField("field1").getValue().toString(),equalTo("test"));
  bulkResponse=client().prepareBulk().add(client().prepareUpdate().setIndex(indexOrAlias()).setType("type1").setId("6").setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null)).setUpsert(jsonBuilder().startObject().field("field",0).endObject())).add(client().prepareUpdate().setIndex(indexOrAlias()).setType("type1").setId("7").setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null))).add(client().prepareUpdate().setIndex(indexOrAlias()).setType("type1").setId("2").setScript(new Script("ctx._source.field += 1",ScriptService.ScriptType.INLINE,null,null))).execute().actionGet();
  assertThat(bulkResponse.hasFailures(),equalTo(true));
  assertThat(bulkResponse.getItems().length,equalTo(3));
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getId(),equalTo("6"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[0].getResponse()).getVersion(),equalTo(1L));
  assertThat(bulkResponse.getItems()[1].getResponse(),nullValue());
  assertThat(bulkResponse.getItems()[1].getFailure().getIndex(),equalTo("test"));
  assertThat(bulkResponse.getItems()[1].getFailure().getId(),equalTo("7"));
  assertThat(bulkResponse.getItems()[1].getFailure().getMessage(),containsString("document missing"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getId(),equalTo("2"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getIndex(),equalTo("test"));
  assertThat(((UpdateResponse)bulkResponse.getItems()[2].getResponse()).getVersion(),equalTo(3L));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("6").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(1L));
  assertThat(((Number)getResponse.getField("field").getValue()).longValue(),equalTo(0L));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("7").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  getResponse=client().prepareGet().setIndex("test").setType("type1").setId("2").setFields("field").execute().actionGet();
  assertThat(getResponse.isExists(),equalTo(true));
  assertThat(getResponse.getVersion(),equalTo(3L));
  assertThat(((Number)getResponse.getField("field").getValue()).longValue(),equalTo(4L));
}
