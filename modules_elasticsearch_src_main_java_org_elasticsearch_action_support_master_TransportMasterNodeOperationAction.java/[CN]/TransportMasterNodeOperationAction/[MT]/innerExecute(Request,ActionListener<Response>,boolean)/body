{
  final ClusterState clusterState=clusterService.state();
  final DiscoveryNodes nodes=clusterState.nodes();
  if (nodes.localNodeMaster() || localExecute(request)) {
    threadPool.execute(new Runnable(){
      @Override public void run(){
        try {
          checkBlock(request,clusterState);
          Response response=masterOperation(request,clusterState);
          listener.onResponse(response);
        }
 catch (        Exception e) {
          listener.onFailure(e);
        }
      }
    }
);
  }
 else {
    if (nodes.masterNode() == null) {
      if (retrying) {
        listener.onFailure(new MasterNotDiscoveredException());
      }
 else {
        clusterService.add(request.masterNodeTimeout(),new TimeoutClusterStateListener(){
          @Override public void postAdded(){
            ClusterState clusterStateV2=clusterService.state();
            if (clusterStateV2.nodes().masterNodeId() != null) {
              clusterService.remove(this);
              innerExecute(request,listener,true);
            }
          }
          @Override public void onClose(){
            clusterService.remove(this);
            listener.onFailure(new NodeClosedException(nodes.localNode()));
          }
          @Override public void onTimeout(          TimeValue timeout){
            clusterService.remove(this);
            listener.onFailure(new MasterNotDiscoveredException());
          }
          @Override public void clusterChanged(          ClusterChangedEvent event){
            if (event.nodesDelta().masterNodeChanged()) {
              clusterService.remove(this);
              innerExecute(request,listener,true);
            }
          }
        }
);
      }
      return;
    }
    processBeforeDelegationToMaster(request,clusterState);
    transportService.sendRequest(nodes.masterNode(),transportAction(),request,new BaseTransportResponseHandler<Response>(){
      @Override public Response newInstance(){
        return newResponse();
      }
      @Override public void handleResponse(      Response response){
        listener.onResponse(response);
      }
      @Override public void handleException(      final RemoteTransportException exp){
        if (exp.unwrapCause() instanceof ConnectTransportException) {
          clusterService.add(request.masterNodeTimeout(),new TimeoutClusterStateListener(){
            @Override public void postAdded(){
              ClusterState clusterStateV2=clusterService.state();
              if (!clusterState.nodes().masterNodeId().equals(clusterStateV2.nodes().masterNodeId())) {
                clusterService.remove(this);
                innerExecute(request,listener,false);
              }
            }
            @Override public void onClose(){
              clusterService.remove(this);
              listener.onFailure(new NodeClosedException(nodes.localNode()));
            }
            @Override public void onTimeout(            TimeValue timeout){
              clusterService.remove(this);
              listener.onFailure(new MasterNotDiscoveredException());
            }
            @Override public void clusterChanged(            ClusterChangedEvent event){
              if (event.nodesDelta().masterNodeChanged()) {
                clusterService.remove(this);
                innerExecute(request,listener,false);
              }
            }
          }
);
        }
 else {
          listener.onFailure(exp);
        }
      }
    }
);
  }
}
