{
  blobStore.executor().execute(new Runnable(){
    @Override public void run(){
      int retry=0;
      is.mark(Integer.MAX_VALUE);
      while (true) {
        try {
          ObjectMetadata md=new ObjectMetadata();
          if (blobStore.serverSideEncryption()) {
            md.setSSEAlgorithm(ObjectMetadata.AES_256_SERVER_SIDE_ENCRYPTION);
          }
          md.setContentLength(sizeInBytes);
          blobStore.client().putObject(blobStore.bucket(),buildKey(blobName),is,md);
          listener.onCompleted();
          return;
        }
 catch (        AmazonS3Exception e) {
          if (shouldRetry(e) && retry < blobStore.numberOfRetries()) {
            try {
              is.reset();
            }
 catch (            IOException ex) {
              listener.onFailure(e);
              return;
            }
            retry++;
          }
 else {
            listener.onFailure(e);
            return;
          }
        }
catch (        Throwable e) {
          listener.onFailure(e);
          return;
        }
      }
    }
  }
);
}
