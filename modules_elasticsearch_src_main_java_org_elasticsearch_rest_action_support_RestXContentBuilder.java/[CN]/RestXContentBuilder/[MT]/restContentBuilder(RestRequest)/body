{
  XContentType contentType=XContentType.fromRestContentType(request.header("Content-Type"));
  if (contentType == null) {
    if (request.hasContent()) {
      contentType=XContentFactory.xContentType(request.contentAsBytes());
    }
  }
  if (contentType == null) {
    contentType=XContentType.JSON;
  }
  BinaryXContentBuilder builder=XContentFactory.contentBinaryBuilder(contentType);
  if (request.paramAsBoolean("pretty",false)) {
    builder.prettyPrint();
  }
  return builder;
}
