{
  ImmutableSettings.Builder nodeSettings=ImmutableSettings.settingsBuilder().put("cluster.routing.operation.type","org.elasticsearch.test.integration.search.embedded.TwoInstanceUnbalancedShardsEmbeddedSearchTests$UnevenOperationRoutingModule");
  startNode("server1",nodeSettings);
  startNode("server2",nodeSettings);
  clusterService=((InternalNode)node("server1")).injector().getInstance(ClusterService.class);
  client("server1").admin().indices().create(Requests.createIndexRequest("test").settings(settingsBuilder().put("number_of_shards",3).put("number_of_replicas",0))).actionGet();
  client("server1").admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  for (int i=0; i < 100; i++) {
    index(client("server1"),Integer.toString(i),"test",i);
  }
  client("server1").admin().indices().refresh(refreshRequest("test")).actionGet();
  SearchService searchService1=((InternalNode)node("server1")).injector().getInstance(SearchService.class);
  SearchService searchService2=((InternalNode)node("server2")).injector().getInstance(SearchService.class);
  nodeToSearchService=ImmutableMap.<String,SearchService>builder().put(((InternalNode)node("server1")).injector().getInstance(ClusterService.class).state().nodes().localNodeId(),searchService1).put(((InternalNode)node("server2")).injector().getInstance(ClusterService.class).state().nodes().localNodeId(),searchService2).build();
  searchPhaseController=((InternalNode)node("server1")).injector().getInstance(SearchPhaseController.class);
}
