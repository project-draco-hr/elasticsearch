{
  int numDocs=randomIntBetween(1,10);
  Map<String,Object> requestContent=new HashMap<>();
  List<Map<String,Object>> docs=new ArrayList<>();
  List<Map<String,Object>> expectedDocs=new ArrayList<>();
  requestContent.put(Fields.DOCS,docs);
  for (int i=0; i < numDocs; i++) {
    Map<String,Object> doc=new HashMap<>();
    String index=randomAsciiOfLengthBetween(1,10);
    String type=randomAsciiOfLengthBetween(1,10);
    String id=randomAsciiOfLengthBetween(1,10);
    doc.put(Fields.INDEX,index);
    doc.put(Fields.TYPE,type);
    doc.put(Fields.ID,id);
    String fieldName=randomAsciiOfLengthBetween(1,10);
    String fieldValue=randomAsciiOfLengthBetween(1,10);
    doc.put(Fields.SOURCE,Collections.singletonMap(fieldName,fieldValue));
    docs.add(doc);
    Map<String,Object> expectedDoc=new HashMap<>();
    expectedDoc.put(Fields.INDEX,index);
    expectedDoc.put(Fields.TYPE,type);
    expectedDoc.put(Fields.ID,id);
    expectedDoc.put(Fields.SOURCE,Collections.singletonMap(fieldName,fieldValue));
    expectedDocs.add(expectedDoc);
  }
  Map<String,Object> pipelineConfig=new HashMap<>();
  List<Map<String,Object>> processors=new ArrayList<>();
  int numProcessors=randomIntBetween(1,10);
  for (int i=0; i < numProcessors; i++) {
    processors.add(Collections.singletonMap("mock_processor",Collections.emptyMap()));
  }
  pipelineConfig.put("processors",processors);
  requestContent.put(Fields.PIPELINE,pipelineConfig);
  ParsedSimulateRequest actualRequest=new ParsedSimulateRequest.Parser().parse(requestContent,false,store);
  assertThat(actualRequest.isVerbose(),equalTo(false));
  assertThat(actualRequest.getDocuments().size(),equalTo(numDocs));
  Iterator<Map<String,Object>> expectedDocsIterator=expectedDocs.iterator();
  for (  IngestDocument ingestDocument : actualRequest.getDocuments()) {
    Map<String,Object> expectedDocument=expectedDocsIterator.next();
    assertThat(ingestDocument.getSource(),equalTo(expectedDocument.get(Fields.SOURCE)));
    assertThat(ingestDocument.getMetadata(INDEX),equalTo(expectedDocument.get(Fields.INDEX)));
    assertThat(ingestDocument.getMetadata(TYPE),equalTo(expectedDocument.get(Fields.TYPE)));
    assertThat(ingestDocument.getMetadata(ID),equalTo(expectedDocument.get(Fields.ID)));
  }
  assertThat(actualRequest.getPipeline().getId(),equalTo(ParsedSimulateRequest.Parser.SIMULATED_PIPELINE_ID));
  assertThat(actualRequest.getPipeline().getDescription(),nullValue());
  assertThat(actualRequest.getPipeline().getProcessors().size(),equalTo(numProcessors));
}
