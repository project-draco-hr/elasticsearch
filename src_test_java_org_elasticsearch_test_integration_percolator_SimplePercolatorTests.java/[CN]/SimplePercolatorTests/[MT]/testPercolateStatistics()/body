{
  client().admin().indices().prepareCreate("test").execute().actionGet();
  ensureGreen();
  logger.info("--> register a query");
  client().prepareIndex("test","_percolator","1").setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).execute().actionGet();
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  logger.info("--> First percolate request");
  PercolateResponse response=client().preparePercolate("test","type").setSource(jsonBuilder().startObject().startObject("doc").field("field","val").endObject().endObject()).execute().actionGet();
  assertThat(response.getMatches(),arrayWithSize(1));
  assertThat(convertFromTextArray(response.getMatches()),arrayContaining("1"));
  IndicesStatsResponse indicesResponse=client().admin().indices().prepareStats("test").execute().actionGet();
  assertThat(indicesResponse.getTotal().getPercolate().getCount(),equalTo(5l));
  assertThat(indicesResponse.getTotal().getPercolate().getCurrent(),equalTo(0l));
  NodesStatsResponse nodesResponse=client().admin().cluster().prepareNodesStats().execute().actionGet();
  long percolateCount=0;
  long percolateSumTime=0;
  for (  NodeStats nodeStats : nodesResponse) {
    percolateCount+=nodeStats.getIndices().getPercolate().getCount();
    percolateSumTime+=nodeStats.getIndices().getPercolate().getTimeInMillis();
  }
  assertThat(percolateCount,equalTo(5l));
  logger.info("--> Second percolate request");
  response=client().preparePercolate("test","type").setSource(jsonBuilder().startObject().startObject("doc").field("field","val").endObject().endObject()).execute().actionGet();
  assertThat(response.getMatches(),arrayWithSize(1));
  assertThat(convertFromTextArray(response.getMatches()),arrayContaining("1"));
  indicesResponse=client().admin().indices().prepareStats().setPercolate(true).execute().actionGet();
  assertThat(indicesResponse.getTotal().getPercolate().getCount(),equalTo(10l));
  assertThat(indicesResponse.getTotal().getPercolate().getCurrent(),equalTo(0l));
  nodesResponse=client().admin().cluster().prepareNodesStats().execute().actionGet();
  percolateCount=0;
  percolateSumTime=0;
  for (  NodeStats nodeStats : nodesResponse) {
    percolateCount+=nodeStats.getIndices().getPercolate().getCount();
    percolateSumTime+=nodeStats.getIndices().getPercolate().getTimeInMillis();
  }
  assertThat(percolateCount,equalTo(10l));
}
