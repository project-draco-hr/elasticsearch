{
  client().admin().indices().prepareCreate("test1").execute().actionGet();
  client().admin().indices().prepareCreate("test2").execute().actionGet();
  ensureGreen();
  client().prepareIndex("test1","_percolator","1").setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).execute().actionGet();
  client().prepareIndex("test2","_percolator","1").setSource(jsonBuilder().startObject().field("query",matchAllQuery()).endObject()).execute().actionGet();
  PercolateResponse response=client().preparePercolate().setIndices("test1","test2").setDocumentType("type").setOnlyCount(true).setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().field("field1","b").endObject())).execute().actionGet();
  assertThat(response.getCount(),equalTo(2l));
  client().admin().indices().prepareDeleteMapping("test1").setType("_percolator").execute().actionGet();
  percolatorTypeRemoved("test1");
  response=client().preparePercolate().setIndices("test1","test2").setDocumentType("type").setOnlyCount(true).setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().field("field1","b").endObject())).execute().actionGet();
  assertNoFailures(response);
  assertThat(response.getCount(),equalTo(1l));
  client().admin().indices().prepareDeleteMapping("test2").setType("_percolator").execute().actionGet();
  percolatorTypeRemoved("test2");
  response=client().preparePercolate().setIndices("test1","test2").setDocumentType("type").setOnlyCount(true).setPercolateDoc(docBuilder().setDoc(jsonBuilder().startObject().field("field1","b").endObject())).execute().actionGet();
  assertNoFailures(response);
  assertThat(response.getCount(),equalTo(0l));
}
