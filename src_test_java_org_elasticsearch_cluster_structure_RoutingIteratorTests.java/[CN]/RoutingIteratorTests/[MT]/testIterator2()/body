{
  MetaData metaData=newMetaDataBuilder().put(newIndexMetaDataBuilder("test1").numberOfShards(1).numberOfReplicas(1)).put(newIndexMetaDataBuilder("test2").numberOfShards(1).numberOfReplicas(1)).build();
  RoutingTable routingTable=routingTable().addAsNew(metaData.index("test1")).addAsNew(metaData.index("test2")).build();
  ShardIterator shardIterator=routingTable.index("test1").shard(0).shardsIt(0);
  assertThat(shardIterator.size(),equalTo(2));
  ShardRouting firstRouting=shardIterator.firstOrNull();
  assertThat(shardIterator.firstOrNull(),notNullValue());
  assertThat(shardIterator.remaining(),equalTo(2));
  assertThat(shardIterator.firstOrNull(),sameInstance(shardIterator.firstOrNull()));
  assertThat(shardIterator.remaining(),equalTo(2));
  ShardRouting shardRouting1=shardIterator.nextOrNull();
  assertThat(shardRouting1,sameInstance(firstRouting));
  assertThat(shardRouting1,notNullValue());
  assertThat(shardIterator.remaining(),equalTo(1));
  ShardRouting shardRouting2=shardIterator.nextOrNull();
  assertThat(shardRouting2,notNullValue());
  assertThat(shardIterator.remaining(),equalTo(0));
  assertThat(shardRouting2,not(sameInstance(shardRouting1)));
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardIterator.remaining(),equalTo(0));
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardIterator.remaining(),equalTo(0));
  shardIterator=routingTable.index("test1").shard(0).shardsIt(1);
  assertThat(shardIterator.size(),equalTo(2));
  firstRouting=shardIterator.firstOrNull();
  assertThat(shardIterator.firstOrNull(),notNullValue());
  assertThat(shardIterator.firstOrNull(),sameInstance(shardIterator.firstOrNull()));
  ShardRouting shardRouting3=shardIterator.nextOrNull();
  assertThat(firstRouting,sameInstance(shardRouting3));
  assertThat(shardRouting1,notNullValue());
  ShardRouting shardRouting4=shardIterator.nextOrNull();
  assertThat(shardRouting2,notNullValue());
  assertThat(shardRouting2,not(sameInstance(shardRouting1)));
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardRouting1,not(sameInstance(shardRouting3)));
  assertThat(shardRouting2,not(sameInstance(shardRouting4)));
  assertThat(shardRouting1,sameInstance(shardRouting4));
  assertThat(shardRouting2,sameInstance(shardRouting3));
  shardIterator=routingTable.index("test1").shard(0).shardsIt(2);
  assertThat(shardIterator.size(),equalTo(2));
  firstRouting=shardIterator.firstOrNull();
  assertThat(shardIterator.firstOrNull(),notNullValue());
  assertThat(shardIterator.firstOrNull(),sameInstance(shardIterator.firstOrNull()));
  ShardRouting shardRouting5=shardIterator.nextOrNull();
  assertThat(shardRouting5,sameInstance(firstRouting));
  assertThat(shardRouting5,notNullValue());
  ShardRouting shardRouting6=shardIterator.nextOrNull();
  assertThat(shardRouting6,notNullValue());
  assertThat(shardRouting6,not(sameInstance(shardRouting5)));
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardRouting5,sameInstance(shardRouting1));
  assertThat(shardRouting6,sameInstance(shardRouting2));
  shardIterator=routingTable.index("test1").shard(0).shardsIt(3);
  assertThat(shardIterator.size(),equalTo(2));
  firstRouting=shardIterator.firstOrNull();
  assertThat(shardIterator.firstOrNull(),notNullValue());
  assertThat(shardIterator.firstOrNull(),sameInstance(shardIterator.firstOrNull()));
  ShardRouting shardRouting7=shardIterator.nextOrNull();
  assertThat(shardRouting7,sameInstance(firstRouting));
  assertThat(shardRouting7,notNullValue());
  ShardRouting shardRouting8=shardIterator.nextOrNull();
  assertThat(shardRouting8,notNullValue());
  assertThat(shardRouting8,not(sameInstance(shardRouting7)));
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardRouting7,sameInstance(shardRouting3));
  assertThat(shardRouting8,sameInstance(shardRouting4));
  shardIterator=routingTable.index("test1").shard(0).shardsIt(4);
  assertThat(shardIterator.size(),equalTo(2));
  firstRouting=shardIterator.firstOrNull();
  assertThat(shardIterator.firstOrNull(),notNullValue());
  assertThat(shardIterator.firstOrNull(),sameInstance(shardIterator.firstOrNull()));
  ShardRouting shardRouting9=shardIterator.nextOrNull();
  assertThat(shardRouting9,sameInstance(firstRouting));
  assertThat(shardRouting9,notNullValue());
  ShardRouting shardRouting10=shardIterator.nextOrNull();
  assertThat(shardRouting10,notNullValue());
  assertThat(shardRouting10,not(sameInstance(shardRouting9)));
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardIterator.nextOrNull(),nullValue());
  assertThat(shardRouting9,sameInstance(shardRouting5));
  assertThat(shardRouting10,sameInstance(shardRouting6));
}
