{
  final BulkRequest bulkRequest=this.bulkRequest;
  final long executionId=executionIdGen.incrementAndGet();
  this.bulkRequest=new BulkRequest();
  if (concurrentRequests == 0) {
    boolean afterCalled=false;
    try {
      listener.beforeBulk(executionId,bulkRequest);
      BulkResponse bulkItemResponses=client.bulk(bulkRequest).actionGet();
      afterCalled=true;
      listener.afterBulk(executionId,bulkRequest,bulkItemResponses);
    }
 catch (    Exception e) {
      if (!afterCalled) {
        listener.afterBulk(executionId,bulkRequest,e);
      }
    }
  }
 else {
    boolean success=false;
    try {
      listener.beforeBulk(executionId,bulkRequest);
      semaphore.acquire();
      client.bulk(bulkRequest,new ActionListener<BulkResponse>(){
        @Override public void onResponse(        BulkResponse response){
          try {
            listener.afterBulk(executionId,bulkRequest,response);
          }
  finally {
            semaphore.release();
          }
        }
        @Override public void onFailure(        Throwable e){
          try {
            listener.afterBulk(executionId,bulkRequest,e);
          }
  finally {
            semaphore.release();
          }
        }
      }
);
      success=true;
    }
 catch (    InterruptedException e) {
      Thread.interrupted();
      listener.afterBulk(executionId,bulkRequest,e);
    }
catch (    Throwable t) {
      listener.afterBulk(executionId,bulkRequest,t);
    }
 finally {
      if (!success) {
        semaphore.release();
      }
    }
  }
}
