{
  if (enabledState.enabled && !context.sourceToParse().flyweight()) {
    long ttl=context.sourceToParse().ttl();
    if (ttl <= 0 && defaultTTL > 0) {
      ttl=defaultTTL;
      context.sourceToParse().ttl(ttl);
    }
    if (ttl > 0) {
      long timestamp=context.sourceToParse().timestamp();
      long expire=new Date(timestamp + ttl).getTime();
      long now=System.currentTimeMillis();
      if (context.sourceToParse().origin() == SourceToParse.Origin.PRIMARY && now >= expire) {
        throw new AlreadyExpiredException(context.index(),context.type(),context.id(),timestamp,ttl,now);
      }
      fields.add(new LongFieldMapper.CustomLongNumericField(expire,fieldType()));
    }
  }
}
