{
  client.admin().indices().prepareDelete().execute().actionGet();
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",2).put("index.number_of_replicas",0)).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForGreenStatus().execute().actionGet();
  long recCount=20;
  for (int rec=0; rec < recCount; rec++) {
    client.prepareIndex("test","type","rec" + rec).setSource("field" + rec,"some_value").execute().actionGet();
  }
  RefreshResponse refreshResponse=client.admin().indices().prepareRefresh().execute().actionGet();
  assertThat(refreshResponse.getFailedShards(),equalTo(0));
  logger.info("Searching");
  CountResponse response=client.prepareCount("test").execute().actionGet();
  assertThat(response.getCount(),equalTo(recCount));
}
