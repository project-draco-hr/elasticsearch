{
  client().admin().indices().prepareCreate("test").execute().actionGet();
  client().admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  logger.info("--> indexing with id [1], and routing [0]");
  client().prepareIndex("test","type1","1").setRouting("0").setSource("field","value1").setRefresh(true).execute().actionGet();
  logger.info("--> verifying get with no routing, should not find anything");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareGet("test","type1","1").execute().actionGet().isExists(),equalTo(false));
  }
  logger.info("--> verifying get with routing, should find");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareGet("test","type1","1").setRouting("0").execute().actionGet().isExists(),equalTo(true));
  }
  logger.info("--> search with no routing, should fine one");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(1l));
  }
  logger.info("--> search with wrong routing, should not find");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setRouting("1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(0l));
    assertThat(client().prepareCount().setRouting("1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(0l));
  }
  logger.info("--> search with correct routing, should find");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setRouting("0").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(1l));
    assertThat(client().prepareCount().setRouting("0").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(1l));
  }
  logger.info("--> indexing with id [2], and routing [1]");
  client().prepareIndex("test","type1","2").setRouting("1").setSource("field","value1").setRefresh(true).execute().actionGet();
  logger.info("--> search with no routing, should fine two");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(2l));
    assertThat(client().prepareCount().setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(2l));
  }
  logger.info("--> search with 0 routing, should find one");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setRouting("0").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(1l));
    assertThat(client().prepareCount().setRouting("0").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(1l));
  }
  logger.info("--> search with 1 routing, should find one");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setRouting("1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(1l));
    assertThat(client().prepareCount().setRouting("1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(1l));
  }
  logger.info("--> search with 0,1 routings , should find two");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setRouting("0","1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(2l));
    assertThat(client().prepareCount().setRouting("0","1").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(2l));
  }
  logger.info("--> search with 0,1,0 routings , should find two");
  for (int i=0; i < 5; i++) {
    assertThat(client().prepareSearch().setRouting("0","1","0").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getHits().totalHits(),equalTo(2l));
    assertThat(client().prepareCount().setRouting("0","1","0").setQuery(QueryBuilders.matchAllQuery()).execute().actionGet().getCount(),equalTo(2l));
  }
}
