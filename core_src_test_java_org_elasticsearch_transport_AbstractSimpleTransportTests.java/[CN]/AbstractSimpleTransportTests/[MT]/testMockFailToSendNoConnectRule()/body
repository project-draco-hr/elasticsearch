{
  serviceA.registerRequestHandler("sayHello",StringMessageRequest.class,ThreadPool.Names.GENERIC,new TransportRequestHandler<StringMessageRequest>(){
    @Override public void messageReceived(    StringMessageRequest request,    TransportChannel channel) throws Exception {
      assertThat("moshe",equalTo(request.message));
      throw new RuntimeException("bad message !!!");
    }
  }
);
  serviceB.addFailToSendNoConnectRule(nodeA);
  TransportFuture<StringMessageResponse> res=serviceB.submitRequest(nodeA,"sayHello",new StringMessageRequest("moshe"),new BaseTransportResponseHandler<StringMessageResponse>(){
    @Override public StringMessageResponse newInstance(){
      return new StringMessageResponse();
    }
    @Override public String executor(){
      return ThreadPool.Names.GENERIC;
    }
    @Override public void handleResponse(    StringMessageResponse response){
      fail("got response instead of exception");
    }
    @Override public void handleException(    TransportException exp){
      assertThat(exp.getCause().getMessage(),endsWith("DISCONNECT: simulated"));
    }
  }
);
  try {
    res.txGet();
    fail("exception should be thrown");
  }
 catch (  Exception e) {
    assertThat(e.getCause().getMessage(),endsWith("DISCONNECT: simulated"));
  }
  try {
    serviceB.connectToNode(nodeA);
    fail("exception should be thrown");
  }
 catch (  ConnectTransportException e) {
  }
  try {
    serviceB.connectToNodeLight(nodeA);
    fail("exception should be thrown");
  }
 catch (  ConnectTransportException e) {
  }
  serviceA.removeHandler("sayHello");
}
