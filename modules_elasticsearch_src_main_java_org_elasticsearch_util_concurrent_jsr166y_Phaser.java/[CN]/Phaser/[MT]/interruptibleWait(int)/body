{
  QNode node=null;
  boolean queued=false;
  boolean interrupted=false;
  int p;
  while ((p=getPhase()) == phase && !interrupted) {
    if (Thread.interrupted())     interrupted=true;
 else     if (node == null)     node=new QNode(this,phase,true,false,0,0);
 else     if (!queued)     queued=tryEnqueue(node);
 else     interrupted=node.doWait();
  }
  if (node != null)   node.thread=null;
  if (p != phase || (p=getPhase()) != phase)   releaseWaiters(phase);
  if (interrupted)   throw new InterruptedException();
  return p;
}
