{
  Phaser p=parent;
  long s=state;
  if (p != null) {
    while (unarrivedOf(s) == 0 && phaseOf(s) != phaseOf(root.state)) {
      long parentState=p.getReconciledState();
      int parentPhase=phaseOf(parentState);
      int phase=phaseOf(s=state);
      if (phase != parentPhase) {
        long next=trippedStateFor(parentPhase,partiesOf(s));
        if (casState(s,next)) {
          releaseWaiters(phase);
          s=next;
        }
      }
    }
  }
  return s;
}
