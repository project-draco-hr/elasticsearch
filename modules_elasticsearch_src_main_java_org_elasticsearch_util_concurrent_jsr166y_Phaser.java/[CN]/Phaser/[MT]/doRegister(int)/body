{
  int phase;
  for (; ; ) {
    long s=getReconciledState();
    phase=phaseOf(s);
    int unarrived=unarrivedOf(s) + registrations;
    int parties=partiesOf(s) + registrations;
    if (phase < 0)     break;
    if (parties > ushortMask || unarrived > ushortMask)     throw new IllegalStateException(badBounds(parties,unarrived));
    if (phase == phaseOf(root.state) && casState(s,stateFor(phase,parties,unarrived)))     break;
  }
  return phase;
}
