{
  QNode node=null;
  boolean queued=false;
  boolean interrupted=false;
  int p;
  while ((p=getPhase()) == phase) {
    if (Thread.interrupted())     interrupted=true;
 else     if (node == null)     node=new QNode(this,phase,false,false,0,0);
 else     if (!queued)     queued=tryEnqueue(node);
 else     interrupted=node.doWait();
  }
  if (node != null)   node.thread=null;
  releaseWaiters(phase);
  if (interrupted)   Thread.currentThread().interrupt();
  return p;
}
