{
  Compressor compressor=CompressorFactory.compressor(source,offset,length);
  if (compressor != null) {
    CompressedStreamInput compressedStreamInput=compressor.streamInput(new BytesStreamInput(source,offset,length,false));
    XContentType contentType=XContentFactory.xContentType(compressedStreamInput);
    compressedStreamInput.resetToBufferStart();
    if (contentType == builder.contentType()) {
      builder.rawField("_source",compressedStreamInput);
    }
 else {
      XContentParser parser=XContentFactory.xContent(contentType).createParser(compressedStreamInput);
      try {
        parser.nextToken();
        builder.field("_source");
        builder.copyCurrentStructure(parser);
      }
  finally {
        parser.close();
      }
    }
  }
 else {
    XContentType contentType=XContentFactory.xContentType(source,offset,length);
    if (contentType == builder.contentType()) {
      builder.rawField("_source",source,offset,length);
    }
 else {
      XContentParser parser=XContentFactory.xContent(contentType).createParser(source,offset,length);
      try {
        parser.nextToken();
        builder.field("_source");
        builder.copyCurrentStructure(parser);
      }
  finally {
        parser.close();
      }
    }
  }
}
