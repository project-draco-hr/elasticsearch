{
  XContentType contentType=XContentType.fromRestContentType(request.header("Content-Type"));
  if (contentType == null) {
    if (request.hasContent()) {
      contentType=XContentFactory.xContentType(request.content());
    }
  }
  if (contentType == null) {
    contentType=XContentType.JSON;
  }
  CachedStreamOutput.Entry cachedEntry=CachedStreamOutput.popEntry();
  XContentBuilder builder=new XContentBuilder(XContentFactory.xContent(contentType),cachedEntry.bytes(),cachedEntry);
  if (request.paramAsBoolean("pretty",false)) {
    builder.prettyPrint();
  }
  String casing=request.param("case");
  if (casing != null && "camelCase".equals(casing)) {
    builder.fieldCaseConversion(XContentBuilder.FieldCaseConversion.CAMELCASE);
  }
 else {
    builder.fieldCaseConversion(XContentBuilder.FieldCaseConversion.NONE);
  }
  return builder;
}
