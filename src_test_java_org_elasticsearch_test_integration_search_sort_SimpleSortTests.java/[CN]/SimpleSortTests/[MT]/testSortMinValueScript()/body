{
  String mapping=jsonBuilder().startObject().startObject("type1").startObject("properties").startObject("lvalue").field("type","long").endObject().startObject("dvalue").field("type","double").endObject().startObject("svalue").field("type","string").endObject().startObject("gvalue").field("type","geo_point").endObject().endObject().endObject().endObject().string();
  prepareCreate("test").setSettings(getSettings()).addMapping("type1",mapping).execute().actionGet();
  ensureGreen();
  for (int i=0; i < 10; i++) {
    IndexRequestBuilder req=client().prepareIndex("test","type1","" + i).setSource(jsonBuilder().startObject().field("ord",i).field("svalue",new String[]{"" + i,"" + (i + 1),"" + (i + 2)}).field("lvalue",new long[]{i,i + 1,i + 2}).field("dvalue",new double[]{i,i + 1,i + 2}).startObject("gvalue").startObject("location").field("lat",(double)i + 1).field("lon",(double)i).endObject().endObject().endObject());
    req.execute().actionGet();
  }
  for (int i=10; i < 20; i++) {
    client().prepareIndex("test","type1","" + i).setSource(jsonBuilder().startObject().field("ord",i).endObject()).execute().actionGet();
  }
  client().admin().indices().prepareRefresh("test").execute().actionGet();
  SearchResponse searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addScriptField("min","var retval = Long.MAX_VALUE; for (v : doc['lvalue'].values){  retval = Math.min(v, retval);} return retval;").addSort("ord",SortOrder.ASC).setSize(10).execute().actionGet();
  assertThat("Failures " + Arrays.toString(searchResponse.getShardFailures()),searchResponse.getShardFailures().length,equalTo(0));
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(20l));
  for (int i=0; i < 10; i++) {
    assertThat("res: " + i + " id: "+ searchResponse.getHits().getAt(i).getId(),(Long)searchResponse.getHits().getAt(i).field("min").value(),equalTo((long)i));
  }
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addScriptField("min","var retval = Double.MAX_VALUE; for (v : doc['dvalue'].values){  retval = Math.min(v, retval);} return retval;").addSort("ord",SortOrder.ASC).setSize(10).execute().actionGet();
  assertThat("Failures " + Arrays.toString(searchResponse.getShardFailures()),searchResponse.getShardFailures().length,equalTo(0));
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(20l));
  for (int i=0; i < 10; i++) {
    assertThat("res: " + i + " id: "+ searchResponse.getHits().getAt(i).getId(),(Double)searchResponse.getHits().getAt(i).field("min").value(),equalTo((double)i));
  }
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addScriptField("min","var retval = Integer.MAX_VALUE; for (v : doc['svalue'].values){  retval = Math.min(Integer.parseInt(v), retval);} return retval;").addSort("ord",SortOrder.ASC).setSize(10).execute().actionGet();
  assertThat("Failures " + Arrays.toString(searchResponse.getShardFailures()),searchResponse.getShardFailures().length,equalTo(0));
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(20l));
  for (int i=0; i < 10; i++) {
    assertThat("res: " + i + " id: "+ searchResponse.getHits().getAt(i).getId(),(Integer)searchResponse.getHits().getAt(i).field("min").value(),equalTo(i));
  }
  searchResponse=client().prepareSearch().setQuery(matchAllQuery()).addScriptField("min","var retval = Double.MAX_VALUE; for (v : doc['gvalue'].values){  retval = Math.min(v.lon, retval);} return retval;").addSort("ord",SortOrder.ASC).setSize(10).execute().actionGet();
  assertThat("Failures " + Arrays.toString(searchResponse.getShardFailures()),searchResponse.getShardFailures().length,equalTo(0));
  assertThat(searchResponse.getHits().getTotalHits(),equalTo(20l));
  for (int i=0; i < 10; i++) {
    assertThat("res: " + i + " id: "+ searchResponse.getHits().getAt(i).getId(),(Double)searchResponse.getHits().getAt(i).field("min").value(),equalTo((double)i));
  }
}
