{
  try {
    client.admin().indices().prepareDelete("test").execute().actionGet();
  }
 catch (  Exception e) {
  }
  client.admin().indices().prepareCreate("test").setSettings(ImmutableSettings.settingsBuilder().put("index.number_of_shards",1)).execute().actionGet();
  client.admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().execute().actionGet();
  client.prepareIndex("test","type","1").setSource("field",2).execute().actionGet();
  client.prepareIndex("test","type","2").setSource("field",1).execute().actionGet();
  client.prepareIndex("test","type","3").setSource("field",0).execute().actionGet();
  client.admin().indices().prepareRefresh().execute().actionGet();
  SearchResponse searchResponse=client.prepareSearch("test").setQuery(customScoreQuery(matchAllQuery()).script("_source.field")).execute().actionGet();
  assertThat(searchResponse.getHits().getAt(0).getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(1).score(),Matchers.lessThan(searchResponse.getHits().getAt(0).score()));
  assertThat(searchResponse.getHits().getAt(1).getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(2).score(),Matchers.lessThan(searchResponse.getHits().getAt(1).score()));
  assertThat(searchResponse.getHits().getAt(2).getId(),equalTo("3"));
  searchResponse=client.prepareSearch("test").setQuery(customScoreQuery(matchAllQuery()).script("_source.field")).addSort("_score",SortOrder.DESC).execute().actionGet();
  assertThat(searchResponse.getHits().getAt(0).getId(),equalTo("1"));
  assertThat(searchResponse.getHits().getAt(1).score(),Matchers.lessThan(searchResponse.getHits().getAt(0).score()));
  assertThat(searchResponse.getHits().getAt(1).getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(2).score(),Matchers.lessThan(searchResponse.getHits().getAt(1).score()));
  assertThat(searchResponse.getHits().getAt(2).getId(),equalTo("3"));
  searchResponse=client.prepareSearch("test").setQuery(customScoreQuery(matchAllQuery()).script("_source.field")).addSort("_score",SortOrder.DESC).execute().actionGet();
  assertThat(searchResponse.getHits().getAt(2).getId(),equalTo("3"));
  assertThat(searchResponse.getHits().getAt(1).getId(),equalTo("2"));
  assertThat(searchResponse.getHits().getAt(0).getId(),equalTo("1"));
}
