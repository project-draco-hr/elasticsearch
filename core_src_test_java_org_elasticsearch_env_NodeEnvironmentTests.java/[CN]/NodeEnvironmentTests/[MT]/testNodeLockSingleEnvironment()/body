{
  final Settings settings=buildEnvSettings(Settings.builder().put(NodeEnvironment.MAX_LOCAL_STORAGE_NODES_SETTING.getKey(),1).build());
  NodeEnvironment env=newNodeEnvironment(settings);
  List<String> dataPaths=Environment.PATH_DATA_SETTING.get(settings);
  try {
    new NodeEnvironment(settings,new Environment(settings));
    fail("env has already locked all the data directories it is allowed");
  }
 catch (  IllegalStateException ex) {
    assertThat(ex.getMessage(),containsString("Failed to obtain node lock"));
  }
  env.close();
  env=new NodeEnvironment(settings,new Environment(settings));
  assertThat(env.nodeDataPaths(),arrayWithSize(dataPaths.size()));
  for (int i=0; i < dataPaths.size(); i++) {
    assertTrue(env.nodeDataPaths()[i].startsWith(PathUtils.get(dataPaths.get(i))));
  }
  env.close();
  assertThat(env.lockedShards(),empty());
}
