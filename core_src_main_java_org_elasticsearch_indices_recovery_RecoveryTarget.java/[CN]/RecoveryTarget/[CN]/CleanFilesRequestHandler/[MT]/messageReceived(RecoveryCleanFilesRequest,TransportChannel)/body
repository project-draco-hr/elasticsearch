{
  try (RecoveriesCollection.StatusRef statusRef=onGoingRecoveries.getStatusSafe(request.recoveryId(),request.shardId())){
    final RecoveryStatus recoveryStatus=statusRef.status();
    recoveryStatus.state().getTranslog().totalOperations(request.totalTranslogOps());
    recoveryStatus.indexShard().deleteShardState();
    recoveryStatus.renameAllTempFiles();
    final Store store=recoveryStatus.store();
    recoveryStatus.legacyChecksums().write(store);
    Store.MetadataSnapshot sourceMetaData=request.sourceMetaSnapshot();
    try {
      store.cleanupAndVerify("recovery CleanFilesRequestHandler",sourceMetaData);
    }
 catch (    CorruptIndexException|IndexFormatTooNewException|IndexFormatTooOldException ex) {
      try {
        try {
          store.removeCorruptionMarker();
        }
  finally {
          Lucene.cleanLuceneIndex(store.directory());
        }
      }
 catch (      Throwable e) {
        logger.debug("Failed to clean lucene index",e);
        ex.addSuppressed(e);
      }
      RecoveryFailedException rfe=new RecoveryFailedException(recoveryStatus.state(),"failed to clean after recovery",ex);
      recoveryStatus.fail(rfe,true);
      throw rfe;
    }
catch (    Exception ex) {
      RecoveryFailedException rfe=new RecoveryFailedException(recoveryStatus.state(),"failed to clean after recovery",ex);
      recoveryStatus.fail(rfe,true);
      throw rfe;
    }
    channel.sendResponse(TransportResponse.Empty.INSTANCE);
  }
 }
