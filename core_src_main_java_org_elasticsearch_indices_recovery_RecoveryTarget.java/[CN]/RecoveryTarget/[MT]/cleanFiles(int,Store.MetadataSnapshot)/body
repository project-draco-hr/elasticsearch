{
  state().getTranslog().totalOperations(totalTranslogOps);
  indexShard().deleteShardState();
  renameAllTempFiles();
  final Store store=store();
  legacyChecksums().write(store);
  try {
    store.cleanupAndVerify("recovery CleanFilesRequestHandler",sourceMetaData);
  }
 catch (  CorruptIndexException|IndexFormatTooNewException|IndexFormatTooOldException ex) {
    try {
      try {
        store.removeCorruptionMarker();
      }
  finally {
        Lucene.cleanLuceneIndex(store.directory());
      }
    }
 catch (    Throwable e) {
      logger.debug("Failed to clean lucene index",e);
      ex.addSuppressed(e);
    }
    RecoveryFailedException rfe=new RecoveryFailedException(state(),"failed to clean after recovery",ex);
    fail(rfe,true);
    throw rfe;
  }
catch (  Exception ex) {
    RecoveryFailedException rfe=new RecoveryFailedException(state(),"failed to clean after recovery",ex);
    fail(rfe,true);
    throw rfe;
  }
}
