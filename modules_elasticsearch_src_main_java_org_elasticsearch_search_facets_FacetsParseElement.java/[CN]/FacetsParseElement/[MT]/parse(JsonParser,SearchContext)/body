{
  JsonToken token;
  SearchContextFacets.QueryExecutionType queryExecutionType=SearchContextFacets.QueryExecutionType.COLLECT;
  List<SearchContextFacets.QueryFacet> queryFacets=null;
  String topLevelFieldName=null;
  while ((token=jp.nextToken()) != JsonToken.END_OBJECT) {
    if (token == JsonToken.FIELD_NAME) {
      topLevelFieldName=jp.getCurrentName();
    }
 else     if (token == JsonToken.VALUE_STRING) {
      if ("queryExecution".equals(topLevelFieldName)) {
        String text=jp.getText();
        if ("collect".equals(text)) {
          queryExecutionType=SearchContextFacets.QueryExecutionType.COLLECT;
        }
 else         if ("idset".equals(text)) {
          queryExecutionType=SearchContextFacets.QueryExecutionType.IDSET;
        }
 else {
          throw new SearchParseException(context,"Unsupported query type [" + text + "]");
        }
      }
    }
 else     if (token == JsonToken.START_OBJECT) {
      SearchContextFacets.Facet facet=null;
      boolean global=false;
      String facetFieldName=null;
      while ((token=jp.nextToken()) != JsonToken.END_OBJECT) {
        if (token == JsonToken.FIELD_NAME) {
          facetFieldName=jp.getCurrentName();
        }
 else         if (token == JsonToken.START_OBJECT) {
          if ("query".equals(facetFieldName)) {
            JsonIndexQueryParser indexQueryParser=(JsonIndexQueryParser)context.queryParser();
            Query facetQuery=indexQueryParser.parse(jp);
            facet=new SearchContextFacets.QueryFacet(topLevelFieldName,facetQuery);
            if (queryFacets == null) {
              queryFacets=Lists.newArrayListWithCapacity(2);
            }
            queryFacets.add((SearchContextFacets.QueryFacet)facet);
          }
        }
 else         if (token == JsonToken.VALUE_TRUE) {
          if ("global".equals(facetFieldName)) {
            global=true;
          }
        }
 else         if (token == JsonToken.VALUE_NUMBER_INT) {
          global=jp.getIntValue() != 0;
        }
 else         if (token == JsonToken.VALUE_STRING) {
          global=Booleans.parseBoolean(jp.getText(),global);
        }
      }
      if (facet == null) {
        throw new SearchParseException(context,"No facet type found for [" + topLevelFieldName + "]");
      }
      facet.global(global);
    }
  }
  if (queryExecutionType == SearchContextFacets.QueryExecutionType.IDSET) {
    context.searcher().enabledDocIdSet();
  }
  context.facets(new SearchContextFacets(queryExecutionType,queryFacets));
}
