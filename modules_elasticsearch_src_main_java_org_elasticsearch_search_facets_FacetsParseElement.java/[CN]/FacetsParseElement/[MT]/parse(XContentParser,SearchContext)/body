{
  XContentParser.Token token;
  List<FacetCollector> facetCollectors=null;
  String topLevelFieldName=null;
  while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
    if (token == XContentParser.Token.FIELD_NAME) {
      topLevelFieldName=parser.currentName();
    }
 else     if (token == XContentParser.Token.START_OBJECT) {
      FacetCollector facet=null;
      boolean global=false;
      String facetFieldName=null;
      while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
        if (token == XContentParser.Token.FIELD_NAME) {
          facetFieldName=parser.currentName();
        }
 else         if (token == XContentParser.Token.START_OBJECT) {
          FacetCollectorParser facetCollectorParser=facetCollectorParsers.get(facetFieldName);
          if (facetCollectorParser == null) {
            throw new SearchParseException(context,"No facet type for [" + facetFieldName + "]");
          }
          facet=facetCollectorParser.parser(topLevelFieldName,parser,context);
        }
 else         if (token.isValue()) {
          if ("global".equals(facetFieldName)) {
            global=parser.booleanValue();
          }
        }
      }
      if (facetCollectors == null) {
        facetCollectors=Lists.newArrayList();
      }
      facetCollectors.add(facet);
      if (global) {
        context.searcher().addGlobalCollector(facet);
      }
 else {
        context.searcher().addCollector(facet);
      }
    }
  }
  context.facets(new SearchContextFacets(facetCollectors));
}
