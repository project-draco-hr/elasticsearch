{
  if (optimizeSingleShard && searchRequest.getSearchType() != SCAN && searchRequest.getSearchType() != COUNT) {
    try {
      ClusterState clusterState=clusterService.state();
      String[] concreteIndices=clusterState.metaData().concreteIndices(searchRequest.getIndices(),searchRequest.getIgnoreIndices(),true);
      Map<String,Set<String>> routingMap=clusterState.metaData().resolveSearchRouting(searchRequest.getRouting(),searchRequest.getIndices());
      int shardCount=clusterService.operationRouting().searchShardsCount(clusterState,searchRequest.getIndices(),concreteIndices,routingMap,searchRequest.getPreference());
      if (shardCount == 1) {
        searchRequest.setSearchType(QUERY_AND_FETCH);
      }
    }
 catch (    IndexMissingException e) {
    }
catch (    Exception e) {
      logger.debug("failed to optimize search type, continue as normal",e);
    }
  }
  if (searchRequest.getSearchType() == DFS_QUERY_THEN_FETCH) {
    dfsQueryThenFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.getSearchType() == SearchType.QUERY_THEN_FETCH) {
    queryThenFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.getSearchType() == SearchType.DFS_QUERY_AND_FETCH) {
    dfsQueryAndFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.getSearchType() == SearchType.QUERY_AND_FETCH) {
    queryAndFetchAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.getSearchType() == SearchType.SCAN) {
    scanAction.execute(searchRequest,listener);
  }
 else   if (searchRequest.getSearchType() == SearchType.COUNT) {
    countAction.execute(searchRequest,listener);
  }
}
