{
  long index=-1;
  File metaDataFile=null;
  MetaData metaData=null;
  long version=-1;
  for (  File dataLocation : nodeEnv.nodeDataLocations()) {
    File stateLocation=new File(dataLocation,"_state");
    if (!stateLocation.exists()) {
      continue;
    }
    File[] stateFiles=stateLocation.listFiles();
    if (stateFiles == null) {
      continue;
    }
    for (    File stateFile : stateFiles) {
      if (logger.isTraceEnabled()) {
        logger.trace("[upgrade]: processing [" + stateFile.getName() + "]");
      }
      String name=stateFile.getName();
      if (!name.startsWith("metadata-")) {
        continue;
      }
      long fileIndex=Long.parseLong(name.substring(name.indexOf('-') + 1));
      if (fileIndex >= index) {
        try {
          byte[] data=Streams.copyToByteArray(new FileInputStream(stateFile));
          if (data.length == 0) {
            continue;
          }
          try (XContentParser parser=XContentHelper.createParser(data,0,data.length)){
            String currentFieldName=null;
            XContentParser.Token token=parser.nextToken();
            if (token != null) {
              while ((token=parser.nextToken()) != XContentParser.Token.END_OBJECT) {
                if (token == XContentParser.Token.FIELD_NAME) {
                  currentFieldName=parser.currentName();
                }
 else                 if (token == XContentParser.Token.START_OBJECT) {
                  if ("meta-data".equals(currentFieldName)) {
                    metaData=MetaData.Builder.fromXContent(parser);
                  }
                }
 else                 if (token.isValue()) {
                  if ("version".equals(currentFieldName)) {
                    version=parser.longValue();
                  }
                }
              }
            }
          }
           index=fileIndex;
          metaDataFile=stateFile;
        }
 catch (        IOException e) {
          logger.warn("failed to read pre 0.19 state from [" + name + "], ignoring...",e);
        }
      }
    }
  }
  if (metaData == null) {
    return;
  }
  logger.info("found old metadata state, loading metadata from [{}] and converting to new metadata location and structure...",metaDataFile.getAbsolutePath());
  writeGlobalState("upgrade",MetaData.builder(metaData).version(version).build());
  for (  IndexMetaData indexMetaData : metaData) {
    IndexMetaData.Builder indexMetaDataBuilder=IndexMetaData.builder(indexMetaData).version(version);
    indexMetaDataBuilder.settings(ImmutableSettings.settingsBuilder().put(indexMetaData.settings()).put(IndexMetaData.SETTING_VERSION_CREATED,Version.V_0_18_0));
    writeIndex("upgrade",indexMetaDataBuilder.build(),null);
  }
  File backupFile=new File(metaDataFile.getParentFile(),"backup-" + metaDataFile.getName());
  if (!metaDataFile.renameTo(backupFile)) {
    throw new IOException("failed to rename old state to backup state [" + metaDataFile.getAbsolutePath() + "]");
  }
  for (  File dataLocation : nodeEnv.nodeDataLocations()) {
    File stateLocation=new File(dataLocation,"_state");
    if (!stateLocation.exists()) {
      continue;
    }
    File[] stateFiles=stateLocation.listFiles();
    if (stateFiles == null) {
      continue;
    }
    for (    File stateFile : stateFiles) {
      String name=stateFile.getName();
      if (!name.startsWith("metadata-")) {
        continue;
      }
      stateFile.delete();
    }
  }
  logger.info("conversion to new metadata location and format done, backup create at [{}]",backupFile.getAbsolutePath());
}
