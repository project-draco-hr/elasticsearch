{
  logger.trace("[_global] writing state, reason [{}]",reason);
  XContentBuilder builder=XContentFactory.contentBuilder(format);
  builder.startObject();
  MetaData.Builder.toXContent(metaData,builder,gatewayModeFormatParams);
  builder.endObject();
  builder.flush();
  String globalFileName="global-" + metaData.version();
  Throwable lastFailure=null;
  boolean wroteAtLeastOnce=false;
  for (  File dataLocation : nodeEnv.nodeDataLocations()) {
    File stateLocation=new File(dataLocation,"_state");
    FileSystemUtils.mkdirs(stateLocation);
    File stateFile=new File(stateLocation,globalFileName);
    FileOutputStream fos=null;
    try {
      fos=new FileOutputStream(stateFile);
      BytesReference bytes=builder.bytes();
      bytes.writeTo(fos);
      fos.getChannel().force(true);
      fos.close();
      wroteAtLeastOnce=true;
    }
 catch (    Throwable e) {
      lastFailure=e;
    }
 finally {
      IOUtils.closeWhileHandlingException(fos);
    }
  }
  if (!wroteAtLeastOnce) {
    logger.warn("[_global]: failed to write global state",lastFailure);
    throw new IOException("failed to write global state",lastFailure);
  }
  for (  File dataLocation : nodeEnv.nodeDataLocations()) {
    File[] files=new File(dataLocation,"_state").listFiles();
    if (files == null) {
      continue;
    }
    for (    File file : files) {
      if (!file.getName().startsWith("global-")) {
        continue;
      }
      if (file.getName().equals(globalFileName)) {
        continue;
      }
      file.delete();
    }
  }
}
