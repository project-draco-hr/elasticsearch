{
  assertAcked(prepareCreate(INDEX).addMapping(TYPE,MAPPING_WITH_DOUBLE_AND_GEO_POINT_AND_TEXT_FIELD));
  ensureYellow();
  XContentBuilder doc=SIMPLE_DOC;
  index(INDEX,TYPE,"1",doc);
  refresh();
  ScoreFunctionBuilder[] scoreFunctionBuilders=getScoreFunctionBuilders();
  float[] weights=createRandomWeights(scoreFunctionBuilders.length);
  float[] scores=getScores(scoreFunctionBuilders);
  String scoreMode=getRandomScoreMode();
  FunctionScoreQueryBuilder withWeights=functionScoreQuery(termFilter(TEXT_FIELD,"value")).scoreMode(scoreMode);
  int weightscounter=0;
  for (  ScoreFunctionBuilder builder : scoreFunctionBuilders) {
    withWeights.add(builder.setWeight(weights[weightscounter]));
    weightscounter++;
  }
  SearchResponse responseWithWeights=client().search(searchRequest().source(searchSource().query(withWeights))).actionGet();
  double expectedScore=computeExpectedScore(weights,scores,scoreMode);
  assertThat((float)expectedScore / responseWithWeights.getHits().getAt(0).getScore(),is(1.0f));
}
