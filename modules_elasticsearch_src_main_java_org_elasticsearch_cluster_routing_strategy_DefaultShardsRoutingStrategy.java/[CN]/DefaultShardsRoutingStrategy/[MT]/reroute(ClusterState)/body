{
  RoutingNodes routingNodes=clusterState.routingNodes();
  Iterable<Node> dataNodes=clusterState.nodes().dataNodes().values();
  boolean changed=false;
  changed|=deassociateDeadNodes(routingNodes,dataNodes);
  applyNewNodes(routingNodes,dataNodes);
  if (routingNodes.hasUnassigned()) {
    changed|=allocateUnassigned(routingNodes);
  }
  changed|=electPrimaries(routingNodes);
  changed|=rebalance(routingNodes);
  if (!changed) {
    return clusterState.routingTable();
  }
  return new RoutingTable.Builder().updateNodes(routingNodes).build();
}
