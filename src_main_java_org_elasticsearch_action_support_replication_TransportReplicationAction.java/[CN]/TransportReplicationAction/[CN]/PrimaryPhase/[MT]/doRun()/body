{
  if (checkBlocks() == false) {
    return;
  }
  final ShardIterator shardIt=shards(observer.observedState(),internalRequest);
  final ShardRouting primary=resolvePrimary(shardIt);
  if (primary == null) {
    retryBecauseUnavailable(shardIt.shardId(),"No active shards.");
    return;
  }
  if (primary.active() == false) {
    logger.trace("primary shard [{}] is not yet active, scheduling a retry.",primary.shardId());
    retryBecauseUnavailable(shardIt.shardId(),"Primary shard is not active or isn't assigned to a known node.");
    return;
  }
  if (observer.observedState().nodes().nodeExists(primary.currentNodeId()) == false) {
    logger.trace("primary shard [{}] is assigned to anode we do not know the node, scheduling a retry.",primary.shardId(),primary.currentNodeId());
    retryBecauseUnavailable(shardIt.shardId(),"Primary shard is not active or isn't assigned to a known node.");
    return;
  }
  routeRequestOrPerformLocally(primary,shardIt);
}
