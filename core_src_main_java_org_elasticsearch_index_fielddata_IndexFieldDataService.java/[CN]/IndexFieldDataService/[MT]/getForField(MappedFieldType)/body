{
  final Names fieldNames=fieldType.names();
  final FieldDataType type=fieldType.fieldDataType();
  if (type == null) {
    throw new IllegalArgumentException("found no fielddata type for field [" + fieldNames.fullName() + "]");
  }
  final boolean docValues=fieldType.hasDocValues();
  IndexFieldData.Builder builder=null;
  String format=type.getFormat(indexSettings);
  if (format != null && FieldDataType.DOC_VALUES_FORMAT_VALUE.equals(format) && !docValues) {
    logger.warn("field [" + fieldNames.fullName() + "] has no doc values, will use default field data format");
    format=null;
  }
  if (format != null) {
    builder=buildersByTypeAndFormat.get(Tuple.tuple(type.getType(),format));
    if (builder == null) {
      logger.warn("failed to find format [" + format + "] for field ["+ fieldNames.fullName()+ "], will use default");
    }
  }
  if (builder == null && docValues) {
    builder=docValuesBuildersByType.get(type.getType());
  }
  if (builder == null) {
    builder=buildersByType.get(type.getType());
  }
  if (builder == null) {
    throw new IllegalArgumentException("failed to find field data builder for field " + fieldNames.fullName() + ", and type "+ type.getType());
  }
  IndexFieldDataCache cache;
synchronized (this) {
    cache=fieldDataCaches.get(fieldNames.indexName());
    if (cache == null) {
      String cacheType=type.getSettings().get("cache",indexSettings.get(FIELDDATA_CACHE_KEY,FIELDDATA_CACHE_VALUE_NODE));
      if (FIELDDATA_CACHE_VALUE_NODE.equals(cacheType)) {
        cache=indicesFieldDataCache.buildIndexFieldDataCache(indexService,index,fieldNames,type);
      }
 else       if ("none".equals(cacheType)) {
        cache=new IndexFieldDataCache.None();
      }
 else {
        throw new IllegalArgumentException("cache type not supported [" + cacheType + "] for field ["+ fieldNames.fullName()+ "]");
      }
      fieldDataCaches.put(fieldNames.indexName(),cache);
    }
    final boolean isOldParentField=ParentFieldMapper.NAME.equals(fieldNames.indexName()) && Version.indexCreated(indexSettings).before(Version.V_2_0_0_beta1);
    if (isOldParentField) {
      if (parentIndexFieldData == null) {
        parentIndexFieldData=builder.build(index,indexSettings,fieldType,cache,circuitBreakerService,indexService.mapperService());
      }
      return (IFD)parentIndexFieldData;
    }
  }
  return (IFD)builder.build(index,indexSettings,fieldType,cache,circuitBreakerService,indexService.mapperService());
}
