{
  try {
    ParsedQuery parsedQuery=null;
    XContentParser parser=XContentHelper.createParser(source);
    for (XContentParser.Token token=parser.nextToken(); token != XContentParser.Token.END_OBJECT; token=parser.nextToken()) {
      if (token == XContentParser.Token.FIELD_NAME) {
        String fieldName=parser.currentName();
        if ("query".equals(fieldName)) {
          parsedQuery=parse(parser);
        }
 else         if ("query_binary".equals(fieldName) || "queryBinary".equals(fieldName)) {
          byte[] querySource=parser.binaryValue();
          XContentParser qSourceParser=XContentFactory.xContent(querySource).createParser(querySource);
          parsedQuery=parse(qSourceParser);
        }
 else {
          throw new QueryParsingException(getShardContext().parseContext(),"request does not support [" + fieldName + "]");
        }
      }
    }
    if (parsedQuery != null) {
      return parsedQuery;
    }
  }
 catch (  QueryShardException e) {
    throw e;
  }
catch (  Throwable e) {
    throw new QueryParsingException(getShardContext().parseContext(),"Failed to parse",e);
  }
  throw new QueryParsingException(getShardContext().parseContext(),"Required query is missing");
}
