{
  XContentParser parser=null;
  try {
    parser=XContentHelper.createParser(source);
    ParsedQuery parsedQuery=null;
    for (XContentParser.Token token=parser.nextToken(); token != XContentParser.Token.END_OBJECT; token=parser.nextToken()) {
      if (token == XContentParser.Token.FIELD_NAME) {
        String fieldName=parser.currentName();
        if ("query".equals(fieldName)) {
          parsedQuery=parse(parser);
        }
 else         if ("query_binary".equals(fieldName) || "queryBinary".equals(fieldName)) {
          byte[] querySource=parser.binaryValue();
          XContentParser qSourceParser=XContentFactory.xContent(querySource).createParser(querySource);
          parsedQuery=parse(qSourceParser);
        }
 else {
          throw new ParsingException(parser.getTokenLocation(),"request does not support [" + fieldName + "]");
        }
      }
    }
    if (parsedQuery == null) {
      throw new ParsingException(parser.getTokenLocation(),"Required query is missing");
    }
    return parsedQuery;
  }
 catch (  ParsingException|QueryShardException e) {
    throw e;
  }
catch (  Throwable e) {
    throw new ParsingException(parser == null ? null : parser.getTokenLocation(),"Failed to parse",e);
  }
}
