{
  XContentParser parser=null;
  try {
    parser=XContentFactory.xContent(source).createParser(source);
    QueryShardContext queryShardContext=cache.get();
    queryShardContext.reset(parser);
    queryShardContext.parseFieldMatcher(parseFieldMatcher);
    try {
      QueryBuilder<?> queryBuilder=queryShardContext.parseContext().parseTopLevelQueryBuilder();
      Query query=toQuery(queryBuilder,queryShardContext);
      return new ParsedQuery(query,queryShardContext.copyNamedQueries());
    }
  finally {
      queryShardContext.reset(null);
    }
  }
 catch (  ParsingException|QueryShardException e) {
    throw e;
  }
catch (  Throwable e) {
    throw new ParsingException(parser == null ? null : parser.getTokenLocation(),"Failed to parse",e);
  }
}
