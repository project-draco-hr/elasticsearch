{
  final String index="test";
  final ShardId shardId=new ShardId(index,0);
  clusterService.setState(state(index,randomBoolean(),randomBoolean() ? ShardRoutingState.INITIALIZING : ShardRoutingState.UNASSIGNED,ShardRoutingState.UNASSIGNED));
  logger.debug("--> using initial state:\n{}",clusterService.state().prettyPrint());
  Future<BroadcastResponse> response=(broadcastReplicationAction.execute(new BroadcastRequest().indices(index)));
  for (  Tuple<ShardId,ActionListener<ActionWriteResponse>> shardRequests : broadcastReplicationAction.capturedShardRequests) {
    shardRequests.v2().onFailure(new UnavailableShardsException(shardId,"test exception expected"));
  }
  response.get();
  logger.info("total shards: {}, ",response.get().getTotalShards());
  assertBroadcastResponse(2,0,0,response.get(),null);
}
