{
  createIndex("test");
  client().prepareIndex("test","type1","1").setSource("field1","value1").get();
  client().prepareIndex("test","type1","2").setSource("field1","value2").get();
  client().prepareIndex("test","type1","3").setSource("field1","value3").get();
  ensureGreen();
  waitForRelocation();
  optimize();
  refresh();
  assertHitCount(client().prepareSearch().setQuery(matchAllQuery()).setPostFilter(andQuery(matchAllQuery(),notQuery(andQuery(termQuery("field1","value1"),termQuery("field1","value2"))))).get(),3l);
  assertHitCount(client().prepareSearch().setQuery(filteredQuery(boolQuery().should(termQuery("field1","value1")).should(termQuery("field1","value2")).should(termQuery("field1","value3")),notQuery(andQuery(termQuery("field1","value1"),termQuery("field1","value2"))))).get(),3l);
  assertHitCount(client().prepareSearch().setQuery(matchAllQuery()).setPostFilter(notQuery(termQuery("field1","value3"))).get(),2l);
}
