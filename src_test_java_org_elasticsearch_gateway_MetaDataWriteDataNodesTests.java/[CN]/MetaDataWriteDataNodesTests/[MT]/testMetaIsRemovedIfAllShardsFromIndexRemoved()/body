{
  String masterNode=startMasterNode();
  String blueNode=startDataNode("blue");
  String redNode=startDataNode("red");
  client().admin().cluster().health(clusterHealthRequest().waitForYellowStatus().waitForNodes("3")).get();
  assertAcked(prepareCreate("blue_index").setSettings(ImmutableSettings.builder().put("index.number_of_replicas",0).put(FilterAllocationDecider.INDEX_ROUTING_INCLUDE_GROUP + "color","blue")));
  index("blue_index","doc","1",jsonBuilder().startObject().field("text","some text").endObject());
  assertAcked(prepareCreate("red_index").setSettings(ImmutableSettings.builder().put("index.number_of_replicas",0).put(FilterAllocationDecider.INDEX_ROUTING_INCLUDE_GROUP + "color","red")));
  index("red_index","doc","1",jsonBuilder().startObject().field("text","some text").endObject());
  ensureGreen();
  assertIndexNotInMetaState(redNode,"blue_index");
  assertIndexNotInMetaState(blueNode,"red_index");
  assertIndexInMetaState(redNode,"red_index");
  assertIndexInMetaState(blueNode,"blue_index");
  assertIndexInMetaState(masterNode,"red_index");
  assertIndexInMetaState(masterNode,"blue_index");
  logger.debug("relocating indices...");
  client().admin().indices().prepareUpdateSettings("blue_index").setSettings(ImmutableSettings.builder().put(FilterAllocationDecider.INDEX_ROUTING_INCLUDE_GROUP + "color","red")).get();
  client().admin().indices().prepareUpdateSettings("red_index").setSettings(ImmutableSettings.builder().put(FilterAllocationDecider.INDEX_ROUTING_INCLUDE_GROUP + "color","blue")).get();
  client().admin().cluster().prepareHealth().setWaitForRelocatingShards(0).get();
  ensureGreen();
  assertIndexNotInMetaState(redNode,"red_index");
  assertIndexNotInMetaState(blueNode,"blue_index");
  assertIndexInMetaState(redNode,"blue_index");
  assertIndexInMetaState(blueNode,"red_index");
  assertIndexInMetaState(masterNode,"red_index");
  assertIndexInMetaState(masterNode,"blue_index");
  waitForConcreteMappingsOnAll("blue_index","doc","text");
  waitForConcreteMappingsOnAll("red_index","doc","text");
  stopNode(redNode);
  ((InternalTestCluster)cluster()).stopCurrentMasterNode();
  masterNode=startMasterNode();
  redNode=startDataNode("red");
  ensureGreen();
  assertIndexNotInMetaState(redNode,"blue_index");
  assertIndexNotInMetaState(blueNode,"blue_index");
  assertIndexNotInMetaState(redNode,"red_index");
  assertIndexInMetaState(blueNode,"red_index");
  assertIndexInMetaState(masterNode,"red_index");
  assertIndexNotInMetaState(masterNode,"blue_index");
  assertTrue(client().prepareGet("red_index","doc","1").get().isExists());
  assertFalse(client().admin().indices().prepareExists("blue_index").get().isExists());
}
