{
  cluster().startNode(nodeSettings(0));
  Environment environment=cluster().getInstance(Environment.class);
  logger.info("Running Cluster Health (waiting for node to startup properly)");
  ClusterHealthResponse clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForGreenStatus()).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.GREEN));
  logger.info("Creating index [{}]","test");
  client().admin().indices().prepareCreate("test").execute().actionGet();
  PutMappingResponse putMappingResponse=client().admin().indices().preparePutMapping("test").setType("type1").setSource(mappingSource()).execute().actionGet();
  assertThat(putMappingResponse.isAcknowledged(),equalTo(true));
  ClusterStateResponse clusterState=client().admin().cluster().state(clusterStateRequest()).actionGet();
  assertThat(clusterState.getState().metaData().index("test").mapping("type1"),notNullValue());
  logger.info("Indexing #1");
  client().index(Requests.indexRequest("test").type("type1").id("1").source(source("1","test"))).actionGet();
  logger.info("Indexing #2");
  client().index(Requests.indexRequest("test").type("type1").id("2").source(source("2","test"))).actionGet();
  logger.info("Gateway Snapshot");
  client().admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Deleting #1");
  client().delete(deleteRequest("test").type("type1").id("1")).actionGet();
  logger.info("Gateway Snapshot");
  client().admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Gateway Snapshot (should be a no op)");
  client().admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Closing the server");
  cluster().stopRandomNode();
  logger.info("Starting the server, should recover from the gateway (only translog should be populated)");
  cluster().startNode(nodeSettings(0));
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForYellowStatus().waitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  clusterState=client().admin().cluster().state(clusterStateRequest()).actionGet();
  assertThat(clusterState.getState().metaData().index("test").mapping("type1"),notNullValue());
  logger.info("Getting #1, should not exists");
  GetResponse getResponse=client().get(getRequest("test").type("type1").id("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2");
  getResponse=client().get(getRequest("test").type("type1").id("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Flushing, so we have actual content in the index files (#2 should be in the index)");
  client().admin().indices().flush(flushRequest("test")).actionGet();
  logger.info("Indexing #3, so we have something in the translog as well");
  client().index(Requests.indexRequest("test").type("type1").id("3").source(source("3","test"))).actionGet();
  logger.info("Gateway Snapshot");
  client().admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Gateway Snapshot (should be a no op)");
  client().admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Closing the server");
  cluster().stopRandomNode();
  logger.info("Starting the server, should recover from the gateway (both index and translog) and reuse work dir");
  cluster().startNode(nodeSettings(0));
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForYellowStatus().waitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  logger.info("Getting #1, should not exists");
  getResponse=client().get(getRequest("test").type("type1").id("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2 (not from the translog, but from the index)");
  getResponse=client().get(getRequest("test").type("type1").id("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Getting #3 (from the translog)");
  getResponse=client().get(getRequest("test").type("type1").id("3")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("3","test")));
  logger.info("Closing the server");
  cluster().stopRandomNode();
  logger.info("Clearing cluster data dir, so there will be a full recovery from the gateway");
  FileSystemUtils.deleteRecursively(environment.dataWithClusterFiles());
  logger.info("Starting the server, should recover from the gateway (both index and translog) without reusing work dir");
  cluster().startNode(nodeSettings(0));
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForYellowStatus().waitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  logger.info("Getting #1, should not exists");
  getResponse=client().get(getRequest("test").type("type1").id("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2 (not from the translog, but from the index)");
  getResponse=client().get(getRequest("test").type("type1").id("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Getting #3 (from the translog)");
  getResponse=client().get(getRequest("test").type("type1").id("3")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("3","test")));
  logger.info("Flushing, so we have actual content in the index files (#3 should be in the index now as well)");
  client().admin().indices().flush(flushRequest("test")).actionGet();
  logger.info("Gateway Snapshot");
  client().admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Gateway Snapshot (should be a no op)");
  client().admin().indices().gatewaySnapshot(gatewaySnapshotRequest("test")).actionGet();
  logger.info("Closing the server");
  cluster().stopRandomNode();
  logger.info("Starting the server, should recover from the gateway (just from the index, nothing in the translog)");
  cluster().startNode(nodeSettings(0));
  logger.info("Running Cluster Health (wait for the shards to startup)");
  clusterHealth=client().admin().cluster().health(clusterHealthRequest().waitForYellowStatus().waitForActiveShards(1)).actionGet();
  logger.info("Done Cluster Health, status " + clusterHealth.getStatus());
  assertThat(clusterHealth.isTimedOut(),equalTo(false));
  assertThat(clusterHealth.getStatus(),equalTo(ClusterHealthStatus.YELLOW));
  logger.info("Getting #1, should not exists");
  getResponse=client().get(getRequest("test").type("type1").id("1")).actionGet();
  assertThat(getResponse.isExists(),equalTo(false));
  logger.info("Getting #2 (not from the translog, but from the index)");
  getResponse=client().get(getRequest("test").type("type1").id("2")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("2","test")));
  logger.info("Getting #3 (not from the translog, but from the index)");
  getResponse=client().get(getRequest("test").type("type1").id("3")).actionGet();
  assertThat(getResponse.getSourceAsString(),equalTo(source("3","test")));
  logger.info("Deleting the index");
  client().admin().indices().delete(deleteIndexRequest("test")).actionGet();
}
