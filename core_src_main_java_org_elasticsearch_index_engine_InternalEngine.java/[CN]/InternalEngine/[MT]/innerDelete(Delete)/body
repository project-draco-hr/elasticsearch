{
  try (Releasable ignored=acquireLock(delete.uid())){
    lastWriteNanos=delete.startTime();
    final long currentVersion;
    final boolean deleted;
    VersionValue versionValue=versionMap.getUnderLock(delete.uid().bytes());
    if (versionValue == null) {
      currentVersion=loadCurrentVersionFromIndex(delete.uid());
      deleted=currentVersion == Versions.NOT_FOUND;
    }
 else {
      deleted=versionValue.delete();
      if (engineConfig.isEnableGcDeletes() && versionValue.delete() && (engineConfig.getThreadPool().estimatedTimeInMillis() - versionValue.time()) > getGcDeletesInMillis()) {
        currentVersion=Versions.NOT_FOUND;
      }
 else {
        currentVersion=versionValue.version();
      }
    }
    long updatedVersion;
    long expectedVersion=delete.version();
    if (delete.versionType().isVersionConflictForWrites(currentVersion,expectedVersion,deleted)) {
      if (delete.origin() == Operation.Origin.RECOVERY) {
        return;
      }
 else {
        throw new VersionConflictEngineException(shardId,delete.type(),delete.id(),delete.versionType().explainConflictForWrites(currentVersion,expectedVersion,deleted));
      }
    }
    updatedVersion=delete.versionType().updateVersion(currentVersion,expectedVersion);
    final boolean found;
    if (currentVersion == Versions.NOT_FOUND) {
      found=false;
    }
 else     if (versionValue != null && versionValue.delete()) {
      found=false;
    }
 else {
      indexWriter.deleteDocuments(delete.uid());
      found=true;
    }
    delete.updateVersion(updatedVersion,found);
    Translog.Location translogLocation=translog.add(new Translog.Delete(delete));
    versionMap.putUnderLock(delete.uid().bytes(),new DeleteVersionValue(updatedVersion,engineConfig.getThreadPool().estimatedTimeInMillis(),translogLocation));
    delete.setTranslogLocation(translogLocation);
  }
 }
