{
  final Translog.TranslogGeneration generation=loadTranslogIdFromCommit(writer);
  final TranslogConfig translogConfig=engineConfig.getTranslogConfig();
  if (openMode == EngineConfig.OpenMode.OPEN_INDEX_AND_TRANSLOG) {
    if (generation == null) {
      throw new IllegalStateException("no translog generation present in commit data but translog is expected to exist");
    }
    translogConfig.setTranslogGeneration(generation);
    if (generation != null && generation.translogUUID == null) {
      throw new IndexFormatTooOldException("trasnlog","translog has no generation nor a UUID - this might be an index from a previous version consider upgrading to N-1 first");
    }
  }
  final Translog translog=new Translog(translogConfig);
  if (generation == null || generation.translogUUID == null) {
    if (generation == null) {
      logger.debug("no translog ID present in the current generation - creating one");
    }
 else     if (generation.translogUUID == null) {
      logger.debug("upgraded translog to pre 2.0 format, associating translog with index - writing translog UUID");
    }
    boolean success=false;
    try {
      commitIndexWriter(writer,translog);
      success=true;
    }
  finally {
      if (success == false) {
        IOUtils.closeWhileHandlingException(translog);
      }
    }
  }
  return translog;
}
